From patchwork Sun May 31 16:38:22 2020
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
X-Patchwork-Submitter: =?utf-8?q?Philippe_Mathieu-Daud=C3=A9?=
 <philmd@redhat.com>
X-Patchwork-Id: 11580721
Return-Path: <SRS0=4Gy4=7N=vger.kernel.org=kvm-owner@kernel.org>
Received: from mail.kernel.org (pdx-korg-mail-1.web.codeaurora.org
 [172.30.200.123])
	by pdx-korg-patchwork-2.web.codeaurora.org (Postfix) with ESMTP id DDD9790
	for <patchwork-kvm@patchwork.kernel.org>;
 Sun, 31 May 2020 16:39:01 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id C6305207BB
	for <patchwork-kvm@patchwork.kernel.org>;
 Sun, 31 May 2020 16:39:01 +0000 (UTC)
Authentication-Results: mail.kernel.org;
	dkim=pass (1024-bit key) header.d=redhat.com header.i=@redhat.com
 header.b="AbucRe59"
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1728105AbgEaQjA (ORCPT
        <rfc822;patchwork-kvm@patchwork.kernel.org>);
        Sun, 31 May 2020 12:39:00 -0400
Received: from us-smtp-delivery-1.mimecast.com ([207.211.31.120]:29745 "EHLO
        us-smtp-1.mimecast.com" rhost-flags-OK-OK-OK-FAIL) by vger.kernel.org
        with ESMTP id S1725912AbgEaQi7 (ORCPT <rfc822;kvm@vger.kernel.org>);
        Sun, 31 May 2020 12:38:59 -0400
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=redhat.com;
        s=mimecast20190719; t=1590943138;
        h=from:from:reply-to:subject:subject:date:date:message-id:message-id:
         to:to:cc:cc:mime-version:mime-version:
  content-type:content-type:content-type:
         content-transfer-encoding:content-transfer-encoding:
         in-reply-to:in-reply-to:references:references;
        bh=Ly/BNyoFscwcUlEdMi1CDGrrxngHJB98Yaq6NCa8Sss=;
        b=AbucRe5984FPtG1hKWIxCZp1xnfgZp8OLWH8sgnO/XNKeCyhp/wtKhJpVVgU4GF6mHiunE
        IJbFm2YM1IMPOCdk9v8U0y31TFepGr/PG4QW8YfaZNmtgKlc3JN+BiEv1nGM9IioDKU2+S
        EmYS/8jmCxhhrFU6vNUbvj/+O/7RhWs=
Received: from mail-wr1-f70.google.com (mail-wr1-f70.google.com
 [209.85.221.70]) (Using TLS) by relay.mimecast.com with ESMTP id
 us-mta-79-O7qQmQCQOey1fmplPEslBg-1; Sun, 31 May 2020 12:38:57 -0400
X-MC-Unique: O7qQmQCQOey1fmplPEslBg-1
Received: by mail-wr1-f70.google.com with SMTP id o1so3589337wrm.17
        for <kvm@vger.kernel.org>; Sun, 31 May 2020 09:38:56 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
         :references:mime-version:content-transfer-encoding;
        bh=Ly/BNyoFscwcUlEdMi1CDGrrxngHJB98Yaq6NCa8Sss=;
        b=BitRgJ2tbJZKP9T2JFd1BS4f5GhJv8mrWD/XgEEHPTIuRZtxyyIf8/+Ihwlq4MdzpO
         IXDneuWec0LfIEyZpSsGyz2x6y37PhhpbywBnYJfz74IQAVZKR+meiCq4GcydmZ33Cn0
         19YYuu/QtiH+lL/h+ZbkNeQIFf8s7k+E3mmTSUYf83axr2+7LM2pJ+guZ5SF9pGybK5F
         fUfx4ajbGxreuq9l6IlT938B7W0i36+IEXG/C2fMTiNS49T9w3utk+scSnXLLTUmznDt
         BJ4Brtz2XNbwS2CeDjSjV7+pJMou4khMDdToDDyJKBAGFnHHFfHZs/AahJMhtxMQB75+
         D8rQ==
X-Gm-Message-State: AOAM533imrY0DxNbD3bKhZy/I0UX1twyVwuyoAemhrbrpylIvjmwo4WN
        Y5yJJwDMCmRvPV+O91ngZtPtqUvdkZwdCSXititiRyuQMKPYnlgswvhy+8ieDHZp0eCrZR0BUdS
        H4nOrOfEIlsbu
X-Received: by 2002:a5d:4e03:: with SMTP id p3mr18519105wrt.350.1590943135174;
        Sun, 31 May 2020 09:38:55 -0700 (PDT)
X-Google-Smtp-Source: 
 ABdhPJxe7sJn4ZGtJgKpS26KNwTyhpDQC9oFjhczDjqsHEXGXaRKqr+VepBPJMpNihdteRynA8wNuA==
X-Received: by 2002:a5d:4e03:: with SMTP id p3mr18519096wrt.350.1590943134994;
        Sun, 31 May 2020 09:38:54 -0700 (PDT)
Received: from localhost.localdomain (43.red-83-51-162.dynamicip.rima-tde.net.
 [83.51.162.43])
        by smtp.gmail.com with ESMTPSA id
 v7sm8920008wme.46.2020.05.31.09.38.53
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Sun, 31 May 2020 09:38:54 -0700 (PDT)
From: =?utf-8?q?Philippe_Mathieu-Daud=C3=A9?= <philmd@redhat.com>
To: qemu-devel@nongnu.org
Cc: Cleber Rosa <crosa@redhat.com>, Kevin Wolf <kwolf@redhat.com>,
 kvm@vger.kernel.org, Richard Henderson <rth@twiddle.net>,
 Fam Zheng <fam@euphon.net>, Eduardo Habkost <ehabkost@redhat.com>,
	=?utf-8?q?Alex_Benn=C3=A9e?= <alex.bennee@linaro.org>,
 Paolo Bonzini <pbonzini@redhat.com>, Max Reitz <mreitz@redhat.com>,
	=?utf-8?q?Philippe_Mathieu-Daud=C3=A9?= <philmd@redhat.com>,
 Stefan Hajnoczi <stefanha@redhat.com>, Markus Armbruster <armbru@redhat.com>,
 Marcelo Tosatti <mtosatti@redhat.com>, qemu-block@nongnu.org, =?utf-8?q?Phi?=
	=?utf-8?q?lippe_Mathieu-Daud=C3=A9?= <f4bug@amsat.org>,
 John Snow <jsnow@redhat.com>
Subject: [PULL 01/25] scripts/qemugdb: Remove shebang header
Date: Sun, 31 May 2020 18:38:22 +0200
Message-Id: <20200531163846.25363-2-philmd@redhat.com>
X-Mailer: git-send-email 2.21.3
In-Reply-To: <20200531163846.25363-1-philmd@redhat.com>
References: <20200531163846.25363-1-philmd@redhat.com>
MIME-Version: 1.0
Sender: kvm-owner@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

From: Philippe Mathieu-Daudé <f4bug@amsat.org>

These scripts are loaded as plugin by GDB (and they don't
have any __main__ entry point). Remove the shebang header.

Signed-off-by: Philippe Mathieu-Daudé <f4bug@amsat.org>
Acked-by: Alex Bennée <alex.bennee@linaro.org>
Reviewed-by: John Snow <jsnow@redhat.com>
Reviewed-by: Kevin Wolf <kwolf@redhat.com>
Message-Id: <20200512103238.7078-2-philmd@redhat.com>
Signed-off-by: Philippe Mathieu-Daudé <philmd@redhat.com>
---
 scripts/qemugdb/__init__.py  | 3 +--
 scripts/qemugdb/aio.py       | 3 +--
 scripts/qemugdb/coroutine.py | 3 +--
 scripts/qemugdb/mtree.py     | 4 +---
 scripts/qemugdb/tcg.py       | 1 -
 scripts/qemugdb/timers.py    | 1 -
 6 files changed, 4 insertions(+), 11 deletions(-)

diff --git a/scripts/qemugdb/__init__.py b/scripts/qemugdb/__init__.py
index 969f552b26..da8ff612e5 100644
--- a/scripts/qemugdb/__init__.py
+++ b/scripts/qemugdb/__init__.py
@@ -1,5 +1,4 @@
-#!/usr/bin/python
-
+#
 # GDB debugging support
 #
 # Copyright (c) 2015 Linaro Ltd
diff --git a/scripts/qemugdb/aio.py b/scripts/qemugdb/aio.py
index 2ba00c4444..d7c1ba0c28 100644
--- a/scripts/qemugdb/aio.py
+++ b/scripts/qemugdb/aio.py
@@ -1,5 +1,4 @@
-#!/usr/bin/python
-
+#
 # GDB debugging support: aio/iohandler debug
 #
 # Copyright (c) 2015 Red Hat, Inc.
diff --git a/scripts/qemugdb/coroutine.py b/scripts/qemugdb/coroutine.py
index 41e079d0e2..db61389022 100644
--- a/scripts/qemugdb/coroutine.py
+++ b/scripts/qemugdb/coroutine.py
@@ -1,5 +1,4 @@
-#!/usr/bin/python
-
+#
 # GDB debugging support
 #
 # Copyright 2012 Red Hat, Inc. and/or its affiliates
diff --git a/scripts/qemugdb/mtree.py b/scripts/qemugdb/mtree.py
index 3030a60d3f..8fe42c3c12 100644
--- a/scripts/qemugdb/mtree.py
+++ b/scripts/qemugdb/mtree.py
@@ -1,5 +1,4 @@
-#!/usr/bin/python
-
+#
 # GDB debugging support
 #
 # Copyright 2012 Red Hat, Inc. and/or its affiliates
@@ -84,4 +83,3 @@ def print_item(self, ptr, offset = gdb.Value(0), level = 0):
         while not isnull(subregion):
             self.print_item(subregion, addr, level)
             subregion = subregion['subregions_link']['tqe_next']
-
diff --git a/scripts/qemugdb/tcg.py b/scripts/qemugdb/tcg.py
index 18880fc9a7..16c03c06a9 100644
--- a/scripts/qemugdb/tcg.py
+++ b/scripts/qemugdb/tcg.py
@@ -1,4 +1,3 @@
-#!/usr/bin/python
 # -*- coding: utf-8 -*-
 #
 # GDB debugging support, TCG status
diff --git a/scripts/qemugdb/timers.py b/scripts/qemugdb/timers.py
index f0e132d27a..46537b27cf 100644
--- a/scripts/qemugdb/timers.py
+++ b/scripts/qemugdb/timers.py
@@ -1,4 +1,3 @@
-#!/usr/bin/python
 # -*- coding: utf-8 -*-
 # GDB debugging support
 #

From patchwork Sun May 31 16:38:23 2020
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
X-Patchwork-Submitter: =?utf-8?q?Philippe_Mathieu-Daud=C3=A9?=
 <philmd@redhat.com>
X-Patchwork-Id: 11580723
Return-Path: <SRS0=4Gy4=7N=vger.kernel.org=kvm-owner@kernel.org>
Received: from mail.kernel.org (pdx-korg-mail-1.web.codeaurora.org
 [172.30.200.123])
	by pdx-korg-patchwork-2.web.codeaurora.org (Postfix) with ESMTP id 1A7EC90
	for <patchwork-kvm@patchwork.kernel.org>;
 Sun, 31 May 2020 16:39:06 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 01FE92074A
	for <patchwork-kvm@patchwork.kernel.org>;
 Sun, 31 May 2020 16:39:06 +0000 (UTC)
Authentication-Results: mail.kernel.org;
	dkim=pass (1024-bit key) header.d=redhat.com header.i=@redhat.com
 header.b="YB41BauQ"
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1728175AbgEaQjF (ORCPT
        <rfc822;patchwork-kvm@patchwork.kernel.org>);
        Sun, 31 May 2020 12:39:05 -0400
Received: from us-smtp-delivery-1.mimecast.com ([205.139.110.120]:32652 "EHLO
        us-smtp-1.mimecast.com" rhost-flags-OK-OK-OK-FAIL) by vger.kernel.org
        with ESMTP id S1728166AbgEaQjE (ORCPT <rfc822;kvm@vger.kernel.org>);
        Sun, 31 May 2020 12:39:04 -0400
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=redhat.com;
        s=mimecast20190719; t=1590943143;
        h=from:from:reply-to:subject:subject:date:date:message-id:message-id:
         to:to:cc:cc:mime-version:mime-version:
  content-type:content-type:content-type:
         content-transfer-encoding:content-transfer-encoding:
         in-reply-to:in-reply-to:references:references;
        bh=C/VDoQzlI3PMEip7rZs9mnHodIncfMhzQDNkbQhv2i8=;
        b=YB41BauQ0Gy9rKCkjMb1x/m/FhT1T3QD+JRtIML+rB0UigF1NepNvDqOJCOLH85HliCoxa
        4egba3X/d7DL2dq/m5mv4NCs9PWf8R27cuxo63EkT10ZuBy3s3u3CxsRNp9BEoMKmQycjD
        nyNReZC0Jd7It+lwLG5WWuUNhIweDaM=
Received: from mail-wm1-f72.google.com (mail-wm1-f72.google.com
 [209.85.128.72]) (Using TLS) by relay.mimecast.com with ESMTP id
 us-mta-270-yxLiOb1fP_OLe8FMiQCLjQ-1; Sun, 31 May 2020 12:39:01 -0400
X-MC-Unique: yxLiOb1fP_OLe8FMiQCLjQ-1
Received: by mail-wm1-f72.google.com with SMTP id v23so1917567wmj.0
        for <kvm@vger.kernel.org>; Sun, 31 May 2020 09:39:01 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
         :references:mime-version:content-transfer-encoding;
        bh=C/VDoQzlI3PMEip7rZs9mnHodIncfMhzQDNkbQhv2i8=;
        b=CdF7428BRcI0KrfwnkCm1doEiGgIjUOCXESlbsb6rsEGhNm45xwyInl1cZhikThU8h
         vQHYC6uPh+cJniyf0gWkTotbh70AbAXASi28438jaYDd1kt76GOm9Y0g5zCFlHgigSrS
         HzvonII82EW7GWCGQZekExc+ziEYGoSLe3CpgqTOq2FyWq5jBUYTCP6INtUfzXwRfgH1
         TSUqd1tUXbHvBEn83cbcwkfF0Exy8sDW4mU7dPcfXKKpgJ7iOGthB83Zpx3xR6NPlfes
         TLC5zNPTwWkQfZBmp+GUYV09l9+/Oh0pAG9oumnyc0roa52q8/bwQtF4LMzsASmowMOS
         HL1g==
X-Gm-Message-State: AOAM530eradmNwaIwvxtviiTJaCWrxdBf1BqLg4MhRJOZQb+ZaLWNiUr
        ZGWb+LV3amSfORH7TKBkMD2Ej8EYAn8JJg2xoO2B4bfDIASvpj3rFsOKS2yN4JXBu7Ux/zKQ0ri
        +83m7lw6Le4bx
X-Received: by 2002:a1c:29c4:: with SMTP id
 p187mr17760833wmp.73.1590943140356;
        Sun, 31 May 2020 09:39:00 -0700 (PDT)
X-Google-Smtp-Source: 
 ABdhPJwIEiALGuV93Ro6dhnxfm0LVwVkfTLG/HYDNsHae0Cpu2iwY0tKkx4JmUw+UJ4NEDJTtGPkpg==
X-Received: by 2002:a1c:29c4:: with SMTP id
 p187mr17760818wmp.73.1590943140155;
        Sun, 31 May 2020 09:39:00 -0700 (PDT)
Received: from localhost.localdomain (43.red-83-51-162.dynamicip.rima-tde.net.
 [83.51.162.43])
        by smtp.gmail.com with ESMTPSA id
 d2sm17217183wrs.95.2020.05.31.09.38.58
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Sun, 31 May 2020 09:38:59 -0700 (PDT)
From: =?utf-8?q?Philippe_Mathieu-Daud=C3=A9?= <philmd@redhat.com>
To: qemu-devel@nongnu.org
Cc: Cleber Rosa <crosa@redhat.com>, Kevin Wolf <kwolf@redhat.com>,
 kvm@vger.kernel.org, Richard Henderson <rth@twiddle.net>,
 Fam Zheng <fam@euphon.net>, Eduardo Habkost <ehabkost@redhat.com>,
	=?utf-8?q?Alex_Benn=C3=A9e?= <alex.bennee@linaro.org>,
 Paolo Bonzini <pbonzini@redhat.com>, Max Reitz <mreitz@redhat.com>,
	=?utf-8?q?Philippe_Mathieu-Daud=C3=A9?= <philmd@redhat.com>,
 Stefan Hajnoczi <stefanha@redhat.com>, Markus Armbruster <armbru@redhat.com>,
 Marcelo Tosatti <mtosatti@redhat.com>, qemu-block@nongnu.org, =?utf-8?q?Phi?=
	=?utf-8?q?lippe_Mathieu-Daud=C3=A9?= <f4bug@amsat.org>,
 John Snow <jsnow@redhat.com>
Subject: [PULL 02/25] scripts/qemu-gdb: Use Python 3 interpreter
Date: Sun, 31 May 2020 18:38:23 +0200
Message-Id: <20200531163846.25363-3-philmd@redhat.com>
X-Mailer: git-send-email 2.21.3
In-Reply-To: <20200531163846.25363-1-philmd@redhat.com>
References: <20200531163846.25363-1-philmd@redhat.com>
MIME-Version: 1.0
Sender: kvm-owner@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

From: Philippe Mathieu-Daudé <f4bug@amsat.org>

Signed-off-by: Philippe Mathieu-Daudé <f4bug@amsat.org>
Reviewed-by: John Snow <jsnow@redhat.com>
Reviewed-by: Kevin Wolf <kwolf@redhat.com>
Message-Id: <20200512103238.7078-3-philmd@redhat.com>
Signed-off-by: Philippe Mathieu-Daudé <philmd@redhat.com>
---
 scripts/qemu-gdb.py | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/scripts/qemu-gdb.py b/scripts/qemu-gdb.py
index f2a305c42e..e0bfa7b5a4 100644
--- a/scripts/qemu-gdb.py
+++ b/scripts/qemu-gdb.py
@@ -1,5 +1,5 @@
-#!/usr/bin/python
-
+#!/usr/bin/env python3
+#
 # GDB debugging support
 #
 # Copyright 2012 Red Hat, Inc. and/or its affiliates

From patchwork Sun May 31 16:38:24 2020
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
X-Patchwork-Submitter: =?utf-8?q?Philippe_Mathieu-Daud=C3=A9?=
 <philmd@redhat.com>
X-Patchwork-Id: 11580725
Return-Path: <SRS0=4Gy4=7N=vger.kernel.org=kvm-owner@kernel.org>
Received: from mail.kernel.org (pdx-korg-mail-1.web.codeaurora.org
 [172.30.200.123])
	by pdx-korg-patchwork-2.web.codeaurora.org (Postfix) with ESMTP id 61EFE90
	for <patchwork-kvm@patchwork.kernel.org>;
 Sun, 31 May 2020 16:39:11 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 49C752074A
	for <patchwork-kvm@patchwork.kernel.org>;
 Sun, 31 May 2020 16:39:11 +0000 (UTC)
Authentication-Results: mail.kernel.org;
	dkim=pass (1024-bit key) header.d=redhat.com header.i=@redhat.com
 header.b="MZC7U8QL"
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1728197AbgEaQjK (ORCPT
        <rfc822;patchwork-kvm@patchwork.kernel.org>);
        Sun, 31 May 2020 12:39:10 -0400
Received: from us-smtp-2.mimecast.com ([207.211.31.81]:23841 "EHLO
        us-smtp-delivery-1.mimecast.com" rhost-flags-OK-OK-OK-FAIL)
        by vger.kernel.org with ESMTP id S1728145AbgEaQjK (ORCPT
        <rfc822;kvm@vger.kernel.org>); Sun, 31 May 2020 12:39:10 -0400
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=redhat.com;
        s=mimecast20190719; t=1590943148;
        h=from:from:reply-to:subject:subject:date:date:message-id:message-id:
         to:to:cc:cc:mime-version:mime-version:
  content-type:content-type:content-type:
         content-transfer-encoding:content-transfer-encoding:
         in-reply-to:in-reply-to:references:references;
        bh=yBN0He0hnRiO6mOUWUzXjmIAL9Om1ymVuyqwTdVM/HE=;
        b=MZC7U8QL6dSsQTSOsgMqiQI+yHf0+vSZdaGboGj8KoouvkLUvIMDH62/ZLFI5Mj4+3nutO
        eHXoyW3AsdmctyPTs4RB70g53hw2nOJspiPu2xKVITf6+fnFbKzPR7rIgXUWZeDdxLRb/m
        9gIGHQmejwdOQn79sO4SdqbHYtuuPbE=
Received: from mail-wr1-f69.google.com (mail-wr1-f69.google.com
 [209.85.221.69]) (Using TLS) by relay.mimecast.com with ESMTP id
 us-mta-403-Ws7IgrkGMiqLiL1-RcdoSA-1; Sun, 31 May 2020 12:39:06 -0400
X-MC-Unique: Ws7IgrkGMiqLiL1-RcdoSA-1
Received: by mail-wr1-f69.google.com with SMTP id m14so1788950wrj.12
        for <kvm@vger.kernel.org>; Sun, 31 May 2020 09:39:06 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
         :references:mime-version:content-transfer-encoding;
        bh=yBN0He0hnRiO6mOUWUzXjmIAL9Om1ymVuyqwTdVM/HE=;
        b=rncPwohv1h7kenOdZndKVCPKjfsvmcA9QMARm7CT7bMwGL1vWCKBEmtfR73I9YRiQk
         +M5FPYwh3YqQJoR2dGEYsHmHN+luZSvTsLkTNO4MG9xd16OFLE4P07TdnuS/fKjSY7e2
         2FiKal2Y7IWKxHOWstzsW6/QW1mzbgDLRzHKObmW7KLzXxTpXSLSwupGwb5cMGiWVK8M
         +9yR1/BnOpNDJ4TAn7zVgeQ0LIYOYXrBTNe3QlE0mAgVpu055f16n2fShrpYGDfjU6+L
         DXm98MR+wJBT0bTpY7ucyTosqFBj7QmkPJWESe+0q3k/T3R399cOQgonRj6LcnAELdl6
         alDQ==
X-Gm-Message-State: AOAM5339qt329yWlgt2KeLmZ2jygrzVS48bqlyesTms3M/H+TH2oX+Ir
        IhtesfuBuZNn+mdL8liz7ARNpnzRWXUVxMiQm3qCHinX5f7WJAD+FKlVEZ1DleJV/obbnqhgFht
        D9/qkWrBJYjA4
X-Received: by 2002:adf:f0d2:: with SMTP id
 x18mr17834378wro.250.1590943145452;
        Sun, 31 May 2020 09:39:05 -0700 (PDT)
X-Google-Smtp-Source: 
 ABdhPJz+gCJF6HcUNgazMBl80tT6OrlhUIFDpGWEUH3j0u8boakYALkjhYWx7zPVPFdQkkPf5lo8sQ==
X-Received: by 2002:adf:f0d2:: with SMTP id
 x18mr17834358wro.250.1590943145303;
        Sun, 31 May 2020 09:39:05 -0700 (PDT)
Received: from localhost.localdomain (43.red-83-51-162.dynamicip.rima-tde.net.
 [83.51.162.43])
        by smtp.gmail.com with ESMTPSA id 5sm7692633wmz.16.2020.05.31.09.39.03
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Sun, 31 May 2020 09:39:04 -0700 (PDT)
From: =?utf-8?q?Philippe_Mathieu-Daud=C3=A9?= <philmd@redhat.com>
To: qemu-devel@nongnu.org
Cc: Cleber Rosa <crosa@redhat.com>, Kevin Wolf <kwolf@redhat.com>,
 kvm@vger.kernel.org, Richard Henderson <rth@twiddle.net>,
 Fam Zheng <fam@euphon.net>, Eduardo Habkost <ehabkost@redhat.com>,
	=?utf-8?q?Alex_Benn=C3=A9e?= <alex.bennee@linaro.org>,
 Paolo Bonzini <pbonzini@redhat.com>, Max Reitz <mreitz@redhat.com>,
	=?utf-8?q?Philippe_Mathieu-Daud=C3=A9?= <philmd@redhat.com>,
 Stefan Hajnoczi <stefanha@redhat.com>, Markus Armbruster <armbru@redhat.com>,
 Marcelo Tosatti <mtosatti@redhat.com>, qemu-block@nongnu.org, =?utf-8?q?Phi?=
	=?utf-8?q?lippe_Mathieu-Daud=C3=A9?= <f4bug@amsat.org>,
 John Snow <jsnow@redhat.com>
Subject: [PULL 03/25] scripts/qmp: Use Python 3 interpreter
Date: Sun, 31 May 2020 18:38:24 +0200
Message-Id: <20200531163846.25363-4-philmd@redhat.com>
X-Mailer: git-send-email 2.21.3
In-Reply-To: <20200531163846.25363-1-philmd@redhat.com>
References: <20200531163846.25363-1-philmd@redhat.com>
MIME-Version: 1.0
Sender: kvm-owner@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

From: Philippe Mathieu-Daudé <f4bug@amsat.org>

Signed-off-by: Philippe Mathieu-Daudé <f4bug@amsat.org>
Reviewed-by: John Snow <jsnow@redhat.com>
Reviewed-by: Kevin Wolf <kwolf@redhat.com>
Message-Id: <20200512103238.7078-4-philmd@redhat.com>
Signed-off-by: Philippe Mathieu-Daudé <philmd@redhat.com>
---
 scripts/qmp/qom-get  | 2 +-
 scripts/qmp/qom-list | 2 +-
 scripts/qmp/qom-set  | 2 +-
 scripts/qmp/qom-tree | 2 +-
 4 files changed, 4 insertions(+), 4 deletions(-)

diff --git a/scripts/qmp/qom-get b/scripts/qmp/qom-get
index 007b4cd442..7c5ede91bb 100755
--- a/scripts/qmp/qom-get
+++ b/scripts/qmp/qom-get
@@ -1,4 +1,4 @@
-#!/usr/bin/python
+#!/usr/bin/env python3
 ##
 # QEMU Object Model test tools
 #
diff --git a/scripts/qmp/qom-list b/scripts/qmp/qom-list
index 03bda3446b..bb68fd65d4 100755
--- a/scripts/qmp/qom-list
+++ b/scripts/qmp/qom-list
@@ -1,4 +1,4 @@
-#!/usr/bin/python
+#!/usr/bin/env python3
 ##
 # QEMU Object Model test tools
 #
diff --git a/scripts/qmp/qom-set b/scripts/qmp/qom-set
index c37fe78b00..19881d85e9 100755
--- a/scripts/qmp/qom-set
+++ b/scripts/qmp/qom-set
@@ -1,4 +1,4 @@
-#!/usr/bin/python
+#!/usr/bin/env python3
 ##
 # QEMU Object Model test tools
 #
diff --git a/scripts/qmp/qom-tree b/scripts/qmp/qom-tree
index 1c8acf61e7..fa91147a03 100755
--- a/scripts/qmp/qom-tree
+++ b/scripts/qmp/qom-tree
@@ -1,4 +1,4 @@
-#!/usr/bin/python
+#!/usr/bin/env python3
 ##
 # QEMU Object Model test tools
 #

From patchwork Sun May 31 16:38:25 2020
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
X-Patchwork-Submitter: =?utf-8?q?Philippe_Mathieu-Daud=C3=A9?=
 <philmd@redhat.com>
X-Patchwork-Id: 11580727
Return-Path: <SRS0=4Gy4=7N=vger.kernel.org=kvm-owner@kernel.org>
Received: from mail.kernel.org (pdx-korg-mail-1.web.codeaurora.org
 [172.30.200.123])
	by pdx-korg-patchwork-2.web.codeaurora.org (Postfix) with ESMTP id 5DEDE1391
	for <patchwork-kvm@patchwork.kernel.org>;
 Sun, 31 May 2020 16:39:16 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 46B772074B
	for <patchwork-kvm@patchwork.kernel.org>;
 Sun, 31 May 2020 16:39:16 +0000 (UTC)
Authentication-Results: mail.kernel.org;
	dkim=pass (1024-bit key) header.d=redhat.com header.i=@redhat.com
 header.b="O2rReB+f"
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1728229AbgEaQjP (ORCPT
        <rfc822;patchwork-kvm@patchwork.kernel.org>);
        Sun, 31 May 2020 12:39:15 -0400
Received: from us-smtp-delivery-1.mimecast.com ([205.139.110.120]:55770 "EHLO
        us-smtp-1.mimecast.com" rhost-flags-OK-OK-OK-FAIL) by vger.kernel.org
        with ESMTP id S1728212AbgEaQjP (ORCPT <rfc822;kvm@vger.kernel.org>);
        Sun, 31 May 2020 12:39:15 -0400
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=redhat.com;
        s=mimecast20190719; t=1590943153;
        h=from:from:reply-to:subject:subject:date:date:message-id:message-id:
         to:to:cc:cc:mime-version:mime-version:
  content-type:content-type:content-type:
         content-transfer-encoding:content-transfer-encoding:
         in-reply-to:in-reply-to:references:references;
        bh=sMv0WAWso8oUAufIgFUwjed/SkQYQOJci7UGvUEGULg=;
        b=O2rReB+fiBqs0kk2lnP2VUBQAheDQaiCEGKiBUFxXwa3nPn662vy55K+GO2ZqDrYX1yrvb
        +thhklU9o1/KGf8U8BK19iO/FTPzrJPfnY6V0nWdGL8OZzbNRvfbAbBySV8jI4uIWNBm8U
        TFhrYHSrMj2+p3d4jGuvOUydg6IkY0g=
Received: from mail-wm1-f72.google.com (mail-wm1-f72.google.com
 [209.85.128.72]) (Using TLS) by relay.mimecast.com with ESMTP id
 us-mta-444-wrY9PkhxPb6QN_CAfsydtQ-1; Sun, 31 May 2020 12:39:11 -0400
X-MC-Unique: wrY9PkhxPb6QN_CAfsydtQ-1
Received: by mail-wm1-f72.google.com with SMTP id v23so1917582wmj.0
        for <kvm@vger.kernel.org>; Sun, 31 May 2020 09:39:11 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
         :references:mime-version:content-transfer-encoding;
        bh=sMv0WAWso8oUAufIgFUwjed/SkQYQOJci7UGvUEGULg=;
        b=efk1gJ3AGl5x9ibhaPNbogsNQSopKb5Gp5Y0vUSsUIlU3Y0LNUch1ICItwY49YR3d3
         IydhSfFtjrKBsJzjybqgivqvu1q0eQMtKWurk95PKqNSzincSDCue/lQ0MiXn722sl0Z
         +H/bPYe6scM65HKUSN2/y7GbKpw5nP22YlXyLdy3xWdB2zMHObwasHai7M6MN4+D/aNQ
         QxKQYUjOSYvCAFesku8xieLTZHHDX44QRvY1cgx96sN5euQoBt56aEjocLqOL98BYuS8
         c0P4AkQpu+BZS3v+LfUfoN8K/1I4uoJnrhEFO8DfNEck0FwHSCVrhxquobHRe1f7V9/F
         CIPw==
X-Gm-Message-State: AOAM533rKXTC+uHzngQe+YKNidLU0tTx2oS9ZwlRe0Bo9nSLiFQ996Ps
        D8nvDiOsjJj3MRrCTUaLibDB6M+D0RkWL5GkbLp0AP1yzlMh6/Xw/1QNPjvYy1fviqe5QYfroVG
        p8gEaHfvrJrL6
X-Received: by 2002:a5d:514f:: with SMTP id
 u15mr19116195wrt.132.1590943150627;
        Sun, 31 May 2020 09:39:10 -0700 (PDT)
X-Google-Smtp-Source: 
 ABdhPJyG/iDkpGxrVd4v54lbHxHsAujyHTlU/e7fh0d4gw7L74BATUg8tOFaSEYyfJzJ1sFZwdHjKQ==
X-Received: by 2002:a5d:514f:: with SMTP id
 u15mr19116175wrt.132.1590943150481;
        Sun, 31 May 2020 09:39:10 -0700 (PDT)
Received: from localhost.localdomain (43.red-83-51-162.dynamicip.rima-tde.net.
 [83.51.162.43])
        by smtp.gmail.com with ESMTPSA id
 v7sm8920858wme.46.2020.05.31.09.39.08
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Sun, 31 May 2020 09:39:09 -0700 (PDT)
From: =?utf-8?q?Philippe_Mathieu-Daud=C3=A9?= <philmd@redhat.com>
To: qemu-devel@nongnu.org
Cc: Cleber Rosa <crosa@redhat.com>, Kevin Wolf <kwolf@redhat.com>,
 kvm@vger.kernel.org, Richard Henderson <rth@twiddle.net>,
 Fam Zheng <fam@euphon.net>, Eduardo Habkost <ehabkost@redhat.com>,
	=?utf-8?q?Alex_Benn=C3=A9e?= <alex.bennee@linaro.org>,
 Paolo Bonzini <pbonzini@redhat.com>, Max Reitz <mreitz@redhat.com>,
	=?utf-8?q?Philippe_Mathieu-Daud=C3=A9?= <philmd@redhat.com>,
 Stefan Hajnoczi <stefanha@redhat.com>, Markus Armbruster <armbru@redhat.com>,
 Marcelo Tosatti <mtosatti@redhat.com>, qemu-block@nongnu.org,
 John Snow <jsnow@redhat.com>
Subject: [PULL 04/25] scripts/kvm/vmxcap: Use Python 3 interpreter and add
 pseudo-main()
Date: Sun, 31 May 2020 18:38:25 +0200
Message-Id: <20200531163846.25363-5-philmd@redhat.com>
X-Mailer: git-send-email 2.21.3
In-Reply-To: <20200531163846.25363-1-philmd@redhat.com>
References: <20200531163846.25363-1-philmd@redhat.com>
MIME-Version: 1.0
Sender: kvm-owner@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

Signed-off-by: Philippe Mathieu-Daudé <philmd@redhat.com>
Acked-by: Paolo Bonzini <pbonzini@redhat.com>
Reviewed-by: John Snow <jsnow@redhat.com>
Reviewed-by: Kevin Wolf <kwolf@redhat.com>
Message-Id: <20200512103238.7078-5-philmd@redhat.com>
---
 scripts/kvm/vmxcap | 7 ++++---
 1 file changed, 4 insertions(+), 3 deletions(-)

diff --git a/scripts/kvm/vmxcap b/scripts/kvm/vmxcap
index 971ed0e721..6fe66d5f57 100755
--- a/scripts/kvm/vmxcap
+++ b/scripts/kvm/vmxcap
@@ -1,4 +1,4 @@
-#!/usr/bin/python
+#!/usr/bin/env python3
 #
 # tool for querying VMX capabilities
 #
@@ -275,5 +275,6 @@ controls = [
         ),
     ]
 
-for c in controls:
-    c.show()
+if __name__ == '__main__':
+    for c in controls:
+        c.show()

From patchwork Sun May 31 16:38:26 2020
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
X-Patchwork-Submitter: =?utf-8?q?Philippe_Mathieu-Daud=C3=A9?=
 <philmd@redhat.com>
X-Patchwork-Id: 11580729
Return-Path: <SRS0=4Gy4=7N=vger.kernel.org=kvm-owner@kernel.org>
Received: from mail.kernel.org (pdx-korg-mail-1.web.codeaurora.org
 [172.30.200.123])
	by pdx-korg-patchwork-2.web.codeaurora.org (Postfix) with ESMTP id 0B16D90
	for <patchwork-kvm@patchwork.kernel.org>;
 Sun, 31 May 2020 16:39:24 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id E6C2C2074B
	for <patchwork-kvm@patchwork.kernel.org>;
 Sun, 31 May 2020 16:39:23 +0000 (UTC)
Authentication-Results: mail.kernel.org;
	dkim=pass (1024-bit key) header.d=redhat.com header.i=@redhat.com
 header.b="G91Hfw6c"
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1728232AbgEaQjX (ORCPT
        <rfc822;patchwork-kvm@patchwork.kernel.org>);
        Sun, 31 May 2020 12:39:23 -0400
Received: from us-smtp-2.mimecast.com ([205.139.110.61]:39439 "EHLO
        us-smtp-delivery-1.mimecast.com" rhost-flags-OK-OK-OK-FAIL)
        by vger.kernel.org with ESMTP id S1728145AbgEaQjU (ORCPT
        <rfc822;kvm@vger.kernel.org>); Sun, 31 May 2020 12:39:20 -0400
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=redhat.com;
        s=mimecast20190719; t=1590943158;
        h=from:from:reply-to:subject:subject:date:date:message-id:message-id:
         to:to:cc:cc:mime-version:mime-version:
  content-type:content-type:content-type:
         content-transfer-encoding:content-transfer-encoding:
         in-reply-to:in-reply-to:references:references;
        bh=Z30VvxAdMFSGdKMqEcqqUvnaAOKiyK2ObUonHxxh/Vo=;
        b=G91Hfw6cDrhKjmYQ8htB13m1Y/EFdJRrDP3QcL776o4VMGwyzd1+NqengueqegaqSxcvEr
        eY1Rm1rhouc5cFof4UtGQmPzx73HNaiHOBOuIaM1wsgxQCFgQ3IKuIFVcD0ZHVh/rKmCpV
        kZdVjWazVlU5rQEHdI4LAhzIajRAnVw=
Received: from mail-wr1-f70.google.com (mail-wr1-f70.google.com
 [209.85.221.70]) (Using TLS) by relay.mimecast.com with ESMTP id
 us-mta-382-fiBnBJ54OxKCCP-CheTaXg-1; Sun, 31 May 2020 12:39:17 -0400
X-MC-Unique: fiBnBJ54OxKCCP-CheTaXg-1
Received: by mail-wr1-f70.google.com with SMTP id s7so3618524wrm.16
        for <kvm@vger.kernel.org>; Sun, 31 May 2020 09:39:16 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
         :references:mime-version:content-transfer-encoding;
        bh=Z30VvxAdMFSGdKMqEcqqUvnaAOKiyK2ObUonHxxh/Vo=;
        b=bCUYFZyZ3xm5D8uqzvWgshqqffPg+q0IuwC5x87LusCkQwsHRy6cwlT2LJJTfDnhRv
         dpJK/heVJpvQErzPOHCP3CLpiNpu3CozKusAIWHfEBD1zh3LiqWcQ1WmBUXnqhzGkKcz
         tkcreVsyEY2lIHx9vwVU6vE0ublFBASJp1yHriwPFAeawPY4gGVD+M0mUh/0bqCofDdO
         cRGlDcZFR3jt9rTMKNsr+OZ8WbgrtCknyUT+HZln/4CX1ErG9OWKid1QwNgMFlZE3R4p
         DVGVjY2NW/0sIGQYwsFzF3TnNySj8g+ZdjvLVge6DUkC/ufuTKehZl8JAi7JGJZF20Pj
         b53g==
X-Gm-Message-State: AOAM531YI2JRtNoVnXplEfHkoY08b7PQx2Cjjp4HH0gJQdSfXyuXXzqW
        hWeLSHGv69Kmt2Qic4ICKDxINQTaH4JDItPICfyV7TFmqNTJmwk2l3f/QBkw7Zhb+CYR1y1HzzI
        qwc9mslesW3Ig
X-Received: by 2002:a1c:29c2:: with SMTP id p185mr16889178wmp.7.1590943155578;
        Sun, 31 May 2020 09:39:15 -0700 (PDT)
X-Google-Smtp-Source: 
 ABdhPJyOLd8dSnD3qnmQhUEm/Dn1hZEFh70mX5LIcVUN2qnXfZwKc4kvuMmAfTDZzOM7VoEzCzWu+g==
X-Received: by 2002:a1c:29c2:: with SMTP id p185mr16889160wmp.7.1590943155392;
        Sun, 31 May 2020 09:39:15 -0700 (PDT)
Received: from localhost.localdomain (43.red-83-51-162.dynamicip.rima-tde.net.
 [83.51.162.43])
        by smtp.gmail.com with ESMTPSA id
 l204sm9390658wmf.19.2020.05.31.09.39.14
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Sun, 31 May 2020 09:39:14 -0700 (PDT)
From: =?utf-8?q?Philippe_Mathieu-Daud=C3=A9?= <philmd@redhat.com>
To: qemu-devel@nongnu.org
Cc: Cleber Rosa <crosa@redhat.com>, Kevin Wolf <kwolf@redhat.com>,
 kvm@vger.kernel.org, Richard Henderson <rth@twiddle.net>,
 Fam Zheng <fam@euphon.net>, Eduardo Habkost <ehabkost@redhat.com>,
	=?utf-8?q?Alex_Benn=C3=A9e?= <alex.bennee@linaro.org>,
 Paolo Bonzini <pbonzini@redhat.com>, Max Reitz <mreitz@redhat.com>,
	=?utf-8?q?Philippe_Mathieu-Daud=C3=A9?= <philmd@redhat.com>,
 Stefan Hajnoczi <stefanha@redhat.com>, Markus Armbruster <armbru@redhat.com>,
 Marcelo Tosatti <mtosatti@redhat.com>, qemu-block@nongnu.org,
 John Snow <jsnow@redhat.com>
Subject: [PULL 05/25] scripts/modules/module_block: Use Python 3 interpreter &
 add pseudo-main
Date: Sun, 31 May 2020 18:38:26 +0200
Message-Id: <20200531163846.25363-6-philmd@redhat.com>
X-Mailer: git-send-email 2.21.3
In-Reply-To: <20200531163846.25363-1-philmd@redhat.com>
References: <20200531163846.25363-1-philmd@redhat.com>
MIME-Version: 1.0
Sender: kvm-owner@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

Signed-off-by: Philippe Mathieu-Daudé <philmd@redhat.com>
Reviewed-by: John Snow <jsnow@redhat.com>
Reviewed-by: Kevin Wolf <kwolf@redhat.com>
Message-Id: <20200512103238.7078-6-philmd@redhat.com>
---
 scripts/modules/module_block.py | 29 +++++++++++++++--------------
 1 file changed, 15 insertions(+), 14 deletions(-)

diff --git a/scripts/modules/module_block.py b/scripts/modules/module_block.py
index f23191fac1..1109df827d 100644
--- a/scripts/modules/module_block.py
+++ b/scripts/modules/module_block.py
@@ -1,4 +1,4 @@
-#!/usr/bin/python
+#!/usr/bin/env python3
 #
 # Module information generator
 #
@@ -80,19 +80,20 @@ def print_bottom(fheader):
 #endif
 ''')
 
-# First argument: output file
-# All other arguments: modules source files (.c)
-output_file = sys.argv[1]
-with open(output_file, 'w') as fheader:
-    print_top(fheader)
+if __name__ == '__main__':
+    # First argument: output file
+    # All other arguments: modules source files (.c)
+    output_file = sys.argv[1]
+    with open(output_file, 'w') as fheader:
+        print_top(fheader)
 
-    for filename in sys.argv[2:]:
-        if os.path.isfile(filename):
-            process_file(fheader, filename)
-        else:
-            print("File " + filename + " does not exist.", file=sys.stderr)
-            sys.exit(1)
+        for filename in sys.argv[2:]:
+            if os.path.isfile(filename):
+                process_file(fheader, filename)
+            else:
+                print("File " + filename + " does not exist.", file=sys.stderr)
+                sys.exit(1)
 
-    print_bottom(fheader)
+        print_bottom(fheader)
 
-sys.exit(0)
+    sys.exit(0)

From patchwork Sun May 31 16:38:27 2020
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
X-Patchwork-Submitter: =?utf-8?q?Philippe_Mathieu-Daud=C3=A9?=
 <philmd@redhat.com>
X-Patchwork-Id: 11580731
Return-Path: <SRS0=4Gy4=7N=vger.kernel.org=kvm-owner@kernel.org>
Received: from mail.kernel.org (pdx-korg-mail-1.web.codeaurora.org
 [172.30.200.123])
	by pdx-korg-patchwork-2.web.codeaurora.org (Postfix) with ESMTP id 1369890
	for <patchwork-kvm@patchwork.kernel.org>;
 Sun, 31 May 2020 16:39:29 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id ED3BE2074A
	for <patchwork-kvm@patchwork.kernel.org>;
 Sun, 31 May 2020 16:39:28 +0000 (UTC)
Authentication-Results: mail.kernel.org;
	dkim=pass (1024-bit key) header.d=redhat.com header.i=@redhat.com
 header.b="EdaBuI7C"
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1728267AbgEaQj2 (ORCPT
        <rfc822;patchwork-kvm@patchwork.kernel.org>);
        Sun, 31 May 2020 12:39:28 -0400
Received: from us-smtp-2.mimecast.com ([205.139.110.61]:23694 "EHLO
        us-smtp-delivery-1.mimecast.com" rhost-flags-OK-OK-OK-FAIL)
        by vger.kernel.org with ESMTP id S1728243AbgEaQj1 (ORCPT
        <rfc822;kvm@vger.kernel.org>); Sun, 31 May 2020 12:39:27 -0400
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=redhat.com;
        s=mimecast20190719; t=1590943165;
        h=from:from:reply-to:subject:subject:date:date:message-id:message-id:
         to:to:cc:cc:mime-version:mime-version:
  content-type:content-type:content-type:
         content-transfer-encoding:content-transfer-encoding:
         in-reply-to:in-reply-to:references:references;
        bh=zavZXRcfF4vEsC1fffibsH2BOyGQjn9n39JGbmxfN4M=;
        b=EdaBuI7CX6GrM2CE69LNIi4+q2H0HHKQAvQPz5NkGz/x9rcnRqDQ5m5v4pc7LMFkMmGDNa
        X2k1sDyQO95WMxKZcYxeEdQniK59rJtJeM08VMFt+KzEVqyy/DwAhO6AnThb1BXvMHBeZw
        2IOT/uaYWaPo8rlH+IqD6CqkKYKmg3U=
Received: from mail-wr1-f71.google.com (mail-wr1-f71.google.com
 [209.85.221.71]) (Using TLS) by relay.mimecast.com with ESMTP id
 us-mta-194-_SPEDn40MmiWnZ5mfUpv1g-1; Sun, 31 May 2020 12:39:21 -0400
X-MC-Unique: _SPEDn40MmiWnZ5mfUpv1g-1
Received: by mail-wr1-f71.google.com with SMTP id o1so3589628wrm.17
        for <kvm@vger.kernel.org>; Sun, 31 May 2020 09:39:21 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
         :references:mime-version:content-transfer-encoding;
        bh=zavZXRcfF4vEsC1fffibsH2BOyGQjn9n39JGbmxfN4M=;
        b=R/whxiFApiclzj3JlcRi71gtOjFYoQHNStFJXxjcVEdBN4Zrr46Aamju98X3sPHS0Z
         A9lD7DPo0Tkn6BfnYwRxnXHxtQ19CG2tAOnL5USV06gUJHjbeH0Erm8MjBqG+vW+0enO
         6jLX+L1Dfe0ZrgFvNsMzQfllSVzb9T8YCnNrnFnVu9Vx2GnZ57EGqi30msFIICelD/d+
         kJ2deGIytyIq4v0/wN+B1iZ2/3y4X8ZwgZxUjlVuj/8+PIbKeunYXCt7jw8qCE6G0CPl
         ckaKXf0M7AjNnWxBfPHScQIgPjNeHfFHmZVWOxTkVZAfw/ofVU4E7EAOUur9EPbDHz+I
         ymDg==
X-Gm-Message-State: AOAM531GOWDM/at7rbIPm27WowLQBmNuj+bPkgodM5m6AVZDoiLJEijy
        n20K8yQOvf87LfHJz4DXIWv/OXRMkn5wqEiSI/MZnXtoKwHDRxVnpsINuG69vOPjIDZ2HvcYJXV
        g+g+YX8+i8+mZ
X-Received: by 2002:a05:600c:4410:: with SMTP id
 u16mr17583871wmn.88.1590943160626;
        Sun, 31 May 2020 09:39:20 -0700 (PDT)
X-Google-Smtp-Source: 
 ABdhPJxly3Ew6xb8Z2VBdFKMDEhwnRILeq2GKU98Tl7lrJZyURsFrFEvr8EmgNXNr/Rk3c8TXuUC7w==
X-Received: by 2002:a05:600c:4410:: with SMTP id
 u16mr17583850wmn.88.1590943160429;
        Sun, 31 May 2020 09:39:20 -0700 (PDT)
Received: from localhost.localdomain (43.red-83-51-162.dynamicip.rima-tde.net.
 [83.51.162.43])
        by smtp.gmail.com with ESMTPSA id
 w10sm18093502wrp.16.2020.05.31.09.39.19
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Sun, 31 May 2020 09:39:19 -0700 (PDT)
From: =?utf-8?q?Philippe_Mathieu-Daud=C3=A9?= <philmd@redhat.com>
To: qemu-devel@nongnu.org
Cc: Cleber Rosa <crosa@redhat.com>, Kevin Wolf <kwolf@redhat.com>,
 kvm@vger.kernel.org, Richard Henderson <rth@twiddle.net>,
 Fam Zheng <fam@euphon.net>, Eduardo Habkost <ehabkost@redhat.com>,
	=?utf-8?q?Alex_Benn=C3=A9e?= <alex.bennee@linaro.org>,
 Paolo Bonzini <pbonzini@redhat.com>, Max Reitz <mreitz@redhat.com>,
	=?utf-8?q?Philippe_Mathieu-Daud=C3=A9?= <philmd@redhat.com>,
 Stefan Hajnoczi <stefanha@redhat.com>, Markus Armbruster <armbru@redhat.com>,
 Marcelo Tosatti <mtosatti@redhat.com>, qemu-block@nongnu.org,
 John Snow <jsnow@redhat.com>
Subject: [PULL 06/25] scripts/qmp: Fix shebang and imports
Date: Sun, 31 May 2020 18:38:27 +0200
Message-Id: <20200531163846.25363-7-philmd@redhat.com>
X-Mailer: git-send-email 2.21.3
In-Reply-To: <20200531163846.25363-1-philmd@redhat.com>
References: <20200531163846.25363-1-philmd@redhat.com>
MIME-Version: 1.0
Sender: kvm-owner@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

From: John Snow <jsnow@redhat.com>

There's more wrong with these scripts; They are in various stages of
disrepair. That's beyond the scope of this current patchset.

This just mechanically corrects the imports and the shebangs, as part of
ensuring that the python/qemu/lib refactoring didn't break anything
needlessly.

Signed-off-by: John Snow <jsnow@redhat.com>
Message-Id: <20200528222129.23826-2-jsnow@redhat.com>
Reviewed-by: Philippe Mathieu-Daudé <philmd@redhat.com>
Signed-off-by: Philippe Mathieu-Daudé <philmd@redhat.com>
---
 scripts/qmp/qmp      | 4 +++-
 scripts/qmp/qom-fuse | 4 +++-
 scripts/qmp/qom-get  | 4 +++-
 scripts/qmp/qom-list | 4 +++-
 scripts/qmp/qom-set  | 4 +++-
 scripts/qmp/qom-tree | 4 +++-
 6 files changed, 18 insertions(+), 6 deletions(-)

diff --git a/scripts/qmp/qmp b/scripts/qmp/qmp
index 0625fc2aba..8e52e4a54d 100755
--- a/scripts/qmp/qmp
+++ b/scripts/qmp/qmp
@@ -11,7 +11,9 @@
 # See the COPYING file in the top-level directory.
 
 import sys, os
-from qmp import QEMUMonitorProtocol
+
+sys.path.append(os.path.join(os.path.dirname(__file__), '..', '..', 'python'))
+from qemu.qmp import QEMUMonitorProtocol
 
 def print_response(rsp, prefix=[]):
     if type(rsp) == list:
diff --git a/scripts/qmp/qom-fuse b/scripts/qmp/qom-fuse
index 6bada2c33d..5fa6b3bf64 100755
--- a/scripts/qmp/qom-fuse
+++ b/scripts/qmp/qom-fuse
@@ -15,7 +15,9 @@ import fuse, stat
 from fuse import Fuse
 import os, posix
 from errno import *
-from qmp import QEMUMonitorProtocol
+
+sys.path.append(os.path.join(os.path.dirname(__file__), '..', '..', 'python'))
+from qemu.qmp import QEMUMonitorProtocol
 
 fuse.fuse_python_api = (0, 2)
 
diff --git a/scripts/qmp/qom-get b/scripts/qmp/qom-get
index 7c5ede91bb..666df71832 100755
--- a/scripts/qmp/qom-get
+++ b/scripts/qmp/qom-get
@@ -13,7 +13,9 @@
 
 import sys
 import os
-from qmp import QEMUMonitorProtocol
+
+sys.path.append(os.path.join(os.path.dirname(__file__), '..', '..', 'python'))
+from qemu.qmp import QEMUMonitorProtocol
 
 cmd, args = sys.argv[0], sys.argv[1:]
 socket_path = None
diff --git a/scripts/qmp/qom-list b/scripts/qmp/qom-list
index bb68fd65d4..5074fd939f 100755
--- a/scripts/qmp/qom-list
+++ b/scripts/qmp/qom-list
@@ -13,7 +13,9 @@
 
 import sys
 import os
-from qmp import QEMUMonitorProtocol
+
+sys.path.append(os.path.join(os.path.dirname(__file__), '..', '..', 'python'))
+from qemu.qmp import QEMUMonitorProtocol
 
 cmd, args = sys.argv[0], sys.argv[1:]
 socket_path = None
diff --git a/scripts/qmp/qom-set b/scripts/qmp/qom-set
index 19881d85e9..240a78187f 100755
--- a/scripts/qmp/qom-set
+++ b/scripts/qmp/qom-set
@@ -13,7 +13,9 @@
 
 import sys
 import os
-from qmp import QEMUMonitorProtocol
+
+sys.path.append(os.path.join(os.path.dirname(__file__), '..', '..', 'python'))
+from qemu.qmp import QEMUMonitorProtocol
 
 cmd, args = sys.argv[0], sys.argv[1:]
 socket_path = None
diff --git a/scripts/qmp/qom-tree b/scripts/qmp/qom-tree
index fa91147a03..25b0781323 100755
--- a/scripts/qmp/qom-tree
+++ b/scripts/qmp/qom-tree
@@ -15,7 +15,9 @@
 
 import sys
 import os
-from qmp import QEMUMonitorProtocol
+
+sys.path.append(os.path.join(os.path.dirname(__file__), '..', '..', 'python'))
+from qemu.qmp import QEMUMonitorProtocol
 
 cmd, args = sys.argv[0], sys.argv[1:]
 socket_path = None

From patchwork Sun May 31 16:38:28 2020
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
X-Patchwork-Submitter: =?utf-8?q?Philippe_Mathieu-Daud=C3=A9?=
 <philmd@redhat.com>
X-Patchwork-Id: 11580733
Return-Path: <SRS0=4Gy4=7N=vger.kernel.org=kvm-owner@kernel.org>
Received: from mail.kernel.org (pdx-korg-mail-1.web.codeaurora.org
 [172.30.200.123])
	by pdx-korg-patchwork-2.web.codeaurora.org (Postfix) with ESMTP id 6B0C31391
	for <patchwork-kvm@patchwork.kernel.org>;
 Sun, 31 May 2020 16:39:32 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 4C6902074A
	for <patchwork-kvm@patchwork.kernel.org>;
 Sun, 31 May 2020 16:39:32 +0000 (UTC)
Authentication-Results: mail.kernel.org;
	dkim=pass (1024-bit key) header.d=redhat.com header.i=@redhat.com
 header.b="hGS+duYj"
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1728269AbgEaQjb (ORCPT
        <rfc822;patchwork-kvm@patchwork.kernel.org>);
        Sun, 31 May 2020 12:39:31 -0400
Received: from us-smtp-delivery-1.mimecast.com ([207.211.31.120]:24028 "EHLO
        us-smtp-1.mimecast.com" rhost-flags-OK-OK-OK-FAIL) by vger.kernel.org
        with ESMTP id S1728206AbgEaQja (ORCPT <rfc822;kvm@vger.kernel.org>);
        Sun, 31 May 2020 12:39:30 -0400
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=redhat.com;
        s=mimecast20190719; t=1590943168;
        h=from:from:reply-to:subject:subject:date:date:message-id:message-id:
         to:to:cc:cc:mime-version:mime-version:
  content-type:content-type:content-type:
         content-transfer-encoding:content-transfer-encoding:
         in-reply-to:in-reply-to:references:references;
        bh=VZt0ZLdOqej/uZqX1RjbopdK4bZJfrI0RxnWBLQtXiE=;
        b=hGS+duYj1oyLsLVoz8a3tExgKn5AEctyfYX7iDxbwKR+DZ4796r9KzwJ5lIifE1eSVfoD3
        0kU32fnBGA6CGl8o6STtdnznjMwGki03Gqx/e9qyVHzWojY92Pvy/9ZAjpKtPSvG2pi1F5
        z1ZxTjeb4gW9OEvkhdQ5nJ0fNORiQJo=
Received: from mail-wr1-f72.google.com (mail-wr1-f72.google.com
 [209.85.221.72]) (Using TLS) by relay.mimecast.com with ESMTP id
 us-mta-311-nsr2OUb2NjuNAHz8khJDIw-1; Sun, 31 May 2020 12:39:26 -0400
X-MC-Unique: nsr2OUb2NjuNAHz8khJDIw-1
Received: by mail-wr1-f72.google.com with SMTP id e7so3139282wrp.14
        for <kvm@vger.kernel.org>; Sun, 31 May 2020 09:39:26 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
         :references:mime-version:content-transfer-encoding;
        bh=VZt0ZLdOqej/uZqX1RjbopdK4bZJfrI0RxnWBLQtXiE=;
        b=D/5+8xDfzGW8dJY6WdJty2u4resHmzLm2Vbem1vSL5EBtjmxaQo8ujmEll7amRtiVU
         P9E6BXN3bXoygbOb48Yd1jUmvgSES3fdqDWjzzNZVUYJt8d9wROfXcp72kPm+VVTsm28
         YhBup/+N5bCeFfIfrI0G108FhfQ3YCyN0JychvSRilB7xA3mGO9vXzXjxgdDLn9zwqBx
         nl0OjN5WinxTdB2ce5ujR++Z6k9xD6mbhSjdUAoQgp9vN86NuIOg6SdE9qnbqLz5ye4p
         FR+Nul82J40VVi8Bl/d3wC1n7z9Hy70CAhvBEHztc3AaFEj3RQ1CR7Z7SPN82ZiYZ4Hh
         EWWw==
X-Gm-Message-State: AOAM530GPuL3eckYL7XPjCwwyEYr6Gd/8e6KGh+YqGlLzSw1+DDurscb
        eJ5qPI06WGwzmuL+p6oAlTOcIDWSj5oAgevlYJcML+oLaKKQNSOhKi7MJvStgw9YMFdsY/IbRvN
        qKWusWMRL/0vG
X-Received: by 2002:a7b:cb4e:: with SMTP id
 v14mr17434906wmj.164.1590943165707;
        Sun, 31 May 2020 09:39:25 -0700 (PDT)
X-Google-Smtp-Source: 
 ABdhPJyIDhiif77BD+2zEWATjb7OO4Dc+CJOan/ZMSwN3fOg17GLcrYigbcO8xtgQZm9pifBoM5w8w==
X-Received: by 2002:a7b:cb4e:: with SMTP id
 v14mr17434886wmj.164.1590943165498;
        Sun, 31 May 2020 09:39:25 -0700 (PDT)
Received: from localhost.localdomain (43.red-83-51-162.dynamicip.rima-tde.net.
 [83.51.162.43])
        by smtp.gmail.com with ESMTPSA id
 d18sm17660706wrn.34.2020.05.31.09.39.24
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Sun, 31 May 2020 09:39:24 -0700 (PDT)
From: =?utf-8?q?Philippe_Mathieu-Daud=C3=A9?= <philmd@redhat.com>
To: qemu-devel@nongnu.org
Cc: Cleber Rosa <crosa@redhat.com>, Kevin Wolf <kwolf@redhat.com>,
 kvm@vger.kernel.org, Richard Henderson <rth@twiddle.net>,
 Fam Zheng <fam@euphon.net>, Eduardo Habkost <ehabkost@redhat.com>,
	=?utf-8?q?Alex_Benn=C3=A9e?= <alex.bennee@linaro.org>,
 Paolo Bonzini <pbonzini@redhat.com>, Max Reitz <mreitz@redhat.com>,
	=?utf-8?q?Philippe_Mathieu-Daud=C3=A9?= <philmd@redhat.com>,
 Stefan Hajnoczi <stefanha@redhat.com>, Markus Armbruster <armbru@redhat.com>,
 Marcelo Tosatti <mtosatti@redhat.com>, qemu-block@nongnu.org,
 John Snow <jsnow@redhat.com>
Subject: [PULL 07/25] python: remove more instances of sys.version_info
Date: Sun, 31 May 2020 18:38:28 +0200
Message-Id: <20200531163846.25363-8-philmd@redhat.com>
X-Mailer: git-send-email 2.21.3
In-Reply-To: <20200531163846.25363-1-philmd@redhat.com>
References: <20200531163846.25363-1-philmd@redhat.com>
MIME-Version: 1.0
Sender: kvm-owner@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

From: John Snow <jsnow@redhat.com>

We guarantee 3.5+ everywhere; remove more dead checks. In general, try
to avoid using version checks and instead prefer to attempt behavior
when possible.

Signed-off-by: John Snow <jsnow@redhat.com>
Reviewed-by: Philippe Mathieu-Daudé <philmd@redhat.com>
Message-Id: <20200514035230.25756-1-jsnow@redhat.com>
Signed-off-by: Philippe Mathieu-Daudé <philmd@redhat.com>
---
 scripts/analyze-migration.py             |  5 -----
 scripts/decodetree.py                    | 25 +++++++++---------------
 scripts/qmp/qmp-shell                    |  3 ---
 tests/docker/docker.py                   |  5 +++--
 tests/qemu-iotests/nbd-fault-injector.py |  5 +----
 5 files changed, 13 insertions(+), 30 deletions(-)

diff --git a/scripts/analyze-migration.py b/scripts/analyze-migration.py
index 96a31d3974..95838cbff3 100755
--- a/scripts/analyze-migration.py
+++ b/scripts/analyze-migration.py
@@ -25,11 +25,6 @@
 import sys
 
 
-MIN_PYTHON = (3, 2)
-if sys.version_info < MIN_PYTHON:
-    sys.exit("Python %s.%s or later is required.\n" % MIN_PYTHON)
-
-
 def mkdir_p(path):
     try:
         os.makedirs(path)
diff --git a/scripts/decodetree.py b/scripts/decodetree.py
index 46ab917807..f9d204aa36 100755
--- a/scripts/decodetree.py
+++ b/scripts/decodetree.py
@@ -75,13 +75,6 @@ def output(*args):
         output_fd.write(a)
 
 
-if sys.version_info >= (3, 4):
-    re_fullmatch = re.fullmatch
-else:
-    def re_fullmatch(pat, str):
-        return re.match('^' + pat + '$', str)
-
-
 def output_autogen():
     output('/* This file is autogenerated by scripts/decodetree.py.  */\n\n')
 
@@ -428,18 +421,18 @@ def parse_field(lineno, name, toks):
     width = 0
     func = None
     for t in toks:
-        if re_fullmatch('!function=' + re_ident, t):
+        if re.fullmatch('!function=' + re_ident, t):
             if func:
                 error(lineno, 'duplicate function')
             func = t.split('=')
             func = func[1]
             continue
 
-        if re_fullmatch('[0-9]+:s[0-9]+', t):
+        if re.fullmatch('[0-9]+:s[0-9]+', t):
             # Signed field extract
             subtoks = t.split(':s')
             sign = True
-        elif re_fullmatch('[0-9]+:[0-9]+', t):
+        elif re.fullmatch('[0-9]+:[0-9]+', t):
             # Unsigned field extract
             subtoks = t.split(':')
             sign = False
@@ -488,11 +481,11 @@ def parse_arguments(lineno, name, toks):
     flds = []
     extern = False
     for t in toks:
-        if re_fullmatch('!extern', t):
+        if re.fullmatch('!extern', t):
             extern = True
             anyextern = True
             continue
-        if not re_fullmatch(re_ident, t):
+        if not re.fullmatch(re_ident, t):
             error(lineno, 'invalid argument set token "{0}"'.format(t))
         if t in flds:
             error(lineno, 'duplicate argument "{0}"'.format(t))
@@ -621,13 +614,13 @@ def parse_generic(lineno, is_format, name, toks):
             continue
 
         # 'Foo=%Bar' imports a field with a different name.
-        if re_fullmatch(re_ident + '=%' + re_ident, t):
+        if re.fullmatch(re_ident + '=%' + re_ident, t):
             (fname, iname) = t.split('=%')
             flds = add_field_byname(lineno, flds, fname, iname)
             continue
 
         # 'Foo=number' sets an argument field to a constant value
-        if re_fullmatch(re_ident + '=[+-]?[0-9]+', t):
+        if re.fullmatch(re_ident + '=[+-]?[0-9]+', t):
             (fname, value) = t.split('=')
             value = int(value)
             flds = add_field(lineno, flds, fname, ConstField(value))
@@ -635,7 +628,7 @@ def parse_generic(lineno, is_format, name, toks):
 
         # Pattern of 0s, 1s, dots and dashes indicate required zeros,
         # required ones, or dont-cares.
-        if re_fullmatch('[01.-]+', t):
+        if re.fullmatch('[01.-]+', t):
             shift = len(t)
             fms = t.replace('0', '1')
             fms = fms.replace('.', '0')
@@ -652,7 +645,7 @@ def parse_generic(lineno, is_format, name, toks):
             fixedmask = (fixedmask << shift) | fms
             undefmask = (undefmask << shift) | ubm
         # Otherwise, fieldname:fieldwidth
-        elif re_fullmatch(re_ident + ':s?[0-9]+', t):
+        elif re.fullmatch(re_ident + ':s?[0-9]+', t):
             (fname, flen) = t.split(':')
             sign = False
             if flen[0] == 's':
diff --git a/scripts/qmp/qmp-shell b/scripts/qmp/qmp-shell
index a01d31de1e..c5eef06f3f 100755
--- a/scripts/qmp/qmp-shell
+++ b/scripts/qmp/qmp-shell
@@ -77,9 +77,6 @@ import re
 sys.path.append(os.path.join(os.path.dirname(__file__), '..', '..', 'python'))
 from qemu import qmp
 
-if sys.version_info[0] == 2:
-    input = raw_input
-
 class QMPCompleter(list):
     def complete(self, text, state):
         for cmd in self:
diff --git a/tests/docker/docker.py b/tests/docker/docker.py
index d8268c1111..5a9735db78 100755
--- a/tests/docker/docker.py
+++ b/tests/docker/docker.py
@@ -258,12 +258,13 @@ def _kill_instances(self, *args, **kwargs):
         return self._do_kill_instances(True)
 
     def _output(self, cmd, **kwargs):
-        if sys.version_info[1] >= 6:
+        try:
             return subprocess.check_output(self._command + cmd,
                                            stderr=subprocess.STDOUT,
                                            encoding='utf-8',
                                            **kwargs)
-        else:
+        except TypeError:
+            # 'encoding' argument was added in 3.6+
             return subprocess.check_output(self._command + cmd,
                                            stderr=subprocess.STDOUT,
                                            **kwargs).decode('utf-8')
diff --git a/tests/qemu-iotests/nbd-fault-injector.py b/tests/qemu-iotests/nbd-fault-injector.py
index 588d62aebf..78f42c4214 100755
--- a/tests/qemu-iotests/nbd-fault-injector.py
+++ b/tests/qemu-iotests/nbd-fault-injector.py
@@ -47,10 +47,7 @@
 import socket
 import struct
 import collections
-if sys.version_info.major >= 3:
-    import configparser
-else:
-    import ConfigParser as configparser
+import configparser
 
 FAKE_DISK_SIZE = 8 * 1024 * 1024 * 1024 # 8 GB
 

From patchwork Sun May 31 16:38:29 2020
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
X-Patchwork-Submitter: =?utf-8?q?Philippe_Mathieu-Daud=C3=A9?=
 <philmd@redhat.com>
X-Patchwork-Id: 11580735
Return-Path: <SRS0=4Gy4=7N=vger.kernel.org=kvm-owner@kernel.org>
Received: from mail.kernel.org (pdx-korg-mail-1.web.codeaurora.org
 [172.30.200.123])
	by pdx-korg-patchwork-2.web.codeaurora.org (Postfix) with ESMTP id B843090
	for <patchwork-kvm@patchwork.kernel.org>;
 Sun, 31 May 2020 16:39:36 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 9F6AC2074A
	for <patchwork-kvm@patchwork.kernel.org>;
 Sun, 31 May 2020 16:39:36 +0000 (UTC)
Authentication-Results: mail.kernel.org;
	dkim=pass (1024-bit key) header.d=redhat.com header.i=@redhat.com
 header.b="WQtlWz83"
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1728289AbgEaQjf (ORCPT
        <rfc822;patchwork-kvm@patchwork.kernel.org>);
        Sun, 31 May 2020 12:39:35 -0400
Received: from us-smtp-1.mimecast.com ([205.139.110.61]:41091 "EHLO
        us-smtp-delivery-1.mimecast.com" rhost-flags-OK-OK-OK-FAIL)
        by vger.kernel.org with ESMTP id S1728206AbgEaQjf (ORCPT
        <rfc822;kvm@vger.kernel.org>); Sun, 31 May 2020 12:39:35 -0400
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=redhat.com;
        s=mimecast20190719; t=1590943173;
        h=from:from:reply-to:subject:subject:date:date:message-id:message-id:
         to:to:cc:cc:mime-version:mime-version:
  content-type:content-type:content-type:
         content-transfer-encoding:content-transfer-encoding:
         in-reply-to:in-reply-to:references:references;
        bh=rjbH7teVMtjBh+T5ufCfzeY9CyBEBHGmfbosO+YUVTM=;
        b=WQtlWz83FaR6CsbyUIwFSH/qgqVmmwvJQTTx2w64rD3xoTy8PKGninJGCFE/3o+erS47dj
        JhdJbhOJ7h4xohxPB7C37ludFkvyQCATEXurK+QvrfB2tiTiqbhMRy0CdtDmmyaJoZuZA+
        YVEWBA9Corv5k0qM3DYRrz/C4oZ4beU=
Received: from mail-wm1-f72.google.com (mail-wm1-f72.google.com
 [209.85.128.72]) (Using TLS) by relay.mimecast.com with ESMTP id
 us-mta-486-j1wgaqkoMzKki47TsePASg-1; Sun, 31 May 2020 12:39:32 -0400
X-MC-Unique: j1wgaqkoMzKki47TsePASg-1
Received: by mail-wm1-f72.google.com with SMTP id x6so1913227wmj.9
        for <kvm@vger.kernel.org>; Sun, 31 May 2020 09:39:31 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
         :references:mime-version:content-transfer-encoding;
        bh=rjbH7teVMtjBh+T5ufCfzeY9CyBEBHGmfbosO+YUVTM=;
        b=i8KEJeBQTIIZwh87QwrODbuJmDE+zMcVaMBXVnNLYJU7+tuW2sStC/1wNwNe/ar9rI
         8YvS+pTucvMpjf42rH9LQV7YYRFSFfUswjeKo5vraEhLu4wywSNsozjdizf9dx0cfp1C
         xWS9ogG/9Z8zzqx+8BJ4ciS+4ZNnVLnGvivGsADN3b0B605TKQuVMYg+5wHTv4pdJqZE
         /5ftXGLdZP5aQY0mU8sBFR5rmRXmKJRACwrzODkoxCGw74cJL4grBJOdDcxpzAshw6Oc
         sb1GGsCnmp0Z3tsE/SqW0zT7v2W8eL5eVpDgoI9K3aMmX4kARSq0n4XTQ+x1aK045w3F
         GsKA==
X-Gm-Message-State: AOAM530hoFu20ZfMzS64McvFOdDdCxDCHwgmTOHIFtB9goOVDDN3W31j
        Tz0gKxqnRmm55/ZierfIhiPzgD+RpMZAGfre5OgtBFhdzE7MziU6n5orwcIMqcfoHBEhunwTY+Y
        p5S0A4/Af9BtL
X-Received: by 2002:a5d:5112:: with SMTP id
 s18mr17632624wrt.160.1590943170817;
        Sun, 31 May 2020 09:39:30 -0700 (PDT)
X-Google-Smtp-Source: 
 ABdhPJxviLkgXrjUX2NcNJC5mie2lsvP1IrSShLdDDtm64dQg0NFzJSb44/ioBt+ym943Nm0qZ2SIA==
X-Received: by 2002:a5d:5112:: with SMTP id
 s18mr17632616wrt.160.1590943170658;
        Sun, 31 May 2020 09:39:30 -0700 (PDT)
Received: from localhost.localdomain (43.red-83-51-162.dynamicip.rima-tde.net.
 [83.51.162.43])
        by smtp.gmail.com with ESMTPSA id
 k26sm9409518wmi.27.2020.05.31.09.39.29
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Sun, 31 May 2020 09:39:30 -0700 (PDT)
From: =?utf-8?q?Philippe_Mathieu-Daud=C3=A9?= <philmd@redhat.com>
To: qemu-devel@nongnu.org
Cc: Cleber Rosa <crosa@redhat.com>, Kevin Wolf <kwolf@redhat.com>,
 kvm@vger.kernel.org, Richard Henderson <rth@twiddle.net>,
 Fam Zheng <fam@euphon.net>, Eduardo Habkost <ehabkost@redhat.com>,
	=?utf-8?q?Alex_Benn=C3=A9e?= <alex.bennee@linaro.org>,
 Paolo Bonzini <pbonzini@redhat.com>, Max Reitz <mreitz@redhat.com>,
	=?utf-8?q?Philippe_Mathieu-Daud=C3=A9?= <philmd@redhat.com>,
 Stefan Hajnoczi <stefanha@redhat.com>, Markus Armbruster <armbru@redhat.com>,
 Marcelo Tosatti <mtosatti@redhat.com>, qemu-block@nongnu.org,
 Vladimir Sementsov-Ogievskiy <vsementsov@virtuozzo.com>,
 Andrey Shinkevich <andrey.shinkevich@virtuozzo.com>
Subject: [PULL 08/25] python/qemu/machine: add kill() method
Date: Sun, 31 May 2020 18:38:29 +0200
Message-Id: <20200531163846.25363-9-philmd@redhat.com>
X-Mailer: git-send-email 2.21.3
In-Reply-To: <20200531163846.25363-1-philmd@redhat.com>
References: <20200531163846.25363-1-philmd@redhat.com>
MIME-Version: 1.0
Sender: kvm-owner@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

From: Vladimir Sementsov-Ogievskiy <vsementsov@virtuozzo.com>

Add method to hard-kill vm, without any quit commands.

Signed-off-by: Vladimir Sementsov-Ogievskiy <vsementsov@virtuozzo.com>
Reviewed-by: Andrey Shinkevich <andrey.shinkevich@virtuozzo.com>
Message-Id: <20200217150246.29180-19-vsementsov@virtuozzo.com>
Signed-off-by: Philippe Mathieu-Daudé <philmd@redhat.com>
---
 python/qemu/machine.py | 12 +++++++++---
 1 file changed, 9 insertions(+), 3 deletions(-)

diff --git a/python/qemu/machine.py b/python/qemu/machine.py
index b9a98e2c86..d2f531f1b4 100644
--- a/python/qemu/machine.py
+++ b/python/qemu/machine.py
@@ -342,7 +342,7 @@ def wait(self):
         self._load_io_log()
         self._post_shutdown()
 
-    def shutdown(self, has_quit=False):
+    def shutdown(self, has_quit=False, hard=False):
         """
         Terminate the VM and clean up
         """
@@ -354,7 +354,9 @@ def shutdown(self, has_quit=False):
             self._console_socket = None
 
         if self.is_running():
-            if self._qmp:
+            if hard:
+                self._popen.kill()
+            elif self._qmp:
                 try:
                     if not has_quit:
                         self._qmp.cmd('quit')
@@ -368,7 +370,8 @@ def shutdown(self, has_quit=False):
         self._post_shutdown()
 
         exitcode = self.exitcode()
-        if exitcode is not None and exitcode < 0:
+        if exitcode is not None and exitcode < 0 and \
+                not (exitcode == -9 and hard):
             msg = 'qemu received signal %i: %s'
             if self._qemu_full_args:
                 command = ' '.join(self._qemu_full_args)
@@ -378,6 +381,9 @@ def shutdown(self, has_quit=False):
 
         self._launched = False
 
+    def kill(self):
+        self.shutdown(hard=True)
+
     def set_qmp_monitor(self, enabled=True):
         """
         Set the QMP monitor.

From patchwork Sun May 31 16:38:30 2020
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
X-Patchwork-Submitter: =?utf-8?q?Philippe_Mathieu-Daud=C3=A9?=
 <philmd@redhat.com>
X-Patchwork-Id: 11580737
Return-Path: <SRS0=4Gy4=7N=vger.kernel.org=kvm-owner@kernel.org>
Received: from mail.kernel.org (pdx-korg-mail-1.web.codeaurora.org
 [172.30.200.123])
	by pdx-korg-patchwork-2.web.codeaurora.org (Postfix) with ESMTP id 6098990
	for <patchwork-kvm@patchwork.kernel.org>;
 Sun, 31 May 2020 16:39:41 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 47808207BB
	for <patchwork-kvm@patchwork.kernel.org>;
 Sun, 31 May 2020 16:39:41 +0000 (UTC)
Authentication-Results: mail.kernel.org;
	dkim=pass (1024-bit key) header.d=redhat.com header.i=@redhat.com
 header.b="RqjfETu8"
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1728282AbgEaQjk (ORCPT
        <rfc822;patchwork-kvm@patchwork.kernel.org>);
        Sun, 31 May 2020 12:39:40 -0400
Received: from us-smtp-1.mimecast.com ([207.211.31.81]:38547 "EHLO
        us-smtp-delivery-1.mimecast.com" rhost-flags-OK-OK-OK-FAIL)
        by vger.kernel.org with ESMTP id S1728296AbgEaQjj (ORCPT
        <rfc822;kvm@vger.kernel.org>); Sun, 31 May 2020 12:39:39 -0400
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=redhat.com;
        s=mimecast20190719; t=1590943178;
        h=from:from:reply-to:subject:subject:date:date:message-id:message-id:
         to:to:cc:cc:mime-version:mime-version:
  content-type:content-type:content-type:
         content-transfer-encoding:content-transfer-encoding:
         in-reply-to:in-reply-to:references:references;
        bh=gbfmbJetD8UXBRyHPiWp2CZGSyL0yCJiZ8wSWR7Ajrc=;
        b=RqjfETu8ke3T2NkI9jEjHaVvS7H/EFpLBaeeSjrz2KYAIjAFkcdzAUIyexKy7DViwLfnc5
        Uggs8OvJqFC7XuG/fOtT5Pv5Ql4Jl0xQOOMQL9WsfEZMYdb/32GkasQSyWTwdpu+uDdZB3
        px6v8Yrw7zs1RO+08aUKZDZs9imXmkY=
Received: from mail-wr1-f70.google.com (mail-wr1-f70.google.com
 [209.85.221.70]) (Using TLS) by relay.mimecast.com with ESMTP id
 us-mta-403-QWjtuNHxMGSYOBZFzSzNwQ-1; Sun, 31 May 2020 12:39:36 -0400
X-MC-Unique: QWjtuNHxMGSYOBZFzSzNwQ-1
Received: by mail-wr1-f70.google.com with SMTP id l1so3615005wrc.8
        for <kvm@vger.kernel.org>; Sun, 31 May 2020 09:39:36 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
         :references:mime-version:content-transfer-encoding;
        bh=gbfmbJetD8UXBRyHPiWp2CZGSyL0yCJiZ8wSWR7Ajrc=;
        b=kYyEofCeEemfZm1v1wXKyNszniSR8fW56A2cOgIGzWCQ9Swm7kY1SJtcUxDPa6OwSZ
         7rlVoumhTwM/k2g95MkCr+xy7L3ror9UGbpnGoc55EIm7I/ki2qrgMTwQTaIojzHUYAc
         xLxPW4JaDUlcrjDs1rlh06FV29MJHhXJ0P0rTULHxZDNnTfQBEbsJV27radqouPXVgiq
         saSPg4CJwne/g16Bjaw5ZmpJcJQXRKWX/whH2ScjCNVcOyQKb31kmtsX1vGfdBSkvPHV
         5HjxQBQmyAl8RXK6Tq/bB0VYf7XUe9RSkx1fFEcnVVWshwMEIFc+pHCdJgWay/Xu9Qay
         DV3Q==
X-Gm-Message-State: AOAM532CeGYsSJ8U2FWGYYc9O2ovG4OXATES6jLa8wMHGGH0ct+vlPMX
        +x9yRl4tiypZTSQgLKc1VHxObgWLW8pYyfy+EHSjahVYSYRMojv1d9d44Xk5GTkXUNoiy5TwsAa
        tuS94alup9zvG
X-Received: by 2002:a5d:6905:: with SMTP id t5mr17760707wru.113.1590943175696;
        Sun, 31 May 2020 09:39:35 -0700 (PDT)
X-Google-Smtp-Source: 
 ABdhPJyR0WKTSgw9DfCBwsj7WS7gvkIpsMb9ekd4IwqI/sxgbznb+YzTnTNNzeC4sMj2PMSV+Th05w==
X-Received: by 2002:a5d:6905:: with SMTP id t5mr17760696wru.113.1590943175563;
        Sun, 31 May 2020 09:39:35 -0700 (PDT)
Received: from localhost.localdomain (43.red-83-51-162.dynamicip.rima-tde.net.
 [83.51.162.43])
        by smtp.gmail.com with ESMTPSA id
 s7sm17688910wrr.60.2020.05.31.09.39.34
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Sun, 31 May 2020 09:39:35 -0700 (PDT)
From: =?utf-8?q?Philippe_Mathieu-Daud=C3=A9?= <philmd@redhat.com>
To: qemu-devel@nongnu.org
Cc: Cleber Rosa <crosa@redhat.com>, Kevin Wolf <kwolf@redhat.com>,
 kvm@vger.kernel.org, Richard Henderson <rth@twiddle.net>,
 Fam Zheng <fam@euphon.net>, Eduardo Habkost <ehabkost@redhat.com>,
	=?utf-8?q?Alex_Benn=C3=A9e?= <alex.bennee@linaro.org>,
 Paolo Bonzini <pbonzini@redhat.com>, Max Reitz <mreitz@redhat.com>,
	=?utf-8?q?Philippe_Mathieu-Daud=C3=A9?= <philmd@redhat.com>,
 Stefan Hajnoczi <stefanha@redhat.com>, Markus Armbruster <armbru@redhat.com>,
 Marcelo Tosatti <mtosatti@redhat.com>, qemu-block@nongnu.org,
 John Snow <jsnow@redhat.com>
Subject: [PULL 09/25] python/qemu/machine: remove logging configuration
Date: Sun, 31 May 2020 18:38:30 +0200
Message-Id: <20200531163846.25363-10-philmd@redhat.com>
X-Mailer: git-send-email 2.21.3
In-Reply-To: <20200531163846.25363-1-philmd@redhat.com>
References: <20200531163846.25363-1-philmd@redhat.com>
MIME-Version: 1.0
Sender: kvm-owner@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

From: John Snow <jsnow@redhat.com>

Python 3.5 and above do not print a warning when logging is not
configured. As a library, it's best practice to leave logging
configuration to the client executable.

Signed-off-by: John Snow <jsnow@redhat.com>
Reviewed-by: Philippe Mathieu-Daudé <philmd@redhat.com>
Message-Id: <20200514055403.18902-22-jsnow@redhat.com>
Signed-off-by: Philippe Mathieu-Daudé <philmd@redhat.com>
---
 python/qemu/machine.py | 3 ---
 1 file changed, 3 deletions(-)

diff --git a/python/qemu/machine.py b/python/qemu/machine.py
index d2f531f1b4..41554de533 100644
--- a/python/qemu/machine.py
+++ b/python/qemu/machine.py
@@ -119,9 +119,6 @@ def __init__(self, binary, args=None, wrapper=None, name=None,
         self._console_socket = None
         self._remove_files = []
 
-        # just in case logging wasn't configured by the main script:
-        logging.basicConfig()
-
     def __enter__(self):
         return self
 

From patchwork Sun May 31 16:38:31 2020
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
X-Patchwork-Submitter: =?utf-8?q?Philippe_Mathieu-Daud=C3=A9?=
 <philmd@redhat.com>
X-Patchwork-Id: 11580739
Return-Path: <SRS0=4Gy4=7N=vger.kernel.org=kvm-owner@kernel.org>
Received: from mail.kernel.org (pdx-korg-mail-1.web.codeaurora.org
 [172.30.200.123])
	by pdx-korg-patchwork-2.web.codeaurora.org (Postfix) with ESMTP id DA3AB90
	for <patchwork-kvm@patchwork.kernel.org>;
 Sun, 31 May 2020 16:39:47 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id BD8B0207D5
	for <patchwork-kvm@patchwork.kernel.org>;
 Sun, 31 May 2020 16:39:47 +0000 (UTC)
Authentication-Results: mail.kernel.org;
	dkim=pass (1024-bit key) header.d=redhat.com header.i=@redhat.com
 header.b="M57Rtvdm"
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1728310AbgEaQjr (ORCPT
        <rfc822;patchwork-kvm@patchwork.kernel.org>);
        Sun, 31 May 2020 12:39:47 -0400
Received: from us-smtp-1.mimecast.com ([205.139.110.61]:43845 "EHLO
        us-smtp-delivery-1.mimecast.com" rhost-flags-OK-OK-OK-FAIL)
        by vger.kernel.org with ESMTP id S1728294AbgEaQjp (ORCPT
        <rfc822;kvm@vger.kernel.org>); Sun, 31 May 2020 12:39:45 -0400
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=redhat.com;
        s=mimecast20190719; t=1590943183;
        h=from:from:reply-to:subject:subject:date:date:message-id:message-id:
         to:to:cc:cc:mime-version:mime-version:
  content-type:content-type:content-type:
         content-transfer-encoding:content-transfer-encoding:
         in-reply-to:in-reply-to:references:references;
        bh=3OcgS+8uizQs2BB2jjqHl6ry4DnKvgwh0XUrC24oYQg=;
        b=M57Rtvdmf6nKV7BMsqTaicLK5Vx7zDeQ8vg2Pp95QsNgRnJoYT5IbBlexHFJv7pCvZ4rmI
        4IUsbLwm/xQT3b6AyaMNyvmnWIzpngFIn3WuLC/x/gJDSregzz9FXRS08dUy+tRnYh4p1e
        IcbV+oPRuBeXZqxBG8Y6L+MNpUa4SfY=
Received: from mail-wr1-f71.google.com (mail-wr1-f71.google.com
 [209.85.221.71]) (Using TLS) by relay.mimecast.com with ESMTP id
 us-mta-236-vBOM8gfZNzuPFI-5oFMnhQ-1; Sun, 31 May 2020 12:39:42 -0400
X-MC-Unique: vBOM8gfZNzuPFI-5oFMnhQ-1
Received: by mail-wr1-f71.google.com with SMTP id a4so3615049wrp.5
        for <kvm@vger.kernel.org>; Sun, 31 May 2020 09:39:41 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
         :references:mime-version:content-transfer-encoding;
        bh=3OcgS+8uizQs2BB2jjqHl6ry4DnKvgwh0XUrC24oYQg=;
        b=SE4XNxKq78aI79jWpxaVRC+c7b03wnXOsA2X5o5HrC3RNPbfPhLWWtE+wT9Iniz0x9
         qCsBzGK9prPceBviJtRdNkt6qU4ZIZ5LW/Z0zT0WMW0ma1fQNJqJc4jiowA7+mR2bEM9
         dZRx3Oc7AbgBqPEGLfi4nFdh+XEpjy1+p8Ip12oXPFlB1acvIqUg0wb95Qp05mbIYFFW
         5M0cByTb2Mk6wdryKOkHsiZoBF/GS0CuUwFzno13W+8e3JzZR6UL5uk8sdV33ZpofrQo
         1k67lTnMi6D7KktBLKA0FdsN8JLvFGfzeGlXvvKzxy0aMUDW39aoIODgyJn1R82tjmib
         Ei/w==
X-Gm-Message-State: AOAM531zFirw5EmuXKzR9pJA9EcWMY13Y+YRPME9Ja3AzO01o+S0p4Xz
        GrI2SpkGVEIfPGRJLVE0bB/SrDJCus3InYJoWyE7faB/jiAORiRLtZb8xzUntI+j2Be50pr3CAM
        DD+CPiVzxqrz1
X-Received: by 2002:a1c:230a:: with SMTP id
 j10mr17544791wmj.124.1590943180766;
        Sun, 31 May 2020 09:39:40 -0700 (PDT)
X-Google-Smtp-Source: 
 ABdhPJzwjt9ib7xJBDUlj2i2d+LbU8yd4lrgg9+eyZSY61K4oGbjGUzzZ/w68ViV2DfDZ4MNSeL8Yw==
X-Received: by 2002:a1c:230a:: with SMTP id
 j10mr17544774wmj.124.1590943180526;
        Sun, 31 May 2020 09:39:40 -0700 (PDT)
Received: from localhost.localdomain (43.red-83-51-162.dynamicip.rima-tde.net.
 [83.51.162.43])
        by smtp.gmail.com with ESMTPSA id
 23sm8942553wmo.18.2020.05.31.09.39.39
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Sun, 31 May 2020 09:39:40 -0700 (PDT)
From: =?utf-8?q?Philippe_Mathieu-Daud=C3=A9?= <philmd@redhat.com>
To: qemu-devel@nongnu.org
Cc: Cleber Rosa <crosa@redhat.com>, Kevin Wolf <kwolf@redhat.com>,
 kvm@vger.kernel.org, Richard Henderson <rth@twiddle.net>,
 Fam Zheng <fam@euphon.net>, Eduardo Habkost <ehabkost@redhat.com>,
	=?utf-8?q?Alex_Benn=C3=A9e?= <alex.bennee@linaro.org>,
 Paolo Bonzini <pbonzini@redhat.com>, Max Reitz <mreitz@redhat.com>,
	=?utf-8?q?Philippe_Mathieu-Daud=C3=A9?= <philmd@redhat.com>,
 Stefan Hajnoczi <stefanha@redhat.com>, Markus Armbruster <armbru@redhat.com>,
 Marcelo Tosatti <mtosatti@redhat.com>, qemu-block@nongnu.org,
 John Snow <jsnow@redhat.com>
Subject: [PULL 10/25] python/qemu: delint and add pylintrc
Date: Sun, 31 May 2020 18:38:31 +0200
Message-Id: <20200531163846.25363-11-philmd@redhat.com>
X-Mailer: git-send-email 2.21.3
In-Reply-To: <20200531163846.25363-1-philmd@redhat.com>
References: <20200531163846.25363-1-philmd@redhat.com>
MIME-Version: 1.0
Sender: kvm-owner@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

From: John Snow <jsnow@redhat.com>

Bring our these files up to speed with pylint 2.5.0.
Add a pylintrc file to formalize which pylint subset
we are targeting.

The similarity ignore is there to suppress similarity
reports across imports, which for typing constants,
are going to trigger this report erroneously.

Signed-off-by: John Snow <jsnow@redhat.com>
Reviewed-by: Philippe Mathieu-Daudé <philmd@redhat.com>
Message-Id: <20200528222129.23826-4-jsnow@redhat.com>
Signed-off-by: Philippe Mathieu-Daudé <philmd@redhat.com>
---
 python/qemu/machine.py |  6 ++---
 python/qemu/pylintrc   | 58 ++++++++++++++++++++++++++++++++++++++++++
 python/qemu/qtest.py   | 42 +++++++++++++++++++-----------
 3 files changed, 88 insertions(+), 18 deletions(-)
 create mode 100644 python/qemu/pylintrc

diff --git a/python/qemu/machine.py b/python/qemu/machine.py
index 41554de533..8e4ecd1837 100644
--- a/python/qemu/machine.py
+++ b/python/qemu/machine.py
@@ -58,7 +58,7 @@ def __init__(self, reply):
         self.reply = reply
 
 
-class QEMUMachine(object):
+class QEMUMachine:
     """
     A QEMU VM
 
@@ -239,7 +239,7 @@ def _base_args(self):
                          'chardev=mon,mode=control'])
         if self._machine is not None:
             args.extend(['-machine', self._machine])
-        for i in range(self._console_index):
+        for _ in range(self._console_index):
             args.extend(['-serial', 'null'])
         if self._console_set:
             self._console_address = os.path.join(self._sock_dir,
@@ -374,7 +374,7 @@ def shutdown(self, has_quit=False, hard=False):
                 command = ' '.join(self._qemu_full_args)
             else:
                 command = ''
-            LOG.warning(msg, -exitcode, command)
+            LOG.warning(msg, -int(exitcode), command)
 
         self._launched = False
 
diff --git a/python/qemu/pylintrc b/python/qemu/pylintrc
new file mode 100644
index 0000000000..5d6ae7367d
--- /dev/null
+++ b/python/qemu/pylintrc
@@ -0,0 +1,58 @@
+[MASTER]
+
+[MESSAGES CONTROL]
+
+# Disable the message, report, category or checker with the given id(s). You
+# can either give multiple identifiers separated by comma (,) or put this
+# option multiple times (only on the command line, not in the configuration
+# file where it should appear only once). You can also use "--disable=all" to
+# disable everything first and then reenable specific checks. For example, if
+# you want to run only the similarities checker, you can use "--disable=all
+# --enable=similarities". If you want to run only the classes checker, but have
+# no Warning level messages displayed, use "--disable=all --enable=classes
+# --disable=W".
+disable=too-many-arguments,
+        too-many-instance-attributes,
+        too-many-public-methods,
+
+[REPORTS]
+
+[REFACTORING]
+
+[MISCELLANEOUS]
+
+[LOGGING]
+
+[BASIC]
+
+# Good variable names which should always be accepted, separated by a comma.
+good-names=i,
+           j,
+           k,
+           ex,
+           Run,
+           _,
+           fd,
+
+[VARIABLES]
+
+[STRING]
+
+[SPELLING]
+
+[FORMAT]
+
+[SIMILARITIES]
+
+# Ignore imports when computing similarities.
+ignore-imports=yes
+
+[TYPECHECK]
+
+[CLASSES]
+
+[IMPORTS]
+
+[DESIGN]
+
+[EXCEPTIONS]
diff --git a/python/qemu/qtest.py b/python/qemu/qtest.py
index d24ad04256..53d814c064 100644
--- a/python/qemu/qtest.py
+++ b/python/qemu/qtest.py
@@ -1,5 +1,11 @@
-# QEMU qtest library
-#
+"""
+QEMU qtest library
+
+qtest offers the QEMUQtestProtocol and QEMUQTestMachine classes, which
+offer a connection to QEMU's qtest protocol socket, and a qtest-enabled
+subclass of QEMUMachine, respectively.
+"""
+
 # Copyright (C) 2015 Red Hat Inc.
 #
 # Authors:
@@ -17,19 +23,21 @@
 from .machine import QEMUMachine
 
 
-class QEMUQtestProtocol(object):
-    def __init__(self, address, server=False):
-        """
-        Create a QEMUQtestProtocol object.
+class QEMUQtestProtocol:
+    """
+    QEMUQtestProtocol implements a connection to a qtest socket.
 
-        @param address: QEMU address, can be either a unix socket path (string)
-                        or a tuple in the form ( address, port ) for a TCP
-                        connection
-        @param server: server mode, listens on the socket (bool)
-        @raise socket.error on socket connection errors
-        @note No connection is established, this is done by the connect() or
-              accept() methods
-        """
+    :param address: QEMU address, can be either a unix socket path (string)
+                    or a tuple in the form ( address, port ) for a TCP
+                    connection
+    :param server: server mode, listens on the socket (bool)
+    :raise socket.error: on socket connection errors
+
+    .. note::
+       No conection is estabalished by __init__(), this is done
+       by the connect() or accept() methods.
+    """
+    def __init__(self, address, server=False):
         self._address = address
         self._sock = self._get_sock()
         self._sockfile = None
@@ -73,15 +81,19 @@ def cmd(self, qtest_cmd):
         return resp
 
     def close(self):
+        """Close this socket."""
         self._sock.close()
         self._sockfile.close()
 
     def settimeout(self, timeout):
+        """Set a timeout, in seconds."""
         self._sock.settimeout(timeout)
 
 
 class QEMUQtestMachine(QEMUMachine):
-    '''A QEMU VM'''
+    """
+    A QEMU VM, with a qtest socket available.
+    """
 
     def __init__(self, binary, args=None, name=None, test_dir="/var/tmp",
                  socket_scm_helper=None, sock_dir=None):

From patchwork Sun May 31 16:38:32 2020
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
X-Patchwork-Submitter: =?utf-8?q?Philippe_Mathieu-Daud=C3=A9?=
 <philmd@redhat.com>
X-Patchwork-Id: 11580741
Return-Path: <SRS0=4Gy4=7N=vger.kernel.org=kvm-owner@kernel.org>
Received: from mail.kernel.org (pdx-korg-mail-1.web.codeaurora.org
 [172.30.200.123])
	by pdx-korg-patchwork-2.web.codeaurora.org (Postfix) with ESMTP id C08CB90
	for <patchwork-kvm@patchwork.kernel.org>;
 Sun, 31 May 2020 16:39:54 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id A2491207C4
	for <patchwork-kvm@patchwork.kernel.org>;
 Sun, 31 May 2020 16:39:54 +0000 (UTC)
Authentication-Results: mail.kernel.org;
	dkim=pass (1024-bit key) header.d=redhat.com header.i=@redhat.com
 header.b="jU3vi5C1"
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1728322AbgEaQjx (ORCPT
        <rfc822;patchwork-kvm@patchwork.kernel.org>);
        Sun, 31 May 2020 12:39:53 -0400
Received: from us-smtp-2.mimecast.com ([205.139.110.61]:60672 "EHLO
        us-smtp-delivery-1.mimecast.com" rhost-flags-OK-OK-OK-FAIL)
        by vger.kernel.org with ESMTP id S1728294AbgEaQjx (ORCPT
        <rfc822;kvm@vger.kernel.org>); Sun, 31 May 2020 12:39:53 -0400
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=redhat.com;
        s=mimecast20190719; t=1590943191;
        h=from:from:reply-to:subject:subject:date:date:message-id:message-id:
         to:to:cc:cc:mime-version:mime-version:
  content-type:content-type:content-type:
         content-transfer-encoding:content-transfer-encoding:
         in-reply-to:in-reply-to:references:references;
        bh=T0yaQrYBR9fbxjrwWSMaG0y1Z8dADDvU+WXrcZtsKyw=;
        b=jU3vi5C1dmhd7aSiZLOpJ+XAGEQWOAqWFjctWXT+LFaieywiHqzMP7NuhvCuOEXMuYWM7O
        jh/KKsL89gmcQJlHVAVvkiorO34StzxrPoGi5n9agB/At9qC0bLF7SaXKFPkPHUt+dbc9g
        NoTBeTtrcO6iQ6FzyGERcJtEipy8KJY=
Received: from mail-wm1-f70.google.com (mail-wm1-f70.google.com
 [209.85.128.70]) (Using TLS) by relay.mimecast.com with ESMTP id
 us-mta-186-y8MhXQzYOcKvnaCnv3oNvQ-1; Sun, 31 May 2020 12:39:47 -0400
X-MC-Unique: y8MhXQzYOcKvnaCnv3oNvQ-1
Received: by mail-wm1-f70.google.com with SMTP id h25so174437wmb.0
        for <kvm@vger.kernel.org>; Sun, 31 May 2020 09:39:47 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
         :references:mime-version:content-transfer-encoding;
        bh=T0yaQrYBR9fbxjrwWSMaG0y1Z8dADDvU+WXrcZtsKyw=;
        b=GPoHQnel1dLUCZnOsqFx3Tj4r/mNRU/xvRRJ/hhx7FllSDAE9hn7jWntRISPQELNdZ
         J25pEdZAb92+3F2e7+FAOIssBsT3b4ZzSIzryr62+3SMrWc5yFuA0GYTgN8mdkOPybye
         mlTvzF1UONC5FRQJd+EIkibWljJ4UIX93BQgbfNI1ioG3brHftfpam0Lp/c6iWAvqj51
         1kyR6qsjazbzDfaqovA7FKgm0DFqLI4Utj73DSCy1bPaRUL/OmkZglWr8xx1ITqUUxL3
         v31Py4UWRCsNGBh7hA4jZ/2s8gMo60MjEpE1evYaU8qmmTXs1NeoXqpU49wI/sNLFtdB
         SZvQ==
X-Gm-Message-State: AOAM533N0RvOvp037WQlnnll1MH1yVhsZsVMEjTU+/XViWck9e+BqYX4
        nMoq+PvmCxtOrJNMlJ9IJV4QVeZYhJFl+dtatVgCNy7xzf52vrZAhkWBoCqupiijDhVqJvSBrec
        0AXUWQZR1OnPe
X-Received: by 2002:adf:e692:: with SMTP id
 r18mr17215581wrm.192.1590943186010;
        Sun, 31 May 2020 09:39:46 -0700 (PDT)
X-Google-Smtp-Source: 
 ABdhPJwyzme/eJkzFKriVfDnwFDZTFh5KmHq5g1d6NkwyrSeOmFMs12wVIIfxqx+l/LdP8rud9JxpA==
X-Received: by 2002:adf:e692:: with SMTP id
 r18mr17215570wrm.192.1590943185775;
        Sun, 31 May 2020 09:39:45 -0700 (PDT)
Received: from localhost.localdomain (43.red-83-51-162.dynamicip.rima-tde.net.
 [83.51.162.43])
        by smtp.gmail.com with ESMTPSA id
 h15sm17067658wrt.73.2020.05.31.09.39.44
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Sun, 31 May 2020 09:39:45 -0700 (PDT)
From: =?utf-8?q?Philippe_Mathieu-Daud=C3=A9?= <philmd@redhat.com>
To: qemu-devel@nongnu.org
Cc: Cleber Rosa <crosa@redhat.com>, Kevin Wolf <kwolf@redhat.com>,
 kvm@vger.kernel.org, Richard Henderson <rth@twiddle.net>,
 Fam Zheng <fam@euphon.net>, Eduardo Habkost <ehabkost@redhat.com>,
	=?utf-8?q?Alex_Benn=C3=A9e?= <alex.bennee@linaro.org>,
 Paolo Bonzini <pbonzini@redhat.com>, Max Reitz <mreitz@redhat.com>,
	=?utf-8?q?Philippe_Mathieu-Daud=C3=A9?= <philmd@redhat.com>,
 Stefan Hajnoczi <stefanha@redhat.com>, Markus Armbruster <armbru@redhat.com>,
 Marcelo Tosatti <mtosatti@redhat.com>, qemu-block@nongnu.org,
 John Snow <jsnow@redhat.com>
Subject: [PULL 11/25] python/qemu: delint; add flake8 config
Date: Sun, 31 May 2020 18:38:32 +0200
Message-Id: <20200531163846.25363-12-philmd@redhat.com>
X-Mailer: git-send-email 2.21.3
In-Reply-To: <20200531163846.25363-1-philmd@redhat.com>
References: <20200531163846.25363-1-philmd@redhat.com>
MIME-Version: 1.0
Sender: kvm-owner@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

From: John Snow <jsnow@redhat.com>

Mostly, ignore the "no bare except" rule, because flake8 is not
contextual and cannot determine if we re-raise. Pylint can, though, so
always prefer pylint for that.

Signed-off-by: John Snow <jsnow@redhat.com>
Reviewed-by: Philippe Mathieu-Daudé <philmd@redhat.com>
Message-Id: <20200528222129.23826-5-jsnow@redhat.com>
Signed-off-by: Philippe Mathieu-Daudé <philmd@redhat.com>
---
 python/qemu/.flake8    |  2 ++
 python/qemu/accel.py   |  9 ++++++---
 python/qemu/machine.py | 13 +++++++++----
 python/qemu/qmp.py     |  4 ++--
 4 files changed, 19 insertions(+), 9 deletions(-)
 create mode 100644 python/qemu/.flake8

diff --git a/python/qemu/.flake8 b/python/qemu/.flake8
new file mode 100644
index 0000000000..45d8146f3f
--- /dev/null
+++ b/python/qemu/.flake8
@@ -0,0 +1,2 @@
+[flake8]
+extend-ignore = E722  # Pylint handles this, but smarter.
\ No newline at end of file
diff --git a/python/qemu/accel.py b/python/qemu/accel.py
index 36ae85791e..7fabe62920 100644
--- a/python/qemu/accel.py
+++ b/python/qemu/accel.py
@@ -23,11 +23,12 @@
 # Mapping host architecture to any additional architectures it can
 # support which often includes its 32 bit cousin.
 ADDITIONAL_ARCHES = {
-    "x86_64" : "i386",
-    "aarch64" : "armhf",
-    "ppc64le" : "ppc64",
+    "x86_64": "i386",
+    "aarch64": "armhf",
+    "ppc64le": "ppc64",
 }
 
+
 def list_accel(qemu_bin):
     """
     List accelerators enabled in the QEMU binary.
@@ -47,6 +48,7 @@ def list_accel(qemu_bin):
     # Skip the first line which is the header.
     return [acc.strip() for acc in out.splitlines()[1:]]
 
+
 def kvm_available(target_arch=None, qemu_bin=None):
     """
     Check if KVM is available using the following heuristic:
@@ -69,6 +71,7 @@ def kvm_available(target_arch=None, qemu_bin=None):
         return False
     return True
 
+
 def tcg_available(qemu_bin):
     """
     Check if TCG is available.
diff --git a/python/qemu/machine.py b/python/qemu/machine.py
index 8e4ecd1837..187790ce9e 100644
--- a/python/qemu/machine.py
+++ b/python/qemu/machine.py
@@ -29,6 +29,7 @@
 
 LOG = logging.getLogger(__name__)
 
+
 class QEMUMachineError(Exception):
     """
     Exception called when an error in QEMUMachine happens.
@@ -62,7 +63,8 @@ class QEMUMachine:
     """
     A QEMU VM
 
-    Use this object as a context manager to ensure the QEMU process terminates::
+    Use this object as a context manager to ensure
+    the QEMU process terminates::
 
         with VM(binary) as vm:
             ...
@@ -185,8 +187,10 @@ def send_fd_scm(self, fd=None, file_path=None):
             fd_param.append(str(fd))
 
         devnull = open(os.path.devnull, 'rb')
-        proc = subprocess.Popen(fd_param, stdin=devnull, stdout=subprocess.PIPE,
-                                stderr=subprocess.STDOUT, close_fds=False)
+        proc = subprocess.Popen(
+            fd_param, stdin=devnull, stdout=subprocess.PIPE,
+            stderr=subprocess.STDOUT, close_fds=False
+        )
         output = proc.communicate()[0]
         if output:
             LOG.debug(output)
@@ -485,7 +489,8 @@ def event_wait(self, name, timeout=60.0, match=None):
 
     def events_wait(self, events, timeout=60.0):
         """
-        events_wait waits for and returns a named event from QMP with a timeout.
+        events_wait waits for and returns a named event
+        from QMP with a timeout.
 
         events: a sequence of (name, match_criteria) tuples.
                 The match criteria are optional and may be None.
diff --git a/python/qemu/qmp.py b/python/qemu/qmp.py
index d6c9b2f4b1..6ae7693965 100644
--- a/python/qemu/qmp.py
+++ b/python/qemu/qmp.py
@@ -168,8 +168,8 @@ def accept(self, timeout=15.0):
 
         @param timeout: timeout in seconds (nonnegative float number, or
                         None). The value passed will set the behavior of the
-                        underneath QMP socket as described in [1]. Default value
-                        is set to 15.0.
+                        underneath QMP socket as described in [1].
+                        Default value is set to 15.0.
         @return QMP greeting dict
         @raise OSError on socket connection errors
         @raise QMPConnectError if the greeting is not received

From patchwork Sun May 31 16:38:33 2020
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
X-Patchwork-Submitter: =?utf-8?q?Philippe_Mathieu-Daud=C3=A9?=
 <philmd@redhat.com>
X-Patchwork-Id: 11580743
Return-Path: <SRS0=4Gy4=7N=vger.kernel.org=kvm-owner@kernel.org>
Received: from mail.kernel.org (pdx-korg-mail-1.web.codeaurora.org
 [172.30.200.123])
	by pdx-korg-patchwork-2.web.codeaurora.org (Postfix) with ESMTP id C2EE090
	for <patchwork-kvm@patchwork.kernel.org>;
 Sun, 31 May 2020 16:39:57 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id ABED6207C4
	for <patchwork-kvm@patchwork.kernel.org>;
 Sun, 31 May 2020 16:39:57 +0000 (UTC)
Authentication-Results: mail.kernel.org;
	dkim=pass (1024-bit key) header.d=redhat.com header.i=@redhat.com
 header.b="JcPpYnCK"
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1728351AbgEaQj4 (ORCPT
        <rfc822;patchwork-kvm@patchwork.kernel.org>);
        Sun, 31 May 2020 12:39:56 -0400
Received: from us-smtp-1.mimecast.com ([207.211.31.81]:49634 "EHLO
        us-smtp-delivery-1.mimecast.com" rhost-flags-OK-OK-OK-FAIL)
        by vger.kernel.org with ESMTP id S1728341AbgEaQj4 (ORCPT
        <rfc822;kvm@vger.kernel.org>); Sun, 31 May 2020 12:39:56 -0400
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=redhat.com;
        s=mimecast20190719; t=1590943194;
        h=from:from:reply-to:subject:subject:date:date:message-id:message-id:
         to:to:cc:cc:mime-version:mime-version:
  content-type:content-type:content-type:
         content-transfer-encoding:content-transfer-encoding:
         in-reply-to:in-reply-to:references:references;
        bh=7aysy7LnzzU/PowJNv/vyjVqjvAz/h8eLbGuZ+OSeO4=;
        b=JcPpYnCKTC9+VWDxGaupqHCriVeKb5/Oa0DNOWze9O2JLOiW59sUidonVSdYemEWVHwvLi
        Hv2fE8I/Raexc9m5TNx/2M5H/TfizMXI6yTDwwhibfy+vNsw28ZnfJVP83rqc0aImsoFI5
        CCXFIu+HYwhTkRdksmHUkaHhXdwCm/k=
Received: from mail-wr1-f71.google.com (mail-wr1-f71.google.com
 [209.85.221.71]) (Using TLS) by relay.mimecast.com with ESMTP id
 us-mta-89-3Qkw9K5uNJy3iDlkNjR_Ig-1; Sun, 31 May 2020 12:39:52 -0400
X-MC-Unique: 3Qkw9K5uNJy3iDlkNjR_Ig-1
Received: by mail-wr1-f71.google.com with SMTP id j16so3578968wre.22
        for <kvm@vger.kernel.org>; Sun, 31 May 2020 09:39:52 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
         :references:mime-version:content-transfer-encoding;
        bh=7aysy7LnzzU/PowJNv/vyjVqjvAz/h8eLbGuZ+OSeO4=;
        b=C2RO31AmsdbTMPrLIFSamHwLtgII5pcbRYwemwkg/awyokYDYe7/KFAvfLylGouDtU
         6Z/joCLm4sR3C2c0ZRTddblpDNknDAUMUsfYBNCMWAqUISjGH1u36azcT9/csDuUu+Wm
         qVC5zH7kkcUTkIcQDmiZBN95Q9LFLgVjP3c9PKiPw8BtoVFK86v22bAuyVgt1XER+uWi
         3gxySuuWku2iiqgpjnrshkne09ronGHCv+HMWJZExa455dBXU921VXN2SrZmY+jOaYtb
         Se3r4LenAEp1M/YXEjbbwSI5yCfv6W3zo3DPUmKknI1kML/bKg05RqmhEw5bTG7cQjgB
         kaVQ==
X-Gm-Message-State: AOAM533wSiizmPdEaw+2C/bbjJEQz3JMAyQpzpPt5PJAVrI91Kd9YqFd
        7UFILQ6G3L4WWZZrkD1XSzkdVn2aXFEgovMENU8l3aFcO9C7w8ArPhCOsKCWxSVQkF6N0uObYOM
        ALY8tEt9JjuU8
X-Received: by 2002:a7b:cae2:: with SMTP id t2mr18047629wml.150.1590943190882;
        Sun, 31 May 2020 09:39:50 -0700 (PDT)
X-Google-Smtp-Source: 
 ABdhPJyk81obw3iwl5cmks4QKQu+FzG80vqvlMOpxZsa5rTowYPRYxGfXszL5E/IQCa/DUJwBl8aug==
X-Received: by 2002:a7b:cae2:: with SMTP id t2mr18047608wml.150.1590943190702;
        Sun, 31 May 2020 09:39:50 -0700 (PDT)
Received: from localhost.localdomain (43.red-83-51-162.dynamicip.rima-tde.net.
 [83.51.162.43])
        by smtp.gmail.com with ESMTPSA id
 q1sm5415572wmc.15.2020.05.31.09.39.49
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Sun, 31 May 2020 09:39:50 -0700 (PDT)
From: =?utf-8?q?Philippe_Mathieu-Daud=C3=A9?= <philmd@redhat.com>
To: qemu-devel@nongnu.org
Cc: Cleber Rosa <crosa@redhat.com>, Kevin Wolf <kwolf@redhat.com>,
 kvm@vger.kernel.org, Richard Henderson <rth@twiddle.net>,
 Fam Zheng <fam@euphon.net>, Eduardo Habkost <ehabkost@redhat.com>,
	=?utf-8?q?Alex_Benn=C3=A9e?= <alex.bennee@linaro.org>,
 Paolo Bonzini <pbonzini@redhat.com>, Max Reitz <mreitz@redhat.com>,
	=?utf-8?q?Philippe_Mathieu-Daud=C3=A9?= <philmd@redhat.com>,
 Stefan Hajnoczi <stefanha@redhat.com>, Markus Armbruster <armbru@redhat.com>,
 Marcelo Tosatti <mtosatti@redhat.com>, qemu-block@nongnu.org,
 John Snow <jsnow@redhat.com>
Subject: [PULL 12/25] python/qemu: remove Python2 style super() calls
Date: Sun, 31 May 2020 18:38:33 +0200
Message-Id: <20200531163846.25363-13-philmd@redhat.com>
X-Mailer: git-send-email 2.21.3
In-Reply-To: <20200531163846.25363-1-philmd@redhat.com>
References: <20200531163846.25363-1-philmd@redhat.com>
MIME-Version: 1.0
Sender: kvm-owner@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

From: John Snow <jsnow@redhat.com>

Use the Python3 style instead.

Signed-off-by: John Snow <jsnow@redhat.com>
Reviewed-by: Philippe Mathieu-Daudé <philmd@redhat.com>
Message-Id: <20200514055403.18902-12-jsnow@redhat.com>
Signed-off-by: Philippe Mathieu-Daudé <philmd@redhat.com>
---
 python/qemu/machine.py |  2 +-
 python/qemu/qtest.py   | 15 +++++++--------
 2 files changed, 8 insertions(+), 9 deletions(-)

diff --git a/python/qemu/machine.py b/python/qemu/machine.py
index 187790ce9e..95a20a17f9 100644
--- a/python/qemu/machine.py
+++ b/python/qemu/machine.py
@@ -55,7 +55,7 @@ def __init__(self, reply):
             desc = reply["error"]["desc"]
         except KeyError:
             desc = reply
-        super(MonitorResponseError, self).__init__(desc)
+        super().__init__(desc)
         self.reply = reply
 
 
diff --git a/python/qemu/qtest.py b/python/qemu/qtest.py
index 53d814c064..7943487c2b 100644
--- a/python/qemu/qtest.py
+++ b/python/qemu/qtest.py
@@ -101,29 +101,28 @@ def __init__(self, binary, args=None, name=None, test_dir="/var/tmp",
             name = "qemu-%d" % os.getpid()
         if sock_dir is None:
             sock_dir = test_dir
-        super(QEMUQtestMachine,
-              self).__init__(binary, args, name=name, test_dir=test_dir,
-                             socket_scm_helper=socket_scm_helper,
-                             sock_dir=sock_dir)
+        super().__init__(binary, args, name=name, test_dir=test_dir,
+                         socket_scm_helper=socket_scm_helper,
+                         sock_dir=sock_dir)
         self._qtest = None
         self._qtest_path = os.path.join(sock_dir, name + "-qtest.sock")
 
     def _base_args(self):
-        args = super(QEMUQtestMachine, self)._base_args()
+        args = super()._base_args()
         args.extend(['-qtest', 'unix:path=' + self._qtest_path,
                      '-accel', 'qtest'])
         return args
 
     def _pre_launch(self):
-        super(QEMUQtestMachine, self)._pre_launch()
+        super()._pre_launch()
         self._qtest = QEMUQtestProtocol(self._qtest_path, server=True)
 
     def _post_launch(self):
-        super(QEMUQtestMachine, self)._post_launch()
+        super()._post_launch()
         self._qtest.accept()
 
     def _post_shutdown(self):
-        super(QEMUQtestMachine, self)._post_shutdown()
+        super()._post_shutdown()
         self._remove_if_exists(self._qtest_path)
 
     def qtest(self, cmd):

From patchwork Sun May 31 16:38:34 2020
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
X-Patchwork-Submitter: =?utf-8?q?Philippe_Mathieu-Daud=C3=A9?=
 <philmd@redhat.com>
X-Patchwork-Id: 11580749
Return-Path: <SRS0=4Gy4=7N=vger.kernel.org=kvm-owner@kernel.org>
Received: from mail.kernel.org (pdx-korg-mail-1.web.codeaurora.org
 [172.30.200.123])
	by pdx-korg-patchwork-2.web.codeaurora.org (Postfix) with ESMTP id D45A4157C
	for <patchwork-kvm@patchwork.kernel.org>;
 Sun, 31 May 2020 16:40:04 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id BC3952074B
	for <patchwork-kvm@patchwork.kernel.org>;
 Sun, 31 May 2020 16:40:04 +0000 (UTC)
Authentication-Results: mail.kernel.org;
	dkim=pass (1024-bit key) header.d=redhat.com header.i=@redhat.com
 header.b="C45LUFNq"
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1728354AbgEaQkC (ORCPT
        <rfc822;patchwork-kvm@patchwork.kernel.org>);
        Sun, 31 May 2020 12:40:02 -0400
Received: from us-smtp-2.mimecast.com ([205.139.110.61]:43160 "EHLO
        us-smtp-delivery-1.mimecast.com" rhost-flags-OK-OK-OK-FAIL)
        by vger.kernel.org with ESMTP id S1728206AbgEaQkC (ORCPT
        <rfc822;kvm@vger.kernel.org>); Sun, 31 May 2020 12:40:02 -0400
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=redhat.com;
        s=mimecast20190719; t=1590943200;
        h=from:from:reply-to:subject:subject:date:date:message-id:message-id:
         to:to:cc:cc:mime-version:mime-version:
  content-type:content-type:content-type:
         content-transfer-encoding:content-transfer-encoding:
         in-reply-to:in-reply-to:references:references;
        bh=ZGJCD3WtpxESapRsldRYyPkWs2bF0ehM3T5fdkPvFFk=;
        b=C45LUFNqJlE2qEv2/SDgWA2nPEvqetr/nSchzmK20grBNe3GbDEOUkxmOZjlz9xTseQkks
        Y+1mSgLEhFGgSYSU0V1L5tgoEYOtbMNDyfUAL+mrmOk7Oejh08XtCiqzs+X8kBqA3JBsMR
        1iDBhxsuEjnbSKd/Cm07fAdd2uPfCIs=
Received: from mail-wr1-f71.google.com (mail-wr1-f71.google.com
 [209.85.221.71]) (Using TLS) by relay.mimecast.com with ESMTP id
 us-mta-282-IBVCgHBlMcC19b_bCSGFjQ-1; Sun, 31 May 2020 12:39:57 -0400
X-MC-Unique: IBVCgHBlMcC19b_bCSGFjQ-1
Received: by mail-wr1-f71.google.com with SMTP id j16so3579026wre.22
        for <kvm@vger.kernel.org>; Sun, 31 May 2020 09:39:56 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
         :references:mime-version:content-transfer-encoding;
        bh=ZGJCD3WtpxESapRsldRYyPkWs2bF0ehM3T5fdkPvFFk=;
        b=VlmuqqUm6M+dD8SybecqoghetqRC+nGkKEYSU23yOV/VDS8fGxOAIiCKQvkjRKrLPe
         cqkOdtn+isu4kKOVrXDJ51W98pJjIz3nOxz8C+ZQG7v549wYQcifOPUrT5K/CRNpjQL2
         L1Wn17nEJf0iCnkFnEpyfQY04/YdHMDu4FYHukuGu91wQ9KK2qKPE9QDiQGgHQJhCrnD
         7ZDdj4Q6W6QS6mg6WZ9A3+nhShl8tdWptMVowioMzHF25R17DM7I/3IswG2sqlRpUjWF
         WCzUo28l3b/RBv+Md4KZhQKBTHYkgMMv3aOesP1OFjlFtSgrDiM3Bz5YKYoMSL9D/Jmy
         bW4Q==
X-Gm-Message-State: AOAM530WCxXUEp9QoEIlqMMSalEkUwg+GwtPmnjRMVpuGb9sgBPzWBYg
        qo58G7LGaV4UGEdtlMXj2NqiVylgWbZOiII6YyPZVGdCV3uwNceYnWQVRJlViGkGQJl4o0DXVQw
        L5B3uh2E2Zpzx
X-Received: by 2002:a7b:c201:: with SMTP id x1mr17564251wmi.58.1590943195858;
        Sun, 31 May 2020 09:39:55 -0700 (PDT)
X-Google-Smtp-Source: 
 ABdhPJyOEXwNNL/vFr901ND3jDCNFYuC5Y9R8OiJUy3KhCsCICPZclc2nGHqbOnLRtzqs9ghv2iSEA==
X-Received: by 2002:a7b:c201:: with SMTP id x1mr17564238wmi.58.1590943195679;
        Sun, 31 May 2020 09:39:55 -0700 (PDT)
Received: from localhost.localdomain (43.red-83-51-162.dynamicip.rima-tde.net.
 [83.51.162.43])
        by smtp.gmail.com with ESMTPSA id
 d13sm8387945wmb.39.2020.05.31.09.39.54
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Sun, 31 May 2020 09:39:55 -0700 (PDT)
From: =?utf-8?q?Philippe_Mathieu-Daud=C3=A9?= <philmd@redhat.com>
To: qemu-devel@nongnu.org
Cc: Cleber Rosa <crosa@redhat.com>, Kevin Wolf <kwolf@redhat.com>,
 kvm@vger.kernel.org, Richard Henderson <rth@twiddle.net>,
 Fam Zheng <fam@euphon.net>, Eduardo Habkost <ehabkost@redhat.com>,
	=?utf-8?q?Alex_Benn=C3=A9e?= <alex.bennee@linaro.org>,
 Paolo Bonzini <pbonzini@redhat.com>, Max Reitz <mreitz@redhat.com>,
	=?utf-8?q?Philippe_Mathieu-Daud=C3=A9?= <philmd@redhat.com>,
 Stefan Hajnoczi <stefanha@redhat.com>, Markus Armbruster <armbru@redhat.com>,
 Marcelo Tosatti <mtosatti@redhat.com>, qemu-block@nongnu.org,
 John Snow <jsnow@redhat.com>
Subject: [PULL 13/25] python/qemu: fix socket.makefile() typing
Date: Sun, 31 May 2020 18:38:34 +0200
Message-Id: <20200531163846.25363-14-philmd@redhat.com>
X-Mailer: git-send-email 2.21.3
In-Reply-To: <20200531163846.25363-1-philmd@redhat.com>
References: <20200531163846.25363-1-philmd@redhat.com>
MIME-Version: 1.0
Sender: kvm-owner@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

From: John Snow <jsnow@redhat.com>

Note:

A bug in typeshed (https://github.com/python/typeshed/issues/3977)
misinterprets the type of makefile(). Work around this by explicitly
stating that we are opening a text-mode file.

Signed-off-by: John Snow <jsnow@redhat.com>
Reviewed-by: Philippe Mathieu-Daudé <philmd@redhat.com>
Message-Id: <20200514055403.18902-13-jsnow@redhat.com>
Signed-off-by: Philippe Mathieu-Daudé <philmd@redhat.com>
---
 python/qemu/qmp.py   | 10 +++++++---
 python/qemu/qtest.py | 12 ++++++++----
 2 files changed, 15 insertions(+), 7 deletions(-)

diff --git a/python/qemu/qmp.py b/python/qemu/qmp.py
index 6ae7693965..73d49050ed 100644
--- a/python/qemu/qmp.py
+++ b/python/qemu/qmp.py
@@ -11,6 +11,10 @@
 import errno
 import socket
 import logging
+from typing import (
+    Optional,
+    TextIO,
+)
 
 
 class QMPError(Exception):
@@ -61,7 +65,7 @@ def __init__(self, address, server=False, nickname=None):
         self.__events = []
         self.__address = address
         self.__sock = self.__get_sock()
-        self.__sockfile = None
+        self.__sockfile: Optional[TextIO] = None
         self._nickname = nickname
         if self._nickname:
             self.logger = logging.getLogger('QMP').getChild(self._nickname)
@@ -157,7 +161,7 @@ def connect(self, negotiate=True):
         @raise QMPCapabilitiesError if fails to negotiate capabilities
         """
         self.__sock.connect(self.__address)
-        self.__sockfile = self.__sock.makefile()
+        self.__sockfile = self.__sock.makefile(mode='r')
         if negotiate:
             return self.__negotiate_capabilities()
         return None
@@ -180,7 +184,7 @@ def accept(self, timeout=15.0):
         """
         self.__sock.settimeout(timeout)
         self.__sock, _ = self.__sock.accept()
-        self.__sockfile = self.__sock.makefile()
+        self.__sockfile = self.__sock.makefile(mode='r')
         return self.__negotiate_capabilities()
 
     def cmd_obj(self, qmp_cmd):
diff --git a/python/qemu/qtest.py b/python/qemu/qtest.py
index 7943487c2b..4c88590eb0 100644
--- a/python/qemu/qtest.py
+++ b/python/qemu/qtest.py
@@ -19,6 +19,7 @@
 
 import socket
 import os
+from typing import Optional, TextIO
 
 from .machine import QEMUMachine
 
@@ -40,7 +41,7 @@ class QEMUQtestProtocol:
     def __init__(self, address, server=False):
         self._address = address
         self._sock = self._get_sock()
-        self._sockfile = None
+        self._sockfile: Optional[TextIO] = None
         if server:
             self._sock.bind(self._address)
             self._sock.listen(1)
@@ -59,7 +60,7 @@ def connect(self):
         @raise socket.error on socket connection errors
         """
         self._sock.connect(self._address)
-        self._sockfile = self._sock.makefile()
+        self._sockfile = self._sock.makefile(mode='r')
 
     def accept(self):
         """
@@ -68,7 +69,7 @@ def accept(self):
         @raise socket.error on socket connection errors
         """
         self._sock, _ = self._sock.accept()
-        self._sockfile = self._sock.makefile()
+        self._sockfile = self._sock.makefile(mode='r')
 
     def cmd(self, qtest_cmd):
         """
@@ -76,6 +77,7 @@ def cmd(self, qtest_cmd):
 
         @param qtest_cmd: qtest command text to be sent
         """
+        assert self._sockfile is not None
         self._sock.sendall((qtest_cmd + "\n").encode('utf-8'))
         resp = self._sockfile.readline()
         return resp
@@ -83,7 +85,9 @@ def cmd(self, qtest_cmd):
     def close(self):
         """Close this socket."""
         self._sock.close()
-        self._sockfile.close()
+        if self._sockfile:
+            self._sockfile.close()
+            self._sockfile = None
 
     def settimeout(self, timeout):
         """Set a timeout, in seconds."""

From patchwork Sun May 31 16:38:35 2020
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
X-Patchwork-Submitter: =?utf-8?q?Philippe_Mathieu-Daud=C3=A9?=
 <philmd@redhat.com>
X-Patchwork-Id: 11580751
Return-Path: <SRS0=4Gy4=7N=vger.kernel.org=kvm-owner@kernel.org>
Received: from mail.kernel.org (pdx-korg-mail-1.web.codeaurora.org
 [172.30.200.123])
	by pdx-korg-patchwork-2.web.codeaurora.org (Postfix) with ESMTP id E6D8D90
	for <patchwork-kvm@patchwork.kernel.org>;
 Sun, 31 May 2020 16:40:08 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id C66FE2074B
	for <patchwork-kvm@patchwork.kernel.org>;
 Sun, 31 May 2020 16:40:08 +0000 (UTC)
Authentication-Results: mail.kernel.org;
	dkim=pass (1024-bit key) header.d=redhat.com header.i=@redhat.com
 header.b="V/rmodck"
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1728357AbgEaQkH (ORCPT
        <rfc822;patchwork-kvm@patchwork.kernel.org>);
        Sun, 31 May 2020 12:40:07 -0400
Received: from us-smtp-delivery-1.mimecast.com ([205.139.110.120]:53414 "EHLO
        us-smtp-1.mimecast.com" rhost-flags-OK-OK-OK-FAIL) by vger.kernel.org
        with ESMTP id S1728341AbgEaQkG (ORCPT <rfc822;kvm@vger.kernel.org>);
        Sun, 31 May 2020 12:40:06 -0400
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=redhat.com;
        s=mimecast20190719; t=1590943204;
        h=from:from:reply-to:subject:subject:date:date:message-id:message-id:
         to:to:cc:cc:mime-version:mime-version:
  content-type:content-type:content-type:
         content-transfer-encoding:content-transfer-encoding:
         in-reply-to:in-reply-to:references:references;
        bh=ssulewpBrPPL8AloNMkgJXTsJOTpzeqWq+VA42pqYDs=;
        b=V/rmodckbutJp7Dlo3/4nSqSrnyN70VqcFMZEiRbOfxFTRVzNkuossR3JMkXLVU1hUXM7E
        si+64jqil2Zo93KBJ55SS+3s2y4sm51Odm7xwQPswW3DXjPoxJd9aUn+YrJfyMRSmiElcB
        kER+sB7KKM8GwOJu4B8n0hj2arJ/svw=
Received: from mail-wr1-f70.google.com (mail-wr1-f70.google.com
 [209.85.221.70]) (Using TLS) by relay.mimecast.com with ESMTP id
 us-mta-286-B0kiJPXUM0O3p9rN1_Q_Dw-1; Sun, 31 May 2020 12:40:02 -0400
X-MC-Unique: B0kiJPXUM0O3p9rN1_Q_Dw-1
Received: by mail-wr1-f70.google.com with SMTP id e1so3634817wrm.3
        for <kvm@vger.kernel.org>; Sun, 31 May 2020 09:40:02 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
         :references:mime-version:content-transfer-encoding;
        bh=ssulewpBrPPL8AloNMkgJXTsJOTpzeqWq+VA42pqYDs=;
        b=jv5GyCN0jNo+vr2XiFcz6kj+fCDn6U5004DSbwB323AKa8FwJ3KOKyDnvovaHAXHZJ
         h/eTFby7uAgTJLHAu2lkrTYlm145DYCskEhMfXo6eeWjLhpUH4YOzLTDNT7ECVfsu62I
         gpVHL6bkzGoxztT6eFx8oe7Pqt08ESOXSpG6slxRujtnprTa9Q4IZSxd/pccD6hTv3g+
         fzmvI7fcCBM6FeBH2Bh6zrXqoxuvBZmgFiObCB5QH0koxOFNmddd81AGOqSX5NLAER+3
         UJzUoj9FJbf/pbE+22jjwWdhovF8vNwffxAPnGEQTkhteZEL2+I15N23JlCMxrlIP+qr
         CLrw==
X-Gm-Message-State: AOAM531VZ6fCPVgwQwFIZnENSslyP4mjq4QOV9GsYgyl4k/SQmsSVVZk
        KEZzIdLZap4+NVmEyAB5Rs2g973lS9cTEEaprm2kwig/bRTjFnga1zAfbqjFdi9AqCZDDJha41u
        9gXpcBqG3oO39
X-Received: by 2002:a7b:c046:: with SMTP id u6mr17054024wmc.57.1590943201017;
        Sun, 31 May 2020 09:40:01 -0700 (PDT)
X-Google-Smtp-Source: 
 ABdhPJzIdvNLMI//OZsjdo+C0sjBhIjuTUkjfNnTxiKuC1ShLlJgATsXVMG+s/5lIguCBK7zduo/Bw==
X-Received: by 2002:a7b:c046:: with SMTP id u6mr17054012wmc.57.1590943200820;
        Sun, 31 May 2020 09:40:00 -0700 (PDT)
Received: from localhost.localdomain (43.red-83-51-162.dynamicip.rima-tde.net.
 [83.51.162.43])
        by smtp.gmail.com with ESMTPSA id
 o9sm8676600wmh.37.2020.05.31.09.39.59
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Sun, 31 May 2020 09:40:00 -0700 (PDT)
From: =?utf-8?q?Philippe_Mathieu-Daud=C3=A9?= <philmd@redhat.com>
To: qemu-devel@nongnu.org
Cc: Cleber Rosa <crosa@redhat.com>, Kevin Wolf <kwolf@redhat.com>,
 kvm@vger.kernel.org, Richard Henderson <rth@twiddle.net>,
 Fam Zheng <fam@euphon.net>, Eduardo Habkost <ehabkost@redhat.com>,
	=?utf-8?q?Alex_Benn=C3=A9e?= <alex.bennee@linaro.org>,
 Paolo Bonzini <pbonzini@redhat.com>, Max Reitz <mreitz@redhat.com>,
	=?utf-8?q?Philippe_Mathieu-Daud=C3=A9?= <philmd@redhat.com>,
 Stefan Hajnoczi <stefanha@redhat.com>, Markus Armbruster <armbru@redhat.com>,
 Marcelo Tosatti <mtosatti@redhat.com>, qemu-block@nongnu.org,
 John Snow <jsnow@redhat.com>
Subject: [PULL 14/25] python/qemu: Adjust traceback typing
Date: Sun, 31 May 2020 18:38:35 +0200
Message-Id: <20200531163846.25363-15-philmd@redhat.com>
X-Mailer: git-send-email 2.21.3
In-Reply-To: <20200531163846.25363-1-philmd@redhat.com>
References: <20200531163846.25363-1-philmd@redhat.com>
MIME-Version: 1.0
Sender: kvm-owner@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

From: John Snow <jsnow@redhat.com>

mypy considers it incorrect to use `bool` to statically return false,
because it will assume that it could conceivably return True, and gives
different analysis in that case. Use a None return to achieve the same
effect, but make mypy happy.

Note: Pylint considers function signatures as code that might trip the
duplicate-code checker. I'd rather not disable this as it does not
trigger often in practice, so I'm disabling it as a one-off and filed a
change request; see https://github.com/PyCQA/pylint/issues/3619

Signed-off-by: John Snow <jsnow@redhat.com>
Acked-by: Philippe Mathieu-Daudé <philmd@redhat.com>
Message-Id: <20200514055403.18902-14-jsnow@redhat.com>
Signed-off-by: Philippe Mathieu-Daudé <philmd@redhat.com>
---
 python/qemu/machine.py |  8 ++++++--
 python/qemu/qmp.py     | 10 ++++++++--
 2 files changed, 14 insertions(+), 4 deletions(-)

diff --git a/python/qemu/machine.py b/python/qemu/machine.py
index 95a20a17f9..041c615052 100644
--- a/python/qemu/machine.py
+++ b/python/qemu/machine.py
@@ -24,6 +24,8 @@
 import shutil
 import socket
 import tempfile
+from typing import Optional, Type
+from types import TracebackType
 
 from . import qmp
 
@@ -124,9 +126,11 @@ def __init__(self, binary, args=None, wrapper=None, name=None,
     def __enter__(self):
         return self
 
-    def __exit__(self, exc_type, exc_val, exc_tb):
+    def __exit__(self,
+                 exc_type: Optional[Type[BaseException]],
+                 exc_val: Optional[BaseException],
+                 exc_tb: Optional[TracebackType]) -> None:
         self.shutdown()
-        return False
 
     def add_monitor_null(self):
         """
diff --git a/python/qemu/qmp.py b/python/qemu/qmp.py
index 73d49050ed..b91c9d5c1c 100644
--- a/python/qemu/qmp.py
+++ b/python/qemu/qmp.py
@@ -14,7 +14,9 @@
 from typing import (
     Optional,
     TextIO,
+    Type,
 )
+from types import TracebackType
 
 
 class QMPError(Exception):
@@ -146,10 +148,14 @@ def __enter__(self):
         # Implement context manager enter function.
         return self
 
-    def __exit__(self, exc_type, exc_value, exc_traceback):
+    def __exit__(self,
+                 # pylint: disable=duplicate-code
+                 # see https://github.com/PyCQA/pylint/issues/3619
+                 exc_type: Optional[Type[BaseException]],
+                 exc_val: Optional[BaseException],
+                 exc_tb: Optional[TracebackType]) -> None:
         # Implement context manager exit function.
         self.close()
-        return False
 
     def connect(self, negotiate=True):
         """

From patchwork Sun May 31 16:38:36 2020
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
X-Patchwork-Submitter: =?utf-8?q?Philippe_Mathieu-Daud=C3=A9?=
 <philmd@redhat.com>
X-Patchwork-Id: 11580753
Return-Path: <SRS0=4Gy4=7N=vger.kernel.org=kvm-owner@kernel.org>
Received: from mail.kernel.org (pdx-korg-mail-1.web.codeaurora.org
 [172.30.200.123])
	by pdx-korg-patchwork-2.web.codeaurora.org (Postfix) with ESMTP id 2F8031391
	for <patchwork-kvm@patchwork.kernel.org>;
 Sun, 31 May 2020 16:40:12 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 169E4207C4
	for <patchwork-kvm@patchwork.kernel.org>;
 Sun, 31 May 2020 16:40:12 +0000 (UTC)
Authentication-Results: mail.kernel.org;
	dkim=pass (1024-bit key) header.d=redhat.com header.i=@redhat.com
 header.b="T6tQ4IUZ"
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1728362AbgEaQkL (ORCPT
        <rfc822;patchwork-kvm@patchwork.kernel.org>);
        Sun, 31 May 2020 12:40:11 -0400
Received: from us-smtp-1.mimecast.com ([205.139.110.61]:32843 "EHLO
        us-smtp-delivery-1.mimecast.com" rhost-flags-OK-OK-OK-FAIL)
        by vger.kernel.org with ESMTP id S1728341AbgEaQkK (ORCPT
        <rfc822;kvm@vger.kernel.org>); Sun, 31 May 2020 12:40:10 -0400
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=redhat.com;
        s=mimecast20190719; t=1590943209;
        h=from:from:reply-to:subject:subject:date:date:message-id:message-id:
         to:to:cc:cc:mime-version:mime-version:
  content-type:content-type:content-type:
         content-transfer-encoding:content-transfer-encoding:
         in-reply-to:in-reply-to:references:references;
        bh=pSwnlYyy2B0PZW1yLAYRpAT/9w1HRsIxeqH6YbUmUyo=;
        b=T6tQ4IUZISIe+f02JMSbr2yuKCRpRruFYCdCzS7DLPuCtXLwyPYOF5eKZlSysH7VsIPvEO
        s8so2qnuDb3kRSKTyIFDFs5cQskDDsCIKDqAJS0cGcH5I4NToynstw4gB9iLAEditNeKtT
        JU0+ZP6DDD7+USsfSIMIveK7vNI+KXU=
Received: from mail-wr1-f72.google.com (mail-wr1-f72.google.com
 [209.85.221.72]) (Using TLS) by relay.mimecast.com with ESMTP id
 us-mta-392-VJ-6hlDCMtCwMulOxaD5RQ-1; Sun, 31 May 2020 12:40:07 -0400
X-MC-Unique: VJ-6hlDCMtCwMulOxaD5RQ-1
Received: by mail-wr1-f72.google.com with SMTP id w4so3623426wrl.13
        for <kvm@vger.kernel.org>; Sun, 31 May 2020 09:40:07 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
         :references:mime-version:content-transfer-encoding;
        bh=pSwnlYyy2B0PZW1yLAYRpAT/9w1HRsIxeqH6YbUmUyo=;
        b=lVElUqJseVY6DMMqjfiqhmQDi6TMoHhpLmNxfnUUNmvAVW/B34PYRXe7vE2RByk35y
         2u8VOGL5wDQxX9WQ4aWHdZkhNEs4rEVDcfzWbzTkihv+t4wm/wvJvhjn35FfeXBbzfIZ
         a2suTbLB6spz2Q4Bl+fS557DActwYx3Hy/ajraisKTdoK7v4rgwz5mat5F0c2YNAU/Tt
         BWLnElHYnVR/LgNAP5ScD5c/IV2ZI5KLKfc4QJC2o9i+qqbpAEkExQpAKcSq3xAiB4Pi
         EzHoFlhHCJC9/1FLou4HBirfBc2MystQWpPUmyUHWYrnWxpzC2NCYUCphR46pVUPNegh
         MAaA==
X-Gm-Message-State: AOAM530+snZGMe37ekxEOr0Ah0UNJLXICN8uyE5MWdFA8Z7EFgHn9mvP
        GLTMc/AfBrtXBwRAz6WNxM/Jnz72LpvZNg4BMqaqNLOIPY0+BGDUPPQ2XNpkdcQW9HIpruAhG5S
        QXginyiQDl3Ry
X-Received: by 2002:a1c:4c05:: with SMTP id z5mr6191172wmf.129.1590943206333;
        Sun, 31 May 2020 09:40:06 -0700 (PDT)
X-Google-Smtp-Source: 
 ABdhPJzK6EJL9ukNUJVtb0DzQQtMY6apR9VUSafpsaZhu2G7jdYEUit4j1V2cYWBkGwNjw7QAftH3A==
X-Received: by 2002:a1c:4c05:: with SMTP id z5mr6191153wmf.129.1590943206180;
        Sun, 31 May 2020 09:40:06 -0700 (PDT)
Received: from localhost.localdomain (43.red-83-51-162.dynamicip.rima-tde.net.
 [83.51.162.43])
        by smtp.gmail.com with ESMTPSA id
 k16sm16048090wrp.66.2020.05.31.09.40.04
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Sun, 31 May 2020 09:40:05 -0700 (PDT)
From: =?utf-8?q?Philippe_Mathieu-Daud=C3=A9?= <philmd@redhat.com>
To: qemu-devel@nongnu.org
Cc: Cleber Rosa <crosa@redhat.com>, Kevin Wolf <kwolf@redhat.com>,
 kvm@vger.kernel.org, Richard Henderson <rth@twiddle.net>,
 Fam Zheng <fam@euphon.net>, Eduardo Habkost <ehabkost@redhat.com>,
	=?utf-8?q?Alex_Benn=C3=A9e?= <alex.bennee@linaro.org>,
 Paolo Bonzini <pbonzini@redhat.com>, Max Reitz <mreitz@redhat.com>,
	=?utf-8?q?Philippe_Mathieu-Daud=C3=A9?= <philmd@redhat.com>,
 Stefan Hajnoczi <stefanha@redhat.com>, Markus Armbruster <armbru@redhat.com>,
 Marcelo Tosatti <mtosatti@redhat.com>, qemu-block@nongnu.org,
 John Snow <jsnow@redhat.com>
Subject: [PULL 15/25] python/qemu/qmp: use True/False for non/blocking modes
Date: Sun, 31 May 2020 18:38:36 +0200
Message-Id: <20200531163846.25363-16-philmd@redhat.com>
X-Mailer: git-send-email 2.21.3
In-Reply-To: <20200531163846.25363-1-philmd@redhat.com>
References: <20200531163846.25363-1-philmd@redhat.com>
MIME-Version: 1.0
Sender: kvm-owner@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

From: John Snow <jsnow@redhat.com>

The type system doesn't want integers.

Signed-off-by: John Snow <jsnow@redhat.com>
Reviewed-by: Philippe Mathieu-Daudé <philmd@redhat.com>
Message-Id: <20200514055403.18902-15-jsnow@redhat.com>
Signed-off-by: Philippe Mathieu-Daudé <philmd@redhat.com>
---
 python/qemu/qmp.py | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/python/qemu/qmp.py b/python/qemu/qmp.py
index b91c9d5c1c..a634c4e26c 100644
--- a/python/qemu/qmp.py
+++ b/python/qemu/qmp.py
@@ -120,14 +120,14 @@ def __get_events(self, wait=False):
         """
 
         # Check for new events regardless and pull them into the cache:
-        self.__sock.setblocking(0)
+        self.__sock.setblocking(False)
         try:
             self.__json_read()
         except OSError as err:
             if err.errno == errno.EAGAIN:
                 # No data available
                 pass
-        self.__sock.setblocking(1)
+        self.__sock.setblocking(True)
 
         # Wait for new events, if needed.
         # if wait is 0.0, this means "no wait" and is also implicitly false.

From patchwork Sun May 31 16:38:37 2020
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
X-Patchwork-Submitter: =?utf-8?q?Philippe_Mathieu-Daud=C3=A9?=
 <philmd@redhat.com>
X-Patchwork-Id: 11580755
Return-Path: <SRS0=4Gy4=7N=vger.kernel.org=kvm-owner@kernel.org>
Received: from mail.kernel.org (pdx-korg-mail-1.web.codeaurora.org
 [172.30.200.123])
	by pdx-korg-patchwork-2.web.codeaurora.org (Postfix) with ESMTP id 101381391
	for <patchwork-kvm@patchwork.kernel.org>;
 Sun, 31 May 2020 16:40:17 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id EC056207BB
	for <patchwork-kvm@patchwork.kernel.org>;
 Sun, 31 May 2020 16:40:16 +0000 (UTC)
Authentication-Results: mail.kernel.org;
	dkim=pass (1024-bit key) header.d=redhat.com header.i=@redhat.com
 header.b="XE6HymxV"
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1728167AbgEaQkQ (ORCPT
        <rfc822;patchwork-kvm@patchwork.kernel.org>);
        Sun, 31 May 2020 12:40:16 -0400
Received: from us-smtp-delivery-1.mimecast.com ([207.211.31.120]:41166 "EHLO
        us-smtp-1.mimecast.com" rhost-flags-OK-OK-OK-FAIL) by vger.kernel.org
        with ESMTP id S1728206AbgEaQkP (ORCPT <rfc822;kvm@vger.kernel.org>);
        Sun, 31 May 2020 12:40:15 -0400
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=redhat.com;
        s=mimecast20190719; t=1590943214;
        h=from:from:reply-to:subject:subject:date:date:message-id:message-id:
         to:to:cc:cc:mime-version:mime-version:
  content-type:content-type:content-type:
         content-transfer-encoding:content-transfer-encoding:
         in-reply-to:in-reply-to:references:references;
        bh=ZYPUmQb4YdG6fVvlkNEcNWtgTrI955nKbvTxVdHF9pE=;
        b=XE6HymxVU92x1ivgArpiHGe0JayPsLUOatJ6Ea5bP6m3rRM1vbcQRaPAQ87AjUZH5Kxr5e
        YbpkK6VJw3Av+n7bZ2ahmMqYSt49w3Cu79oiul+MQcDlgYDC2Rezp1PZpDUIlPPCDrMcCp
        l4ontoFdTe/hrKQlclAz/oObF/dhke0=
Received: from mail-wr1-f69.google.com (mail-wr1-f69.google.com
 [209.85.221.69]) (Using TLS) by relay.mimecast.com with ESMTP id
 us-mta-101-sGRhHpVfNlebwP4JHKltxA-1; Sun, 31 May 2020 12:40:12 -0400
X-MC-Unique: sGRhHpVfNlebwP4JHKltxA-1
Received: by mail-wr1-f69.google.com with SMTP id p9so2659659wrx.10
        for <kvm@vger.kernel.org>; Sun, 31 May 2020 09:40:12 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
         :references:mime-version:content-transfer-encoding;
        bh=ZYPUmQb4YdG6fVvlkNEcNWtgTrI955nKbvTxVdHF9pE=;
        b=NNA5mQzCULnciLZX9vIz0AZFxWnOTUt67vomWVDi6bIJ9jVSAK6/T+/ss1MJww//Pt
         wMLpnLOMRFtSRSDi9dcN48hZT2Sf3aK+n6FT7zKGXhjYe8Ep1GEpoAnojZ1QeKQvDBih
         iMaxJChXhHSSERTy0UcmYC6ba7VzaJk+bgrrenj5KQKIBvONC8E3VpYp2Q1EvOhZ3oiy
         YkjP3j0p1AoHVuRhmj4Ws9qQQF8ffUw4Oksx86xDY4ru8+WoBTx1ad2EIr7wdKP6ThjN
         IiTpwyjXxduWAFfJp7R011iqIGVgcTOtkOLgER4MKa87cS92+m66qpF1RuEi+ASPL4Zg
         S9gg==
X-Gm-Message-State: AOAM531PiXXpgotFR1V3oH+njQkGSU0YrX4hVsDJZvSkArqtUbBMYX1+
        9HzJCu4eIFzapJc2mtNywhnIYPe4KSOwRaWX4Pnq1+SYlyX2Z1x2GzJnC9m73n94c2kqPoc/DLb
        AwsEkbFHlfGxw
X-Received: by 2002:a5d:6b85:: with SMTP id n5mr17895545wrx.11.1590943211355;
        Sun, 31 May 2020 09:40:11 -0700 (PDT)
X-Google-Smtp-Source: 
 ABdhPJyRd7yv6wPdWcd+XCZmDkbf6iSWHFTnRixvYzZNCu7K1dThRp4MzloCWxTm7st5mmh8HR0q3Q==
X-Received: by 2002:a5d:6b85:: with SMTP id n5mr17895523wrx.11.1590943211151;
        Sun, 31 May 2020 09:40:11 -0700 (PDT)
Received: from localhost.localdomain (43.red-83-51-162.dynamicip.rima-tde.net.
 [83.51.162.43])
        by smtp.gmail.com with ESMTPSA id
 s72sm8428958wme.35.2020.05.31.09.40.09
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Sun, 31 May 2020 09:40:10 -0700 (PDT)
From: =?utf-8?q?Philippe_Mathieu-Daud=C3=A9?= <philmd@redhat.com>
To: qemu-devel@nongnu.org
Cc: Cleber Rosa <crosa@redhat.com>, Kevin Wolf <kwolf@redhat.com>,
 kvm@vger.kernel.org, Richard Henderson <rth@twiddle.net>,
 Fam Zheng <fam@euphon.net>, Eduardo Habkost <ehabkost@redhat.com>,
	=?utf-8?q?Alex_Benn=C3=A9e?= <alex.bennee@linaro.org>,
 Paolo Bonzini <pbonzini@redhat.com>, Max Reitz <mreitz@redhat.com>,
	=?utf-8?q?Philippe_Mathieu-Daud=C3=A9?= <philmd@redhat.com>,
 Stefan Hajnoczi <stefanha@redhat.com>, Markus Armbruster <armbru@redhat.com>,
 Marcelo Tosatti <mtosatti@redhat.com>, qemu-block@nongnu.org,
 John Snow <jsnow@redhat.com>
Subject: [PULL 16/25] python/qemu/qmp: assert sockfile is not None
Date: Sun, 31 May 2020 18:38:37 +0200
Message-Id: <20200531163846.25363-17-philmd@redhat.com>
X-Mailer: git-send-email 2.21.3
In-Reply-To: <20200531163846.25363-1-philmd@redhat.com>
References: <20200531163846.25363-1-philmd@redhat.com>
MIME-Version: 1.0
Sender: kvm-owner@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

From: John Snow <jsnow@redhat.com>

In truth, if you don't do this, you'll just get a TypeError
exception. Now, you'll get an AssertionError.

Is this tangibly better? No.
Does mypy complain less? Yes.

Signed-off-by: John Snow <jsnow@redhat.com>
Reviewed-by: Philippe Mathieu-Daudé <philmd@redhat.com>
Message-Id: <20200514055403.18902-21-jsnow@redhat.com>
Signed-off-by: Philippe Mathieu-Daudé <philmd@redhat.com>
---
 python/qemu/qmp.py | 1 +
 1 file changed, 1 insertion(+)

diff --git a/python/qemu/qmp.py b/python/qemu/qmp.py
index a634c4e26c..e64b6b5faa 100644
--- a/python/qemu/qmp.py
+++ b/python/qemu/qmp.py
@@ -94,6 +94,7 @@ def __negotiate_capabilities(self):
         raise QMPCapabilitiesError
 
     def __json_read(self, only_event=False):
+        assert self.__sockfile is not None
         while True:
             data = self.__sockfile.readline()
             if not data:

From patchwork Sun May 31 16:38:38 2020
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
X-Patchwork-Submitter: =?utf-8?q?Philippe_Mathieu-Daud=C3=A9?=
 <philmd@redhat.com>
X-Patchwork-Id: 11580759
Return-Path: <SRS0=4Gy4=7N=vger.kernel.org=kvm-owner@kernel.org>
Received: from mail.kernel.org (pdx-korg-mail-1.web.codeaurora.org
 [172.30.200.123])
	by pdx-korg-patchwork-2.web.codeaurora.org (Postfix) with ESMTP id 7D2E990
	for <patchwork-kvm@patchwork.kernel.org>;
 Sun, 31 May 2020 16:40:26 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 671E1207BB
	for <patchwork-kvm@patchwork.kernel.org>;
 Sun, 31 May 2020 16:40:26 +0000 (UTC)
Authentication-Results: mail.kernel.org;
	dkim=pass (1024-bit key) header.d=redhat.com header.i=@redhat.com
 header.b="Kvz9phEn"
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1728360AbgEaQkZ (ORCPT
        <rfc822;patchwork-kvm@patchwork.kernel.org>);
        Sun, 31 May 2020 12:40:25 -0400
Received: from us-smtp-2.mimecast.com ([205.139.110.61]:52483 "EHLO
        us-smtp-delivery-1.mimecast.com" rhost-flags-OK-OK-OK-FAIL)
        by vger.kernel.org with ESMTP id S1728272AbgEaQkZ (ORCPT
        <rfc822;kvm@vger.kernel.org>); Sun, 31 May 2020 12:40:25 -0400
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=redhat.com;
        s=mimecast20190719; t=1590943223;
        h=from:from:reply-to:subject:subject:date:date:message-id:message-id:
         to:to:cc:cc:mime-version:mime-version:
  content-type:content-type:content-type:
         content-transfer-encoding:content-transfer-encoding:
         in-reply-to:in-reply-to:references:references;
        bh=hSfG89j1yh/LShH9lpHtA4pkqoFK62nXlpymRDXmlAY=;
        b=Kvz9phEn7O0IqmCrW4I0vQt+h+Bgeq1AdRia/HyeEJ1cd6yufPkJ1jNnW+GuVv4EkLK2pR
        wauYnQ5G4w4uvD4b/fMs+Vvj8nJfnWY+g6X0EWTzfm9Q5GxrlPY2aRjGZqRChGdoUMlkR4
        kRg2hcPWvsP4FUoEgvBhu+/GRlg4SWk=
Received: from mail-wm1-f70.google.com (mail-wm1-f70.google.com
 [209.85.128.70]) (Using TLS) by relay.mimecast.com with ESMTP id
 us-mta-106-LApTHkjDMjectnAYlb-44g-1; Sun, 31 May 2020 12:40:17 -0400
X-MC-Unique: LApTHkjDMjectnAYlb-44g-1
Received: by mail-wm1-f70.google.com with SMTP id g84so1916908wmf.4
        for <kvm@vger.kernel.org>; Sun, 31 May 2020 09:40:17 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
         :references:mime-version:content-transfer-encoding;
        bh=hSfG89j1yh/LShH9lpHtA4pkqoFK62nXlpymRDXmlAY=;
        b=WwZ+iukNlm5o3zYQ0C7vqfwKBzMT/4XuvSBcstOTZMa4JFWl9B5zv8GRmBA9Pu/W4v
         0rOPVWjNYRU/hdIDs9GW+H2D/vOIgryU67JfITtHgw/6/ogDiMvra1PZwbRdSREddRmL
         8GnWa8W5lWs0Byy8gMvFC97rRjDi3rpPCHEbk0heGI/Oo8ykoDTbCoQQgRa0m7NRXIRZ
         Mlywfggwx2LprkJnoyRCLi0wkQxHeA/lCE4nYiiN61WwCQBFZzzkaA2zKHF4SfkYGvAP
         Kyrss4CLJLyNAA59AcvO9rv442FWE6ZKNOXWSfQ0OGXGjJM9fIEiTu3g7P78sWPrtSPw
         i9XQ==
X-Gm-Message-State: AOAM531YZ/0PZ76dmZ5Gikhav5z0vro3d74d/QYfqX3WX7d/Sq6VL/hu
        +4ZvgugDP/Bhzus+Qwxl655CxO2p5VZdR/4zScKgMmYosy3sek9+wP4eZIEHxVgLZMrjAqDW1Y+
        SOWQ+je8oGzRx
X-Received: by 2002:a7b:c5d7:: with SMTP id
 n23mr19218261wmk.185.1590943216325;
        Sun, 31 May 2020 09:40:16 -0700 (PDT)
X-Google-Smtp-Source: 
 ABdhPJzh77KlO64phqJTcDuJt0gPKNWkW2egnQKIXztLKi9l6mDsg1cRYoXGChGRkZq/Axxfqzi/sw==
X-Received: by 2002:a7b:c5d7:: with SMTP id
 n23mr19218248wmk.185.1590943216159;
        Sun, 31 May 2020 09:40:16 -0700 (PDT)
Received: from localhost.localdomain (43.red-83-51-162.dynamicip.rima-tde.net.
 [83.51.162.43])
        by smtp.gmail.com with ESMTPSA id
 b187sm8297281wmd.26.2020.05.31.09.40.14
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Sun, 31 May 2020 09:40:15 -0700 (PDT)
From: =?utf-8?q?Philippe_Mathieu-Daud=C3=A9?= <philmd@redhat.com>
To: qemu-devel@nongnu.org
Cc: Cleber Rosa <crosa@redhat.com>, Kevin Wolf <kwolf@redhat.com>,
 kvm@vger.kernel.org, Richard Henderson <rth@twiddle.net>,
 Fam Zheng <fam@euphon.net>, Eduardo Habkost <ehabkost@redhat.com>,
	=?utf-8?q?Alex_Benn=C3=A9e?= <alex.bennee@linaro.org>,
 Paolo Bonzini <pbonzini@redhat.com>, Max Reitz <mreitz@redhat.com>,
	=?utf-8?q?Philippe_Mathieu-Daud=C3=A9?= <philmd@redhat.com>,
 Stefan Hajnoczi <stefanha@redhat.com>, Markus Armbruster <armbru@redhat.com>,
 Marcelo Tosatti <mtosatti@redhat.com>, qemu-block@nongnu.org,
 John Snow <jsnow@redhat.com>
Subject: [PULL 17/25] python/qemu/qtest: Check before accessing _qtest
Date: Sun, 31 May 2020 18:38:38 +0200
Message-Id: <20200531163846.25363-18-philmd@redhat.com>
X-Mailer: git-send-email 2.21.3
In-Reply-To: <20200531163846.25363-1-philmd@redhat.com>
References: <20200531163846.25363-1-philmd@redhat.com>
MIME-Version: 1.0
Sender: kvm-owner@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

From: John Snow <jsnow@redhat.com>

It can be None; so add assertions or exceptions where appropriate to
guard the access accordingly.

Signed-off-by: John Snow <jsnow@redhat.com>
Reviewed-by: Philippe Mathieu-Daudé <philmd@redhat.com>
Message-Id: <20200514055403.18902-30-jsnow@redhat.com>
Signed-off-by: Philippe Mathieu-Daudé <philmd@redhat.com>
---
 python/qemu/qtest.py | 14 +++++++++++---
 1 file changed, 11 insertions(+), 3 deletions(-)

diff --git a/python/qemu/qtest.py b/python/qemu/qtest.py
index 4c88590eb0..888c8bd2f6 100644
--- a/python/qemu/qtest.py
+++ b/python/qemu/qtest.py
@@ -121,7 +121,8 @@ def _pre_launch(self):
         super()._pre_launch()
         self._qtest = QEMUQtestProtocol(self._qtest_path, server=True)
 
-    def _post_launch(self):
+    def _post_launch(self) -> None:
+        assert self._qtest is not None
         super()._post_launch()
         self._qtest.accept()
 
@@ -129,6 +130,13 @@ def _post_shutdown(self):
         super()._post_shutdown()
         self._remove_if_exists(self._qtest_path)
 
-    def qtest(self, cmd):
-        '''Send a qtest command to guest'''
+    def qtest(self, cmd: str) -> str:
+        """
+        Send a qtest command to the guest.
+
+        :param cmd: qtest command to send
+        :return: qtest server response
+        """
+        if self._qtest is None:
+            raise RuntimeError("qtest socket not available")
         return self._qtest.cmd(cmd)

From patchwork Sun May 31 16:38:39 2020
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
X-Patchwork-Submitter: =?utf-8?q?Philippe_Mathieu-Daud=C3=A9?=
 <philmd@redhat.com>
X-Patchwork-Id: 11580761
Return-Path: <SRS0=4Gy4=7N=vger.kernel.org=kvm-owner@kernel.org>
Received: from mail.kernel.org (pdx-korg-mail-1.web.codeaurora.org
 [172.30.200.123])
	by pdx-korg-patchwork-2.web.codeaurora.org (Postfix) with ESMTP id 9C74990
	for <patchwork-kvm@patchwork.kernel.org>;
 Sun, 31 May 2020 16:40:27 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 83DCE2074A
	for <patchwork-kvm@patchwork.kernel.org>;
 Sun, 31 May 2020 16:40:27 +0000 (UTC)
Authentication-Results: mail.kernel.org;
	dkim=pass (1024-bit key) header.d=redhat.com header.i=@redhat.com
 header.b="XP9q1aAs"
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1728368AbgEaQk1 (ORCPT
        <rfc822;patchwork-kvm@patchwork.kernel.org>);
        Sun, 31 May 2020 12:40:27 -0400
Received: from us-smtp-2.mimecast.com ([207.211.31.81]:22365 "EHLO
        us-smtp-delivery-1.mimecast.com" rhost-flags-OK-OK-OK-FAIL)
        by vger.kernel.org with ESMTP id S1728352AbgEaQkZ (ORCPT
        <rfc822;kvm@vger.kernel.org>); Sun, 31 May 2020 12:40:25 -0400
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=redhat.com;
        s=mimecast20190719; t=1590943224;
        h=from:from:reply-to:subject:subject:date:date:message-id:message-id:
         to:to:cc:cc:mime-version:mime-version:
  content-type:content-type:content-type:
         content-transfer-encoding:content-transfer-encoding:
         in-reply-to:in-reply-to:references:references;
        bh=Q4vVNWwGJ6X+mCxN22qm0JQKHOJ0PdAaDdcsNO2TkXQ=;
        b=XP9q1aAsYf1Fr7PLqqnnARozlJZiWStmALF/X+i7vMcGElQWS0/1QB1YzMPzebpPpYsWJj
        DVQltubJAWskQ4AtSPbScOeCKPn4j8GClvEcvyvuGcLj4Zj3HguLLfwphApio1ZHoDZoC4
        fxCTTD4WXuWk+9tzcuA+9aYZUOSdPlc=
Received: from mail-wr1-f70.google.com (mail-wr1-f70.google.com
 [209.85.221.70]) (Using TLS) by relay.mimecast.com with ESMTP id
 us-mta-161-v5aZ3Mg9PEe2Xz7I5S9-cA-1; Sun, 31 May 2020 12:40:22 -0400
X-MC-Unique: v5aZ3Mg9PEe2Xz7I5S9-cA-1
Received: by mail-wr1-f70.google.com with SMTP id p9so2659828wrx.10
        for <kvm@vger.kernel.org>; Sun, 31 May 2020 09:40:22 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
         :references:mime-version:content-transfer-encoding;
        bh=Q4vVNWwGJ6X+mCxN22qm0JQKHOJ0PdAaDdcsNO2TkXQ=;
        b=l1G5UHBNdcBK68LKsAfOm5dkGifzhrT7dK2pMt0jNrjwlqsTlz/Au/na6ZJ1O0wIC/
         vENmos1bFcrCT+PvLuqPkRspw0SAKXBwgfMmCEXu10fSzghd0lpTMurFPnrPV/9q5cEJ
         CYWX32/Kf9HdFYNiXherRdZ+NPiMMEShP15dHIsPTsf3Kw6BY3LeiNKy/BHREDTtfNl0
         7GPjO3IvH2YM0+SHA/xyVi7+NL96VpxFvUl68iqd7FDvpC/MA5rqyA4R8OeBf3ry2MOy
         V51Gux9nPGis5XbOMRr1ElhTJDqbhZgIjuIeyM5krw8wf36NH2VKPyAYWIT8VQJNhwrT
         RHeg==
X-Gm-Message-State: AOAM532Ik7hIaYDe4wyqUhZUv2eVvBz42tF6iH9mjqi1giPfPz0Q9Kcz
        qnjNq0a4X08rf0kBOA/wwSqczFrheTghS8lNOVgYfF5ocErwUC3UM2+PmiBl3bu0SUwrOOODjIh
        /2AMHDDwHW4Hl
X-Received: by 2002:adf:eec2:: with SMTP id a2mr17399492wrp.136.1590943221350;
        Sun, 31 May 2020 09:40:21 -0700 (PDT)
X-Google-Smtp-Source: 
 ABdhPJzTbjh1kanaHu4mvEz5G2IetIDATr+AlkqOK/pFPgvXTE/QruP8PTveawBN85Yr0c5UV+YrRQ==
X-Received: by 2002:adf:eec2:: with SMTP id a2mr17399473wrp.136.1590943221141;
        Sun, 31 May 2020 09:40:21 -0700 (PDT)
Received: from localhost.localdomain (43.red-83-51-162.dynamicip.rima-tde.net.
 [83.51.162.43])
        by smtp.gmail.com with ESMTPSA id
 a1sm10072069wmd.28.2020.05.31.09.40.19
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Sun, 31 May 2020 09:40:20 -0700 (PDT)
From: =?utf-8?q?Philippe_Mathieu-Daud=C3=A9?= <philmd@redhat.com>
To: qemu-devel@nongnu.org
Cc: Cleber Rosa <crosa@redhat.com>, Kevin Wolf <kwolf@redhat.com>,
 kvm@vger.kernel.org, Richard Henderson <rth@twiddle.net>,
 Fam Zheng <fam@euphon.net>, Eduardo Habkost <ehabkost@redhat.com>,
	=?utf-8?q?Alex_Benn=C3=A9e?= <alex.bennee@linaro.org>,
 Paolo Bonzini <pbonzini@redhat.com>, Max Reitz <mreitz@redhat.com>,
	=?utf-8?q?Philippe_Mathieu-Daud=C3=A9?= <philmd@redhat.com>,
 Stefan Hajnoczi <stefanha@redhat.com>, Markus Armbruster <armbru@redhat.com>,
 Marcelo Tosatti <mtosatti@redhat.com>, qemu-block@nongnu.org,
 Robert Foley <robert.foley@linaro.org>, Peter Puhov <peter.puhov@linaro.org>
Subject: [PULL 18/25] tests/vm: Pass --debug through for vm-boot-ssh
Date: Sun, 31 May 2020 18:38:39 +0200
Message-Id: <20200531163846.25363-19-philmd@redhat.com>
X-Mailer: git-send-email 2.21.3
In-Reply-To: <20200531163846.25363-1-philmd@redhat.com>
References: <20200531163846.25363-1-philmd@redhat.com>
MIME-Version: 1.0
Sender: kvm-owner@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

From: Robert Foley <robert.foley@linaro.org>

This helps debug issues that occur during the boot sequence.

Signed-off-by: Robert Foley <robert.foley@linaro.org>
Reviewed-by: Peter Puhov <peter.puhov@linaro.org>
Reviewed-by: Alex Bennée <alex.bennee@linaro.org>
Reviewed-by: Philippe Mathieu-Daudé <philmd@redhat.com>
Tested-by: Philippe Mathieu-Daudé <philmd@redhat.com>
Message-Id: <20200529203458.1038-5-robert.foley@linaro.org>
Signed-off-by: Philippe Mathieu-Daudé <philmd@redhat.com>
---
 tests/vm/Makefile.include | 1 +
 1 file changed, 1 insertion(+)

diff --git a/tests/vm/Makefile.include b/tests/vm/Makefile.include
index 74ab522c55..80f7f6bdee 100644
--- a/tests/vm/Makefile.include
+++ b/tests/vm/Makefile.include
@@ -91,6 +91,7 @@ vm-boot-ssh-%: $(IMAGES_DIR)/%.img
 	$(call quiet-command, \
 		$(PYTHON) $(SRC_PATH)/tests/vm/$* \
 		$(if $(J),--jobs $(J)) \
+		$(if $(V)$(DEBUG), --debug) \
 		--image "$<" \
 		--interactive \
 		false, \

From patchwork Sun May 31 16:38:40 2020
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
X-Patchwork-Submitter: =?utf-8?q?Philippe_Mathieu-Daud=C3=A9?=
 <philmd@redhat.com>
X-Patchwork-Id: 11580765
Return-Path: <SRS0=4Gy4=7N=vger.kernel.org=kvm-owner@kernel.org>
Received: from mail.kernel.org (pdx-korg-mail-1.web.codeaurora.org
 [172.30.200.123])
	by pdx-korg-patchwork-2.web.codeaurora.org (Postfix) with ESMTP id 55DBE1391
	for <patchwork-kvm@patchwork.kernel.org>;
 Sun, 31 May 2020 16:40:34 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 38BDC2074B
	for <patchwork-kvm@patchwork.kernel.org>;
 Sun, 31 May 2020 16:40:34 +0000 (UTC)
Authentication-Results: mail.kernel.org;
	dkim=pass (1024-bit key) header.d=redhat.com header.i=@redhat.com
 header.b="Jb0LfEkk"
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1728372AbgEaQkd (ORCPT
        <rfc822;patchwork-kvm@patchwork.kernel.org>);
        Sun, 31 May 2020 12:40:33 -0400
Received: from us-smtp-2.mimecast.com ([207.211.31.81]:43991 "EHLO
        us-smtp-delivery-1.mimecast.com" rhost-flags-OK-OK-OK-FAIL)
        by vger.kernel.org with ESMTP id S1728272AbgEaQkc (ORCPT
        <rfc822;kvm@vger.kernel.org>); Sun, 31 May 2020 12:40:32 -0400
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=redhat.com;
        s=mimecast20190719; t=1590943230;
        h=from:from:reply-to:subject:subject:date:date:message-id:message-id:
         to:to:cc:cc:mime-version:mime-version:
  content-type:content-type:content-type:
         content-transfer-encoding:content-transfer-encoding:
         in-reply-to:in-reply-to:references:references;
        bh=s8Rk2ct1SwmXVJV/wHXYbsX6rV3XnYQXBZW0Chu6BIg=;
        b=Jb0LfEkkq9eiO+yU4qKLQlMcO4ex3YedAd2UGOZnBu4KdNP76CulXyEd6Hm54sJ6Md2hFf
        VhzGFSaa+cAVObZo9m4+sRgm4OPyySAWlJrbdu/q4+Vvqb5lK0VEEvODtH5RTtNgUSSieX
        BaiR3BgIMDK5VQtWOUpmVQVSt0IzIWc=
Received: from mail-wr1-f69.google.com (mail-wr1-f69.google.com
 [209.85.221.69]) (Using TLS) by relay.mimecast.com with ESMTP id
 us-mta-143-BTHn_8R_PRi-Ibc2G8Ljcg-1; Sun, 31 May 2020 12:40:27 -0400
X-MC-Unique: BTHn_8R_PRi-Ibc2G8Ljcg-1
Received: by mail-wr1-f69.google.com with SMTP id s17so3599641wrt.7
        for <kvm@vger.kernel.org>; Sun, 31 May 2020 09:40:27 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
         :references:mime-version:content-transfer-encoding;
        bh=s8Rk2ct1SwmXVJV/wHXYbsX6rV3XnYQXBZW0Chu6BIg=;
        b=SVta4PabPKe2dw/yFOc8uPJl/6zVFKtIIe7ET4wImX4nW4DiVlbnYqrFbjTc+Ourmb
         0XwVn2NqnX89/2737Y12jhqyZRp1jpAdqluhmpNYOn2e+nEs24NCGZ1FiUdZBqoKlUjR
         tL9cV2FBNUxqEvrzql2U0B9RlQoIzJSh4h2HYWar7w3ttDtvCUv9i3VpzURR4iwCh8k4
         Y8A6Yh0TV6Tu0ZJjfnsWqddbX5aUfUcRRrSv7Dl+AZXfgl900jBDunipYrLSuoYHYU7g
         bJS0xCdHLy6eWHa62LeeNaAwxCIwKwyIGDMUXAd9QWOX2pz+O2NaPCfN7iZeG2vOmKpq
         fqQQ==
X-Gm-Message-State: AOAM530ufTf31Jl/TkqKJOOIwxmTHvpnnghwNXODJkXmRPJv7gbGopEy
        RZ1+PShuPZitrN40msWpkxgMvadqrl48kXXaFgpKQdHOJuh2eOhWIJqbZYOjAa3WtTfqr4aQf7K
        tB+DIcKEB5ck6
X-Received: by 2002:adf:fb0f:: with SMTP id
 c15mr19211126wrr.410.1590943226362;
        Sun, 31 May 2020 09:40:26 -0700 (PDT)
X-Google-Smtp-Source: 
 ABdhPJze0FR0rffg96Z21CHxAOunsqXM7ThaI5OCZlRFyIOIHJ0snfCaqtZZHfecy2V9OYUxse0UKA==
X-Received: by 2002:adf:fb0f:: with SMTP id
 c15mr19211104wrr.410.1590943226147;
        Sun, 31 May 2020 09:40:26 -0700 (PDT)
Received: from localhost.localdomain (43.red-83-51-162.dynamicip.rima-tde.net.
 [83.51.162.43])
        by smtp.gmail.com with ESMTPSA id
 y25sm9023876wmi.2.2020.05.31.09.40.24
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Sun, 31 May 2020 09:40:25 -0700 (PDT)
From: =?utf-8?q?Philippe_Mathieu-Daud=C3=A9?= <philmd@redhat.com>
To: qemu-devel@nongnu.org
Cc: Cleber Rosa <crosa@redhat.com>, Kevin Wolf <kwolf@redhat.com>,
 kvm@vger.kernel.org, Richard Henderson <rth@twiddle.net>,
 Fam Zheng <fam@euphon.net>, Eduardo Habkost <ehabkost@redhat.com>,
	=?utf-8?q?Alex_Benn=C3=A9e?= <alex.bennee@linaro.org>,
 Paolo Bonzini <pbonzini@redhat.com>, Max Reitz <mreitz@redhat.com>,
	=?utf-8?q?Philippe_Mathieu-Daud=C3=A9?= <philmd@redhat.com>,
 Stefan Hajnoczi <stefanha@redhat.com>, Markus Armbruster <armbru@redhat.com>,
 Marcelo Tosatti <mtosatti@redhat.com>, qemu-block@nongnu.org,
 Robert Foley <robert.foley@linaro.org>, Peter Puhov <peter.puhov@linaro.org>
Subject: [PULL 19/25] tests/vm: Add ability to select QEMU from current build
Date: Sun, 31 May 2020 18:38:40 +0200
Message-Id: <20200531163846.25363-20-philmd@redhat.com>
X-Mailer: git-send-email 2.21.3
In-Reply-To: <20200531163846.25363-1-philmd@redhat.com>
References: <20200531163846.25363-1-philmd@redhat.com>
MIME-Version: 1.0
Sender: kvm-owner@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

From: Robert Foley <robert.foley@linaro.org>

Added a new special variable QEMU_LOCAL=1, which
will indicate to take the QEMU binary from the current
build.

Signed-off-by: Robert Foley <robert.foley@linaro.org>
Reviewed-by: Peter Puhov <peter.puhov@linaro.org>
Reviewed-by: Alex Bennée <alex.bennee@linaro.org>
Reviewed-by: Philippe Mathieu-Daudé <philmd@redhat.com>
Tested-by: Philippe Mathieu-Daudé <philmd@redhat.com>
Message-Id: <20200529203458.1038-6-robert.foley@linaro.org>
Signed-off-by: Philippe Mathieu-Daudé <philmd@redhat.com>
---
 tests/vm/Makefile.include |  4 ++++
 tests/vm/basevm.py        | 28 +++++++++++++++++++++++-----
 2 files changed, 27 insertions(+), 5 deletions(-)

diff --git a/tests/vm/Makefile.include b/tests/vm/Makefile.include
index 80f7f6bdee..a253aba457 100644
--- a/tests/vm/Makefile.include
+++ b/tests/vm/Makefile.include
@@ -41,6 +41,7 @@ endif
 	@echo "    J=[0..9]*            	 - Override the -jN parameter for make commands"
 	@echo "    DEBUG=1              	 - Enable verbose output on host and interactive debugging"
 	@echo "    V=1				 - Enable verbose ouput on host and guest commands"
+	@echo "    QEMU_LOCAL=1                 - Use QEMU binary local to this build."
 	@echo "    QEMU=/path/to/qemu		 - Change path to QEMU binary"
 	@echo "    QEMU_IMG=/path/to/qemu-img	 - Change path to qemu-img tool"
 
@@ -57,6 +58,7 @@ $(IMAGES_DIR)/%.img:	$(SRC_PATH)/tests/vm/% \
 		$(PYTHON) $< \
 		$(if $(V)$(DEBUG), --debug) \
 		$(if $(GENISOIMAGE),--genisoimage $(GENISOIMAGE)) \
+		$(if $(QEMU_LOCAL),--build-path $(BUILD_DIR)) \
 		--image "$@" \
 		--force \
 		--build-image $@, \
@@ -71,6 +73,7 @@ vm-build-%: $(IMAGES_DIR)/%.img
 		$(if $(DEBUG), --interactive) \
 		$(if $(J),--jobs $(J)) \
 		$(if $(V),--verbose) \
+		$(if $(QEMU_LOCAL),--build-path $(BUILD_DIR)) \
 		--image "$<" \
 		$(if $(BUILD_TARGET),--build-target $(BUILD_TARGET)) \
 		--snapshot \
@@ -92,6 +95,7 @@ vm-boot-ssh-%: $(IMAGES_DIR)/%.img
 		$(PYTHON) $(SRC_PATH)/tests/vm/$* \
 		$(if $(J),--jobs $(J)) \
 		$(if $(V)$(DEBUG), --debug) \
+		$(if $(QEMU_LOCAL),--build-path $(BUILD_DIR)) \
 		--image "$<" \
 		--interactive \
 		false, \
diff --git a/tests/vm/basevm.py b/tests/vm/basevm.py
index a2d4054d72..5a3ce42281 100644
--- a/tests/vm/basevm.py
+++ b/tests/vm/basevm.py
@@ -61,9 +61,11 @@ class BaseVM(object):
     # 4 is arbitrary, but greater than 2,
     # since we found we need to wait more than twice as long.
     tcg_ssh_timeout_multiplier = 4
-    def __init__(self, debug=False, vcpus=None, genisoimage=None):
+    def __init__(self, debug=False, vcpus=None, genisoimage=None,
+                 build_path=None):
         self._guest = None
         self._genisoimage = genisoimage
+        self._build_path = build_path
         self._tmpdir = os.path.realpath(tempfile.mkdtemp(prefix="vm-test-",
                                                          suffix=".tmp",
                                                          dir="."))
@@ -184,15 +186,15 @@ def boot(self, img, extra_args=[]):
             "-device", "virtio-blk,drive=drive0,bootindex=0"]
         args += self._data_args + extra_args
         logging.debug("QEMU args: %s", " ".join(args))
-        qemu_bin = os.environ.get("QEMU", "qemu-system-" + self.arch)
-        guest = QEMUMachine(binary=qemu_bin, args=args)
+        qemu_path = get_qemu_path(self.arch, self._build_path)
+        guest = QEMUMachine(binary=qemu_path, args=args)
         guest.set_machine('pc')
         guest.set_console()
         try:
             guest.launch()
         except:
             logging.error("Failed to launch QEMU, command line:")
-            logging.error(" ".join([qemu_bin] + args))
+            logging.error(" ".join([qemu_path] + args))
             logging.error("Log:")
             logging.error(guest.get_log())
             logging.error("QEMU version >= 2.10 is required")
@@ -391,6 +393,19 @@ def gen_cloud_init_iso(self):
 
         return os.path.join(cidir, "cloud-init.iso")
 
+def get_qemu_path(arch, build_path=None):
+    """Fetch the path to the qemu binary."""
+    # If QEMU environment variable set, it takes precedence
+    if "QEMU" in os.environ:
+        qemu_path = os.environ["QEMU"]
+    elif build_path:
+        qemu_path = os.path.join(build_path, arch + "-softmmu")
+        qemu_path = os.path.join(qemu_path, "qemu-system-" + arch)
+    else:
+        # Default is to use system path for qemu.
+        qemu_path = "qemu-system-" + arch
+    return qemu_path
+
 def parse_args(vmcls):
 
     def get_default_jobs():
@@ -421,6 +436,9 @@ def get_default_jobs():
                       help="build QEMU from source in guest")
     parser.add_option("--build-target",
                       help="QEMU build target", default="check")
+    parser.add_option("--build-path", default=None,
+                      help="Path of build directory, "\
+                           "for using build tree QEMU binary. ")
     parser.add_option("--interactive", "-I", action="store_true",
                       help="Interactively run command")
     parser.add_option("--snapshot", "-s", action="store_true",
@@ -439,7 +457,7 @@ def main(vmcls):
         logging.basicConfig(level=(logging.DEBUG if args.debug
                                    else logging.WARN))
         vm = vmcls(debug=args.debug, vcpus=args.jobs,
-                   genisoimage=args.genisoimage)
+                   genisoimage=args.genisoimage, build_path=args.build_path)
         if args.build_image:
             if os.path.exists(args.image) and not args.force:
                 sys.stderr.writelines(["Image file exists: %s\n" % args.image,

From patchwork Sun May 31 16:38:41 2020
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
X-Patchwork-Submitter: =?utf-8?q?Philippe_Mathieu-Daud=C3=A9?=
 <philmd@redhat.com>
X-Patchwork-Id: 11580767
Return-Path: <SRS0=4Gy4=7N=vger.kernel.org=kvm-owner@kernel.org>
Received: from mail.kernel.org (pdx-korg-mail-1.web.codeaurora.org
 [172.30.200.123])
	by pdx-korg-patchwork-2.web.codeaurora.org (Postfix) with ESMTP id 7D6121391
	for <patchwork-kvm@patchwork.kernel.org>;
 Sun, 31 May 2020 16:40:37 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 62A022074B
	for <patchwork-kvm@patchwork.kernel.org>;
 Sun, 31 May 2020 16:40:37 +0000 (UTC)
Authentication-Results: mail.kernel.org;
	dkim=pass (1024-bit key) header.d=redhat.com header.i=@redhat.com
 header.b="eH7e0ZLW"
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1728379AbgEaQkg (ORCPT
        <rfc822;patchwork-kvm@patchwork.kernel.org>);
        Sun, 31 May 2020 12:40:36 -0400
Received: from us-smtp-1.mimecast.com ([205.139.110.61]:30441 "EHLO
        us-smtp-1.mimecast.com" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S1728272AbgEaQkg (ORCPT <rfc822;kvm@vger.kernel.org>);
        Sun, 31 May 2020 12:40:36 -0400
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=redhat.com;
        s=mimecast20190719; t=1590943234;
        h=from:from:reply-to:subject:subject:date:date:message-id:message-id:
         to:to:cc:cc:mime-version:mime-version:
  content-type:content-type:content-type:
         content-transfer-encoding:content-transfer-encoding:
         in-reply-to:in-reply-to:references:references;
        bh=NeYhFc6juZkPrqvPgAt2uIQTGjMzeewfSJodiqWwwkw=;
        b=eH7e0ZLWybdf3pWLfmzvw7GWoIfXd2Jxw+SOGRqWpjrdV39Kj4AJiPWPLy/9GE8tJuDwKt
        uakpt1VF6m1RyYNPj5DfQUNoIWjXhm9/WL5ZZm1sLoEl5lz/NzPeb+xuIIxvvV1/+9vNOn
        jD01Pe9ebHjqgzcyIBNzS6gIQh4wdgs=
Received: from mail-wr1-f71.google.com (mail-wr1-f71.google.com
 [209.85.221.71]) (Using TLS) by relay.mimecast.com with ESMTP id
 us-mta-4-ikUSMSUfNVKDwYBrsbXVXA-1; Sun, 31 May 2020 12:40:32 -0400
X-MC-Unique: ikUSMSUfNVKDwYBrsbXVXA-1
Received: by mail-wr1-f71.google.com with SMTP id w16so3602493wru.18
        for <kvm@vger.kernel.org>; Sun, 31 May 2020 09:40:32 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
         :references:mime-version:content-transfer-encoding;
        bh=NeYhFc6juZkPrqvPgAt2uIQTGjMzeewfSJodiqWwwkw=;
        b=n0YkNr6tw/d6uIc+j0htJaO1gQAHXwsyFjVQ9if+8R7jyBR+PhlJ1uMXKwJYIWu4AD
         vP2lZY+96I8F73TKJrF7m4hD6ElE9iIAXjZ6N0GpQgxt8iJGmVbWysF1dRfm10iv+6sR
         fx9TJMC0KE68BmA9JWsDfir8+Iukj2wa4pmcf7GsICVFabBrbV4yf0TFWlrRIDbmAM7z
         d26NU39M3CPaKHLg4A5yxNierHjUysnSMeann5IeDT3FGCNOny2OY7EGq7x8mTiwKwJt
         eSWK7iMNFCn9Hhu0uaGGzU4KYiS7p1QqpjFz/XCqtC2JxTJCd7/UocyGPcItvmlJr51X
         WRaw==
X-Gm-Message-State: AOAM532yFM0mOfFgVpSQySzHATokiXQtFrvLJKyfjRifpuaMnXGaCp2H
        Hbigik4nw9Adm15QsnIzqFE+Y3itKvAOtGYm/EAk/XFUk7hkdyI256xIwXMBaGQRWs/csGLqJgW
        rexqs14kkVHs5
X-Received: by 2002:a5d:628c:: with SMTP id
 k12mr17814513wru.211.1590943231325;
        Sun, 31 May 2020 09:40:31 -0700 (PDT)
X-Google-Smtp-Source: 
 ABdhPJwQhmvCd9JeaOCqg0GzXFrykGN6A9vNWGNP+OY36M63eNUdY7+avBRNroyItWUmvC8DxOTmCA==
X-Received: by 2002:a5d:628c:: with SMTP id
 k12mr17814494wru.211.1590943231095;
        Sun, 31 May 2020 09:40:31 -0700 (PDT)
Received: from localhost.localdomain (43.red-83-51-162.dynamicip.rima-tde.net.
 [83.51.162.43])
        by smtp.gmail.com with ESMTPSA id
 q4sm9026212wma.47.2020.05.31.09.40.29
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Sun, 31 May 2020 09:40:30 -0700 (PDT)
From: =?utf-8?q?Philippe_Mathieu-Daud=C3=A9?= <philmd@redhat.com>
To: qemu-devel@nongnu.org
Cc: Cleber Rosa <crosa@redhat.com>, Kevin Wolf <kwolf@redhat.com>,
 kvm@vger.kernel.org, Richard Henderson <rth@twiddle.net>,
 Fam Zheng <fam@euphon.net>, Eduardo Habkost <ehabkost@redhat.com>,
	=?utf-8?q?Alex_Benn=C3=A9e?= <alex.bennee@linaro.org>,
 Paolo Bonzini <pbonzini@redhat.com>, Max Reitz <mreitz@redhat.com>,
	=?utf-8?q?Philippe_Mathieu-Daud=C3=A9?= <philmd@redhat.com>,
 Stefan Hajnoczi <stefanha@redhat.com>, Markus Armbruster <armbru@redhat.com>,
 Marcelo Tosatti <mtosatti@redhat.com>, qemu-block@nongnu.org,
 Robert Foley <robert.foley@linaro.org>, Peter Puhov <peter.puhov@linaro.org>
Subject: [PULL 20/25] tests/vm: allow wait_ssh() to specify command
Date: Sun, 31 May 2020 18:38:41 +0200
Message-Id: <20200531163846.25363-21-philmd@redhat.com>
X-Mailer: git-send-email 2.21.3
In-Reply-To: <20200531163846.25363-1-philmd@redhat.com>
References: <20200531163846.25363-1-philmd@redhat.com>
MIME-Version: 1.0
Sender: kvm-owner@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

From: Robert Foley <robert.foley@linaro.org>

This allows for waiting for completion of arbitrary commands.

Signed-off-by: Robert Foley <robert.foley@linaro.org>
Reviewed-by: Peter Puhov <peter.puhov@linaro.org>
Reviewed-by: Alex Bennée <alex.bennee@linaro.org>
Reviewed-by: Philippe Mathieu-Daudé <philmd@redhat.com>
Tested-by: Philippe Mathieu-Daudé <philmd@redhat.com>
Message-Id: <20200529203458.1038-7-robert.foley@linaro.org>
Signed-off-by: Philippe Mathieu-Daudé <philmd@redhat.com>
---
 tests/vm/basevm.py | 14 +++++++-------
 1 file changed, 7 insertions(+), 7 deletions(-)

diff --git a/tests/vm/basevm.py b/tests/vm/basevm.py
index 5a3ce42281..a80b616a08 100644
--- a/tests/vm/basevm.py
+++ b/tests/vm/basevm.py
@@ -320,24 +320,24 @@ def console_sshd_config(self, prompt):
     def print_step(self, text):
         sys.stderr.write("### %s ...\n" % text)
 
-    def wait_ssh(self, wait_root=False, seconds=300):
+    def wait_ssh(self, wait_root=False, seconds=300, cmd="exit 0"):
         # Allow more time for VM to boot under TCG.
         if not kvm_available(self.arch):
             seconds *= self.tcg_ssh_timeout_multiplier
         starttime = datetime.datetime.now()
         endtime = starttime + datetime.timedelta(seconds=seconds)
-        guest_up = False
+        cmd_success = False
         while datetime.datetime.now() < endtime:
-            if wait_root and self.ssh_root("exit 0") == 0:
-                guest_up = True
+            if wait_root and self.ssh_root(cmd) == 0:
+                cmd_success = True
                 break
-            elif self.ssh("exit 0") == 0:
-                guest_up = True
+            elif self.ssh(cmd) == 0:
+                cmd_success = True
                 break
             seconds = (endtime - datetime.datetime.now()).total_seconds()
             logging.debug("%ds before timeout", seconds)
             time.sleep(1)
-        if not guest_up:
+        if not cmd_success:
             raise Exception("Timeout while waiting for guest ssh")
 
     def shutdown(self):

From patchwork Sun May 31 16:38:42 2020
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
X-Patchwork-Submitter: =?utf-8?q?Philippe_Mathieu-Daud=C3=A9?=
 <philmd@redhat.com>
X-Patchwork-Id: 11580769
Return-Path: <SRS0=4Gy4=7N=vger.kernel.org=kvm-owner@kernel.org>
Received: from mail.kernel.org (pdx-korg-mail-1.web.codeaurora.org
 [172.30.200.123])
	by pdx-korg-patchwork-2.web.codeaurora.org (Postfix) with ESMTP id 9783C1391
	for <patchwork-kvm@patchwork.kernel.org>;
 Sun, 31 May 2020 16:40:43 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 7F478207BB
	for <patchwork-kvm@patchwork.kernel.org>;
 Sun, 31 May 2020 16:40:43 +0000 (UTC)
Authentication-Results: mail.kernel.org;
	dkim=pass (1024-bit key) header.d=redhat.com header.i=@redhat.com
 header.b="IKIquA7f"
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1728382AbgEaQkm (ORCPT
        <rfc822;patchwork-kvm@patchwork.kernel.org>);
        Sun, 31 May 2020 12:40:42 -0400
Received: from us-smtp-delivery-1.mimecast.com ([205.139.110.120]:21824 "EHLO
        us-smtp-1.mimecast.com" rhost-flags-OK-OK-OK-FAIL) by vger.kernel.org
        with ESMTP id S1727932AbgEaQkl (ORCPT <rfc822;kvm@vger.kernel.org>);
        Sun, 31 May 2020 12:40:41 -0400
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=redhat.com;
        s=mimecast20190719; t=1590943241;
        h=from:from:reply-to:subject:subject:date:date:message-id:message-id:
         to:to:cc:cc:mime-version:mime-version:
  content-type:content-type:content-type:
         content-transfer-encoding:content-transfer-encoding:
         in-reply-to:in-reply-to:references:references;
        bh=VtnVaYYGa7/aqTUYxIxdKhEN8NJpUIW8xv7x+iz9PNM=;
        b=IKIquA7fLNpyHb+TuthMfBWabTtdNw98PN1EBRsai1y17yTO+39YA3ItxHNiA7lscFZGhN
        RRyTdbn+9gJil721kMA5Ixghc5KT0JyMrPqJXjI9yYoob0HiOublrx9FOvwqUeX/jSl3hX
        qZUPTDjfpzld6AeIWhZTE9BQAqStE6o=
Received: from mail-wr1-f71.google.com (mail-wr1-f71.google.com
 [209.85.221.71]) (Using TLS) by relay.mimecast.com with ESMTP id
 us-mta-342-Lg84mT8MMI2kR5Q06z77Eg-1; Sun, 31 May 2020 12:40:37 -0400
X-MC-Unique: Lg84mT8MMI2kR5Q06z77Eg-1
Received: by mail-wr1-f71.google.com with SMTP id l1so3615872wrc.8
        for <kvm@vger.kernel.org>; Sun, 31 May 2020 09:40:37 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
         :references:mime-version:content-transfer-encoding;
        bh=VtnVaYYGa7/aqTUYxIxdKhEN8NJpUIW8xv7x+iz9PNM=;
        b=o8R5eZTSy9DV2YOFoNixCRjWn4OQFVV0kZaMh+avI1epRquR3eiiZ6ZpL3CUcl/379
         eWCVKmXQDL1WSP0BiUmE1LN53uJ8bJj0H2K9/+HeAIywZ5JelPuWf9XHG7V4rabmMYrJ
         dMUopPCV3ghhN+THnseaxHbBEI0UA6qiZrykM85V1GnGvGAzAOAPLHSvejWYV30AGYlv
         Rrz2pq6+XNxwCX0oaZ++az12NPegfS3JCtwzBAdM/14o0sjMmqXI4CgqIrz3igeBwYHH
         Slql4b3YALi+q+nOn7QQtZh/kH8x0xktFUPIRDrdABZBYo1gpR36S+LeKfApiYEfPRiE
         9+hg==
X-Gm-Message-State: AOAM532neeeaobxfO59MyxkqsxjrB0ATHwxZOai0jgRwJdB16PfsssmV
        4qD6wcsXtGuRSLqXV6nJY63IWIGecI60YVLyeTWthZJGBrr3wMgjhJA+ApCeJe5zbtP7ennjKD9
        W6b3+rZpFycZ9
X-Received: by 2002:a5d:4484:: with SMTP id j4mr17681264wrq.325.1590943236590;
        Sun, 31 May 2020 09:40:36 -0700 (PDT)
X-Google-Smtp-Source: 
 ABdhPJxgZwwOTcr688HaliXjwVILCgXMwwdoueLVIOVtH/2dXXqGIkOpERxl7rjGuHjeNfqMMGldnQ==
X-Received: by 2002:a5d:4484:: with SMTP id j4mr17681252wrq.325.1590943236436;
        Sun, 31 May 2020 09:40:36 -0700 (PDT)
Received: from localhost.localdomain (43.red-83-51-162.dynamicip.rima-tde.net.
 [83.51.162.43])
        by smtp.gmail.com with ESMTPSA id
 d13sm8390301wmb.39.2020.05.31.09.40.34
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Sun, 31 May 2020 09:40:35 -0700 (PDT)
From: =?utf-8?q?Philippe_Mathieu-Daud=C3=A9?= <philmd@redhat.com>
To: qemu-devel@nongnu.org
Cc: Cleber Rosa <crosa@redhat.com>, Kevin Wolf <kwolf@redhat.com>,
 kvm@vger.kernel.org, Richard Henderson <rth@twiddle.net>,
 Fam Zheng <fam@euphon.net>, Eduardo Habkost <ehabkost@redhat.com>,
	=?utf-8?q?Alex_Benn=C3=A9e?= <alex.bennee@linaro.org>,
 Paolo Bonzini <pbonzini@redhat.com>, Max Reitz <mreitz@redhat.com>,
	=?utf-8?q?Philippe_Mathieu-Daud=C3=A9?= <philmd@redhat.com>,
 Stefan Hajnoczi <stefanha@redhat.com>, Markus Armbruster <armbru@redhat.com>,
 Marcelo Tosatti <mtosatti@redhat.com>, qemu-block@nongnu.org,
 John Snow <jsnow@redhat.com>
Subject: [PULL 21/25] tests/migration/guestperf: Use Python 3 interpreter
Date: Sun, 31 May 2020 18:38:42 +0200
Message-Id: <20200531163846.25363-22-philmd@redhat.com>
X-Mailer: git-send-email 2.21.3
In-Reply-To: <20200531163846.25363-1-philmd@redhat.com>
References: <20200531163846.25363-1-philmd@redhat.com>
MIME-Version: 1.0
Sender: kvm-owner@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

Signed-off-by: Philippe Mathieu-Daudé <philmd@redhat.com>
Reviewed-by: John Snow <jsnow@redhat.com>
Reviewed-by: Kevin Wolf <kwolf@redhat.com>
Message-Id: <20200512103238.7078-7-philmd@redhat.com>
---
 tests/migration/guestperf-batch.py | 2 +-
 tests/migration/guestperf-plot.py  | 2 +-
 tests/migration/guestperf.py       | 2 +-
 3 files changed, 3 insertions(+), 3 deletions(-)

diff --git a/tests/migration/guestperf-batch.py b/tests/migration/guestperf-batch.py
index cb150ce804..f1e900908d 100755
--- a/tests/migration/guestperf-batch.py
+++ b/tests/migration/guestperf-batch.py
@@ -1,4 +1,4 @@
-#!/usr/bin/python
+#!/usr/bin/env python3
 #
 # Migration test batch comparison invokation
 #
diff --git a/tests/migration/guestperf-plot.py b/tests/migration/guestperf-plot.py
index d70bb7a557..907151011a 100755
--- a/tests/migration/guestperf-plot.py
+++ b/tests/migration/guestperf-plot.py
@@ -1,4 +1,4 @@
-#!/usr/bin/python
+#!/usr/bin/env python3
 #
 # Migration test graph plotting command
 #
diff --git a/tests/migration/guestperf.py b/tests/migration/guestperf.py
index 99b027e8ba..ba1c4bc4ca 100755
--- a/tests/migration/guestperf.py
+++ b/tests/migration/guestperf.py
@@ -1,4 +1,4 @@
-#!/usr/bin/python
+#!/usr/bin/env python3
 #
 # Migration test direct invokation command
 #

From patchwork Sun May 31 16:38:43 2020
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
X-Patchwork-Submitter: =?utf-8?q?Philippe_Mathieu-Daud=C3=A9?=
 <philmd@redhat.com>
X-Patchwork-Id: 11580771
Return-Path: <SRS0=4Gy4=7N=vger.kernel.org=kvm-owner@kernel.org>
Received: from mail.kernel.org (pdx-korg-mail-1.web.codeaurora.org
 [172.30.200.123])
	by pdx-korg-patchwork-2.web.codeaurora.org (Postfix) with ESMTP id 4CE7E90
	for <patchwork-kvm@patchwork.kernel.org>;
 Sun, 31 May 2020 16:40:47 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 34D29207BB
	for <patchwork-kvm@patchwork.kernel.org>;
 Sun, 31 May 2020 16:40:47 +0000 (UTC)
Authentication-Results: mail.kernel.org;
	dkim=pass (1024-bit key) header.d=redhat.com header.i=@redhat.com
 header.b="ed5UW8wx"
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1728388AbgEaQkq (ORCPT
        <rfc822;patchwork-kvm@patchwork.kernel.org>);
        Sun, 31 May 2020 12:40:46 -0400
Received: from us-smtp-delivery-1.mimecast.com ([207.211.31.120]:39170 "EHLO
        us-smtp-1.mimecast.com" rhost-flags-OK-OK-OK-FAIL) by vger.kernel.org
        with ESMTP id S1728370AbgEaQkp (ORCPT <rfc822;kvm@vger.kernel.org>);
        Sun, 31 May 2020 12:40:45 -0400
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=redhat.com;
        s=mimecast20190719; t=1590943244;
        h=from:from:reply-to:subject:subject:date:date:message-id:message-id:
         to:to:cc:cc:mime-version:mime-version:
  content-type:content-type:content-type:
         content-transfer-encoding:content-transfer-encoding:
         in-reply-to:in-reply-to:references:references;
        bh=KEU6cF8wx9dT9DR4quAwHsy5LYVVtSbv+hQRMIt0K90=;
        b=ed5UW8wxOOVe8bwi6Tg3d2UnK6ccgSCym/dCcE6Zz5QZIQcGuYVVhjitFcQ400T+mvEavj
        xboZbayJpgjDchh5kjPN9vR1ieEFmaSdyWkn6/8scDmg1Ss/LwluYebwoJ7eiVEEej0ys+
        +KiqqCfk0ciD7tCm6wT0lhrDiMn0vUo=
Received: from mail-wr1-f69.google.com (mail-wr1-f69.google.com
 [209.85.221.69]) (Using TLS) by relay.mimecast.com with ESMTP id
 us-mta-147-QxTWf2GnOqu9LMYTuocZvw-1; Sun, 31 May 2020 12:40:42 -0400
X-MC-Unique: QxTWf2GnOqu9LMYTuocZvw-1
Received: by mail-wr1-f69.google.com with SMTP id h6so3649523wrx.4
        for <kvm@vger.kernel.org>; Sun, 31 May 2020 09:40:42 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
         :references:mime-version:content-transfer-encoding;
        bh=KEU6cF8wx9dT9DR4quAwHsy5LYVVtSbv+hQRMIt0K90=;
        b=riZsWdlqYpjvFlI6rA4MFLr4nncvX7xIk7AHBwg4E9iOCgcB70j84lmfiXwo3R9W9f
         i9Nwbn/ELhhcMqUkyBp9Kzh7bJgQQ5qF/sSioIOgansTqC9UJlZ4fm9Xo1M//FT3WC/a
         H7JIpBRJ0avnNX54zlXsRyEA98nWck9EXJfuercKPgdge5eVX0FconGmLGTXewPFWuJU
         VZBuO7AIv/ftlzIlo61AX4Aay2X2khKV/Q+vz2dH4Hj+v0o0xnF/eeEH3QpR4d7z2x3C
         xRnNkUlCLZdAGN/tEzQIkfC9qVn2z+1vDHu1Jj8Xe96DGTzaOyVaPRDDaaTThW5RaILC
         huNw==
X-Gm-Message-State: AOAM530xgEzTTbPuO7FkbVgzPHvbrriTzf0v5hy/sKoQS1ZFYX6bl2hA
        zhXiXTtIMvF76bWT2D0vVo69OfMZcUwKdWVdc8K8nx/uOeXxqWTXHbj8Px1R8TQwdhqQX+shT/S
        v5SQj589kyqJ1
X-Received: by 2002:adf:8041:: with SMTP id 59mr17259543wrk.278.1590943241715;
        Sun, 31 May 2020 09:40:41 -0700 (PDT)
X-Google-Smtp-Source: 
 ABdhPJzImNvZeAhhQ1GMFMgecKFJ9XA4/OBogYQBVHGi7VCZ3PzFb8gTmqybziOivHHumywOwku1CA==
X-Received: by 2002:adf:8041:: with SMTP id 59mr17259527wrk.278.1590943241554;
        Sun, 31 May 2020 09:40:41 -0700 (PDT)
Received: from localhost.localdomain (43.red-83-51-162.dynamicip.rima-tde.net.
 [83.51.162.43])
        by smtp.gmail.com with ESMTPSA id
 z25sm8585383wmf.10.2020.05.31.09.40.40
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Sun, 31 May 2020 09:40:41 -0700 (PDT)
From: =?utf-8?q?Philippe_Mathieu-Daud=C3=A9?= <philmd@redhat.com>
To: qemu-devel@nongnu.org
Cc: Cleber Rosa <crosa@redhat.com>, Kevin Wolf <kwolf@redhat.com>,
 kvm@vger.kernel.org, Richard Henderson <rth@twiddle.net>,
 Fam Zheng <fam@euphon.net>, Eduardo Habkost <ehabkost@redhat.com>,
	=?utf-8?q?Alex_Benn=C3=A9e?= <alex.bennee@linaro.org>,
 Paolo Bonzini <pbonzini@redhat.com>, Max Reitz <mreitz@redhat.com>,
	=?utf-8?q?Philippe_Mathieu-Daud=C3=A9?= <philmd@redhat.com>,
 Stefan Hajnoczi <stefanha@redhat.com>, Markus Armbruster <armbru@redhat.com>,
 Marcelo Tosatti <mtosatti@redhat.com>, qemu-block@nongnu.org,
 "Dr. David Alan Gilbert" <dgilbert@redhat.com>
Subject: [PULL 22/25] tests/acceptance/migration.py: Wait for both sides
Date: Sun, 31 May 2020 18:38:43 +0200
Message-Id: <20200531163846.25363-23-philmd@redhat.com>
X-Mailer: git-send-email 2.21.3
In-Reply-To: <20200531163846.25363-1-philmd@redhat.com>
References: <20200531163846.25363-1-philmd@redhat.com>
MIME-Version: 1.0
Sender: kvm-owner@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

From: "Dr. David Alan Gilbert" <dgilbert@redhat.com>

When the source finishes migration the destination will still be
receiving the data sent by the source, so it might not have quite
finished yet, so won't quite have reached 'completed'.
This lead to occasional asserts in the next few checks.

After the source has finished, check the destination as well.
(We can't just switch to checking the destination, because it doesn't
give a status until it has started receiving the migration).

Reported-by: Alex Bennée <alex.bennee@linaro.org>
Signed-off-by: Dr. David Alan Gilbert <dgilbert@redhat.com>
Tested-by: Alex Bennée <alex.bennee@linaro.org>
Reviewed-by: Philippe Mathieu-Daudé <philmd@redhat.com>
Message-Id: <20200528112404.121972-1-dgilbert@redhat.com>
Signed-off-by: Philippe Mathieu-Daudé <philmd@redhat.com>
---
 tests/acceptance/migration.py | 4 ++++
 1 file changed, 4 insertions(+)

diff --git a/tests/acceptance/migration.py b/tests/acceptance/migration.py
index 0365289cda..792639cb69 100644
--- a/tests/acceptance/migration.py
+++ b/tests/acceptance/migration.py
@@ -35,6 +35,10 @@ def assert_migration(self, src_vm, dst_vm):
                       timeout=self.timeout,
                       step=0.1,
                       args=(src_vm,))
+        wait.wait_for(self.migration_finished,
+                      timeout=self.timeout,
+                      step=0.1,
+                      args=(dst_vm,))
         self.assertEqual(src_vm.command('query-migrate')['status'], 'completed')
         self.assertEqual(dst_vm.command('query-migrate')['status'], 'completed')
         self.assertEqual(dst_vm.command('query-status')['status'], 'running')

From patchwork Sun May 31 16:38:44 2020
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
X-Patchwork-Submitter: =?utf-8?q?Philippe_Mathieu-Daud=C3=A9?=
 <philmd@redhat.com>
X-Patchwork-Id: 11580773
Return-Path: <SRS0=4Gy4=7N=vger.kernel.org=kvm-owner@kernel.org>
Received: from mail.kernel.org (pdx-korg-mail-1.web.codeaurora.org
 [172.30.200.123])
	by pdx-korg-patchwork-2.web.codeaurora.org (Postfix) with ESMTP id E199B1391
	for <patchwork-kvm@patchwork.kernel.org>;
 Sun, 31 May 2020 16:40:52 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id CA1CC207BB
	for <patchwork-kvm@patchwork.kernel.org>;
 Sun, 31 May 2020 16:40:52 +0000 (UTC)
Authentication-Results: mail.kernel.org;
	dkim=pass (1024-bit key) header.d=redhat.com header.i=@redhat.com
 header.b="G8HQgLfK"
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1728393AbgEaQkw (ORCPT
        <rfc822;patchwork-kvm@patchwork.kernel.org>);
        Sun, 31 May 2020 12:40:52 -0400
Received: from us-smtp-delivery-1.mimecast.com ([205.139.110.120]:41613 "EHLO
        us-smtp-1.mimecast.com" rhost-flags-OK-OK-OK-FAIL) by vger.kernel.org
        with ESMTP id S1728397AbgEaQkv (ORCPT <rfc822;kvm@vger.kernel.org>);
        Sun, 31 May 2020 12:40:51 -0400
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=redhat.com;
        s=mimecast20190719; t=1590943249;
        h=from:from:reply-to:subject:subject:date:date:message-id:message-id:
         to:to:cc:cc:mime-version:mime-version:
  content-type:content-type:content-type:
         content-transfer-encoding:content-transfer-encoding:
         in-reply-to:in-reply-to:references:references;
        bh=EasuWk6m0BoiPz6F4JYRddSpg6v+5LpuTCzT8S/4Pwk=;
        b=G8HQgLfKC5SofY1e2cEjvW3B+Ve5JSLdPx3WLl9MTJ1v8BlWeVDYpPvmhlTNy0msBq/DkH
        woPVnwBUxGAqsE7A6K6Mav14AgcgpzRKCxV1Lv3/DPkC/JdBZjNs5BHpllsBkaVTalJk+B
        svpiWxwE9t7fBzwcwDuh0NiI4YY27VU=
Received: from mail-wr1-f71.google.com (mail-wr1-f71.google.com
 [209.85.221.71]) (Using TLS) by relay.mimecast.com with ESMTP id
 us-mta-494-qvGR3IAvOauNMX844ZCQLw-1; Sun, 31 May 2020 12:40:48 -0400
X-MC-Unique: qvGR3IAvOauNMX844ZCQLw-1
Received: by mail-wr1-f71.google.com with SMTP id p9so2660168wrx.10
        for <kvm@vger.kernel.org>; Sun, 31 May 2020 09:40:47 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
         :references:mime-version:content-transfer-encoding;
        bh=EasuWk6m0BoiPz6F4JYRddSpg6v+5LpuTCzT8S/4Pwk=;
        b=DNevcA00j04byQdJejAqn1kOpXb2oGDekEbmsL7tpRNNdlF+FLf5oMzxkroG17VPzA
         +mSo361N0sq5aHLw335pbXXfAEm6k/M5dY+pDs3Bi9hK6FdsH34bMEMCCMGNSOEunlgU
         McNk2B17eQw5a2eX3AW8nx6Eae6TYJt+AjQZ73YzU1OtsGE2zaY+PoAVvi+mcG4FO5y9
         91n9zMdjBrwOyB22XG30TOYgG53wqqcXsFxNjV4z1WQS43fYTvvpSaYZDqaeAB3Pztyb
         4dx3QC0aQFmkhqEKeSUm9WTalLS2C2hXrFTbUOZh5VDt/bpr9pvFvkLjWjZUNYcTtRI+
         hzwg==
X-Gm-Message-State: AOAM530cgNkWjZN5WHPsXWS8PTH8NlVcXIMrBzuRECUcW9bVb+T5UOBk
        TcjcqYGSq9hzWH5RV/IEPtQmvfzIOCuq9WOUwQ9YhKtM3PhHb+/iaQWg3UBpy7F4gLU6Vkghh1m
        /HE4zzMKTFI1V
X-Received: by 2002:a05:600c:2147:: with SMTP id
 v7mr17849642wml.101.1590943246923;
        Sun, 31 May 2020 09:40:46 -0700 (PDT)
X-Google-Smtp-Source: 
 ABdhPJyI6LDvlfCZPK9wwqdms85yxMc4JSYt7zQlkz8yplSypRhy6I1JyG6cFZgTmZSSCpBd31os2g==
X-Received: by 2002:a05:600c:2147:: with SMTP id
 v7mr17849613wml.101.1590943246702;
        Sun, 31 May 2020 09:40:46 -0700 (PDT)
Received: from localhost.localdomain (43.red-83-51-162.dynamicip.rima-tde.net.
 [83.51.162.43])
        by smtp.gmail.com with ESMTPSA id
 a6sm17634729wrn.38.2020.05.31.09.40.45
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Sun, 31 May 2020 09:40:46 -0700 (PDT)
From: =?utf-8?q?Philippe_Mathieu-Daud=C3=A9?= <philmd@redhat.com>
To: qemu-devel@nongnu.org
Cc: Cleber Rosa <crosa@redhat.com>, Kevin Wolf <kwolf@redhat.com>,
 kvm@vger.kernel.org, Richard Henderson <rth@twiddle.net>,
 Fam Zheng <fam@euphon.net>, Eduardo Habkost <ehabkost@redhat.com>,
	=?utf-8?q?Alex_Benn=C3=A9e?= <alex.bennee@linaro.org>,
 Paolo Bonzini <pbonzini@redhat.com>, Max Reitz <mreitz@redhat.com>,
	=?utf-8?q?Philippe_Mathieu-Daud=C3=A9?= <philmd@redhat.com>,
 Stefan Hajnoczi <stefanha@redhat.com>, Markus Armbruster <armbru@redhat.com>,
 Marcelo Tosatti <mtosatti@redhat.com>, qemu-block@nongnu.org,
 Pavel Dovgalyuk <Pavel.Dovgaluk@gmail.com>,
 Pavel Dovgalyuk <Pavel.Dovgaluk@ispras.ru>,
 Willian Rampazzo <willianr@redhat.com>
Subject: [PULL 23/25] tests/acceptance: allow console interaction with
 specific VMs
Date: Sun, 31 May 2020 18:38:44 +0200
Message-Id: <20200531163846.25363-24-philmd@redhat.com>
X-Mailer: git-send-email 2.21.3
In-Reply-To: <20200531163846.25363-1-philmd@redhat.com>
References: <20200531163846.25363-1-philmd@redhat.com>
MIME-Version: 1.0
Sender: kvm-owner@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

From: Pavel Dovgalyuk <Pavel.Dovgaluk@gmail.com>

Console interaction in avocado scripts was possible only with single
default VM.
This patch modifies the function parameters to allow passing a specific
VM as a parameter to interact with it.

Signed-off-by: Pavel Dovgalyuk <Pavel.Dovgaluk@ispras.ru>
Reviewed-by: Willian Rampazzo <willianr@redhat.com>
Reviewed-by: Alex Bennée <alex.bennee@linaro.org>
Tested-by: Philippe Mathieu-Daudé <philmd@redhat.com>
Message-Id: <159073587933.20809.5122618715976660635.stgit@pasha-ThinkPad-X280>
Signed-off-by: Philippe Mathieu-Daudé <philmd@redhat.com>
---
 tests/acceptance/avocado_qemu/__init__.py | 13 ++++++++-----
 1 file changed, 8 insertions(+), 5 deletions(-)

diff --git a/tests/acceptance/avocado_qemu/__init__.py b/tests/acceptance/avocado_qemu/__init__.py
index 59e7b4f763..77d1c1d9ff 100644
--- a/tests/acceptance/avocado_qemu/__init__.py
+++ b/tests/acceptance/avocado_qemu/__init__.py
@@ -69,13 +69,15 @@ def pick_default_qemu_bin(arch=None):
 
 
 def _console_interaction(test, success_message, failure_message,
-                         send_string, keep_sending=False):
+                         send_string, keep_sending=False, vm=None):
     assert not keep_sending or send_string
-    console = test.vm.console_socket.makefile()
+    if vm is None:
+        vm = test.vm
+    console = vm.console_socket.makefile()
     console_logger = logging.getLogger('console')
     while True:
         if send_string:
-            test.vm.console_socket.sendall(send_string.encode())
+            vm.console_socket.sendall(send_string.encode())
             if not keep_sending:
                 send_string = None # send only once
         msg = console.readline().strip()
@@ -115,7 +117,8 @@ def interrupt_interactive_console_until_pattern(test, success_message,
     _console_interaction(test, success_message, failure_message,
                          interrupt_string, True)
 
-def wait_for_console_pattern(test, success_message, failure_message=None):
+def wait_for_console_pattern(test, success_message, failure_message=None,
+                             vm=None):
     """
     Waits for messages to appear on the console, while logging the content
 
@@ -125,7 +128,7 @@ def wait_for_console_pattern(test, success_message, failure_message=None):
     :param success_message: if this message appears, test succeeds
     :param failure_message: if this message appears, test fails
     """
-    _console_interaction(test, success_message, failure_message, None)
+    _console_interaction(test, success_message, failure_message, None, vm=vm)
 
 def exec_command_and_wait_for_pattern(test, command,
                                       success_message, failure_message=None):

From patchwork Sun May 31 16:38:45 2020
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
X-Patchwork-Submitter: =?utf-8?q?Philippe_Mathieu-Daud=C3=A9?=
 <philmd@redhat.com>
X-Patchwork-Id: 11580775
Return-Path: <SRS0=4Gy4=7N=vger.kernel.org=kvm-owner@kernel.org>
Received: from mail.kernel.org (pdx-korg-mail-1.web.codeaurora.org
 [172.30.200.123])
	by pdx-korg-patchwork-2.web.codeaurora.org (Postfix) with ESMTP id 87F8F90
	for <patchwork-kvm@patchwork.kernel.org>;
 Sun, 31 May 2020 16:40:57 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 7025B207C4
	for <patchwork-kvm@patchwork.kernel.org>;
 Sun, 31 May 2020 16:40:57 +0000 (UTC)
Authentication-Results: mail.kernel.org;
	dkim=pass (1024-bit key) header.d=redhat.com header.i=@redhat.com
 header.b="eAQDFuu4"
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1728415AbgEaQk4 (ORCPT
        <rfc822;patchwork-kvm@patchwork.kernel.org>);
        Sun, 31 May 2020 12:40:56 -0400
Received: from us-smtp-delivery-1.mimecast.com ([205.139.110.120]:26139 "EHLO
        us-smtp-1.mimecast.com" rhost-flags-OK-OK-OK-FAIL) by vger.kernel.org
        with ESMTP id S1728408AbgEaQk4 (ORCPT <rfc822;kvm@vger.kernel.org>);
        Sun, 31 May 2020 12:40:56 -0400
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=redhat.com;
        s=mimecast20190719; t=1590943255;
        h=from:from:reply-to:subject:subject:date:date:message-id:message-id:
         to:to:cc:cc:mime-version:mime-version:
  content-type:content-type:content-type:
         content-transfer-encoding:content-transfer-encoding:
         in-reply-to:in-reply-to:references:references;
        bh=5kh3KwB/jxedDy9sx3WKrEz/2+qdiWFHqjY6mnOtPis=;
        b=eAQDFuu4DWxSdrg21aWyOUFMK+8xdM+GLYQGPtczUVJQFuZbrVKOlyUfkEs5/H8LsVDVu8
        LLnyjVLVC0144TI15+AcrQLeQjpKkp15P+KlNwEcNQlc3eTUDqULxn49nA280nYo0ebqpE
        qjg87L+Ohr9CjQf7J+dt2IVqnQDN5o0=
Received: from mail-wr1-f72.google.com (mail-wr1-f72.google.com
 [209.85.221.72]) (Using TLS) by relay.mimecast.com with ESMTP id
 us-mta-410-CTDLEOYfOw2YWxz8dpXi9Q-1; Sun, 31 May 2020 12:40:53 -0400
X-MC-Unique: CTDLEOYfOw2YWxz8dpXi9Q-1
Received: by mail-wr1-f72.google.com with SMTP id e1so3635565wrm.3
        for <kvm@vger.kernel.org>; Sun, 31 May 2020 09:40:52 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
         :references:mime-version:content-transfer-encoding;
        bh=5kh3KwB/jxedDy9sx3WKrEz/2+qdiWFHqjY6mnOtPis=;
        b=oix1IRUy4KkiRsl7/mBd72k9+7oFdkyYtrGJv2lHOXoB1Y+PaA7NIDllz4iZNHeHYg
         b2jhbDgdL5bGF9yujLzudXIPLbuVvHOTewn9t2oS3uZ48RFZhlRG47Jdd9x/7nbHQJVt
         MjtqwD6Bat6U6YViF9O/EqzQ0WrVWvxfxupjFbPVEd4MFc/dURUnH5ZO8WE5VW8+ZOSv
         L4VYsLV6hmX8BqCFzGDpMHBvlNztpEKAMv2ngWs+zZi1A140GXSMyHOOLDMiBSWlIKls
         HdyeT/TT4NnINVewNNirz/Dj8A9HCjIVRROGe8S0KgN6hctsPwdEwutv77/6UMLS0FKb
         iYsA==
X-Gm-Message-State: AOAM532YDnN7HkvK1lVzKOyS7QV9C13ZpNWZ5iouAX1C6qtdmPadZUmI
        PfUG4NkQd7HRLI1Vt3rUsaknIhEp5zh7d5dsNH5yx+dBPDhhB0ni9RzQ6JuU64Cx5howcjvH8W4
        WU+8Kf8vho+rg
X-Received: by 2002:a1c:7517:: with SMTP id o23mr3694859wmc.7.1590943251918;
        Sun, 31 May 2020 09:40:51 -0700 (PDT)
X-Google-Smtp-Source: 
 ABdhPJwgg7fWuhgUuVeOwz5AFukgiuotsYWI2AIs/F0Y1zcZ15fa/CgxkrebrEP3uzeGGoMSBlmEew==
X-Received: by 2002:a1c:7517:: with SMTP id o23mr3694845wmc.7.1590943251774;
        Sun, 31 May 2020 09:40:51 -0700 (PDT)
Received: from localhost.localdomain (43.red-83-51-162.dynamicip.rima-tde.net.
 [83.51.162.43])
        by smtp.gmail.com with ESMTPSA id
 e15sm9223356wme.9.2020.05.31.09.40.50
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Sun, 31 May 2020 09:40:51 -0700 (PDT)
From: =?utf-8?q?Philippe_Mathieu-Daud=C3=A9?= <philmd@redhat.com>
To: qemu-devel@nongnu.org
Cc: Cleber Rosa <crosa@redhat.com>, Kevin Wolf <kwolf@redhat.com>,
 kvm@vger.kernel.org, Richard Henderson <rth@twiddle.net>,
 Fam Zheng <fam@euphon.net>, Eduardo Habkost <ehabkost@redhat.com>,
	=?utf-8?q?Alex_Benn=C3=A9e?= <alex.bennee@linaro.org>,
 Paolo Bonzini <pbonzini@redhat.com>, Max Reitz <mreitz@redhat.com>,
	=?utf-8?q?Philippe_Mathieu-Daud=C3=A9?= <philmd@redhat.com>,
 Stefan Hajnoczi <stefanha@redhat.com>, Markus Armbruster <armbru@redhat.com>,
 Marcelo Tosatti <mtosatti@redhat.com>, qemu-block@nongnu.org,
 Pavel Dovgalyuk <Pavel.Dovgaluk@gmail.com>,
 Pavel Dovgalyuk <Pavel.Dovgaluk@ispras.ru>
Subject: [PULL 24/25] tests/acceptance: refactor boot_linux_console test to
 allow code reuse
Date: Sun, 31 May 2020 18:38:45 +0200
Message-Id: <20200531163846.25363-25-philmd@redhat.com>
X-Mailer: git-send-email 2.21.3
In-Reply-To: <20200531163846.25363-1-philmd@redhat.com>
References: <20200531163846.25363-1-philmd@redhat.com>
MIME-Version: 1.0
Sender: kvm-owner@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

From: Pavel Dovgalyuk <Pavel.Dovgaluk@gmail.com>

This patch splits code in BootLinuxConsole class into two different
classes to allow reusing it by record/replay tests.

Signed-off-by: Pavel Dovgalyuk <Pavel.Dovgaluk@ispras.ru>
Reviewed-by: Alex Bennée <alex.bennee@linaro.org>
Tested-by: Philippe Mathieu-Daudé <philmd@redhat.com>
Message-Id: <159073588490.20809.13942096070255577558.stgit@pasha-ThinkPad-X280>
Signed-off-by: Philippe Mathieu-Daudé <philmd@redhat.com>
---
 tests/acceptance/boot_linux_console.py | 21 +++++++++++----------
 1 file changed, 11 insertions(+), 10 deletions(-)

diff --git a/tests/acceptance/boot_linux_console.py b/tests/acceptance/boot_linux_console.py
index c6b06a1a13..12725d4529 100644
--- a/tests/acceptance/boot_linux_console.py
+++ b/tests/acceptance/boot_linux_console.py
@@ -28,19 +28,13 @@
 except CmdNotFoundError:
     P7ZIP_AVAILABLE = False
 
-class BootLinuxConsole(Test):
-    """
-    Boots a Linux kernel and checks that the console is operational and the
-    kernel command line is properly passed from QEMU to the kernel
-    """
-
-    timeout = 90
-
+class LinuxKernelTest(Test):
     KERNEL_COMMON_COMMAND_LINE = 'printk.time=0 '
 
-    def wait_for_console_pattern(self, success_message):
+    def wait_for_console_pattern(self, success_message, vm=None):
         wait_for_console_pattern(self, success_message,
-                                 failure_message='Kernel panic - not syncing')
+                                 failure_message='Kernel panic - not syncing',
+                                 vm=vm)
 
     def extract_from_deb(self, deb, path):
         """
@@ -79,6 +73,13 @@ def extract_from_rpm(self, rpm, path):
         os.chdir(cwd)
         return os.path.normpath(os.path.join(self.workdir, path))
 
+class BootLinuxConsole(LinuxKernelTest):
+    """
+    Boots a Linux kernel and checks that the console is operational and the
+    kernel command line is properly passed from QEMU to the kernel
+    """
+    timeout = 90
+
     def test_x86_64_pc(self):
         """
         :avocado: tags=arch:x86_64

From patchwork Sun May 31 16:38:46 2020
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
X-Patchwork-Submitter: =?utf-8?q?Philippe_Mathieu-Daud=C3=A9?=
 <philmd@redhat.com>
X-Patchwork-Id: 11580777
Return-Path: <SRS0=4Gy4=7N=vger.kernel.org=kvm-owner@kernel.org>
Received: from mail.kernel.org (pdx-korg-mail-1.web.codeaurora.org
 [172.30.200.123])
	by pdx-korg-patchwork-2.web.codeaurora.org (Postfix) with ESMTP id 552B61391
	for <patchwork-kvm@patchwork.kernel.org>;
 Sun, 31 May 2020 16:41:05 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 3E3A92074B
	for <patchwork-kvm@patchwork.kernel.org>;
 Sun, 31 May 2020 16:41:05 +0000 (UTC)
Authentication-Results: mail.kernel.org;
	dkim=pass (1024-bit key) header.d=redhat.com header.i=@redhat.com
 header.b="DFymAV+Q"
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1728432AbgEaQlE (ORCPT
        <rfc822;patchwork-kvm@patchwork.kernel.org>);
        Sun, 31 May 2020 12:41:04 -0400
Received: from us-smtp-1.mimecast.com ([207.211.31.81]:39854 "EHLO
        us-smtp-delivery-1.mimecast.com" rhost-flags-OK-OK-OK-FAIL)
        by vger.kernel.org with ESMTP id S1728394AbgEaQlD (ORCPT
        <rfc822;kvm@vger.kernel.org>); Sun, 31 May 2020 12:41:03 -0400
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=redhat.com;
        s=mimecast20190719; t=1590943261;
        h=from:from:reply-to:subject:subject:date:date:message-id:message-id:
         to:to:cc:cc:mime-version:mime-version:
  content-type:content-type:content-type:
         content-transfer-encoding:content-transfer-encoding:
         in-reply-to:in-reply-to:references:references;
        bh=j5BS+2d4i/ahG24dd/tHPN0fLUUFmd8jGntUYE3MrX0=;
        b=DFymAV+QzviYD825qDTd1pRFR9GTyX61uN3hhaOt+T8dYlpS78LtsW9jHY189nu1cqBUSL
        468WT3y/BA4lkNP9SRuhGZkvkXynvm0OTuj5RFlxIm9N16DW0MusTlQ2VIPbK8KiG4I1jL
        3Q94h2QuIRKR9m4Acz9bAFr8scef2nY=
Received: from mail-wr1-f70.google.com (mail-wr1-f70.google.com
 [209.85.221.70]) (Using TLS) by relay.mimecast.com with ESMTP id
 us-mta-305-sNTjGaloPnajb6u4G0-rpg-1; Sun, 31 May 2020 12:40:58 -0400
X-MC-Unique: sNTjGaloPnajb6u4G0-rpg-1
Received: by mail-wr1-f70.google.com with SMTP id c14so3592484wrw.11
        for <kvm@vger.kernel.org>; Sun, 31 May 2020 09:40:57 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
         :references:mime-version:content-transfer-encoding;
        bh=j5BS+2d4i/ahG24dd/tHPN0fLUUFmd8jGntUYE3MrX0=;
        b=PFro2frEB2nnjaT+xNsK5Q3wdQWZ7twFJrLh38YxtkT74GK2enQ2y6cKAJ4WKcbql4
         XFgbzOJc65VxFVzxWqG/LzCdQUZBw3GtcO3vwQY7aXXE/MlUw+SlozCg1Ng0ue41L+lm
         Oen9YpYPDkXMj+GrXemGxCHwLDXsAHc44LdAmraivyg4LuSzIEL3X0j/g/Z5D6zEiXlj
         S565ZTJqEjxm2VUId1PTSUxL+AcGLXiYipT+vXhBcDi3ohAT7G7wb/Di6RyuBUMBn5hk
         mTgbR5F1OvyT3WrmC+NEdLZ7NbXP5mspGsVmXmYivcDnxX4Jc/mD4AA61E73J0H3GXiZ
         y55Q==
X-Gm-Message-State: AOAM530/d+gxkyyu45WsX3bs3M/I7hFqReMkycKLCzdvqNucmX1rHVgv
        szLlJAAdD3qBpayLJOjZ4IO43p7TzdxZ+2Z0oREChcHUwHXqP4J+jrbDqCl7JU+tw/VCKCqmUvA
        bsPBLFsdLGQLI
X-Received: by 2002:adf:b354:: with SMTP id
 k20mr18137770wrd.412.1590943256926;
        Sun, 31 May 2020 09:40:56 -0700 (PDT)
X-Google-Smtp-Source: 
 ABdhPJx0HkzqO5UvunzkIevQCS8DP8RYc0sFupFoLUZyl6tgkem6GKu1Knj86ln8moQU3+6mIDc99g==
X-Received: by 2002:adf:b354:: with SMTP id
 k20mr18137753wrd.412.1590943256749;
        Sun, 31 May 2020 09:40:56 -0700 (PDT)
Received: from localhost.localdomain (43.red-83-51-162.dynamicip.rima-tde.net.
 [83.51.162.43])
        by smtp.gmail.com with ESMTPSA id
 d15sm18060321wrq.30.2020.05.31.09.40.55
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Sun, 31 May 2020 09:40:56 -0700 (PDT)
From: =?utf-8?q?Philippe_Mathieu-Daud=C3=A9?= <philmd@redhat.com>
To: qemu-devel@nongnu.org
Cc: Cleber Rosa <crosa@redhat.com>, Kevin Wolf <kwolf@redhat.com>,
 kvm@vger.kernel.org, Richard Henderson <rth@twiddle.net>,
 Fam Zheng <fam@euphon.net>, Eduardo Habkost <ehabkost@redhat.com>,
	=?utf-8?q?Alex_Benn=C3=A9e?= <alex.bennee@linaro.org>,
 Paolo Bonzini <pbonzini@redhat.com>, Max Reitz <mreitz@redhat.com>,
	=?utf-8?q?Philippe_Mathieu-Daud=C3=A9?= <philmd@redhat.com>,
 Stefan Hajnoczi <stefanha@redhat.com>, Markus Armbruster <armbru@redhat.com>,
 Marcelo Tosatti <mtosatti@redhat.com>, qemu-block@nongnu.org,
 Pavel Dovgalyuk <Pavel.Dovgaluk@gmail.com>,
 Pavel Dovgalyuk <Pavel.Dovgaluk@ispras.ru>
Subject: [PULL 25/25] tests/acceptance: refactor boot_linux to allow code
 reuse
Date: Sun, 31 May 2020 18:38:46 +0200
Message-Id: <20200531163846.25363-26-philmd@redhat.com>
X-Mailer: git-send-email 2.21.3
In-Reply-To: <20200531163846.25363-1-philmd@redhat.com>
References: <20200531163846.25363-1-philmd@redhat.com>
MIME-Version: 1.0
Sender: kvm-owner@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

From: Pavel Dovgalyuk <Pavel.Dovgaluk@gmail.com>

This patch moves image downloading functions to the separate class to allow
reusing them from record/replay tests.

Signed-off-by: Pavel Dovgalyuk <Pavel.Dovgaluk@ispras.ru>
Tested-by: Philippe Mathieu-Daudé <philmd@redhat.com>
Message-Id: <159073593167.20809.17582679291556188984.stgit@pasha-ThinkPad-X280>
Signed-off-by: Philippe Mathieu-Daudé <philmd@redhat.com>
---
 tests/acceptance/boot_linux.py | 49 ++++++++++++++++++++--------------
 1 file changed, 29 insertions(+), 20 deletions(-)

diff --git a/tests/acceptance/boot_linux.py b/tests/acceptance/boot_linux.py
index 075a386300..3aa57e88b0 100644
--- a/tests/acceptance/boot_linux.py
+++ b/tests/acceptance/boot_linux.py
@@ -26,22 +26,8 @@
 TCG_NOT_AVAILABLE = ACCEL_NOT_AVAILABLE_FMT % "TCG"
 
 
-class BootLinux(Test):
-    """
-    Boots a Linux system, checking for a successful initialization
-    """
-
-    timeout = 900
-    chksum = None
-
-    def setUp(self):
-        super(BootLinux, self).setUp()
-        self.vm.add_args('-smp', '2')
-        self.vm.add_args('-m', '1024')
-        self.prepare_boot()
-        self.prepare_cloudinit()
-
-    def prepare_boot(self):
+class BootLinuxBase(Test):
+    def download_boot(self):
         self.log.debug('Looking for and selecting a qemu-img binary to be '
                        'used to create the bootable snapshot image')
         # If qemu-img has been built, use it, otherwise the system wide one
@@ -60,17 +46,17 @@ def prepare_boot(self):
         if image_arch == 'ppc64':
             image_arch = 'ppc64le'
         try:
-            self.boot = vmimage.get(
+            boot = vmimage.get(
                 'fedora', arch=image_arch, version='31',
                 checksum=self.chksum,
                 algorithm='sha256',
                 cache_dir=self.cache_dirs[0],
                 snapshot_dir=self.workdir)
-            self.vm.add_args('-drive', 'file=%s' % self.boot.path)
         except:
             self.cancel('Failed to download/prepare boot image')
+        return boot.path
 
-    def prepare_cloudinit(self):
+    def download_cloudinit(self):
         self.log.info('Preparing cloudinit image')
         try:
             cloudinit_iso = os.path.join(self.workdir, 'cloudinit.iso')
@@ -81,9 +67,32 @@ def prepare_cloudinit(self):
                           # QEMU's hard coded usermode router address
                           phone_home_host='10.0.2.2',
                           phone_home_port=self.phone_home_port)
-            self.vm.add_args('-drive', 'file=%s,format=raw' % cloudinit_iso)
         except Exception:
             self.cancel('Failed to prepared cloudinit image')
+        return cloudinit_iso
+
+class BootLinux(BootLinuxBase):
+    """
+    Boots a Linux system, checking for a successful initialization
+    """
+
+    timeout = 900
+    chksum = None
+
+    def setUp(self):
+        super(BootLinux, self).setUp()
+        self.vm.add_args('-smp', '2')
+        self.vm.add_args('-m', '1024')
+        self.prepare_boot()
+        self.prepare_cloudinit()
+
+    def prepare_boot(self):
+        path = self.download_boot()
+        self.vm.add_args('-drive', 'file=%s' % path)
+
+    def prepare_cloudinit(self):
+        cloudinit_iso = self.download_cloudinit()
+        self.vm.add_args('-drive', 'file=%s,format=raw' % cloudinit_iso)
 
     def launch_and_wait(self):
         self.vm.set_console()
