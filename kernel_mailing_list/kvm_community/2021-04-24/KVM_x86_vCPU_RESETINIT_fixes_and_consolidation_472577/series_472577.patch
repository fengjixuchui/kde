From patchwork Sat Apr 24 00:46:03 2021
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
X-Patchwork-Submitter: Sean Christopherson <seanjc@google.com>
X-Patchwork-Id: 12222111
Return-Path: <kvm-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-26.3 required=3.0 tests=BAYES_00,DKIMWL_WL_MED,
	DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,
	INCLUDES_CR_TRAILER,INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,
	USER_AGENT_GIT,USER_IN_DEF_DKIM_WL autolearn=ham autolearn_force=no
	version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id A66B8C433B4
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:47:11 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 7EE6C61465
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:47:11 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S243974AbhDXAro (ORCPT <rfc822;kvm@archiver.kernel.org>);
        Fri, 23 Apr 2021 20:47:44 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:36716 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S237240AbhDXArl (ORCPT <rfc822;kvm@vger.kernel.org>);
        Fri, 23 Apr 2021 20:47:41 -0400
Received: from mail-yb1-xb4a.google.com (mail-yb1-xb4a.google.com
 [IPv6:2607:f8b0:4864:20::b4a])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id CA75DC06174A
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:47:02 -0700 (PDT)
Received: by mail-yb1-xb4a.google.com with SMTP id
 u73-20020a25ab4f0000b0290410f38a2f81so26212013ybi.22
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:47:02 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=google.com; s=20161025;
        h=reply-to:date:in-reply-to:message-id:mime-version:references
         :subject:from:to:cc;
        bh=RHGsqWwH1zxHj0xIe8K4VtoI6F8/53X2i4hvFea/Jtc=;
        b=OPjwaJ3YTXeq24If+8hQOW0VyJ+bADxa0ZRW5sPafB80mG4gzK4fam3t9CjRIQWl7T
         wGw7HJd4vszwt8ioG7VoGFwsLhoabf0qd/kaDt6vxb6365MyOLPhCdgvplw3BaMQ2qs8
         No6dsSgvzPfQcYF09OgMhnG4ahp0tp7RHLuXXmJ8jKSi2UmICvWZbzP2d/nJLz71SmY9
         lWxco2nnDLF9nUs8asjapZgxqWC9N3Z/d9gP+9Gmrj6EzMj0uHmP/G6vRkJPYNyoVxgz
         5l+Kvb6xbV4lSKxLTbI/+68iCD6p8msMn5HQemfW0SzONRC/SXhKoPbgtQYkTQWLFvJy
         O2cw==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:reply-to:date:in-reply-to:message-id
         :mime-version:references:subject:from:to:cc;
        bh=RHGsqWwH1zxHj0xIe8K4VtoI6F8/53X2i4hvFea/Jtc=;
        b=e981HZOg+yUbP0igHDM0VB5yqwq09laBsbPb9w5yUmFc5M4P/yOW4hfMpe+/t8Gb9s
         eF8R8/K6yDmI41jqTZUA4vbBywBIR9Vx+tcil5joRag42cZLFjl1JcUot51wz957veEY
         01BxgasFmoSny4Wn3autnO+mb/AgiVm1LAhcNPp5n72f46gUQlRXBm0qKT8YMbzQkHTG
         M58sGb4hvZp0evcpIQmHc0jIYoDJgs+WRjQ3/I/JAQvawgOq8e2PFxZQwZJnMYsBkRo+
         TQx0iRrn0vGem/FBGcdZKXWMjVV1D8Mi8NmDEOkGfJAfa+oNe1j/8RaDVT4zUQFewEDx
         4xZg==
X-Gm-Message-State: AOAM532YKPYyCdCq5pOH9GXbfF72XpaaoJLgF+FWpj0YOj3QnPC0H77x
        /LyfyvMn0C6JBdQ8hHpnYra3+o01xaU=
X-Google-Smtp-Source: 
 ABdhPJzX+waosmfrUN513JsYHxpFuDWHWvyn4N/ji2D0vC9EQhyeKOU7/v4bDJ04Jc3LfwehTPEuiQqvW2Q=
X-Received: from seanjc798194.pdx.corp.google.com
 ([2620:15c:f:10:ad52:3246:e190:f070])
 (user=seanjc job=sendgmr) by 2002:a25:ac9b:: with SMTP id
 x27mr8963271ybi.120.1619225222104;
 Fri, 23 Apr 2021 17:47:02 -0700 (PDT)
Reply-To: Sean Christopherson <seanjc@google.com>
Date: Fri, 23 Apr 2021 17:46:03 -0700
In-Reply-To: <20210424004645.3950558-1-seanjc@google.com>
Message-Id: <20210424004645.3950558-2-seanjc@google.com>
Mime-Version: 1.0
References: <20210424004645.3950558-1-seanjc@google.com>
X-Mailer: git-send-email 2.31.1.498.g6c1eba8ee3d-goog
Subject: [PATCH 01/43] KVM: nVMX: Set LDTR to its architecturally defined
 value on nested VM-Exit
From: Sean Christopherson <seanjc@google.com>
To: Paolo Bonzini <pbonzini@redhat.com>
Cc: Sean Christopherson <seanjc@google.com>,
        Vitaly Kuznetsov <vkuznets@redhat.com>,
        Wanpeng Li <wanpengli@tencent.com>,
        Jim Mattson <jmattson@google.com>,
        Joerg Roedel <joro@8bytes.org>, kvm@vger.kernel.org,
        linux-kernel@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

Set L1's LDTR on VM-Exit per the Intel SDM:

  The host-state area does not contain a selector field for LDTR. LDTR is
  established as follows on all VM exits: the selector is cleared to
  0000H, the segment is marked unusable and is otherwise undefined
  (although the base address is always canonical).

This is likely a benign bug since the LDTR is unusable, as it means the
L1 VMM is conditioned to reload its LDTR in order to function properly on
bare metal.

Fixes: 4704d0befb07 ("KVM: nVMX: Exiting from L2 to L1")
Signed-off-by: Sean Christopherson <seanjc@google.com>
---
 arch/x86/kvm/vmx/nested.c | 4 ++++
 1 file changed, 4 insertions(+)

diff --git a/arch/x86/kvm/vmx/nested.c b/arch/x86/kvm/vmx/nested.c
index 00339d624c92..32126fa0c4d8 100644
--- a/arch/x86/kvm/vmx/nested.c
+++ b/arch/x86/kvm/vmx/nested.c
@@ -4276,6 +4276,10 @@ static void load_vmcs12_host_state(struct kvm_vcpu *vcpu,
 	};
 	vmx_set_segment(vcpu, &seg, VCPU_SREG_TR);
 
+	memset(&seg, 0, sizeof(seg));
+	seg.unusable = 1;
+	vmx_set_segment(vcpu, &seg, VCPU_SREG_LDTR);
+
 	kvm_set_dr(vcpu, 7, 0x400);
 	vmcs_write64(GUEST_IA32_DEBUGCTL, 0);
 

From patchwork Sat Apr 24 00:46:04 2021
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
X-Patchwork-Submitter: Sean Christopherson <seanjc@google.com>
X-Patchwork-Id: 12222113
Return-Path: <kvm-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-26.3 required=3.0 tests=BAYES_00,DKIMWL_WL_MED,
	DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,
	INCLUDES_CR_TRAILER,INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,
	USER_AGENT_GIT,USER_IN_DEF_DKIM_WL autolearn=ham autolearn_force=no
	version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 0100BC43460
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:47:13 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id D2E3261462
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:47:12 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S244139AbhDXArs (ORCPT <rfc822;kvm@archiver.kernel.org>);
        Fri, 23 Apr 2021 20:47:48 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:36728 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S236084AbhDXArn (ORCPT <rfc822;kvm@vger.kernel.org>);
        Fri, 23 Apr 2021 20:47:43 -0400
Received: from mail-qk1-x749.google.com (mail-qk1-x749.google.com
 [IPv6:2607:f8b0:4864:20::749])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 11245C06138B
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:47:05 -0700 (PDT)
Received: by mail-qk1-x749.google.com with SMTP id
 g76-20020a379d4f0000b02902e40532d832so9461156qke.20
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:47:05 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=google.com; s=20161025;
        h=reply-to:date:in-reply-to:message-id:mime-version:references
         :subject:from:to:cc;
        bh=qhJeA9fQsblztcKyPyMtaBD+iwF8KjnP8LQXx6xVt+Y=;
        b=b3hY/U1WaneYQzBX9CN0ubCT32hE7hloWZQl65LI4eOUrh2+bCCLjcGsK2HvWOnJpg
         sBdJcC9mDoOMsLXUUS9kQD/3X5H/CcZLA/Eu6/ssiSu2KlTk+u2hrcofJqqKfoCqCauZ
         u+SI3MhCXDJOhIOavHtb6eda4e+B49L6lq5e/0STCZqREnb3SRT7HHjzTfdatDkVET+/
         0vOobWHTBwTP6Q37Za+FXkozTubZLUJjxuivp2cf6iN2odnT/Uu+Zgij495RzNj/le8U
         R53bGc1k9EXAJf562dRE4GHwbMY6+Cr1bCcZWozxeuEU20vhS16WbFUKio0F/9kLuZfV
         v0nA==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:reply-to:date:in-reply-to:message-id
         :mime-version:references:subject:from:to:cc;
        bh=qhJeA9fQsblztcKyPyMtaBD+iwF8KjnP8LQXx6xVt+Y=;
        b=CXtJoAFc2FzaPM1zYOqGZ13c6DnTDI+kuXCv6Or9qntUERM0mIhk/XZc01i5UjS3eF
         FVGtEmvThzMYIUEJDjPMDxH/1lJEFU4sIxm3jD46rVW2cBaT9NCFHejVCjN8ksA8L+e2
         bMoWgc6BlfAJ8/I7hSX/bu0tpxby44Qxo+iOX19hHNTGPaMCtzcX6VJUM5yiu9oAsmPr
         0A2I8sFxiIAhkdBmM9AXsSsNWDkr+gFUMeMIvAaEVrUHaY+dT8+2Kn0lrpLlz7mV5vLO
         03py9vMGmNkzj76G/I36+iZK6CEBxFOWjibCeUb8RbrDxaqZLz+1Ed0VNi2Up8RQDa6j
         1BJg==
X-Gm-Message-State: AOAM531YiBoYg/x24goRL2NUeSfP27yOcNOAiVU3QH8ug3wTdMa2zfCt
        +yclUT2YH6+zjX2fP3+RQOLT1GqW9no=
X-Google-Smtp-Source: 
 ABdhPJyDQMKu2bPxJQfGop/kTOzjGyE4dTxY0BImHfkaNpq+Ou8R2DmlzmPCu2WWxy1hBBcaH1nOFkenA/M=
X-Received: from seanjc798194.pdx.corp.google.com
 ([2620:15c:f:10:ad52:3246:e190:f070])
 (user=seanjc job=sendgmr) by 2002:a0c:e950:: with SMTP id
 n16mr7445105qvo.43.1619225224151;
 Fri, 23 Apr 2021 17:47:04 -0700 (PDT)
Reply-To: Sean Christopherson <seanjc@google.com>
Date: Fri, 23 Apr 2021 17:46:04 -0700
In-Reply-To: <20210424004645.3950558-1-seanjc@google.com>
Message-Id: <20210424004645.3950558-3-seanjc@google.com>
Mime-Version: 1.0
References: <20210424004645.3950558-1-seanjc@google.com>
X-Mailer: git-send-email 2.31.1.498.g6c1eba8ee3d-goog
Subject: [PATCH 02/43] KVM: VMX: Set EDX at INIT with CPUID.0x1,
 Family-Model-Stepping
From: Sean Christopherson <seanjc@google.com>
To: Paolo Bonzini <pbonzini@redhat.com>
Cc: Sean Christopherson <seanjc@google.com>,
        Vitaly Kuznetsov <vkuznets@redhat.com>,
        Wanpeng Li <wanpengli@tencent.com>,
        Jim Mattson <jmattson@google.com>,
        Joerg Roedel <joro@8bytes.org>, kvm@vger.kernel.org,
        linux-kernel@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

Set EDX at RESET/INIT based on the userspace-defined CPUID model when
possible, i.e. when CPUID.0x1.EAX is defined by userspace.  At
RESET/INIT, all CPUs that support CPUID set EDX to the FMS enumerated in
CPUID.0x1.EAX.  If no CPUID match is found, fall back to KVM's default
of 0x600 (Family '6'), which is the least awful approximation of KVM's
virtual CPU model.

Fixes: 6aa8b732ca01 ("[PATCH] kvm: userspace interface")
Signed-off-by: Sean Christopherson <seanjc@google.com>
---
 arch/x86/kvm/vmx/vmx.c | 7 ++++++-
 1 file changed, 6 insertions(+), 1 deletion(-)

diff --git a/arch/x86/kvm/vmx/vmx.c b/arch/x86/kvm/vmx/vmx.c
index a182cae71044..9c00d013af59 100644
--- a/arch/x86/kvm/vmx/vmx.c
+++ b/arch/x86/kvm/vmx/vmx.c
@@ -4497,6 +4497,7 @@ static void vmx_vcpu_reset(struct kvm_vcpu *vcpu, bool init_event)
 {
 	struct vcpu_vmx *vmx = to_vmx(vcpu);
 	struct msr_data apic_base_msr;
+	u32 eax, dummy;
 	u64 cr0;
 
 	vmx->rmode.vm86_active = 0;
@@ -4504,7 +4505,11 @@ static void vmx_vcpu_reset(struct kvm_vcpu *vcpu, bool init_event)
 
 	vmx->msr_ia32_umwait_control = 0;
 
-	vmx->vcpu.arch.regs[VCPU_REGS_RDX] = get_rdx_init_val();
+	eax = 1;
+	if (!kvm_cpuid(vcpu, &eax, &dummy, &dummy, &dummy, true))
+		eax = get_rdx_init_val();
+	kvm_rdx_write(vcpu, eax);
+
 	vmx->hv_deadline_tsc = -1;
 	kvm_set_cr8(vcpu, 0);
 

From patchwork Sat Apr 24 00:46:05 2021
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
X-Patchwork-Submitter: Sean Christopherson <seanjc@google.com>
X-Patchwork-Id: 12222115
Return-Path: <kvm-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-26.3 required=3.0 tests=BAYES_00,DKIMWL_WL_MED,
	DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,
	INCLUDES_CR_TRAILER,INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,
	USER_AGENT_GIT,USER_IN_DEF_DKIM_WL autolearn=ham autolearn_force=no
	version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id D2E8FC433B4
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:47:15 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id B59B461462
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:47:15 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S244147AbhDXArv (ORCPT <rfc822;kvm@archiver.kernel.org>);
        Fri, 23 Apr 2021 20:47:51 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:36738 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S244088AbhDXArr (ORCPT <rfc822;kvm@vger.kernel.org>);
        Fri, 23 Apr 2021 20:47:47 -0400
Received: from mail-qk1-x749.google.com (mail-qk1-x749.google.com
 [IPv6:2607:f8b0:4864:20::749])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 30585C06174A
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:47:07 -0700 (PDT)
Received: by mail-qk1-x749.google.com with SMTP id
 g184-20020a3784c10000b02902e385de9adaso15314212qkd.3
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:47:07 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=google.com; s=20161025;
        h=reply-to:date:in-reply-to:message-id:mime-version:references
         :subject:from:to:cc;
        bh=WDHyTgGjim6hk3/xd8JtlILQjW4Wl2Ft0fupXNYGdHc=;
        b=rvQnQvoP00Y7thOgQbkMO45k+pLyOLGgPtLCI27QOGyOOacF6s5jSWo7yThwKATN2j
         gRoqPUOPIg6AkpXdKzh/EdXAzIXyvJAbL3JyWI6e7MEPDQe5Y6KR/cpJzkbmQOo7Cv2g
         oqNuv3Vq4fCHXKP1dWMvFDgnu/lWiDStPzq0RDOJbXuuCyLYDo5CAX0P8NQM4GHHYW1C
         PSqUlcNQ7Ytju04V1UQmEuoFBdp8VIBcbY9o33dP8BY10NLdCjeURq/0yAP+zgFk/BMk
         OQYvtHz1eU0ypNg/RkrzVRr0Oi3Cht4n0S9STEhnJV+sNJ2/Bh8c9qaK9rP4cD83Lpgm
         pm/g==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:reply-to:date:in-reply-to:message-id
         :mime-version:references:subject:from:to:cc;
        bh=WDHyTgGjim6hk3/xd8JtlILQjW4Wl2Ft0fupXNYGdHc=;
        b=WCY8Y5jOlx3owyErdEFcjV5odqdV4iZYQZuZmYW1Qaff0A4uZMkfEVXQnauyDVYURS
         PnMF4jyKzifzcmTBt+KfCUuAvIt34Bn385IeXBKgZivTdoRoQSxsrq4Lns8M9qkQbHlF
         1/8llX7wZTPXKF/tCrsT3KyvIOQHPVZNF5Q7XXOwB3cvXjgJLJpHT/JuAk+KgwDEFw8y
         XeA4Q5vB0/aIdmN2vRttzszkOo2kTEzIH5KhllM+q0inGlMw/Joh2P3u/OdRYC7IlLm/
         MPgYDmPgFKS28SjZhOQZUWK6ClViQysPtJFs/nWfJ5GGfEjbXQakk+fNbNCuhcMRhlCr
         lbKA==
X-Gm-Message-State: AOAM532cngI9yIa2BhgH+H7BtzsBtsZLn2WSj20whxrMqz41C8Sub0GT
        Ul1r5xgP/Gk0RMT7+S3Ii7LTut7D3sI=
X-Google-Smtp-Source: 
 ABdhPJxba3jkQY8JoBg2/bwM1Z2vQB+NWcrsdv6irr9VK+VHqlDgSN7t9llZT/MKf+h1RoPbe5u8rIhrzM8=
X-Received: from seanjc798194.pdx.corp.google.com
 ([2620:15c:f:10:ad52:3246:e190:f070])
 (user=seanjc job=sendgmr) by 2002:a0c:f247:: with SMTP id
 z7mr7230997qvl.24.1619225226439;
 Fri, 23 Apr 2021 17:47:06 -0700 (PDT)
Reply-To: Sean Christopherson <seanjc@google.com>
Date: Fri, 23 Apr 2021 17:46:05 -0700
In-Reply-To: <20210424004645.3950558-1-seanjc@google.com>
Message-Id: <20210424004645.3950558-4-seanjc@google.com>
Mime-Version: 1.0
References: <20210424004645.3950558-1-seanjc@google.com>
X-Mailer: git-send-email 2.31.1.498.g6c1eba8ee3d-goog
Subject: [PATCH 03/43] KVM: SVM: Require exact CPUID.0x1 match when stuffing
 EDX at INIT
From: Sean Christopherson <seanjc@google.com>
To: Paolo Bonzini <pbonzini@redhat.com>
Cc: Sean Christopherson <seanjc@google.com>,
        Vitaly Kuznetsov <vkuznets@redhat.com>,
        Wanpeng Li <wanpengli@tencent.com>,
        Jim Mattson <jmattson@google.com>,
        Joerg Roedel <joro@8bytes.org>, kvm@vger.kernel.org,
        linux-kernel@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

Do not allow an inexact CPUID "match" when querying the guest's CPUID.0x1
to stuff EDX during INIT.  In the common case, where the guest CPU model
is an AMD variant, allowing an inexact match is a nop since KVM doesn't
emulate Intel's goofy "out-of-range" logic for AMD and Hygon.  If the
vCPU model happens to be an Intel variant, an inexact match is possible
if and only if the max CPUID leaf is precisely '0'. Aside from the fact
that there's probably no CPU in existence with a single CPUID leaf, if
the max CPUID leaf is '0', that means that CPUID.0.EAX is '0', and thus
an inexact match for CPUID.0x1.EAX will also yield '0'.

So, with lots of twisty logic, no functional change intended.

Signed-off-by: Sean Christopherson <seanjc@google.com>
---
 arch/x86/kvm/svm/svm.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/arch/x86/kvm/svm/svm.c b/arch/x86/kvm/svm/svm.c
index 14ff7f0963e9..b9e3229ddc27 100644
--- a/arch/x86/kvm/svm/svm.c
+++ b/arch/x86/kvm/svm/svm.c
@@ -1299,7 +1299,7 @@ static void svm_vcpu_reset(struct kvm_vcpu *vcpu, bool init_event)
 	}
 	init_vmcb(vcpu);
 
-	kvm_cpuid(vcpu, &eax, &dummy, &dummy, &dummy, false);
+	kvm_cpuid(vcpu, &eax, &dummy, &dummy, &dummy, true);
 	kvm_rdx_write(vcpu, eax);
 
 	if (kvm_vcpu_apicv_active(vcpu) && !init_event)

From patchwork Sat Apr 24 00:46:06 2021
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
X-Patchwork-Submitter: Sean Christopherson <seanjc@google.com>
X-Patchwork-Id: 12222117
Return-Path: <kvm-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-26.3 required=3.0 tests=BAYES_00,DKIMWL_WL_MED,
	DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,
	INCLUDES_CR_TRAILER,INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,
	USER_AGENT_GIT,USER_IN_DEF_DKIM_WL autolearn=ham autolearn_force=no
	version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 072BEC433B4
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:47:20 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id BE9CE61465
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:47:19 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S244194AbhDXArz (ORCPT <rfc822;kvm@archiver.kernel.org>);
        Fri, 23 Apr 2021 20:47:55 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:36746 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S236084AbhDXArs (ORCPT <rfc822;kvm@vger.kernel.org>);
        Fri, 23 Apr 2021 20:47:48 -0400
Received: from mail-qk1-x749.google.com (mail-qk1-x749.google.com
 [IPv6:2607:f8b0:4864:20::749])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 68C61C061756
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:47:09 -0700 (PDT)
Received: by mail-qk1-x749.google.com with SMTP id
 h22-20020a05620a13f6b02902e3e9aad4bdso11558051qkl.14
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:47:09 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=google.com; s=20161025;
        h=reply-to:date:in-reply-to:message-id:mime-version:references
         :subject:from:to:cc;
        bh=Z23zPQAgxlBigLhFQaq/Iwh63wl+bRNTg9ZoEclpoEQ=;
        b=SWsFp/9EiXizbzTZHrHr0qgh4MJgPmOaDWL3ZJFP7m6lSN0+Oc4/yRfnkMabUXBbO8
         rrPWAtC/mzWxZlqtyksyKvjwtdZ6W4jL96KxqfaPjk8N4mxYETzupFdQgq7p7PZ3pXTi
         vGgmGYA1EDadD+YakYmwdBZILiSbwl/3hMaITsMCr9utLlKPjkUWBMiYa/CKEKoe3eiu
         ZKujj+e+blJrpSXrFco3lN84sEvEejoq9HVR78JJmEAa+HX3tn3+ZJK2wA9hymcKfp++
         RtBF3/69GAczeXPMUbVIJQFWveCrfDknw3pN8A8mInXKqOoBDP/THOWRvRh8P9Ft/A4j
         XSPA==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:reply-to:date:in-reply-to:message-id
         :mime-version:references:subject:from:to:cc;
        bh=Z23zPQAgxlBigLhFQaq/Iwh63wl+bRNTg9ZoEclpoEQ=;
        b=QzQGd12I061t6n1KGVNibm4XYAk1xnkObmOkogPogK5lSndIo+mNhBG8We/Y2wbZe7
         3QVFPDR5dM+mh6Lffcz+qBDj9XtyEwDxabea4ATnp7fvbJWUx8SSNxv0TgO1NZIPlAYp
         y+m4nGRBlikduRlBUFozGiNOTR98uYQOLca34jwcGpMg04mRdWWTvkNOauQMvfbl08Kx
         Upl2PDJMhG/n1PHhydGVye4ptwE7lLSDgf236uM0RqPBY1Nsn1xY/ZLnukzBx7yS9Fnr
         nGlfzAsxVeOGjZ4EIeOVgfz5P0sanghZYowg91bZwu6/L8w3E7mtAa+zF8wsUPTtyEsC
         HKSQ==
X-Gm-Message-State: AOAM531F/3TIN6b4GIm+gsYwSX8V2Bcu3hR4p+rRP/HWCpMvInSMmHIG
        /hkcZVw92y+Y+ZbvewOV5Lhtr4tikdY=
X-Google-Smtp-Source: 
 ABdhPJwL+caeGee5q5H1DwGy2Zp+KrNbEV1OdzbTDu+pWbDKkegIYuDBsNf+879sZmeGGLjrZGJLv0D5FB0=
X-Received: from seanjc798194.pdx.corp.google.com
 ([2620:15c:f:10:ad52:3246:e190:f070])
 (user=seanjc job=sendgmr) by 2002:a05:6214:88d:: with SMTP id
 cz13mr7404534qvb.13.1619225228657; Fri, 23 Apr 2021 17:47:08 -0700 (PDT)
Reply-To: Sean Christopherson <seanjc@google.com>
Date: Fri, 23 Apr 2021 17:46:06 -0700
In-Reply-To: <20210424004645.3950558-1-seanjc@google.com>
Message-Id: <20210424004645.3950558-5-seanjc@google.com>
Mime-Version: 1.0
References: <20210424004645.3950558-1-seanjc@google.com>
X-Mailer: git-send-email 2.31.1.498.g6c1eba8ee3d-goog
Subject: [PATCH 04/43] KVM: SVM: Fall back to KVM's hardcoded value for EDX at
 RESET/INIT
From: Sean Christopherson <seanjc@google.com>
To: Paolo Bonzini <pbonzini@redhat.com>
Cc: Sean Christopherson <seanjc@google.com>,
        Vitaly Kuznetsov <vkuznets@redhat.com>,
        Wanpeng Li <wanpengli@tencent.com>,
        Jim Mattson <jmattson@google.com>,
        Joerg Roedel <joro@8bytes.org>, kvm@vger.kernel.org,
        linux-kernel@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

At vCPU RESET/INIT (mostly RESET), stuff EDX with KVM's hardcoded,
default Family-Model-Stepping ID of 0x600 if CPUID.0x1 isn't defined.
At RESET, the CPUID lookup is guaranteed to "miss" because KVM emulates
RESET before exposing the vCPU to userspace, i.e. userspace can't
possibly have done set the vCPU's CPUID model, and thus KVM will always
write '0'.  At INIT, using 0x600 is less bad than using '0'.

While initializing EDX to '0' is _extremely_ unlikely to be noticed by
the guest, let alone break the guest, and can be overridden by
userspace for the RESET case, using 0x600 is preferable as it will allow
consolidating the relevant VMX and SVM RESET/INIT logic in the future.
And, digging through old specs suggests that neither Intel nor AMD have
ever shipped a CPU that initialized EDX to '0' at RESET.

Regarding 0x600 as KVM's default Family, it is a sane default and in
many ways the most appropriate.  Prior to the 386 implementations, DX
was undefined at RESET.  With the 386, 486, 586/P5, and 686/P6/Athlon,
both Intel and AMD set EDX to 3, 4, 5, and 6 respectively.  AMD switched
to using '15' as its primary Family with the introduction of AMD64, but
Intel has continued using '6' for the last few decades.

So, '6' is a valid Family for both Intel and AMD CPUs, is compatible
with both 32-bit and 64-bit CPUs (albeit not a perfect fit for 64-bit
AMD), and of the common Families (3 - 6), is the best fit with respect to
KVM's virtual CPU model.  E.g. prior to the P6, Intel CPUs did not have a
STI window.  Modern operating systems, Linux included, rely on the STI
window, e.g. for "safe halt", and KVM unconditionally assumes the virtual
CPU has an STI window.  Thus enumerating a Family ID of 3, 4, or 5 would
be provably wrong.

Opportunistically remove a stale comment.

Fixes: 66f7b72e1171 ("KVM: x86: Make register state after reset conform to specification")
Signed-off-by: Sean Christopherson <seanjc@google.com>
---
 arch/x86/kvm/svm/svm.c | 11 +++++++++--
 1 file changed, 9 insertions(+), 2 deletions(-)

diff --git a/arch/x86/kvm/svm/svm.c b/arch/x86/kvm/svm/svm.c
index b9e3229ddc27..d4d7720ce42f 100644
--- a/arch/x86/kvm/svm/svm.c
+++ b/arch/x86/kvm/svm/svm.c
@@ -1219,7 +1219,6 @@ static void init_vmcb(struct kvm_vcpu *vcpu)
 	kvm_mmu_reset_context(vcpu);
 
 	save->cr4 = X86_CR4_PAE;
-	/* rdx = ?? */
 
 	if (npt_enabled) {
 		/* Setup VMCB for Nested Paging */
@@ -1299,7 +1298,15 @@ static void svm_vcpu_reset(struct kvm_vcpu *vcpu, bool init_event)
 	}
 	init_vmcb(vcpu);
 
-	kvm_cpuid(vcpu, &eax, &dummy, &dummy, &dummy, true);
+	/*
+	 * Fall back to KVM's default Family/Model/Stepping if no CPUID match
+	 * is found.  Note, it's impossible to get a match at RESET since KVM
+	 * emulates RESET before exposing the vCPU to userspace, i.e. it's
+	 * impossible for kvm_cpuid() to find a valid entry on RESET.  But, go
+	 * through the motions in case that's ever remedied, and to be pedantic.
+	 */
+	if (!kvm_cpuid(vcpu, &eax, &dummy, &dummy, &dummy, true))
+		eax = get_rdx_init_val();
 	kvm_rdx_write(vcpu, eax);
 
 	if (kvm_vcpu_apicv_active(vcpu) && !init_event)

From patchwork Sat Apr 24 00:46:07 2021
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
X-Patchwork-Submitter: Sean Christopherson <seanjc@google.com>
X-Patchwork-Id: 12222119
Return-Path: <kvm-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-26.3 required=3.0 tests=BAYES_00,DKIMWL_WL_MED,
	DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,
	INCLUDES_CR_TRAILER,INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,
	USER_AGENT_GIT,USER_IN_DEF_DKIM_WL autolearn=ham autolearn_force=no
	version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 6B7ACC43460
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:47:21 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 469D361463
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:47:21 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S244198AbhDXAr4 (ORCPT <rfc822;kvm@archiver.kernel.org>);
        Fri, 23 Apr 2021 20:47:56 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:36738 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S244169AbhDXArt (ORCPT <rfc822;kvm@vger.kernel.org>);
        Fri, 23 Apr 2021 20:47:49 -0400
Received: from mail-yb1-xb4a.google.com (mail-yb1-xb4a.google.com
 [IPv6:2607:f8b0:4864:20::b4a])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id B2228C061574
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:47:11 -0700 (PDT)
Received: by mail-yb1-xb4a.google.com with SMTP id
 n11-20020a25808b0000b02904d9818b80e8so26105569ybk.14
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:47:11 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=google.com; s=20161025;
        h=reply-to:date:in-reply-to:message-id:mime-version:references
         :subject:from:to:cc;
        bh=eLXITIaRSuUPT8nfK0P77aCKjNJeDULPyebo6963mgA=;
        b=D01Z2nQvrqvPGM2+TMi1fDQ40FrBs4SoH9NdPjhrjuAk39IioVMxoDDE8TIoyEfPty
         ZC4AXMSXhuDPcIQSSiD7a2b3FZz4MZHmLyygGcs7fxOIJyDI4Pj8zQuJ3Y1zhh+Ry4KD
         CFS60tnES5yM1Qi02DdBwBZDKSh7wbviijj648HM2ATHBO5vCKcoMc85THK32jgAaO5w
         19f7NAhS94vaL3rdmyC0i5tBcQ13w0abEnJ5oSLx+ixsSbgiIggrZcpFiaU+W9JL8kET
         jqdVrgvoMMKpiiuMo5VecgzQAIcNplDmDi6y6rNeYzcRXdlCVxdV/ZHN/bdOu+1XG69A
         GV3w==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:reply-to:date:in-reply-to:message-id
         :mime-version:references:subject:from:to:cc;
        bh=eLXITIaRSuUPT8nfK0P77aCKjNJeDULPyebo6963mgA=;
        b=LD4tVeksxeF6qA7SLbCGbsjGbA4UlKfnbM+UHBl3wlIn4AhcMtkDiEqBla4vS2DNyH
         wGPj16drtB6mEnIDOpLd62nBJkPgW5IBbi5iFJAmUDHaPrlN9FlzeSwH+BDe/4Wn96xo
         6PT6LMDMNu0j1lA0cZ7brxNUFLLdxWV+Nkz5bO/v//ZxYglbjrg7stZOY1ZYGH2o2UPg
         g/q6okpcHCZZT+3xcupqmzrJz5m1wYE9s0DlGIB45JslKr+V5HR1FMMi5/dBVWuU6Bvb
         d4Id/iAAyXat0jkzQG+G5mEsyushSPobS1fOJ8j4Ueu2mWUPCb/Y0rwbUZNeJaLTJ8ng
         RipA==
X-Gm-Message-State: AOAM532+4BliMs902wCwF5zFHnPg7vV4oi+HuPTPZbYHal1Ji8J2xIbm
        bjB1HKWckaLaWdIh65J4S+ykpryLeiQ=
X-Google-Smtp-Source: 
 ABdhPJygFq/wAwVEmmGyNGHD6tEd0pB/Sve3VonZlYrccyTtdRzzfTv52tPrSXGNwozvRoNleeRkSmZptgY=
X-Received: from seanjc798194.pdx.corp.google.com
 ([2620:15c:f:10:ad52:3246:e190:f070])
 (user=seanjc job=sendgmr) by 2002:a5b:ed2:: with SMTP id
 a18mr9410758ybs.466.1619225231008;
 Fri, 23 Apr 2021 17:47:11 -0700 (PDT)
Reply-To: Sean Christopherson <seanjc@google.com>
Date: Fri, 23 Apr 2021 17:46:07 -0700
In-Reply-To: <20210424004645.3950558-1-seanjc@google.com>
Message-Id: <20210424004645.3950558-6-seanjc@google.com>
Mime-Version: 1.0
References: <20210424004645.3950558-1-seanjc@google.com>
X-Mailer: git-send-email 2.31.1.498.g6c1eba8ee3d-goog
Subject: [PATCH 05/43] KVM: x86: Split out CR0/CR4 MMU role change detectors
 to separate helpers
From: Sean Christopherson <seanjc@google.com>
To: Paolo Bonzini <pbonzini@redhat.com>
Cc: Sean Christopherson <seanjc@google.com>,
        Vitaly Kuznetsov <vkuznets@redhat.com>,
        Wanpeng Li <wanpengli@tencent.com>,
        Jim Mattson <jmattson@google.com>,
        Joerg Roedel <joro@8bytes.org>, kvm@vger.kernel.org,
        linux-kernel@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

Split out the post-CR0/CR4 MMU role change detectors to separate helpers,
they will be used during vCPU RESET/INIT to conditionally reset the MMU
in a future patch.

No functional change intended.

Signed-off-by: Sean Christopherson <seanjc@google.com>
---
 arch/x86/kvm/x86.c | 22 ++++++++++++++++------
 1 file changed, 16 insertions(+), 6 deletions(-)

diff --git a/arch/x86/kvm/x86.c b/arch/x86/kvm/x86.c
index 3bf52ba5f2bb..0bc783fc6c9b 100644
--- a/arch/x86/kvm/x86.c
+++ b/arch/x86/kvm/x86.c
@@ -823,16 +823,21 @@ bool pdptrs_changed(struct kvm_vcpu *vcpu)
 }
 EXPORT_SYMBOL_GPL(pdptrs_changed);
 
+static bool kvm_cr0_mmu_role_changed(unsigned long old_cr0, unsigned long cr0)
+{
+	unsigned long mmu_role_bits = X86_CR0_PG | X86_CR0_WP;
+
+	return (cr0 ^ old_cr0) & mmu_role_bits;
+}
+
 void kvm_post_set_cr0(struct kvm_vcpu *vcpu, unsigned long old_cr0, unsigned long cr0)
 {
-	unsigned long update_bits = X86_CR0_PG | X86_CR0_WP;
-
 	if ((cr0 ^ old_cr0) & X86_CR0_PG) {
 		kvm_clear_async_pf_completion_queue(vcpu);
 		kvm_async_pf_hash_reset(vcpu);
 	}
 
-	if ((cr0 ^ old_cr0) & update_bits)
+	if (kvm_cr0_mmu_role_changed(old_cr0, cr0))
 		kvm_mmu_reset_context(vcpu);
 
 	if (((cr0 ^ old_cr0) & X86_CR0_CD) &&
@@ -1009,13 +1014,18 @@ bool kvm_is_valid_cr4(struct kvm_vcpu *vcpu, unsigned long cr4)
 }
 EXPORT_SYMBOL_GPL(kvm_is_valid_cr4);
 
-void kvm_post_set_cr4(struct kvm_vcpu *vcpu, unsigned long old_cr4, unsigned long cr4)
+static bool kvm_cr4_mmu_role_changed(unsigned long old_cr4, unsigned long cr4)
 {
 	unsigned long mmu_role_bits = X86_CR4_PGE | X86_CR4_PSE | X86_CR4_PAE |
 				      X86_CR4_SMEP | X86_CR4_SMAP | X86_CR4_PKE;
 
-	if (((cr4 ^ old_cr4) & mmu_role_bits) ||
-	    (!(cr4 & X86_CR4_PCIDE) && (old_cr4 & X86_CR4_PCIDE)))
+	return (((cr4 ^ old_cr4) & mmu_role_bits) ||
+	       (!(cr4 & X86_CR4_PCIDE) && (old_cr4 & X86_CR4_PCIDE)));
+}
+
+void kvm_post_set_cr4(struct kvm_vcpu *vcpu, unsigned long old_cr4, unsigned long cr4)
+{
+	if (kvm_cr4_mmu_role_changed(old_cr4, cr4))
 		kvm_mmu_reset_context(vcpu);
 }
 EXPORT_SYMBOL_GPL(kvm_post_set_cr4);

From patchwork Sat Apr 24 00:46:08 2021
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
X-Patchwork-Submitter: Sean Christopherson <seanjc@google.com>
X-Patchwork-Id: 12222121
Return-Path: <kvm-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-26.3 required=3.0 tests=BAYES_00,DKIMWL_WL_MED,
	DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,
	INCLUDES_CR_TRAILER,INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,
	USER_AGENT_GIT,USER_IN_DEF_DKIM_WL autolearn=ham autolearn_force=no
	version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 49202C433B4
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:47:28 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 0BF6761463
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:47:28 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S244237AbhDXAsC (ORCPT <rfc822;kvm@archiver.kernel.org>);
        Fri, 23 Apr 2021 20:48:02 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:36778 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S244186AbhDXArx (ORCPT <rfc822;kvm@vger.kernel.org>);
        Fri, 23 Apr 2021 20:47:53 -0400
Received: from mail-yb1-xb49.google.com (mail-yb1-xb49.google.com
 [IPv6:2607:f8b0:4864:20::b49])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 1CC1EC06175F
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:47:14 -0700 (PDT)
Received: by mail-yb1-xb49.google.com with SMTP id
 n11-20020a25808b0000b02904d9818b80e8so26105645ybk.14
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:47:14 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=google.com; s=20161025;
        h=reply-to:date:in-reply-to:message-id:mime-version:references
         :subject:from:to:cc;
        bh=S9LmVyYL6pKRzjL0U4nbFcV7jk04TtApkl0zLSJh5eY=;
        b=Vpz6x3d/WMuGdzpraohbyCQTi1uVwYhunPo+2aSj5UWanqRDVQrIPgbKUnMiD2hOCz
         bY733/hXMBRJuCid8pzgaqoC4inNWlfoJO08iKaGNWY9/BNNJrrymcs1T9vCmcl+TGun
         BJPhe4tSMQEtq4+TabGCNItyljf1U49IIu76UxhNEtk8ppSIARKIORJNxdNbQVFERfZE
         PTnKL2g2A1FO7GYiI33n/k6yA86qLPZL3a5Kg6In+QtEcRDcZA2Vw/I9p9FQs8/JmGEf
         8puBdq5ol2dh+WFW8mZT6gPrFZqgQrMG6J5A+PMxPtg28ur0uH+6yvm3Q+iZA16pwS0z
         5cuQ==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:reply-to:date:in-reply-to:message-id
         :mime-version:references:subject:from:to:cc;
        bh=S9LmVyYL6pKRzjL0U4nbFcV7jk04TtApkl0zLSJh5eY=;
        b=JdhCHY7r82xlwHBabYKGkug9/55tCuR7c5bLF+sOmBQnY0WyZHxHY1YqYyu1m1gtEj
         KwBxzYzztrLJXQT9RSuNQtRa7f9GjSE1ohRLq7Cqew6Xk2YisLO+FEcC6CzgQLaBY0zs
         +QPg1fN7TElR34fcr1v1miFJdBndi+UgYaWIXA5O4+4RMEmEV1Tm3eM9Z4NWyUapC4FG
         BHIaJgszNRaGQkr1QkTdnTLqaTV7T/Xw+kxuag6FDme5nrJuRXrPnYntJdr0XT9nqlK3
         5sZ4LbnshIqkn+vpBlcvSciZGaDTYfsADJSO2nwZ07i2x2vEYJiliBP86XLpgkLZtYeN
         DOsA==
X-Gm-Message-State: AOAM533Ll//YHJrubE1/hRR8HRnM7pkDCYbSnkPzJxfGVkz+WeUkfMPF
        +oKjuTOwAay8kEgZcDw4hCi/mdUZ+M0=
X-Google-Smtp-Source: 
 ABdhPJzNjugdSqn82XdJBxea+OssmMAoG3fwvDRlR+EOI2k0bGA2Fsupd6nBHuUkreyhPVBG/DoW7J0IQ3k=
X-Received: from seanjc798194.pdx.corp.google.com
 ([2620:15c:f:10:ad52:3246:e190:f070])
 (user=seanjc job=sendgmr) by 2002:a25:fc0a:: with SMTP id
 v10mr9565094ybd.71.1619225233273;
 Fri, 23 Apr 2021 17:47:13 -0700 (PDT)
Reply-To: Sean Christopherson <seanjc@google.com>
Date: Fri, 23 Apr 2021 17:46:08 -0700
In-Reply-To: <20210424004645.3950558-1-seanjc@google.com>
Message-Id: <20210424004645.3950558-7-seanjc@google.com>
Mime-Version: 1.0
References: <20210424004645.3950558-1-seanjc@google.com>
X-Mailer: git-send-email 2.31.1.498.g6c1eba8ee3d-goog
Subject: [PATCH 06/43] KVM: x86: Properly reset MMU context at vCPU RESET/INIT
From: Sean Christopherson <seanjc@google.com>
To: Paolo Bonzini <pbonzini@redhat.com>
Cc: Sean Christopherson <seanjc@google.com>,
        Vitaly Kuznetsov <vkuznets@redhat.com>,
        Wanpeng Li <wanpengli@tencent.com>,
        Jim Mattson <jmattson@google.com>,
        Joerg Roedel <joro@8bytes.org>, kvm@vger.kernel.org,
        linux-kernel@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

Post-process the CR0 and CR4 changes at vCPU INIT (and RESET for good
measure) to effect a MMU context reset when necessary.  Simply
re-initializing the current MMU is not sufficient as the current root
HPA may not be usable in the new context.  E.g. if TDP is disabled and
INIT arrives while the vCPU is in long mode, KVM will fail to switch to
the 32-bit pae_root and bomb on the next VM-Enter due to running with a
64-bit CR3 in 32-bit mode.

This bug was papered over in both VMX and SVM.

In VMX, the INIT issue is specific to running without unrestricted guest
since unrestricted guest is available if and only if EPT is enabled.
Commit 8668a3c468ed ("KVM: VMX: Reset mmu context when entering real
mode") resolved the issue by forcing a reset when entering emulated real
mode.

In SVM, commit ebae871a509d ("kvm: svm: reset mmu on VCPU reset") forced
a MMU reset on every INIT to workaround the flaw in common x86.  Note, at
the time the bug was fixed, the SVM problem was exacerbated by a complete
lack of a CR4 update.

The VMX and SVM fixes are not technically wrong, but lack of precision
makes it difficult to reason about why a context reset is needed.  The VMX
code in particular is nasty. The vendor resets will be reverted in future
patches, primarily to aid bisection in case there are non-INIT flows that
rely on the existing VMX logic.

Signed-off-by: Sean Christopherson <seanjc@google.com>
---
 arch/x86/kvm/x86.c | 8 +++++++-
 1 file changed, 7 insertions(+), 1 deletion(-)

diff --git a/arch/x86/kvm/x86.c b/arch/x86/kvm/x86.c
index 0bc783fc6c9b..b87193190a73 100644
--- a/arch/x86/kvm/x86.c
+++ b/arch/x86/kvm/x86.c
@@ -10341,7 +10341,6 @@ int kvm_arch_vcpu_create(struct kvm_vcpu *vcpu)
 	kvm_vcpu_mtrr_init(vcpu);
 	vcpu_load(vcpu);
 	kvm_vcpu_reset(vcpu, false);
-	kvm_init_mmu(vcpu, false);
 	vcpu_put(vcpu);
 	return 0;
 
@@ -10415,6 +10414,9 @@ void kvm_arch_vcpu_destroy(struct kvm_vcpu *vcpu)
 
 void kvm_vcpu_reset(struct kvm_vcpu *vcpu, bool init_event)
 {
+	unsigned long old_cr0 = kvm_read_cr0(vcpu);
+	unsigned long old_cr4 = kvm_read_cr4(vcpu);
+
 	kvm_lapic_reset(vcpu, init_event);
 
 	vcpu->arch.hflags = 0;
@@ -10483,6 +10485,10 @@ void kvm_vcpu_reset(struct kvm_vcpu *vcpu, bool init_event)
 	vcpu->arch.ia32_xss = 0;
 
 	static_call(kvm_x86_vcpu_reset)(vcpu, init_event);
+
+	if (kvm_cr0_mmu_role_changed(old_cr0, kvm_read_cr0(vcpu)) ||
+	    kvm_cr4_mmu_role_changed(old_cr4, kvm_read_cr4(vcpu)))
+		kvm_mmu_reset_context(vcpu);
 }
 
 void kvm_vcpu_deliver_sipi_vector(struct kvm_vcpu *vcpu, u8 vector)

From patchwork Sat Apr 24 00:46:09 2021
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
X-Patchwork-Submitter: Sean Christopherson <seanjc@google.com>
X-Patchwork-Id: 12222123
Return-Path: <kvm-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-26.3 required=3.0 tests=BAYES_00,DKIMWL_WL_MED,
	DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,
	INCLUDES_CR_TRAILER,INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,
	USER_AGENT_GIT,USER_IN_DEF_DKIM_WL autolearn=ham autolearn_force=no
	version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id E3EDEC433B4
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:47:52 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id B211361477
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:47:52 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S244337AbhDXAs2 (ORCPT <rfc822;kvm@archiver.kernel.org>);
        Fri, 23 Apr 2021 20:48:28 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:36814 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S244213AbhDXAr7 (ORCPT <rfc822;kvm@vger.kernel.org>);
        Fri, 23 Apr 2021 20:47:59 -0400
Received: from mail-qk1-x74a.google.com (mail-qk1-x74a.google.com
 [IPv6:2607:f8b0:4864:20::74a])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 2B818C061343
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:47:16 -0700 (PDT)
Received: by mail-qk1-x74a.google.com with SMTP id
 e4-20020a37b5040000b02902df9a0070efso15795583qkf.18
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:47:16 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=google.com; s=20161025;
        h=reply-to:date:in-reply-to:message-id:mime-version:references
         :subject:from:to:cc;
        bh=JB6oJJbZMgaQnz7sqxcoT6QpJu5P3mbAqjor0BPlckU=;
        b=gawyKmWHr60QBhm0KhMDBJy75XnqknCiP9RfJiC4WSxotL9fml3dncimBkNry5llXI
         GIUHw+eneBqfGoQuUCB2zKZIi4DIN6WjCg78tl7wxvozV/T/ynHsjonDfy5HmUkIpK5p
         Lemt/VPEUSJPXemM8qGHsVc7oTmx3EEbNpXkLltre8r3sxcPi1UnI0IJMHjILIQIEcDd
         w9rp7c/auaOIc9xejwFwnQRk44gB4hJovUgyIgZUlojAXd7sptVvFsgkIw/cZ/+/bvZN
         liEAQakKftCs3ilzhXSrJ7ipScs+kvm+FWY5ondZxDCqvBlsjJ4xzdNvgGiN7kKZObN4
         Nq3A==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:reply-to:date:in-reply-to:message-id
         :mime-version:references:subject:from:to:cc;
        bh=JB6oJJbZMgaQnz7sqxcoT6QpJu5P3mbAqjor0BPlckU=;
        b=BCRhZZXio661YF/0rGvQgaWHa4HN39oL/Dq9IGbaggcSRSOHrAc0qNgYEl5TpUXy+N
         xsMhRBFOcc1M/b2YM+BrY9FtB/qMGe2A3X2Zm5fWZ10fR8tuVTDgLHc7Zx5Ss4T9s+pT
         CxJUTxK/BphdNwfzd2886U5HO1pMrjr0qLU4YsPfobyAVPCkyBT+u08RSy+WE+hpK6GK
         0pb3RSuOHB4zvdA5ZM4hY9CEgC1GzbGmbdBBqD9NzZXLFmFPi8Z8jzUzDfJQ/4pCvRF8
         lueww5OgEu+ru2GdW5iCdcKQ9diSP5Y0ykChZfJ5Jb8TLnjvIxHz+DaLipII8igrimA9
         Yx2g==
X-Gm-Message-State: AOAM532VNh6RsqRBpXVTpu7GKCgn03rQDNc2zwr6XvNxqgoDA4KTvs7W
        7swsa0q/blpIhEkYbL+SBbjTlHQP2TY=
X-Google-Smtp-Source: 
 ABdhPJylGy/lLogptAm0ek+Ns5KvivhCMZAXT84Fhul4D9tz+Lpeo/wX0Iaqw3kuo7eVq38Tn/AfvbaHqmQ=
X-Received: from seanjc798194.pdx.corp.google.com
 ([2620:15c:f:10:ad52:3246:e190:f070])
 (user=seanjc job=sendgmr) by 2002:a05:6214:3eb:: with SMTP id
 cf11mr7365067qvb.37.1619225235338; Fri, 23 Apr 2021 17:47:15 -0700 (PDT)
Reply-To: Sean Christopherson <seanjc@google.com>
Date: Fri, 23 Apr 2021 17:46:09 -0700
In-Reply-To: <20210424004645.3950558-1-seanjc@google.com>
Message-Id: <20210424004645.3950558-8-seanjc@google.com>
Mime-Version: 1.0
References: <20210424004645.3950558-1-seanjc@google.com>
X-Mailer: git-send-email 2.31.1.498.g6c1eba8ee3d-goog
Subject: [PATCH 07/43] KVM: VMX: Remove explicit MMU reset in enter_rmode()
From: Sean Christopherson <seanjc@google.com>
To: Paolo Bonzini <pbonzini@redhat.com>
Cc: Sean Christopherson <seanjc@google.com>,
        Vitaly Kuznetsov <vkuznets@redhat.com>,
        Wanpeng Li <wanpengli@tencent.com>,
        Jim Mattson <jmattson@google.com>,
        Joerg Roedel <joro@8bytes.org>, kvm@vger.kernel.org,
        linux-kernel@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

Drop an explicit MMU reset when entering emulated real mode now that the
vCPU INIT/RESET path correctly handles conditional MMU resets, e.g. if
INIT arrives while the vCPU is in 64-bit mode.

Note, while there are multiple other direct calls to vmx_set_cr0(), i.e.
paths that change CR0 without invoking kvm_post_set_cr0(), only the INIT
emulation can reach enter_rmode().  CLTS emulation only toggles CR.TS,
VM-Exit (and late VM-Fail) emulation cannot architecturally transition to
Real Mode, and VM-Enter to Real Mode is possible if and only if
Unrestricted Guest is enabled (exposed to L1).

This effectively reverts commit 8668a3c468ed ("KVM: VMX: Reset mmu
context when entering real mode")

Signed-off-by: Sean Christopherson <seanjc@google.com>
---
 arch/x86/kvm/vmx/vmx.c | 2 --
 1 file changed, 2 deletions(-)

diff --git a/arch/x86/kvm/vmx/vmx.c b/arch/x86/kvm/vmx/vmx.c
index 9c00d013af59..e90952ca6087 100644
--- a/arch/x86/kvm/vmx/vmx.c
+++ b/arch/x86/kvm/vmx/vmx.c
@@ -2960,8 +2960,6 @@ static void enter_rmode(struct kvm_vcpu *vcpu)
 	fix_rmode_seg(VCPU_SREG_DS, &vmx->rmode.segs[VCPU_SREG_DS]);
 	fix_rmode_seg(VCPU_SREG_GS, &vmx->rmode.segs[VCPU_SREG_GS]);
 	fix_rmode_seg(VCPU_SREG_FS, &vmx->rmode.segs[VCPU_SREG_FS]);
-
-	kvm_mmu_reset_context(vcpu);
 }
 
 int vmx_set_efer(struct kvm_vcpu *vcpu, u64 efer)

From patchwork Sat Apr 24 00:46:10 2021
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
X-Patchwork-Submitter: Sean Christopherson <seanjc@google.com>
X-Patchwork-Id: 12222125
Return-Path: <kvm-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-26.3 required=3.0 tests=BAYES_00,DKIMWL_WL_MED,
	DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,
	INCLUDES_CR_TRAILER,INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,
	USER_AGENT_GIT,USER_IN_DEF_DKIM_WL autolearn=ham autolearn_force=no
	version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id A84D8C433B4
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:48:04 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 817C961465
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:48:04 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S244359AbhDXAsh (ORCPT <rfc822;kvm@archiver.kernel.org>);
        Fri, 23 Apr 2021 20:48:37 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:36828 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S244173AbhDXAsB (ORCPT <rfc822;kvm@vger.kernel.org>);
        Fri, 23 Apr 2021 20:48:01 -0400
Received: from mail-yb1-xb4a.google.com (mail-yb1-xb4a.google.com
 [IPv6:2607:f8b0:4864:20::b4a])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 66D11C061346
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:47:18 -0700 (PDT)
Received: by mail-yb1-xb4a.google.com with SMTP id
 n129-20020a2527870000b02904ed02e1aab5so14639571ybn.21
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:47:18 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=google.com; s=20161025;
        h=reply-to:date:in-reply-to:message-id:mime-version:references
         :subject:from:to:cc;
        bh=Jt+QADH41QWXYhePdcqYrOCInHjfAIgUcTFitJT85II=;
        b=VKCD32tNE1gQlT8ZBHmOFQRMkonRpIDU2w8ZcZmMWG/7LY6e4AiT3pguQltFHx+cnZ
         Q1K5jdZDD7ObiUHwqs3LK8yW6Lm8azAWM8On3E0EOePkJjeVIpQbzl2NYdOA5DtnD0uE
         /tJeuBOOcMgrXvAXgj70Gx2Raox3rxVrhxzxWGsTAydHbW/6kYjdTuiuVSQIZHDBcG7c
         AOHXWD+1aSRrWePdu/il24DPE9Vd7L+uPsF+KwVKzddyZzCGn6HO8wm66J0kx3dIBVHX
         Y3KTVdZKSBede+UunwTlNnFwh9QSaXzNjWKYCayzmuVdBWs22HkiQ5fltixxunX2zl7w
         Zy7Q==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:reply-to:date:in-reply-to:message-id
         :mime-version:references:subject:from:to:cc;
        bh=Jt+QADH41QWXYhePdcqYrOCInHjfAIgUcTFitJT85II=;
        b=ZeJ0dNZE4y/hXkNUsPgFimK3JiPrghmnwfgngO/SqGERM1hAjm39LoQW8TILXC3ZEE
         XZTQxJX7m2CiH1ZAAosxH9fZvLI34edTpLnoqwb4WyMy0Odd3Je+wqx//VUXTcK1DT9u
         kParI7jSmKywkSgbFL7FUtuXcPfz5Ugd3ZcVr3cgf4cs4GH2v3EB2A21yTIn0snIMEDT
         1EHCK0mu383VcUsqRIJYxUC9C/S/C0Sy3Ur4zyamDuLYoleGbW9k3eHPqsXaOf13eOg/
         JyNI7tnpvHtTnn2wqdIPZXJ839FVjkHXZ/1P3HiX9IiiyRJvNnT4ezpOsFnLChFmiMnB
         6MNg==
X-Gm-Message-State: AOAM5322eafN/jQB8YBB2qve3k46dpkSZSQ620YUG0zIZ6hSbAKGnGbS
        sQ/e0BffPWEmdqQBiEbRK1QyH0DxAOI=
X-Google-Smtp-Source: 
 ABdhPJwcTnmC6X0oWuujcgYVmlJxsbfvu4nwR2aDmxuh3bzRd3SWRELPe0JgJ/qSwHhiHda4+AZA0+IYfiQ=
X-Received: from seanjc798194.pdx.corp.google.com
 ([2620:15c:f:10:ad52:3246:e190:f070])
 (user=seanjc job=sendgmr) by 2002:a25:6f85:: with SMTP id
 k127mr10032078ybc.270.1619225237656;
 Fri, 23 Apr 2021 17:47:17 -0700 (PDT)
Reply-To: Sean Christopherson <seanjc@google.com>
Date: Fri, 23 Apr 2021 17:46:10 -0700
In-Reply-To: <20210424004645.3950558-1-seanjc@google.com>
Message-Id: <20210424004645.3950558-9-seanjc@google.com>
Mime-Version: 1.0
References: <20210424004645.3950558-1-seanjc@google.com>
X-Mailer: git-send-email 2.31.1.498.g6c1eba8ee3d-goog
Subject: [PATCH 08/43] KVM: SVM: Drop explicit MMU reset at RESET/INIT
From: Sean Christopherson <seanjc@google.com>
To: Paolo Bonzini <pbonzini@redhat.com>
Cc: Sean Christopherson <seanjc@google.com>,
        Vitaly Kuznetsov <vkuznets@redhat.com>,
        Wanpeng Li <wanpengli@tencent.com>,
        Jim Mattson <jmattson@google.com>,
        Joerg Roedel <joro@8bytes.org>, kvm@vger.kernel.org,
        linux-kernel@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

Drop an explicit MMU reset in SVM's vCPU RESET/INIT flow now that the
common x86 path correctly handles conditional MMU resets, e.g. if INIT
arrives while the vCPU is in 64-bit mode.

This reverts commit ebae871a509d ("kvm: svm: reset mmu on VCPU reset").

Signed-off-by: Sean Christopherson <seanjc@google.com>
---
 arch/x86/kvm/svm/svm.c | 1 -
 1 file changed, 1 deletion(-)

diff --git a/arch/x86/kvm/svm/svm.c b/arch/x86/kvm/svm/svm.c
index d4d7720ce42f..fbea2f45de9a 100644
--- a/arch/x86/kvm/svm/svm.c
+++ b/arch/x86/kvm/svm/svm.c
@@ -1216,7 +1216,6 @@ static void init_vmcb(struct kvm_vcpu *vcpu)
 	 * It also updates the guest-visible cr0 value.
 	 */
 	svm_set_cr0(vcpu, X86_CR0_NW | X86_CR0_CD | X86_CR0_ET);
-	kvm_mmu_reset_context(vcpu);
 
 	save->cr4 = X86_CR4_PAE;
 

From patchwork Sat Apr 24 00:46:11 2021
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
X-Patchwork-Submitter: Sean Christopherson <seanjc@google.com>
X-Patchwork-Id: 12222129
Return-Path: <kvm-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-26.3 required=3.0 tests=BAYES_00,DKIMWL_WL_MED,
	DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,
	INCLUDES_CR_TRAILER,INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,
	USER_AGENT_GIT,USER_IN_DEF_DKIM_WL autolearn=unavailable autolearn_force=no
	version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 0930CC433ED
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:48:29 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id D0CC96144A
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:48:28 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S244408AbhDXAtD (ORCPT <rfc822;kvm@archiver.kernel.org>);
        Fri, 23 Apr 2021 20:49:03 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:36798 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S244287AbhDXAsQ (ORCPT <rfc822;kvm@vger.kernel.org>);
        Fri, 23 Apr 2021 20:48:16 -0400
Received: from mail-yb1-xb49.google.com (mail-yb1-xb49.google.com
 [IPv6:2607:f8b0:4864:20::b49])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 927A9C061348
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:47:20 -0700 (PDT)
Received: by mail-yb1-xb49.google.com with SMTP id
 e65-20020a25e7440000b02904ecfeff1ed8so14909037ybh.19
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:47:20 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=google.com; s=20161025;
        h=reply-to:date:in-reply-to:message-id:mime-version:references
         :subject:from:to:cc;
        bh=H46lT8DkG1h570Zv+xu7UsGwwPn89nRKlivzLO/8BXo=;
        b=owrm6gGDzwQ7FwWNwHfNIhmy9Lqo8phxgwqD6ABoLD/cJGiyhu67gPfYzx0aSg+8KF
         tVdZy/nzRqIfcXY4br9XBeoi78tHRe3ubmjQT59+rK0iYKK4LkR1s244D39i+m91gT8u
         f+sumHioWtfft0u9tpTeh6BWiOzfc1hhyPvnA7V357DF5/1Gnfj1wq1OVqzA6AsSLa1r
         mqM1r+FWCGacwM+kT0PDIzDlcmmbN6JPXkDJ8FOoEmv3182DZfKtdhhTXdYkKqIfF5+8
         guepsKVT6MArtV8J1s+UvpX+oUhkOMM3Pgp/mi4ozsj3IsviwkeKfdxzB/SjoAP54D0y
         YP2g==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:reply-to:date:in-reply-to:message-id
         :mime-version:references:subject:from:to:cc;
        bh=H46lT8DkG1h570Zv+xu7UsGwwPn89nRKlivzLO/8BXo=;
        b=I6cFARQ+dQoEU/6y8ongNmNwW8MzUXuajiRTVSkARx8yXEDtAojXncXi+REclOz3Rs
         PQOdgzXP8Zq04oQ7ohqOrXmSCCyY8BaPTpC7wcfr9CuNclL+d+xiHdRQ9PS1DlOOIr/G
         D/YMPUtTgrm7D0TMplJBMg5n9gdAQ+J2EWo+mz3RYkeoOV1VnJfviq3qaN9FnbYSrff3
         2qL7wNK35Z5fLg/uktb6dl/GAF6wuKrtzJNKo12cVef8kPoxSKWSjPtU51edNbyz1U5x
         qyZh7q+z+WXOLFRYKEr7MGq+G7F0JHsGZ/ctx+JoCxxgykrzwqUfQJBpuRTZ9rBWKhe8
         Et1w==
X-Gm-Message-State: AOAM530zycB5SGfWYKGBVF3Y5BOm4bC0EpzR/9RycaxgJO9i5HwfZVUX
        0P1AhBRtPHU7D4D23mkRb+pQC2uXQD8=
X-Google-Smtp-Source: 
 ABdhPJxh0IUsb0ZRQ30lwpzDVONjxt/W1mIo+x+7drFrxe04MX4a5WLKSNARh2B34kk5H7MeCvQ4lxn71ec=
X-Received: from seanjc798194.pdx.corp.google.com
 ([2620:15c:f:10:ad52:3246:e190:f070])
 (user=seanjc job=sendgmr) by 2002:a25:ab53:: with SMTP id
 u77mr9566083ybi.48.1619225239877;
 Fri, 23 Apr 2021 17:47:19 -0700 (PDT)
Reply-To: Sean Christopherson <seanjc@google.com>
Date: Fri, 23 Apr 2021 17:46:11 -0700
In-Reply-To: <20210424004645.3950558-1-seanjc@google.com>
Message-Id: <20210424004645.3950558-10-seanjc@google.com>
Mime-Version: 1.0
References: <20210424004645.3950558-1-seanjc@google.com>
X-Mailer: git-send-email 2.31.1.498.g6c1eba8ee3d-goog
Subject: [PATCH 09/43] KVM: SVM: Drop a redundant init_vmcb() from
 svm_create_vcpu()
From: Sean Christopherson <seanjc@google.com>
To: Paolo Bonzini <pbonzini@redhat.com>
Cc: Sean Christopherson <seanjc@google.com>,
        Vitaly Kuznetsov <vkuznets@redhat.com>,
        Wanpeng Li <wanpengli@tencent.com>,
        Jim Mattson <jmattson@google.com>,
        Joerg Roedel <joro@8bytes.org>, kvm@vger.kernel.org,
        linux-kernel@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

Drop an extra init_vmcb() from svm_create_vcpu(), svm_vcpu_reset() is
guaranteed to call init_vmcb() and there are no consumers of the VMCB
data between ->vcpu_create() and ->vcpu_reset().  Keep the call to
svm_switch_vmcb() as sev_es_create_vcpu() touches the current VMCB, but
hoist it up a few lines to associate the switch with the allocation of
vmcb01.

Signed-off-by: Sean Christopherson <seanjc@google.com>
---
 arch/x86/kvm/svm/svm.c | 4 +---
 1 file changed, 1 insertion(+), 3 deletions(-)

diff --git a/arch/x86/kvm/svm/svm.c b/arch/x86/kvm/svm/svm.c
index fbea2f45de9a..6c73ea3d20c6 100644
--- a/arch/x86/kvm/svm/svm.c
+++ b/arch/x86/kvm/svm/svm.c
@@ -1371,15 +1371,13 @@ static int svm_create_vcpu(struct kvm_vcpu *vcpu)
 
 	svm->vmcb01.ptr = page_address(vmcb01_page);
 	svm->vmcb01.pa = __sme_set(page_to_pfn(vmcb01_page) << PAGE_SHIFT);
+	svm_switch_vmcb(svm, &svm->vmcb01);
 
 	if (vmsa_page)
 		svm->vmsa = page_address(vmsa_page);
 
 	svm->guest_state_loaded = false;
 
-	svm_switch_vmcb(svm, &svm->vmcb01);
-	init_vmcb(vcpu);
-
 	svm_init_osvw(vcpu);
 	vcpu->arch.microcode_version = 0x01000065;
 

From patchwork Sat Apr 24 00:46:12 2021
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
X-Patchwork-Submitter: Sean Christopherson <seanjc@google.com>
X-Patchwork-Id: 12222127
Return-Path: <kvm-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-26.3 required=3.0 tests=BAYES_00,DKIMWL_WL_MED,
	DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,
	INCLUDES_CR_TRAILER,INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,
	USER_AGENT_GIT,USER_IN_DEF_DKIM_WL autolearn=ham autolearn_force=no
	version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 64718C433B4
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:48:25 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 349B56128A
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:48:25 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S235947AbhDXAs4 (ORCPT <rfc822;kvm@archiver.kernel.org>);
        Fri, 23 Apr 2021 20:48:56 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:36880 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S244286AbhDXAsP (ORCPT <rfc822;kvm@vger.kernel.org>);
        Fri, 23 Apr 2021 20:48:15 -0400
Received: from mail-yb1-xb4a.google.com (mail-yb1-xb4a.google.com
 [IPv6:2607:f8b0:4864:20::b4a])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id E323AC061574
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:47:22 -0700 (PDT)
Received: by mail-yb1-xb4a.google.com with SMTP id
 p9-20020a2574090000b02904e2cb6a90e7so26400657ybc.17
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:47:22 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=google.com; s=20161025;
        h=reply-to:date:in-reply-to:message-id:mime-version:references
         :subject:from:to:cc;
        bh=8lM2E0jJiBC1VTmkEjEGfcPNw32U+DRkCC8iMe7vR7g=;
        b=fRnpEjwEWFFWgQyiODGaPJYvV9lGJtlFOFWquX9veLOfyDjX4Ju1bx95sXoo3aW+H8
         XUNnnwv+t993ylG6HdqfPFSpp6UekjvlRSb7nu/xuJr9D8y52SYLKUW6UnvPV2jzsEm+
         49SUHn3vdm1B1shrMRA+Ezvn6rnlysIEisI7/e9B6Rx/USc2+h9wO/ni3pN5QVeJ4Lzj
         9JFDU94eJF9lXKUH4+7bOohj73mCMkNSlk7vZSZdwtBbvK7eazc1MAZzBY+XLpXCL89D
         Bi8tgZu/dAjP3bF3plexU0WYT1zvAlFOw8nwDR0Bh83qiAM8jqG0QzuX9t3ergoWlSzu
         nw5A==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:reply-to:date:in-reply-to:message-id
         :mime-version:references:subject:from:to:cc;
        bh=8lM2E0jJiBC1VTmkEjEGfcPNw32U+DRkCC8iMe7vR7g=;
        b=PjM3nTCUiovtVud5Pure1kOSHWAXW75usm7MJFARNMPy/tFyXvbMaDOfF5hFme4kRU
         47jUPpA6uV4KxpzJmugjuhnoLH09LadW3VXCd2Hi4nPIxGa6en3NJx1N3nyK3GMio824
         TdTlm5CChXJB6l4AfrCK/eHka9OWfaDuWDMmZIGzTqrNRFFpIz0UdAsNlYw8L6tsXQ36
         YEh4XMFaOxyi7Bt3HZVHpOAdfplEU6uno+93qfu4lkF+EptplLS6kXeZhPJ0KeFFi5DT
         1TFVgMdGf1ziiFycDCPxswA2EmvEYe58lb8kIRZCV4s/OLr6pfOtgMwYMGr2feA4KHbJ
         bp3A==
X-Gm-Message-State: AOAM530TpEeGi+0XIFnBSJiu5mHLOESUs46Onni446d106gSa3JmNpRs
        htni7Q3lfmXcmntfnf6ht1QDnb1cXnU=
X-Google-Smtp-Source: 
 ABdhPJxyqz775QrFZEuQlFzBtSWNWtfMgqlruqGMlkDNvkgBDonOUZXac7QUX41PiYq4W2N34cpGnA1CFJQ=
X-Received: from seanjc798194.pdx.corp.google.com
 ([2620:15c:f:10:ad52:3246:e190:f070])
 (user=seanjc job=sendgmr) by 2002:a25:8884:: with SMTP id
 d4mr9544198ybl.410.1619225242226;
 Fri, 23 Apr 2021 17:47:22 -0700 (PDT)
Reply-To: Sean Christopherson <seanjc@google.com>
Date: Fri, 23 Apr 2021 17:46:12 -0700
In-Reply-To: <20210424004645.3950558-1-seanjc@google.com>
Message-Id: <20210424004645.3950558-11-seanjc@google.com>
Mime-Version: 1.0
References: <20210424004645.3950558-1-seanjc@google.com>
X-Mailer: git-send-email 2.31.1.498.g6c1eba8ee3d-goog
Subject: [PATCH 10/43] KVM: VMX: Move init_vmcs() invocation to
 vmx_vcpu_reset()
From: Sean Christopherson <seanjc@google.com>
To: Paolo Bonzini <pbonzini@redhat.com>
Cc: Sean Christopherson <seanjc@google.com>,
        Vitaly Kuznetsov <vkuznets@redhat.com>,
        Wanpeng Li <wanpengli@tencent.com>,
        Jim Mattson <jmattson@google.com>,
        Joerg Roedel <joro@8bytes.org>, kvm@vger.kernel.org,
        linux-kernel@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

Initialize constant VMCS state in vcpu_vcpu_reset() instead of in
vmx_vcpu_create(), which allows for the removal of the open coded "vCPU
load" sequence since ->vcpu_reset() is invoked while the vCPU is properly
loaded (which is the entire point of vCPU reset...).

Deferring initialization is effectively a nop as it's impossible to
safely access the VMCS between the current call site and its new home, as
both the vCPU and the pCPU are put immediately after init_vmcs(), i.e.
the VMCS isn't guaranteed to be loaded.

Note, task preemption is not a problem as vmx_sched_in() _can't_ touch
the VMCS as ->sched_in() is invoked before the vCPU, and thus VMCS, is
reloaded.  I.e. the preemption path also can't consume VMCS state.

Signed-off-by: Sean Christopherson <seanjc@google.com>
---
 arch/x86/kvm/vmx/vmx.c | 16 +++++-----------
 1 file changed, 5 insertions(+), 11 deletions(-)

diff --git a/arch/x86/kvm/vmx/vmx.c b/arch/x86/kvm/vmx/vmx.c
index e90952ca6087..856aa44b17d5 100644
--- a/arch/x86/kvm/vmx/vmx.c
+++ b/arch/x86/kvm/vmx/vmx.c
@@ -4396,10 +4396,6 @@ static void vmx_compute_secondary_exec_control(struct vcpu_vmx *vmx)
 
 #define VMX_XSS_EXIT_BITMAP 0
 
-/*
- * Noting that the initialization of Guest-state Area of VMCS is in
- * vmx_vcpu_reset().
- */
 static void init_vmcs(struct vcpu_vmx *vmx)
 {
 	if (nested)
@@ -4498,6 +4494,9 @@ static void vmx_vcpu_reset(struct kvm_vcpu *vcpu, bool init_event)
 	u32 eax, dummy;
 	u64 cr0;
 
+	if (!init_event)
+		init_vmcs(vmx);
+
 	vmx->rmode.vm86_active = 0;
 	vmx->spec_ctrl = 0;
 
@@ -6905,7 +6904,7 @@ static void vmx_free_vcpu(struct kvm_vcpu *vcpu)
 static int vmx_create_vcpu(struct kvm_vcpu *vcpu)
 {
 	struct vcpu_vmx *vmx;
-	int i, cpu, err;
+	int i, err;
 
 	BUILD_BUG_ON(offsetof(struct vcpu_vmx, vcpu) != 0);
 	vmx = to_vmx(vcpu);
@@ -6991,12 +6990,7 @@ static int vmx_create_vcpu(struct kvm_vcpu *vcpu)
 	vmx->msr_bitmap_mode = 0;
 
 	vmx->loaded_vmcs = &vmx->vmcs01;
-	cpu = get_cpu();
-	vmx_vcpu_load(vcpu, cpu);
-	vcpu->cpu = cpu;
-	init_vmcs(vmx);
-	vmx_vcpu_put(vcpu);
-	put_cpu();
+
 	if (cpu_need_virtualize_apic_accesses(vcpu)) {
 		err = alloc_apic_access_page(vcpu->kvm);
 		if (err)

From patchwork Sat Apr 24 00:46:13 2021
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
X-Patchwork-Submitter: Sean Christopherson <seanjc@google.com>
X-Patchwork-Id: 12222131
Return-Path: <kvm-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-26.3 required=3.0 tests=BAYES_00,DKIMWL_WL_MED,
	DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,
	INCLUDES_CR_TRAILER,INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,
	USER_AGENT_GIT,USER_IN_DEF_DKIM_WL autolearn=unavailable autolearn_force=no
	version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 27F0AC433ED
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:49:19 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id E9A116144A
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:49:18 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S244493AbhDXAtv (ORCPT <rfc822;kvm@archiver.kernel.org>);
        Fri, 23 Apr 2021 20:49:51 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:36808 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S244327AbhDXAs1 (ORCPT <rfc822;kvm@vger.kernel.org>);
        Fri, 23 Apr 2021 20:48:27 -0400
Received: from mail-yb1-xb49.google.com (mail-yb1-xb49.google.com
 [IPv6:2607:f8b0:4864:20::b49])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 3A3D4C06175F
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:47:25 -0700 (PDT)
Received: by mail-yb1-xb49.google.com with SMTP id
 a7-20020a5b00070000b02904ed415d9d84so4615758ybp.0
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:47:25 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=google.com; s=20161025;
        h=reply-to:date:in-reply-to:message-id:mime-version:references
         :subject:from:to:cc;
        bh=bZhFtNS6H4/qf4I8RWVJ2+WzcwhJXicC5JMUikKYnuU=;
        b=jFVVaBFZMcDYN7hb4egS1sUaS6IMOo7muvsB5U4vo0ARzbvBBEorLBvCAW/At38u6N
         Rox4cksEOHGe8nBD7fxsO0TK8JrEKwIAs8aXMT8hBdvkFrAYUzU6t3o0aHlhxTtPTkp7
         oABbrSeMftw785UuunwjeGx+eg8khpZDWI0R7gjLo5wJrSaZisYbZWub76DXwmSPHRCC
         Plnmt9gApth3A0lCrYWwctC6MSLbbYhsr+wWcHaM/oEeomqvRncWFvhpVLQNYufxO8tv
         NyTWauJC27FU95S6wBSZIYW6+vDBi59LSChLyQ6GBt/6CHl4MfiGw2UOltARSlRxSbdq
         SZKg==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:reply-to:date:in-reply-to:message-id
         :mime-version:references:subject:from:to:cc;
        bh=bZhFtNS6H4/qf4I8RWVJ2+WzcwhJXicC5JMUikKYnuU=;
        b=r6rdCZl6FD4f6rzY6z7/I+HWCo7bogr8+F/yWPyhGOwA734zgHI//cRcPxiX1Zs9of
         E9RQeZ95ytQBijTC+N5Ct1xkeFqtmayPxfkStUs9yKFkvJmzdknV4M58ZW37t46T+SBj
         0o2x8n/6jCPpTTvwdo3K6QSyWKtW4HbyY/gZJaotl/Y+qIhWCKWComyv7Ti582N3G7oM
         cZQuPUkXVUg8Elz0a4kF7dh2T1QWAa8RqYIirgylTPPnPcmopOT2gBSZnLU0p4P0kESp
         eaYaNl27ZdoCvM7SLHPv1yp96Nfhe7pP2/TlI1sTIcyFA15XvuyFB3bS9tAy7+USgjTh
         GISQ==
X-Gm-Message-State: AOAM532eZgPCMNx7JiGdHFJG06LP6yTQPJYtGUw3jWDAX3JeXUQK1Wnr
        LXtWB6EseAkNfOLWme8IC67rRLhoAb4=
X-Google-Smtp-Source: 
 ABdhPJzW7SSyk1RpTzdj7JWWqLsRpSIgopTP0PSz261q7zhylYUyaXFATUOLvvXvDD5ESYWQsrYl4ze9zeg=
X-Received: from seanjc798194.pdx.corp.google.com
 ([2620:15c:f:10:ad52:3246:e190:f070])
 (user=seanjc job=sendgmr) by 2002:a25:ba83:: with SMTP id
 s3mr9551305ybg.280.1619225244508;
 Fri, 23 Apr 2021 17:47:24 -0700 (PDT)
Reply-To: Sean Christopherson <seanjc@google.com>
Date: Fri, 23 Apr 2021 17:46:13 -0700
In-Reply-To: <20210424004645.3950558-1-seanjc@google.com>
Message-Id: <20210424004645.3950558-12-seanjc@google.com>
Mime-Version: 1.0
References: <20210424004645.3950558-1-seanjc@google.com>
X-Mailer: git-send-email 2.31.1.498.g6c1eba8ee3d-goog
Subject: [PATCH 11/43] KVM: x86: WARN if the APIC map is dirty without an
 in-kernel local APIC
From: Sean Christopherson <seanjc@google.com>
To: Paolo Bonzini <pbonzini@redhat.com>
Cc: Sean Christopherson <seanjc@google.com>,
        Vitaly Kuznetsov <vkuznets@redhat.com>,
        Wanpeng Li <wanpengli@tencent.com>,
        Jim Mattson <jmattson@google.com>,
        Joerg Roedel <joro@8bytes.org>, kvm@vger.kernel.org,
        linux-kernel@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

WARN if KVM ends up in a state where it thinks its APIC map needs to be
recalculated, but KVM is not emulating the local APIC.  This is mostly
to document KVM's "rules" in order to provide clarity in future cleanups.

Signed-off-by: Sean Christopherson <seanjc@google.com>
---
 arch/x86/kvm/lapic.c | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/arch/x86/kvm/lapic.c b/arch/x86/kvm/lapic.c
index 152591f9243a..655eb1d07344 100644
--- a/arch/x86/kvm/lapic.c
+++ b/arch/x86/kvm/lapic.c
@@ -192,6 +192,9 @@ void kvm_recalculate_apic_map(struct kvm *kvm)
 	if (atomic_read_acquire(&kvm->arch.apic_map_dirty) == CLEAN)
 		return;
 
+	WARN_ONCE(!irqchip_in_kernel(kvm),
+		  "Dirty APIC map without an in-kernel local APIC");
+
 	mutex_lock(&kvm->arch.apic_map_lock);
 	/*
 	 * Read kvm->arch.apic_map_dirty before kvm->arch.apic_map

From patchwork Sat Apr 24 00:46:14 2021
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
X-Patchwork-Submitter: Sean Christopherson <seanjc@google.com>
X-Patchwork-Id: 12222133
Return-Path: <kvm-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-26.3 required=3.0 tests=BAYES_00,DKIMWL_WL_MED,
	DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,
	INCLUDES_CR_TRAILER,INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,
	USER_AGENT_GIT,USER_IN_DEF_DKIM_WL autolearn=unavailable autolearn_force=no
	version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id D15D9C433B4
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:49:25 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 92BE661465
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:49:25 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S244209AbhDXAt5 (ORCPT <rfc822;kvm@archiver.kernel.org>);
        Fri, 23 Apr 2021 20:49:57 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:36928 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S244330AbhDXAs1 (ORCPT <rfc822;kvm@vger.kernel.org>);
        Fri, 23 Apr 2021 20:48:27 -0400
Received: from mail-qt1-x84a.google.com (mail-qt1-x84a.google.com
 [IPv6:2607:f8b0:4864:20::84a])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 73FE8C06134A
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:47:27 -0700 (PDT)
Received: by mail-qt1-x84a.google.com with SMTP id
 x13-20020ac84d4d0000b02901a95d7c4bb5so18629458qtv.14
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:47:27 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=google.com; s=20161025;
        h=reply-to:date:in-reply-to:message-id:mime-version:references
         :subject:from:to:cc;
        bh=nJ0Vx6GbmijZ7PDR3hwIYLOvt4K+KdVv1iVkzVPrEHQ=;
        b=CHIwF6Upat5nEcmPw+p2goGG9yaxiZOo90wW5j+8Ba6nIAr/qCVhZjxVzBatY501fR
         eV5lT1JFrSyfjrhrfANk8BrRdSZ7U6BmPXGHRFpY2dF/AmqrRf+73RYscgZ5s2Hb2Ev0
         y3hm3xcNsxFKAHYTkjDIceYwbdND7SkIwvU4s+RsLvNxG7NzeoYNc6KyMnObn96yaKPW
         +6pBQA7hpeshb4tY5GN+CgmVw6UUni99Ou+1XR6kYBsGrjEA1x0EWTi48+Z+fd37bA6+
         Xi9pdfp9oVXpyc1g0PUqzF7plNbRkQ7AoRRWB0Pxj59OvWTEabRdBw4AyHl/Mi76w56y
         l3hw==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:reply-to:date:in-reply-to:message-id
         :mime-version:references:subject:from:to:cc;
        bh=nJ0Vx6GbmijZ7PDR3hwIYLOvt4K+KdVv1iVkzVPrEHQ=;
        b=fSHzEiPZUG9NZvJtSijvkTzJRE+avf2SnSWbznvvRwb7aNc6B/Yc1oBGMdXukYAfBD
         D7kHW952w6E0xD+huDrlBGDRGhOFWUMdv1vV82aoh4YLUbEYebVo+eWN19NJXpBGLQcs
         pryfpJ5oW4qyP4Qs9R23bRvgI+1WmyFE2+r0CcEDygnzZahH7Nh5eLVy249PABowaJbO
         yZXO4/hg3nHprl11IKq5fL88I8ueMhxf48SpKXwgNweVGrYHzP2dW1rMG2clu+RA2EmK
         9mZZxj6lb06151HDuIE/yzYTD3CuPKvegDks8Wtl4b53zqkdTwHORpKtTKkCKmaabSym
         x8Ug==
X-Gm-Message-State: AOAM533ui7LroWGee7IJmSJq5VuQMYvSL1h4KvDigu2NiABoM9kLki1L
        V6237mb8olSt0geSQqOMoOKgLzTnl1E=
X-Google-Smtp-Source: 
 ABdhPJzE1UuuDxgXT49WcOpqRxfDihcDQIPaRpjw5EuExsxUh27ZmE1uejEh1Sue2I20i856RBEu6FSYlJU=
X-Received: from seanjc798194.pdx.corp.google.com
 ([2620:15c:f:10:ad52:3246:e190:f070])
 (user=seanjc job=sendgmr) by 2002:a0c:db05:: with SMTP id
 d5mr7191402qvk.41.1619225246707;
 Fri, 23 Apr 2021 17:47:26 -0700 (PDT)
Reply-To: Sean Christopherson <seanjc@google.com>
Date: Fri, 23 Apr 2021 17:46:14 -0700
In-Reply-To: <20210424004645.3950558-1-seanjc@google.com>
Message-Id: <20210424004645.3950558-13-seanjc@google.com>
Mime-Version: 1.0
References: <20210424004645.3950558-1-seanjc@google.com>
X-Mailer: git-send-email 2.31.1.498.g6c1eba8ee3d-goog
Subject: [PATCH 12/43] KVM: x86: Remove defunct BSP "update" in local APIC
 reset
From: Sean Christopherson <seanjc@google.com>
To: Paolo Bonzini <pbonzini@redhat.com>
Cc: Sean Christopherson <seanjc@google.com>,
        Vitaly Kuznetsov <vkuznets@redhat.com>,
        Wanpeng Li <wanpengli@tencent.com>,
        Jim Mattson <jmattson@google.com>,
        Joerg Roedel <joro@8bytes.org>, kvm@vger.kernel.org,
        linux-kernel@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

Remove a BSP APIC update in kvm_lapic_reset() that is a glorified and
confusing nop.  When the code was originally added, kvm_vcpu_is_bsp()
queried kvm->arch.bsp_vcpu, i.e. the intent was to set the BSP bit in the
BSP vCPU's APIC.  But, stuffing the BSP bit at INIT was wrong since the
guest can change its BSP(s); this was fixed by commit 58d269d8cccc ("KVM:
x86: BSP in MSR_IA32_APICBASE is writable").

In other words, kvm_vcpu_is_bsp() is now purely a reflection of
vcpu->arch.apic_base.MSR_IA32_APICBASE_BSP, thus the update will always
set the current value and kvm_lapic_set_base() is effectively a nop if
the new and old values match.  The RESET case, which does need to stuff
the BSP for the reset vCPU, is handled by vendor code (though this will
soon be moved to common code).

No functional change intended.

Signed-off-by: Sean Christopherson <seanjc@google.com>
---
 arch/x86/kvm/lapic.c | 4 +---
 1 file changed, 1 insertion(+), 3 deletions(-)

diff --git a/arch/x86/kvm/lapic.c b/arch/x86/kvm/lapic.c
index 655eb1d07344..b99630c6d7fe 100644
--- a/arch/x86/kvm/lapic.c
+++ b/arch/x86/kvm/lapic.c
@@ -2351,9 +2351,7 @@ void kvm_lapic_reset(struct kvm_vcpu *vcpu, bool init_event)
 	apic->highest_isr_cache = -1;
 	update_divide_count(apic);
 	atomic_set(&apic->lapic_timer.pending, 0);
-	if (kvm_vcpu_is_bsp(vcpu))
-		kvm_lapic_set_base(vcpu,
-				vcpu->arch.apic_base | MSR_IA32_APICBASE_BSP);
+
 	vcpu->arch.pv_eoi.msr_val = 0;
 	apic_update_ppr(apic);
 	if (vcpu->arch.apicv_active) {

From patchwork Sat Apr 24 00:46:15 2021
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
X-Patchwork-Submitter: Sean Christopherson <seanjc@google.com>
X-Patchwork-Id: 12222135
Return-Path: <kvm-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-26.3 required=3.0 tests=BAYES_00,DKIMWL_WL_MED,
	DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,
	INCLUDES_CR_TRAILER,INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,
	USER_AGENT_GIT,USER_IN_DEF_DKIM_WL autolearn=ham autolearn_force=no
	version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 523B2C433ED
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:49:31 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 2637261466
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:49:31 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S244504AbhDXAuD (ORCPT <rfc822;kvm@archiver.kernel.org>);
        Fri, 23 Apr 2021 20:50:03 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:36932 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S244336AbhDXAs2 (ORCPT <rfc822;kvm@vger.kernel.org>);
        Fri, 23 Apr 2021 20:48:28 -0400
Received: from mail-yb1-xb4a.google.com (mail-yb1-xb4a.google.com
 [IPv6:2607:f8b0:4864:20::b4a])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 91024C06134E
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:47:29 -0700 (PDT)
Received: by mail-yb1-xb4a.google.com with SMTP id
 u3-20020a2509430000b02904e7f1a30cffso26292240ybm.8
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:47:29 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=google.com; s=20161025;
        h=reply-to:date:in-reply-to:message-id:mime-version:references
         :subject:from:to:cc;
        bh=Xh7m40xB+PCdgjTH1Qjusqokdv3A8hOeLP4wgBd8rCM=;
        b=m7Kced1XGavUVsH0vrTEvI819K22pWwag3mNjA9ln17XpeVzi/Emhgb+nl9PEa8DTb
         83XHT+FntZINsSy1uE1KYCaY6Dw0Pzz0gFBGM19UQmUZv5cRuhDgZiWlP/rrwxvcVmjD
         0Y4MI+GKiP+47Hx5HzzCv5PEiEl/sfX8AZabUAal712dfWW1OxTTyM6zln0adk7XXxGH
         N60rPwv2QYTfJW0jW1XkPo56SiSSPFUo8MhjAf2VqfmbL819kmPm5CQsIL+y18wBoaEi
         Mnq49xnBHPrPjM5whD/7oXi/Jgz79t7XNzI6sovpIPo5IjA/KDjCkzz4QvWfmXMXtJRg
         EeMg==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:reply-to:date:in-reply-to:message-id
         :mime-version:references:subject:from:to:cc;
        bh=Xh7m40xB+PCdgjTH1Qjusqokdv3A8hOeLP4wgBd8rCM=;
        b=j6uY/0lDv1AnljxjqwSydFQFW3orPFj4fJ2zCM77G/fJqzBd44lEKJTHEoAcQKhdK2
         aQqk4dQkyMu7NIAQPftNgHcwf3zfdp+AQ7dtvyJf+//Y56iOLUQNryPoGArzbUN4ys5u
         1aT2/53c5PN06egkxQkpyjoekzSvVCvf7sMP/fWkenWIfgXwMG1DniFyCKyYttFrfPMU
         fZ4lr557QJckaPQ8bZR7q86ZG/24Qff+DFV28k3vFbdJrFxYsSFt6omSBPs+2Ajtt+OK
         VVj87jFXuYM7UxImjd8MfthFpzInroRoQfKhQxUg4Wnr6+eMRVsxlldWCX6ABuR2YaTV
         m2Tg==
X-Gm-Message-State: AOAM531DXoa6goH1v0eo2bxCgqchLM3JWYsnICJTkZpGetRRzkNx6icG
        cEdLmseXprcekhjidD3Si4rOM9zClkk=
X-Google-Smtp-Source: 
 ABdhPJzpXCPqBe2RUCyu8UuGN557NYQlwjPqrZBc2bfEb5qqDYWpd95PoAPObper5Uk5il8kW8NF4wH7iSg=
X-Received: from seanjc798194.pdx.corp.google.com
 ([2620:15c:f:10:ad52:3246:e190:f070])
 (user=seanjc job=sendgmr) by 2002:a25:a067:: with SMTP id
 x94mr10121340ybh.42.1619225248896;
 Fri, 23 Apr 2021 17:47:28 -0700 (PDT)
Reply-To: Sean Christopherson <seanjc@google.com>
Date: Fri, 23 Apr 2021 17:46:15 -0700
In-Reply-To: <20210424004645.3950558-1-seanjc@google.com>
Message-Id: <20210424004645.3950558-14-seanjc@google.com>
Mime-Version: 1.0
References: <20210424004645.3950558-1-seanjc@google.com>
X-Mailer: git-send-email 2.31.1.498.g6c1eba8ee3d-goog
Subject: [PATCH 13/43] KVM: x86: Migrate the PIT only if vcpu0 is migrated,
 not any BSP
From: Sean Christopherson <seanjc@google.com>
To: Paolo Bonzini <pbonzini@redhat.com>
Cc: Sean Christopherson <seanjc@google.com>,
        Vitaly Kuznetsov <vkuznets@redhat.com>,
        Wanpeng Li <wanpengli@tencent.com>,
        Jim Mattson <jmattson@google.com>,
        Joerg Roedel <joro@8bytes.org>, kvm@vger.kernel.org,
        linux-kernel@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

Make vcpu0 the arbitrary owner of the PIT, as was intended when PIT
migration was added by commit 2f5997140f22 ("KVM: migrate PIT timer").
The PIT was unintentionally turned into being owned by the BSP by commit
c5af89b68abb ("KVM: Introduce kvm_vcpu_is_bsp() function."), and was then
unintentionally converted to a shared ownership model when
kvm_vcpu_is_bsp() was modified to check the APIC base MSR instead of
hardcoding vcpu0 as the BSP.

Functionally, this just means the PIT's hrtimer is migrated less often.
The real motivation is to remove the usage of kvm_vcpu_is_bsp(), so that
more legacy/broken crud can be removed in a future patch.

Fixes: 58d269d8cccc ("KVM: x86: BSP in MSR_IA32_APICBASE is writable")
Signed-off-by: Sean Christopherson <seanjc@google.com>
---
 arch/x86/kvm/i8254.c | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/arch/x86/kvm/i8254.c b/arch/x86/kvm/i8254.c
index a6e218c6140d..5a69cce4d72d 100644
--- a/arch/x86/kvm/i8254.c
+++ b/arch/x86/kvm/i8254.c
@@ -220,7 +220,8 @@ void __kvm_migrate_pit_timer(struct kvm_vcpu *vcpu)
 	struct kvm_pit *pit = vcpu->kvm->arch.vpit;
 	struct hrtimer *timer;
 
-	if (!kvm_vcpu_is_bsp(vcpu) || !pit)
+	/* Somewhat arbitrarily make vcpu0 the owner of the PIT. */
+	if (vcpu->vcpu_id || !pit)
 		return;
 
 	timer = &pit->pit_state.timer;

From patchwork Sat Apr 24 00:46:16 2021
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
X-Patchwork-Submitter: Sean Christopherson <seanjc@google.com>
X-Patchwork-Id: 12222139
Return-Path: <kvm-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-26.3 required=3.0 tests=BAYES_00,DKIMWL_WL_MED,
	DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,
	INCLUDES_CR_TRAILER,INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,
	USER_AGENT_GIT,USER_IN_DEF_DKIM_WL autolearn=ham autolearn_force=no
	version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id C5B3CC433ED
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:49:44 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id A99806144A
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:49:44 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S244368AbhDXAuO (ORCPT <rfc822;kvm@archiver.kernel.org>);
        Fri, 23 Apr 2021 20:50:14 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:36964 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S244352AbhDXAsg (ORCPT <rfc822;kvm@vger.kernel.org>);
        Fri, 23 Apr 2021 20:48:36 -0400
Received: from mail-yb1-xb49.google.com (mail-yb1-xb49.google.com
 [IPv6:2607:f8b0:4864:20::b49])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 7CB85C061358
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:47:31 -0700 (PDT)
Received: by mail-yb1-xb49.google.com with SMTP id
 d89-20020a25a3620000b02904dc8d0450c6so26111233ybi.2
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:47:31 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=google.com; s=20161025;
        h=reply-to:date:in-reply-to:message-id:mime-version:references
         :subject:from:to:cc;
        bh=j3nbddZ5OdcUiZfcbardrnX3JrHsR8vaFmvYceXtq5I=;
        b=dKe4MKRvLa5cRtsNK4gaIDmSYQHgrK6HZIpAsyjq5XO5C4inuSFTII5JMRUmVJzXO0
         8VHQBy2+xo8oZayRmPKItvDmKdNdRuIPJqQZa4cLnC5KscQ7Aq/LTCU8DVv7qb5GC+AD
         yjAcS3r0HGIWOCVN+ZRImA7MF0D83q5DRO6gY0W04w0E7NvJ3cFyeP0Jjs/voZ/cexGC
         MEQKa/YbcCUuHyQvaHqdr5TRD48KLW2xGxTTykCSAZaTcM1PI+JXSm8h+Fc9QVsHU1Si
         vIhnp66PtNcU98viffnLyGm3O/yFNILgnzPpqBDLNomM86ua6lhUrvaFQuKmv0gqm5dg
         eEWw==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:reply-to:date:in-reply-to:message-id
         :mime-version:references:subject:from:to:cc;
        bh=j3nbddZ5OdcUiZfcbardrnX3JrHsR8vaFmvYceXtq5I=;
        b=o7x0xJZoUq9BDYAwGEozot5dsvd7GHN8yF3JX6SrZPX6TIjyFCNeSQ1bzGRrxnQD8M
         oJFWsnjtuIcwRqeqMceo8EUxwjkrR40wnH8mOimZcPHTICyMBMGwPVYH0EgG0OG/M7xc
         QaaHgRiTQCnZ3/5pEd5USrI9FSKQdUylX1YM/LvorDg94dUSevCra/EnX+aBAx2ZNpde
         SMwtOk/ATPNb7l0nkkgYr5WClWVBww8LQw9Ils/Kr8B+JOAGRt33mmYI+SX/Sb1mk6Hu
         GRXbL/KRLaS9lzQ0AkRN2i31Onk9l7Ya7/K0XCT7KnGMA1fj1VftWMZDmuvAWsAPXuqi
         Lfxg==
X-Gm-Message-State: AOAM532se1NWTG98koq+H/e9XU+dKAaHGgA3cApW1zbwPwJqUSdoiAvN
        KB0+V7CQwUxRootZqAmIou4QJdBZCUU=
X-Google-Smtp-Source: 
 ABdhPJyDQvjVL0RRlUvUPqCuXq5ryPDQ7vkxO0EQR2T+iSYbWrRdUteCU5Z+BZGctP9roBG4voJIlHKok7I=
X-Received: from seanjc798194.pdx.corp.google.com
 ([2620:15c:f:10:ad52:3246:e190:f070])
 (user=seanjc job=sendgmr) by 2002:a25:ae16:: with SMTP id
 a22mr7205063ybj.449.1619225250892;
 Fri, 23 Apr 2021 17:47:30 -0700 (PDT)
Reply-To: Sean Christopherson <seanjc@google.com>
Date: Fri, 23 Apr 2021 17:46:16 -0700
In-Reply-To: <20210424004645.3950558-1-seanjc@google.com>
Message-Id: <20210424004645.3950558-15-seanjc@google.com>
Mime-Version: 1.0
References: <20210424004645.3950558-1-seanjc@google.com>
X-Mailer: git-send-email 2.31.1.498.g6c1eba8ee3d-goog
Subject: [PATCH 14/43] KVM: x86: Don't force set BSP bit when local APIC is
 managed by userspace
From: Sean Christopherson <seanjc@google.com>
To: Paolo Bonzini <pbonzini@redhat.com>
Cc: Sean Christopherson <seanjc@google.com>,
        Vitaly Kuznetsov <vkuznets@redhat.com>,
        Wanpeng Li <wanpengli@tencent.com>,
        Jim Mattson <jmattson@google.com>,
        Joerg Roedel <joro@8bytes.org>, kvm@vger.kernel.org,
        linux-kernel@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

Don't set the BSP bit in vcpu->arch.apic_base when the local APIC is
managed by userspace.  Forcing all vCPUs to be BSPs is non-sensical, and
was dead code when it was added by commit 97222cc83163 ("KVM: Emulate
local APIC in kernel").  At the time, kvm_lapic_set_base() was invoked
if and only if the local APIC was in-kernel (and it couldn't be called
before the vCPU created its APIC).

kvm_lapic_set_base() eventually gained generic usage, but the latent bug
escaped notice because the only true consumer would be the guest itself
in the form of an explicit RDMSRs on APs.  Out of Linux, SeaBIOS, and
EDK2/OVMF, only OVMF consume the BSP bit from the APIC_BASE MSR.  For
the vast majority of usage in OVMF, BSP confusion would be benign.
OVMF's BSP election upon SMI rendezvous might be broken, but practically
no one runs KVM with an out-of-kernel local APIC, let alone does so while
utilizing SMIs with OVMF.

Fixes: 97222cc83163 ("KVM: Emulate local APIC in kernel")
Signed-off-by: Sean Christopherson <seanjc@google.com>
---
 arch/x86/kvm/lapic.c | 3 ---
 1 file changed, 3 deletions(-)

diff --git a/arch/x86/kvm/lapic.c b/arch/x86/kvm/lapic.c
index b99630c6d7fe..c11f23753a5b 100644
--- a/arch/x86/kvm/lapic.c
+++ b/arch/x86/kvm/lapic.c
@@ -2252,9 +2252,6 @@ void kvm_lapic_set_base(struct kvm_vcpu *vcpu, u64 value)
 	u64 old_value = vcpu->arch.apic_base;
 	struct kvm_lapic *apic = vcpu->arch.apic;
 
-	if (!apic)
-		value |= MSR_IA32_APICBASE_BSP;
-
 	vcpu->arch.apic_base = value;
 
 	if ((old_value ^ value) & MSR_IA32_APICBASE_ENABLE)

From patchwork Sat Apr 24 00:46:17 2021
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
X-Patchwork-Submitter: Sean Christopherson <seanjc@google.com>
X-Patchwork-Id: 12222137
Return-Path: <kvm-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-26.3 required=3.0 tests=BAYES_00,DKIMWL_WL_MED,
	DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,
	INCLUDES_CR_TRAILER,INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,
	USER_AGENT_GIT,USER_IN_DEF_DKIM_WL autolearn=ham autolearn_force=no
	version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 16A05C433ED
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:49:37 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id E42E061465
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:49:36 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S244520AbhDXAuL (ORCPT <rfc822;kvm@archiver.kernel.org>);
        Fri, 23 Apr 2021 20:50:11 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:36966 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S236937AbhDXAsf (ORCPT <rfc822;kvm@vger.kernel.org>);
        Fri, 23 Apr 2021 20:48:35 -0400
Received: from mail-yb1-xb4a.google.com (mail-yb1-xb4a.google.com
 [IPv6:2607:f8b0:4864:20::b4a])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id D6C1AC06135A
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:47:33 -0700 (PDT)
Received: by mail-yb1-xb4a.google.com with SMTP id
 d89-20020a25a3620000b02904dc8d0450c6so26111291ybi.2
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:47:33 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=google.com; s=20161025;
        h=reply-to:date:in-reply-to:message-id:mime-version:references
         :subject:from:to:cc;
        bh=1D0TlyZZx7JwVOxkgqn3lnDpgF3MCu1QmI2F6hIBoT4=;
        b=lJHyP2rRzUH35KcQlgXnydQwYs0SMuzctWrf1uue9kHOp9MJrRXHtC5IpS9bUmg5B/
         A0Q62gvdYDqZ3MbhDcdCt2n4G9uugT2Ala6NsNZ1yR/8b9BTCNMSopmxcVmTV3mZHHz3
         OH7EpGIBqx8kcnN9000YhwJa0v+t2TObsImK0uRlzEIfTDwY2yIk9O6ZUAQe5nsIbx7R
         bGKT2k5BRJPrbEGodj/Lr5M/gKBDBEwh75aq7eELmv0Dvl9UduuuCBtRyMAyBQiO4uiP
         Mr8AgekMCAryuK0bBxqiaQ+xyniOnc0wvV7dQNDLMIRyk9jEbrIABGpyQ3bBRtNXUcyE
         g8Vg==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:reply-to:date:in-reply-to:message-id
         :mime-version:references:subject:from:to:cc;
        bh=1D0TlyZZx7JwVOxkgqn3lnDpgF3MCu1QmI2F6hIBoT4=;
        b=hl+itUlUSyWCZP9puOfT/HYDOuGxHM3prLF4rf/X920Oc9JYkZf6VjY9q6qjgAjLCu
         O76BqwFgW+qqo+mtJnLs3VekBblyI3OJrphcmBpGOfaKxf/gm1iylHY0mAs57twNvKV+
         JcXx/vRrnL+v72pPxdz/4A/vzMMHSwswllhdMSEqyVn1+5ZaHoHG40I+K9uX+GXCgCnz
         23fUjipIud/78ZbprCTtvh5iQQBmY6UruLNvrBs+dFbvyOiRL5aRYCnUFDq7cCcIV60V
         k3TW/OMtAH6az4/lnX7cBmfyRtrqEn2lwJXDIGrqIRRjUkk7mFcNczr3+RItrEKtLQ/J
         46Uw==
X-Gm-Message-State: AOAM532ClwF0QGGPTIr3Hs/5UjCeqm2AnbZfeG2AzgPR5tKRwHfea2ke
        k0VaSj5GoKS6aPnAboTagIBJzbj8vIY=
X-Google-Smtp-Source: 
 ABdhPJzngNfTzw5UGaEBP1JekalwRdxRyeo6Y8YRa47F+7ha9DtFE7ZwHKUXAcSGSvl3cmIn87UxZ5ggIHo=
X-Received: from seanjc798194.pdx.corp.google.com
 ([2620:15c:f:10:ad52:3246:e190:f070])
 (user=seanjc job=sendgmr) by 2002:a25:2a16:: with SMTP id
 q22mr6068085ybq.379.1619225253134;
 Fri, 23 Apr 2021 17:47:33 -0700 (PDT)
Reply-To: Sean Christopherson <seanjc@google.com>
Date: Fri, 23 Apr 2021 17:46:17 -0700
In-Reply-To: <20210424004645.3950558-1-seanjc@google.com>
Message-Id: <20210424004645.3950558-16-seanjc@google.com>
Mime-Version: 1.0
References: <20210424004645.3950558-1-seanjc@google.com>
X-Mailer: git-send-email 2.31.1.498.g6c1eba8ee3d-goog
Subject: [PATCH 15/43] KVM: x86: Set BSP bit in reset BSP vCPU's APIC base by
 default
From: Sean Christopherson <seanjc@google.com>
To: Paolo Bonzini <pbonzini@redhat.com>
Cc: Sean Christopherson <seanjc@google.com>,
        Vitaly Kuznetsov <vkuznets@redhat.com>,
        Wanpeng Li <wanpengli@tencent.com>,
        Jim Mattson <jmattson@google.com>,
        Joerg Roedel <joro@8bytes.org>, kvm@vger.kernel.org,
        linux-kernel@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

Set the BSP bit appropriately during local APIC "reset" instead of
relying on vendor code to clean up at a later point.  This is a step
towards consolidating the local APIC, VMX, and SVM xAPIC initialization
code.

Signed-off-by: Sean Christopherson <seanjc@google.com>
---
 arch/x86/kvm/lapic.c | 7 +++++--
 1 file changed, 5 insertions(+), 2 deletions(-)

diff --git a/arch/x86/kvm/lapic.c b/arch/x86/kvm/lapic.c
index c11f23753a5b..b088f6984b37 100644
--- a/arch/x86/kvm/lapic.c
+++ b/arch/x86/kvm/lapic.c
@@ -2305,6 +2305,7 @@ EXPORT_SYMBOL_GPL(kvm_apic_update_apicv);
 void kvm_lapic_reset(struct kvm_vcpu *vcpu, bool init_event)
 {
 	struct kvm_lapic *apic = vcpu->arch.apic;
+	u64 msr_val;
 	int i;
 
 	if (!apic)
@@ -2314,8 +2315,10 @@ void kvm_lapic_reset(struct kvm_vcpu *vcpu, bool init_event)
 	hrtimer_cancel(&apic->lapic_timer.timer);
 
 	if (!init_event) {
-		kvm_lapic_set_base(vcpu, APIC_DEFAULT_PHYS_BASE |
-		                         MSR_IA32_APICBASE_ENABLE);
+		msr_val = APIC_DEFAULT_PHYS_BASE | MSR_IA32_APICBASE_ENABLE;
+		if (kvm_vcpu_is_reset_bsp(vcpu))
+			msr_val |= MSR_IA32_APICBASE_BSP;
+		kvm_lapic_set_base(vcpu, msr_val);
 		kvm_apic_set_xapic_id(apic, vcpu->vcpu_id);
 	}
 	kvm_apic_set_version(apic->vcpu);

From patchwork Sat Apr 24 00:46:18 2021
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
X-Patchwork-Submitter: Sean Christopherson <seanjc@google.com>
X-Patchwork-Id: 12222141
Return-Path: <kvm-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-26.3 required=3.0 tests=BAYES_00,DKIMWL_WL_MED,
	DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,
	INCLUDES_CR_TRAILER,INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,
	USER_AGENT_GIT,USER_IN_DEF_DKIM_WL autolearn=ham autolearn_force=no
	version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 09D97C433B4
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:49:52 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id CFF6861466
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:49:51 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S244551AbhDXAuW (ORCPT <rfc822;kvm@archiver.kernel.org>);
        Fri, 23 Apr 2021 20:50:22 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:36976 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S244358AbhDXAsh (ORCPT <rfc822;kvm@vger.kernel.org>);
        Fri, 23 Apr 2021 20:48:37 -0400
Received: from mail-qk1-x74a.google.com (mail-qk1-x74a.google.com
 [IPv6:2607:f8b0:4864:20::74a])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id E6CBFC06135C
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:47:35 -0700 (PDT)
Received: by mail-qk1-x74a.google.com with SMTP id
 s143-20020a3745950000b029028274263008so15786968qka.9
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:47:35 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=google.com; s=20161025;
        h=reply-to:date:in-reply-to:message-id:mime-version:references
         :subject:from:to:cc;
        bh=6E3V7dLtDnT6jSCZRct8iCP/xNw6ab9zCOnAN/OMqYU=;
        b=ZC/juWTzgPj3AcF9d+wyZqpPFeBLvHw4FDrSGn7bhpRpEcDqLIziz4xu657jnfnqMX
         HCdhIRnqRJtgDS14/dqjE66dfy6QwP409nw+08HpkekQWt7se+uUsZTRkyCN+ykrpX++
         SgFaNKrEuUn7v/p/6+LFAGDafeIpgSMtb8CC8sDnkxTruy2sIVcGa3GY2jkyewF70Sft
         hv+9ncYGeLJnDD9DrQRDltD+OMERbLMxRSlObX+2RWuo4pTnxf9YFpANQKGPk+SVCvM7
         OincD5gPJ/9M2MpwT8wvifTgayci5MjW9X5rQgf3zzqA9yHg2nSERMSWF7WkXunxTEBz
         HGMw==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:reply-to:date:in-reply-to:message-id
         :mime-version:references:subject:from:to:cc;
        bh=6E3V7dLtDnT6jSCZRct8iCP/xNw6ab9zCOnAN/OMqYU=;
        b=KvRkKMRArG7AclpN560BR/1lVQUtD/WWAPLHNAxxWLYrUHPp8BeFCQXGIpeIMbLeLF
         gUWqeXItl5M25u/Lj/O4eKQfiHxnrtXhucOtRqo+QDO6zTtNwCJJzKwSCOD8SdGmwssP
         t8n1F7wg38KP5LdGHLDLSNAK1Gbn0ROTPdOyFGp8KpfmRs4CsU0V0V+wMccDr6wxB285
         QWqoqoSc/Q6t3LhFKBhPhQlEP1Lu1x2dFUcTJmymEJHt8Ql6D28SHPpFJFvA/g7sXKDs
         8E2ofjjuFsm6nsWZI6VrU6FDViiGIA9gJDIIRbySn4bxf5ka3vnHWOioqv8O/ZzZQUrq
         Y5Dg==
X-Gm-Message-State: AOAM532jHw0LbCADHXj57ogtNB4HVT6hH1xD+Z+ZywHDktbgjx4nz7Lb
        qr9JDRVrTyldd2axuD6C7Sc7G51c/TI=
X-Google-Smtp-Source: 
 ABdhPJzGjVcWS5kWnrD4TQlNWKFu4tcBa7CTHMtb6IkBzS3H8pChLv9vqQHCRA9Hi0cnJGdo35D7XFM6eSo=
X-Received: from seanjc798194.pdx.corp.google.com
 ([2620:15c:f:10:ad52:3246:e190:f070])
 (user=seanjc job=sendgmr) by 2002:ad4:4f84:: with SMTP id
 em4mr7384577qvb.26.1619225255197;
 Fri, 23 Apr 2021 17:47:35 -0700 (PDT)
Reply-To: Sean Christopherson <seanjc@google.com>
Date: Fri, 23 Apr 2021 17:46:18 -0700
In-Reply-To: <20210424004645.3950558-1-seanjc@google.com>
Message-Id: <20210424004645.3950558-17-seanjc@google.com>
Mime-Version: 1.0
References: <20210424004645.3950558-1-seanjc@google.com>
X-Mailer: git-send-email 2.31.1.498.g6c1eba8ee3d-goog
Subject: [PATCH 16/43] KVM: VMX: Stuff vcpu->arch.apic_base directly at vCPU
 RESET
From: Sean Christopherson <seanjc@google.com>
To: Paolo Bonzini <pbonzini@redhat.com>
Cc: Sean Christopherson <seanjc@google.com>,
        Vitaly Kuznetsov <vkuznets@redhat.com>,
        Wanpeng Li <wanpengli@tencent.com>,
        Jim Mattson <jmattson@google.com>,
        Joerg Roedel <joro@8bytes.org>, kvm@vger.kernel.org,
        linux-kernel@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

Write vcpu->arch.apic_base directly instead of bouncing through
kvm_set_apic_base().  This is a glorified nop, and is a step towards
cleaning up the mess that is local APIC creation.

When using an in-kernel APIC, kvm_create_lapic() explicitly sets
vcpu->arch.apic_base to MSR_IA32_APICBASE_ENABLE to avoid its own
kvm_lapic_set_base() call in kvm_lapic_reset() from triggering state
changes.  That call during RESET exists purely to set apic->base_address
to the default base value.  As a result, by the time VMX gets control,
the only missing piece is the BSP bit being set for the reset BSP.

For a userspace APIC, there are no side effects to process (for the APIC).

In both cases, the call to kvm_update_cpuid_runtime() is a nop because
the vCPU hasn't yet been exposed to userspace, i.e. there can't be any
CPUID entries.

No functional change intended.

Signed-off-by: Sean Christopherson <seanjc@google.com>
---
 arch/x86/kvm/vmx/vmx.c | 9 +++------
 1 file changed, 3 insertions(+), 6 deletions(-)

diff --git a/arch/x86/kvm/vmx/vmx.c b/arch/x86/kvm/vmx/vmx.c
index 856aa44b17d5..fa14e9a74b96 100644
--- a/arch/x86/kvm/vmx/vmx.c
+++ b/arch/x86/kvm/vmx/vmx.c
@@ -4490,7 +4490,6 @@ static void init_vmcs(struct vcpu_vmx *vmx)
 static void vmx_vcpu_reset(struct kvm_vcpu *vcpu, bool init_event)
 {
 	struct vcpu_vmx *vmx = to_vmx(vcpu);
-	struct msr_data apic_base_msr;
 	u32 eax, dummy;
 	u64 cr0;
 
@@ -4511,12 +4510,10 @@ static void vmx_vcpu_reset(struct kvm_vcpu *vcpu, bool init_event)
 	kvm_set_cr8(vcpu, 0);
 
 	if (!init_event) {
-		apic_base_msr.data = APIC_DEFAULT_PHYS_BASE |
-				     MSR_IA32_APICBASE_ENABLE;
+		vcpu->arch.apic_base = APIC_DEFAULT_PHYS_BASE |
+				       MSR_IA32_APICBASE_ENABLE;
 		if (kvm_vcpu_is_reset_bsp(vcpu))
-			apic_base_msr.data |= MSR_IA32_APICBASE_BSP;
-		apic_base_msr.host_initiated = true;
-		kvm_set_apic_base(vcpu, &apic_base_msr);
+			vcpu->arch.apic_base |= MSR_IA32_APICBASE_BSP;
 	}
 
 	vmx_segment_cache_clear(vmx);

From patchwork Sat Apr 24 00:46:19 2021
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
X-Patchwork-Submitter: Sean Christopherson <seanjc@google.com>
X-Patchwork-Id: 12222143
Return-Path: <kvm-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-26.3 required=3.0 tests=BAYES_00,DKIMWL_WL_MED,
	DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,
	INCLUDES_CR_TRAILER,INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,
	USER_AGENT_GIT,USER_IN_DEF_DKIM_WL autolearn=ham autolearn_force=no
	version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id CEEB8C433ED
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:50:30 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id A11C161465
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:50:30 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S244581AbhDXAvF (ORCPT <rfc822;kvm@archiver.kernel.org>);
        Fri, 23 Apr 2021 20:51:05 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:36896 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S244402AbhDXAtA (ORCPT <rfc822;kvm@vger.kernel.org>);
        Fri, 23 Apr 2021 20:49:00 -0400
Received: from mail-yb1-xb4a.google.com (mail-yb1-xb4a.google.com
 [IPv6:2607:f8b0:4864:20::b4a])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id E0EABC061360
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:47:37 -0700 (PDT)
Received: by mail-yb1-xb4a.google.com with SMTP id
 f7-20020a5b0c070000b02904e9a56ee7e7so26240325ybq.9
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:47:37 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=google.com; s=20161025;
        h=reply-to:date:in-reply-to:message-id:mime-version:references
         :subject:from:to:cc;
        bh=DJN/sqIDywz/2FMtb4bxhM2j3upE+B1Quag3pNmQ3Oo=;
        b=sZAszlVUTvzyfXu+nPT1sSpYj6JD1dvWEsBo7Fa8ZOaVrztp8j1FjXhNAEl4UsxQ4v
         G/v6zCJjgHHEdEBvvS+vhX8kL6jFFT07f8xMpxv76fFAXUdyPYTzD6nOltl/cvLoRAOr
         JUW3K2I9ThxLa4WbtspdveKg8Gi7Ieiddv+pYVuaIXGh8GGSGjMmAan01ASS5CYd58xP
         zG3NGAxWnobFVYq6Kny++rrHoILQoqRVbhLTi+WY1v3NRLFU2/jNF3HLsbc2Kc6kYlhn
         cU2HcA9iXhu/gjXtmgoSZsgSV7fz6XGFe1wuMMyH984RXLdSOKKAl/O4X3A59SPATJgC
         hEiA==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:reply-to:date:in-reply-to:message-id
         :mime-version:references:subject:from:to:cc;
        bh=DJN/sqIDywz/2FMtb4bxhM2j3upE+B1Quag3pNmQ3Oo=;
        b=UisEklaoY8cstGzqxi4IqdN2Ew36nyUQCqGh6+EdopB/5QxgWbWZZxkoIK/6OtoAHT
         nozP1GdlAJ3TlnPjNgGLkAAwCFb5zPXrsETDYqvfpwAXjk6T3OcKVprzf4+GS8UPmLrd
         qF/hoDA3Wjao/b4rPBkY4rjONSindl0AqW+/FPpGSoW4kK/DvNbg0UFkP88WDyTM4oXf
         FdlZSNNZBWrvuno2Zqm+aj293AfOsIQbHSmoc1l1uoJmuyCuAydMZeo7t6MGVdtg5NbE
         Vw+MUkuTBGNFcZq0PhEY3vqea0FU47X0f4QKs3aVkktlLYERWorJbu8z/E0sYaWKmnQZ
         gyhQ==
X-Gm-Message-State: AOAM531cgQQhrkclxpFKV0HJl16TmR6LLLk8ewUqNueHrSWn3aUBDc0e
        nnnfAQWrIYZZlhYzd7QPBZxeT6WgS8g=
X-Google-Smtp-Source: 
 ABdhPJw0zRN1qcjD7Mnma6hjavDzMn15lGBDX8VMfnGjsOTOnPpDJVLjMSbAtG6YvEXrlSOY/lTLS1NAABg=
X-Received: from seanjc798194.pdx.corp.google.com
 ([2620:15c:f:10:ad52:3246:e190:f070])
 (user=seanjc job=sendgmr) by 2002:a25:4946:: with SMTP id
 w67mr9609876yba.141.1619225257191;
 Fri, 23 Apr 2021 17:47:37 -0700 (PDT)
Reply-To: Sean Christopherson <seanjc@google.com>
Date: Fri, 23 Apr 2021 17:46:19 -0700
In-Reply-To: <20210424004645.3950558-1-seanjc@google.com>
Message-Id: <20210424004645.3950558-18-seanjc@google.com>
Mime-Version: 1.0
References: <20210424004645.3950558-1-seanjc@google.com>
X-Mailer: git-send-email 2.31.1.498.g6c1eba8ee3d-goog
Subject: [PATCH 17/43] KVM: x86: Open code necessary bits of
 kvm_lapic_set_base() at vCPU RESET
From: Sean Christopherson <seanjc@google.com>
To: Paolo Bonzini <pbonzini@redhat.com>
Cc: Sean Christopherson <seanjc@google.com>,
        Vitaly Kuznetsov <vkuznets@redhat.com>,
        Wanpeng Li <wanpengli@tencent.com>,
        Jim Mattson <jmattson@google.com>,
        Joerg Roedel <joro@8bytes.org>, kvm@vger.kernel.org,
        linux-kernel@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

Stuff vcpu->arch.apic_base and apic->base_address directly during APIC
reset, as opposed to bouncing through kvm_set_apic_base() while fudging
the ENABLE bit during creation to avoid the other, unwanted side effects.

This is a step towards consolidating the APIC RESET logic across x86,
VMX, and SVM.

Signed-off-by: Sean Christopherson <seanjc@google.com>
---
 arch/x86/kvm/lapic.c | 15 ++++++---------
 1 file changed, 6 insertions(+), 9 deletions(-)

diff --git a/arch/x86/kvm/lapic.c b/arch/x86/kvm/lapic.c
index b088f6984b37..b1366df46d1d 100644
--- a/arch/x86/kvm/lapic.c
+++ b/arch/x86/kvm/lapic.c
@@ -2305,7 +2305,6 @@ EXPORT_SYMBOL_GPL(kvm_apic_update_apicv);
 void kvm_lapic_reset(struct kvm_vcpu *vcpu, bool init_event)
 {
 	struct kvm_lapic *apic = vcpu->arch.apic;
-	u64 msr_val;
 	int i;
 
 	if (!apic)
@@ -2315,10 +2314,13 @@ void kvm_lapic_reset(struct kvm_vcpu *vcpu, bool init_event)
 	hrtimer_cancel(&apic->lapic_timer.timer);
 
 	if (!init_event) {
-		msr_val = APIC_DEFAULT_PHYS_BASE | MSR_IA32_APICBASE_ENABLE;
+		vcpu->arch.apic_base = APIC_DEFAULT_PHYS_BASE |
+				       MSR_IA32_APICBASE_ENABLE;
 		if (kvm_vcpu_is_reset_bsp(vcpu))
-			msr_val |= MSR_IA32_APICBASE_BSP;
-		kvm_lapic_set_base(vcpu, msr_val);
+			vcpu->arch.apic_base |= MSR_IA32_APICBASE_BSP;
+
+		apic->base_address = MSR_IA32_APICBASE_ENABLE;
+
 		kvm_apic_set_xapic_id(apic, vcpu->vcpu_id);
 	}
 	kvm_apic_set_version(apic->vcpu);
@@ -2461,11 +2463,6 @@ int kvm_create_lapic(struct kvm_vcpu *vcpu, int timer_advance_ns)
 		lapic_timer_advance_dynamic = false;
 	}
 
-	/*
-	 * APIC is created enabled. This will prevent kvm_lapic_set_base from
-	 * thinking that APIC state has changed.
-	 */
-	vcpu->arch.apic_base = MSR_IA32_APICBASE_ENABLE;
 	static_branch_inc(&apic_sw_disabled.key); /* sw disabled at reset */
 	kvm_iodevice_init(&apic->dev, &apic_mmio_ops);
 

From patchwork Sat Apr 24 00:46:20 2021
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
X-Patchwork-Submitter: Sean Christopherson <seanjc@google.com>
X-Patchwork-Id: 12222145
Return-Path: <kvm-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-26.3 required=3.0 tests=BAYES_00,DKIMWL_WL_MED,
	DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,
	INCLUDES_CR_TRAILER,INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,
	USER_AGENT_GIT,USER_IN_DEF_DKIM_WL autolearn=ham autolearn_force=no
	version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id A2AE3C433B4
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:51:05 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 7A97461466
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:51:05 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S244318AbhDXAvi (ORCPT <rfc822;kvm@archiver.kernel.org>);
        Fri, 23 Apr 2021 20:51:38 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:36812 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S244388AbhDXAtm (ORCPT <rfc822;kvm@vger.kernel.org>);
        Fri, 23 Apr 2021 20:49:42 -0400
Received: from mail-yb1-xb49.google.com (mail-yb1-xb49.google.com
 [IPv6:2607:f8b0:4864:20::b49])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 5D34DC061362
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:47:40 -0700 (PDT)
Received: by mail-yb1-xb49.google.com with SMTP id
 d8-20020a25eb080000b02904e6f038cad5so26111140ybs.4
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:47:40 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=google.com; s=20161025;
        h=reply-to:date:in-reply-to:message-id:mime-version:references
         :subject:from:to:cc;
        bh=NZdv+AGbcKGuCnoG8O16om5C2kLzm+MyJDxYqgfhwLA=;
        b=mf8daJbNL2+OfvIgSL+41PtaksanbJRRqTdAYgYF/QdSjD42oJvxk44BDMRtD1W37p
         HcrJChZUXCNY4kJ94XHe+ZcoL4C/IRyDvUpZCcOhRJkdzQWEhfKRcmYJHDLtzc9AH1DM
         mr+SDmg4+cRDOFfsJq01xVEVATH1UMRq5WgW3de58q+dQwdP5A5+oPZNiDtUoPY0vQ6W
         CxeqLA6hODY9xdGQJJmOvQw/I4mT2oY97Sy8oPky6wTmUvsDayPmW6Hf/2jPSv3r9FcX
         oQMEMVYg+3givAO8GRo8clPvE0RstBCsB4TEMg2P7o/pw3XdI4LujyiHdF3w0IQU4RyY
         WhlQ==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:reply-to:date:in-reply-to:message-id
         :mime-version:references:subject:from:to:cc;
        bh=NZdv+AGbcKGuCnoG8O16om5C2kLzm+MyJDxYqgfhwLA=;
        b=klw7eA46OaInRZsWUcSKhhPhoN73ncinJY5/wGfVEhjD88kc5amI3oM5k4krgspDc5
         eGQWDi8Hsf1tM9J39zNjc+zOPg/SgLXtbhwlo6nmY0UnmJjCk/YR3TpjasNhANTd1uq2
         vpFuPhgSVEyyT7zKzPlixc8E1RS3/TQtK4VXoJVoH//IK0/5FLbpvc6jcAFCL4XOjK7N
         pJKNgkA1rnCnLWvz+Z/zI+1e98x8Jlw/1fnh8hsyAFHE5zjUoXtvnLvnxQEH0Y+ojsBL
         fm0NTfQfNtdLQRVG/6HS3y1rPxVk8WZPGT9KLsCLy9LlfBXWqVVc4p9q/XH4rsGiOpYk
         3Uqw==
X-Gm-Message-State: AOAM5310eCBlmCLgFrAP0DqkzuUbZ7SKapxwF0ZFIhKyNuCF86fRGGrJ
        Cwtazli2PSJNmLUJQGLEch8MVxmBRac=
X-Google-Smtp-Source: 
 ABdhPJz2bRSOk/4gUqVZJXXQC3kpzYyE7rhGX85o1M51Ow03HS+MoK2fqNFfOt4irkPUD8x65HXfiKE6EFw=
X-Received: from seanjc798194.pdx.corp.google.com
 ([2620:15c:f:10:ad52:3246:e190:f070])
 (user=seanjc job=sendgmr) by 2002:a25:9ac7:: with SMTP id
 t7mr9678756ybo.58.1619225259641;
 Fri, 23 Apr 2021 17:47:39 -0700 (PDT)
Reply-To: Sean Christopherson <seanjc@google.com>
Date: Fri, 23 Apr 2021 17:46:20 -0700
In-Reply-To: <20210424004645.3950558-1-seanjc@google.com>
Message-Id: <20210424004645.3950558-19-seanjc@google.com>
Mime-Version: 1.0
References: <20210424004645.3950558-1-seanjc@google.com>
X-Mailer: git-send-email 2.31.1.498.g6c1eba8ee3d-goog
Subject: [PATCH 18/43] KVM: x86: Consolidate APIC base RESET initialization
 code
From: Sean Christopherson <seanjc@google.com>
To: Paolo Bonzini <pbonzini@redhat.com>
Cc: Sean Christopherson <seanjc@google.com>,
        Vitaly Kuznetsov <vkuznets@redhat.com>,
        Wanpeng Li <wanpengli@tencent.com>,
        Jim Mattson <jmattson@google.com>,
        Joerg Roedel <joro@8bytes.org>, kvm@vger.kernel.org,
        linux-kernel@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

Consolidate the APIC base RESET logic, which is currently spread out
across both x86 and vendor code.  For an in-kernel APIC, the vendor code
is redundant.  But for a userspace APIC, KVM relies on the vendor code
to initialize vcpu->arch.apic_base.  Hoist the vcpu->arch.apic_base
initialization above the !apic check so that it applies to both flavors
of APIC emulation, and delete the vendor code.

Signed-off-by: Sean Christopherson <seanjc@google.com>
---
 arch/x86/kvm/lapic.c   | 14 ++++++++------
 arch/x86/kvm/svm/svm.c |  6 ------
 arch/x86/kvm/vmx/vmx.c |  7 -------
 3 files changed, 8 insertions(+), 19 deletions(-)

diff --git a/arch/x86/kvm/lapic.c b/arch/x86/kvm/lapic.c
index b1366df46d1d..07cfa4d181da 100644
--- a/arch/x86/kvm/lapic.c
+++ b/arch/x86/kvm/lapic.c
@@ -2307,18 +2307,20 @@ void kvm_lapic_reset(struct kvm_vcpu *vcpu, bool init_event)
 	struct kvm_lapic *apic = vcpu->arch.apic;
 	int i;
 
-	if (!apic)
-		return;
-
-	/* Stop the timer in case it's a reset to an active apic */
-	hrtimer_cancel(&apic->lapic_timer.timer);
-
 	if (!init_event) {
 		vcpu->arch.apic_base = APIC_DEFAULT_PHYS_BASE |
 				       MSR_IA32_APICBASE_ENABLE;
 		if (kvm_vcpu_is_reset_bsp(vcpu))
 			vcpu->arch.apic_base |= MSR_IA32_APICBASE_BSP;
+	}
 
+	if (!apic)
+		return;
+
+	/* Stop the timer in case it's a reset to an active apic */
+	hrtimer_cancel(&apic->lapic_timer.timer);
+
+	if (!init_event) {
 		apic->base_address = MSR_IA32_APICBASE_ENABLE;
 
 		kvm_apic_set_xapic_id(apic, vcpu->vcpu_id);
diff --git a/arch/x86/kvm/svm/svm.c b/arch/x86/kvm/svm/svm.c
index 6c73ea3d20c6..271b6def087f 100644
--- a/arch/x86/kvm/svm/svm.c
+++ b/arch/x86/kvm/svm/svm.c
@@ -1289,12 +1289,6 @@ static void svm_vcpu_reset(struct kvm_vcpu *vcpu, bool init_event)
 	svm->spec_ctrl = 0;
 	svm->virt_spec_ctrl = 0;
 
-	if (!init_event) {
-		vcpu->arch.apic_base = APIC_DEFAULT_PHYS_BASE |
-				       MSR_IA32_APICBASE_ENABLE;
-		if (kvm_vcpu_is_reset_bsp(vcpu))
-			vcpu->arch.apic_base |= MSR_IA32_APICBASE_BSP;
-	}
 	init_vmcb(vcpu);
 
 	/*
diff --git a/arch/x86/kvm/vmx/vmx.c b/arch/x86/kvm/vmx/vmx.c
index fa14e9a74b96..40a4ac23d54f 100644
--- a/arch/x86/kvm/vmx/vmx.c
+++ b/arch/x86/kvm/vmx/vmx.c
@@ -4509,13 +4509,6 @@ static void vmx_vcpu_reset(struct kvm_vcpu *vcpu, bool init_event)
 	vmx->hv_deadline_tsc = -1;
 	kvm_set_cr8(vcpu, 0);
 
-	if (!init_event) {
-		vcpu->arch.apic_base = APIC_DEFAULT_PHYS_BASE |
-				       MSR_IA32_APICBASE_ENABLE;
-		if (kvm_vcpu_is_reset_bsp(vcpu))
-			vcpu->arch.apic_base |= MSR_IA32_APICBASE_BSP;
-	}
-
 	vmx_segment_cache_clear(vmx);
 
 	seg_setup(VCPU_SREG_CS);

From patchwork Sat Apr 24 00:46:21 2021
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
X-Patchwork-Submitter: Sean Christopherson <seanjc@google.com>
X-Patchwork-Id: 12222147
Return-Path: <kvm-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-26.3 required=3.0 tests=BAYES_00,DKIMWL_WL_MED,
	DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,
	INCLUDES_CR_TRAILER,INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,
	USER_AGENT_GIT,USER_IN_DEF_DKIM_WL autolearn=ham autolearn_force=no
	version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 862B4C433B4
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:51:08 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 5A6E161474
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:51:08 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S244472AbhDXAvo (ORCPT <rfc822;kvm@archiver.kernel.org>);
        Fri, 23 Apr 2021 20:51:44 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:36814 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S244470AbhDXAtr (ORCPT <rfc822;kvm@vger.kernel.org>);
        Fri, 23 Apr 2021 20:49:47 -0400
Received: from mail-yb1-xb4a.google.com (mail-yb1-xb4a.google.com
 [IPv6:2607:f8b0:4864:20::b4a])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 79B97C061363
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:47:42 -0700 (PDT)
Received: by mail-yb1-xb4a.google.com with SMTP id
 c1-20020a5b0bc10000b02904e7c6399b20so26348086ybr.12
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:47:42 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=google.com; s=20161025;
        h=reply-to:date:in-reply-to:message-id:mime-version:references
         :subject:from:to:cc;
        bh=ybux/4YslnMEYEZsvkcGPcqviW6S9OYK5jonptQyC4I=;
        b=n131qTWJCuWa04F4oe/3zu7xSR7HCmvR/RjU/3fY9RqKUdbO5EOJoN1M9/J4pd8A6J
         1E1lRubsGs7E2kBG1YxPkF4VPlN1Jn7mZd1l3+UUvHisjWJB+6SmEHaumw3zglONg9vX
         0NAgrjMgC5gAYnf89al/eiJPhFA/YwcYdoOe9Fd1TeBFkivvrtYlj3JC5WqB9C1kdObb
         OJZB4Yc2GB22sYAlYhzmfBz1r94xKrkPOgxFoON73t6nw9+6Yp+YtB20u768tvdkz310
         Pi7Wun0oZc0rel4564fvhXVkolzMGmGXIldyNEeX0NWOr450PnCTWY97ha2lJ4xyfQTK
         f/4w==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:reply-to:date:in-reply-to:message-id
         :mime-version:references:subject:from:to:cc;
        bh=ybux/4YslnMEYEZsvkcGPcqviW6S9OYK5jonptQyC4I=;
        b=dmqy39uvZXmw3SRa7ssPcBI56e7zuBPnhzJ+W6ZdQBleSQL5xtg5dm8mZ6rNBdNSZr
         dA9vpCRjJOgRS1JDych2fIHA+W15DO89xO6Ua2wp6H/R17YggdoEUV/P+npf+bXfqZY+
         q88wUikE2C0/hfXDDXhhv98hrDOnt8IJrlXiLRyqStQ+zZTKmD87hQ/FR9wLd7a8CxMb
         Lf10V/AlW6JX6aPg5fJrfITktcnXesMF8or+1nLWgIVfXnqw/qvwFVLSbR+uO6ArnSAm
         M9Xr3KLeyndkkYiabk/onnm1Gg73tWoUuB3/UPmvXd+hh4kffSew8vb6WtBbtUcqquNR
         frew==
X-Gm-Message-State: AOAM531VIFRB1ArUfnOKHe+eOSfwoacNg9Z9OuQ10n+9wZRcJVw+OAJy
        crpFQeaYbDhy+uLfI8TmaE9zymQJfzA=
X-Google-Smtp-Source: 
 ABdhPJyNpvOlFlK5nKkndMFN0zoAPRak6kIWE7dUUTmKDCl8k11TIMKl+UTWyXpWoIjH+UpQIIwz0khh63A=
X-Received: from seanjc798194.pdx.corp.google.com
 ([2620:15c:f:10:ad52:3246:e190:f070])
 (user=seanjc job=sendgmr) by 2002:a25:8143:: with SMTP id
 j3mr9160217ybm.237.1619225261741;
 Fri, 23 Apr 2021 17:47:41 -0700 (PDT)
Reply-To: Sean Christopherson <seanjc@google.com>
Date: Fri, 23 Apr 2021 17:46:21 -0700
In-Reply-To: <20210424004645.3950558-1-seanjc@google.com>
Message-Id: <20210424004645.3950558-20-seanjc@google.com>
Mime-Version: 1.0
References: <20210424004645.3950558-1-seanjc@google.com>
X-Mailer: git-send-email 2.31.1.498.g6c1eba8ee3d-goog
Subject: [PATCH 19/43] KVM: x86: Move EDX initialization at vCPU RESET to
 common code
From: Sean Christopherson <seanjc@google.com>
To: Paolo Bonzini <pbonzini@redhat.com>
Cc: Sean Christopherson <seanjc@google.com>,
        Vitaly Kuznetsov <vkuznets@redhat.com>,
        Wanpeng Li <wanpengli@tencent.com>,
        Jim Mattson <jmattson@google.com>,
        Joerg Roedel <joro@8bytes.org>, kvm@vger.kernel.org,
        linux-kernel@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

Move the EDX initialization at vCPU RESET, which is now identical between
VMX and SVM, into common code.

No functional change intended.

Signed-off-by: Sean Christopherson <seanjc@google.com>
---
 arch/x86/include/asm/kvm_host.h |  5 -----
 arch/x86/kvm/svm/svm.c          | 13 -------------
 arch/x86/kvm/vmx/vmx.c          |  6 ------
 arch/x86/kvm/x86.c              | 13 +++++++++++++
 4 files changed, 13 insertions(+), 24 deletions(-)

diff --git a/arch/x86/include/asm/kvm_host.h b/arch/x86/include/asm/kvm_host.h
index 3e5fc80a35c8..2b9799366dad 100644
--- a/arch/x86/include/asm/kvm_host.h
+++ b/arch/x86/include/asm/kvm_host.h
@@ -1701,11 +1701,6 @@ static inline unsigned long read_msr(unsigned long msr)
 }
 #endif
 
-static inline u32 get_rdx_init_val(void)
-{
-	return 0x600; /* P6 family */
-}
-
 static inline void kvm_inject_gp(struct kvm_vcpu *vcpu, u32 error_code)
 {
 	kvm_queue_exception_e(vcpu, GP_VECTOR, error_code);
diff --git a/arch/x86/kvm/svm/svm.c b/arch/x86/kvm/svm/svm.c
index 271b6def087f..5c12ba725186 100644
--- a/arch/x86/kvm/svm/svm.c
+++ b/arch/x86/kvm/svm/svm.c
@@ -1283,25 +1283,12 @@ static void init_vmcb(struct kvm_vcpu *vcpu)
 static void svm_vcpu_reset(struct kvm_vcpu *vcpu, bool init_event)
 {
 	struct vcpu_svm *svm = to_svm(vcpu);
-	u32 dummy;
-	u32 eax = 1;
 
 	svm->spec_ctrl = 0;
 	svm->virt_spec_ctrl = 0;
 
 	init_vmcb(vcpu);
 
-	/*
-	 * Fall back to KVM's default Family/Model/Stepping if no CPUID match
-	 * is found.  Note, it's impossible to get a match at RESET since KVM
-	 * emulates RESET before exposing the vCPU to userspace, i.e. it's
-	 * impossible for kvm_cpuid() to find a valid entry on RESET.  But, go
-	 * through the motions in case that's ever remedied, and to be pedantic.
-	 */
-	if (!kvm_cpuid(vcpu, &eax, &dummy, &dummy, &dummy, true))
-		eax = get_rdx_init_val();
-	kvm_rdx_write(vcpu, eax);
-
 	if (kvm_vcpu_apicv_active(vcpu) && !init_event)
 		avic_update_vapic_bar(svm, APIC_DEFAULT_PHYS_BASE);
 }
diff --git a/arch/x86/kvm/vmx/vmx.c b/arch/x86/kvm/vmx/vmx.c
index 40a4ac23d54f..805888541142 100644
--- a/arch/x86/kvm/vmx/vmx.c
+++ b/arch/x86/kvm/vmx/vmx.c
@@ -4490,7 +4490,6 @@ static void init_vmcs(struct vcpu_vmx *vmx)
 static void vmx_vcpu_reset(struct kvm_vcpu *vcpu, bool init_event)
 {
 	struct vcpu_vmx *vmx = to_vmx(vcpu);
-	u32 eax, dummy;
 	u64 cr0;
 
 	if (!init_event)
@@ -4501,11 +4500,6 @@ static void vmx_vcpu_reset(struct kvm_vcpu *vcpu, bool init_event)
 
 	vmx->msr_ia32_umwait_control = 0;
 
-	eax = 1;
-	if (!kvm_cpuid(vcpu, &eax, &dummy, &dummy, &dummy, true))
-		eax = get_rdx_init_val();
-	kvm_rdx_write(vcpu, eax);
-
 	vmx->hv_deadline_tsc = -1;
 	kvm_set_cr8(vcpu, 0);
 
diff --git a/arch/x86/kvm/x86.c b/arch/x86/kvm/x86.c
index b87193190a73..167c650d1187 100644
--- a/arch/x86/kvm/x86.c
+++ b/arch/x86/kvm/x86.c
@@ -10416,6 +10416,7 @@ void kvm_vcpu_reset(struct kvm_vcpu *vcpu, bool init_event)
 {
 	unsigned long old_cr0 = kvm_read_cr0(vcpu);
 	unsigned long old_cr4 = kvm_read_cr4(vcpu);
+	u32 eax, dummy;
 
 	kvm_lapic_reset(vcpu, init_event);
 
@@ -10482,6 +10483,18 @@ void kvm_vcpu_reset(struct kvm_vcpu *vcpu, bool init_event)
 	vcpu->arch.regs_avail = ~0;
 	vcpu->arch.regs_dirty = ~0;
 
+	/*
+	 * Fall back to KVM's default Family/Model/Stepping of 0x600 (P6/Athlon)
+	 * if no CPUID match is found.  Note, it's impossible to get a match at
+	 * RESET since KVM emulates RESET before exposing the vCPU to userspace,
+	 * i.e. it'simpossible for kvm_cpuid() to find a valid entry on RESET.
+	 * But, go through the motions in case that's ever remedied.
+	 */
+	eax = 1;
+	if (!kvm_cpuid(vcpu, &eax, &dummy, &dummy, &dummy, true))
+		eax = 0x600;
+	kvm_rdx_write(vcpu, eax);
+
 	vcpu->arch.ia32_xss = 0;
 
 	static_call(kvm_x86_vcpu_reset)(vcpu, init_event);

From patchwork Sat Apr 24 00:46:22 2021
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
X-Patchwork-Submitter: Sean Christopherson <seanjc@google.com>
X-Patchwork-Id: 12222149
Return-Path: <kvm-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-26.3 required=3.0 tests=BAYES_00,DKIMWL_WL_MED,
	DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,
	INCLUDES_CR_TRAILER,INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,
	USER_AGENT_GIT,USER_IN_DEF_DKIM_WL autolearn=ham autolearn_force=no
	version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id D721AC433ED
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:51:10 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id B14186128A
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:51:10 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S244592AbhDXAvq (ORCPT <rfc822;kvm@archiver.kernel.org>);
        Fri, 23 Apr 2021 20:51:46 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:36962 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S244499AbhDXAtx (ORCPT <rfc822;kvm@vger.kernel.org>);
        Fri, 23 Apr 2021 20:49:53 -0400
Received: from mail-qv1-xf4a.google.com (mail-qv1-xf4a.google.com
 [IPv6:2607:f8b0:4864:20::f4a])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id B60C7C061367
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:47:44 -0700 (PDT)
Received: by mail-qv1-xf4a.google.com with SMTP id
 p2-20020ad452e20000b0290177fba4b9d5so19499613qvu.6
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:47:44 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=google.com; s=20161025;
        h=reply-to:date:in-reply-to:message-id:mime-version:references
         :subject:from:to:cc;
        bh=wI67RiHgb1mAzdZjTnzSpZxYjSY4YrR/tb9tPeu38Cg=;
        b=aW61n+hq0gn3dqvDogkL4uQbFlHfCDJDthWQqBqzWoBOtoRVNDw2awJ4DrFmHcobPg
         xVOR6PMq21FfC02u9wL06gdIyWam2QqRaFCZTdDD0GZ8/Ps/mmazUacpzuGS3BobxDPx
         619t5xRMcydgdJ8pxkdgEbdBkozvMhvvG7tBWjOD4DelWGBGMK3jfkHxrI9S/mCK3ZN0
         uQvwGf1dAkmTV08H+SiJeOAFiYMyerfXSgExT33fzj8HNq53K61i/MYZqlYzru+Jn008
         5yvyizifbyzwVeQ/2c2uarNQWheDY2XU9KTn8cKSluDfm6+HZ1HJoKKfDDYZZm4ZARK3
         gcnA==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:reply-to:date:in-reply-to:message-id
         :mime-version:references:subject:from:to:cc;
        bh=wI67RiHgb1mAzdZjTnzSpZxYjSY4YrR/tb9tPeu38Cg=;
        b=s+01L7TIyPSWKkpwYfUdtPI1VP6htKOJHOpOQffeSXVReTdQQF6M5+KViRrIBh7SAm
         qRKDOeJhgojNo3j+/I2Zn1TbLGqPZ06uWCgq8+QEsf+Z66JI+/XuZ9ecLHkPkJxuYvGE
         suFJ+4rin+YQe1JQfDDgm8O7n+GVH/HAVeZGOgHBkJWCPJowA6VP5k2VbkUnWsMq4mSA
         cMI5jArh3Gm3dcOjTWU/JTOWZn2qoHHDo1j58219AwJbp2GDZUYpKK6j7+p9s1wc6GlM
         6JIqPze91FWRQku2LtFzH/6pxptwf475Wg98pDW3gygB/alECAFekTlm5NYlhkKz/esr
         fNDQ==
X-Gm-Message-State: AOAM531Dl4TJagrDLERrZCLMEGDpHuHx+cytbctC94n5BY7uRFr83c+s
        4840bJXJvzbLo0Ml4QhEg4ckW1tlloE=
X-Google-Smtp-Source: 
 ABdhPJxirD2wOfuAm1w1ezcPpaIsvw7mKfzfoqHEJkGbN7KbVVp8QL3zCdcms0Ks1wgdpfoxygqu4zKvxSs=
X-Received: from seanjc798194.pdx.corp.google.com
 ([2620:15c:f:10:ad52:3246:e190:f070])
 (user=seanjc job=sendgmr) by 2002:a0c:f147:: with SMTP id
 y7mr7334860qvl.17.1619225263973;
 Fri, 23 Apr 2021 17:47:43 -0700 (PDT)
Reply-To: Sean Christopherson <seanjc@google.com>
Date: Fri, 23 Apr 2021 17:46:22 -0700
In-Reply-To: <20210424004645.3950558-1-seanjc@google.com>
Message-Id: <20210424004645.3950558-21-seanjc@google.com>
Mime-Version: 1.0
References: <20210424004645.3950558-1-seanjc@google.com>
X-Mailer: git-send-email 2.31.1.498.g6c1eba8ee3d-goog
Subject: [PATCH 20/43] KVM: SVM: Don't bother writing vmcb->save.rip at vCPU
 RESET/INIT
From: Sean Christopherson <seanjc@google.com>
To: Paolo Bonzini <pbonzini@redhat.com>
Cc: Sean Christopherson <seanjc@google.com>,
        Vitaly Kuznetsov <vkuznets@redhat.com>,
        Wanpeng Li <wanpengli@tencent.com>,
        Jim Mattson <jmattson@google.com>,
        Joerg Roedel <joro@8bytes.org>, kvm@vger.kernel.org,
        linux-kernel@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

Remove unnecessary initialization of vmcb->save.rip during vCPU RESET/INIT,
as svm_vcpu_run() unconditionally propagates VCPU_REGS_RIP to save.rip.

No true functional change intended.

Signed-off-by: Sean Christopherson <seanjc@google.com>
---
 arch/x86/kvm/svm/svm.c | 3 +--
 1 file changed, 1 insertion(+), 2 deletions(-)

diff --git a/arch/x86/kvm/svm/svm.c b/arch/x86/kvm/svm/svm.c
index 5c12ba725186..4ea100c08cb3 100644
--- a/arch/x86/kvm/svm/svm.c
+++ b/arch/x86/kvm/svm/svm.c
@@ -1208,8 +1208,7 @@ static void init_vmcb(struct kvm_vcpu *vcpu)
 	svm_set_efer(vcpu, 0);
 	save->dr6 = 0xffff0ff0;
 	kvm_set_rflags(vcpu, X86_EFLAGS_FIXED);
-	save->rip = 0x0000fff0;
-	vcpu->arch.regs[VCPU_REGS_RIP] = save->rip;
+	vcpu->arch.regs[VCPU_REGS_RIP] = 0x0000fff0;
 
 	/*
 	 * svm_set_cr0() sets PG and WP and clears NW and CD on save->cr0.

From patchwork Sat Apr 24 00:46:23 2021
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
X-Patchwork-Submitter: Sean Christopherson <seanjc@google.com>
X-Patchwork-Id: 12222151
Return-Path: <kvm-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-26.3 required=3.0 tests=BAYES_00,DKIMWL_WL_MED,
	DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,
	INCLUDES_CR_TRAILER,INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,
	USER_AGENT_GIT,USER_IN_DEF_DKIM_WL autolearn=ham autolearn_force=no
	version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 9CA5DC433B4
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:51:14 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 769D76144A
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:51:14 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S244147AbhDXAvt (ORCPT <rfc822;kvm@archiver.kernel.org>);
        Fri, 23 Apr 2021 20:51:49 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:36964 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S236024AbhDXAt4 (ORCPT <rfc822;kvm@vger.kernel.org>);
        Fri, 23 Apr 2021 20:49:56 -0400
Received: from mail-yb1-xb4a.google.com (mail-yb1-xb4a.google.com
 [IPv6:2607:f8b0:4864:20::b4a])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id F15DBC06136A
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:47:46 -0700 (PDT)
Received: by mail-yb1-xb4a.google.com with SMTP id
 d8-20020a25eb080000b02904e6f038cad5so26111315ybs.4
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:47:46 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=google.com; s=20161025;
        h=reply-to:date:in-reply-to:message-id:mime-version:references
         :subject:from:to:cc;
        bh=b+GdRfiaLMn2dSo2d+DAg1VA45RjBqE++zgwaZZFJKg=;
        b=kTvoVs7Enelp9QXEVJWtZafvgD2YeKehMVsyr6tIo3simXB0zM5yuctnGDDo9YQ9Ci
         CwJuqP+my7DjJq6fAwO5SS5gak2wfGNs7C0gl66d4LZUNMQZNpbDS1suAZi1zcIamMxF
         ghDWeNFjWTahtqq15Sl4yS6rrEWNkYwHVV63Pa6VLIA3s0n8XKAK48Zv1+LCf6K/CjRq
         4erH9Yk2Qupy+4rp86jy7YzXlLujdqJJl60D2itG79sMWU9WnX7V8d7n1Te39q+hx2bP
         mJ0zTiTV6wwsgDTzLzkrkqMQe8gxJqrFU/Dhj5seNPTA1iqIkAbhhX6sSWPtZsDHXyeo
         2OJA==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:reply-to:date:in-reply-to:message-id
         :mime-version:references:subject:from:to:cc;
        bh=b+GdRfiaLMn2dSo2d+DAg1VA45RjBqE++zgwaZZFJKg=;
        b=V7HZ+lJrM8EwJ1jVXl/RnAIvIEMdXz62ZBgFgQ6WeZ7SB+27hkmETjwHtdCowr+AHZ
         JPb32dWjyrGeMXedbnU4ijRf768VWuvEOHRMCEynbhWCpdeZjScb77euqjAs01uTbKsT
         5cziW3DhJFhXJV2wx275krthuGc0Fscc7Y4bd/4T76K+CoWoEIrh1s3WAM8mk95YUKe8
         MiBOKdixaQJup//+yXEEA3TK2u0J+G9+O7VQjcG+GOpOXVyRf+rpmwTVx5sNgNnrJEtk
         I836hxZqmnBrYeRV5YWzbH5+rn9LmCCFHLByYOxc8jeC91XxsL8xP2HI1db40pWmQqbt
         MtMA==
X-Gm-Message-State: AOAM531tSUOecXdKfz/eMVQrChRm0tb9E93uYKGbDnCYF3yYJrb15oUJ
        RJlNXfFYk6+Een7XWnkiYXuHOURnj7U=
X-Google-Smtp-Source: 
 ABdhPJz4pJvMhFssUtGQghZ1OOf+Szg4/DUHPlgGx/Mmsz/euo8RqdCoqnvCdHpnFELywoak2ymQl5NiobE=
X-Received: from seanjc798194.pdx.corp.google.com
 ([2620:15c:f:10:ad52:3246:e190:f070])
 (user=seanjc job=sendgmr) by 2002:a25:504b:: with SMTP id
 e72mr6967336ybb.152.1619225266221;
 Fri, 23 Apr 2021 17:47:46 -0700 (PDT)
Reply-To: Sean Christopherson <seanjc@google.com>
Date: Fri, 23 Apr 2021 17:46:23 -0700
In-Reply-To: <20210424004645.3950558-1-seanjc@google.com>
Message-Id: <20210424004645.3950558-22-seanjc@google.com>
Mime-Version: 1.0
References: <20210424004645.3950558-1-seanjc@google.com>
X-Mailer: git-send-email 2.31.1.498.g6c1eba8ee3d-goog
Subject: [PATCH 21/43] KVM: VMX: Invert handling of CR0.WP for EPT without
 unrestricted guest
From: Sean Christopherson <seanjc@google.com>
To: Paolo Bonzini <pbonzini@redhat.com>
Cc: Sean Christopherson <seanjc@google.com>,
        Vitaly Kuznetsov <vkuznets@redhat.com>,
        Wanpeng Li <wanpengli@tencent.com>,
        Jim Mattson <jmattson@google.com>,
        Joerg Roedel <joro@8bytes.org>, kvm@vger.kernel.org,
        linux-kernel@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

Opt-in to forcing CR0.WP=1 for shadow paging, and stop lying about WP
being "always on" for unrestricted guest.  In addition to making KVM a
wee bit more honest, this paves the way for additional cleanup.

No functional change intended.

Signed-off-by: Sean Christopherson <seanjc@google.com>
---
 arch/x86/kvm/vmx/vmx.c | 14 +++++---------
 1 file changed, 5 insertions(+), 9 deletions(-)

diff --git a/arch/x86/kvm/vmx/vmx.c b/arch/x86/kvm/vmx/vmx.c
index 805888541142..d0050c140b4d 100644
--- a/arch/x86/kvm/vmx/vmx.c
+++ b/arch/x86/kvm/vmx/vmx.c
@@ -135,8 +135,7 @@ module_param(allow_smaller_maxphyaddr, bool, S_IRUGO);
 #define KVM_VM_CR0_ALWAYS_OFF (X86_CR0_NW | X86_CR0_CD)
 #define KVM_VM_CR0_ALWAYS_ON_UNRESTRICTED_GUEST X86_CR0_NE
 #define KVM_VM_CR0_ALWAYS_ON				\
-	(KVM_VM_CR0_ALWAYS_ON_UNRESTRICTED_GUEST | 	\
-	 X86_CR0_WP | X86_CR0_PG | X86_CR0_PE)
+	(KVM_VM_CR0_ALWAYS_ON_UNRESTRICTED_GUEST | X86_CR0_PG | X86_CR0_PE)
 
 #define KVM_VM_CR4_ALWAYS_ON_UNRESTRICTED_GUEST X86_CR4_VMXE
 #define KVM_PMODE_VM_CR4_ALWAYS_ON (X86_CR4_PAE | X86_CR4_VMXE)
@@ -3103,9 +3102,7 @@ void ept_save_pdptrs(struct kvm_vcpu *vcpu)
 	kvm_register_mark_dirty(vcpu, VCPU_EXREG_PDPTR);
 }
 
-static void ept_update_paging_mode_cr0(unsigned long *hw_cr0,
-					unsigned long cr0,
-					struct kvm_vcpu *vcpu)
+static void ept_update_paging_mode_cr0(unsigned long cr0, struct kvm_vcpu *vcpu)
 {
 	struct vcpu_vmx *vmx = to_vmx(vcpu);
 
@@ -3124,9 +3121,6 @@ static void ept_update_paging_mode_cr0(unsigned long *hw_cr0,
 		vcpu->arch.cr0 = cr0;
 		vmx_set_cr4(vcpu, kvm_read_cr4(vcpu));
 	}
-
-	if (!(cr0 & X86_CR0_WP))
-		*hw_cr0 &= ~X86_CR0_WP;
 }
 
 void vmx_set_cr0(struct kvm_vcpu *vcpu, unsigned long cr0)
@@ -3139,6 +3133,8 @@ void vmx_set_cr0(struct kvm_vcpu *vcpu, unsigned long cr0)
 		hw_cr0 |= KVM_VM_CR0_ALWAYS_ON_UNRESTRICTED_GUEST;
 	else {
 		hw_cr0 |= KVM_VM_CR0_ALWAYS_ON;
+		if (!enable_ept)
+			hw_cr0 |= X86_CR0_WP;
 
 		if (vmx->rmode.vm86_active && (cr0 & X86_CR0_PE))
 			enter_pmode(vcpu);
@@ -3157,7 +3153,7 @@ void vmx_set_cr0(struct kvm_vcpu *vcpu, unsigned long cr0)
 #endif
 
 	if (enable_ept && !is_unrestricted_guest(vcpu))
-		ept_update_paging_mode_cr0(&hw_cr0, cr0, vcpu);
+		ept_update_paging_mode_cr0(cr0, vcpu);
 
 	vmcs_writel(CR0_READ_SHADOW, cr0);
 	vmcs_writel(GUEST_CR0, hw_cr0);

From patchwork Sat Apr 24 00:46:24 2021
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
X-Patchwork-Submitter: Sean Christopherson <seanjc@google.com>
X-Patchwork-Id: 12222153
Return-Path: <kvm-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-26.3 required=3.0 tests=BAYES_00,DKIMWL_WL_MED,
	DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,
	INCLUDES_CR_TRAILER,INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,
	USER_AGENT_GIT,USER_IN_DEF_DKIM_WL autolearn=ham autolearn_force=no
	version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 1349EC433ED
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:51:18 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id D9FE361466
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:51:17 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S244627AbhDXAvx (ORCPT <rfc822;kvm@archiver.kernel.org>);
        Fri, 23 Apr 2021 20:51:53 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:36824 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S244174AbhDXAt5 (ORCPT <rfc822;kvm@vger.kernel.org>);
        Fri, 23 Apr 2021 20:49:57 -0400
Received: from mail-yb1-xb4a.google.com (mail-yb1-xb4a.google.com
 [IPv6:2607:f8b0:4864:20::b4a])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 36403C06136B
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:47:49 -0700 (PDT)
Received: by mail-yb1-xb4a.google.com with SMTP id
 n129-20020a2527870000b02904ed02e1aab5so14640521ybn.21
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:47:49 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=google.com; s=20161025;
        h=reply-to:date:in-reply-to:message-id:mime-version:references
         :subject:from:to:cc;
        bh=Ew2nV1C2QkTbVPUHEDeR3BqzkrHRV1hyqurcl8ylJqA=;
        b=Q/+euOX/jNPV0L+/HCLRbjP+tdZVMolhBrphGswflROesQAMX/mKt4/qDAZgSlzR6u
         XLqaFXtMPQG13Og4KpzQOqGfOt4eFgHbmxpoyFNhUt1FY419Q1HyUP1I6pkgZbwVGkx8
         F7+vNX8lVz0LNFeRUDsTorj5bgM9Oh0wfBbZarrYnvSr+aMFoqAy+Fv5ekwizD8Ga6mI
         0b1DxdCPi8isOCr2JUs7CGKsJlH/w2EiC9x2rwK2cZDuQROlHMP1IsNled/w5n02FID/
         SZXlLqT8xZEhSs8OgQ+OMLMqJYW9AFT2RanZRsWG4zg87Vz803KVZACsX+kabnuJFFiX
         eoNw==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:reply-to:date:in-reply-to:message-id
         :mime-version:references:subject:from:to:cc;
        bh=Ew2nV1C2QkTbVPUHEDeR3BqzkrHRV1hyqurcl8ylJqA=;
        b=cA4+Cjsh5mZn8D7BdB3jWi4gNzgM8lyaUhOr6EiMrMtErrKZNGpaPs5JJlOIsq42/U
         F5xMO9Mx+CyAP7KzHUlszIhQIi8EjjQAovaGfj/G4aDYdOzowGrtzJkCrx1aka77qyCn
         amOy1pbkhTBDyJBPFEe9Phq7JAXGwKEcTttJjijK/2f3Khb2TpJ0Bv4fElMGuEOdC30e
         0h0J+nEbnHFS1eueJMSFoRLU9PyUperJ9I0BmsdH+JLOcsHo2QgeezrQujDnU70xjgFp
         CBJNDDv/HQeZIEofaHAPazMi3y3VI8nsylAfdXChrj18oCY6mdGsQ4zSHeweNx2vlKWq
         uXkg==
X-Gm-Message-State: AOAM5331xCLIvl8ikfL3zVZMRF/c3RPK1rsiZt5BosszwjcFEg7fgfhP
        Jj42JO9HWM7y17fPbMnqYPbraBk1wAc=
X-Google-Smtp-Source: 
 ABdhPJz4owlPeswNQ7Hsm2Ba7sazeB4/U3MZQetD/sxaZrXNUPfYQB6CwbIIvGWqfRuoL9tIsNKaUOIGiqY=
X-Received: from seanjc798194.pdx.corp.google.com
 ([2620:15c:f:10:ad52:3246:e190:f070])
 (user=seanjc job=sendgmr) by 2002:a5b:44e:: with SMTP id
 s14mr9583662ybp.11.1619225268482;
 Fri, 23 Apr 2021 17:47:48 -0700 (PDT)
Reply-To: Sean Christopherson <seanjc@google.com>
Date: Fri, 23 Apr 2021 17:46:24 -0700
In-Reply-To: <20210424004645.3950558-1-seanjc@google.com>
Message-Id: <20210424004645.3950558-23-seanjc@google.com>
Mime-Version: 1.0
References: <20210424004645.3950558-1-seanjc@google.com>
X-Mailer: git-send-email 2.31.1.498.g6c1eba8ee3d-goog
Subject: [PATCH 22/43] KVM: VMX: Remove direct write to vcpu->arch.cr0 during
 vCPU RESET/INIT
From: Sean Christopherson <seanjc@google.com>
To: Paolo Bonzini <pbonzini@redhat.com>
Cc: Sean Christopherson <seanjc@google.com>,
        Vitaly Kuznetsov <vkuznets@redhat.com>,
        Wanpeng Li <wanpengli@tencent.com>,
        Jim Mattson <jmattson@google.com>,
        Joerg Roedel <joro@8bytes.org>, kvm@vger.kernel.org,
        linux-kernel@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

Remove a bogus write to vcpu->arch.cr0 that immediately precedes
vmx_set_cr0() during vCPU RESET/INIT.  For RESET, this is a nop since
the "old" CR0 value is meaningless.  But for INIT, if the vCPU is coming
from paging enabled mode, crushing vcpu->arch.cr0 will cause the various
is_paging() checks in vmx_set_cr0() to get false negatives.

For the exit_lmode() case, the false negative is benign as vmx_set_efer()
is called immediately after vmx_set_cr0().

For EPT without unrestricted guest, the false negative will cause KVM to
unnecessarily run with CR3 load/store exiting.  But again, this is
benign, albeit sub-optimal.

Signed-off-by: Sean Christopherson <seanjc@google.com>
---
 arch/x86/kvm/vmx/vmx.c | 5 +----
 1 file changed, 1 insertion(+), 4 deletions(-)

diff --git a/arch/x86/kvm/vmx/vmx.c b/arch/x86/kvm/vmx/vmx.c
index d0050c140b4d..5795de909609 100644
--- a/arch/x86/kvm/vmx/vmx.c
+++ b/arch/x86/kvm/vmx/vmx.c
@@ -4486,7 +4486,6 @@ static void init_vmcs(struct vcpu_vmx *vmx)
 static void vmx_vcpu_reset(struct kvm_vcpu *vcpu, bool init_event)
 {
 	struct vcpu_vmx *vmx = to_vmx(vcpu);
-	u64 cr0;
 
 	if (!init_event)
 		init_vmcs(vmx);
@@ -4557,9 +4556,7 @@ static void vmx_vcpu_reset(struct kvm_vcpu *vcpu, bool init_event)
 
 	kvm_make_request(KVM_REQ_APIC_PAGE_RELOAD, vcpu);
 
-	cr0 = X86_CR0_NW | X86_CR0_CD | X86_CR0_ET;
-	vmx->vcpu.arch.cr0 = cr0;
-	vmx_set_cr0(vcpu, cr0); /* enter rmode */
+	vmx_set_cr0(vcpu, X86_CR0_NW | X86_CR0_CD | X86_CR0_ET);
 	vmx_set_cr4(vcpu, 0);
 	vmx_set_efer(vcpu, 0);
 

From patchwork Sat Apr 24 00:46:25 2021
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
X-Patchwork-Submitter: Sean Christopherson <seanjc@google.com>
X-Patchwork-Id: 12222155
Return-Path: <kvm-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-26.3 required=3.0 tests=BAYES_00,DKIMWL_WL_MED,
	DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,
	INCLUDES_CR_TRAILER,INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,
	USER_AGENT_GIT,USER_IN_DEF_DKIM_WL autolearn=ham autolearn_force=no
	version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 64847C433ED
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:52:03 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 32B5261263
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:52:03 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S244408AbhDXAwg (ORCPT <rfc822;kvm@archiver.kernel.org>);
        Fri, 23 Apr 2021 20:52:36 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:36880 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S244270AbhDXAu4 (ORCPT <rfc822;kvm@vger.kernel.org>);
        Fri, 23 Apr 2021 20:50:56 -0400
Received: from mail-yb1-xb4a.google.com (mail-yb1-xb4a.google.com
 [IPv6:2607:f8b0:4864:20::b4a])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 5CB1BC061343
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:47:51 -0700 (PDT)
Received: by mail-yb1-xb4a.google.com with SMTP id
 v3-20020a05690204c3b02904e65b70792dso26595841ybs.1
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:47:51 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=google.com; s=20161025;
        h=reply-to:date:in-reply-to:message-id:mime-version:references
         :subject:from:to:cc;
        bh=qXb6vjQTd1xwjeGuxgHWs2f2nyIxbCEgG3y42oAowog=;
        b=hJ5QM1I+GcatYOsJAhrQYWxqOelYqAAqZTUaiWa8J4truULZy53P1vLI1c8k5c+GhF
         zSayk6J4HVR89e04/E5spls47PevdzuGhhz1JhwcqWim4Aa8Lw6t3b77+PEU6hFBxkdN
         EHqYsU+6eKPUgT323rnDunkjJva93ZP5iP7HjjvdITSOTQd7S5wEG98DmsnHHM00zVCg
         r2T11xOgWHAOxcBWNgL16pWiGyWLlQTcXd4hFcZFzcVr8gbTgvUL/iFjpfAuBfIqkkoA
         9tJUeCetGo5mtLMg3LYvI1KrYOx3oQfA+oQppLM7MnQo60EV5vdV5l99FQJIEJsKhvxJ
         vmPA==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:reply-to:date:in-reply-to:message-id
         :mime-version:references:subject:from:to:cc;
        bh=qXb6vjQTd1xwjeGuxgHWs2f2nyIxbCEgG3y42oAowog=;
        b=UvhID1Cm1JOKk/Iptl7U5MP4Cn04FSj8jzwaujxlwNU1QRcaWAX341ITxrgbcl0Qcd
         2BOwN/lbMAPELAPCjSASPjZi/s/6RMm0AUnvn5yDxFbhMOV/ofGnI9L5DM2H64JWha8f
         ZXnTcaZ5s9SOo6dtHTyLh6MURrq1ndCzNhEm/1JPYLQ5E5COMFlhVbJHsob2gbUu2Iyc
         wQmm6gPdrfaZNYVMzJyUBwX/tZR2/BJYn6PisojERLNakXo/0rd5+VBi2hCDOg3XpO39
         jMFm7SCbeynWQs611rwGOFmuCDaMe59KX66uQlRGppoeuovmjfpE5Pw+8BuTRsvGWDa3
         HX7g==
X-Gm-Message-State: AOAM533LUEyuXMKZaa+wi42RyV9xmyEDH/QjSHGDqPEQWEvpeWq0yUKz
        fuUAlrycnq6G97QaYlkeQ1aNh6cbXF8=
X-Google-Smtp-Source: 
 ABdhPJzeIovgiSTBW+DtE984HaOO03yXgGvjqkVLAuHDvQwHCGKM2Rw5CiEOH9VQIx2ntBf/EtpQB2dY0WU=
X-Received: from seanjc798194.pdx.corp.google.com
 ([2620:15c:f:10:ad52:3246:e190:f070])
 (user=seanjc job=sendgmr) by 2002:a25:3447:: with SMTP id
 b68mr6804966yba.180.1619225270603;
 Fri, 23 Apr 2021 17:47:50 -0700 (PDT)
Reply-To: Sean Christopherson <seanjc@google.com>
Date: Fri, 23 Apr 2021 17:46:25 -0700
In-Reply-To: <20210424004645.3950558-1-seanjc@google.com>
Message-Id: <20210424004645.3950558-24-seanjc@google.com>
Mime-Version: 1.0
References: <20210424004645.3950558-1-seanjc@google.com>
X-Mailer: git-send-email 2.31.1.498.g6c1eba8ee3d-goog
Subject: [PATCH 23/43] KVM: VMX: Fold ept_update_paging_mode_cr0() back into
 vmx_set_cr0()
From: Sean Christopherson <seanjc@google.com>
To: Paolo Bonzini <pbonzini@redhat.com>
Cc: Sean Christopherson <seanjc@google.com>,
        Vitaly Kuznetsov <vkuznets@redhat.com>,
        Wanpeng Li <wanpengli@tencent.com>,
        Jim Mattson <jmattson@google.com>,
        Joerg Roedel <joro@8bytes.org>, kvm@vger.kernel.org,
        linux-kernel@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

Move the CR0/CR3/CR4 shenanigans for EPT without unrestricted guest back
into vmx_set_cr0().  This will allow a future patch to eliminate the
rather gross stuffing of vcpu->arch.cr0 in the paging transition cases
by snapshotting the old CR0.

No functional change intended.

Signed-off-by: Sean Christopherson <seanjc@google.com>
---
 arch/x86/kvm/vmx/vmx.c | 40 +++++++++++++++++-----------------------
 1 file changed, 17 insertions(+), 23 deletions(-)

diff --git a/arch/x86/kvm/vmx/vmx.c b/arch/x86/kvm/vmx/vmx.c
index 5795de909609..c9322cd55390 100644
--- a/arch/x86/kvm/vmx/vmx.c
+++ b/arch/x86/kvm/vmx/vmx.c
@@ -3102,27 +3102,6 @@ void ept_save_pdptrs(struct kvm_vcpu *vcpu)
 	kvm_register_mark_dirty(vcpu, VCPU_EXREG_PDPTR);
 }
 
-static void ept_update_paging_mode_cr0(unsigned long cr0, struct kvm_vcpu *vcpu)
-{
-	struct vcpu_vmx *vmx = to_vmx(vcpu);
-
-	if (!kvm_register_is_available(vcpu, VCPU_EXREG_CR3))
-		vmx_cache_reg(vcpu, VCPU_EXREG_CR3);
-	if (!(cr0 & X86_CR0_PG)) {
-		/* From paging/starting to nonpaging */
-		exec_controls_setbit(vmx, CPU_BASED_CR3_LOAD_EXITING |
-					  CPU_BASED_CR3_STORE_EXITING);
-		vcpu->arch.cr0 = cr0;
-		vmx_set_cr4(vcpu, kvm_read_cr4(vcpu));
-	} else if (!is_paging(vcpu)) {
-		/* From nonpaging to paging */
-		exec_controls_clearbit(vmx, CPU_BASED_CR3_LOAD_EXITING |
-					    CPU_BASED_CR3_STORE_EXITING);
-		vcpu->arch.cr0 = cr0;
-		vmx_set_cr4(vcpu, kvm_read_cr4(vcpu));
-	}
-}
-
 void vmx_set_cr0(struct kvm_vcpu *vcpu, unsigned long cr0)
 {
 	struct vcpu_vmx *vmx = to_vmx(vcpu);
@@ -3152,8 +3131,23 @@ void vmx_set_cr0(struct kvm_vcpu *vcpu, unsigned long cr0)
 	}
 #endif
 
-	if (enable_ept && !is_unrestricted_guest(vcpu))
-		ept_update_paging_mode_cr0(cr0, vcpu);
+	if (enable_ept && !is_unrestricted_guest(vcpu)) {
+		if (!kvm_register_is_available(vcpu, VCPU_EXREG_CR3))
+			vmx_cache_reg(vcpu, VCPU_EXREG_CR3);
+		if (!(cr0 & X86_CR0_PG)) {
+			/* From paging/starting to nonpaging */
+			exec_controls_setbit(vmx, CPU_BASED_CR3_LOAD_EXITING |
+						  CPU_BASED_CR3_STORE_EXITING);
+			vcpu->arch.cr0 = cr0;
+			vmx_set_cr4(vcpu, kvm_read_cr4(vcpu));
+		} else if (!is_paging(vcpu)) {
+			/* From nonpaging to paging */
+			exec_controls_clearbit(vmx, CPU_BASED_CR3_LOAD_EXITING |
+						    CPU_BASED_CR3_STORE_EXITING);
+			vcpu->arch.cr0 = cr0;
+			vmx_set_cr4(vcpu, kvm_read_cr4(vcpu));
+		}
+	}
 
 	vmcs_writel(CR0_READ_SHADOW, cr0);
 	vmcs_writel(GUEST_CR0, hw_cr0);

From patchwork Sat Apr 24 00:46:26 2021
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
X-Patchwork-Submitter: Sean Christopherson <seanjc@google.com>
X-Patchwork-Id: 12222157
Return-Path: <kvm-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-26.3 required=3.0 tests=BAYES_00,DKIMWL_WL_MED,
	DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,
	INCLUDES_CR_TRAILER,INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,
	USER_AGENT_GIT,USER_IN_DEF_DKIM_WL autolearn=ham autolearn_force=no
	version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 023B5C433B4
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:52:32 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id CB3696145F
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:52:31 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S244427AbhDXAxH (ORCPT <rfc822;kvm@archiver.kernel.org>);
        Fri, 23 Apr 2021 20:53:07 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:36814 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S244453AbhDXAvi (ORCPT <rfc822;kvm@vger.kernel.org>);
        Fri, 23 Apr 2021 20:51:38 -0400
Received: from mail-yb1-xb4a.google.com (mail-yb1-xb4a.google.com
 [IPv6:2607:f8b0:4864:20::b4a])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 9189CC061373
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:47:53 -0700 (PDT)
Received: by mail-yb1-xb4a.google.com with SMTP id
 o187-20020a2528c40000b02904e567b4bf7eso26379801ybo.10
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:47:53 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=google.com; s=20161025;
        h=reply-to:date:in-reply-to:message-id:mime-version:references
         :subject:from:to:cc;
        bh=SHBCMVMQ7FRSJddaHHw6x+5pUMPyIiVnrugYIOD42MA=;
        b=K0J9aSp6q96WN80rLA6BoEuEJYxtMQ8pd8iGLxs8Gr6drsu1Dq4gujhBRutXdcf1Nh
         DvR9rhloXJ2QlSEliiOhZIePybPVLVhP+K0eXGOJMuvS9+LhJnzlLHdgtXjQ0qIOnLfo
         HgjRG/0NGbKvb3bkpn2u7Dz9nC7dyYvXXcsuVoDTKx8/GSyzRKQ+O559upr7n48pRK8h
         RqK4K61sgn2Y7My7Ab3m0cUaQBgrJ/apiGYseof8kscSvVnpA19XdUbW3TYS4Ysm1DNQ
         UxKz5BvsVHfvSB/H+Qqdo9Ip7d5GBv2OxTE8vr2mizTH11y8OMR+XwGdDXImPaNO0HlB
         EgkA==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:reply-to:date:in-reply-to:message-id
         :mime-version:references:subject:from:to:cc;
        bh=SHBCMVMQ7FRSJddaHHw6x+5pUMPyIiVnrugYIOD42MA=;
        b=Z2VVNs4D/JFWh9wUEjHfAguCcHmMuqh5nImLa1sZHYOmuvUgCbDHLmzctuqfpj5eme
         jsIoVQhaPlB5idIO5RULFD0ww91SK5bUIRPdBEdoGwa6xRgITpB1U7WJk8+2X3UgNSP8
         e+xWxI6FGbrXHRDqTaO45T4ClW1aZztCHUgQBb0K18Eo0hU6UJrC5Cy3SCD0uWrKUfFL
         MzZm7kOhHXW6N9RLrRmnosV66/CO/dnHgSW2cBmvvDa/0ySarfS71Fgo4Vbagw+Wcwue
         eWCD0CLUOvD/Lpasnlmtbih6RYyR8UVaodjbWQVlHTnLgMvT9rYKwl5TZ/gHhEh47Jyt
         LSFg==
X-Gm-Message-State: AOAM533mKMdOgeNRsitRhGjSZOfpFtAAlyqKLiuMoAKhuFOl4BHo4ncG
        iE4mF0dDjPf8Bh3yBmXoAoN3Gth67sE=
X-Google-Smtp-Source: 
 ABdhPJweOFyWksKQg+6Diok/CUE1OzHlc60esHdxSIqqD+wEGQjBoNcll8hIkwPWtWR5aa/thYsEnhuW/34=
X-Received: from seanjc798194.pdx.corp.google.com
 ([2620:15c:f:10:ad52:3246:e190:f070])
 (user=seanjc job=sendgmr) by 2002:a5b:489:: with SMTP id
 n9mr9165164ybp.45.1619225272854;
 Fri, 23 Apr 2021 17:47:52 -0700 (PDT)
Reply-To: Sean Christopherson <seanjc@google.com>
Date: Fri, 23 Apr 2021 17:46:26 -0700
In-Reply-To: <20210424004645.3950558-1-seanjc@google.com>
Message-Id: <20210424004645.3950558-25-seanjc@google.com>
Mime-Version: 1.0
References: <20210424004645.3950558-1-seanjc@google.com>
X-Mailer: git-send-email 2.31.1.498.g6c1eba8ee3d-goog
Subject: [PATCH 24/43] KVM: nVMX: Do not clear CR3 load/store exiting bits if
 L1 wants 'em
From: Sean Christopherson <seanjc@google.com>
To: Paolo Bonzini <pbonzini@redhat.com>
Cc: Sean Christopherson <seanjc@google.com>,
        Vitaly Kuznetsov <vkuznets@redhat.com>,
        Wanpeng Li <wanpengli@tencent.com>,
        Jim Mattson <jmattson@google.com>,
        Joerg Roedel <joro@8bytes.org>, kvm@vger.kernel.org,
        linux-kernel@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

Keep CR3 load/store exiting enable as needed when running L2 in order to
honor L1's desires.  This fixes a largely theoretical bug where L1 could
intercept CR3 but not CR0.PG and end up not getting the desired CR3 exits
when L2 enables paging.  In other words, the existing !is_paging() check
inadvertantly handles the normal case for L2 where vmx_set_cr0() is
called during VM-Enter, which is guaranteed to run with paging enabled,
and thus will never clear the bits.

Removing the !is_paging() check will also allow future consolidation and
cleanup of the related code.  From a performance perspective, this is
all a nop, as the VMCS controls shadow will optimize away the VMWRITE
when the controls are in the desired state.

Add a comment explaining why CR3 is intercepted, with a big disclaimer
about not querying the old CR3.  Because vmx_set_cr0() is used for flows
that are not directly tied to MOV CR3, e.g. vCPU RESET/INIT and nested
VM-Enter, it's possible that is_paging() is not synchronized with CR3
load/store exiting.  This is actually guaranteed in the current code, as
KVM starts with CR3 interception disabled.  Obviously that can be fixed,
but there's no good reason to play whack-a-mole, and it tends to end
poorly, e.g. descriptor table exiting for UMIP emulation attempted to be
precise in the past and ended up botching the interception toggling.

Fixes: fe3ef05c7572 ("KVM: nVMX: Prepare vmcs02 from vmcs01 and vmcs12")
Signed-off-by: Sean Christopherson <seanjc@google.com>
---
 arch/x86/kvm/vmx/vmx.c | 46 +++++++++++++++++++++++++++++++++---------
 1 file changed, 37 insertions(+), 9 deletions(-)

diff --git a/arch/x86/kvm/vmx/vmx.c b/arch/x86/kvm/vmx/vmx.c
index c9322cd55390..e42ae77e4b82 100644
--- a/arch/x86/kvm/vmx/vmx.c
+++ b/arch/x86/kvm/vmx/vmx.c
@@ -3102,10 +3102,14 @@ void ept_save_pdptrs(struct kvm_vcpu *vcpu)
 	kvm_register_mark_dirty(vcpu, VCPU_EXREG_PDPTR);
 }
 
+#define CR3_EXITING_BITS (CPU_BASED_CR3_LOAD_EXITING | \
+			  CPU_BASED_CR3_STORE_EXITING)
+
 void vmx_set_cr0(struct kvm_vcpu *vcpu, unsigned long cr0)
 {
 	struct vcpu_vmx *vmx = to_vmx(vcpu);
 	unsigned long hw_cr0;
+	u32 tmp;
 
 	hw_cr0 = (cr0 & ~KVM_VM_CR0_ALWAYS_OFF);
 	if (is_unrestricted_guest(vcpu))
@@ -3132,18 +3136,42 @@ void vmx_set_cr0(struct kvm_vcpu *vcpu, unsigned long cr0)
 #endif
 
 	if (enable_ept && !is_unrestricted_guest(vcpu)) {
+		/*
+		 * Ensure KVM has an up-to-date snapshot of the guest's CR3.  If
+		 * the below code _enables_ CR3 exiting, vmx_cache_reg() will
+		 * (correctly) stop reading vmcs.GUEST_CR3 because it thinks
+		 * KVM's CR3 is installed.
+		 */
 		if (!kvm_register_is_available(vcpu, VCPU_EXREG_CR3))
 			vmx_cache_reg(vcpu, VCPU_EXREG_CR3);
+
+		/*
+		 * When running with EPT but not unrestricted guest, KVM must
+		 * intercept CR3 accesses when paging is _disabled_.  This is
+		 * necessary because restricted guests can't actually run with
+		 * paging disabled, and so KVM stuffs its own CR3 in order to
+		 * run the guest when identity mapped page tables.
+		 *
+		 * Do _NOT_ check the old CR0.PG, e.g. to optimize away the
+		 * update, it may be stale with respect to CR3 interception,
+		 * e.g. after nested VM-Enter.
+		 *
+		 * Lastly, honor L1's desires, i.e. intercept CR3 loads and/or
+		 * stores to forward them to L1, even if KVM does not need to
+		 * intercept them to preserve its identity mapped page tables.
+		 */
 		if (!(cr0 & X86_CR0_PG)) {
-			/* From paging/starting to nonpaging */
-			exec_controls_setbit(vmx, CPU_BASED_CR3_LOAD_EXITING |
-						  CPU_BASED_CR3_STORE_EXITING);
-			vcpu->arch.cr0 = cr0;
-			vmx_set_cr4(vcpu, kvm_read_cr4(vcpu));
-		} else if (!is_paging(vcpu)) {
-			/* From nonpaging to paging */
-			exec_controls_clearbit(vmx, CPU_BASED_CR3_LOAD_EXITING |
-						    CPU_BASED_CR3_STORE_EXITING);
+			exec_controls_setbit(vmx, CR3_EXITING_BITS);
+		} else if (!is_guest_mode(vcpu)) {
+			exec_controls_clearbit(vmx, CR3_EXITING_BITS);
+		} else {
+			tmp = exec_controls_get(vmx);
+			tmp &= ~CR3_EXITING_BITS;
+			tmp |= get_vmcs12(vcpu)->cpu_based_vm_exec_control & CR3_EXITING_BITS;
+			exec_controls_set(vmx, tmp);
+		}
+
+		if (!is_paging(vcpu) != !(cr0 & X86_CR0_PG)) {
 			vcpu->arch.cr0 = cr0;
 			vmx_set_cr4(vcpu, kvm_read_cr4(vcpu));
 		}

From patchwork Sat Apr 24 00:46:27 2021
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
X-Patchwork-Submitter: Sean Christopherson <seanjc@google.com>
X-Patchwork-Id: 12222159
Return-Path: <kvm-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-26.3 required=3.0 tests=BAYES_00,DKIMWL_WL_MED,
	DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,
	INCLUDES_CR_TRAILER,INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,
	USER_AGENT_GIT,USER_IN_DEF_DKIM_WL autolearn=ham autolearn_force=no
	version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 82BBEC433B4
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:52:36 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 538D46145F
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:52:36 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S244445AbhDXAxK (ORCPT <rfc822;kvm@archiver.kernel.org>);
        Fri, 23 Apr 2021 20:53:10 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:36962 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S244474AbhDXAvo (ORCPT <rfc822;kvm@vger.kernel.org>);
        Fri, 23 Apr 2021 20:51:44 -0400
Received: from mail-yb1-xb49.google.com (mail-yb1-xb49.google.com
 [IPv6:2607:f8b0:4864:20::b49])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 1D439C061377
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:47:56 -0700 (PDT)
Received: by mail-yb1-xb49.google.com with SMTP id
 e8-20020a2587480000b02904e5857564e2so26353682ybn.16
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:47:56 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=google.com; s=20161025;
        h=reply-to:date:in-reply-to:message-id:mime-version:references
         :subject:from:to:cc;
        bh=BsJdegcuVAgkFqlKM15IX9VerfL7fgnioVjMhrNs33k=;
        b=vLlkN+LUxUzZtGrOzpsmPmPjsmrhAnES/tWoBJJAyibAJP7P+KimwEM8v/xj1BDKMC
         lXBRoAMO9dPZhq3w9t/iBTqjbi4qgn6+fD3Nrwqwu7RJu7eTeAX3GBs0sgulKAQHxGBC
         TCnXsZeo8VIbirryF19u2K/pH+fusn98DIKywWHtCeTR5cFWqrm+su5xf8Ai77gXGOYY
         Wf7h65B9fb4f6LJuWuPQRLIOmjkEOVHv0QluCrjL85hA9eDHjcp8h/bf35+Nzg40Kx/P
         4FmVIlL1eHGsjH4XBMx+8O7l2U8NzcI7oOWzah/msl0AKrrwW62V8OnCHuUQnPuOEAhw
         hgGQ==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:reply-to:date:in-reply-to:message-id
         :mime-version:references:subject:from:to:cc;
        bh=BsJdegcuVAgkFqlKM15IX9VerfL7fgnioVjMhrNs33k=;
        b=DECXhpGiRdW/4sMVz6xtFY4SjCpv61YQWchSWdc3Wk0XiMa+IjIpDB7bdKa+CDdSVJ
         sd6a0a2iElO2CntfXvYxoYaIJAFXBOZLOZPwvkgXwsHj1apofB7AvXlcxaEKuAQKrWAY
         /lPPpHxj3HFaHKoKPOgw7uNnsobqaMYzePZFaVPvQFyVjjrTe8FjE6cGKRVe6hHxtV8J
         5YlWDmUTdNfOzKqoVdkFfqU9jPSHHMU2NmFFfXwMH4zoxrrLLMQS6TPMrvnzX1EGzgyf
         Mc63jhoqzkyZtS1tjyzpcdt8fVFA2AiXcBLGTdzhca5qgZthEc/C19UrA5h4rmFZb+5A
         XdpQ==
X-Gm-Message-State: AOAM533voybDatsC3hbBS8n+oOkZmyslQ+YDjDv12SzoQ+AbxrnNnZPm
        +cH/H2dk7W84aF+IrnsQ5TGTZYxLZOk=
X-Google-Smtp-Source: 
 ABdhPJzyPJomgsq6ZqoDzIcmkO1nI1sk1jfKTrA9H1DUUKS9RODIf5HQq30YKdvPbZsH69RJwsrH5f8n32g=
X-Received: from seanjc798194.pdx.corp.google.com
 ([2620:15c:f:10:ad52:3246:e190:f070])
 (user=seanjc job=sendgmr) by 2002:a25:5883:: with SMTP id
 m125mr8938555ybb.171.1619225275305;
 Fri, 23 Apr 2021 17:47:55 -0700 (PDT)
Reply-To: Sean Christopherson <seanjc@google.com>
Date: Fri, 23 Apr 2021 17:46:27 -0700
In-Reply-To: <20210424004645.3950558-1-seanjc@google.com>
Message-Id: <20210424004645.3950558-26-seanjc@google.com>
Mime-Version: 1.0
References: <20210424004645.3950558-1-seanjc@google.com>
X-Mailer: git-send-email 2.31.1.498.g6c1eba8ee3d-goog
Subject: [PATCH 25/43] KVM: VMX: Pull GUEST_CR3 from the VMCS iff CR3 load
 exiting is disabled
From: Sean Christopherson <seanjc@google.com>
To: Paolo Bonzini <pbonzini@redhat.com>
Cc: Sean Christopherson <seanjc@google.com>,
        Vitaly Kuznetsov <vkuznets@redhat.com>,
        Wanpeng Li <wanpengli@tencent.com>,
        Jim Mattson <jmattson@google.com>,
        Joerg Roedel <joro@8bytes.org>, kvm@vger.kernel.org,
        linux-kernel@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

Tweak the logic for grabbing vmcs.GUEST_CR3 in vmx_cache_reg() to look
directly at the execution controls, as opposed to effectively inferring
the controls from vCPUs state.  Inferring the controls isn't wrong, but it
creates a very subtle dependency between the caching logic, the state of
vcpu->arch.cr0 (via is_paging()), and the behavior of vmx_set_cr0().

Using the execution controls doesn't completely eliminate the dependency
in vmx_set_cr0(), e.g. neglecting to cache CR3 before enabling
interception would still break the guest, but it does reduce the
code dependency and mostly eliminate the logical dependency (that CR3
loads are intercepted in certain scenarios).  Eliminating the sublte
read of vcpu->arch.cr0 will also allow for additional cleanup in
vmx_set_cr0().

Signed-off-by: Sean Christopherson <seanjc@google.com>
---
 arch/x86/kvm/vmx/vmx.c | 7 +++++--
 1 file changed, 5 insertions(+), 2 deletions(-)

diff --git a/arch/x86/kvm/vmx/vmx.c b/arch/x86/kvm/vmx/vmx.c
index e42ae77e4b82..596c8f9766ac 100644
--- a/arch/x86/kvm/vmx/vmx.c
+++ b/arch/x86/kvm/vmx/vmx.c
@@ -2370,8 +2370,11 @@ static void vmx_cache_reg(struct kvm_vcpu *vcpu, enum kvm_reg reg)
 		vcpu->arch.cr0 |= vmcs_readl(GUEST_CR0) & guest_owned_bits;
 		break;
 	case VCPU_EXREG_CR3:
-		if (is_unrestricted_guest(vcpu) ||
-		    (enable_ept && is_paging(vcpu)))
+		/*
+		 * When intercepting CR3 loads, e.g. for shadowing paging, KVM's
+		 * CR3 is loaded into hardware, not the guest's CR3.
+		 */
+		if (!(exec_controls_get(to_vmx(vcpu)) & CPU_BASED_CR3_LOAD_EXITING))
 			vcpu->arch.cr3 = vmcs_readl(GUEST_CR3);
 		break;
 	case VCPU_EXREG_CR4:

From patchwork Sat Apr 24 00:46:28 2021
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
X-Patchwork-Submitter: Sean Christopherson <seanjc@google.com>
X-Patchwork-Id: 12222161
Return-Path: <kvm-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-26.3 required=3.0 tests=BAYES_00,DKIMWL_WL_MED,
	DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,
	INCLUDES_CR_TRAILER,INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,
	USER_AGENT_GIT,USER_IN_DEF_DKIM_WL autolearn=ham autolearn_force=no
	version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 077ABC433ED
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:52:40 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id C8B1B61263
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:52:39 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S244483AbhDXAxO (ORCPT <rfc822;kvm@archiver.kernel.org>);
        Fri, 23 Apr 2021 20:53:14 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:36964 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S244597AbhDXAvs (ORCPT <rfc822;kvm@vger.kernel.org>);
        Fri, 23 Apr 2021 20:51:48 -0400
Received: from mail-yb1-xb4a.google.com (mail-yb1-xb4a.google.com
 [IPv6:2607:f8b0:4864:20::b4a])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 60064C061346
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:47:58 -0700 (PDT)
Received: by mail-yb1-xb4a.google.com with SMTP id
 e13-20020a25d30d0000b02904ec4109da25so26208000ybf.7
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:47:58 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=google.com; s=20161025;
        h=reply-to:date:in-reply-to:message-id:mime-version:references
         :subject:from:to:cc;
        bh=xQjgXxDowxam8JHFp2lMQSy0uU5l4G90MChbJDwG3P4=;
        b=vrkGY+oTI2Wmke2vymXqHiinOuYnSi6pt0qxIsFDWY4rSh3zLHKkzCF+4c/pNPTL1+
         56kMamCA5mbaPHuJ7yLSXgWMYUOOTWaFOBB6wLJJskT2qn0POVeJ3ueX7QT4vc5hwKle
         Lkk7ORtMHJ+w5qAavedqunXHaoueL6+Nitu4GDM4WJBYeNlZts309QUfSIRiYTwL+1Ak
         qQLtz0UDF3IzaxdMHoAacttefRIPqjwPck33g12HYKSoLLDsjh5dVm0VvaoXTM7dzPaj
         rizbGFen1vqHJvflNG2YRnIg+14a3fSBOUghG7UE+k2VqhbQFOcdItXJhxBMnax/+TST
         Rzfw==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:reply-to:date:in-reply-to:message-id
         :mime-version:references:subject:from:to:cc;
        bh=xQjgXxDowxam8JHFp2lMQSy0uU5l4G90MChbJDwG3P4=;
        b=RNmA4YzqKQBfC5amblbf+jyTZoP7KGTRgZy7/AApCaOqYPoy7dS3SnKK9FdbgYEfMq
         ZyTpioKPF1lgbVjOMVDVDWuw47U6AutL7n5kTULVXh3QHjlgkyiBW9NRmV0hj0yCYzy2
         5/s336sE1yxTS1NE3fQlbEO1js6bBbXakwU/YU2cEF4TItnPrptwBuw0Wlj0o2ToFZZP
         9/qqARPX8Vg8RtwKrNZ9jQe0MMNhHw0orsCbjItjSleXcdb4Y1Tm6XQ8zXTkjzNETbMr
         /QgiOzRveMAGXPMxTr+9WmSuTwwM8nB522ZrrBwMZoSbQOVPbu6/wQ6g2/7zuYLDUfp6
         gmCg==
X-Gm-Message-State: AOAM532AeH4Zkt4o4IgvYWYlPSj+waqbydjfIL1Uxn/mzSASQEba4eam
        E4GG6XMqjoOtv4LOoN+7to5vyuSERNg=
X-Google-Smtp-Source: 
 ABdhPJy1vGfcQ/3sgvWc/gFelDhCA3rHMXvsqASU1T0CrCYyFZQ4XET3B3QGekR/FDZ6LrX8PHfitVfMjHk=
X-Received: from seanjc798194.pdx.corp.google.com
 ([2620:15c:f:10:ad52:3246:e190:f070])
 (user=seanjc job=sendgmr) by 2002:a25:7315:: with SMTP id
 o21mr6501271ybc.319.1619225277610;
 Fri, 23 Apr 2021 17:47:57 -0700 (PDT)
Reply-To: Sean Christopherson <seanjc@google.com>
Date: Fri, 23 Apr 2021 17:46:28 -0700
In-Reply-To: <20210424004645.3950558-1-seanjc@google.com>
Message-Id: <20210424004645.3950558-27-seanjc@google.com>
Mime-Version: 1.0
References: <20210424004645.3950558-1-seanjc@google.com>
X-Mailer: git-send-email 2.31.1.498.g6c1eba8ee3d-goog
Subject: [PATCH 26/43] KVM: VMX: Process CR0.PG side effects after setting CR0
 assets
From: Sean Christopherson <seanjc@google.com>
To: Paolo Bonzini <pbonzini@redhat.com>
Cc: Sean Christopherson <seanjc@google.com>,
        Vitaly Kuznetsov <vkuznets@redhat.com>,
        Wanpeng Li <wanpengli@tencent.com>,
        Jim Mattson <jmattson@google.com>,
        Joerg Roedel <joro@8bytes.org>, kvm@vger.kernel.org,
        linux-kernel@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

Move the long mode and EPT w/o unrestricted guest side effect processing
down in vmx_set_cr0() so that the EPT && !URG case doesn't have to stuff
vcpu->arch.cr0 early.  This also fixes an oddity where CR0 might not be
marked available, i.e. the early vcpu->arch.cr0 write would appear to be
in danger of being overwritten, though that can't actually happen in the
current code since CR0.TS is the only guest-owned bit, and CR0.TS is not
read by vmx_set_cr4().

Signed-off-by: Sean Christopherson <seanjc@google.com>
---
 arch/x86/kvm/vmx/vmx.c | 23 ++++++++++++-----------
 1 file changed, 12 insertions(+), 11 deletions(-)

diff --git a/arch/x86/kvm/vmx/vmx.c b/arch/x86/kvm/vmx/vmx.c
index 596c8f9766ac..5f30181fd240 100644
--- a/arch/x86/kvm/vmx/vmx.c
+++ b/arch/x86/kvm/vmx/vmx.c
@@ -3111,9 +3111,11 @@ void ept_save_pdptrs(struct kvm_vcpu *vcpu)
 void vmx_set_cr0(struct kvm_vcpu *vcpu, unsigned long cr0)
 {
 	struct vcpu_vmx *vmx = to_vmx(vcpu);
-	unsigned long hw_cr0;
+	unsigned long hw_cr0, old_cr0_pg;
 	u32 tmp;
 
+	old_cr0_pg = kvm_read_cr0_bits(vcpu, X86_CR0_PG);
+
 	hw_cr0 = (cr0 & ~KVM_VM_CR0_ALWAYS_OFF);
 	if (is_unrestricted_guest(vcpu))
 		hw_cr0 |= KVM_VM_CR0_ALWAYS_ON_UNRESTRICTED_GUEST;
@@ -3129,11 +3131,16 @@ void vmx_set_cr0(struct kvm_vcpu *vcpu, unsigned long cr0)
 			enter_rmode(vcpu);
 	}
 
+	vmcs_writel(CR0_READ_SHADOW, cr0);
+	vmcs_writel(GUEST_CR0, hw_cr0);
+	vcpu->arch.cr0 = cr0;
+	kvm_register_mark_available(vcpu, VCPU_EXREG_CR0);
+
 #ifdef CONFIG_X86_64
 	if (vcpu->arch.efer & EFER_LME) {
-		if (!is_paging(vcpu) && (cr0 & X86_CR0_PG))
+		if (!old_cr0_pg && (cr0 & X86_CR0_PG))
 			enter_lmode(vcpu);
-		if (is_paging(vcpu) && !(cr0 & X86_CR0_PG))
+		else if (old_cr0_pg && !(cr0 & X86_CR0_PG))
 			exit_lmode(vcpu);
 	}
 #endif
@@ -3174,17 +3181,11 @@ void vmx_set_cr0(struct kvm_vcpu *vcpu, unsigned long cr0)
 			exec_controls_set(vmx, tmp);
 		}
 
-		if (!is_paging(vcpu) != !(cr0 & X86_CR0_PG)) {
-			vcpu->arch.cr0 = cr0;
+		/* Note, vmx_set_cr4() consumes the new vcpu->arch.cr0. */
+		if ((old_cr0_pg ^ cr0) & X86_CR0_PG)
 			vmx_set_cr4(vcpu, kvm_read_cr4(vcpu));
-		}
 	}
 
-	vmcs_writel(CR0_READ_SHADOW, cr0);
-	vmcs_writel(GUEST_CR0, hw_cr0);
-	vcpu->arch.cr0 = cr0;
-	kvm_register_mark_available(vcpu, VCPU_EXREG_CR0);
-
 	/* depends on vcpu->arch.cr0 to be set to a new value */
 	vmx->emulation_required = emulation_required(vcpu);
 }

From patchwork Sat Apr 24 00:46:29 2021
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
X-Patchwork-Submitter: Sean Christopherson <seanjc@google.com>
X-Patchwork-Id: 12222163
Return-Path: <kvm-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-26.3 required=3.0 tests=BAYES_00,DKIMWL_WL_MED,
	DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,
	INCLUDES_CR_TRAILER,INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,
	USER_AGENT_GIT,USER_IN_DEF_DKIM_WL autolearn=ham autolearn_force=no
	version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id F41F5C433B4
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:52:42 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id C13D161465
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:52:42 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S244528AbhDXAxR (ORCPT <rfc822;kvm@archiver.kernel.org>);
        Fri, 23 Apr 2021 20:53:17 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:36824 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S244612AbhDXAvt (ORCPT <rfc822;kvm@vger.kernel.org>);
        Fri, 23 Apr 2021 20:51:49 -0400
Received: from mail-yb1-xb49.google.com (mail-yb1-xb49.google.com
 [IPv6:2607:f8b0:4864:20::b49])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 9F36AC061345
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:48:00 -0700 (PDT)
Received: by mail-yb1-xb49.google.com with SMTP id
 n11-20020a25808b0000b02904d9818b80e8so26106960ybk.14
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:48:00 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=google.com; s=20161025;
        h=reply-to:date:in-reply-to:message-id:mime-version:references
         :subject:from:to:cc;
        bh=JqcOnCGExfR3YjMtsB4lLkNrTfGGIsxEsg5SkDkGdDA=;
        b=hTIMu62j1JfVoMqUJDMRxt4mX6dRaa2v8VIO52tvPHuQXjRNo0B9jHOMT4XZ66Ge8h
         /OafbtDyprXRunXNaiH0JuDl+PhiPUF1F91bHHOkmTWu20fMrd+4/2lporx6mFkHLz/Q
         53/btJAj3u5jCLr4l8M/FVswWMOcZFPHi5yObFtdEf5FGPv/ntYqMDsE/6HUniIWceLa
         UDlZz/XxdEuF8pNOW75zu1kPSBXUOuDz3ztcQ1zlQkCziPqxlZU/JyzbnAme7Bc26E9b
         e0jzQLjBdMzi4QrKpoa/olCS85DNJsb9g3SuAF0rJ4yfVDujU0y29sqcGcFb8DLkBAKw
         YlDA==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:reply-to:date:in-reply-to:message-id
         :mime-version:references:subject:from:to:cc;
        bh=JqcOnCGExfR3YjMtsB4lLkNrTfGGIsxEsg5SkDkGdDA=;
        b=eEPJAsG040OT6SR2EOJVjPRiKLUPv0LUhHuXUpnmyRR1HcH0RYX2rki/8MiGLzzPGm
         sZ4yPsF5PC4XdrUKlsP7Dh1C4cQHmwgZBFAmvIVlkM+f0mnOsOT/KlrO7BlTyNhjRmWJ
         pDWHOfoVBlcndNPKJDje57M5Hf4iinDN6qv51/rkWgjBPY2Mnkmx00LCtO6A0s0L+v0g
         APY48apvADZ2Px/6ydSLbnVC9NQsCAt6iDZhXlaFaCkbRTsQ/j3072FInfiqxLw/76vI
         gbmb354QXO3LN8Ga9zQOsjV/p7xTBzIWYj/RLBMTtZFzlbfju+Kcr9+Tu4FBZ/FV1Fe1
         vSFA==
X-Gm-Message-State: AOAM531L/8SMTrJw10EpFlHXbsOB8C9kz0luvwqrT+J7Pf1ge5Zr44ta
        042ivsPU4OyVszWjQIHTEjhqnq9JMfc=
X-Google-Smtp-Source: 
 ABdhPJwVdft0X93b33hr5Zga9hH9TiTwaqFgtZy6VqZeveX1PGKa6J1UAlQo8+Z0r4MKQLjWN2y5mbO25r8=
X-Received: from seanjc798194.pdx.corp.google.com
 ([2620:15c:f:10:ad52:3246:e190:f070])
 (user=seanjc job=sendgmr) by 2002:a25:d152:: with SMTP id
 i79mr10295563ybg.328.1619225279897;
 Fri, 23 Apr 2021 17:47:59 -0700 (PDT)
Reply-To: Sean Christopherson <seanjc@google.com>
Date: Fri, 23 Apr 2021 17:46:29 -0700
In-Reply-To: <20210424004645.3950558-1-seanjc@google.com>
Message-Id: <20210424004645.3950558-28-seanjc@google.com>
Mime-Version: 1.0
References: <20210424004645.3950558-1-seanjc@google.com>
X-Mailer: git-send-email 2.31.1.498.g6c1eba8ee3d-goog
Subject: [PATCH 27/43] KVM: VMX: Skip emulation required checks during
 pmode/rmode transitions
From: Sean Christopherson <seanjc@google.com>
To: Paolo Bonzini <pbonzini@redhat.com>
Cc: Sean Christopherson <seanjc@google.com>,
        Vitaly Kuznetsov <vkuznets@redhat.com>,
        Wanpeng Li <wanpengli@tencent.com>,
        Jim Mattson <jmattson@google.com>,
        Joerg Roedel <joro@8bytes.org>, kvm@vger.kernel.org,
        linux-kernel@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

Don't refresh "emulation required" when stuffing segments during
transitions to/from real mode when running without unrestricted guest.
The checks are unnecessary as vmx_set_cr0() unconditionally rechecks
"emulation required".  They also happen to be broken, as enter_pmode()
and enter_rmode() run with a stale vcpu->arch.cr0.

Signed-off-by: Sean Christopherson <seanjc@google.com>
---
 arch/x86/kvm/vmx/vmx.c | 18 ++++++++++++------
 1 file changed, 12 insertions(+), 6 deletions(-)

diff --git a/arch/x86/kvm/vmx/vmx.c b/arch/x86/kvm/vmx/vmx.c
index 5f30181fd240..37bfa20a04dd 100644
--- a/arch/x86/kvm/vmx/vmx.c
+++ b/arch/x86/kvm/vmx/vmx.c
@@ -2827,6 +2827,8 @@ static __init int alloc_kvm_area(void)
 	return 0;
 }
 
+static void __vmx_set_segment(struct kvm_vcpu *vcpu, struct kvm_segment *var, int seg);
+
 static void fix_pmode_seg(struct kvm_vcpu *vcpu, int seg,
 		struct kvm_segment *save)
 {
@@ -2843,7 +2845,7 @@ static void fix_pmode_seg(struct kvm_vcpu *vcpu, int seg,
 		save->dpl = save->selector & SEGMENT_RPL_MASK;
 		save->s = 1;
 	}
-	vmx_set_segment(vcpu, save, seg);
+	__vmx_set_segment(vcpu, save, seg);
 }
 
 static void enter_pmode(struct kvm_vcpu *vcpu)
@@ -2864,7 +2866,7 @@ static void enter_pmode(struct kvm_vcpu *vcpu)
 
 	vmx->rmode.vm86_active = 0;
 
-	vmx_set_segment(vcpu, &vmx->rmode.segs[VCPU_SREG_TR], VCPU_SREG_TR);
+	__vmx_set_segment(vcpu, &vmx->rmode.segs[VCPU_SREG_TR], VCPU_SREG_TR);
 
 	flags = vmcs_readl(GUEST_RFLAGS);
 	flags &= RMODE_GUEST_OWNED_EFLAGS_BITS;
@@ -3399,7 +3401,7 @@ static u32 vmx_segment_access_rights(struct kvm_segment *var)
 	return ar;
 }
 
-void vmx_set_segment(struct kvm_vcpu *vcpu, struct kvm_segment *var, int seg)
+static void __vmx_set_segment(struct kvm_vcpu *vcpu, struct kvm_segment *var, int seg)
 {
 	struct vcpu_vmx *vmx = to_vmx(vcpu);
 	const struct kvm_vmx_segment_field *sf = &kvm_vmx_segment_fields[seg];
@@ -3412,7 +3414,7 @@ void vmx_set_segment(struct kvm_vcpu *vcpu, struct kvm_segment *var, int seg)
 			vmcs_write16(sf->selector, var->selector);
 		else if (var->s)
 			fix_rmode_seg(seg, &vmx->rmode.segs[seg]);
-		goto out;
+		return;
 	}
 
 	vmcs_writel(sf->base, var->base);
@@ -3434,9 +3436,13 @@ void vmx_set_segment(struct kvm_vcpu *vcpu, struct kvm_segment *var, int seg)
 		var->type |= 0x1; /* Accessed */
 
 	vmcs_write32(sf->ar_bytes, vmx_segment_access_rights(var));
+}
 
-out:
-	vmx->emulation_required = emulation_required(vcpu);
+void vmx_set_segment(struct kvm_vcpu *vcpu, struct kvm_segment *var, int seg)
+{
+	__vmx_set_segment(vcpu, var, seg);
+
+	to_vmx(vcpu)->emulation_required = emulation_required(vcpu);
 }
 
 static void vmx_get_cs_db_l_bits(struct kvm_vcpu *vcpu, int *db, int *l)

From patchwork Sat Apr 24 00:46:30 2021
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
X-Patchwork-Submitter: Sean Christopherson <seanjc@google.com>
X-Patchwork-Id: 12222167
Return-Path: <kvm-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-26.3 required=3.0 tests=BAYES_00,DKIMWL_WL_MED,
	DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,
	INCLUDES_CR_TRAILER,INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,
	USER_AGENT_GIT,USER_IN_DEF_DKIM_WL autolearn=unavailable autolearn_force=no
	version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 1C9F3C433B4
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:53:28 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id E57476145F
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:53:27 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S244254AbhDXAyC (ORCPT <rfc822;kvm@archiver.kernel.org>);
        Fri, 23 Apr 2021 20:54:02 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:36798 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S244236AbhDXAwg (ORCPT <rfc822;kvm@vger.kernel.org>);
        Fri, 23 Apr 2021 20:52:36 -0400
Received: from mail-yb1-xb4a.google.com (mail-yb1-xb4a.google.com
 [IPv6:2607:f8b0:4864:20::b4a])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id CA3BFC06137B
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:48:02 -0700 (PDT)
Received: by mail-yb1-xb4a.google.com with SMTP id
 s2-20020a5b07420000b02904eb842efc40so26198702ybq.3
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:48:02 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=google.com; s=20161025;
        h=reply-to:date:in-reply-to:message-id:mime-version:references
         :subject:from:to:cc;
        bh=OQ6Lvv5hUZLxy6LtPOKbAp59CLYR6ZOdLmQpGf/gsyE=;
        b=VAMmZddflONjj4+4i9x1eMZDZlg0Fk3FfXR97b9eh9OiOqWVMVlFB8OtX0Ia7HSXal
         cJkfdUeFpYIwSnMrVpVCJK+crTHF+kQ2qBUtaqCVXMTsnjwN+c6TmZUmBkWUMbpp05cY
         HJ5yxF67I+gB4biY/jxoqjlReB5Wo4gjt1zS4mrf3RQA4PIFpgfTuLVYAWV/74A7v0vt
         NHWWoDjT0YsykzXSQ4s7BNhMFN8dVFC+hJsXalhoM1r9NnDRxDw5jpPYBYHLCiuDcp+D
         Ff+B/dinV9IGDKYxxpki5nhSlqfIbzamUKNTdrMzm3r/oyON3ARkh3O6ZulmtR/HX32m
         2Xmg==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:reply-to:date:in-reply-to:message-id
         :mime-version:references:subject:from:to:cc;
        bh=OQ6Lvv5hUZLxy6LtPOKbAp59CLYR6ZOdLmQpGf/gsyE=;
        b=giQp4s/4hm80Mqf5cROAXNjYfGUO7HbM6kVb+ONxQH+iCYxDL6yfQeEUPOMfyoLbA2
         KYZQsEhVq/o0bNywo38Dpqhw9TNJsTe3qKi7QGPlNRanH8J6tkxhlw6vhp4nBWgV0ERT
         4Kl6GHbeqroXU5iRUDwJxXlErYpKqKZmpRIHZkzB7QVFHtyG8ph0ATm6wtqvIW+HBhds
         zfo0Vgc0rOI+oS42SuUOFfVAFXymeleD5Q8NZnw5/a2sQCaEklNv7BziISxSnj5D0emY
         Eciq4Uc2G1mEbHkdGGcHjCh/Pr5LMBEik+kW2wnP7bD+k91v6CUEBRf7OHXlBxHwMcVV
         iEKg==
X-Gm-Message-State: AOAM531f9nQt8rs9Y4Lx2QzB6gdOu+VhV4B/0zR1xlQsmhx8ac+GR4K8
        80YIExpVihHSShCfpsUJadHrGrb9yes=
X-Google-Smtp-Source: 
 ABdhPJz973IcJu9CuRU33WhIG6gKNEX6LxtNGUTLA8kxQ4jqGktu9x6SnWAkTtYu/q0TVa56P20RsnBL5d4=
X-Received: from seanjc798194.pdx.corp.google.com
 ([2620:15c:f:10:ad52:3246:e190:f070])
 (user=seanjc job=sendgmr) by 2002:a05:6902:4d4:: with SMTP id
 v20mr9489642ybs.420.1619225282067; Fri, 23 Apr 2021 17:48:02 -0700 (PDT)
Reply-To: Sean Christopherson <seanjc@google.com>
Date: Fri, 23 Apr 2021 17:46:30 -0700
In-Reply-To: <20210424004645.3950558-1-seanjc@google.com>
Message-Id: <20210424004645.3950558-29-seanjc@google.com>
Mime-Version: 1.0
References: <20210424004645.3950558-1-seanjc@google.com>
X-Mailer: git-send-email 2.31.1.498.g6c1eba8ee3d-goog
Subject: [PATCH 28/43] KVM: nVMX: Don't evaluate "emulation required" on
 VM-Exit
From: Sean Christopherson <seanjc@google.com>
To: Paolo Bonzini <pbonzini@redhat.com>
Cc: Sean Christopherson <seanjc@google.com>,
        Vitaly Kuznetsov <vkuznets@redhat.com>,
        Wanpeng Li <wanpengli@tencent.com>,
        Jim Mattson <jmattson@google.com>,
        Joerg Roedel <joro@8bytes.org>, kvm@vger.kernel.org,
        linux-kernel@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

Use the "internal" variants of setting segment registers when stuffing
state on nested VM-Exit in order to skip the "emulation required"
updates.  VM-Exit must always go to protected mode, and all segments are
mostly hardcoded (to valid values) on VM-Exit.  The bits of the segments
that aren't hardcoded are explicitly checked during VM-Enter, e.g. the
selector RPLs must all be zero.

Signed-off-by: Sean Christopherson <seanjc@google.com>
---
 arch/x86/kvm/vmx/nested.c | 16 ++++++++--------
 arch/x86/kvm/vmx/vmx.c    |  6 ++----
 arch/x86/kvm/vmx/vmx.h    |  2 +-
 3 files changed, 11 insertions(+), 13 deletions(-)

diff --git a/arch/x86/kvm/vmx/nested.c b/arch/x86/kvm/vmx/nested.c
index 32126fa0c4d8..f811bb7f2dc3 100644
--- a/arch/x86/kvm/vmx/nested.c
+++ b/arch/x86/kvm/vmx/nested.c
@@ -4245,7 +4245,7 @@ static void load_vmcs12_host_state(struct kvm_vcpu *vcpu,
 		seg.l = 1;
 	else
 		seg.db = 1;
-	vmx_set_segment(vcpu, &seg, VCPU_SREG_CS);
+	__vmx_set_segment(vcpu, &seg, VCPU_SREG_CS);
 	seg = (struct kvm_segment) {
 		.base = 0,
 		.limit = 0xFFFFFFFF,
@@ -4256,17 +4256,17 @@ static void load_vmcs12_host_state(struct kvm_vcpu *vcpu,
 		.g = 1
 	};
 	seg.selector = vmcs12->host_ds_selector;
-	vmx_set_segment(vcpu, &seg, VCPU_SREG_DS);
+	__vmx_set_segment(vcpu, &seg, VCPU_SREG_DS);
 	seg.selector = vmcs12->host_es_selector;
-	vmx_set_segment(vcpu, &seg, VCPU_SREG_ES);
+	__vmx_set_segment(vcpu, &seg, VCPU_SREG_ES);
 	seg.selector = vmcs12->host_ss_selector;
-	vmx_set_segment(vcpu, &seg, VCPU_SREG_SS);
+	__vmx_set_segment(vcpu, &seg, VCPU_SREG_SS);
 	seg.selector = vmcs12->host_fs_selector;
 	seg.base = vmcs12->host_fs_base;
-	vmx_set_segment(vcpu, &seg, VCPU_SREG_FS);
+	__vmx_set_segment(vcpu, &seg, VCPU_SREG_FS);
 	seg.selector = vmcs12->host_gs_selector;
 	seg.base = vmcs12->host_gs_base;
-	vmx_set_segment(vcpu, &seg, VCPU_SREG_GS);
+	__vmx_set_segment(vcpu, &seg, VCPU_SREG_GS);
 	seg = (struct kvm_segment) {
 		.base = vmcs12->host_tr_base,
 		.limit = 0x67,
@@ -4274,11 +4274,11 @@ static void load_vmcs12_host_state(struct kvm_vcpu *vcpu,
 		.type = 11,
 		.present = 1
 	};
-	vmx_set_segment(vcpu, &seg, VCPU_SREG_TR);
+	__vmx_set_segment(vcpu, &seg, VCPU_SREG_TR);
 
 	memset(&seg, 0, sizeof(seg));
 	seg.unusable = 1;
-	vmx_set_segment(vcpu, &seg, VCPU_SREG_LDTR);
+	__vmx_set_segment(vcpu, &seg, VCPU_SREG_LDTR);
 
 	kvm_set_dr(vcpu, 7, 0x400);
 	vmcs_write64(GUEST_IA32_DEBUGCTL, 0);
diff --git a/arch/x86/kvm/vmx/vmx.c b/arch/x86/kvm/vmx/vmx.c
index 37bfa20a04dd..594975dc3f94 100644
--- a/arch/x86/kvm/vmx/vmx.c
+++ b/arch/x86/kvm/vmx/vmx.c
@@ -2827,8 +2827,6 @@ static __init int alloc_kvm_area(void)
 	return 0;
 }
 
-static void __vmx_set_segment(struct kvm_vcpu *vcpu, struct kvm_segment *var, int seg);
-
 static void fix_pmode_seg(struct kvm_vcpu *vcpu, int seg,
 		struct kvm_segment *save)
 {
@@ -3401,7 +3399,7 @@ static u32 vmx_segment_access_rights(struct kvm_segment *var)
 	return ar;
 }
 
-static void __vmx_set_segment(struct kvm_vcpu *vcpu, struct kvm_segment *var, int seg)
+void __vmx_set_segment(struct kvm_vcpu *vcpu, struct kvm_segment *var, int seg)
 {
 	struct vcpu_vmx *vmx = to_vmx(vcpu);
 	const struct kvm_vmx_segment_field *sf = &kvm_vmx_segment_fields[seg];
@@ -3438,7 +3436,7 @@ static void __vmx_set_segment(struct kvm_vcpu *vcpu, struct kvm_segment *var, in
 	vmcs_write32(sf->ar_bytes, vmx_segment_access_rights(var));
 }
 
-void vmx_set_segment(struct kvm_vcpu *vcpu, struct kvm_segment *var, int seg)
+static void vmx_set_segment(struct kvm_vcpu *vcpu, struct kvm_segment *var, int seg)
 {
 	__vmx_set_segment(vcpu, var, seg);
 
diff --git a/arch/x86/kvm/vmx/vmx.h b/arch/x86/kvm/vmx/vmx.h
index 19fe09fad2fe..1283ad0e592d 100644
--- a/arch/x86/kvm/vmx/vmx.h
+++ b/arch/x86/kvm/vmx/vmx.h
@@ -376,7 +376,7 @@ void vmx_set_cr4(struct kvm_vcpu *vcpu, unsigned long cr4);
 void set_cr4_guest_host_mask(struct vcpu_vmx *vmx);
 void ept_save_pdptrs(struct kvm_vcpu *vcpu);
 void vmx_get_segment(struct kvm_vcpu *vcpu, struct kvm_segment *var, int seg);
-void vmx_set_segment(struct kvm_vcpu *vcpu, struct kvm_segment *var, int seg);
+void __vmx_set_segment(struct kvm_vcpu *vcpu, struct kvm_segment *var, int seg);
 u64 construct_eptp(struct kvm_vcpu *vcpu, hpa_t root_hpa, int root_level);
 
 void vmx_update_exception_bitmap(struct kvm_vcpu *vcpu);

From patchwork Sat Apr 24 00:46:31 2021
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
X-Patchwork-Submitter: Sean Christopherson <seanjc@google.com>
X-Patchwork-Id: 12222165
Return-Path: <kvm-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-26.3 required=3.0 tests=BAYES_00,DKIMWL_WL_MED,
	DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,
	INCLUDES_CR_TRAILER,INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,
	USER_AGENT_GIT,USER_IN_DEF_DKIM_WL autolearn=ham autolearn_force=no
	version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 948BFC433B4
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:53:24 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 7134D61466
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:53:24 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S232742AbhDXAx7 (ORCPT <rfc822;kvm@archiver.kernel.org>);
        Fri, 23 Apr 2021 20:53:59 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:36800 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S244170AbhDXAwf (ORCPT <rfc822;kvm@vger.kernel.org>);
        Fri, 23 Apr 2021 20:52:35 -0400
Received: from mail-qv1-xf4a.google.com (mail-qv1-xf4a.google.com
 [IPv6:2607:f8b0:4864:20::f4a])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id E2E6EC06137D
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:48:04 -0700 (PDT)
Received: by mail-qv1-xf4a.google.com with SMTP id
 p2-20020ad452e20000b0290177fba4b9d5so19500078qvu.6
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:48:04 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=google.com; s=20161025;
        h=reply-to:date:in-reply-to:message-id:mime-version:references
         :subject:from:to:cc;
        bh=8FPjB9kODcd44RP7aC0zZao6wso5dTHmRwxsyhm3GIU=;
        b=ozB2Ag/eEMci6Fo+7ypR3EpsxZvT2N3jckC41JPYLCyLZwWueyWwAysuxItZ2uzeKk
         dpjozZ5Nl/F2ZREDDjmNT8iq3zQb2GESNIkIBQG5Dwrf+mYRNAvaLnDCV/7DJiD44wBv
         YC2PMSKYAIOVLxE48ilkyk3/LA3WyNk6B9Jng9Sgwn/WOMIVOrU8Dm7fBiLo0XQO61f3
         EQxbHW1IJS+ehHCIvH06rMTYNo11dvUqMKFaf4eQ0c3CD7SAgujPQmMRdCm1ovOPxaOn
         IGJaOgkSTQEq2VrAL0BtxRe3J1J3zMrNtWainJ6cQo+NbgUMoSqVmShRfLKLmFQMc0Mb
         wL+w==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:reply-to:date:in-reply-to:message-id
         :mime-version:references:subject:from:to:cc;
        bh=8FPjB9kODcd44RP7aC0zZao6wso5dTHmRwxsyhm3GIU=;
        b=nSmrNrraezwdPH39Ww7sgUTfoN9YtwzXIOmRdyCFEYfzP/0NEs1KlpN9G6ORkHu5Ja
         Tro3tBegoUaOeq5ySLL0n9wdB+bnd3dENxISy21G/mW1K6hMNyYMy9TNWWVy9miriiSY
         L6QObF53p6LBd4i/bATvX6up+BBsnHefBqTR1lgrdoVH24knsbg2yPigwufTX0vv8bck
         svqx3FJ4lF74CxBqLZsSY5nn9AY4PyN7aMWYJ7MllR0J9HZ40aR6ctw4z2G/Ik0MC135
         z5/t+4+898ICKiaLOCfOBiEFUZCerS4wrWx2HEP1IolxNbcUlvSOL0OSw4eCZSR1sMd9
         aoTQ==
X-Gm-Message-State: AOAM531ON9kqA5cGNiURG49AdAlRGX37B/XKhTHthR3l/TxOASvjZQhJ
        4b9xufhejtpTExBqIQzEKxNsx44Iwr0=
X-Google-Smtp-Source: 
 ABdhPJwIe4aMtREwCdKlN8Ejc4nv8qWnmoGL1M73/G1IxtPwJ/CZeAKF0LNUA6wkJbNTrlSMirS4uyZ9p+w=
X-Received: from seanjc798194.pdx.corp.google.com
 ([2620:15c:f:10:ad52:3246:e190:f070])
 (user=seanjc job=sendgmr) by 2002:ad4:4e01:: with SMTP id
 dl1mr7170885qvb.9.1619225284120;
 Fri, 23 Apr 2021 17:48:04 -0700 (PDT)
Reply-To: Sean Christopherson <seanjc@google.com>
Date: Fri, 23 Apr 2021 17:46:31 -0700
In-Reply-To: <20210424004645.3950558-1-seanjc@google.com>
Message-Id: <20210424004645.3950558-30-seanjc@google.com>
Mime-Version: 1.0
References: <20210424004645.3950558-1-seanjc@google.com>
X-Mailer: git-send-email 2.31.1.498.g6c1eba8ee3d-goog
Subject: [PATCH 29/43] KVM: SVM: Tweak order of cr0/cr4/efer writes at
 RESET/INIT
From: Sean Christopherson <seanjc@google.com>
To: Paolo Bonzini <pbonzini@redhat.com>
Cc: Sean Christopherson <seanjc@google.com>,
        Vitaly Kuznetsov <vkuznets@redhat.com>,
        Wanpeng Li <wanpengli@tencent.com>,
        Jim Mattson <jmattson@google.com>,
        Joerg Roedel <joro@8bytes.org>, kvm@vger.kernel.org,
        linux-kernel@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

Hoist svm_set_cr0() up in the sequence of register initialization during
vCPU RESET/INIT, purely to match VMX so that a future patch can move the
sequences to common x86.

Signed-off-by: Sean Christopherson <seanjc@google.com>
---
 arch/x86/kvm/svm/svm.c | 7 +------
 1 file changed, 1 insertion(+), 6 deletions(-)

diff --git a/arch/x86/kvm/svm/svm.c b/arch/x86/kvm/svm/svm.c
index 4ea100c08cb3..88d34fa93d8b 100644
--- a/arch/x86/kvm/svm/svm.c
+++ b/arch/x86/kvm/svm/svm.c
@@ -1204,18 +1204,13 @@ static void init_vmcb(struct kvm_vcpu *vcpu)
 	init_sys_seg(&save->ldtr, SEG_TYPE_LDT);
 	init_sys_seg(&save->tr, SEG_TYPE_BUSY_TSS16);
 
+	svm_set_cr0(vcpu, X86_CR0_NW | X86_CR0_CD | X86_CR0_ET);
 	svm_set_cr4(vcpu, 0);
 	svm_set_efer(vcpu, 0);
 	save->dr6 = 0xffff0ff0;
 	kvm_set_rflags(vcpu, X86_EFLAGS_FIXED);
 	vcpu->arch.regs[VCPU_REGS_RIP] = 0x0000fff0;
 
-	/*
-	 * svm_set_cr0() sets PG and WP and clears NW and CD on save->cr0.
-	 * It also updates the guest-visible cr0 value.
-	 */
-	svm_set_cr0(vcpu, X86_CR0_NW | X86_CR0_CD | X86_CR0_ET);
-
 	save->cr4 = X86_CR4_PAE;
 
 	if (npt_enabled) {

From patchwork Sat Apr 24 00:46:32 2021
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
X-Patchwork-Submitter: Sean Christopherson <seanjc@google.com>
X-Patchwork-Id: 12222169
Return-Path: <kvm-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-26.3 required=3.0 tests=BAYES_00,DKIMWL_WL_MED,
	DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,
	INCLUDES_CR_TRAILER,INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,
	USER_AGENT_GIT,USER_IN_DEF_DKIM_WL autolearn=ham autolearn_force=no
	version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 87BB1C433B4
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:53:54 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 67D0061409
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:53:54 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S236103AbhDXAy2 (ORCPT <rfc822;kvm@archiver.kernel.org>);
        Fri, 23 Apr 2021 20:54:28 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:36926 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S244338AbhDXAxD (ORCPT <rfc822;kvm@vger.kernel.org>);
        Fri, 23 Apr 2021 20:53:03 -0400
Received: from mail-yb1-xb49.google.com (mail-yb1-xb49.google.com
 [IPv6:2607:f8b0:4864:20::b49])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 310F7C0612EA
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:48:07 -0700 (PDT)
Received: by mail-yb1-xb49.google.com with SMTP id
 l6-20020a5b05860000b02904e88b568042so26335196ybp.6
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:48:07 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=google.com; s=20161025;
        h=reply-to:date:in-reply-to:message-id:mime-version:references
         :subject:from:to:cc;
        bh=dsiMBchNTtndnmQlk4F63qszrVBMRXg4RloYviM4gF4=;
        b=DLHJVAghmlCF6JmDRY3qJZSPKKBmK7vBFJ9tA2azFp9TZbNze8G6Dk+Et/qgGC5OPh
         DJUS44SdtB817l7bOzG0U6SKVW7HuaG1CrykmapcI0bmvwsKnIeu92on9mT+vHZ+OpZ5
         HLmFQGihRTiuKUveO2bSSkIUxvfVkbym6Mecyb3VZjRcQlK49lX+8QdpkmDb5HIp4Sda
         qSij8iYdhJ5QpSU61zus5WOKpUrPJ1vv5dwmnUb4jqDi0Bna+gIAbnh12ac3jz0RdyD9
         8AbAAZld7/AdGjOhjV9dJk2IaV72uTLa1jgdy0ZcQAbEssuNLl29zZVFG0uDjRsbGC1j
         hAGQ==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:reply-to:date:in-reply-to:message-id
         :mime-version:references:subject:from:to:cc;
        bh=dsiMBchNTtndnmQlk4F63qszrVBMRXg4RloYviM4gF4=;
        b=rrVFZ9zs+HF9DkHYb0tswrtCWfEADdTeCrjQMUzKnO/W9QkMDsMvE73B9NHriU2Sf6
         +66N2I0mrPec3fm9B3PAUavZHpHNgy/M6PRti4pvTvi/6RkHmOBQE227uO7a4mV8RI+J
         WALnOcl0xc0RAPf2lF8GVSK8n7/dKPaJuKhm3V24afmR/5kIqq0/PpSCqlcs0uE2N1o0
         8MCqIkrWHQ+XY49YVDPD8npFSxxas1c1790XYPB00/D9EfR/txN0LaMnDKsjULaEP0Re
         /hdblnfdZ+T4sa6gSVUpuvR1lbcZmbF1s1m6xNV6wU+Mcgl6ZXNx0mWoUK+hZ0LrUvrF
         iMEQ==
X-Gm-Message-State: AOAM533QHSumf5YpVkWbMt6ncIAI39vjw2x4ZhGFAinbM7js+EnLzCAs
        0Oi+Qm4593yiPYD6Ej2iGSRRZyuIO3Y=
X-Google-Smtp-Source: 
 ABdhPJzHd1onR0oqXPgHGSf07Ej3AmYGAmthNY/gfjWbuNGb2R8GtbRaqSXyt8YUb+K2T5W3zOT9ewLF2cE=
X-Received: from seanjc798194.pdx.corp.google.com
 ([2620:15c:f:10:ad52:3246:e190:f070])
 (user=seanjc job=sendgmr) by 2002:a25:1905:: with SMTP id
 5mr9570731ybz.302.1619225286449;
 Fri, 23 Apr 2021 17:48:06 -0700 (PDT)
Reply-To: Sean Christopherson <seanjc@google.com>
Date: Fri, 23 Apr 2021 17:46:32 -0700
In-Reply-To: <20210424004645.3950558-1-seanjc@google.com>
Message-Id: <20210424004645.3950558-31-seanjc@google.com>
Mime-Version: 1.0
References: <20210424004645.3950558-1-seanjc@google.com>
X-Mailer: git-send-email 2.31.1.498.g6c1eba8ee3d-goog
Subject: [PATCH 30/43] KVM: SVM: Drop redundant writes to vmcb->save.cr4 at
 RESET/INIT
From: Sean Christopherson <seanjc@google.com>
To: Paolo Bonzini <pbonzini@redhat.com>
Cc: Sean Christopherson <seanjc@google.com>,
        Vitaly Kuznetsov <vkuznets@redhat.com>,
        Wanpeng Li <wanpengli@tencent.com>,
        Jim Mattson <jmattson@google.com>,
        Joerg Roedel <joro@8bytes.org>, kvm@vger.kernel.org,
        linux-kernel@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

Drop direct writes to vmcb->save.cr4 during vCPU RESET/INIT, as the
values being written are fully redundant with respect to
svm_set_cr4(vcpu, 0) a few lines earlier.  Note, svm_set_cr4() also
correctly forces X86_CR4_PAE when NPT is disabled.

No functional change intended.

Signed-off-by: Sean Christopherson <seanjc@google.com>
---
 arch/x86/kvm/svm/svm.c | 3 ---
 1 file changed, 3 deletions(-)

diff --git a/arch/x86/kvm/svm/svm.c b/arch/x86/kvm/svm/svm.c
index 88d34fa93d8b..558329f53709 100644
--- a/arch/x86/kvm/svm/svm.c
+++ b/arch/x86/kvm/svm/svm.c
@@ -1211,8 +1211,6 @@ static void init_vmcb(struct kvm_vcpu *vcpu)
 	kvm_set_rflags(vcpu, X86_EFLAGS_FIXED);
 	vcpu->arch.regs[VCPU_REGS_RIP] = 0x0000fff0;
 
-	save->cr4 = X86_CR4_PAE;
-
 	if (npt_enabled) {
 		/* Setup VMCB for Nested Paging */
 		control->nested_ctl |= SVM_NESTED_CTL_NP_ENABLE;
@@ -1222,7 +1220,6 @@ static void init_vmcb(struct kvm_vcpu *vcpu)
 		svm_clr_intercept(svm, INTERCEPT_CR3_WRITE);
 		save->g_pat = vcpu->arch.pat;
 		save->cr3 = 0;
-		save->cr4 = 0;
 	}
 	svm->current_vmcb->asid_generation = 0;
 	svm->asid = 0;

From patchwork Sat Apr 24 00:46:33 2021
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
X-Patchwork-Submitter: Sean Christopherson <seanjc@google.com>
X-Patchwork-Id: 12222171
Return-Path: <kvm-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-26.3 required=3.0 tests=BAYES_00,DKIMWL_WL_MED,
	DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,
	INCLUDES_CR_TRAILER,INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,
	USER_AGENT_GIT,USER_IN_DEF_DKIM_WL autolearn=ham autolearn_force=no
	version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id DA8C6C433ED
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:53:55 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id BCD3861465
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:53:55 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S233027AbhDXAyb (ORCPT <rfc822;kvm@archiver.kernel.org>);
        Fri, 23 Apr 2021 20:54:31 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:36928 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S232501AbhDXAxD (ORCPT <rfc822;kvm@vger.kernel.org>);
        Fri, 23 Apr 2021 20:53:03 -0400
Received: from mail-yb1-xb49.google.com (mail-yb1-xb49.google.com
 [IPv6:2607:f8b0:4864:20::b49])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 8146FC0612EE
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:48:09 -0700 (PDT)
Received: by mail-yb1-xb49.google.com with SMTP id
 e13-20020a25d30d0000b02904ec4109da25so26208339ybf.7
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:48:09 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=google.com; s=20161025;
        h=reply-to:date:in-reply-to:message-id:mime-version:references
         :subject:from:to:cc;
        bh=sHAT3f/Z7rzeqzw1crWe70jwssZuJ3ZwjfFXfNoL22E=;
        b=uAjiVALHwTJh6zDtWgM6ZZ6gfTE8VT2Z3/yzpWjbaXccVMu2ELKEuSKDYxBnbfqEKG
         aUpmmY3b721f/yOLcO18vtQfjUmjNHwLXEi3F1KAcSbjMd/a/cgUnnt+98/jl2gEoKM0
         01t2k8Vwp/zIQQnTIMgQNz7Re5nZCi/BmdeBxXntF4xPl5WZzxFctkPhuP2VeDYPdV3T
         W6duE03AG3gqc1yODwV1LhoredzgkaaN1mVC5tuWy4zcJ4r+IMVrbdwk9Og2m5YSJQxj
         4JAnvsUl3F/9DqUTnQDZgohvq70D9MVepoignzuybt32IPsjxraTRKxhCVYJNJTE5f5F
         Rncg==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:reply-to:date:in-reply-to:message-id
         :mime-version:references:subject:from:to:cc;
        bh=sHAT3f/Z7rzeqzw1crWe70jwssZuJ3ZwjfFXfNoL22E=;
        b=cTkY8wYj5XgW6AWr6kzxWyl0+HQABJIFxcllPO4r6/SVhyt4ernya94Wl+opoVvJCy
         qyGyt7/UaYpt+2ku0zobaGLW6Wf2CFeYbC+jiWNaxV7SBfGLcWyg85BcOnQzmzWDUHbW
         RaLdbiGqUJBRS3c3a+/Q+W3/ElEMHY/Gzbz2Mbo47Swec2t730+I1jah6zpiqaIiONoW
         73XwOe5hrLv5qoxu86jIk21pCJ/fgpxS2vceYzJmfDirpBtOwpC7QindPkQ0992TOnBx
         YBwJ+CJ9gRKHuKfjtOfqrRoeER8kwZqwGvPM5ZeRMGxEM7w1UOL9tR95+jIYDfq7d2ta
         SKkA==
X-Gm-Message-State: AOAM530Iu1u2/t7F+hnwHyGfdUx8pS5kE1RFXSHj7Rm81nrwWPkGFAO5
        cv4uMYKIAypcCMHu3vsBv7Ulci89MAI=
X-Google-Smtp-Source: 
 ABdhPJyACzhkbHPYYanTR1KTSWvR/rHvFEzLNkK3c74rBb4WMmGKl2BBA8pZ7L1ssUCvhdjh9QwVPqlZlRM=
X-Received: from seanjc798194.pdx.corp.google.com
 ([2620:15c:f:10:ad52:3246:e190:f070])
 (user=seanjc job=sendgmr) by 2002:a25:bd83:: with SMTP id
 f3mr9374328ybh.29.1619225288761;
 Fri, 23 Apr 2021 17:48:08 -0700 (PDT)
Reply-To: Sean Christopherson <seanjc@google.com>
Date: Fri, 23 Apr 2021 17:46:33 -0700
In-Reply-To: <20210424004645.3950558-1-seanjc@google.com>
Message-Id: <20210424004645.3950558-32-seanjc@google.com>
Mime-Version: 1.0
References: <20210424004645.3950558-1-seanjc@google.com>
X-Mailer: git-send-email 2.31.1.498.g6c1eba8ee3d-goog
Subject: [PATCH 31/43] KVM: SVM: Stuff save->dr6 at during VMSA sync,
 not at RESET/INIT
From: Sean Christopherson <seanjc@google.com>
To: Paolo Bonzini <pbonzini@redhat.com>
Cc: Sean Christopherson <seanjc@google.com>,
        Vitaly Kuznetsov <vkuznets@redhat.com>,
        Wanpeng Li <wanpengli@tencent.com>,
        Jim Mattson <jmattson@google.com>,
        Joerg Roedel <joro@8bytes.org>, kvm@vger.kernel.org,
        linux-kernel@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

Move code to stuff vmcb->save.dr6 to its architectural init value from
svm_vcpu_reset() into sev_es_sync_vmsa().  Except for protected guests,
a.k.a. SEV-ES guests, vmcb->save.dr6 is set during VM-Enter, i.e. the
extra write is unnecessary.  For SEV-ES, stuffing save->dr6 handles a
theoretical case where the VMSA could be encrypted before the first
KVM_RUN.

Signed-off-by: Sean Christopherson <seanjc@google.com>
---
 arch/x86/kvm/svm/sev.c | 1 +
 arch/x86/kvm/svm/svm.c | 1 -
 2 files changed, 1 insertion(+), 1 deletion(-)

diff --git a/arch/x86/kvm/svm/sev.c b/arch/x86/kvm/svm/sev.c
index a9d8d6aafdb8..b81ebeb4c426 100644
--- a/arch/x86/kvm/svm/sev.c
+++ b/arch/x86/kvm/svm/sev.c
@@ -573,6 +573,7 @@ static int sev_es_sync_vmsa(struct vcpu_svm *svm)
 	save->xcr0 = svm->vcpu.arch.xcr0;
 	save->pkru = svm->vcpu.arch.pkru;
 	save->xss  = svm->vcpu.arch.ia32_xss;
+	save->dr6  = svm->vcpu.arch.dr6;
 
 	/*
 	 * SEV-ES will use a VMSA that is pointed to by the VMCB, not
diff --git a/arch/x86/kvm/svm/svm.c b/arch/x86/kvm/svm/svm.c
index 558329f53709..996a6b03e338 100644
--- a/arch/x86/kvm/svm/svm.c
+++ b/arch/x86/kvm/svm/svm.c
@@ -1207,7 +1207,6 @@ static void init_vmcb(struct kvm_vcpu *vcpu)
 	svm_set_cr0(vcpu, X86_CR0_NW | X86_CR0_CD | X86_CR0_ET);
 	svm_set_cr4(vcpu, 0);
 	svm_set_efer(vcpu, 0);
-	save->dr6 = 0xffff0ff0;
 	kvm_set_rflags(vcpu, X86_EFLAGS_FIXED);
 	vcpu->arch.regs[VCPU_REGS_RIP] = 0x0000fff0;
 

From patchwork Sat Apr 24 00:46:34 2021
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
X-Patchwork-Submitter: Sean Christopherson <seanjc@google.com>
X-Patchwork-Id: 12222173
Return-Path: <kvm-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-26.3 required=3.0 tests=BAYES_00,DKIMWL_WL_MED,
	DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,
	INCLUDES_CR_TRAILER,INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,
	USER_AGENT_GIT,USER_IN_DEF_DKIM_WL autolearn=ham autolearn_force=no
	version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id D0076C43460
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:53:57 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id B442761467
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:53:57 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S244303AbhDXAyc (ORCPT <rfc822;kvm@archiver.kernel.org>);
        Fri, 23 Apr 2021 20:54:32 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:37932 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S244406AbhDXAxG (ORCPT <rfc822;kvm@vger.kernel.org>);
        Fri, 23 Apr 2021 20:53:06 -0400
Received: from mail-yb1-xb4a.google.com (mail-yb1-xb4a.google.com
 [IPv6:2607:f8b0:4864:20::b4a])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id ECBDBC0612F0
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:48:11 -0700 (PDT)
Received: by mail-yb1-xb4a.google.com with SMTP id
 u7-20020a259b470000b02904dca50820c2so26388954ybo.11
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:48:11 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=google.com; s=20161025;
        h=reply-to:date:in-reply-to:message-id:mime-version:references
         :subject:from:to:cc;
        bh=BdoSnjJxYw1zfGUU/Z7GRrV8PpQo7mVoIG98cidoNPE=;
        b=ZXyR7PW511+wiI+r2z9sDLy0bn0R5t8+YYcLnYmh7WaFjgQWhFS6rovcK5dI6JHnlf
         KI+2ZzBslvkOwq2PEeWwR9ep+zwT7rrBaLcQkBX/RbCQxCxGjt7ypzGich2z8BnjhR4s
         qISIoA1jRnc5m3+Wk56tidUt6Zvx4lRgcTUDITmRZtq2YTrj+l4As3q4u4RtfEQ7SoT7
         8/Xyso6YE9kY7cN+qAtFpwWyWusn8447Xu0ZG8v99Xn2XUxUBz9nVtdjEURfL7YbeTsa
         9byiJ2akf/jQbdqZvhAgyf2enceQnK8WKNOs+E69qt6hTgsUJ4scu6PlzJXpcKyTmULh
         fCVg==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:reply-to:date:in-reply-to:message-id
         :mime-version:references:subject:from:to:cc;
        bh=BdoSnjJxYw1zfGUU/Z7GRrV8PpQo7mVoIG98cidoNPE=;
        b=pW8X3Dbm00fTl1vjGXpS9BB4m4NbrCaIGlwBL4J5EmrmL9OPdSe2dqRNkhOvBKNQn7
         Z3wKg3xaI2Mpz8gzJpzrrse2+eYKyGyUC1MTPE6+8HWdkwHP+t2JU3lO4KsQgC/w5zMR
         dqA30F8VfshJE0OxukI94VfCDMQuVPNroJnV7Rxc+BamvLrUcbsEEswjoKMeIKuMWcp4
         jUR9TeNj2OxD4RSx7QUOAzclUOtk8ReSsbdrPT1AporsJcIo2+M6UmbhecGEM4OWreNF
         Fcy86yEhRz+7nDUMmEyF52JYqSjy/8LMGjjW26+9D7P+HgKIzRGiTY2NQZDXiFUiJnKq
         M0GA==
X-Gm-Message-State: AOAM533jmbxT99KhwniD4tn+/JzpPCb/0WIT7IFCAlnf5u//ch3B/c10
        VyZ1IrLwTyYuoe3CDqa0/zrmNL5CZUs=
X-Google-Smtp-Source: 
 ABdhPJwzgFMPHtpsTuP1bO+XVQ19S4WjrI+kU3mdBgFcxF60m+DI+8eH/lVH69xsBoUWa1oj0/dKVi9rINA=
X-Received: from seanjc798194.pdx.corp.google.com
 ([2620:15c:f:10:ad52:3246:e190:f070])
 (user=seanjc job=sendgmr) by 2002:a25:9a01:: with SMTP id
 x1mr9232033ybn.269.1619225291193;
 Fri, 23 Apr 2021 17:48:11 -0700 (PDT)
Reply-To: Sean Christopherson <seanjc@google.com>
Date: Fri, 23 Apr 2021 17:46:34 -0700
In-Reply-To: <20210424004645.3950558-1-seanjc@google.com>
Message-Id: <20210424004645.3950558-33-seanjc@google.com>
Mime-Version: 1.0
References: <20210424004645.3950558-1-seanjc@google.com>
X-Mailer: git-send-email 2.31.1.498.g6c1eba8ee3d-goog
Subject: [PATCH 32/43] KVM: VMX: Skip pointless MSR bitmap update when setting
 EFER
From: Sean Christopherson <seanjc@google.com>
To: Paolo Bonzini <pbonzini@redhat.com>
Cc: Sean Christopherson <seanjc@google.com>,
        Vitaly Kuznetsov <vkuznets@redhat.com>,
        Wanpeng Li <wanpengli@tencent.com>,
        Jim Mattson <jmattson@google.com>,
        Joerg Roedel <joro@8bytes.org>, kvm@vger.kernel.org,
        linux-kernel@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

Split setup_msrs() into vmx_setup_uret_msrs() and an open coded refresh
of the MSR bitmap, and skip the latter when refreshing the user return
MSRs during an EFER load.  Only the x2APIC MSRs are dynamically exposed
and hidden, and those are not affected by a change in EFER.

Signed-off-by: Sean Christopherson <seanjc@google.com>
---
 arch/x86/kvm/vmx/vmx.c | 19 ++++++++++---------
 1 file changed, 10 insertions(+), 9 deletions(-)

diff --git a/arch/x86/kvm/vmx/vmx.c b/arch/x86/kvm/vmx/vmx.c
index 594975dc3f94..bdfb3def8526 100644
--- a/arch/x86/kvm/vmx/vmx.c
+++ b/arch/x86/kvm/vmx/vmx.c
@@ -1767,11 +1767,12 @@ static void vmx_setup_uret_msr(struct vcpu_vmx *vmx, unsigned int msr)
 }
 
 /*
- * Set up the vmcs to automatically save and restore system
- * msrs.  Don't touch the 64-bit msrs if the guest is in legacy
- * mode, as fiddling with msrs is very expensive.
+ * Configuring user return MSRs to automatically save, load, and restore MSRs
+ * that need to be shoved into hardware when running the guest.  Note, omitting
+ * an MSR here does _NOT_ mean it's not emulated, only that it will not be
+ * loaded into hardware when running the guest.
  */
-static void setup_msrs(struct vcpu_vmx *vmx)
+static void vmx_setup_uret_msrs(struct vcpu_vmx *vmx)
 {
 	vmx->guest_uret_msrs_loaded = false;
 	vmx->nr_active_uret_msrs = 0;
@@ -1793,9 +1794,6 @@ static void setup_msrs(struct vcpu_vmx *vmx)
 		vmx_setup_uret_msr(vmx, MSR_TSC_AUX);
 
 	vmx_setup_uret_msr(vmx, MSR_IA32_TSX_CTRL);
-
-	if (cpu_has_vmx_msr_bitmap())
-		vmx_update_msr_bitmap(&vmx->vcpu);
 }
 
 static u64 vmx_write_l1_tsc_offset(struct kvm_vcpu *vcpu, u64 offset)
@@ -2982,7 +2980,7 @@ int vmx_set_efer(struct kvm_vcpu *vcpu, u64 efer)
 
 		msr->data = efer & ~EFER_LME;
 	}
-	setup_msrs(vmx);
+	vmx_setup_uret_msrs(vmx);
 	return 0;
 }
 
@@ -4572,7 +4570,10 @@ static void vmx_vcpu_reset(struct kvm_vcpu *vcpu, bool init_event)
 	if (kvm_mpx_supported())
 		vmcs_write64(GUEST_BNDCFGS, 0);
 
-	setup_msrs(vmx);
+	vmx_setup_uret_msrs(vmx);
+
+	if (cpu_has_vmx_msr_bitmap())
+		vmx_update_msr_bitmap(&vmx->vcpu);
 
 	vmcs_write32(VM_ENTRY_INTR_INFO_FIELD, 0);  /* 22.2.1 */
 

From patchwork Sat Apr 24 00:46:35 2021
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
X-Patchwork-Submitter: Sean Christopherson <seanjc@google.com>
X-Patchwork-Id: 12222175
Return-Path: <kvm-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-26.3 required=3.0 tests=BAYES_00,DKIMWL_WL_MED,
	DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,
	INCLUDES_CR_TRAILER,INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,
	USER_AGENT_GIT,USER_IN_DEF_DKIM_WL autolearn=ham autolearn_force=no
	version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 0FC57C433B4
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:54:02 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id E617261469
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:54:01 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S244338AbhDXAyg (ORCPT <rfc822;kvm@archiver.kernel.org>);
        Fri, 23 Apr 2021 20:54:36 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:36962 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S244439AbhDXAxI (ORCPT <rfc822;kvm@vger.kernel.org>);
        Fri, 23 Apr 2021 20:53:08 -0400
Received: from mail-yb1-xb49.google.com (mail-yb1-xb49.google.com
 [IPv6:2607:f8b0:4864:20::b49])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 1D2F8C0612F3
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:48:14 -0700 (PDT)
Received: by mail-yb1-xb49.google.com with SMTP id
 z8-20020a2566480000b02904e0f6f67f42so26642977ybm.15
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:48:14 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=google.com; s=20161025;
        h=reply-to:date:in-reply-to:message-id:mime-version:references
         :subject:from:to:cc;
        bh=TyRU0/tPrLYATGQcgqMekR6RRGDcn8BCsFh+kG7e/tE=;
        b=SMY4s4+fzw/1Y2OOxIguwHavAdi/v6k+lTW8DHAFW/hyqvcd0GNmF7lfKiHO9+Ge3G
         ys7y3WcYFwlVue4WsLYkWnrl+8MRYkTkGgFHNBb9HVsTLY5M9daiCJHmnkCWpJuggoks
         5yh6krar0RFaqT+Csqf/4Wx4prEvk8rWonrW6mbzyQ+pla/t8wr7B87c4p6fhn9At2nt
         ZQvq8CQHkQ2M3lCX7tC/8ysu+Rp75vhqs0H2GFCoXktXEVbWbnhOuaYE2n6nnXRHv2PV
         MCGEiE1OFhcPKQC3YDrbURvs68PdwNqGTXuGITfwnEBHOF9QG9EQbvuveedXXaNp1ThU
         GBIg==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:reply-to:date:in-reply-to:message-id
         :mime-version:references:subject:from:to:cc;
        bh=TyRU0/tPrLYATGQcgqMekR6RRGDcn8BCsFh+kG7e/tE=;
        b=Ioy72T8YO84ZPxgOblHMCVFSn9sXmSt0/Ns0SJTcR7/JWFJpkE2ZPtslN9hqGa+qwX
         sl+ID7Xye+bPdovxDNCnWGw7MDs196iHMWacTNnF0/b67IjHwi9q+GSPWxqEbNB1Lwzm
         fy+3+bdMzulN5MRWyo945ZxORTfdVChD+Wyrex6cYdmiz0oPEoybrsDxQakVS3XYwyV0
         A2Z+Rq73HiloWn1s/qgkzokj0YI/Hqepdq634tybcrARZKUywaa8AzsqQxGn/TsTSchf
         z6POpX2RLkJcupQQlXtoxZzM64r1qPpalIGs2PJ3CEAT3UySyVW/nmnIkTCHVPvG8zZ/
         TH2Q==
X-Gm-Message-State: AOAM5303v4I0zYcXmqZso1TtslcJ5Qys8LIaiPf+a7G+8ghhysPhplcG
        hxkw2Iv2Maw5RrGlJXHAfagNrT3HLNo=
X-Google-Smtp-Source: 
 ABdhPJza0fNO9HnQ0aPO3jH9n9Houz3G6gIcPXjHTLM8IC4W4xFSfevYb0Xq8Fxsq9cjUzNMtFJB6ZA38C8=
X-Received: from seanjc798194.pdx.corp.google.com
 ([2620:15c:f:10:ad52:3246:e190:f070])
 (user=seanjc job=sendgmr) by 2002:a25:c444:: with SMTP id
 u65mr9803926ybf.93.1619225293387;
 Fri, 23 Apr 2021 17:48:13 -0700 (PDT)
Reply-To: Sean Christopherson <seanjc@google.com>
Date: Fri, 23 Apr 2021 17:46:35 -0700
In-Reply-To: <20210424004645.3950558-1-seanjc@google.com>
Message-Id: <20210424004645.3950558-34-seanjc@google.com>
Mime-Version: 1.0
References: <20210424004645.3950558-1-seanjc@google.com>
X-Mailer: git-send-email 2.31.1.498.g6c1eba8ee3d-goog
Subject: [PATCH 33/43] KVM: VMX: Refresh list of user return MSRs after
 setting guest CPUID
From: Sean Christopherson <seanjc@google.com>
To: Paolo Bonzini <pbonzini@redhat.com>
Cc: Sean Christopherson <seanjc@google.com>,
        Vitaly Kuznetsov <vkuznets@redhat.com>,
        Wanpeng Li <wanpengli@tencent.com>,
        Jim Mattson <jmattson@google.com>,
        Joerg Roedel <joro@8bytes.org>, kvm@vger.kernel.org,
        linux-kernel@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

After a CPUID update, refresh the list of user return MSRs that are
loaded into hardware when running the vCPU.  This is necessary to handle
the oddball case where userspace exposes X86_FEATURE_RDTSCP to the guest
after the vCPU is running.

Fixes: 0023ef39dc35 ("kvm: vmx: Set IA32_TSC_AUX for legacy mode guests")
Fixes: 4e47c7a6d714 ("KVM: VMX: Add instruction rdtscp support for guest")
Signed-off-by: Sean Christopherson <seanjc@google.com>
---
 arch/x86/kvm/vmx/vmx.c | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/arch/x86/kvm/vmx/vmx.c b/arch/x86/kvm/vmx/vmx.c
index bdfb3def8526..57cabef3ffd9 100644
--- a/arch/x86/kvm/vmx/vmx.c
+++ b/arch/x86/kvm/vmx/vmx.c
@@ -7313,6 +7313,8 @@ static void vmx_vcpu_after_set_cpuid(struct kvm_vcpu *vcpu)
 	/* xsaves_enabled is recomputed in vmx_compute_secondary_exec_control(). */
 	vcpu->arch.xsaves_enabled = false;
 
+	vmx_setup_uret_msrs(vmx);
+
 	if (cpu_has_secondary_exec_ctrls()) {
 		vmx_compute_secondary_exec_control(vmx);
 		vmcs_set_secondary_exec_control(vmx);

From patchwork Sat Apr 24 00:46:36 2021
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
X-Patchwork-Submitter: Sean Christopherson <seanjc@google.com>
X-Patchwork-Id: 12222177
Return-Path: <kvm-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-26.3 required=3.0 tests=BAYES_00,DKIMWL_WL_MED,
	DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,
	INCLUDES_CR_TRAILER,INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,
	USER_AGENT_GIT,USER_IN_DEF_DKIM_WL autolearn=ham autolearn_force=no
	version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 41FC9C43460
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:54:03 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 1F2A761465
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:54:03 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S244403AbhDXAyi (ORCPT <rfc822;kvm@archiver.kernel.org>);
        Fri, 23 Apr 2021 20:54:38 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:37964 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S244469AbhDXAxN (ORCPT <rfc822;kvm@vger.kernel.org>);
        Fri, 23 Apr 2021 20:53:13 -0400
Received: from mail-yb1-xb49.google.com (mail-yb1-xb49.google.com
 [IPv6:2607:f8b0:4864:20::b49])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 6B704C061288
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:48:16 -0700 (PDT)
Received: by mail-yb1-xb49.google.com with SMTP id
 d89-20020a25a3620000b02904dc8d0450c6so26112534ybi.2
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:48:16 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=google.com; s=20161025;
        h=reply-to:date:in-reply-to:message-id:mime-version:references
         :subject:from:to:cc;
        bh=thJRe/zksywSokv9ZmTCndjiPPjEmBU1CAnUpNcr8ss=;
        b=cHaqKGZ0l7MVStxsR4rYVHgGZ2z01asm7gZWaBduBDDkFmUj6dfL07QN1zqBjxx8JT
         SUL5ugEMLYkbiX1iF/FZO28Z8ygEf8sZfZf6zQ8ibXrQDR8N7KCDowMJ8FPq2xPFiCt4
         NesaxKfH/Io25cj+IT/bgWh0pB3AHsU5WL+SKdgozzefTt+lSUkYKQvtuySidncFgxcg
         c3kpQRLrvTVOokNCiHLg68EHDRDW0sETL47HTMf8bXDolpud/6dfxiTYn6MC9uhSaTYx
         vzADYJrJ41W3Qv7pZPuuesMxZJKguolq3gJ/TCAG1ZTzCTj40NamknX+I98ng0DOTla/
         zinw==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:reply-to:date:in-reply-to:message-id
         :mime-version:references:subject:from:to:cc;
        bh=thJRe/zksywSokv9ZmTCndjiPPjEmBU1CAnUpNcr8ss=;
        b=NG1YhOgHU++gvYkaQCrN/6VKWxixdX3DFJmR2bySoDSHpa4Wfpuk8dujydsxtdLSD5
         sgNFgPX/kqS0da+/3def31RkCGT/HRm6UzVRPO4irQq+YPdWeGQ7TgTBZFuVMSrSDRvf
         fds29T1peqOyeLYUZx+k3spdynSQn3pnRaS5PO8lIo+0iXtyh44lRbBV9/yBX/uzmjVh
         a/Hbcp0lCmpZyyMu6LkjrKCOBnmdr6j4etNJey6ixPszrtCAx2c212r+k+yB/SSKEAT2
         A91MIqV2NeC0bcRHtLyCc3XmnX6Yr+XFfF9cHD2BsAUq0UjFfYn8q2ayQr9MEFuRlUgv
         wCpg==
X-Gm-Message-State: AOAM5322AOvasLmFADxkTSrLJFY8XTnuWo7haKGgoFr1SusJBe9o3S7w
        c+KzeU6mUHJ6BZbOb0CoqvH6XfgE0aw=
X-Google-Smtp-Source: 
 ABdhPJy2gKSZmcqpJXKP2OVfsSIMNONflhb75V2hptd/0tJpdTQzlaVYkT3ExAFdPKH/IdY2XmjJCAFvAgg=
X-Received: from seanjc798194.pdx.corp.google.com
 ([2620:15c:f:10:ad52:3246:e190:f070])
 (user=seanjc job=sendgmr) by 2002:a25:38cf:: with SMTP id
 f198mr9254733yba.21.1619225295684;
 Fri, 23 Apr 2021 17:48:15 -0700 (PDT)
Reply-To: Sean Christopherson <seanjc@google.com>
Date: Fri, 23 Apr 2021 17:46:36 -0700
In-Reply-To: <20210424004645.3950558-1-seanjc@google.com>
Message-Id: <20210424004645.3950558-35-seanjc@google.com>
Mime-Version: 1.0
References: <20210424004645.3950558-1-seanjc@google.com>
X-Mailer: git-send-email 2.31.1.498.g6c1eba8ee3d-goog
Subject: [PATCH 34/43] KVM: VMX: Don't _explicitly_ reconfigure user return
 MSRs on vCPU INIT
From: Sean Christopherson <seanjc@google.com>
To: Paolo Bonzini <pbonzini@redhat.com>
Cc: Sean Christopherson <seanjc@google.com>,
        Vitaly Kuznetsov <vkuznets@redhat.com>,
        Wanpeng Li <wanpengli@tencent.com>,
        Jim Mattson <jmattson@google.com>,
        Joerg Roedel <joro@8bytes.org>, kvm@vger.kernel.org,
        linux-kernel@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

When emulating vCPU INIT, do not unconditionally refresh the list of user
return MSRs that need to be loaded into hardware when running the guest.
Unconditionally refreshing the list is confusing, as the vast majority of
MSRs are not modified on INIT.  The real motivation is to handle the case
where an INIT during long mode obviates the need to load the SYSCALL MSRs,
and that is handled as needed by vmx_set_efer().

Signed-off-by: Sean Christopherson <seanjc@google.com>
---
 arch/x86/kvm/vmx/vmx.c | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/arch/x86/kvm/vmx/vmx.c b/arch/x86/kvm/vmx/vmx.c
index 57cabef3ffd9..8c982e049cbb 100644
--- a/arch/x86/kvm/vmx/vmx.c
+++ b/arch/x86/kvm/vmx/vmx.c
@@ -4509,6 +4509,8 @@ static void init_vmcs(struct vcpu_vmx *vmx)
 		vmx->pt_desc.guest.output_mask = 0x7F;
 		vmcs_write64(GUEST_IA32_RTIT_CTL, 0);
 	}
+
+	vmx_setup_uret_msrs(vmx);
 }
 
 static void vmx_vcpu_reset(struct kvm_vcpu *vcpu, bool init_event)
@@ -4570,8 +4572,6 @@ static void vmx_vcpu_reset(struct kvm_vcpu *vcpu, bool init_event)
 	if (kvm_mpx_supported())
 		vmcs_write64(GUEST_BNDCFGS, 0);
 
-	vmx_setup_uret_msrs(vmx);
-
 	if (cpu_has_vmx_msr_bitmap())
 		vmx_update_msr_bitmap(&vmx->vcpu);
 

From patchwork Sat Apr 24 00:46:37 2021
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
X-Patchwork-Submitter: Sean Christopherson <seanjc@google.com>
X-Patchwork-Id: 12222179
Return-Path: <kvm-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-26.3 required=3.0 tests=BAYES_00,DKIMWL_WL_MED,
	DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,
	INCLUDES_CR_TRAILER,INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,
	USER_AGENT_GIT,USER_IN_DEF_DKIM_WL autolearn=ham autolearn_force=no
	version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 5BEFDC433B4
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:54:06 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 4348361467
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:54:06 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S244355AbhDXAyl (ORCPT <rfc822;kvm@archiver.kernel.org>);
        Fri, 23 Apr 2021 20:54:41 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:36976 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S244576AbhDXAxX (ORCPT <rfc822;kvm@vger.kernel.org>);
        Fri, 23 Apr 2021 20:53:23 -0400
Received: from mail-qv1-xf4a.google.com (mail-qv1-xf4a.google.com
 [IPv6:2607:f8b0:4864:20::f4a])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 918C7C061574
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:48:18 -0700 (PDT)
Received: by mail-qv1-xf4a.google.com with SMTP id
 r18-20020a0ccc120000b02901a21aadacfcso17409663qvk.5
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:48:18 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=google.com; s=20161025;
        h=reply-to:date:in-reply-to:message-id:mime-version:references
         :subject:from:to:cc;
        bh=+baILf2lXS2iWNLfTisgtic2CRjWJPJ8uCOLhPpc9SM=;
        b=nmztxv0y6RS5IsfCFItQFXpjcVSs2MxcwJHs9zE4Qs/AQCSej81PHB+CNuIS3XWNRF
         Ls/n88PLlbH+xcoOF3lKpGHR20LCj8fkdTrgGei7O5WxK7+CB6LWWlQvWrXIYLNIT6/j
         G98m3rjapaIF8hKRKdlxlllygjdXnZ2nSdf4bmDIH5nrqNIo21herfLIHPemuwqbdFr9
         P7HiyM9BSsxY2brAkpPL7WYR0EkyuR7darUnbAU8b89NhKyBwiM4GdNml9IJtWccn1lC
         h4JVzW7KWzEvigm9W2yA7Gtu0PCavzqkiSuTZ77K20tnEEFS053AW4Ts640tx2oaHrfj
         2z+Q==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:reply-to:date:in-reply-to:message-id
         :mime-version:references:subject:from:to:cc;
        bh=+baILf2lXS2iWNLfTisgtic2CRjWJPJ8uCOLhPpc9SM=;
        b=KkL9kKSeA5cIHOi+68aWg8veuL4U7erUVEnG2R90unrsDgwwVyCrfCC5k02RJ4OR9K
         GQuvi4O38mxYL3K9c0oiTUeFT0SA+5Gi5HLA36urfzSlT50EjpeyYc3FqqzDv/RlvUi3
         QMpT/GLCSZ9wWkDhis2kVhaCPrPpNy2bSsDnaiexhgv6kQDcK2O3nKV9hBZQKkh5frWH
         1uh41/ifnSGy07pb1W7TM542VcFpdOmqFVK2s0ynTB+ubCpqaQG+HofuN61xU4c4ojef
         XpP8ajt/xdeipHET0/h2SS0urQ0ZIWSm32w2ttTPZr/sQHgC9r/ccSjIE8pT8uJ4TKJR
         Zy1Q==
X-Gm-Message-State: AOAM533tgby36j2jP+KezNVBQhU01rjsI5/GtlR9FahDRS9i+L+P6BLe
        trCRdonvQhQdkgi7I0DllhE2WBPDABo=
X-Google-Smtp-Source: 
 ABdhPJzcHLkaOfdICkyC5H3BnUMovLq0F9V3DSKROkZFnCWd8Ri859BzA6rNRz4oQHCVIpXu3EOFV0KYF3o=
X-Received: from seanjc798194.pdx.corp.google.com
 ([2620:15c:f:10:ad52:3246:e190:f070])
 (user=seanjc job=sendgmr) by 2002:a0c:ea48:: with SMTP id
 u8mr7077384qvp.47.1619225297836;
 Fri, 23 Apr 2021 17:48:17 -0700 (PDT)
Reply-To: Sean Christopherson <seanjc@google.com>
Date: Fri, 23 Apr 2021 17:46:37 -0700
In-Reply-To: <20210424004645.3950558-1-seanjc@google.com>
Message-Id: <20210424004645.3950558-36-seanjc@google.com>
Mime-Version: 1.0
References: <20210424004645.3950558-1-seanjc@google.com>
X-Mailer: git-send-email 2.31.1.498.g6c1eba8ee3d-goog
Subject: [PATCH 35/43] KVM: x86: Move setting of sregs during vCPU RESET/INIT
 to common x86
From: Sean Christopherson <seanjc@google.com>
To: Paolo Bonzini <pbonzini@redhat.com>
Cc: Sean Christopherson <seanjc@google.com>,
        Vitaly Kuznetsov <vkuznets@redhat.com>,
        Wanpeng Li <wanpengli@tencent.com>,
        Jim Mattson <jmattson@google.com>,
        Joerg Roedel <joro@8bytes.org>, kvm@vger.kernel.org,
        linux-kernel@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

Move the setting of CR0, CR4, EFER, RFLAGS, and RIP from vendor code to
common x86.  VMX and SVM now have near-identical sequences, the only
difference between that VMX updates the exception bitmap.  Updating the
bitmap on SVM is unnecessary, but benign.  Unfortunately it can't be left
behind in VMX due to the need to update exception intercepts after the
control registers are set.

Signed-off-by: Sean Christopherson <seanjc@google.com>
---
 arch/x86/kvm/svm/svm.c | 6 ------
 arch/x86/kvm/vmx/vmx.c | 9 ---------
 arch/x86/kvm/x86.c     | 8 ++++++++
 3 files changed, 8 insertions(+), 15 deletions(-)

diff --git a/arch/x86/kvm/svm/svm.c b/arch/x86/kvm/svm/svm.c
index 996a6b03e338..23f880268ff5 100644
--- a/arch/x86/kvm/svm/svm.c
+++ b/arch/x86/kvm/svm/svm.c
@@ -1204,12 +1204,6 @@ static void init_vmcb(struct kvm_vcpu *vcpu)
 	init_sys_seg(&save->ldtr, SEG_TYPE_LDT);
 	init_sys_seg(&save->tr, SEG_TYPE_BUSY_TSS16);
 
-	svm_set_cr0(vcpu, X86_CR0_NW | X86_CR0_CD | X86_CR0_ET);
-	svm_set_cr4(vcpu, 0);
-	svm_set_efer(vcpu, 0);
-	kvm_set_rflags(vcpu, X86_EFLAGS_FIXED);
-	vcpu->arch.regs[VCPU_REGS_RIP] = 0x0000fff0;
-
 	if (npt_enabled) {
 		/* Setup VMCB for Nested Paging */
 		control->nested_ctl |= SVM_NESTED_CTL_NP_ENABLE;
diff --git a/arch/x86/kvm/vmx/vmx.c b/arch/x86/kvm/vmx/vmx.c
index 8c982e049cbb..d8afca144e11 100644
--- a/arch/x86/kvm/vmx/vmx.c
+++ b/arch/x86/kvm/vmx/vmx.c
@@ -4557,9 +4557,6 @@ static void vmx_vcpu_reset(struct kvm_vcpu *vcpu, bool init_event)
 		vmcs_write64(GUEST_IA32_DEBUGCTL, 0);
 	}
 
-	kvm_set_rflags(vcpu, X86_EFLAGS_FIXED);
-	kvm_rip_write(vcpu, 0xfff0);
-
 	vmcs_writel(GUEST_GDTR_BASE, 0);
 	vmcs_write32(GUEST_GDTR_LIMIT, 0xffff);
 
@@ -4587,12 +4584,6 @@ static void vmx_vcpu_reset(struct kvm_vcpu *vcpu, bool init_event)
 
 	kvm_make_request(KVM_REQ_APIC_PAGE_RELOAD, vcpu);
 
-	vmx_set_cr0(vcpu, X86_CR0_NW | X86_CR0_CD | X86_CR0_ET);
-	vmx_set_cr4(vcpu, 0);
-	vmx_set_efer(vcpu, 0);
-
-	vmx_update_exception_bitmap(vcpu);
-
 	vpid_sync_context(vmx->vpid);
 	if (init_event)
 		vmx_clear_hlt(vcpu);
diff --git a/arch/x86/kvm/x86.c b/arch/x86/kvm/x86.c
index 167c650d1187..97d8e3e74bab 100644
--- a/arch/x86/kvm/x86.c
+++ b/arch/x86/kvm/x86.c
@@ -10499,6 +10499,14 @@ void kvm_vcpu_reset(struct kvm_vcpu *vcpu, bool init_event)
 
 	static_call(kvm_x86_vcpu_reset)(vcpu, init_event);
 
+	kvm_set_rflags(vcpu, X86_EFLAGS_FIXED);
+	kvm_rip_write(vcpu, 0xfff0);
+
+	static_call(kvm_x86_set_cr0)(vcpu, X86_CR0_NW | X86_CR0_CD | X86_CR0_ET);
+	static_call(kvm_x86_set_cr4)(vcpu, 0);
+	static_call(kvm_x86_set_efer)(vcpu, 0);
+	static_call(kvm_x86_update_exception_bitmap)(vcpu);
+
 	if (kvm_cr0_mmu_role_changed(old_cr0, kvm_read_cr0(vcpu)) ||
 	    kvm_cr4_mmu_role_changed(old_cr4, kvm_read_cr4(vcpu)))
 		kvm_mmu_reset_context(vcpu);

From patchwork Sat Apr 24 00:46:38 2021
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
X-Patchwork-Submitter: Sean Christopherson <seanjc@google.com>
X-Patchwork-Id: 12222181
Return-Path: <kvm-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-26.3 required=3.0 tests=BAYES_00,DKIMWL_WL_MED,
	DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,
	INCLUDES_CR_TRAILER,INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,
	USER_AGENT_GIT,USER_IN_DEF_DKIM_WL autolearn=ham autolearn_force=no
	version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id AAD9DC433B4
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:54:47 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 85B3761466
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:54:47 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S244615AbhDXAzW (ORCPT <rfc822;kvm@archiver.kernel.org>);
        Fri, 23 Apr 2021 20:55:22 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:38134 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S231386AbhDXAx6 (ORCPT <rfc822;kvm@vger.kernel.org>);
        Fri, 23 Apr 2021 20:53:58 -0400
Received: from mail-yb1-xb4a.google.com (mail-yb1-xb4a.google.com
 [IPv6:2607:f8b0:4864:20::b4a])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id B1C2FC061348
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:48:20 -0700 (PDT)
Received: by mail-yb1-xb4a.google.com with SMTP id
 z8-20020a2566480000b02904e0f6f67f42so26643170ybm.15
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:48:20 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=google.com; s=20161025;
        h=reply-to:date:in-reply-to:message-id:mime-version:references
         :subject:from:to:cc;
        bh=BcYmgJLXkQJJcYxDhmV+A4GdpBicTf4J3kxojsPseyo=;
        b=CkSStvVOFxviRKV+zeGALhdHXccSceIl2sr98P3tZy650GVaj0sQy5ieQPo/t2KLJo
         5v1FpyJ0OMXg6VXwre4dIh5nrK3KgRXukeHn6zm8sZEoSK2ByrWKFN/dUvy/Jbs+Spvu
         jMCGW1jwHMYaxR0heiH7N5RQMqKqzu0gTxikWQqbpEbYmWM7SzxHYstdrFYD79txgbwj
         dxxn0jTwkmjRFnYyub1TsVNZP8oGXmYQxYyQbUn5kNzrWsj+xpX/Tmzcvde1twUk9DCr
         x/IV3jz3b5CVtNgXRaLSyCRdP7CQWi0xst3mfobqRB1r4PbibfTNL5JSF3GTgH04Upoo
         93zQ==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:reply-to:date:in-reply-to:message-id
         :mime-version:references:subject:from:to:cc;
        bh=BcYmgJLXkQJJcYxDhmV+A4GdpBicTf4J3kxojsPseyo=;
        b=ZwTo8oq3pQz1yZYZI23g/yeo7gkDSG66rMZKp0MvNFa1g+zp62qDPIBGYZtM4HTDe6
         RIOmj48xUvZ1JxH5HVArCaZ+QGIB3rdN/KytiIW1xHy6PvvYf7ozqYupSYBy+Uy/p5Be
         j7KQxiXH8x8Swr44Dx6mQh1uaviVHWLtwdThiHCSlXvtrkDNS/ADQh1i0+8sjBH4C50w
         02XfCXR1HKvxo09pxQbLMq11IhoXgimNe2ygB7h8TSgEA56CnsnGkvlr8v8w1k+TC//f
         fZzLYF/iIhdahVv5tzAOybmtR7etQzVVhqebqft949ikEJT9/ZzxQsUrmvdyhD4NsSAB
         uSpQ==
X-Gm-Message-State: AOAM5316Vuvvg2eHhez2gwCHXoklt8TJ9/kJDrTGwPSYwlpmD+noY/pt
        qKS0xz1/cMSTbVQELYDAdH+4qka6ZnE=
X-Google-Smtp-Source: 
 ABdhPJxPz+ZvsI4LIrFC6DUqitf0LoKkGuy4DdYbdSzXPOowIoEHdn/pCCh8TRClkQta0zaSCIJ+pF8yshQ=
X-Received: from seanjc798194.pdx.corp.google.com
 ([2620:15c:f:10:ad52:3246:e190:f070])
 (user=seanjc job=sendgmr) by 2002:a05:6902:687:: with SMTP id
 i7mr8699935ybt.310.1619225299999; Fri, 23 Apr 2021 17:48:19 -0700 (PDT)
Reply-To: Sean Christopherson <seanjc@google.com>
Date: Fri, 23 Apr 2021 17:46:38 -0700
In-Reply-To: <20210424004645.3950558-1-seanjc@google.com>
Message-Id: <20210424004645.3950558-37-seanjc@google.com>
Mime-Version: 1.0
References: <20210424004645.3950558-1-seanjc@google.com>
X-Mailer: git-send-email 2.31.1.498.g6c1eba8ee3d-goog
Subject: [PATCH 36/43] KVM: VMX: Remove obsolete MSR bitmap refresh at vCPU
 RESET/INIT
From: Sean Christopherson <seanjc@google.com>
To: Paolo Bonzini <pbonzini@redhat.com>
Cc: Sean Christopherson <seanjc@google.com>,
        Vitaly Kuznetsov <vkuznets@redhat.com>,
        Wanpeng Li <wanpengli@tencent.com>,
        Jim Mattson <jmattson@google.com>,
        Joerg Roedel <joro@8bytes.org>, kvm@vger.kernel.org,
        linux-kernel@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

Remove an unnecessary MSR bitmap refresh during vCPU RESET/INIT.  In both
cases, the MSR bitmap already has the desired values and state.

At RESET, the vCPU is guaranteed to be running with x2APIC disabled, the
x2APIC MSRs are guaranteed to be intercepted due to the MSR bitmap being
initialized to all ones by alloc_loaded_vmcs(), and vmx->msr_bitmap_mode
is guaranteed to be zero, i.e. reflecting x2APIC disabled.

At INIT, the APIC_BASE MSR is not modified, thus there can't be any
change in x2APIC state.

Signed-off-by: Sean Christopherson <seanjc@google.com>
---
 arch/x86/kvm/vmx/vmx.c | 3 ---
 1 file changed, 3 deletions(-)

diff --git a/arch/x86/kvm/vmx/vmx.c b/arch/x86/kvm/vmx/vmx.c
index d8afca144e11..acfb87f30979 100644
--- a/arch/x86/kvm/vmx/vmx.c
+++ b/arch/x86/kvm/vmx/vmx.c
@@ -4569,9 +4569,6 @@ static void vmx_vcpu_reset(struct kvm_vcpu *vcpu, bool init_event)
 	if (kvm_mpx_supported())
 		vmcs_write64(GUEST_BNDCFGS, 0);
 
-	if (cpu_has_vmx_msr_bitmap())
-		vmx_update_msr_bitmap(&vmx->vcpu);
-
 	vmcs_write32(VM_ENTRY_INTR_INFO_FIELD, 0);  /* 22.2.1 */
 
 	if (cpu_has_vmx_tpr_shadow() && !init_event) {

From patchwork Sat Apr 24 00:46:39 2021
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
X-Patchwork-Submitter: Sean Christopherson <seanjc@google.com>
X-Patchwork-Id: 12222183
Return-Path: <kvm-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-26.3 required=3.0 tests=BAYES_00,DKIMWL_WL_MED,
	DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,
	INCLUDES_CR_TRAILER,INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,
	USER_AGENT_GIT,USER_IN_DEF_DKIM_WL autolearn=ham autolearn_force=no
	version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id E2DDCC433ED
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:55:06 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id BE99861466
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:55:06 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S244646AbhDXAzj (ORCPT <rfc822;kvm@archiver.kernel.org>);
        Fri, 23 Apr 2021 20:55:39 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:38202 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S244653AbhDXAyR (ORCPT <rfc822;kvm@vger.kernel.org>);
        Fri, 23 Apr 2021 20:54:17 -0400
Received: from mail-qk1-x749.google.com (mail-qk1-x749.google.com
 [IPv6:2607:f8b0:4864:20::749])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id CCEDDC061756
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:48:22 -0700 (PDT)
Received: by mail-qk1-x749.google.com with SMTP id
 q5-20020a05620a0c85b02902e004d74d8cso15763858qki.16
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:48:22 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=google.com; s=20161025;
        h=reply-to:date:in-reply-to:message-id:mime-version:references
         :subject:from:to:cc;
        bh=zLhT1Olw4w4A/z5QqS68fw+vGniyRMY+4zsyez+hxb8=;
        b=X/6DdF5y6jftvjVQXXyHqgICC6xuwcEmdwIrGhWdI/3AA4IADr9ArY/5Jq5XZ1oAbh
         8ixRUMsqk+4xeYynvXcrkDb/B7vOYJ8NT8LbkbswduKbml2KNWufSoE4F5+dhO9tgo+4
         eEnW+bD9DdCzvHbuoWRej9KL9UubtQnnmdTqkXDPVnZdJ0ExfO3inh1btsCY8JPmFdss
         /Br/Yx/m3eSEniFgzGCeQjGfy0EVCzsQoGTby5iGu9Gq7LyXI5YEKxJBa7FFYbiE45lE
         C4xmu9fk9NSLHc3st2IBYkyRxnuVdD5vu4ipAlWJ7to5vKrsQ/A3XZDOjxjHsILaSUdl
         eFBQ==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:reply-to:date:in-reply-to:message-id
         :mime-version:references:subject:from:to:cc;
        bh=zLhT1Olw4w4A/z5QqS68fw+vGniyRMY+4zsyez+hxb8=;
        b=M29kO/0buHhY4XZOdkFgPVkwi/lpYhrf3kN59F9+lfwo4uU2ndQBM9t3Bho2jntan+
         e6pMCMTsBylW2GdvQ/9peenemHdqKmB51rJWj36ZDSMC8MvOBBAqHRYsVmWPRZ8cdeU1
         Bg/nxfnyZrRx0I0BmtKlowa8REIyZR5FzI9iLf+UOfcfZ2lCMdG3J0xNIdT2oV79JVM1
         Loqleek4v3sh1Ip8crjjxxeOtr7eqISyYSE4bS2VucCqRTXLW9ur4PU4yUWCBlnuBkNv
         g2EPFGxDrJ3rimgD/WVN88fr7jj8+AFkusWPTByQAAiDyYSugprG1UTKF75KMS65Xr/M
         S4Gg==
X-Gm-Message-State: AOAM532JXW6fdEHFLTWIBHL2F8UbLwZLK+d1SdJE23//W814KhuOcOAT
        PfoPRfbI/TINyuGJ0CEDr9FXj1PN7DY=
X-Google-Smtp-Source: 
 ABdhPJxREhJpQW8HpLyftkLk1ST20DVpT+NSBMDlbnY/lcznsryFA5sIGYAngsDKucwdsBX/xRGDO9Tn/8U=
X-Received: from seanjc798194.pdx.corp.google.com
 ([2620:15c:f:10:ad52:3246:e190:f070])
 (user=seanjc job=sendgmr) by 2002:a0c:ec4b:: with SMTP id
 n11mr7248572qvq.6.1619225302028;
 Fri, 23 Apr 2021 17:48:22 -0700 (PDT)
Reply-To: Sean Christopherson <seanjc@google.com>
Date: Fri, 23 Apr 2021 17:46:39 -0700
In-Reply-To: <20210424004645.3950558-1-seanjc@google.com>
Message-Id: <20210424004645.3950558-38-seanjc@google.com>
Mime-Version: 1.0
References: <20210424004645.3950558-1-seanjc@google.com>
X-Mailer: git-send-email 2.31.1.498.g6c1eba8ee3d-goog
Subject: [PATCH 37/43] KVM: nVMX: Remove obsolete MSR bitmap refresh at nested
 transitions
From: Sean Christopherson <seanjc@google.com>
To: Paolo Bonzini <pbonzini@redhat.com>
Cc: Sean Christopherson <seanjc@google.com>,
        Vitaly Kuznetsov <vkuznets@redhat.com>,
        Wanpeng Li <wanpengli@tencent.com>,
        Jim Mattson <jmattson@google.com>,
        Joerg Roedel <joro@8bytes.org>, kvm@vger.kernel.org,
        linux-kernel@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

Drop unnecessary MSR bitmap updates during nested transitions, as L1's
APIC_BASE MSR is not modified by the standard VM-Enter/VM-Exit flows,
and L2's MSR bitmap is managed separately.  In the unlikely event that L1
is pathological and loads APIC_BASE via the VM-Exit load list, KVM will
handle updating the bitmap in its normal WRMSR flows.

Signed-off-by: Sean Christopherson <seanjc@google.com>
---
 arch/x86/kvm/vmx/nested.c | 6 ------
 arch/x86/kvm/vmx/vmx.c    | 2 +-
 arch/x86/kvm/vmx/vmx.h    | 1 -
 3 files changed, 1 insertion(+), 8 deletions(-)

diff --git a/arch/x86/kvm/vmx/nested.c b/arch/x86/kvm/vmx/nested.c
index f811bb7f2dc3..9dcdf158a405 100644
--- a/arch/x86/kvm/vmx/nested.c
+++ b/arch/x86/kvm/vmx/nested.c
@@ -4283,9 +4283,6 @@ static void load_vmcs12_host_state(struct kvm_vcpu *vcpu,
 	kvm_set_dr(vcpu, 7, 0x400);
 	vmcs_write64(GUEST_IA32_DEBUGCTL, 0);
 
-	if (cpu_has_vmx_msr_bitmap())
-		vmx_update_msr_bitmap(vcpu);
-
 	if (nested_vmx_load_msr(vcpu, vmcs12->vm_exit_msr_load_addr,
 				vmcs12->vm_exit_msr_load_count))
 		nested_vmx_abort(vcpu, VMX_ABORT_LOAD_HOST_MSR_FAIL);
@@ -4364,9 +4361,6 @@ static void nested_vmx_restore_host_state(struct kvm_vcpu *vcpu)
 
 	kvm_mmu_reset_context(vcpu);
 
-	if (cpu_has_vmx_msr_bitmap())
-		vmx_update_msr_bitmap(vcpu);
-
 	/*
 	 * This nasty bit of open coding is a compromise between blindly
 	 * loading L1's MSRs using the exit load lists (incorrect emulation
diff --git a/arch/x86/kvm/vmx/vmx.c b/arch/x86/kvm/vmx/vmx.c
index acfb87f30979..45a013631f63 100644
--- a/arch/x86/kvm/vmx/vmx.c
+++ b/arch/x86/kvm/vmx/vmx.c
@@ -3984,7 +3984,7 @@ static void vmx_update_msr_bitmap_x2apic(struct kvm_vcpu *vcpu, u8 mode)
 	}
 }
 
-void vmx_update_msr_bitmap(struct kvm_vcpu *vcpu)
+static void vmx_update_msr_bitmap(struct kvm_vcpu *vcpu)
 {
 	struct vcpu_vmx *vmx = to_vmx(vcpu);
 	u8 mode = vmx_msr_bitmap_mode(vcpu);
diff --git a/arch/x86/kvm/vmx/vmx.h b/arch/x86/kvm/vmx/vmx.h
index 1283ad0e592d..e46df3253a21 100644
--- a/arch/x86/kvm/vmx/vmx.h
+++ b/arch/x86/kvm/vmx/vmx.h
@@ -380,7 +380,6 @@ void __vmx_set_segment(struct kvm_vcpu *vcpu, struct kvm_segment *var, int seg);
 u64 construct_eptp(struct kvm_vcpu *vcpu, hpa_t root_hpa, int root_level);
 
 void vmx_update_exception_bitmap(struct kvm_vcpu *vcpu);
-void vmx_update_msr_bitmap(struct kvm_vcpu *vcpu);
 bool vmx_nmi_blocked(struct kvm_vcpu *vcpu);
 bool vmx_interrupt_blocked(struct kvm_vcpu *vcpu);
 bool vmx_get_nmi_mask(struct kvm_vcpu *vcpu);

From patchwork Sat Apr 24 00:46:40 2021
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
X-Patchwork-Submitter: Sean Christopherson <seanjc@google.com>
X-Patchwork-Id: 12222185
Return-Path: <kvm-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-26.3 required=3.0 tests=BAYES_00,DKIMWL_WL_MED,
	DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,
	INCLUDES_CR_TRAILER,INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,
	USER_AGENT_GIT,USER_IN_DEF_DKIM_WL autolearn=ham autolearn_force=no
	version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id DA563C433B4
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:55:10 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id BB8A561465
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:55:10 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S244667AbhDXAzp (ORCPT <rfc822;kvm@archiver.kernel.org>);
        Fri, 23 Apr 2021 20:55:45 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:38226 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S244669AbhDXAyW (ORCPT <rfc822;kvm@vger.kernel.org>);
        Fri, 23 Apr 2021 20:54:22 -0400
Received: from mail-yb1-xb4a.google.com (mail-yb1-xb4a.google.com
 [IPv6:2607:f8b0:4864:20::b4a])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id D4C9BC0612A5
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:48:24 -0700 (PDT)
Received: by mail-yb1-xb4a.google.com with SMTP id
 7-20020a5b01070000b02904ed6442e5f6so3085037ybx.23
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:48:24 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=google.com; s=20161025;
        h=reply-to:date:in-reply-to:message-id:mime-version:references
         :subject:from:to:cc;
        bh=oyVUQsNf2XbjaOTtJporiUactMrDu8dgH9+VujzngIc=;
        b=i2htVs7R+LB4UeHXF7qO4pwcNIptJJ2+4/sMOE4V28rul7Vr3jf37UUAx9N08ahTtq
         v/MjJRGHgVPMSPSz+RTrfc+dZE2UWQOXKgsoSEpipjHh3FjnOeq2mO/KKSIGIL6Bg5Eh
         lyao12REP5QCPRsqu0O1nK4+xpCGupMZ/nNVeIUPYFKZsEnOnm/RbtxufQJB1qn7bSgn
         B4eAqoSQium9JVDnDY6qhcvuedHreP/rTEhJKptxS0eZW0yGjEGagcV9KGujZrC7hfpL
         Bwg4B9+f+OecO3j8HnoT2/K54seMd79FF3Fo0ZEGPG0u1JhGkdht5HrEqj0+NF/TOD+3
         PDnw==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:reply-to:date:in-reply-to:message-id
         :mime-version:references:subject:from:to:cc;
        bh=oyVUQsNf2XbjaOTtJporiUactMrDu8dgH9+VujzngIc=;
        b=jB7/z9G8LgXtaZhm1bWjao90qEH3Tei4vKUDW3Zx/r8z/dpXtYr9y0v9E3W+6rF3PG
         ECNFiC7hgk58IMbaT+ab+PMj5PuHWr1+IUkoWr+rBkmi9CttdMHcq30Zqb8pHRQDZgki
         2JyBPFZ1XFWOFAJ4ZAsZv3ZOw+i+carWUxxIuxqyp1dTcLjFOvaqAKgoj4RkkuQj4hqN
         ff3EEKajsnQi11AeB2IU36EM4spHDLHt+rifYvVe8esFXPWRy0gHBusMnSaXd21qeFXX
         28jVDPP3YfJYSLftEMA9gR7PMiRDbbtBXgf2SlwDYr7NSHSrSfBgJQqN5DCzWvuhGd52
         VeGw==
X-Gm-Message-State: AOAM531GPwVGNvYnNLy2zE+ckw/dH00j1pzt4cnjtSI9QAoO2otv7rCy
        +/f7gWVu0Dgg29AD2e4cpHmCuoBaQKU=
X-Google-Smtp-Source: 
 ABdhPJzHBq0sbNM2r7DOXFRJi+6RJhB/VG+TDbd1QTSuIvUr1Dy5UE8zNRs1SBS7+weybKMIxtBBMirt5sE=
X-Received: from seanjc798194.pdx.corp.google.com
 ([2620:15c:f:10:ad52:3246:e190:f070])
 (user=seanjc job=sendgmr) by 2002:a25:a265:: with SMTP id
 b92mr9083215ybi.486.1619225304165;
 Fri, 23 Apr 2021 17:48:24 -0700 (PDT)
Reply-To: Sean Christopherson <seanjc@google.com>
Date: Fri, 23 Apr 2021 17:46:40 -0700
In-Reply-To: <20210424004645.3950558-1-seanjc@google.com>
Message-Id: <20210424004645.3950558-39-seanjc@google.com>
Mime-Version: 1.0
References: <20210424004645.3950558-1-seanjc@google.com>
X-Mailer: git-send-email 2.31.1.498.g6c1eba8ee3d-goog
Subject: [PATCH 38/43] KVM: VMX: Don't redo x2APIC MSR bitmaps when userspace
 filter is changed
From: Sean Christopherson <seanjc@google.com>
To: Paolo Bonzini <pbonzini@redhat.com>
Cc: Sean Christopherson <seanjc@google.com>,
        Vitaly Kuznetsov <vkuznets@redhat.com>,
        Wanpeng Li <wanpengli@tencent.com>,
        Jim Mattson <jmattson@google.com>,
        Joerg Roedel <joro@8bytes.org>, kvm@vger.kernel.org,
        linux-kernel@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

Drop an explicit call to update the x2APIC MSRs when the userspace MSR
filter is modified.  The x2APIC MSRs are deliberately exempt from
userspace filtering.

Signed-off-by: Sean Christopherson <seanjc@google.com>
---
 arch/x86/kvm/vmx/vmx.c | 1 -
 1 file changed, 1 deletion(-)

diff --git a/arch/x86/kvm/vmx/vmx.c b/arch/x86/kvm/vmx/vmx.c
index 45a013631f63..beaf9fefddad 100644
--- a/arch/x86/kvm/vmx/vmx.c
+++ b/arch/x86/kvm/vmx/vmx.c
@@ -4055,7 +4055,6 @@ static void vmx_msr_filter_changed(struct kvm_vcpu *vcpu)
 	}
 
 	pt_update_intercept_for_msr(vcpu);
-	vmx_update_msr_bitmap_x2apic(vcpu, vmx_msr_bitmap_mode(vcpu));
 }
 
 static inline bool kvm_vcpu_trigger_posted_interrupt(struct kvm_vcpu *vcpu,

From patchwork Sat Apr 24 00:46:41 2021
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
X-Patchwork-Submitter: Sean Christopherson <seanjc@google.com>
X-Patchwork-Id: 12222187
Return-Path: <kvm-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-26.3 required=3.0 tests=BAYES_00,DKIMWL_WL_MED,
	DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,
	INCLUDES_CR_TRAILER,INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,
	USER_AGENT_GIT,USER_IN_DEF_DKIM_WL autolearn=ham autolearn_force=no
	version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 6BEEEC433ED
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:55:14 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 5126C6146B
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:55:14 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S244187AbhDXAzs (ORCPT <rfc822;kvm@archiver.kernel.org>);
        Fri, 23 Apr 2021 20:55:48 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:37920 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S244674AbhDXAyX (ORCPT <rfc822;kvm@vger.kernel.org>);
        Fri, 23 Apr 2021 20:54:23 -0400
Received: from mail-yb1-xb49.google.com (mail-yb1-xb49.google.com
 [IPv6:2607:f8b0:4864:20::b49])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 42682C0612A7
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:48:27 -0700 (PDT)
Received: by mail-yb1-xb49.google.com with SMTP id
 s34-20020a252d620000b02904e34d3a48abso26210576ybe.13
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:48:27 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=google.com; s=20161025;
        h=reply-to:date:in-reply-to:message-id:mime-version:references
         :subject:from:to:cc;
        bh=cHlwUSJUjHnQJ6kDK9sfUkfBgeAVcW+1jr4rnQYo1Ko=;
        b=fumK39euhhCQk2484+Hwff7kn91tSshSd9Oao+wPZHIv/x6YICMBz2CGSs2lqBhgJo
         RRSVdlnliIu3d5znNnEiGxMnWYvfq0A+0gfcvNZaz2ejSvhpOSfYlP7nXCW0tMkPei7y
         IA9nlGv4r/dckLaQYT/H5SYXrYoxyPPLLYB2oTteq7Em6/H4stXp2fzofJ0qBVGHDXco
         QeTDQrA9HBw0K2njlFLzyx6OyFGmgcb04pshJi/ZCdb3p9rSFhHVLTSP8LDexL1A1Cl5
         wAJ2sdlqS2/P73F1uOHSYq45NGO+BN133HuQg0l52L/Tgdm81DVYlynl3j3zWGy/4+qS
         uPQg==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:reply-to:date:in-reply-to:message-id
         :mime-version:references:subject:from:to:cc;
        bh=cHlwUSJUjHnQJ6kDK9sfUkfBgeAVcW+1jr4rnQYo1Ko=;
        b=WDbsiaTcnMZ3SgovGBcYNX/bkLLFBAOWfrV3NejRgHg/Qddo0eOfabok8ImjqAPFep
         DMKwzu503fV9IoIlWyRAtAgNikHpC3Ypmtdkmv2GtpjRniChdKdkEdMDR12LGEFFVZsM
         YLzT/DSbmLfE+E5nH/OmuYY6o7COAux4lalEnhuLtOaSH2wmqJJa/VP/2iAQUk0/mqCb
         YPlq++W7H6JiRif3HSXQ63MFBLRgZGpP1M1k5XUIHAsnKxDDg1OU1sMvLi1zy2BOEiUy
         qUl8UIRnNWv2TnxAX/7aDyGIhBU0x3eT1T+Sba35G+j8wp/QkRnOz9fbigIlBElHyAQK
         qz/w==
X-Gm-Message-State: AOAM530qxbjDepYL9zfiYyb+y/xYpgoKnygrVPUV0UzXKGGXKzirQmF6
        VHjn3uYfTwKasOihR0M234i5wFi0QrE=
X-Google-Smtp-Source: 
 ABdhPJywoeVodiv4R9BqMCGeljzHV7ruPDnZWCAYDPfKq7hCQsoy3MFsMAmsat+0vbkVlsG6vvps6QRMv4Y=
X-Received: from seanjc798194.pdx.corp.google.com
 ([2620:15c:f:10:ad52:3246:e190:f070])
 (user=seanjc job=sendgmr) by 2002:a25:4bc6:: with SMTP id
 y189mr9589994yba.14.1619225306532;
 Fri, 23 Apr 2021 17:48:26 -0700 (PDT)
Reply-To: Sean Christopherson <seanjc@google.com>
Date: Fri, 23 Apr 2021 17:46:41 -0700
In-Reply-To: <20210424004645.3950558-1-seanjc@google.com>
Message-Id: <20210424004645.3950558-40-seanjc@google.com>
Mime-Version: 1.0
References: <20210424004645.3950558-1-seanjc@google.com>
X-Mailer: git-send-email 2.31.1.498.g6c1eba8ee3d-goog
Subject: [PATCH 39/43] KVM: VMX: Remove unnecessary initialization of
 msr_bitmap_mode
From: Sean Christopherson <seanjc@google.com>
To: Paolo Bonzini <pbonzini@redhat.com>
Cc: Sean Christopherson <seanjc@google.com>,
        Vitaly Kuznetsov <vkuznets@redhat.com>,
        Wanpeng Li <wanpengli@tencent.com>,
        Jim Mattson <jmattson@google.com>,
        Joerg Roedel <joro@8bytes.org>, kvm@vger.kernel.org,
        linux-kernel@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

Don't bother initializing msr_bitmap_mode to 0, all of struct vcpu_vmx is
zero initialized.

No functional change intended.

Signed-off-by: Sean Christopherson <seanjc@google.com>
---
 arch/x86/kvm/vmx/vmx.c | 1 -
 1 file changed, 1 deletion(-)

diff --git a/arch/x86/kvm/vmx/vmx.c b/arch/x86/kvm/vmx/vmx.c
index beaf9fefddad..cfd986aae7b7 100644
--- a/arch/x86/kvm/vmx/vmx.c
+++ b/arch/x86/kvm/vmx/vmx.c
@@ -6982,7 +6982,6 @@ static int vmx_create_vcpu(struct kvm_vcpu *vcpu)
 		vmx_disable_intercept_for_msr(vcpu, MSR_CORE_C6_RESIDENCY, MSR_TYPE_R);
 		vmx_disable_intercept_for_msr(vcpu, MSR_CORE_C7_RESIDENCY, MSR_TYPE_R);
 	}
-	vmx->msr_bitmap_mode = 0;
 
 	vmx->loaded_vmcs = &vmx->vmcs01;
 

From patchwork Sat Apr 24 00:46:42 2021
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
X-Patchwork-Submitter: Sean Christopherson <seanjc@google.com>
X-Patchwork-Id: 12222189
Return-Path: <kvm-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-26.3 required=3.0 tests=BAYES_00,DKIMWL_WL_MED,
	DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,
	INCLUDES_CR_TRAILER,INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,
	USER_AGENT_GIT,USER_IN_DEF_DKIM_WL autolearn=ham autolearn_force=no
	version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 1DD89C433B4
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:55:18 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id D8F706146B
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:55:17 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S244717AbhDXAzw (ORCPT <rfc822;kvm@archiver.kernel.org>);
        Fri, 23 Apr 2021 20:55:52 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:38240 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S244694AbhDXAyZ (ORCPT <rfc822;kvm@vger.kernel.org>);
        Fri, 23 Apr 2021 20:54:25 -0400
Received: from mail-yb1-xb49.google.com (mail-yb1-xb49.google.com
 [IPv6:2607:f8b0:4864:20::b49])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 7DBDBC0612AC
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:48:29 -0700 (PDT)
Received: by mail-yb1-xb49.google.com with SMTP id
 7-20020a5b01070000b02904ed6442e5f6so3085175ybx.23
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:48:29 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=google.com; s=20161025;
        h=reply-to:date:in-reply-to:message-id:mime-version:references
         :subject:from:to:cc;
        bh=+Lg1qMt4LiK9E6pFHFmoygD2uVA+jxYyMvXAcTg1YjI=;
        b=ol3vBedZlUOiXLMeWSQueWzfhA1I86+zrk74vxi0p/x6/cDCEFT+WIWcj3svtmBKCE
         cy7J7VLH4YnnfcaLJffk+Jj68mx53LWZc28CGxUUmAPizMAeoL531mu5zjGAoS7o1XHR
         J+13RzhV8MB1ySyxzcNmgDaBBhxGQiACZjBd4/1UtJR8wANr0OkjMd5qiYpCYhMXHhXH
         Gg1ltRfv9uWgJw7/h61TiqnhopWbBIxE7XeHjLRPEeCJJUWZAyNjBZJxQSqYaXdnqbs4
         dUHMX1pQ1wqwzauXI4UY/GG7GbpGVrLE+nYWe010QUBnnWZwcwQPj91XzdAL46Yy4RT8
         f1mg==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:reply-to:date:in-reply-to:message-id
         :mime-version:references:subject:from:to:cc;
        bh=+Lg1qMt4LiK9E6pFHFmoygD2uVA+jxYyMvXAcTg1YjI=;
        b=kLUYdWIIKxf3AfjHJuHadldkFnDa4oHoMN10XygBp6tklG43GUTsfXE55l6wcH71Hj
         c8rfMdc1KcUva3x30KlMKxqWsX/Erqa4iw60tBo2Deac4VxajwG8UjD7JrzSg6dodS9a
         jwRpwsj04gLjAJN+D4/CeBFbfEjuB8KfGm/lRtEDKqpLi+GJRvgFIPzJCDH3UmDYaKor
         z5Bm1QEaxwRsWFaDdlLDXCi/IUXYR0wQ2pjrrwLyBrtwfZQbQ3Dl31YzziWybqphAoKd
         IlxJ8HAhar767O33EgpUvn/x72iM9XFMsyJsP4XjUS27S4r9OhWuCYF1i1JKUVYnJNl7
         Q7nA==
X-Gm-Message-State: AOAM531AvRMu9SJUhEz0B6saDoolAxo3vagMB7xi1y3NZchZOVKX2N35
        MeborJzuy4pPOYoYt9b/WmL09awUJok=
X-Google-Smtp-Source: 
 ABdhPJyZdkyyiJXWKBXuNajpdy4djv2ChoL9WWVdCG5+m/m4TEr9b0ozloXGpMlLFOs8Ts9tXz0YPB0yyQU=
X-Received: from seanjc798194.pdx.corp.google.com
 ([2620:15c:f:10:ad52:3246:e190:f070])
 (user=seanjc job=sendgmr) by 2002:a25:f311:: with SMTP id
 c17mr8630747ybs.189.1619225308794;
 Fri, 23 Apr 2021 17:48:28 -0700 (PDT)
Reply-To: Sean Christopherson <seanjc@google.com>
Date: Fri, 23 Apr 2021 17:46:42 -0700
In-Reply-To: <20210424004645.3950558-1-seanjc@google.com>
Message-Id: <20210424004645.3950558-41-seanjc@google.com>
Mime-Version: 1.0
References: <20210424004645.3950558-1-seanjc@google.com>
X-Mailer: git-send-email 2.31.1.498.g6c1eba8ee3d-goog
Subject: [PATCH 40/43] KVM: VMX: Smush x2APIC MSR bitmap adjustments into
 single function
From: Sean Christopherson <seanjc@google.com>
To: Paolo Bonzini <pbonzini@redhat.com>
Cc: Sean Christopherson <seanjc@google.com>,
        Vitaly Kuznetsov <vkuznets@redhat.com>,
        Wanpeng Li <wanpengli@tencent.com>,
        Jim Mattson <jmattson@google.com>,
        Joerg Roedel <joro@8bytes.org>, kvm@vger.kernel.org,
        linux-kernel@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

Consolidate all of the dynamic MSR bitmap adjustments into
vmx_update_msr_bitmap_x2apic(), and rename the mode tracker to reflect
that it is x2APIC specific.  If KVM gains more cases of dynamic MSR
pass-through, odds are very good that those new cases will be better off
with their own logic, e.g. see Intel PT MSRs and MSR_IA32_SPEC_CTRL.

Attempting to handle all updates in a common helper did more harm than
good, as KVM ended up collecting a large number of useless "updates".

Signed-off-by: Sean Christopherson <seanjc@google.com>
---
 arch/x86/kvm/vmx/vmx.c | 55 ++++++++++++++++--------------------------
 arch/x86/kvm/vmx/vmx.h |  2 +-
 2 files changed, 22 insertions(+), 35 deletions(-)

diff --git a/arch/x86/kvm/vmx/vmx.c b/arch/x86/kvm/vmx/vmx.c
index cfd986aae7b7..dcef189b0108 100644
--- a/arch/x86/kvm/vmx/vmx.c
+++ b/arch/x86/kvm/vmx/vmx.c
@@ -3931,21 +3931,6 @@ void vmx_set_intercept_for_msr(struct kvm_vcpu *vcpu,
 		vmx_disable_intercept_for_msr(vcpu, msr, type);
 }
 
-static u8 vmx_msr_bitmap_mode(struct kvm_vcpu *vcpu)
-{
-	u8 mode = 0;
-
-	if (cpu_has_secondary_exec_ctrls() &&
-	    (secondary_exec_controls_get(to_vmx(vcpu)) &
-	     SECONDARY_EXEC_VIRTUALIZE_X2APIC_MODE)) {
-		mode |= MSR_BITMAP_MODE_X2APIC;
-		if (enable_apicv && kvm_vcpu_apicv_active(vcpu))
-			mode |= MSR_BITMAP_MODE_X2APIC_APICV;
-	}
-
-	return mode;
-}
-
 static void vmx_reset_x2apic_msrs(struct kvm_vcpu *vcpu, u8 mode)
 {
 	unsigned long *msr_bitmap = to_vmx(vcpu)->vmcs01.msr_bitmap;
@@ -3963,11 +3948,29 @@ static void vmx_reset_x2apic_msrs(struct kvm_vcpu *vcpu, u8 mode)
 	}
 }
 
-static void vmx_update_msr_bitmap_x2apic(struct kvm_vcpu *vcpu, u8 mode)
+static void vmx_update_msr_bitmap_x2apic(struct kvm_vcpu *vcpu)
 {
+	struct vcpu_vmx *vmx = to_vmx(vcpu);
+	u8 mode;
+
 	if (!cpu_has_vmx_msr_bitmap())
 		return;
 
+	if (cpu_has_secondary_exec_ctrls() &&
+	    (secondary_exec_controls_get(vmx) &
+	     SECONDARY_EXEC_VIRTUALIZE_X2APIC_MODE)) {
+		mode = MSR_BITMAP_MODE_X2APIC;
+		if (enable_apicv && kvm_vcpu_apicv_active(vcpu))
+			mode |= MSR_BITMAP_MODE_X2APIC_APICV;
+	} else {
+		mode = 0;
+	}
+
+	if (!(mode ^ vmx->x2apic_msr_bitmap_mode))
+		return;
+
+	vmx->x2apic_msr_bitmap_mode = mode;
+
 	vmx_reset_x2apic_msrs(vcpu, mode);
 
 	/*
@@ -3984,21 +3987,6 @@ static void vmx_update_msr_bitmap_x2apic(struct kvm_vcpu *vcpu, u8 mode)
 	}
 }
 
-static void vmx_update_msr_bitmap(struct kvm_vcpu *vcpu)
-{
-	struct vcpu_vmx *vmx = to_vmx(vcpu);
-	u8 mode = vmx_msr_bitmap_mode(vcpu);
-	u8 changed = mode ^ vmx->msr_bitmap_mode;
-
-	if (!changed)
-		return;
-
-	if (changed & (MSR_BITMAP_MODE_X2APIC | MSR_BITMAP_MODE_X2APIC_APICV))
-		vmx_update_msr_bitmap_x2apic(vcpu, mode);
-
-	vmx->msr_bitmap_mode = mode;
-}
-
 void pt_update_intercept_for_msr(struct kvm_vcpu *vcpu)
 {
 	struct vcpu_vmx *vmx = to_vmx(vcpu);
@@ -4258,8 +4246,7 @@ static void vmx_refresh_apicv_exec_ctrl(struct kvm_vcpu *vcpu)
 					SECONDARY_EXEC_VIRTUAL_INTR_DELIVERY);
 	}
 
-	if (cpu_has_vmx_msr_bitmap())
-		vmx_update_msr_bitmap(vcpu);
+	vmx_update_msr_bitmap_x2apic(vcpu);
 }
 
 u32 vmx_exec_control(struct vcpu_vmx *vmx)
@@ -6287,7 +6274,7 @@ void vmx_set_virtual_apic_mode(struct kvm_vcpu *vcpu)
 	}
 	secondary_exec_controls_set(vmx, sec_exec_control);
 
-	vmx_update_msr_bitmap(vcpu);
+	vmx_update_msr_bitmap_x2apic(vcpu);
 }
 
 static void vmx_set_apic_access_page_addr(struct kvm_vcpu *vcpu)
diff --git a/arch/x86/kvm/vmx/vmx.h b/arch/x86/kvm/vmx/vmx.h
index e46df3253a21..5d2f047dafdf 100644
--- a/arch/x86/kvm/vmx/vmx.h
+++ b/arch/x86/kvm/vmx/vmx.h
@@ -229,7 +229,7 @@ struct nested_vmx {
 struct vcpu_vmx {
 	struct kvm_vcpu       vcpu;
 	u8                    fail;
-	u8		      msr_bitmap_mode;
+	u8		      x2apic_msr_bitmap_mode;
 
 	/*
 	 * If true, host state has been stored in vmx->loaded_vmcs for

From patchwork Sat Apr 24 00:46:43 2021
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
X-Patchwork-Submitter: Sean Christopherson <seanjc@google.com>
X-Patchwork-Id: 12222191
Return-Path: <kvm-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-26.3 required=3.0 tests=BAYES_00,DKIMWL_WL_MED,
	DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,
	INCLUDES_CR_TRAILER,INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,
	USER_AGENT_GIT,USER_IN_DEF_DKIM_WL autolearn=ham autolearn_force=no
	version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 40968C433ED
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:55:20 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 1F9A761469
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:55:20 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S244728AbhDXAzz (ORCPT <rfc822;kvm@archiver.kernel.org>);
        Fri, 23 Apr 2021 20:55:55 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:37964 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S244712AbhDXAy0 (ORCPT <rfc822;kvm@vger.kernel.org>);
        Fri, 23 Apr 2021 20:54:26 -0400
Received: from mail-qv1-xf4a.google.com (mail-qv1-xf4a.google.com
 [IPv6:2607:f8b0:4864:20::f4a])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id A93CCC0612B1
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:48:31 -0700 (PDT)
Received: by mail-qv1-xf4a.google.com with SMTP id
 w20-20020a0562140b34b029019c9674180fso19479162qvj.0
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:48:31 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=google.com; s=20161025;
        h=reply-to:date:in-reply-to:message-id:mime-version:references
         :subject:from:to:cc;
        bh=dwT5gDx8U+TXQv6xKXH5cDgd0KUyWk3Y9gjyR2V9h0g=;
        b=l8ErXtGiagqYGtTD5hcXb339Fg9mJCb4XUVGzrj5cDuO82nBEXHxHkUm05WJ0ypAWz
         fve7vgYc1/WZwz2APDMoyEn72hM55Ydxd/Vm3cpuzSNFI26zDZunqMRAmEcJBze5CEPo
         QdW7j5tWccjbNSW7GaO/JxQpi84x7UClBc+dgzKPNJ6+bwN1U2Qq1XTHC82UmYhxJ+u9
         pi9LPGonJtCYXHPTCMLq4SiQCCoAz9bYmvKv4GHSQDNVVbzmFRIK+b2Hm3NknIdHQ4WI
         b7jPoNOb24j5/Q27UwlAqWyjrGIRJzjiUzFa5dysl6hvzRBXTyAx6e5mH6Wq9E4asuUk
         ewbw==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:reply-to:date:in-reply-to:message-id
         :mime-version:references:subject:from:to:cc;
        bh=dwT5gDx8U+TXQv6xKXH5cDgd0KUyWk3Y9gjyR2V9h0g=;
        b=B4ahjYB2MaALQPX709O1FUBwA8a2h0G6xNv/wUUihF402oK0w6QIYP3PaTJHXMo0t7
         lwOak3q5Iwve0bAsGHJi38ATTtzUq1btF8ELfywn+iGfP6/sPdMISjkaRPmUsf7yF1gJ
         BZBLk/dpDb3Np8Cbt6Z8dRO8/WTSXYJEDFyJWMUGwCPs4HZBRChaoF6bS5malqaMa6eG
         nWpQmEnq7shwoyGFTyCVY6+dssBEhDFrusP5lBYffASNufMnJLgrPOWP2sFoLXGUiaRz
         X218+qAwBsOZDsIi/PHs+v3jCXPk1UJf2Mxeoko8ah2bdG+1Ex5fO095ccyGrOUZjH6k
         v+6g==
X-Gm-Message-State: AOAM533CtbmHco3riCrAt4guMSUocD6TaCzFocqhTVijQ4xLVDFEVB8C
        dRIssoNIEEE14ZzCLCmPU83NU9gD94c=
X-Google-Smtp-Source: 
 ABdhPJyJLXPmypGxS0Nd+GIxuMgYV+8Xnctu20pirxZqq4r04lQSaraBi7RF97vOU0EGhYj6UvgkWN515yM=
X-Received: from seanjc798194.pdx.corp.google.com
 ([2620:15c:f:10:ad52:3246:e190:f070])
 (user=seanjc job=sendgmr) by 2002:a0c:fa52:: with SMTP id
 k18mr7269182qvo.22.1619225310920;
 Fri, 23 Apr 2021 17:48:30 -0700 (PDT)
Reply-To: Sean Christopherson <seanjc@google.com>
Date: Fri, 23 Apr 2021 17:46:43 -0700
In-Reply-To: <20210424004645.3950558-1-seanjc@google.com>
Message-Id: <20210424004645.3950558-42-seanjc@google.com>
Mime-Version: 1.0
References: <20210424004645.3950558-1-seanjc@google.com>
X-Mailer: git-send-email 2.31.1.498.g6c1eba8ee3d-goog
Subject: [PATCH 41/43] KVM: VMX: Remove redundant write to set vCPU as active
 at RESET/INIT
From: Sean Christopherson <seanjc@google.com>
To: Paolo Bonzini <pbonzini@redhat.com>
Cc: Sean Christopherson <seanjc@google.com>,
        Vitaly Kuznetsov <vkuznets@redhat.com>,
        Wanpeng Li <wanpengli@tencent.com>,
        Jim Mattson <jmattson@google.com>,
        Joerg Roedel <joro@8bytes.org>, kvm@vger.kernel.org,
        linux-kernel@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

Drop a call to vmx_clear_hlt() during vCPU INIT, the guest's activity
state is unconditionally set to "active" a few lines earlier in
vmx_vcpu_reset().

No functional change intended.

Signed-off-by: Sean Christopherson <seanjc@google.com>
---
 arch/x86/kvm/vmx/vmx.c | 2 --
 1 file changed, 2 deletions(-)

diff --git a/arch/x86/kvm/vmx/vmx.c b/arch/x86/kvm/vmx/vmx.c
index dcef189b0108..78d17adce7e6 100644
--- a/arch/x86/kvm/vmx/vmx.c
+++ b/arch/x86/kvm/vmx/vmx.c
@@ -4568,8 +4568,6 @@ static void vmx_vcpu_reset(struct kvm_vcpu *vcpu, bool init_event)
 	kvm_make_request(KVM_REQ_APIC_PAGE_RELOAD, vcpu);
 
 	vpid_sync_context(vmx->vpid);
-	if (init_event)
-		vmx_clear_hlt(vcpu);
 }
 
 static void vmx_enable_irq_window(struct kvm_vcpu *vcpu)

From patchwork Sat Apr 24 00:46:44 2021
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
X-Patchwork-Submitter: Sean Christopherson <seanjc@google.com>
X-Patchwork-Id: 12222193
Return-Path: <kvm-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-26.3 required=3.0 tests=BAYES_00,DKIMWL_WL_MED,
	DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,
	INCLUDES_CR_TRAILER,INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,
	USER_AGENT_GIT,USER_IN_DEF_DKIM_WL autolearn=ham autolearn_force=no
	version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 5B237C43461
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:55:21 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 43EC461409
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:55:21 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S244738AbhDXAz5 (ORCPT <rfc822;kvm@archiver.kernel.org>);
        Fri, 23 Apr 2021 20:55:57 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:37974 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S244178AbhDXAy2 (ORCPT <rfc822;kvm@vger.kernel.org>);
        Fri, 23 Apr 2021 20:54:28 -0400
Received: from mail-yb1-xb49.google.com (mail-yb1-xb49.google.com
 [IPv6:2607:f8b0:4864:20::b49])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 60F82C061240
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:48:34 -0700 (PDT)
Received: by mail-yb1-xb49.google.com with SMTP id
 z8-20020a2566480000b02904e0f6f67f42so26643529ybm.15
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:48:33 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=google.com; s=20161025;
        h=reply-to:date:in-reply-to:message-id:mime-version:references
         :subject:from:to:cc;
        bh=RNPvYWQZyWoudwJX+eiT9Tudy0ylNLdSxXPRHk/Dbl0=;
        b=gvCmi5O1ZkvTuWybFhyFe2JFoeB2S3lx+dxD9bnbYmI4BtiRAXulvIvRLIb/qhztor
         XYM3ah8EuggNJMBqkEnOL8z5JU/JkV2e/WvUsByF8YMjiUXz5S8gnKAXCrW/d80N83TJ
         0BP/p3Mj205ml68DMUpifOGSSzKtHocxUkiCu9CEMeDxpI9BuX7UDxqCM0GZ2GNzt8e/
         P6EzLZVEZo/hKCEiygpszaZOUJ09Irn1sK9cGRfSqlPPka0isWhzrjORHmp/9fCBgpFU
         Jve999MtScRsD+38Bw7QbC9XSNrL5P45NGUxOAGgy7bc4Q0JFgXkDgNcCWjNPSTkzJDQ
         VMbw==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:reply-to:date:in-reply-to:message-id
         :mime-version:references:subject:from:to:cc;
        bh=RNPvYWQZyWoudwJX+eiT9Tudy0ylNLdSxXPRHk/Dbl0=;
        b=WFlKr07uh+hpJ+yLXmAvS8MLA4c1leiRoQxTfp2f+KlUGB4aEbwSwWIqr8Fq/L4yEe
         2i57yzGHaTj/baYG+DyQoLPasMbEKxogQLrM53Qu5VgSSxpaZHVdPIVexxKr5vqFT6Jd
         iOziVGF0pVPxLNDZkPfMZgTJJ95c+MlmhFpV91KczvX+h6eMnVpurT2655VCebCsHYEB
         JLZ5+2JGtlc5FsDQ+SVmrkI/+RT2++lAh9W/3GydIqxd+2UZw/bm5kuXnMISyEr8hBfV
         rks5p5QDeb6IJm6gPAYoxNBmwgAnj8doe5gSnxOjCDVX35cr2ktdOr0CuKv7qMHGsI4c
         wQZw==
X-Gm-Message-State: AOAM532z5JLfSj+VBe4vMRizYVH7jSeUvj9PJcpleje65TXxmHGOgtI+
        1q0Sq0TTAHDDwYMZhxRxOkQB2shfaho=
X-Google-Smtp-Source: 
 ABdhPJycBkWcCmvduvpUbK4zX4dHRlAPZHp3qDiadndfD/wpwn3q9fnD6IYaRZyl/4WrKd8UXKNUdK7eOYU=
X-Received: from seanjc798194.pdx.corp.google.com
 ([2620:15c:f:10:ad52:3246:e190:f070])
 (user=seanjc job=sendgmr) by 2002:a25:cfca:: with SMTP id
 f193mr9202657ybg.44.1619225313306;
 Fri, 23 Apr 2021 17:48:33 -0700 (PDT)
Reply-To: Sean Christopherson <seanjc@google.com>
Date: Fri, 23 Apr 2021 17:46:44 -0700
In-Reply-To: <20210424004645.3950558-1-seanjc@google.com>
Message-Id: <20210424004645.3950558-43-seanjc@google.com>
Mime-Version: 1.0
References: <20210424004645.3950558-1-seanjc@google.com>
X-Mailer: git-send-email 2.31.1.498.g6c1eba8ee3d-goog
Subject: [PATCH 42/43] KVM: VMX: Drop VMWRITEs to zero fields at vCPU RESET
From: Sean Christopherson <seanjc@google.com>
To: Paolo Bonzini <pbonzini@redhat.com>
Cc: Sean Christopherson <seanjc@google.com>,
        Vitaly Kuznetsov <vkuznets@redhat.com>,
        Wanpeng Li <wanpengli@tencent.com>,
        Jim Mattson <jmattson@google.com>,
        Joerg Roedel <joro@8bytes.org>, kvm@vger.kernel.org,
        linux-kernel@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

Don't waste time writing zeros via VMWRITE during vCPU RESET, the VMCS
is zero allocated.

No functional change intended.

Signed-off-by: Sean Christopherson <seanjc@google.com>
---
 arch/x86/kvm/vmx/vmx.c | 29 -----------------------------
 1 file changed, 29 deletions(-)

diff --git a/arch/x86/kvm/vmx/vmx.c b/arch/x86/kvm/vmx/vmx.c
index 78d17adce7e6..74258ba4832a 100644
--- a/arch/x86/kvm/vmx/vmx.c
+++ b/arch/x86/kvm/vmx/vmx.c
@@ -4427,13 +4427,6 @@ static void init_vmcs(struct vcpu_vmx *vmx)
 	}
 
 	if (kvm_vcpu_apicv_active(&vmx->vcpu)) {
-		vmcs_write64(EOI_EXIT_BITMAP0, 0);
-		vmcs_write64(EOI_EXIT_BITMAP1, 0);
-		vmcs_write64(EOI_EXIT_BITMAP2, 0);
-		vmcs_write64(EOI_EXIT_BITMAP3, 0);
-
-		vmcs_write16(GUEST_INTR_STATUS, 0);
-
 		vmcs_write16(POSTED_INTR_NV, POSTED_INTR_VECTOR);
 		vmcs_write64(POSTED_INTR_DESC_ADDR, __pa((&vmx->pi_desc)));
 	}
@@ -4444,23 +4437,9 @@ static void init_vmcs(struct vcpu_vmx *vmx)
 		vmx->ple_window_dirty = true;
 	}
 
-	vmcs_write32(PAGE_FAULT_ERROR_CODE_MASK, 0);
-	vmcs_write32(PAGE_FAULT_ERROR_CODE_MATCH, 0);
-	vmcs_write32(CR3_TARGET_COUNT, 0);           /* 22.2.1 */
-
-	vmcs_write16(HOST_FS_SELECTOR, 0);            /* 22.2.4 */
-	vmcs_write16(HOST_GS_SELECTOR, 0);            /* 22.2.4 */
 	vmx_set_constant_host_state(vmx);
-	vmcs_writel(HOST_FS_BASE, 0); /* 22.2.4 */
-	vmcs_writel(HOST_GS_BASE, 0); /* 22.2.4 */
 
-	if (cpu_has_vmx_vmfunc())
-		vmcs_write64(VM_FUNCTION_CONTROL, 0);
-
-	vmcs_write32(VM_EXIT_MSR_STORE_COUNT, 0);
-	vmcs_write32(VM_EXIT_MSR_LOAD_COUNT, 0);
 	vmcs_write64(VM_EXIT_MSR_LOAD_ADDR, __pa(vmx->msr_autoload.host.val));
-	vmcs_write32(VM_ENTRY_MSR_LOAD_COUNT, 0);
 	vmcs_write64(VM_ENTRY_MSR_LOAD_ADDR, __pa(vmx->msr_autoload.guest.val));
 
 	if (vmcs_config.vmentry_ctrl & VM_ENTRY_LOAD_IA32_PAT)
@@ -4493,7 +4472,6 @@ static void init_vmcs(struct vcpu_vmx *vmx)
 		memset(&vmx->pt_desc, 0, sizeof(vmx->pt_desc));
 		/* Bit[6~0] are forced to 1, writes are ignored. */
 		vmx->pt_desc.guest.output_mask = 0x7F;
-		vmcs_write64(GUEST_IA32_RTIT_CTL, 0);
 	}
 
 	vmx_setup_uret_msrs(vmx);
@@ -4536,13 +4514,6 @@ static void vmx_vcpu_reset(struct kvm_vcpu *vcpu, bool init_event)
 	vmcs_write32(GUEST_LDTR_LIMIT, 0xffff);
 	vmcs_write32(GUEST_LDTR_AR_BYTES, 0x00082);
 
-	if (!init_event) {
-		vmcs_write32(GUEST_SYSENTER_CS, 0);
-		vmcs_writel(GUEST_SYSENTER_ESP, 0);
-		vmcs_writel(GUEST_SYSENTER_EIP, 0);
-		vmcs_write64(GUEST_IA32_DEBUGCTL, 0);
-	}
-
 	vmcs_writel(GUEST_GDTR_BASE, 0);
 	vmcs_write32(GUEST_GDTR_LIMIT, 0xffff);
 

From patchwork Sat Apr 24 00:46:45 2021
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
X-Patchwork-Submitter: Sean Christopherson <seanjc@google.com>
X-Patchwork-Id: 12222195
Return-Path: <kvm-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-26.3 required=3.0 tests=BAYES_00,DKIMWL_WL_MED,
	DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,
	INCLUDES_CR_TRAILER,INCLUDES_PATCH,MAILING_LIST_MULTI,SPF_HELO_NONE,SPF_PASS,
	USER_AGENT_GIT,USER_IN_DEF_DKIM_WL autolearn=ham autolearn_force=no
	version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 12019C433ED
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:56:20 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id DC9FE61469
	for <kvm@archiver.kernel.org>; Sat, 24 Apr 2021 00:56:19 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S244209AbhDXA4y (ORCPT <rfc822;kvm@archiver.kernel.org>);
        Fri, 23 Apr 2021 20:56:54 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:38134 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S244455AbhDXAzU (ORCPT <rfc822;kvm@vger.kernel.org>);
        Fri, 23 Apr 2021 20:55:20 -0400
Received: from mail-yb1-xb4a.google.com (mail-yb1-xb4a.google.com
 [IPv6:2607:f8b0:4864:20::b4a])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 8506BC061244
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:48:36 -0700 (PDT)
Received: by mail-yb1-xb4a.google.com with SMTP id
 d89-20020a25a3620000b02904dc8d0450c6so26113060ybi.2
        for <kvm@vger.kernel.org>; Fri, 23 Apr 2021 17:48:36 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=google.com; s=20161025;
        h=reply-to:date:in-reply-to:message-id:mime-version:references
         :subject:from:to:cc;
        bh=R43ABUZ9/Fi53IKsY58euoL+dVYl7LoEC4YFNOGoqao=;
        b=gXjNOqK1L7vM4ncBy6xohX2vvBi4KwcgSkBOQa8L7aBPQfp16D1WJmCV/jdeojHOb3
         +DSylbvxS8KAgWscv86gsTLDKq3gjRiTy4ihusv4PEreJ42QGVxpCDxewRnMBBTJuBAy
         HFzGOqeuT3p+ktZJ6FljmDgd6X3hNhSgFY692LBEoiE4EsJmf2ceP9tNJ5CbIbmqHM9n
         KkFsE7lyGMYLmTWoYraea9HlpCHVi4V0P2ptJBwM9pft6TPEpT4kUgdOXrLEJJV/bIVA
         uYGiCZ1YyGIVzV5bglKD3vQhbGUIPZdbEMjV1hh4fEZgbJvuQwLIeQ/K6gRcPp5SLPPx
         1dvA==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:reply-to:date:in-reply-to:message-id
         :mime-version:references:subject:from:to:cc;
        bh=R43ABUZ9/Fi53IKsY58euoL+dVYl7LoEC4YFNOGoqao=;
        b=LG60DOB5Y9iwV2/rIrv/sU9x51/bYIH02Np3YO9O3vkQ2j4+pu+K6CxibOKe6ZkJkV
         660eCZIG0Mjw2Y5RosEAniE3J8tanTxGL5FyNJ/cj2+FYMSd9QVUzp//EmSROXao8kXo
         rT9igb+8MP4H4D9f0onGkWKSGFYpBDKHonZf6ZfJA/+KtRnee/CxoYUURoLQh0m7qwcE
         DK+BEkribQaySRqwIFF3DwOh9ESoYUDiNsZh8XDDqhzmpH4q1lQp3XijfncIvUOryNL2
         CRguGyYMro4ncA64SRlvuOD4daCgLwI8G1DkHzizRgiGRM4ZSqVSsOtiizWeaPdiIjK+
         Rw3Q==
X-Gm-Message-State: AOAM533tIQm6Kj4BKx4RXZgwD0jIjQeYzGHJ1fvDWOtrdJrXfuSUBU4C
        749beKx+Ez6TW7DFfCoEuFCPVn7V0yE=
X-Google-Smtp-Source: 
 ABdhPJzPKy+rI/zbpn2Xldk6fWBp/khBlsJXC/ketf7A0l2T/NPalRCb7nmHR5GXqtN+0kehgINMCJzse5Q=
X-Received: from seanjc798194.pdx.corp.google.com
 ([2620:15c:f:10:ad52:3246:e190:f070])
 (user=seanjc job=sendgmr) by 2002:a25:840c:: with SMTP id
 u12mr9012245ybk.345.1619225315623;
 Fri, 23 Apr 2021 17:48:35 -0700 (PDT)
Reply-To: Sean Christopherson <seanjc@google.com>
Date: Fri, 23 Apr 2021 17:46:45 -0700
In-Reply-To: <20210424004645.3950558-1-seanjc@google.com>
Message-Id: <20210424004645.3950558-44-seanjc@google.com>
Mime-Version: 1.0
References: <20210424004645.3950558-1-seanjc@google.com>
X-Mailer: git-send-email 2.31.1.498.g6c1eba8ee3d-goog
Subject: [PATCH 43/43] KVM: x86: Drop pointless @reset_roots from
 kvm_init_mmu()
From: Sean Christopherson <seanjc@google.com>
To: Paolo Bonzini <pbonzini@redhat.com>
Cc: Sean Christopherson <seanjc@google.com>,
        Vitaly Kuznetsov <vkuznets@redhat.com>,
        Wanpeng Li <wanpengli@tencent.com>,
        Jim Mattson <jmattson@google.com>,
        Joerg Roedel <joro@8bytes.org>, kvm@vger.kernel.org,
        linux-kernel@vger.kernel.org
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

Remove the @reset_roots param from kvm_init_mmu(), the one user,
kvm_mmu_reset_context() has already unloaded the MMU and thus freed and
invalidated all roots.  This also happens to be why the reset_roots=true
paths doesn't leak roots; they're already invalid.

No functional change intended.

Signed-off-by: Sean Christopherson <seanjc@google.com>
---
 arch/x86/kvm/mmu.h        |  2 +-
 arch/x86/kvm/mmu/mmu.c    | 13 ++-----------
 arch/x86/kvm/svm/nested.c |  2 +-
 arch/x86/kvm/vmx/nested.c |  2 +-
 4 files changed, 5 insertions(+), 14 deletions(-)

diff --git a/arch/x86/kvm/mmu.h b/arch/x86/kvm/mmu.h
index 88d0ed5225a4..63b49725fb24 100644
--- a/arch/x86/kvm/mmu.h
+++ b/arch/x86/kvm/mmu.h
@@ -65,7 +65,7 @@ void kvm_mmu_set_ept_masks(bool has_ad_bits, bool has_exec_only);
 void
 reset_shadow_zero_bits_mask(struct kvm_vcpu *vcpu, struct kvm_mmu *context);
 
-void kvm_init_mmu(struct kvm_vcpu *vcpu, bool reset_roots);
+void kvm_init_mmu(struct kvm_vcpu *vcpu);
 void kvm_init_shadow_npt_mmu(struct kvm_vcpu *vcpu, u32 cr0, u32 cr4, u32 efer,
 			     gpa_t nested_cr3);
 void kvm_init_shadow_ept_mmu(struct kvm_vcpu *vcpu, bool execonly,
diff --git a/arch/x86/kvm/mmu/mmu.c b/arch/x86/kvm/mmu/mmu.c
index 930ac8a7e7c9..ff3e200b32dd 100644
--- a/arch/x86/kvm/mmu/mmu.c
+++ b/arch/x86/kvm/mmu/mmu.c
@@ -4793,17 +4793,8 @@ static void init_kvm_nested_mmu(struct kvm_vcpu *vcpu)
 	update_last_nonleaf_level(vcpu, g_context);
 }
 
-void kvm_init_mmu(struct kvm_vcpu *vcpu, bool reset_roots)
+void kvm_init_mmu(struct kvm_vcpu *vcpu)
 {
-	if (reset_roots) {
-		uint i;
-
-		vcpu->arch.mmu->root_hpa = INVALID_PAGE;
-
-		for (i = 0; i < KVM_MMU_NUM_PREV_ROOTS; i++)
-			vcpu->arch.mmu->prev_roots[i] = KVM_MMU_ROOT_INFO_INVALID;
-	}
-
 	if (mmu_is_nested(vcpu))
 		init_kvm_nested_mmu(vcpu);
 	else if (tdp_enabled)
@@ -4829,7 +4820,7 @@ kvm_mmu_calc_root_page_role(struct kvm_vcpu *vcpu)
 void kvm_mmu_reset_context(struct kvm_vcpu *vcpu)
 {
 	kvm_mmu_unload(vcpu);
-	kvm_init_mmu(vcpu, true);
+	kvm_init_mmu(vcpu);
 }
 EXPORT_SYMBOL_GPL(kvm_mmu_reset_context);
 
diff --git a/arch/x86/kvm/svm/nested.c b/arch/x86/kvm/svm/nested.c
index 540d43ba2cf4..a0b48a8f32ed 100644
--- a/arch/x86/kvm/svm/nested.c
+++ b/arch/x86/kvm/svm/nested.c
@@ -406,7 +406,7 @@ static int nested_svm_load_cr3(struct kvm_vcpu *vcpu, unsigned long cr3,
 	vcpu->arch.cr3 = cr3;
 	kvm_register_mark_available(vcpu, VCPU_EXREG_CR3);
 
-	kvm_init_mmu(vcpu, false);
+	kvm_init_mmu(vcpu);
 
 	return 0;
 }
diff --git a/arch/x86/kvm/vmx/nested.c b/arch/x86/kvm/vmx/nested.c
index 9dcdf158a405..3a5b86932a5e 100644
--- a/arch/x86/kvm/vmx/nested.c
+++ b/arch/x86/kvm/vmx/nested.c
@@ -1137,7 +1137,7 @@ static int nested_vmx_load_cr3(struct kvm_vcpu *vcpu, unsigned long cr3, bool ne
 	vcpu->arch.cr3 = cr3;
 	kvm_register_mark_available(vcpu, VCPU_EXREG_CR3);
 
-	kvm_init_mmu(vcpu, false);
+	kvm_init_mmu(vcpu);
 
 	return 0;
 }
