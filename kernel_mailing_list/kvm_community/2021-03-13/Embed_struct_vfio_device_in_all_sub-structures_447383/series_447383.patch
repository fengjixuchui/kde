From patchwork Sat Mar 13 00:55:53 2021
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
X-Patchwork-Submitter: Jason Gunthorpe <jgg@nvidia.com>
X-Patchwork-Id: 12136241
Return-Path: <kvm-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-16.0 required=3.0 tests=BAYES_00,DKIMWL_WL_HIGH,
	DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,
	INCLUDES_CR_TRAILER,INCLUDES_PATCH,MAILING_LIST_MULTI,MSGID_FROM_MTA_HEADER,
	SPF_HELO_NONE,SPF_PASS autolearn=ham autolearn_force=no version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 4C551C4360C
	for <kvm@archiver.kernel.org>; Sat, 13 Mar 2021 00:57:02 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 2EB1164F8F
	for <kvm@archiver.kernel.org>; Sat, 13 Mar 2021 00:57:02 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S232956AbhCMA4f (ORCPT <rfc822;kvm@archiver.kernel.org>);
        Fri, 12 Mar 2021 19:56:35 -0500
Received: from mail-dm6nam12on2081.outbound.protection.outlook.com
 ([40.107.243.81]:44481
        "EHLO NAM12-DM6-obe.outbound.protection.outlook.com"
        rhost-flags-OK-OK-OK-FAIL) by vger.kernel.org with ESMTP
        id S232257AbhCMA4Q (ORCPT <rfc822;kvm@vger.kernel.org>);
        Fri, 12 Mar 2021 19:56:16 -0500
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=f3QmvPvZuZdXgxlsPsvfdnDGJYY7xhf2rIHGEmo1LtvZRFkIa3Uvksdy+Y8py+U6W/i8ivZ86OiabXLlVBAKTSXtyirEe2V68yStYKSAuQPw5+1ONhb0Cu8hPDX1hXxjElDBLPPxaTPyGhVAZS1A2GfclJdFSGg2xHFWVV90bcCXSW8uMI3r+8Pyam7kYs0eogQ9I5z51p6tcQJbRYp/gbA2KU4uyb1ts68XjggpWHln3lSlEIzlhDcbRwfjtmE3TwZsW11mgiWnwo3HA9b6rCsnC6hv1WnoU/wx1bwQ5MYgYCYJ3MEXwo1DMAVM2EDlg3Tfjsp0ZhNPGoOF7LJrqw==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=KiIyIwO7kq0WsbP/stKbgYgvl/RRRz075uzNy8ghGqU=;
 b=Yusi/BdGc2akABjOLKui1IBb5TqUHZV5DtpvlSPqAmJVSrZR8oxg/21EhviiZ0W2akYLpHtaLuPCSCBzhZnYhURtVnGtmOsuMsovnEoWOA0ioWFnn4sj049nxelfHtRDYvl7CUhQZNU1QonizcUau1+7lMfGwxzCj3TTkQwhf79F4oxCpCLs1+69ml0Cr4/TKT9uUut6XtW1ETFJa2DNOS7E6az563Pv7s2L/jw4So03ZOj3MDUBAGYr7vqIM6U3VpwWkVN+dNQEAxCBagjIozU8qb/CYJ16+6kH2F0+g9BsJnLpb05OghyWq0tTfomgIYgsRWHBV0fs5LBysTcrPw==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=nvidia.com; dmarc=pass action=none header.from=nvidia.com;
 dkim=pass header.d=nvidia.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=Nvidia.com;
 s=selector2;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=KiIyIwO7kq0WsbP/stKbgYgvl/RRRz075uzNy8ghGqU=;
 b=GZrlcfB+rmd5+arvlLiMNmImeH5/8uM8dYY6OZhr4t+2hJoqmFO4TIWFexYQdNeOzrLQZ2YjkRX6Of3a3ES/4gJvFmIgcaqaIT0orQVCAFkOAUbHRT0INkMbtcghoD0+2OYSzNulJSeO1My/cYcEw45uorugCgO2GiZEcWoYVJFY9JURETupu2cwIr8rRXWykx0Usu46e/5AcS2xgG77FsRI4qlYEUdRO/QNjJl7MjozdO2VBa6HElY0PCAWvwS6bf4X/ZzOnIar+DlMgY+J8Er6UoUMNHnd3R2ugS5lzXTD2G635cNJYH7z3Frg9Rc1RZUubK11wpcD6g8Kk2P0TQ==
Authentication-Results: redhat.com; dkim=none (message not signed)
 header.d=none;redhat.com; dmarc=none action=none header.from=nvidia.com;
Received: from DM6PR12MB3834.namprd12.prod.outlook.com (2603:10b6:5:14a::12)
 by DM6PR12MB2940.namprd12.prod.outlook.com (2603:10b6:5:15f::19) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.3933.31; Sat, 13 Mar
 2021 00:56:15 +0000
Received: from DM6PR12MB3834.namprd12.prod.outlook.com
 ([fe80::1c62:7fa3:617b:ab87]) by DM6PR12MB3834.namprd12.prod.outlook.com
 ([fe80::1c62:7fa3:617b:ab87%6]) with mapi id 15.20.3933.032; Sat, 13 Mar 2021
 00:56:15 +0000
From: Jason Gunthorpe <jgg@nvidia.com>
To: Alex Williamson <alex.williamson@redhat.com>,
        Cornelia Huck <cohuck@redhat.com>, kvm@vger.kernel.org
Cc: "Raj, Ashok" <ashok.raj@intel.com>,
        Dan Williams <dan.j.williams@intel.com>,
        Daniel Vetter <daniel@ffwll.ch>,
        Christoph Hellwig <hch@lst.de>,
        Leon Romanovsky <leonro@nvidia.com>,
        Max Gurtovoy <mgurtovoy@nvidia.com>,
        Tarun Gupta <targupta@nvidia.com>
Subject: [PATCH v2 01/14] vfio: Remove extra put/gets around
 vfio_device->group
Date: Fri, 12 Mar 2021 20:55:53 -0400
Message-Id: <1-v2-20d933792272+4ff-vfio1_jgg@nvidia.com>
In-Reply-To: <0-v2-20d933792272+4ff-vfio1_jgg@nvidia.com>
References: 
X-Originating-IP: [142.162.115.133]
X-ClientProxiedBy: BL1PR13CA0167.namprd13.prod.outlook.com
 (2603:10b6:208:2bd::22) To DM6PR12MB3834.namprd12.prod.outlook.com
 (2603:10b6:5:14a::12)
MIME-Version: 1.0
X-MS-Exchange-MessageSentRepresentingType: 1
Received: from mlx.ziepe.ca (142.162.115.133) by
 BL1PR13CA0167.namprd13.prod.outlook.com (2603:10b6:208:2bd::22) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.3955.11 via Frontend
 Transport; Sat, 13 Mar 2021 00:56:12 +0000
Received: from jgg by mlx with local (Exim 4.94)        (envelope-from
 <jgg@nvidia.com>)        id 1lKsZa-00EMAl-O2; Fri, 12 Mar 2021 20:56:06 -0400
X-MS-PublicTrafficType: Email
X-MS-Office365-Filtering-Correlation-Id: a2f89a1e-ddc2-483b-fbaf-08d8e5bacc0f
X-MS-TrafficTypeDiagnostic: DM6PR12MB2940:
X-MS-Exchange-Transport-Forked: True
X-Microsoft-Antispam-PRVS: 
 <DM6PR12MB2940B7CD961EF9AD5020EA52C26E9@DM6PR12MB2940.namprd12.prod.outlook.com>
X-MS-Oob-TLC-OOBClassifiers: OLM:5797;
X-MS-Exchange-SenderADCheck: 1
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: 
 OkbSiz5DKmDdxxixlQ5D3NEd6SQhl4Nwr9MsPqZ0jORR6+QSQ4vt2e/7APctEMNl1OQpaBVlaQoAz4FOYr538uDCan18v2gObs7SHumkF2dLY6gkFz4gPhtqdnGBoaAqSnevOoRWJ+a2LjlIIrwfdVUabqngpV2Op84ZMS40FQNl5y3C9Bm19D1AFYrzkAzZp+UtR4XEuf6avJbGEVsNNwp2Glm7b+GtkCmyXQCL+pAjoGeqWVqUtuJU+4gK6hds9iplKjlhXGUY1LHH0vdYcJhk6SpAUjbR9hYDQcEQlqh0tKxB5AVAXEhkWIm7o6opSJcRxe5QT1RPDPyK1+AxO4xRU8NVGDvy2igphmF5xtGjvNO37fMq7WjeVveQEHa7Yy1+vDAxR2E8kLsSsooCEqnJcJDF/Ddyf8WUX/ZWfJD15X4+Z5IKxpVliEkoUeFRCgicGqDiSwxP7AL7/TyAiQkVDb+Tiz+H3MFHbRpUsQD+9nldnPPcRphlE3Ixd0DM2Ob4XZoIbbK3sSzqgNByY1CfFqrq2aQdGVZFL3v8VT2y3IoWNNAlPmTMW/4Ea5wrrubySEhc1q1QhDC7+1WQa+nPSWwSTL390S7YfL2MrdA=
X-Forefront-Antispam-Report: 
 CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:DM6PR12MB3834.namprd12.prod.outlook.com;PTR:;CAT:NONE;SFS:(4636009)(39860400002)(376002)(396003)(136003)(366004)(346002)(9746002)(9786002)(8676002)(6666004)(4326008)(107886003)(54906003)(8936002)(5660300002)(36756003)(316002)(110136005)(83380400001)(66946007)(66556008)(186003)(26005)(66476007)(478600001)(2906002)(426003)(86362001)(2616005)(4216001);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData: 
 q7xFN+pQ/7yjY26wP2x2FkSGX2sGIUD806jRqr2TiOxkt9c0KxwP84PdgumaAnOx8Pr1/fTC7tIjEXOwpV9cOmIBGySN+eeNuDiRaxQWrM8XT96UW1MCaE/pIwclpHh61zx/iD6kifii/55emoAqtcybS6LIC2g8lMyOoGaklM0+QgG5RXbfjVlhffFedeppuvjaqIFEHWw6eERzRqoexDY10fPrCfF+iLLIklqP5AUTl8hazXXzkKerYlb7xi2tNcJUoXLdZOjdNiI/VT4i95BicCFDZ+hQQZmJ9TTkA1FHZ4SFp1CIkY6ODgY7EqerQ8fuWCmPZn0i29ru4ek+4WjH1X6fkGoZ3ZZT2yCVx3bOkypCSQkKZ/v2dw05fGrHnF+UcWe2wlkGjOG38+MIjrC/Qp3zDHqyTIH5Ox4IMNHuJpu5OYJXg/0n+QNJiV82scO3RjE0gg9s/z4xsnsMT1djkt1Mmzw9afELRgUf/TexPVntBJwyvON73DG+Oq4Pmztsta52xc8HprWv8c96XZFY/Qf/paM4jta8rTdpDBNc9yqhLh58Eo+xO/tyKDY9vpCNhdZgcb+Zq1jVMmE9cOEkup5M0AJoFt5NzzAA962N0yNSBDnDcg4F2CHK5FhHBfq2NRnfq3jcX2bKlpmJuvWrn9y4SD3kXmpMOdW0l2qhJA2HjHVl3GBeLaYOZM1ZuTmC4kbEZFaHIl5DDjylxdnUEq/5ZZ61YRBTsih9aztEqlyBeAnUmktSLUslaQpbmRYztq8a/EC7mI7OG+Ogdx5C8pIc6xQDCIDU0eeoNV6/dGgfkAgDUyMPF6XuoHJzt/rmJWzBmcTTQbOWr9gbOn9Kmw3qq09qbHkoPOWfmal03fRWCjiEBC9rZUOMtARwV35N8b3e0m1KE7v3MVBpWBWxFJ7AGhGEC2GySL7UTNJ92VLcFlWTjXe8yN4GORk93bXW1GIi0RmQvVkMuPv1juLnfGi2+rrQv5pq3pPYuhGF1l9t9jIgVpsWdHhlzfaor/QkA5uado7njiOFkrbj4/vxBCDau7iJMOYGAMRkhRAIV66Nb6N0u4hEzxs1Bh4kYgno0BMr8ijKyH3Qy+iztPLfNdYn8NRmU6EY8UWIcba/yXGBl4BAgGM4kykdEwQ1oLhGB5KIPsORY41M1rX+gIswd0baEAG28UMOogyH2nbcWqZfExIn97V84jlGfOWp/jcTzGN3MkwtQehMCb7qn2+ct0xfX+ROszZbSu2+29dSC827LsHocERxRAsbnQNuRUJFCP3KseUdasVcWCEXAVlimq/NjaipnI+I71khUv4TfR25p3MFoLPw3rNzjpbT
X-OriginatorOrg: Nvidia.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 
 a2f89a1e-ddc2-483b-fbaf-08d8e5bacc0f
X-MS-Exchange-CrossTenant-AuthSource: DM6PR12MB3834.namprd12.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 13 Mar 2021 00:56:12.6290
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 43083d15-7273-40c1-b7db-39efd9ccc17a
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: 
 ROdzgl/WGRpkVez3rSzhCh4zGo4a/Tz9JDvVkJkcqq1pC3jSpmegI+WDbKbLRy2T
X-MS-Exchange-Transport-CrossTenantHeadersStamped: DM6PR12MB2940
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

The vfio_device->group value has a get obtained during
vfio_add_group_dev() which gets moved from the stack to vfio_device->group
in vfio_group_create_device().

The reference remains until we reach the end of vfio_del_group_dev() when
it is put back.

Thus anything that already has a kref on the vfio_device is guaranteed a
valid group pointer. Remove all the extra reference traffic.

It is tricky to see, but the get at the start of vfio_del_group_dev() is
actually pairing with the put hidden inside vfio_device_put() a few lines
below.

A later patch merges vfio_group_create_device() into vfio_add_group_dev()
which makes the ownership and error flow on the create side easier to
follow.

Reviewed-by: Christoph Hellwig <hch@lst.de>
Signed-off-by: Jason Gunthorpe <jgg@nvidia.com>
---
 drivers/vfio/vfio.c | 21 ++-------------------
 1 file changed, 2 insertions(+), 19 deletions(-)

diff --git a/drivers/vfio/vfio.c b/drivers/vfio/vfio.c
index 38779e6fd80cb4..15d8e678e5563a 100644
--- a/drivers/vfio/vfio.c
+++ b/drivers/vfio/vfio.c
@@ -546,14 +546,12 @@ struct vfio_device *vfio_group_create_device(struct vfio_group *group,
 
 	kref_init(&device->kref);
 	device->dev = dev;
+	/* Our reference on group is moved to the device */
 	device->group = group;
 	device->ops = ops;
 	device->device_data = device_data;
 	dev_set_drvdata(dev, device);
 
-	/* No need to get group_lock, caller has group reference */
-	vfio_group_get(group);
-
 	mutex_lock(&group->device_lock);
 	list_add(&device->group_next, &group->device_list);
 	group->dev_counter++;
@@ -585,13 +583,11 @@ void vfio_device_put(struct vfio_device *device)
 {
 	struct vfio_group *group = device->group;
 	kref_put_mutex(&device->kref, vfio_device_release, &group->device_lock);
-	vfio_group_put(group);
 }
 EXPORT_SYMBOL_GPL(vfio_device_put);
 
 static void vfio_device_get(struct vfio_device *device)
 {
-	vfio_group_get(device->group);
 	kref_get(&device->kref);
 }
 
@@ -841,14 +837,6 @@ int vfio_add_group_dev(struct device *dev,
 		vfio_group_put(group);
 		return PTR_ERR(device);
 	}
-
-	/*
-	 * Drop all but the vfio_device reference.  The vfio_device holds
-	 * a reference to the vfio_group, which holds a reference to the
-	 * iommu_group.
-	 */
-	vfio_group_put(group);
-
 	return 0;
 }
 EXPORT_SYMBOL_GPL(vfio_add_group_dev);
@@ -928,12 +916,6 @@ void *vfio_del_group_dev(struct device *dev)
 	unsigned int i = 0;
 	bool interrupted = false;
 
-	/*
-	 * The group exists so long as we have a device reference.  Get
-	 * a group reference and use it to scan for the device going away.
-	 */
-	vfio_group_get(group);
-
 	/*
 	 * When the device is removed from the group, the group suddenly
 	 * becomes non-viable; the device has a driver (until the unbind
@@ -1008,6 +990,7 @@ void *vfio_del_group_dev(struct device *dev)
 	if (list_empty(&group->device_list))
 		wait_event(group->container_q, !group->container);
 
+	/* Matches the get in vfio_group_create_device() */
 	vfio_group_put(group);
 
 	return device_data;

From patchwork Sat Mar 13 00:55:54 2021
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
X-Patchwork-Submitter: Jason Gunthorpe <jgg@nvidia.com>
X-Patchwork-Id: 12136237
Return-Path: <kvm-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-16.0 required=3.0 tests=BAYES_00,DKIMWL_WL_HIGH,
	DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,
	INCLUDES_CR_TRAILER,INCLUDES_PATCH,MAILING_LIST_MULTI,MSGID_FROM_MTA_HEADER,
	SPF_HELO_NONE,SPF_PASS autolearn=ham autolearn_force=no version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 7D4FEC43619
	for <kvm@archiver.kernel.org>; Sat, 13 Mar 2021 00:57:02 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 5FDA964F89
	for <kvm@archiver.kernel.org>; Sat, 13 Mar 2021 00:57:02 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S232975AbhCMA4g (ORCPT <rfc822;kvm@archiver.kernel.org>);
        Fri, 12 Mar 2021 19:56:36 -0500
Received: from mail-dm6nam12on2081.outbound.protection.outlook.com
 ([40.107.243.81]:44481
        "EHLO NAM12-DM6-obe.outbound.protection.outlook.com"
        rhost-flags-OK-OK-OK-FAIL) by vger.kernel.org with ESMTP
        id S232389AbhCMA4Q (ORCPT <rfc822;kvm@vger.kernel.org>);
        Fri, 12 Mar 2021 19:56:16 -0500
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=aSJeFkY7/02wxwWxFfh0TPaqiQZJkUpC9yYDgKCxyVzgUWz2+0H9/s2O2LnCtKRVYiqhYPfgF1wR7XnTbHA5O8thBpeLsKG/o8ncmn/TyM9ymtKKYVaJqnFeNmzqqyZlgw8ZSTEfBZuLWCWFj9Bi/olHB6CLS8CaSPm5PlfQ7pVoCgOe8Qvz9zHi/B9mb1T/9uc/+WGZY0pHDkSzGcfWY2I+H/7IMxPmtUcnvs6OdUeO25MqB4SIbb36Anh6NnNxDPy+t/iB6T2ereJb4n98FKeXu2/15os85DXWiMeLjxF6xocN9ASWjo+Uj/rtulP9u99Q8tkZI2okauoumBIw7w==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=Om19ByP/I6xPGMjGFR4lv9LcCo/CEmmV9LX/26rOUP4=;
 b=INhLPsJN5OcfRMEFrQBUzRwbSLTbTs+Mp3hy3b3uIqdIeFrLcfXOGAJJ5OxFG/3YxQLQlHaH3PnO/En6sEZH3vthHLq871M6CCScYC7buvBjvPxVz2HIUJc4lnYUlhZIvHBG9vruYGFbAf8qE4cUh/pg4wr367k21F70KJ+VQae+WxnxVCg6khHrhCQM2GUYh4/n37o6IkCAhvtczr4dKLbdPotd02RK2S3UJ06J9npNjrsBywn11DYIxOsiirY4p9RsiaftP/Fq/yfUpT6ejePsEBTgiy5Zz3ikVaOb14GbJMcM9mUvcNTdWs8Clw07/4tzJKJoqJKxi3Vqw2jYww==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=nvidia.com; dmarc=pass action=none header.from=nvidia.com;
 dkim=pass header.d=nvidia.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=Nvidia.com;
 s=selector2;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=Om19ByP/I6xPGMjGFR4lv9LcCo/CEmmV9LX/26rOUP4=;
 b=UxKAD4GVyjFbbPz1TMymoCp+1P3JAsK5ibgTDWexT2XESqLv39AdN5B+2PqaKEUM+CNz49KX16jNZavDM4DfdDKGFFj6RJgcx4l8oSMk/oaF12y9dI7vu3XEcHqdV1ifDZCoEEtHj25W0GELA+n8AWYUqzpX0qDNAcnVwRAhNKv6C0p9npTrp5UD5Ot3wBrbBn19afubECemXxhsY6/I/tp5Lcg0xhE6EY4cbvQJwOyLPzP2QDCfz+cbZKYWDqtH08NR9dN36K90Bg7Ifl29uAQL9Uq6y2TXwAu9XRVAuB3yRbezclce7grewaAIUeZgLq18WANK1bpnN5ONIqqPnA==
Authentication-Results: redhat.com; dkim=none (message not signed)
 header.d=none;redhat.com; dmarc=none action=none header.from=nvidia.com;
Received: from DM6PR12MB3834.namprd12.prod.outlook.com (2603:10b6:5:14a::12)
 by DM6PR12MB2940.namprd12.prod.outlook.com (2603:10b6:5:15f::19) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.3933.31; Sat, 13 Mar
 2021 00:56:15 +0000
Received: from DM6PR12MB3834.namprd12.prod.outlook.com
 ([fe80::1c62:7fa3:617b:ab87]) by DM6PR12MB3834.namprd12.prod.outlook.com
 ([fe80::1c62:7fa3:617b:ab87%6]) with mapi id 15.20.3933.032; Sat, 13 Mar 2021
 00:56:15 +0000
From: Jason Gunthorpe <jgg@nvidia.com>
To: Alex Williamson <alex.williamson@redhat.com>,
        Cornelia Huck <cohuck@redhat.com>, kvm@vger.kernel.org
Cc: "Raj, Ashok" <ashok.raj@intel.com>,
        Dan Williams <dan.j.williams@intel.com>,
        Daniel Vetter <daniel@ffwll.ch>,
        Christoph Hellwig <hch@lst.de>,
        Leon Romanovsky <leonro@nvidia.com>,
        Max Gurtovoy <mgurtovoy@nvidia.com>,
        Tarun Gupta <targupta@nvidia.com>
Subject: [PATCH v2 02/14] vfio: Simplify the lifetime logic for vfio_device
Date: Fri, 12 Mar 2021 20:55:54 -0400
Message-Id: <2-v2-20d933792272+4ff-vfio1_jgg@nvidia.com>
In-Reply-To: <0-v2-20d933792272+4ff-vfio1_jgg@nvidia.com>
References: 
X-Originating-IP: [142.162.115.133]
X-ClientProxiedBy: MN2PR06CA0009.namprd06.prod.outlook.com
 (2603:10b6:208:23d::14) To DM6PR12MB3834.namprd12.prod.outlook.com
 (2603:10b6:5:14a::12)
MIME-Version: 1.0
X-MS-Exchange-MessageSentRepresentingType: 1
Received: from mlx.ziepe.ca (142.162.115.133) by
 MN2PR06CA0009.namprd06.prod.outlook.com (2603:10b6:208:23d::14) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.3912.17 via Frontend
 Transport; Sat, 13 Mar 2021 00:56:12 +0000
Received: from jgg by mlx with local (Exim 4.94)        (envelope-from
 <jgg@nvidia.com>)        id 1lKsZa-00EMAo-Pi; Fri, 12 Mar 2021 20:56:06 -0400
X-MS-PublicTrafficType: Email
X-MS-Office365-Filtering-Correlation-Id: b6ba012a-e2fa-4b9b-6497-08d8e5bacc04
X-MS-TrafficTypeDiagnostic: DM6PR12MB2940:
X-MS-Exchange-Transport-Forked: True
X-Microsoft-Antispam-PRVS: 
 <DM6PR12MB29403DB8C95065383FA3A051C26E9@DM6PR12MB2940.namprd12.prod.outlook.com>
X-MS-Oob-TLC-OOBClassifiers: OLM:7691;
X-MS-Exchange-SenderADCheck: 1
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: 
 0haoW+UMDLa8s3EzW8CzbKCoXqNWl9w4kloWRDn6KyTwx+OEzKvU+cycExdMPHn1y97Z4uOqPBSnfFKQ0NhBqb2W3wQBKMpF0uIzzEeHBEIgT2bZ8gLYL6p4BMcEqIDPOF+KjHgmiU/as9xfJMclILWAGfwZ5JoUZuOyp7jxEtEx/IOymPx/BBcwqFsquaQyOMoh+fpQCtl8fORD7w7P+edK/1rMakxdXj4GkqNJZeNIzQ/0UGGc23F8bxw0kNmXxhpFBQCtFwHdboT3324X7UAWRb/P4t0Nxvv10tC57mtJrCBJbWtd2Runbu9HGH3ODkL4ogsQsRg819OHojujZAijJfEAjBpFDB60+4DLkcpKL9EJ2+yU7OUHoNIAPVNFdeVvy69O74AeINoeWkpcHFc07l61Hi+39e9DKZU9ApmXWOR7kZIgxHszUhFF3OpJf6ILx+uov6e1nOo3pT10f/NDcSrfO5WKFX6Ye/vVuQxR+So2sk5mRr9I2s6rXmwLYSVRq9zxss32dV7ddSgAc0TGxV/qShpu0xZ78W1KDnu2BQp0qwy59Khk5tCu86TemZT/PBVQH/IlDzc6Tx+v3tvZ29wi6J4D2/uMrhwrxQk=
X-Forefront-Antispam-Report: 
 CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:DM6PR12MB3834.namprd12.prod.outlook.com;PTR:;CAT:NONE;SFS:(4636009)(39860400002)(376002)(396003)(136003)(366004)(346002)(9746002)(9786002)(8676002)(6666004)(4326008)(107886003)(54906003)(8936002)(5660300002)(36756003)(316002)(110136005)(83380400001)(66946007)(66556008)(186003)(26005)(66476007)(478600001)(2906002)(426003)(86362001)(2616005)(4216001);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData: 
 TyxzxR/AvtjgkoIc4SWalRdgg6zXhtvo3qcfHz04Pt21f4lfbttXS7O2WmeroaEkeByjhlvMxealSIsJI8eF4UhhT/3pMAbzIDpoRuWl9E0RXNZVwasWxPmYd5u3pxhDv8nd7IbblRvmaw50OJm0U4yBwJygyRcMgmqFkLhkZIpKFhOo+Xx3xA2ZlQdTLCwIvY9K+z76+OtmEJ8gov63VXWImd3p+QVrPqar5MlM5x1rPOmuXuscTYXycLY0D/XEZNs5TU6lje2O4C1f5INlbLCD406oM5hlymPNSvSKk3OYdsh4+120jf2B2dsgeEeBQjAnPUgP7zC7ANVRwapoMfY/Bfwpk2NMBMCyAd/02fcc4X17OeWMLj8kvjnv2+3QbLoFOLm/Ob81tabzFP34oyBpfLKIaaSN+hV1561oZjDG3ommpVhgl730rZAx9oBNRB4Hsftsg6EwPW6yE53mcOtTHfgP4CdV6HFo/DYjn+ie75aXin/JWjIlGHVA8lukjmObDg76hywvqwuZmk3W+oiJpor126KU3A2zwRUCfZOzhB5M8terRmd2AiNRsUPaaZA4gpkr73EYRqRTcq1KOvpIyWFqGUnUruqfuEF6ebyi4dcgFM1oYk8X+aaX2vVUO/E3f4lDGhBul6rZSOuU7EZUnt7spdjPBAcSfw0DtoUIeB3BxdIawU3L88/kdYhGcKbe0krfdNwZiIYqOn5SMUmwuLYRAyBSUn52QU6nxN61T/zs7WMKsThMjAs6uyN5MU9pGNMBngkOClBDpqeJIw9QTO6B8l2ruWmub3mieJQdbqAgKQ/4+JguQtnjgMZy/p6d7pMxTjBsJGOS2UzT8gxH7y1O2RQxL0ACUjGEMtHnscIhj71OmHy7yZtS2tzauOgAcxFFuWM3ej1gYB90lbmNuBOlMyhGnJbnO5jTzFZnlnS6sNzlJbreGDp/kfGW36sccN0Avyxgz7NTVM9FijpwU6PQx20OOZePXt+P/SMRqpr/f1cewvXcA39LCRUB7o/8T+dep2qSzS6VfJkOGruVDotzerIbLQ82UgYAt570rO4E6FdMWH4jDyZeS0sA6JliI6iffPsWtxPbrLKRg4KD9nWgoTLJDzs8rwwEqVzeYyBfdGKJo3F+4UbmqVN5+HAguqPUTJrkxKLVm1ykPJH+lFZZchbKxGM36Q8UTCqz8IooL55/53lEACv5HYn9KewOlHpN/1L9W4Eqs1ogFP5GODmub6rYFhL+gvcKvIeWSQZeV6VUAzc/1T1vL5yFawkoI4a09ehffS8I5Ogxj0sDERGzjmlLsoUrEuhn4i+d+W80tq2sUhk6b+L4Nmlz
X-OriginatorOrg: Nvidia.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 
 b6ba012a-e2fa-4b9b-6497-08d8e5bacc04
X-MS-Exchange-CrossTenant-AuthSource: DM6PR12MB3834.namprd12.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 13 Mar 2021 00:56:12.7290
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 43083d15-7273-40c1-b7db-39efd9ccc17a
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: 
 ZhCfuELoDBTTz8k5XcNtChuW+6ZVERgv2LlW8GL0xSsuWC6vS0xsPnXpHv/O1Cw1
X-MS-Exchange-Transport-CrossTenantHeadersStamped: DM6PR12MB2940
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

The vfio_device is using a 'sleep until all refs go to zero' pattern for
its lifetime, but it is indirectly coded by repeatedly scanning the group
list waiting for the device to be removed on its own.

Switch this around to be a direct representation, use a refcount to count
the number of places that are blocking destruction and sleep directly on a
completion until that counter goes to zero. kfree the device after other
accesses have been excluded in vfio_del_group_dev(). This is a fairly
common Linux idiom.

Due to this we can now remove kref_put_mutex(), which is very rarely used
in the kernel. Here it is being used to prevent a zero ref device from
being seen in the group list. Instead allow the zero ref device to
continue to exist in the device_list and use refcount_inc_not_zero() to
exclude it once refs go to zero.

This patch is organized so the next patch will be able to alter the API to
allow drivers to provide the kfree.

Reviewed-by: Christoph Hellwig <hch@lst.de>
Signed-off-by: Jason Gunthorpe <jgg@nvidia.com>
---
 drivers/vfio/vfio.c | 79 ++++++++++++++-------------------------------
 1 file changed, 25 insertions(+), 54 deletions(-)

diff --git a/drivers/vfio/vfio.c b/drivers/vfio/vfio.c
index 15d8e678e5563a..32660e8a69ae20 100644
--- a/drivers/vfio/vfio.c
+++ b/drivers/vfio/vfio.c
@@ -46,7 +46,6 @@ static struct vfio {
 	struct mutex			group_lock;
 	struct cdev			group_cdev;
 	dev_t				group_devt;
-	wait_queue_head_t		release_q;
 } vfio;
 
 struct vfio_iommu_driver {
@@ -91,7 +90,8 @@ struct vfio_group {
 };
 
 struct vfio_device {
-	struct kref			kref;
+	refcount_t			refcount;
+	struct completion		comp;
 	struct device			*dev;
 	const struct vfio_device_ops	*ops;
 	struct vfio_group		*group;
@@ -544,7 +544,8 @@ struct vfio_device *vfio_group_create_device(struct vfio_group *group,
 	if (!device)
 		return ERR_PTR(-ENOMEM);
 
-	kref_init(&device->kref);
+	refcount_set(&device->refcount, 1);
+	init_completion(&device->comp);
 	device->dev = dev;
 	/* Our reference on group is moved to the device */
 	device->group = group;
@@ -560,35 +561,17 @@ struct vfio_device *vfio_group_create_device(struct vfio_group *group,
 	return device;
 }
 
-static void vfio_device_release(struct kref *kref)
-{
-	struct vfio_device *device = container_of(kref,
-						  struct vfio_device, kref);
-	struct vfio_group *group = device->group;
-
-	list_del(&device->group_next);
-	group->dev_counter--;
-	mutex_unlock(&group->device_lock);
-
-	dev_set_drvdata(device->dev, NULL);
-
-	kfree(device);
-
-	/* vfio_del_group_dev may be waiting for this device */
-	wake_up(&vfio.release_q);
-}
-
 /* Device reference always implies a group reference */
 void vfio_device_put(struct vfio_device *device)
 {
-	struct vfio_group *group = device->group;
-	kref_put_mutex(&device->kref, vfio_device_release, &group->device_lock);
+	if (refcount_dec_and_test(&device->refcount))
+		complete(&device->comp);
 }
 EXPORT_SYMBOL_GPL(vfio_device_put);
 
-static void vfio_device_get(struct vfio_device *device)
+static bool vfio_device_try_get(struct vfio_device *device)
 {
-	kref_get(&device->kref);
+	return refcount_inc_not_zero(&device->refcount);
 }
 
 static struct vfio_device *vfio_group_get_device(struct vfio_group *group,
@@ -598,8 +581,7 @@ static struct vfio_device *vfio_group_get_device(struct vfio_group *group,
 
 	mutex_lock(&group->device_lock);
 	list_for_each_entry(device, &group->device_list, group_next) {
-		if (device->dev == dev) {
-			vfio_device_get(device);
+		if (device->dev == dev && vfio_device_try_get(device)) {
 			mutex_unlock(&group->device_lock);
 			return device;
 		}
@@ -883,9 +865,8 @@ static struct vfio_device *vfio_device_get_from_name(struct vfio_group *group,
 			ret = !strcmp(dev_name(it->dev), buf);
 		}
 
-		if (ret) {
+		if (ret && vfio_device_try_get(it)) {
 			device = it;
-			vfio_device_get(device);
 			break;
 		}
 	}
@@ -908,13 +889,13 @@ EXPORT_SYMBOL_GPL(vfio_device_data);
  * removed.  Open file descriptors for the device... */
 void *vfio_del_group_dev(struct device *dev)
 {
-	DEFINE_WAIT_FUNC(wait, woken_wake_function);
 	struct vfio_device *device = dev_get_drvdata(dev);
 	struct vfio_group *group = device->group;
 	void *device_data = device->device_data;
 	struct vfio_unbound_dev *unbound;
 	unsigned int i = 0;
 	bool interrupted = false;
+	long rc;
 
 	/*
 	 * When the device is removed from the group, the group suddenly
@@ -935,32 +916,18 @@ void *vfio_del_group_dev(struct device *dev)
 	WARN_ON(!unbound);
 
 	vfio_device_put(device);
-
-	/*
-	 * If the device is still present in the group after the above
-	 * 'put', then it is in use and we need to request it from the
-	 * bus driver.  The driver may in turn need to request the
-	 * device from the user.  We send the request on an arbitrary
-	 * interval with counter to allow the driver to take escalating
-	 * measures to release the device if it has the ability to do so.
-	 */
-	add_wait_queue(&vfio.release_q, &wait);
-
-	do {
-		device = vfio_group_get_device(group, dev);
-		if (!device)
-			break;
-
+	rc = try_wait_for_completion(&device->comp);
+	while (rc <= 0) {
 		if (device->ops->request)
 			device->ops->request(device_data, i++);
 
-		vfio_device_put(device);
-
 		if (interrupted) {
-			wait_woken(&wait, TASK_UNINTERRUPTIBLE, HZ * 10);
+			rc = wait_for_completion_timeout(&device->comp,
+							 HZ * 10);
 		} else {
-			wait_woken(&wait, TASK_INTERRUPTIBLE, HZ * 10);
-			if (signal_pending(current)) {
+			rc = wait_for_completion_interruptible_timeout(
+				&device->comp, HZ * 10);
+			if (rc < 0) {
 				interrupted = true;
 				dev_warn(dev,
 					 "Device is currently in use, task"
@@ -969,10 +936,13 @@ void *vfio_del_group_dev(struct device *dev)
 					 current->comm, task_pid_nr(current));
 			}
 		}
+	}
 
-	} while (1);
+	mutex_lock(&group->device_lock);
+	list_del(&device->group_next);
+	group->dev_counter--;
+	mutex_unlock(&group->device_lock);
 
-	remove_wait_queue(&vfio.release_q, &wait);
 	/*
 	 * In order to support multiple devices per group, devices can be
 	 * plucked from the group while other devices in the group are still
@@ -992,6 +962,8 @@ void *vfio_del_group_dev(struct device *dev)
 
 	/* Matches the get in vfio_group_create_device() */
 	vfio_group_put(group);
+	dev_set_drvdata(dev, NULL);
+	kfree(device);
 
 	return device_data;
 }
@@ -2362,7 +2334,6 @@ static int __init vfio_init(void)
 	mutex_init(&vfio.iommu_drivers_lock);
 	INIT_LIST_HEAD(&vfio.group_list);
 	INIT_LIST_HEAD(&vfio.iommu_drivers_list);
-	init_waitqueue_head(&vfio.release_q);
 
 	ret = misc_register(&vfio_dev);
 	if (ret) {

From patchwork Sat Mar 13 00:55:55 2021
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
X-Patchwork-Submitter: Jason Gunthorpe <jgg@nvidia.com>
X-Patchwork-Id: 12136225
Return-Path: <kvm-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-16.0 required=3.0 tests=BAYES_00,DKIMWL_WL_HIGH,
	DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,
	INCLUDES_CR_TRAILER,INCLUDES_PATCH,MAILING_LIST_MULTI,MSGID_FROM_MTA_HEADER,
	SPF_HELO_NONE,SPF_PASS autolearn=unavailable autolearn_force=no version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id DBEF8C43331
	for <kvm@archiver.kernel.org>; Sat, 13 Mar 2021 00:57:01 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id BCF7364F87
	for <kvm@archiver.kernel.org>; Sat, 13 Mar 2021 00:57:01 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S232878AbhCMA4b (ORCPT <rfc822;kvm@archiver.kernel.org>);
        Fri, 12 Mar 2021 19:56:31 -0500
Received: from mail-dm6nam12on2065.outbound.protection.outlook.com
 ([40.107.243.65]:30549
        "EHLO NAM12-DM6-obe.outbound.protection.outlook.com"
        rhost-flags-OK-OK-OK-FAIL) by vger.kernel.org with ESMTP
        id S231907AbhCMA4O (ORCPT <rfc822;kvm@vger.kernel.org>);
        Fri, 12 Mar 2021 19:56:14 -0500
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=gv7MWvgjdKQIgU8qCZJmKISCs6crTHLgttWDSPrv3ScrbKSL/QWaGFV63kBUTLYco+m2Dxj3f4WQ4rXmj5NXNQphNhybEtgvlwTr8mRePAmKvDc5n42J4G4u/FC53IiZJF2FpWsrUJx3mAbbb1mXNQ4Lh2BIs8wuPiGeIruHsMYv/urWke92IMa0AsH8qdh7BH5ef3pIh/tqFqDV97aR6x/LiIUd9l3rCrezOCzYKd8pHncryQOdJbAvq+2dKfjt7b48l+k4yNux16T9Nzq4TgZf6abCnvSwIBY5JA1CHwRoJulZCoBUmVfktn1l20PerCAlhZ+BNosE2TwfcBqIfA==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=jf6XvtxllmGXRppYusByYnlwfyOqo2GO2puGv/Dx5xk=;
 b=TZp1H7FS4C0myfUr/084z9kLp86ph97UwgXlRTGMYIwGXqJJD9eE7VNh9g3mz2o19EcpdMBH3ZWpzR0JmMRATpmKNK4/zDEgnSbpp+OhVJTzPKkVVdSh5W63n+Ba3cUV2/KG5Krv8+VKUGw1aaljn8u5QDE2B19h6jkYE6XHlxwKowgGrGiJYGWEoQ1dcSYbWhNYuOc/20AYua+pPjaPQ/WaRWYJC6fxYEDnmxHWjq2pWDETNBO8ymAv/Sl81PYVrJ557M/y+goGYdS2RUCH6tu+ZZhjuQIvo2KIZVt92nKkb1cMFAnrqxMk+7iU+VPGP8iPGzwekTfFMXbE8XVF2Q==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=nvidia.com; dmarc=pass action=none header.from=nvidia.com;
 dkim=pass header.d=nvidia.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=Nvidia.com;
 s=selector2;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=jf6XvtxllmGXRppYusByYnlwfyOqo2GO2puGv/Dx5xk=;
 b=a2p2wR+kKYcydzYmW5dlbjsanTNsRMXQ0b0xCpVfcZzlnoW1Su05T1c4HdT+lLAgyZwJXNCQEuLrEhvqJS1s0GBTf5bgDvFxM2iEAiqjaHwiIeM6xDtYJfCJj3kCiKN0aLNGcj8KiKFcmfYWVDGywekBf++UQhxnnWFkSyBo5fhZAvokI5ea+XCrDY7yb7yh1V85+HovfkUe/zhuIpUc4u21V0DtMCSuCZjY9C+mq6Q6uGf2Frtq7pjnafSZ2gYmv5Am0TsaSbAauUNCbb0a9Povlbt+kZ67kpXkp7z0bKmE777WCwGrqKHpH8y2raEC7KdosbY+RYl6MEmvgun9EQ==
Authentication-Results: redhat.com; dkim=none (message not signed)
 header.d=none;redhat.com; dmarc=none action=none header.from=nvidia.com;
Received: from DM6PR12MB3834.namprd12.prod.outlook.com (2603:10b6:5:14a::12)
 by DM6PR12MB2940.namprd12.prod.outlook.com (2603:10b6:5:15f::19) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.3933.31; Sat, 13 Mar
 2021 00:56:12 +0000
Received: from DM6PR12MB3834.namprd12.prod.outlook.com
 ([fe80::1c62:7fa3:617b:ab87]) by DM6PR12MB3834.namprd12.prod.outlook.com
 ([fe80::1c62:7fa3:617b:ab87%6]) with mapi id 15.20.3933.032; Sat, 13 Mar 2021
 00:56:12 +0000
From: Jason Gunthorpe <jgg@nvidia.com>
To: Alex Williamson <alex.williamson@redhat.com>,
        Cornelia Huck <cohuck@redhat.com>,
        Jonathan Corbet <corbet@lwn.net>, kvm@vger.kernel.org,
        linux-doc@vger.kernel.org
Cc: "Raj, Ashok" <ashok.raj@intel.com>,
        Dan Williams <dan.j.williams@intel.com>,
        Daniel Vetter <daniel@ffwll.ch>,
        Christoph Hellwig <hch@lst.de>,
        Leon Romanovsky <leonro@nvidia.com>,
        Max Gurtovoy <mgurtovoy@nvidia.com>,
        Tarun Gupta <targupta@nvidia.com>,
        Liu Yi L <yi.l.liu@intel.com>
Subject: [PATCH v2 03/14] vfio: Split creation of a vfio_device into init and
 register ops
Date: Fri, 12 Mar 2021 20:55:55 -0400
Message-Id: <3-v2-20d933792272+4ff-vfio1_jgg@nvidia.com>
In-Reply-To: <0-v2-20d933792272+4ff-vfio1_jgg@nvidia.com>
References: 
X-Originating-IP: [142.162.115.133]
X-ClientProxiedBy: BL1PR13CA0228.namprd13.prod.outlook.com
 (2603:10b6:208:2bf::23) To DM6PR12MB3834.namprd12.prod.outlook.com
 (2603:10b6:5:14a::12)
MIME-Version: 1.0
X-MS-Exchange-MessageSentRepresentingType: 1
Received: from mlx.ziepe.ca (142.162.115.133) by
 BL1PR13CA0228.namprd13.prod.outlook.com (2603:10b6:208:2bf::23) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.3955.9 via Frontend
 Transport; Sat, 13 Mar 2021 00:56:10 +0000
Received: from jgg by mlx with local (Exim 4.94)        (envelope-from
 <jgg@nvidia.com>)        id 1lKsZa-00EMAt-RU; Fri, 12 Mar 2021 20:56:06 -0400
X-MS-PublicTrafficType: Email
X-MS-Office365-Filtering-Correlation-Id: d47b6ee4-3c19-47ac-0c56-08d8e5bacb1d
X-MS-TrafficTypeDiagnostic: DM6PR12MB2940:
X-MS-Exchange-Transport-Forked: True
X-Microsoft-Antispam-PRVS: 
 <DM6PR12MB2940B6F5B1C7BB62B236D172C26E9@DM6PR12MB2940.namprd12.prod.outlook.com>
X-MS-Oob-TLC-OOBClassifiers: OLM:2733;
X-MS-Exchange-SenderADCheck: 1
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: 
 6jmrbUBBmqdKhrl01G4NHjxqtNajhq0dGDtYTDAQlmlrel6tvaHFK9NLD/ITHAF+MNrIVbE+dWNObM9aBMQ7DxbeyXMOOZKmLv8MNABrqof3lS39t1Tg28dhJwdkiMHhg6v1KEjYtAzhCe/8gobVjCZMqriIiG2wbcxABPkwHye+LdNfGUzMzLcmcJHQ0Wffku7l/wWt7BShkBLi3y4NeQjbAvYXsNETdX5cZir70ZteBTaHUPlEK8zBkWs+cLj3e6i4qJwhrLC7raUQGounBym7ilPyMO69khb+MR6l1cuUzbWPNrGlr4RL829yVARvyS7xWUfTP55YxwHohnllpbcf206UNJEs2psob+7j+k2Ll0//b2MECrQ7uk8KgSJqbRUkGuS+Y2QtIYy+PghOg89bRMR1A5WU2Sk0sPaN42AvxiwesvwHaHjJMYqCp0/cqg186RpqqFer/sLNYtpIc10ItoPpW0UcBQOPI4uqprpyeuJ9aSqMFkJyY0RSeBIw1+bnQa+Y5JSMtGYQnReZssjqu9KXAEENRnLRP7KCycX0GVlR7Ol2MvPKpam2OZv69aKkSakYLg7rppUdiUIB2XsxOhT3Jnzi8EGAihSZJY4=
X-Forefront-Antispam-Report: 
 CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:DM6PR12MB3834.namprd12.prod.outlook.com;PTR:;CAT:NONE;SFS:(4636009)(39860400002)(376002)(396003)(136003)(366004)(346002)(9746002)(9786002)(8676002)(6666004)(4326008)(54906003)(8936002)(5660300002)(36756003)(316002)(110136005)(30864003)(83380400001)(66946007)(66556008)(186003)(26005)(66476007)(478600001)(2906002)(426003)(86362001)(7416002)(2616005)(4216001);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData: 
 YE4eT/GMc1OmEPUryUDkfGcbbV6uKHKhSeuxjjula56PyJQi6yJzLWfQQPc1F+X2VvSpQoQ3OfFw7ALbLc9UP2HvLcuhl0P+A0WtD6Qik+eE84hXDhOkKmcklQVGmvdIBscUuRoaIwOzFzo4+Su29xO/SF9dKtdVVEhsQHNzKITV/bLkBngsH74dyiU2D+C92LQFfKrDmvoTHcOSOp9ucebsH+9EVXQMW0oa2zyNbILZflYYuR1i8gcwaOmySsMBk+LcRiPWeGy9dg4iEbPtqBujAv/hdkuv7ih9IoBLuDnghG4OmONuCM/ys70wRSEdbxgsYv/cLSxryWXR0mvfLXH+qMow5ep2a5S/HgQNK/pyLht71n/nJEpd45U5GXlKkkqVMR+9/p0urPC+2E9S08J+1NDJuDDNSuUfyqHdEXwhfyzy3ebhDRJ6lOpeVVgEYBN40pmOHokFwKKOjjh+VJwJ35ZammabTax2r52WeiqBBhctK/pns+eN3lvjfiOKstoRNDHer8ce35rwqZNCJGp72atqkC8xvbP0VOtY7KIkxh68yf+2ZAkxct8ymiomRCQk1WadOGbhb9Q6cHE3SHz3bKDcUa7w3r1qHtJq/aXaTH7bUg7SdLWMW4twWWGUq4J7IHtAeNS0j+NxTTHONC40On/zg+PLi1bvMY5aQDB2K86kPMjkSoKmd5owWmDY2OXjpzKM3ycV1itYavq38gB5nncS+0oA8lXpUDw4lurbSBwig5Me1752czSf185IQJx6Z/iNu7tQEyhB7lN/MpDtWilE28jMfPI7i7zuq/TqkdgOwtvni8M8YCXvpQIEM1gbGV7YDFCya34Z/5yrAYUlbR/li66IYg0HT0v8Kt9d8y8va5CQ3cGT/lDDX66HDbv7ECLT9YV8/uRU86HBUE47Ksv8l7+fJSOfwLOdzU7UBzFdgFP/KhF2G/u0ERNmvc4o98ivRL6CVp+d55FQAf8Dy9KfCBUWo/8IPXlWLbQ+Ay07iX7K4jFsHCYaZiI0PY9D7PqXIPseFqifmsxp7RoaGxKn1Ai+ccxGUdS6ucsAl7ZH/HL1VaKuJtkU9r62vOwQCL4YfruhA3igei9OrjQDnSj7GqANkS3O6MUoyo1Tm8yDMYv8AalRo/zEdQJ9UQMw1E61CcLAopukQmFrrqPU+xGmfDeXAmrQe6g0UzBSV2XNpuFsg/tnONFUmrfbYHTffgQjAOcU+/0Cxx/Vn+EhafzcouxUmXDzRrKG0XY3miXtOv1zJOODbqTc7YKLG+J7x9SlCPPHMbYna6C0luEP4EPcmViBEfZd6wsA1tCdLi5z4ov6+eLe1iUhn4IzJQFdZqpbfWRDPsruE++CFA==
X-OriginatorOrg: Nvidia.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 
 d47b6ee4-3c19-47ac-0c56-08d8e5bacb1d
X-MS-Exchange-CrossTenant-AuthSource: DM6PR12MB3834.namprd12.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 13 Mar 2021 00:56:10.9300
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 43083d15-7273-40c1-b7db-39efd9ccc17a
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: 
 tjShEJ5vZ6qs2LvT/WPSHQ9Mvwn0hgGXaWHCs83Pj/YaCdS473qhX8ZJZfpj1rHc
X-MS-Exchange-Transport-CrossTenantHeadersStamped: DM6PR12MB2940
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

This makes the struct vfio_pci_device part of the public interface so it
can be used with container_of and so forth, as is typical for a Linux
subystem.

This is the first step to bring some type-safety to the vfio interface by
allowing the replacement of 'void *' and 'struct device *' inputs with a
simple and clear 'struct vfio_pci_device *'

For now the self-allocating vfio_add_group_dev() interface is kept so each
user can be updated as a separate patch.

The expected usage pattern is

  driver core probe() function:
     my_device = kzalloc(sizeof(*mydevice));
     vfio_init_group_dev(&my_device->vdev, dev, ops, mydevice);
     /* other driver specific prep */
     vfio_register_group_dev(&my_device->vdev);
     dev_set_drvdata(my_device);

  driver core remove() function:
     my_device = dev_get_drvdata(dev);
     vfio_unregister_group_dev(&my_device->vdev);
     /* other driver specific tear down */
     kfree(my_device);

Allowing the driver to be able to use the drvdata and vifo_device to go
to/from its own data.

The pattern also makes it clear that vfio_register_group_dev() must be
last in the sequence, as once it is called the core code can immediately
start calling ops. The init/register gap is provided to allow for the
driver to do setup before ops can be called and thus avoid races.

Reviewed-by: Christoph Hellwig <hch@lst.de>
Reviewed-by: Liu Yi L <yi.l.liu@intel.com>
Signed-off-by: Jason Gunthorpe <jgg@nvidia.com>
---
 Documentation/driver-api/vfio.rst |  31 ++++----
 drivers/vfio/vfio.c               | 123 ++++++++++++++++--------------
 include/linux/vfio.h              |  16 ++++
 3 files changed, 98 insertions(+), 72 deletions(-)

diff --git a/Documentation/driver-api/vfio.rst b/Documentation/driver-api/vfio.rst
index f1a4d3c3ba0bb1..d3a02300913a7f 100644
--- a/Documentation/driver-api/vfio.rst
+++ b/Documentation/driver-api/vfio.rst
@@ -249,18 +249,23 @@ VFIO bus driver API
 
 VFIO bus drivers, such as vfio-pci make use of only a few interfaces
 into VFIO core.  When devices are bound and unbound to the driver,
-the driver should call vfio_add_group_dev() and vfio_del_group_dev()
-respectively::
-
-	extern int vfio_add_group_dev(struct device *dev,
-				      const struct vfio_device_ops *ops,
-				      void *device_data);
-
-	extern void *vfio_del_group_dev(struct device *dev);
-
-vfio_add_group_dev() indicates to the core to begin tracking the
-iommu_group of the specified dev and register the dev as owned by
-a VFIO bus driver.  The driver provides an ops structure for callbacks
+the driver should call vfio_register_group_dev() and
+vfio_unregister_group_dev() respectively::
+
+	void vfio_init_group_dev(struct vfio_device *device,
+				struct device *dev,
+				const struct vfio_device_ops *ops,
+				void *device_data);
+	int vfio_register_group_dev(struct vfio_device *device);
+	void vfio_unregister_group_dev(struct vfio_device *device);
+
+The driver should embed the vfio_device in its own structure and call
+vfio_init_group_dev() to pre-configure it before going to registration.
+vfio_register_group_dev() indicates to the core to begin tracking the
+iommu_group of the specified dev and register the dev as owned by a VFIO bus
+driver. Once vfio_register_group_dev() returns it is possible for userspace to
+start accessing the driver, thus the driver should ensure it is completely
+ready before calling it. The driver provides an ops structure for callbacks
 similar to a file operations structure::
 
 	struct vfio_device_ops {
@@ -276,7 +281,7 @@ similar to a file operations structure::
 	};
 
 Each function is passed the device_data that was originally registered
-in the vfio_add_group_dev() call above.  This allows the bus driver
+in the vfio_register_group_dev() call above.  This allows the bus driver
 an easy place to store its opaque, private data.  The open/release
 callbacks are issued when a new file descriptor is created for a
 device (via VFIO_GROUP_GET_DEVICE_FD).  The ioctl interface provides
diff --git a/drivers/vfio/vfio.c b/drivers/vfio/vfio.c
index 32660e8a69ae20..cfa06ae3b9018b 100644
--- a/drivers/vfio/vfio.c
+++ b/drivers/vfio/vfio.c
@@ -89,16 +89,6 @@ struct vfio_group {
 	struct blocking_notifier_head	notifier;
 };
 
-struct vfio_device {
-	refcount_t			refcount;
-	struct completion		comp;
-	struct device			*dev;
-	const struct vfio_device_ops	*ops;
-	struct vfio_group		*group;
-	struct list_head		group_next;
-	void				*device_data;
-};
-
 #ifdef CONFIG_VFIO_NOIOMMU
 static bool noiommu __read_mostly;
 module_param_named(enable_unsafe_noiommu_mode,
@@ -532,35 +522,6 @@ static struct vfio_group *vfio_group_get_from_dev(struct device *dev)
 /**
  * Device objects - create, release, get, put, search
  */
-static
-struct vfio_device *vfio_group_create_device(struct vfio_group *group,
-					     struct device *dev,
-					     const struct vfio_device_ops *ops,
-					     void *device_data)
-{
-	struct vfio_device *device;
-
-	device = kzalloc(sizeof(*device), GFP_KERNEL);
-	if (!device)
-		return ERR_PTR(-ENOMEM);
-
-	refcount_set(&device->refcount, 1);
-	init_completion(&device->comp);
-	device->dev = dev;
-	/* Our reference on group is moved to the device */
-	device->group = group;
-	device->ops = ops;
-	device->device_data = device_data;
-	dev_set_drvdata(dev, device);
-
-	mutex_lock(&group->device_lock);
-	list_add(&device->group_next, &group->device_list);
-	group->dev_counter++;
-	mutex_unlock(&group->device_lock);
-
-	return device;
-}
-
 /* Device reference always implies a group reference */
 void vfio_device_put(struct vfio_device *device)
 {
@@ -779,14 +740,23 @@ static int vfio_iommu_group_notifier(struct notifier_block *nb,
 /**
  * VFIO driver API
  */
-int vfio_add_group_dev(struct device *dev,
-		       const struct vfio_device_ops *ops, void *device_data)
+void vfio_init_group_dev(struct vfio_device *device, struct device *dev,
+			 const struct vfio_device_ops *ops, void *device_data)
+{
+	init_completion(&device->comp);
+	device->dev = dev;
+	device->ops = ops;
+	device->device_data = device_data;
+}
+EXPORT_SYMBOL_GPL(vfio_init_group_dev);
+
+int vfio_register_group_dev(struct vfio_device *device)
 {
+	struct vfio_device *existing_device;
 	struct iommu_group *iommu_group;
 	struct vfio_group *group;
-	struct vfio_device *device;
 
-	iommu_group = iommu_group_get(dev);
+	iommu_group = iommu_group_get(device->dev);
 	if (!iommu_group)
 		return -EINVAL;
 
@@ -805,21 +775,50 @@ int vfio_add_group_dev(struct device *dev,
 		iommu_group_put(iommu_group);
 	}
 
-	device = vfio_group_get_device(group, dev);
-	if (device) {
-		dev_WARN(dev, "Device already exists on group %d\n",
+	existing_device = vfio_group_get_device(group, device->dev);
+	if (existing_device) {
+		dev_WARN(device->dev, "Device already exists on group %d\n",
 			 iommu_group_id(iommu_group));
-		vfio_device_put(device);
+		vfio_device_put(existing_device);
 		vfio_group_put(group);
 		return -EBUSY;
 	}
 
-	device = vfio_group_create_device(group, dev, ops, device_data);
-	if (IS_ERR(device)) {
-		vfio_group_put(group);
-		return PTR_ERR(device);
-	}
+	/* Our reference on group is moved to the device */
+	device->group = group;
+
+	/* Refcounting can't start until the driver calls register */
+	refcount_set(&device->refcount, 1);
+
+	mutex_lock(&group->device_lock);
+	list_add(&device->group_next, &group->device_list);
+	group->dev_counter++;
+	mutex_unlock(&group->device_lock);
+
+	return 0;
+}
+EXPORT_SYMBOL_GPL(vfio_register_group_dev);
+
+int vfio_add_group_dev(struct device *dev, const struct vfio_device_ops *ops,
+		       void *device_data)
+{
+	struct vfio_device *device;
+	int ret;
+
+	device = kzalloc(sizeof(*device), GFP_KERNEL);
+	if (!device)
+		return -ENOMEM;
+
+	vfio_init_group_dev(device, dev, ops, device_data);
+	ret = vfio_register_group_dev(device);
+	if (ret)
+		goto err_kfree;
+	dev_set_drvdata(dev, device);
 	return 0;
+
+err_kfree:
+	kfree(device);
+	return ret;
 }
 EXPORT_SYMBOL_GPL(vfio_add_group_dev);
 
@@ -887,11 +886,9 @@ EXPORT_SYMBOL_GPL(vfio_device_data);
 /*
  * Decrement the device reference count and wait for the device to be
  * removed.  Open file descriptors for the device... */
-void *vfio_del_group_dev(struct device *dev)
+void vfio_unregister_group_dev(struct vfio_device *device)
 {
-	struct vfio_device *device = dev_get_drvdata(dev);
 	struct vfio_group *group = device->group;
-	void *device_data = device->device_data;
 	struct vfio_unbound_dev *unbound;
 	unsigned int i = 0;
 	bool interrupted = false;
@@ -908,7 +905,7 @@ void *vfio_del_group_dev(struct device *dev)
 	 */
 	unbound = kzalloc(sizeof(*unbound), GFP_KERNEL);
 	if (unbound) {
-		unbound->dev = dev;
+		unbound->dev = device->dev;
 		mutex_lock(&group->unbound_lock);
 		list_add(&unbound->unbound_next, &group->unbound_list);
 		mutex_unlock(&group->unbound_lock);
@@ -919,7 +916,7 @@ void *vfio_del_group_dev(struct device *dev)
 	rc = try_wait_for_completion(&device->comp);
 	while (rc <= 0) {
 		if (device->ops->request)
-			device->ops->request(device_data, i++);
+			device->ops->request(device->device_data, i++);
 
 		if (interrupted) {
 			rc = wait_for_completion_timeout(&device->comp,
@@ -929,7 +926,7 @@ void *vfio_del_group_dev(struct device *dev)
 				&device->comp, HZ * 10);
 			if (rc < 0) {
 				interrupted = true;
-				dev_warn(dev,
+				dev_warn(device->dev,
 					 "Device is currently in use, task"
 					 " \"%s\" (%d) "
 					 "blocked until device is released",
@@ -962,9 +959,17 @@ void *vfio_del_group_dev(struct device *dev)
 
 	/* Matches the get in vfio_group_create_device() */
 	vfio_group_put(group);
+}
+EXPORT_SYMBOL_GPL(vfio_unregister_group_dev);
+
+void *vfio_del_group_dev(struct device *dev)
+{
+	struct vfio_device *device = dev_get_drvdata(dev);
+	void *device_data = device->device_data;
+
+	vfio_unregister_group_dev(device);
 	dev_set_drvdata(dev, NULL);
 	kfree(device);
-
 	return device_data;
 }
 EXPORT_SYMBOL_GPL(vfio_del_group_dev);
diff --git a/include/linux/vfio.h b/include/linux/vfio.h
index b7e18bde5aa8b3..ad8b579d67d34a 100644
--- a/include/linux/vfio.h
+++ b/include/linux/vfio.h
@@ -15,6 +15,18 @@
 #include <linux/poll.h>
 #include <uapi/linux/vfio.h>
 
+struct vfio_device {
+	struct device *dev;
+	const struct vfio_device_ops *ops;
+	struct vfio_group *group;
+
+	/* Members below here are private, not for driver use */
+	refcount_t refcount;
+	struct completion comp;
+	struct list_head group_next;
+	void *device_data;
+};
+
 /**
  * struct vfio_device_ops - VFIO bus driver device callbacks
  *
@@ -48,11 +60,15 @@ struct vfio_device_ops {
 extern struct iommu_group *vfio_iommu_group_get(struct device *dev);
 extern void vfio_iommu_group_put(struct iommu_group *group, struct device *dev);
 
+void vfio_init_group_dev(struct vfio_device *device, struct device *dev,
+			 const struct vfio_device_ops *ops, void *device_data);
+int vfio_register_group_dev(struct vfio_device *device);
 extern int vfio_add_group_dev(struct device *dev,
 			      const struct vfio_device_ops *ops,
 			      void *device_data);
 
 extern void *vfio_del_group_dev(struct device *dev);
+void vfio_unregister_group_dev(struct vfio_device *device);
 extern struct vfio_device *vfio_device_get_from_dev(struct device *dev);
 extern void vfio_device_put(struct vfio_device *device);
 extern void *vfio_device_data(struct vfio_device *device);

From patchwork Sat Mar 13 00:55:56 2021
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
X-Patchwork-Submitter: Jason Gunthorpe <jgg@nvidia.com>
X-Patchwork-Id: 12136223
Return-Path: <kvm-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-16.0 required=3.0 tests=BAYES_00,DKIMWL_WL_HIGH,
	DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,
	INCLUDES_CR_TRAILER,INCLUDES_PATCH,MAILING_LIST_MULTI,MSGID_FROM_MTA_HEADER,
	SPF_HELO_NONE,SPF_PASS autolearn=ham autolearn_force=no version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 91477C4332D
	for <kvm@archiver.kernel.org>; Sat, 13 Mar 2021 00:57:01 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 6C7F264F5F
	for <kvm@archiver.kernel.org>; Sat, 13 Mar 2021 00:57:01 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S232840AbhCMA4a (ORCPT <rfc822;kvm@archiver.kernel.org>);
        Fri, 12 Mar 2021 19:56:30 -0500
Received: from mail-dm6nam12on2065.outbound.protection.outlook.com
 ([40.107.243.65]:30549
        "EHLO NAM12-DM6-obe.outbound.protection.outlook.com"
        rhost-flags-OK-OK-OK-FAIL) by vger.kernel.org with ESMTP
        id S231679AbhCMA4N (ORCPT <rfc822;kvm@vger.kernel.org>);
        Fri, 12 Mar 2021 19:56:13 -0500
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=fLUbJyoHKXovFC0s3duvPWbhVYRvSs33MQ6Pe7VLEUtXgs1/fXGXPw08qW7JcvliRX8bL68m357ujnTDtTejsC/hY8XxZqn0xnkdnHETpeIGoxrv9OZPg7Wnf/xg75vYAgUAeeXxj31EeEBnH1F5GXWJmk+cBGgqoLn4xvx4fGQ1F22OEWq5SM/t1GDdGWMgjpPAu41STfwJQ4DmouXXTpJ933oBttkLPnZ8T6t937daRlwAEWmqypf6d6f0U7QJVLpiO0hedz0ubHaFYtSFh0F36Oe6oHyXl0El1Xk0E5yvGvtXEau6RjExk/m0Ksf3GiNQYVZveM6lpI0MXlhapQ==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=9UHYrFLiPZV8NmFSDwiIQzvR9eTpwaX5BQQ4w4AsxPg=;
 b=mbdSPUtk/6Fg2ORu4sCAnfL5xks/PDr9OruEh2MlRK2iFyrDMjkJ6bUkUb6ZnernRHOgh3t0AGUx58peG4rrOWSpdsVPagfqKE9xKBM8B/RVN+0QBSkO5BQ9ZIhjw0SyCYNdqzNky1CqqiqGiDSHAO4PKPK2ENk7Kt9g16Q6dVkElCjtSNg6sc181Pi93iZddPC9YYlLXg/tsqxSn6iUR76dRV/H5JI3N0IChMHsxkcSNcXPiDyfDOfAsGMP8niUSoBhdUsqEHOLVE9/0ss+zfUedr1hkrWmn1H8q2hQmquvipD5Gzy66AthFDXXu3/+GpVjufeTCiTYugsKSz0nQg==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=nvidia.com; dmarc=pass action=none header.from=nvidia.com;
 dkim=pass header.d=nvidia.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=Nvidia.com;
 s=selector2;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=9UHYrFLiPZV8NmFSDwiIQzvR9eTpwaX5BQQ4w4AsxPg=;
 b=fPFj4CJTOgDyqESMSAbtvePzEDZaE26UZEYQjiVfqvUpvmRUc5XnaqUKMQXtVoZQzoQbI5sQpyhLlcfQPSt2i9wZBfANDvZLy3V8ABNxybbekH+OSavtfj8+lLHOhmgzgNRWzc5ictB2Cp0rThdMhvGJfQDzON2DfZQnZCDtCUnqkqwpsLstWFSfRFbC+yaxk9y/jOReN8S/eRrXPYdyE7tMFu/hWQTbwAFtt1GUMXm+naVP1gCFEeprS6rwOtkLvEy4yXj3uGEWAXwAOE8AN8KvOAGH2cBUGBQt8xJpWFmf9Sp7rvZxn+AjtoXScZPJJK/kowWBUJbHTMxKIEpZUw==
Authentication-Results: redhat.com; dkim=none (message not signed)
 header.d=none;redhat.com; dmarc=none action=none header.from=nvidia.com;
Received: from DM6PR12MB3834.namprd12.prod.outlook.com (2603:10b6:5:14a::12)
 by DM6PR12MB2940.namprd12.prod.outlook.com (2603:10b6:5:15f::19) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.3933.31; Sat, 13 Mar
 2021 00:56:10 +0000
Received: from DM6PR12MB3834.namprd12.prod.outlook.com
 ([fe80::1c62:7fa3:617b:ab87]) by DM6PR12MB3834.namprd12.prod.outlook.com
 ([fe80::1c62:7fa3:617b:ab87%6]) with mapi id 15.20.3933.032; Sat, 13 Mar 2021
 00:56:10 +0000
From: Jason Gunthorpe <jgg@nvidia.com>
To: Alex Williamson <alex.williamson@redhat.com>,
        Cornelia Huck <cohuck@redhat.com>,
        Eric Auger <eric.auger@redhat.com>, kvm@vger.kernel.org
Cc: "Raj, Ashok" <ashok.raj@intel.com>,
        Dan Williams <dan.j.williams@intel.com>,
        Daniel Vetter <daniel@ffwll.ch>,
        Christoph Hellwig <hch@lst.de>,
        Leon Romanovsky <leonro@nvidia.com>,
        Max Gurtovoy <mgurtovoy@nvidia.com>,
        Tarun Gupta <targupta@nvidia.com>
Subject: [PATCH v2 04/14] vfio/platform: Use
 vfio_init/register/unregister_group_dev
Date: Fri, 12 Mar 2021 20:55:56 -0400
Message-Id: <4-v2-20d933792272+4ff-vfio1_jgg@nvidia.com>
In-Reply-To: <0-v2-20d933792272+4ff-vfio1_jgg@nvidia.com>
References: 
X-Originating-IP: [142.162.115.133]
X-ClientProxiedBy: BL1PR13CA0175.namprd13.prod.outlook.com
 (2603:10b6:208:2bd::30) To DM6PR12MB3834.namprd12.prod.outlook.com
 (2603:10b6:5:14a::12)
MIME-Version: 1.0
X-MS-Exchange-MessageSentRepresentingType: 1
Received: from mlx.ziepe.ca (142.162.115.133) by
 BL1PR13CA0175.namprd13.prod.outlook.com (2603:10b6:208:2bd::30) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.3955.11 via Frontend
 Transport; Sat, 13 Mar 2021 00:56:09 +0000
Received: from jgg by mlx with local (Exim 4.94)        (envelope-from
 <jgg@nvidia.com>)        id 1lKsZa-00EMAx-T9; Fri, 12 Mar 2021 20:56:06 -0400
X-MS-PublicTrafficType: Email
X-MS-Office365-Filtering-Correlation-Id: 87da1b21-3055-46b5-2070-08d8e5baca77
X-MS-TrafficTypeDiagnostic: DM6PR12MB2940:
X-MS-Exchange-Transport-Forked: True
X-Microsoft-Antispam-PRVS: 
 <DM6PR12MB29409E4420D9FF11F3FE4BBCC26E9@DM6PR12MB2940.namprd12.prod.outlook.com>
X-MS-Oob-TLC-OOBClassifiers: OLM:4941;
X-MS-Exchange-SenderADCheck: 1
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: 
 /vKyNFH84lCZsP/yb5CFYWAZ0YvgpPWniJCA2fR2qM6fUbxOYxyisTSdKjWfr6tDHaRIHC0LyPBp1ilS+PojBHHSewfpKU4/88v6Gr6xAcrxu31eg01Y7hkJ8Wy/+xx07g7w6n5Gl8Y96IlaL0AGLzWxXpNgrX+x+RKqEe5I2BVXRCyhMfVE00pSlBaTTg3c7W2qJmAS0ZfRyNt9Ye7/yHJji/aZ0leVyWTwZdmBubfuSuYpBKG+Ygs6+K6HFgYm8gfEy4Yz17tJhN+5pJTpi7I+ShVVT7WntCcbKC2iqmdMxZtB0aI2ks1VfZPvUvgPjHEa/UrzZsPhyHXfy6ltJhhH1hMV9ddG9ntuLhzAgRFCN1tWrpHfy+XnMXLpM/ns32XfOvKMtcgE/rs8G4SFt4XC6ixnqKLXIWtr0qZDYBK09dTTr0J0X52cO1wA5hWrQK+/6usESq9gMzZTRxbfc6vaKBGbJolTfnraQNQ98St3j+cT2TsZFOAMaW/tyQB4pN5XPqql5194nymr2wF8+Rgg4TzDn0l2iZDSqdYbIbw+m2sK/vXWrPPiM0GiAsVtu9RY0yApKSTLD3x3OrQYXy1cvpBupcg9Yh26QjxhDkw=
X-Forefront-Antispam-Report: 
 CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:DM6PR12MB3834.namprd12.prod.outlook.com;PTR:;CAT:NONE;SFS:(4636009)(39860400002)(376002)(396003)(136003)(366004)(346002)(9746002)(9786002)(8676002)(6666004)(4326008)(107886003)(54906003)(8936002)(5660300002)(36756003)(316002)(110136005)(83380400001)(66946007)(66556008)(186003)(26005)(66476007)(478600001)(2906002)(426003)(86362001)(2616005)(4216001);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData: 
 ifcE6GfbHWk/mf5LqSrjzESjbe/NjlZ216CuwrFugOHKc/U8bVA+EQ/H9hzwgHKKkBjhnstANdgK/Dm40xTkr+djd945gxHO0Baqth5ELwD1TpD0MUi+lAUX8ptiI+BVpZrL9weXylMQlWwPkZ/U9CNi2vNCTX0Yui5ExVMQAVZSybEReAznUBLwBs9r977scEQZY61/UlxhjO92kSMyk0da2IRebvqNfreownUS7W6aDvE+JJNLTR1WopU24MQ5Z6BjEXS0RjjXEMaTxlUc9Vd78p+SYp2YDBVmdFAwSymCQnhuouBpdIbNeRaJZrZQ5I8aoaiTze4VkKPO3XR4KcqNBHq7CZVagleHkI1xIQxCr1GAxUafzDCsPbp6itO8Re7CemUXoPWZj/hccUPxMN6EiBzTfhrPn1zDtrCp6Ux6HhqIEMnwv4ruK6NWSofroNebJlCMJTmKRGoSSlJOGo2e/1BjLbjamoCY1e6NiPExaVnQLvgbFPJq+FE+AgpypEI0mr/3o/CcJunpPHT71oF16a9lRPiitRhaX9FVcoI0NNg3SYYXkcXC7arv+UF2UUWBjub+5pBRKfARvk4dCPSmVKRrOKGu/pkf6jMU4M3W16lliKVAaqdi5c6JvPRW8CCpcWi9q2zsMgLCJCZzhUmX+wrn7QadCsp7Qjs461i6JEGSGNy9jtIwPcWTvhwnDfYNJUU7ehjxZ9FKmnMMvASaTLYAVjrpm5wCZSvTfpVgFyLq9q/j6Vlht1jDDyVwevkYhYgtI6USBEalqTZTT8XnTt4vzYRr4nBv9x+Nry+RI+Q4LaaL6I8e3N70z0eaDcOidr+VPXY6sYxLlWbqAh3SItQ0TV/+aJiExo8IKkd/RUqNH7KHlWW1pWE9Ni6hNElBJynkfXzxnJTb7xNvUA+p/QdanEba3ULiu632h56pdvzIiYqwBEcyevRupQBtoecD5Y/BRnHZ2tKro5X3YEVNgIUny1FqMVDeevg0lTUy55Y8ItOG2KLCRh6EJzRrno3PBY6PfX74hiwRkSgSUBLZEo0HTY1XX43/fzZyFiICfnWjcIWon3Id2riFTd5667cA5KO3OfIbsmosrCjSxZhCeuBrltqnjQhdogrq58uvSXYLVGrW1CJPcRmhSxAn45/CUErYRr+wEv4c6Y9L3T4kTn4mNHvj2uOABPaeo06Em3IGhUtB/pI+smwObXAAiBzFxlntyveW4dSHwDBzSxAUUkCfrpwM9oAMpprIBlbKx/RjFE2VzdKDttZnAUq4XeFOGbYILRQg+f1LQbEYMZFDBvoNVeHqg68iflliZQDvERrZIcx5xOi6LuNDGgWqWhohrGLVwTLj9fW7kbylWw==
X-OriginatorOrg: Nvidia.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 
 87da1b21-3055-46b5-2070-08d8e5baca77
X-MS-Exchange-CrossTenant-AuthSource: DM6PR12MB3834.namprd12.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 13 Mar 2021 00:56:09.8466
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 43083d15-7273-40c1-b7db-39efd9ccc17a
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: 
 QCPDbAF04Cr6vbvcjVRAI+SwYHru8pNvhanaQ45NcO341otsmmfj+4Dh3Zu9Dja5
X-MS-Exchange-Transport-CrossTenantHeadersStamped: DM6PR12MB2940
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

platform already allocates a struct vfio_platform_device with exactly
the same lifetime as vfio_device, switch to the new API and embed
vfio_device in vfio_platform_device.

Reviewed-by: Christoph Hellwig <hch@lst.de>
Signed-off-by: Jason Gunthorpe <jgg@nvidia.com>
---
 drivers/vfio/platform/vfio_amba.c             |  8 ++++---
 drivers/vfio/platform/vfio_platform.c         | 21 ++++++++---------
 drivers/vfio/platform/vfio_platform_common.c  | 23 +++++++------------
 drivers/vfio/platform/vfio_platform_private.h |  5 ++--
 4 files changed, 26 insertions(+), 31 deletions(-)

diff --git a/drivers/vfio/platform/vfio_amba.c b/drivers/vfio/platform/vfio_amba.c
index 3626c21501017e..f970eb2a999f29 100644
--- a/drivers/vfio/platform/vfio_amba.c
+++ b/drivers/vfio/platform/vfio_amba.c
@@ -66,16 +66,18 @@ static int vfio_amba_probe(struct amba_device *adev, const struct amba_id *id)
 	if (ret) {
 		kfree(vdev->name);
 		kfree(vdev);
+		return ret;
 	}
 
-	return ret;
+	dev_set_drvdata(&adev->dev, vdev);
+	return 0;
 }
 
 static void vfio_amba_remove(struct amba_device *adev)
 {
-	struct vfio_platform_device *vdev =
-		vfio_platform_remove_common(&adev->dev);
+	struct vfio_platform_device *vdev = dev_get_drvdata(&adev->dev);
 
+	vfio_platform_remove_common(vdev);
 	kfree(vdev->name);
 	kfree(vdev);
 }
diff --git a/drivers/vfio/platform/vfio_platform.c b/drivers/vfio/platform/vfio_platform.c
index 9fb6818cea12cb..f7b3f64ecc7f6c 100644
--- a/drivers/vfio/platform/vfio_platform.c
+++ b/drivers/vfio/platform/vfio_platform.c
@@ -54,23 +54,22 @@ static int vfio_platform_probe(struct platform_device *pdev)
 	vdev->reset_required = reset_required;
 
 	ret = vfio_platform_probe_common(vdev, &pdev->dev);
-	if (ret)
+	if (ret) {
 		kfree(vdev);
-
-	return ret;
+		return ret;
+	}
+	dev_set_drvdata(&pdev->dev, vdev);
+	return 0;
 }
 
 static int vfio_platform_remove(struct platform_device *pdev)
 {
-	struct vfio_platform_device *vdev;
-
-	vdev = vfio_platform_remove_common(&pdev->dev);
-	if (vdev) {
-		kfree(vdev);
-		return 0;
-	}
+	struct vfio_platform_device *vdev = dev_get_drvdata(&pdev->dev);
 
-	return -EINVAL;
+	vfio_platform_remove_common(vdev);
+	kfree(vdev->name);
+	kfree(vdev);
+	return 0;
 }
 
 static struct platform_driver vfio_platform_driver = {
diff --git a/drivers/vfio/platform/vfio_platform_common.c b/drivers/vfio/platform/vfio_platform_common.c
index fb4b385191f288..6eb749250ee41c 100644
--- a/drivers/vfio/platform/vfio_platform_common.c
+++ b/drivers/vfio/platform/vfio_platform_common.c
@@ -659,8 +659,7 @@ int vfio_platform_probe_common(struct vfio_platform_device *vdev,
 	struct iommu_group *group;
 	int ret;
 
-	if (!vdev)
-		return -EINVAL;
+	vfio_init_group_dev(&vdev->vdev, dev, &vfio_platform_ops, vdev);
 
 	ret = vfio_platform_acpi_probe(vdev, dev);
 	if (ret)
@@ -685,13 +684,13 @@ int vfio_platform_probe_common(struct vfio_platform_device *vdev,
 		goto put_reset;
 	}
 
-	ret = vfio_add_group_dev(dev, &vfio_platform_ops, vdev);
+	ret = vfio_register_group_dev(&vdev->vdev);
 	if (ret)
 		goto put_iommu;
 
 	mutex_init(&vdev->igate);
 
-	pm_runtime_enable(vdev->device);
+	pm_runtime_enable(dev);
 	return 0;
 
 put_iommu:
@@ -702,19 +701,13 @@ int vfio_platform_probe_common(struct vfio_platform_device *vdev,
 }
 EXPORT_SYMBOL_GPL(vfio_platform_probe_common);
 
-struct vfio_platform_device *vfio_platform_remove_common(struct device *dev)
+void vfio_platform_remove_common(struct vfio_platform_device *vdev)
 {
-	struct vfio_platform_device *vdev;
-
-	vdev = vfio_del_group_dev(dev);
+	vfio_unregister_group_dev(&vdev->vdev);
 
-	if (vdev) {
-		pm_runtime_disable(vdev->device);
-		vfio_platform_put_reset(vdev);
-		vfio_iommu_group_put(dev->iommu_group, dev);
-	}
-
-	return vdev;
+	pm_runtime_disable(vdev->device);
+	vfio_platform_put_reset(vdev);
+	vfio_iommu_group_put(vdev->vdev.dev->iommu_group, vdev->vdev.dev);
 }
 EXPORT_SYMBOL_GPL(vfio_platform_remove_common);
 
diff --git a/drivers/vfio/platform/vfio_platform_private.h b/drivers/vfio/platform/vfio_platform_private.h
index 289089910643ac..a5ba82c8cbc354 100644
--- a/drivers/vfio/platform/vfio_platform_private.h
+++ b/drivers/vfio/platform/vfio_platform_private.h
@@ -9,6 +9,7 @@
 
 #include <linux/types.h>
 #include <linux/interrupt.h>
+#include <linux/vfio.h>
 
 #define VFIO_PLATFORM_OFFSET_SHIFT   40
 #define VFIO_PLATFORM_OFFSET_MASK (((u64)(1) << VFIO_PLATFORM_OFFSET_SHIFT) - 1)
@@ -42,6 +43,7 @@ struct vfio_platform_region {
 };
 
 struct vfio_platform_device {
+	struct vfio_device		vdev;
 	struct vfio_platform_region	*regions;
 	u32				num_regions;
 	struct vfio_platform_irq	*irqs;
@@ -80,8 +82,7 @@ struct vfio_platform_reset_node {
 
 extern int vfio_platform_probe_common(struct vfio_platform_device *vdev,
 				      struct device *dev);
-extern struct vfio_platform_device *vfio_platform_remove_common
-				     (struct device *dev);
+void vfio_platform_remove_common(struct vfio_platform_device *vdev);
 
 extern int vfio_platform_irq_init(struct vfio_platform_device *vdev);
 extern void vfio_platform_irq_cleanup(struct vfio_platform_device *vdev);

From patchwork Sat Mar 13 00:55:57 2021
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
X-Patchwork-Submitter: Jason Gunthorpe <jgg@nvidia.com>
X-Patchwork-Id: 12136217
Return-Path: <kvm-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-16.0 required=3.0 tests=BAYES_00,DKIMWL_WL_HIGH,
	DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,
	INCLUDES_CR_TRAILER,INCLUDES_PATCH,MAILING_LIST_MULTI,MSGID_FROM_MTA_HEADER,
	SPF_HELO_NONE,SPF_PASS autolearn=ham autolearn_force=no version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 4099EC433DB
	for <kvm@archiver.kernel.org>; Sat, 13 Mar 2021 00:57:01 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 12C3D64F8E
	for <kvm@archiver.kernel.org>; Sat, 13 Mar 2021 00:57:01 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S232697AbhCMA43 (ORCPT <rfc822;kvm@archiver.kernel.org>);
        Fri, 12 Mar 2021 19:56:29 -0500
Received: from mail-dm6nam12on2065.outbound.protection.outlook.com
 ([40.107.243.65]:30549
        "EHLO NAM12-DM6-obe.outbound.protection.outlook.com"
        rhost-flags-OK-OK-OK-FAIL) by vger.kernel.org with ESMTP
        id S229968AbhCMA4M (ORCPT <rfc822;kvm@vger.kernel.org>);
        Fri, 12 Mar 2021 19:56:12 -0500
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=cCedcAimrAvrHdLtSvCZXSUap9q8+HbZCM2coerKDexokifvQRTAtorjIAGlavzLTHcc6/ClNziujzb8HJeMZRfJ409M4QxWDmSDY6PsykU/bXgVy0p9Cf0xtqyMZ65qplsHzKTW9S33YnDL3c5lRaDZ7lBfxSepBysBzoFPMkpIwgFY/RMxzPx/yTz57VbkTOMgPCoi7Z4KZPzOqKdaHVpFiEpqpvrqNK+G0qfD15sJyfe+RYGzsSyVKxQSEqjm4T5Gm1g4IHl5t9AHBpGHyP4fjG6xIRtgOsO6dEVGSvyBAAAb374ibi8J5yZ3AcF4BMMH10haS9s58Bfo5XK58g==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=PFDMldiKKN1KfYi4zZ5BY279M7dvQOOT6wffdMdWF1I=;
 b=Mi/if8TQHcUd7SHctiqGDdtEXEJYbixClIEkn2bbW9ZdXojoJKVX3xYjA5auZIKLxezvyQYovBo1Yf73rp2WDhTcw3ZVhFN8LJ/fAfPsovIz6Gfex/LrrtPsN0xkQJ6FPEJf7kXQuQBfmrwcP9osF2UiJQHcA5QGEtYu5foe2x4KbUKPqvMMemkNQTTM+E+goCp2dFB7BZ8y4pDAsdmasE4F0AEfNbTfnH9t1TTXJBdZUIIT16uqDhHOygYVixCuJGLqyjWi1WweqlOd+Pb1+EKiwuIWMP761GGqu+B+2/ox6O5HUGBT5cOEIX/HSqm9XS1BIlVl9AIrmv/VB+5jGA==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=nvidia.com; dmarc=pass action=none header.from=nvidia.com;
 dkim=pass header.d=nvidia.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=Nvidia.com;
 s=selector2;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=PFDMldiKKN1KfYi4zZ5BY279M7dvQOOT6wffdMdWF1I=;
 b=h6uEpnei2EzVqi3SlWiEu99xptm+0cdYNgZ4d7MJiybO6O3oLyevZcLtmcg8CJrGpuuDqSQb31KMeGwYi975ogufh4VJJJWJcqWSbL46DFCrTO8NpgJr9m5S7GfKZMj4WJUYZdFUlzLkZgr21+HDdPKAj4+IRx0nXnyIyI8DR2oahymjqsM4u+F9OCLr7rEzu+RCxsxYLr6aA/NpGkElvIkgEp556nFKxEB4fBzWT+r1+3hXIFR+5DCr9k2tTMfd/hYh07ErCUHMxKMfg5TvEnSaJQLxk4EhQhjqLW+p9KnFKnM+LLxF0A21Lm1BmL3ZZi+d3FTJSH2VH6jcz2VUeQ==
Authentication-Results: redhat.com; dkim=none (message not signed)
 header.d=none;redhat.com; dmarc=none action=none header.from=nvidia.com;
Received: from DM6PR12MB3834.namprd12.prod.outlook.com (2603:10b6:5:14a::12)
 by DM6PR12MB2940.namprd12.prod.outlook.com (2603:10b6:5:15f::19) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.3933.31; Sat, 13 Mar
 2021 00:56:09 +0000
Received: from DM6PR12MB3834.namprd12.prod.outlook.com
 ([fe80::1c62:7fa3:617b:ab87]) by DM6PR12MB3834.namprd12.prod.outlook.com
 ([fe80::1c62:7fa3:617b:ab87%6]) with mapi id 15.20.3933.032; Sat, 13 Mar 2021
 00:56:09 +0000
From: Jason Gunthorpe <jgg@nvidia.com>
To: Cornelia Huck <cohuck@redhat.com>, kvm@vger.kernel.org
Cc: Alex Williamson <alex.williamson@redhat.com>,
        "Raj, Ashok" <ashok.raj@intel.com>,
        Bharat Bhushan <Bharat.Bhushan@nxp.com>,
        Dan Williams <dan.j.williams@intel.com>,
        Daniel Vetter <daniel@ffwll.ch>,
        Diana Craciun <diana.craciun@oss.nxp.com>,
        Eric Auger <eric.auger@redhat.com>,
        Christoph Hellwig <hch@lst.de>,
        Leon Romanovsky <leonro@nvidia.com>,
        Max Gurtovoy <mgurtovoy@nvidia.com>,
        Tarun Gupta <targupta@nvidia.com>
Subject: [PATCH v2 05/14] vfio/fsl-mc: Re-order vfio_fsl_mc_probe()
Date: Fri, 12 Mar 2021 20:55:57 -0400
Message-Id: <5-v2-20d933792272+4ff-vfio1_jgg@nvidia.com>
In-Reply-To: <0-v2-20d933792272+4ff-vfio1_jgg@nvidia.com>
References: 
X-Originating-IP: [142.162.115.133]
X-ClientProxiedBy: BLAPR03CA0128.namprd03.prod.outlook.com
 (2603:10b6:208:32e::13) To DM6PR12MB3834.namprd12.prod.outlook.com
 (2603:10b6:5:14a::12)
MIME-Version: 1.0
X-MS-Exchange-MessageSentRepresentingType: 1
Received: from mlx.ziepe.ca (142.162.115.133) by
 BLAPR03CA0128.namprd03.prod.outlook.com (2603:10b6:208:32e::13) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.3912.17 via Frontend
 Transport; Sat, 13 Mar 2021 00:56:08 +0000
Received: from jgg by mlx with local (Exim 4.94)        (envelope-from
 <jgg@nvidia.com>)        id 1lKsZa-00EMB1-Uj; Fri, 12 Mar 2021 20:56:06 -0400
X-MS-PublicTrafficType: Email
X-MS-Office365-Filtering-Correlation-Id: 98e2b08a-d270-4171-a5a4-08d8e5bac98d
X-MS-TrafficTypeDiagnostic: DM6PR12MB2940:
X-MS-Exchange-Transport-Forked: True
X-Microsoft-Antispam-PRVS: 
 <DM6PR12MB294091B0938CEB440873354AC26E9@DM6PR12MB2940.namprd12.prod.outlook.com>
X-MS-Oob-TLC-OOBClassifiers: OLM:6430;
X-MS-Exchange-SenderADCheck: 1
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: 
 vFATLS17T+uBwEGeW1hmvLFEMr9Yx1dQgZvuN8FMj4BPV5ftyiscwOiGEdjoeQOqKxl3OS1QbaMKfRYcFoUP3WNTQw2XIQ5SNBGfDJFGiWPn0/rvuphoDVg/4TlwepaLozk6iQHaK70S02QXD5ExzoogjZNbXUpArKq+FH7FhkuxYE/JdMEr4rJnf3T+A/RaeSSS29kupOud+AAdcUg3uigZDRN8GasGv499ZwWhZirF4vxZnpRtv72QUqVsNc/IE0qYUt3p0klD31Gk2/ii2GkLIyq6+bCRdf0wPtHtM/9q9FdAvmizF0HhXMxC9zEnL0d5vgRMCKKcf7mG0KdtY7gzafZ3MRkzDU+PX0jbNPuAd1c4ADcoPUFBWda+0US9kVaMGpe610YZlrngwe/ChSufGauPllxC3VCshGqzdUXKAZWLW4gvqSnoYv6FswimkmVBC/vb7m83Al59Zp5V3MEhyacm9ubC2fuFaUTcPEVvn3cUFnsrP/5oNK/MCeEkrNyRvGx1jbpiJtXD5MZI6TT8e4Ec4d4Rp4W1FukmM0y5OO79/c+yA1FFZDCthQKfY7PWvN8Y+Icd7MyWzT5fNqt/KwG1Ga6Ge9VbqNCHzIWS10yqNMscelzHEaaFwNIc
X-Forefront-Antispam-Report: 
 CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:DM6PR12MB3834.namprd12.prod.outlook.com;PTR:;CAT:NONE;SFS:(4636009)(39860400002)(376002)(396003)(136003)(366004)(346002)(9746002)(9786002)(8676002)(6666004)(4326008)(107886003)(54906003)(8936002)(5660300002)(36756003)(316002)(83380400001)(66946007)(66556008)(186003)(26005)(66476007)(478600001)(2906002)(426003)(86362001)(7416002)(2616005)(4216001)(169823001);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData: 
 KxrWufcwxeA1NXZB/5J/cIAR4Q4YIYdV304PGNiGIa1cXg2eElcA18pN5jLAzA2awTu+auZtv/MUJxhdenYRza7d2NQh4c8k+ptYUhPtwBhzMhfJ1yGnpILz8KMWQWBv/F1Nq1+41yPg50t3oK4bogwUl6RuXDxedHPrfj5iBsBEZuj/GyhqCQlSbisLwD78vHCQVyNqZQ7FklewR+k5LiwaFC80i91yViEmFCMOKo8KLXy/DPEMGskHVIEPeYXT14JQzs4iNMeg4pmkg7++N5S7EceajO6mb+TwAj956bOuUBqjMSj9WRo7/2jYmFcGqN6vOYeUfm5iLm/FCOWDScRBjVm/pWA/pRQueZ+a9/xXD/H1kJ1KDyKUyNvOWDsHiLynJmE5HLtPIgKcsOfPn5HVTc+MFdQq5KPJqTROg1BujEiESTn4HJzFeWMXJMW9rWRyFaWbDNAkeT3tO6YJbmN6w4ogADwJvXjb2X9vhYXJDiX7x85vl5cpqPpmPkGrPWRbmp7bEMY3qgl7kAXMKl0L6BJha6LCF+DrTgll8X+j3Bm/W2a2OnlC9vDWgcGlGwntb5+D4CUOR2puQtpFOghMJzMo4erNpX0c6DhyA/INMT2AsXXxWMcyVzryUEYYNQpl5AqLnYW3PfoLpk+BnCKCdQjPurbm2PLROHyeySKeJHEBJ+sBVTfIRpwd5o68z5O/k6pJxaKvLuaGO0qZRQsKGJo7n+f/DUgR5RKI6xM7ik8RtmUiWqltPNX3PXma6weKcRJ08vJrcbE3YGinSXQHE55jvpvz4ZBTVT0beApBFa20LMfnFqdI4u9p0UYGfZ0L3XzxhXKNMampR3+4mvKFUkVIUVqdejs2YI/qIRBf0au8cQ7BwhbkEptPvAfVt4J+fYncEhRQhaG1gDoxspoXf1geJk/0m35qx/mkvFs2ik+rGDk3zHT42cISOQcQ+AmVyAx+3k87gL/Rsuy1XmofEdcdr3Z9vEfdOGUeGUUqmzzJX9SNyd5b90JH3oZJMmlIS/rYy4QFlojcP89Q4sTEfHnEx87chzjnJBLIxb+stfOY/VQdMJOxg2pILZb2mrM+ueIX6Afhe/C5Pd1FcqvWMCyeySuyXpGGiKh+RuPGm3EyoH07KRa3FOQ8JMnZ6TSZIo7XI0X14s4yDT3po+/c0AkPJg5QE9YXhBkkHxje/EiWRdYxgxJfH2zvXGPx4jh3ZpwXoIbbauvgR8P2XJjxxrPWNtSkRCtmRaXXAJGvV8e4PWGBssYV83Oqgt308bbkUliZeK8j/9wf1Yv1HU1PWgM2M2wKmaAc7RrbKYgoSTSbUkRRULec5X99gcpnaq72gfSvIOtM4Fx8LMYzgw==
X-OriginatorOrg: Nvidia.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 
 98e2b08a-d270-4171-a5a4-08d8e5bac98d
X-MS-Exchange-CrossTenant-AuthSource: DM6PR12MB3834.namprd12.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 13 Mar 2021 00:56:08.9571
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 43083d15-7273-40c1-b7db-39efd9ccc17a
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: 
 9Tu2zir4uaJRDUced0VpC4M/9/K4STcgW3M5mdeHtd1PXcm+a+Kw0qbKN/Kd9+ML
X-MS-Exchange-Transport-CrossTenantHeadersStamped: DM6PR12MB2940
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

vfio_add_group_dev() must be called only after all of the private data in
vdev is fully setup and ready, otherwise there could be races with user
space instantiating a device file descriptor and starting to call ops.

For instance vfio_fsl_mc_reflck_attach() sets vdev->reflck and
vfio_fsl_mc_open(), called by fops open, unconditionally derefs it, which
will crash if things get out of order.

This driver started life with the right sequence, but three commits added
stuff after vfio_add_group_dev().

Fixes: 2e0d29561f59 ("vfio/fsl-mc: Add irq infrastructure for fsl-mc devices")
Fixes: f2ba7e8c947b ("vfio/fsl-mc: Added lock support in preparation for interrupt handling")
Fixes: 704f5082d845 ("vfio/fsl-mc: Scan DPRC objects on vfio-fsl-mc driver bind")
Signed-off-by: Jason Gunthorpe <jgg@nvidia.com>
---
 drivers/vfio/fsl-mc/vfio_fsl_mc.c | 43 ++++++++++++++++---------------
 1 file changed, 22 insertions(+), 21 deletions(-)

diff --git a/drivers/vfio/fsl-mc/vfio_fsl_mc.c b/drivers/vfio/fsl-mc/vfio_fsl_mc.c
index f27e25112c4037..881849723b4dfb 100644
--- a/drivers/vfio/fsl-mc/vfio_fsl_mc.c
+++ b/drivers/vfio/fsl-mc/vfio_fsl_mc.c
@@ -582,11 +582,21 @@ static int vfio_fsl_mc_init_device(struct vfio_fsl_mc_device *vdev)
 	dprc_cleanup(mc_dev);
 out_nc_unreg:
 	bus_unregister_notifier(&fsl_mc_bus_type, &vdev->nb);
-	vdev->nb.notifier_call = NULL;
-
 	return ret;
 }
 
+static void vfio_fsl_uninit_device(struct vfio_fsl_mc_device *vdev)
+{
+	struct fsl_mc_device *mc_dev = vdev->mc_dev;
+
+	if (!is_fsl_mc_bus_dprc(mc_dev))
+		return;
+
+	dprc_remove_devices(mc_dev, NULL, 0);
+	dprc_cleanup(mc_dev);
+	bus_unregister_notifier(&fsl_mc_bus_type, &vdev->nb);
+}
+
 static int vfio_fsl_mc_probe(struct fsl_mc_device *mc_dev)
 {
 	struct iommu_group *group;
@@ -607,29 +617,27 @@ static int vfio_fsl_mc_probe(struct fsl_mc_device *mc_dev)
 	}
 
 	vdev->mc_dev = mc_dev;
-
-	ret = vfio_add_group_dev(dev, &vfio_fsl_mc_ops, vdev);
-	if (ret) {
-		dev_err(dev, "VFIO_FSL_MC: Failed to add to vfio group\n");
-		goto out_group_put;
-	}
+	mutex_init(&vdev->igate);
 
 	ret = vfio_fsl_mc_reflck_attach(vdev);
 	if (ret)
-		goto out_group_dev;
+		goto out_group_put;
 
 	ret = vfio_fsl_mc_init_device(vdev);
 	if (ret)
 		goto out_reflck;
 
-	mutex_init(&vdev->igate);
-
+	ret = vfio_add_group_dev(dev, &vfio_fsl_mc_ops, vdev);
+	if (ret) {
+		dev_err(dev, "VFIO_FSL_MC: Failed to add to vfio group\n");
+		goto out_device;
+	}
 	return 0;
 
+out_device:
+	vfio_fsl_uninit_device(vdev);
 out_reflck:
 	vfio_fsl_mc_reflck_put(vdev->reflck);
-out_group_dev:
-	vfio_del_group_dev(dev);
 out_group_put:
 	vfio_iommu_group_put(group, dev);
 	return ret;
@@ -646,16 +654,9 @@ static int vfio_fsl_mc_remove(struct fsl_mc_device *mc_dev)
 
 	mutex_destroy(&vdev->igate);
 
+	vfio_fsl_uninit_device(vdev);
 	vfio_fsl_mc_reflck_put(vdev->reflck);
 
-	if (is_fsl_mc_bus_dprc(mc_dev)) {
-		dprc_remove_devices(mc_dev, NULL, 0);
-		dprc_cleanup(mc_dev);
-	}
-
-	if (vdev->nb.notifier_call)
-		bus_unregister_notifier(&fsl_mc_bus_type, &vdev->nb);
-
 	vfio_iommu_group_put(mc_dev->dev.iommu_group, dev);
 
 	return 0;

From patchwork Sat Mar 13 00:55:58 2021
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
X-Patchwork-Submitter: Jason Gunthorpe <jgg@nvidia.com>
X-Patchwork-Id: 12136229
Return-Path: <kvm-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-16.0 required=3.0 tests=BAYES_00,DKIMWL_WL_HIGH,
	DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,
	INCLUDES_CR_TRAILER,INCLUDES_PATCH,MAILING_LIST_MULTI,MSGID_FROM_MTA_HEADER,
	SPF_HELO_NONE,SPF_PASS autolearn=ham autolearn_force=no version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 11C43C43332
	for <kvm@archiver.kernel.org>; Sat, 13 Mar 2021 00:57:02 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id E507364FA8
	for <kvm@archiver.kernel.org>; Sat, 13 Mar 2021 00:57:01 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S232892AbhCMA4c (ORCPT <rfc822;kvm@archiver.kernel.org>);
        Fri, 12 Mar 2021 19:56:32 -0500
Received: from mail-dm6nam12on2065.outbound.protection.outlook.com
 ([40.107.243.65]:30549
        "EHLO NAM12-DM6-obe.outbound.protection.outlook.com"
        rhost-flags-OK-OK-OK-FAIL) by vger.kernel.org with ESMTP
        id S231906AbhCMA4O (ORCPT <rfc822;kvm@vger.kernel.org>);
        Fri, 12 Mar 2021 19:56:14 -0500
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=ZMdGO8i9xv1DmTXkNYEQOV6qOaNPk+oQx936qm/aWOET9LZ3tKdW2qypOi3ndXIiMd2Lyg3CVhB7TZwEBVpUXv3pUryqyvI99nBQB+/tr+nhO0cMKzKiaF20gT/J/Lj3P10FwyYNEFd5fCGhHVMv4DQaa7fIFjgTPOqBcwVneOgKN556od8DdU1RessdQG03WFpfUOGukSgEa2YR+Hp/fK9yVJhBlxDGn7D/QAHyII4kBIZVXAUEWi+2QSXOYOSGg/rOSyRzMFrfLrxxdtZ78scwtqBbLzkXvF6xrL2HGNpQsLXu7bSURqPa28vCo0HOQKlQVWYWwA9Tj2a4WIswkg==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=7RwiMB4dBUAI2v3IEE844Lu5CZunbMWQyKshCzvVj50=;
 b=XJaD6X0v4E8g5IoNA10XmnNzOteC4gv9H8TYefmX6tvgweJFkuUSa7BYIKsOrpMTA7N9X8VoM4nTEOF+ZueyJn3Meo3KUwawLUNqA4nkh/zks+9KyN6BGPcVeSyPn7EVNfD6T6xSEhnTiI80asi4JR9hsto5OLwEx/SxjBHj/c47gRQ6MkLmWP2XXWO8yd+sa3jMK8nX7VLTqyY7Cx55KWmR12XLSrAbbNMFRDOxh6MKubY0dnkynEH7mAv9Z5ZcLX+QRFwT8g1GqfRa+2vbSVGJhFNyl5e/0fCNCYjqwP8K4ZluRh+LqrfmRgSyBP9IEfI2nNcQlHFjo7O19oMngg==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=nvidia.com; dmarc=pass action=none header.from=nvidia.com;
 dkim=pass header.d=nvidia.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=Nvidia.com;
 s=selector2;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=7RwiMB4dBUAI2v3IEE844Lu5CZunbMWQyKshCzvVj50=;
 b=gIe4oBqZz/BFGRIL/rS3iMwfAMF4BsPKoR7X1tbNsaB3It/qxtug3udcphz5jfXNH5f7fuVky0OUBc+VV0nVX8oshnD9RKFQwwHXyBALkt1gE9+9JD+8fNR6D/wWxUpAup2c+/FMO6oIdwQiDQRoMSzPPpN0Gm4eZxjR60meVvGcrbZ/0igRhLZwhUf6h/+vgNnvSMtuovkisLdS+73KGHMD9CJIPBxeQxUq+J2PSP6bEmr7TFCRy+eIIz+3W9Qu+h7EIxbwF5q4pH7lRid51NApFuJuNtJgrfK+5pCUokt6BiMV3I9RcjBX61R98NJMkB1XgyRRo6UT0Mmkdu6tpA==
Authentication-Results: redhat.com; dkim=none (message not signed)
 header.d=none;redhat.com; dmarc=none action=none header.from=nvidia.com;
Received: from DM6PR12MB3834.namprd12.prod.outlook.com (2603:10b6:5:14a::12)
 by DM6PR12MB2940.namprd12.prod.outlook.com (2603:10b6:5:15f::19) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.3933.31; Sat, 13 Mar
 2021 00:56:12 +0000
Received: from DM6PR12MB3834.namprd12.prod.outlook.com
 ([fe80::1c62:7fa3:617b:ab87]) by DM6PR12MB3834.namprd12.prod.outlook.com
 ([fe80::1c62:7fa3:617b:ab87%6]) with mapi id 15.20.3933.032; Sat, 13 Mar 2021
 00:56:12 +0000
From: Jason Gunthorpe <jgg@nvidia.com>
To: Alex Williamson <alex.williamson@redhat.com>,
        Cornelia Huck <cohuck@redhat.com>,
        Diana Craciun <diana.craciun@oss.nxp.com>, kvm@vger.kernel.org
Cc: "Raj, Ashok" <ashok.raj@intel.com>,
        Dan Williams <dan.j.williams@intel.com>,
        Daniel Vetter <daniel@ffwll.ch>,
        Christoph Hellwig <hch@lst.de>,
        Leon Romanovsky <leonro@nvidia.com>,
        Max Gurtovoy <mgurtovoy@nvidia.com>,
        Tarun Gupta <targupta@nvidia.com>
Subject: [PATCH v2 06/14] vfio/fsl-mc: Use
 vfio_init/register/unregister_group_dev
Date: Fri, 12 Mar 2021 20:55:58 -0400
Message-Id: <6-v2-20d933792272+4ff-vfio1_jgg@nvidia.com>
In-Reply-To: <0-v2-20d933792272+4ff-vfio1_jgg@nvidia.com>
References: 
X-Originating-IP: [142.162.115.133]
X-ClientProxiedBy: BLAPR03CA0149.namprd03.prod.outlook.com
 (2603:10b6:208:32e::34) To DM6PR12MB3834.namprd12.prod.outlook.com
 (2603:10b6:5:14a::12)
MIME-Version: 1.0
X-MS-Exchange-MessageSentRepresentingType: 1
Received: from mlx.ziepe.ca (142.162.115.133) by
 BLAPR03CA0149.namprd03.prod.outlook.com (2603:10b6:208:32e::34) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.3912.17 via Frontend
 Transport; Sat, 13 Mar 2021 00:56:10 +0000
Received: from jgg by mlx with local (Exim 4.94)        (envelope-from
 <jgg@nvidia.com>)        id 1lKsZb-00EMB5-07; Fri, 12 Mar 2021 20:56:07 -0400
X-MS-PublicTrafficType: Email
X-MS-Office365-Filtering-Correlation-Id: eef32a2e-3a4d-4b63-fec4-08d8e5bacae5
X-MS-TrafficTypeDiagnostic: DM6PR12MB2940:
X-MS-Exchange-Transport-Forked: True
X-Microsoft-Antispam-PRVS: 
 <DM6PR12MB2940B14F73B04842B5D95280C26E9@DM6PR12MB2940.namprd12.prod.outlook.com>
X-MS-Oob-TLC-OOBClassifiers: OLM:4941;
X-MS-Exchange-SenderADCheck: 1
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: 
 nv3MoRBiG0UThK8aHIqh/lnRvasQCuIHq9MfUtUmt2mOqR3SL49gXm+cdWir3eT1ZgtmB+Vop/nep8yDBonR8WL4kJTTUEDOgGqgOVVwduaSUXxwDgbRXUM9jXCX5ExCQcyXzFX2oCSU4GsgBJ9ZwfVmVcXH1JUJufeMRf4xbs4fLQi1qfmWFSQbxOseE/d0vw2OXubLCllCq6w2OF0Zg1be1VCwn5HHX8PxPD5fUt0ujl3kXm+T6H83Zr2HhETwkvG87M0iaEM44umFYrvth6h/ejqTjT/Dut/JObwdOTlgXo/CmdGQso0cwBb4Ad+sh8luBJRSILGTALNe1binsp7OPh1XZW96kr86Mgmt79tJaWwBn2r8+4iXONGvvAuvlcZFiyHMC7l+wrRXMjbdJnDH8MTIIAebvRYoHJQWQIn05+AKpPYbUqghho9pshtOjKWpHvS3dC2BoB9tykW9nJZM2X1L1vS9UC7ongRqJhnFJPiGgpw1h+kdWlZ5rFpe14KGcA5m4kS+pwKSbdSXxC9rnEcv+WH7mRv3c+KyTMu/BAn6Y4eA2vN60tnbzRFmxYZjClboj1e+amjrSvdH6Afx4Wg+W5vxTpWHxRE3xoY=
X-Forefront-Antispam-Report: 
 CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:DM6PR12MB3834.namprd12.prod.outlook.com;PTR:;CAT:NONE;SFS:(4636009)(39860400002)(376002)(396003)(136003)(366004)(346002)(9746002)(9786002)(8676002)(6666004)(4326008)(107886003)(54906003)(8936002)(5660300002)(36756003)(316002)(110136005)(83380400001)(66946007)(66556008)(186003)(26005)(66476007)(478600001)(2906002)(426003)(86362001)(2616005)(4216001);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData: 
 sh2NXLUM/MePgpgti0/69qwapV651p3CQzCpHiMZMkG+j251diN1Rw/f5F1hbI0oQXr/RHv1fvHK+M/Uf3Oy1x8RSPTdsuieSva22pjOYkALTi+y6gjAwIsUR760myGtOXa1rwWAxl2LjaPJ6E9HM3kxedHIuVW/MneRttoQFJFhruAnGKVUYWUIOkv2m+achf/GfZtxcUMo2hUQVJaBKgt+Ul9O3u/I8uIF4x9YL+NU7LoxdjCwzMs84CAad+XsiIRRSKN9vGWxLsj1U3nCbkAFxYw4fJzap8vBaqnYjqBRvwf98CQhyyWSQKIFmkIRcMNc+DLuWs2x4JTlJ/JNNtNRv7dmnAyNuIcnGI/CNi2+tThKLrq9njE8Svq4obUmOVehJmVpWV2BESXUPRCBBsr8M3kaS1Ukv+b1vFtBx/elL6HFM2lRRe2Zy2XO7/KUKLc2X6QC9pxZLFOeWRddBoK7kNKtqWb33n0Mc5ga8uQfcABaLgv/6KpjV/xDvup2Hn6uA386ao8yrS3TU495JGBPAfchK63nQtAKsnr3qFi6QohdhmcxnB9jHc6kXdjiQsurqRh6DEI11OEERs2geEpXkH4u7tMNOgeFLdJ0QvU1P+0SZt6tXIwYpw6fFwHAX0E/UnMphJjUa9dxUPoDHsUkW9ogJtHGhKYWCPKDSjtbvVWpjIvX7A8BUb3zW3q24qzysJvwS8te1EsGOIiBKHDUi0bpprNjZMTA1DYYnOEOZXnjgSotF3DqXmP4G0TPDacqLudhQJ6eKigeK1Vut8elkyGY3Px/Li9eWOSBg6GnuZ5cO22vrHVLpDbDW0TUw9ObbmbM3tc/YcE95WgWYNY/bWUMy4vV2ii7pX9PTHyWY8+6Z1UV+Y6TdmY/b3zKcuQxRavd0P815T7gHKYFPl8G55gQik85u/2gLiID9FOINbc9IWhenfcOmLGvPNM1Hfw4TI92+e+kIW22ngpHUxmpmb6U1HVrexTMKKm+4YZk7ze4J830+Ufhvhud+OcxYfl1vxvpmU8iP6fE8ok+5MazlBSKORXKhhGKs+Fd6aLXsgj4ookvx5PrKnBXSuswMYe/q8nPOJTNL4UyTkfhuoLUvMuquqmu4Gaw7Iopxnme+tu+uwGwUGthJjQgI/n6CvV4DWHmbFk0Ec0lIDExzY/Uf1fEVddYMmhiQnPHvArY6GjgGn93vglOas508XrFQPKb8aVCixuB1VaPF7uG/odbNL0OKh46wExy4Vr8TaoKNuA9p9WL/hZu1YJJ0GZq7LRgpVvUnTc0KMs2n0LazvGkrILkPZmMR4/Ywn0I23RGeJpCN7v2WKGaZLqY8BfFdWMt2gRTXD67nLzokt6y4g==
X-OriginatorOrg: Nvidia.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 
 eef32a2e-3a4d-4b63-fec4-08d8e5bacae5
X-MS-Exchange-CrossTenant-AuthSource: DM6PR12MB3834.namprd12.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 13 Mar 2021 00:56:10.5712
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 43083d15-7273-40c1-b7db-39efd9ccc17a
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: 
 1gkVEnP7MouVU0RQ4uzTOGVzNHVO4G1Dirp2neqcmixK3MEZ5AleYzBFySbc0dh6
X-MS-Exchange-Transport-CrossTenantHeadersStamped: DM6PR12MB2940
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

fsl-mc already allocates a struct vfio_fsl_mc_device with exactly the same
lifetime as vfio_device, switch to the new API and embed vfio_device in
vfio_fsl_mc_device. While here remove the devm usage for the vdev, this
code is clean and doesn't need devm.

Signed-off-by: Jason Gunthorpe <jgg@nvidia.com>
---
 drivers/vfio/fsl-mc/vfio_fsl_mc.c         | 18 ++++++++++--------
 drivers/vfio/fsl-mc/vfio_fsl_mc_private.h |  1 +
 2 files changed, 11 insertions(+), 8 deletions(-)

diff --git a/drivers/vfio/fsl-mc/vfio_fsl_mc.c b/drivers/vfio/fsl-mc/vfio_fsl_mc.c
index 881849723b4dfb..87ea8368aa510a 100644
--- a/drivers/vfio/fsl-mc/vfio_fsl_mc.c
+++ b/drivers/vfio/fsl-mc/vfio_fsl_mc.c
@@ -610,34 +610,38 @@ static int vfio_fsl_mc_probe(struct fsl_mc_device *mc_dev)
 		return -EINVAL;
 	}
 
-	vdev = devm_kzalloc(dev, sizeof(*vdev), GFP_KERNEL);
+	vdev = kzalloc(sizeof(*vdev), GFP_KERNEL);
 	if (!vdev) {
 		ret = -ENOMEM;
 		goto out_group_put;
 	}
 
+	vfio_init_group_dev(&vdev->vdev, dev, &vfio_fsl_mc_ops, vdev);
 	vdev->mc_dev = mc_dev;
 	mutex_init(&vdev->igate);
 
 	ret = vfio_fsl_mc_reflck_attach(vdev);
 	if (ret)
-		goto out_group_put;
+		goto out_kfree;
 
 	ret = vfio_fsl_mc_init_device(vdev);
 	if (ret)
 		goto out_reflck;
 
-	ret = vfio_add_group_dev(dev, &vfio_fsl_mc_ops, vdev);
+	ret = vfio_register_group_dev(&vdev->vdev);
 	if (ret) {
 		dev_err(dev, "VFIO_FSL_MC: Failed to add to vfio group\n");
 		goto out_device;
 	}
+	dev_set_drvdata(dev, vdev);
 	return 0;
 
 out_device:
 	vfio_fsl_uninit_device(vdev);
 out_reflck:
 	vfio_fsl_mc_reflck_put(vdev->reflck);
+out_kfree:
+	kfree(vdev);
 out_group_put:
 	vfio_iommu_group_put(group, dev);
 	return ret;
@@ -645,18 +649,16 @@ static int vfio_fsl_mc_probe(struct fsl_mc_device *mc_dev)
 
 static int vfio_fsl_mc_remove(struct fsl_mc_device *mc_dev)
 {
-	struct vfio_fsl_mc_device *vdev;
 	struct device *dev = &mc_dev->dev;
+	struct vfio_fsl_mc_device *vdev = dev_get_drvdata(dev);
 
-	vdev = vfio_del_group_dev(dev);
-	if (!vdev)
-		return -EINVAL;
-
+	vfio_unregister_group_dev(&vdev->vdev);
 	mutex_destroy(&vdev->igate);
 
 	vfio_fsl_uninit_device(vdev);
 	vfio_fsl_mc_reflck_put(vdev->reflck);
 
+	kfree(vdev);
 	vfio_iommu_group_put(mc_dev->dev.iommu_group, dev);
 
 	return 0;
diff --git a/drivers/vfio/fsl-mc/vfio_fsl_mc_private.h b/drivers/vfio/fsl-mc/vfio_fsl_mc_private.h
index a97ee691ed47ec..89700e00e77d10 100644
--- a/drivers/vfio/fsl-mc/vfio_fsl_mc_private.h
+++ b/drivers/vfio/fsl-mc/vfio_fsl_mc_private.h
@@ -36,6 +36,7 @@ struct vfio_fsl_mc_region {
 };
 
 struct vfio_fsl_mc_device {
+	struct vfio_device		vdev;
 	struct fsl_mc_device		*mc_dev;
 	struct notifier_block        nb;
 	int				refcnt;

From patchwork Sat Mar 13 00:55:59 2021
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
X-Patchwork-Submitter: Jason Gunthorpe <jgg@nvidia.com>
X-Patchwork-Id: 12136261
Return-Path: <kvm-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-16.0 required=3.0 tests=BAYES_00,DKIMWL_WL_HIGH,
	DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,
	INCLUDES_CR_TRAILER,INCLUDES_PATCH,MAILING_LIST_MULTI,MSGID_FROM_MTA_HEADER,
	SPF_HELO_NONE,SPF_PASS autolearn=ham autolearn_force=no version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 17A6BC433DB
	for <kvm@archiver.kernel.org>; Sat, 13 Mar 2021 01:04:03 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id DC5F564F56
	for <kvm@archiver.kernel.org>; Sat, 13 Mar 2021 01:04:02 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S232262AbhCMBD3 (ORCPT <rfc822;kvm@archiver.kernel.org>);
        Fri, 12 Mar 2021 20:03:29 -0500
Received: from mail-bn8nam12on2051.outbound.protection.outlook.com
 ([40.107.237.51]:51809
        "EHLO NAM12-BN8-obe.outbound.protection.outlook.com"
        rhost-flags-OK-OK-OK-FAIL) by vger.kernel.org with ESMTP
        id S232255AbhCMBDI (ORCPT <rfc822;kvm@vger.kernel.org>);
        Fri, 12 Mar 2021 20:03:08 -0500
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=DCoU4IaDZN3/YPsh8leAIwTtqqziyk7BI+S1Uipx2ahP5zpSPTb+ah2hxof4HK4hD8BW0o4YubBYDWcqK4AK7WOsO8WOEIxQoeau773uuotKc+/dNY/ifO9h8zMzFgQqrKD8nmMpvmzLlBAOx6fSw4daMXgHJcqs4DbTBU1OOB0j7goTu9LArMMoQZ0574xzqmWbie4NSCZ8mH5JOEn/w/JKVoUbmr9CE+AAiKaY0uPN01dLLNFfv6k1OF+nI5lBWjG7rSV797R9eNIcKMBfwouWb6YqyD8kbLssGgE1F2aRyEcg1MNudrOEzwtHyCYCuVCcEbXTVz2fi/zkri9epQ==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=mklakhkGKcRS+LTOiHNXJp+OMFPRB5KeG2q9SWWqp9k=;
 b=Q80b4wivoOpHs7NzcoU4kiqC+jtgCybhVAFbgIAMRM8fKTRR6bWfHjViobC7SshjoGsd7qXFxfR++Kle1N0jE68pi7c7IbWsr9vQjP4rLHmJBEtE6iH8A2Q8KVCuJqyjb6PRUv4fw2fvB2HAheWRx54JC/4Fj8TqR7NDrriDwUb500No5VZaQ6JJFP5lqDxH372a6Y1tbihaZxPiy9LBfNKFgVserotcSUvyWR2ctjS2DP/Y5Z5iqC2+YjbgC31gWkiilICFkLFERp9xpYH4lKQn/dbjHWKqNsWkB3XyGjPTFU8QvwPBlyVPHwDYHj4dPVGOIb+tGC4O3dDhJN+qdw==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=nvidia.com; dmarc=pass action=none header.from=nvidia.com;
 dkim=pass header.d=nvidia.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=Nvidia.com;
 s=selector2;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=mklakhkGKcRS+LTOiHNXJp+OMFPRB5KeG2q9SWWqp9k=;
 b=MB/PueZunIaKlprP+GtOnzA1RIyB43u/DxR230sK6Ns8ZP0mrzq+IRA1OWFj3Qjxu1lDT7pOcWJAkUnWBB1tbhuCb3DaPPx4qP/9XC2W9O/3o/zzu+RKjg+kKM9Oas86InRnNz2B34uDAzdmbPkbUu/LOd63Y5U2nUd1ZRrj4jeo4oDllM6JqSjv0QfUxlKicEac4BW2N8xi53Sa1docp7UIg4+BJpd4xHig9fdEudqr0scGd7JIrKIzK4e7SVWlcJNuicNq/9EJN6RmRSgSfT1reiyGMTEartcBWbOPVUE/4kb9idzl1CAo3CQu5FIppvtDwwg1eUuKQ5f2v/j2aw==
Authentication-Results: redhat.com; dkim=none (message not signed)
 header.d=none;redhat.com; dmarc=none action=none header.from=nvidia.com;
Received: from DM6PR12MB3834.namprd12.prod.outlook.com (2603:10b6:5:14a::12)
 by DM6PR12MB3306.namprd12.prod.outlook.com (2603:10b6:5:186::20) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.3912.17; Sat, 13 Mar
 2021 01:03:06 +0000
Received: from DM6PR12MB3834.namprd12.prod.outlook.com
 ([fe80::1c62:7fa3:617b:ab87]) by DM6PR12MB3834.namprd12.prod.outlook.com
 ([fe80::1c62:7fa3:617b:ab87%6]) with mapi id 15.20.3933.032; Sat, 13 Mar 2021
 01:03:06 +0000
From: Jason Gunthorpe <jgg@nvidia.com>
To: Cornelia Huck <cohuck@redhat.com>, kvm@vger.kernel.org
Cc: Alex Williamson <alex.williamson@redhat.com>,
        "Raj, Ashok" <ashok.raj@intel.com>,
        Dan Williams <dan.j.williams@intel.com>,
        Daniel Vetter <daniel@ffwll.ch>,
        Christoph Hellwig <hch@lst.de>,
        Leon Romanovsky <leonro@nvidia.com>,
        Max Gurtovoy <mgurtovoy@nvidia.com>,
        Tarun Gupta <targupta@nvidia.com>
Subject: [PATCH v2 07/14] vfio/pci: Move VGA and VF initialization to
 functions
Date: Fri, 12 Mar 2021 20:55:59 -0400
Message-Id: <7-v2-20d933792272+4ff-vfio1_jgg@nvidia.com>
In-Reply-To: <0-v2-20d933792272+4ff-vfio1_jgg@nvidia.com>
References: 
X-Originating-IP: [142.162.115.133]
X-ClientProxiedBy: MN2PR05CA0060.namprd05.prod.outlook.com
 (2603:10b6:208:236::29) To DM6PR12MB3834.namprd12.prod.outlook.com
 (2603:10b6:5:14a::12)
MIME-Version: 1.0
X-MS-Exchange-MessageSentRepresentingType: 1
Received: from mlx.ziepe.ca (142.162.115.133) by
 MN2PR05CA0060.namprd05.prod.outlook.com (2603:10b6:208:236::29) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.3955.10 via Frontend
 Transport; Sat, 13 Mar 2021 01:03:06 +0000
Received: from jgg by mlx with local (Exim 4.94)        (envelope-from
 <jgg@nvidia.com>)        id 1lKsZb-00EMBA-1t; Fri, 12 Mar 2021 20:56:07 -0400
X-MS-PublicTrafficType: Email
X-MS-Office365-Filtering-Correlation-Id: 5f80a649-2c6c-4c2d-095d-08d8e5bbc30e
X-MS-TrafficTypeDiagnostic: DM6PR12MB3306:
X-MS-Exchange-Transport-Forked: True
X-Microsoft-Antispam-PRVS: 
 <DM6PR12MB3306F4B9F77E334780C29628C26E9@DM6PR12MB3306.namprd12.prod.outlook.com>
X-MS-Oob-TLC-OOBClassifiers: OLM:6790;
X-MS-Exchange-SenderADCheck: 1
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: 
 S49Q1D8mYADH5zlxpB0ygBIrPDmICCaQiKtt6k5kFH2o8mpPpzF/ecvJLZvv9W/EMJS7yo2PcDrwcjZ968iHHePEBKwS6JnupOAnt/KUG8y+eBUfwIjUId8y7kYZwm3MiGebzhGgXnGoUmG3LddMYMwl1UMf7yFEG/Eweq5lPnUvG2oHjuXbEipCWirJE+fkdi8mdNcAN9kVpXcLscJqom2qFnSS8R3oikWl71+C3PWR5wrImbeI+e8r4pDM5zoPF2RV/T8xDXlocLAxbrthhhTsdWG9LBUxsHqyii5KCWk7B6B4gpDsGOnm+0qvQbK3iwuo8rM20tFgaIMkTt3RNsLMCqo92CRyX/khLW6mAUV3851N5/2C0UuY2exybMEe2gCPunyTHbE7WrPDUIuuPhEFc1vkimJ2z876JTjqEnNKM3CcF1oUJXv/cTd640TqQ45NryvWFTB0/uVaS9GfL3NeoCJRACs1LeJWq9DqxLwFcfniXMweQZZ9jzOgH0BbcCht7VVlwGMie64NIdzsFG16znCpeVjAUjViO4I7JKwY5J4o/kTtSAbCdtp/81OF
X-Forefront-Antispam-Report: 
 CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:DM6PR12MB3834.namprd12.prod.outlook.com;PTR:;CAT:NONE;SFS:(4636009)(39860400002)(396003)(376002)(366004)(136003)(346002)(6666004)(8936002)(316002)(54906003)(26005)(426003)(8676002)(9786002)(66556008)(66476007)(86362001)(186003)(83380400001)(478600001)(2616005)(9746002)(4326008)(107886003)(36756003)(66946007)(5660300002)(2906002)(4216001);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData: 
 6qk4IXju7GHAmg8Mm0N7uRfFinDaR9KVFaTdtQ8aoahnOIDyzAYOeUvMGOeRpVVwVlTdc4EhqrrUb8sRYNOCmkIhdvFC3zW8ds8H/6kcaR3Yo6Ecx1MsMkVb0kx6Z9OnR+CrM2ZktPzQNa3e6lgaA+eV1iuytBC3A6ZvomqyTZBzMZLHMTnRyxmYnIZiYsJSFpyE9jY8NkPPkAf9AT6mPUbKoELwYc32za8mUN1m4t+GqIvLAkHJg3+OOE4Fc7t1BhPhZuQj3aBJ7Ud+n0k2SoO52sgUk5lYVCBB2zGR0qH9+08I2OoV1V+2IS/ys+KY+2T+/CY5rAyXdP2BelHf6hOCM2TU+vmUnsZ/iwDpqtzPpPAw7D+N8+QJNlwoCmc1A5nCK6/rUPinaPx0Y6OLWW5G5n1usQ3gMFYNvCBIneVYuWD2javU/OLwhmvIL0UXdDwvGTmfdUZP3vt//HYm5WEHFLqDnyBynzAq2tY3TercdCgOuCfdNd/YtYGjh+akcEM5cypYYo3zqk5P7dUk/eRaPMLrz/e2qSfsjI3wUp7OdkjyCmxXovY5NXjTJuENnvq+JdMnOvGFFg3sOy7pmH8wg7E2gRiB6mo4pTNRFRX7cXcaXi5phrwimpNF5r2AL0uWeS5dxlpuH2iTtAjvLuUSxBycsPdMNxpvnK5f09D8RZh40Kypmi31TMPfUcI1y1HmQhnbgaZKX+1NjblIEmCI7TMXJulxdVuuBCUs6QMNkR6GQIyOt+OLv/96SmGmjaQmOSA6AgvevY3jFJKhvuY27XD4uVQ5KrFEV377NTat+PXfe/tIeQmG2wa25kCZ3l/gTugp53wbjZI2HVNAefZeERKe1eJhEcC1XxNtDHmhqqT1SqRI68KgGpVQECbuCYk03Mi6D+p0BlQbARMk+3Ow+O94gPKAIGW1WDzDr8dilenTohhFevn+4ud/ncEzVpa/8U3IPaMYLzoiArvU3/4XjOSce23vH8BSI0M7BHnz0SPcG/l7q7tpjAlH6htoeerxwlJTe7/OGYelfABWeubRW5zTfsXazTUdrMMeYbnPXt2ZOJYSjVe+/7DEYWK3jXe3s6UDpLnTD4r5oaAkHn628Pi4x8i2SgGzPNQDBnI1rsM9m/XZlXadbFokxu8Chz5FmOu0XOOPXuIQ5RuG/OkCKaid/Ra2m0nKJQ2DFPFizg0R4RHEgRyVnX0IrQC6RDx5V9NjHKOZbG2lRk+J1NWm5b9I9aePcqNhZIYVVgRqxLFm+BjRA5Co6VZMu88+kGb2jwg0sZ0BsOqlb6mdG6KPdkresI4X2bgi6s/IK+DLz0m3edT5WqkMBkoXsfw99Krl5APflA0HK3AcLl95Cg==
X-OriginatorOrg: Nvidia.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 
 5f80a649-2c6c-4c2d-095d-08d8e5bbc30e
X-MS-Exchange-CrossTenant-AuthSource: DM6PR12MB3834.namprd12.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 13 Mar 2021 01:03:06.9315
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 43083d15-7273-40c1-b7db-39efd9ccc17a
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: 
 +/FfjIdGlCtQ/fvzfUL9xkj7UaORGMLlXHLrjR7hm7hM7nNhQBw1L+rBf5k+JJ1P
X-MS-Exchange-Transport-CrossTenantHeadersStamped: DM6PR12MB3306
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

vfio_pci_probe() is quite complicated, with optional VF and VGA sub
components. Move these into clear init/uninit functions and have a linear
flow in probe/remove.

This fixes a few little buglets:
 - vfio_pci_remove() is in the wrong order, vga_client_register() removes
   a notifier and is after kfree(vdev), but the notifier refers to vdev,
   so it can use after free in a race.
 - vga_client_register() can fail but was ignored

Organize things so destruction order is the reverse of creation order.

Fixes: ecaa1f6a0154 ("vfio-pci: Add VGA arbiter client")
Signed-off-by: Jason Gunthorpe <jgg@nvidia.com>
---
 drivers/vfio/pci/vfio_pci.c | 116 +++++++++++++++++++++++-------------
 1 file changed, 74 insertions(+), 42 deletions(-)

diff --git a/drivers/vfio/pci/vfio_pci.c b/drivers/vfio/pci/vfio_pci.c
index 65e7e6b44578c2..f95b58376156a0 100644
--- a/drivers/vfio/pci/vfio_pci.c
+++ b/drivers/vfio/pci/vfio_pci.c
@@ -1922,6 +1922,68 @@ static int vfio_pci_bus_notifier(struct notifier_block *nb,
 	return 0;
 }
 
+static int vfio_pci_vf_init(struct vfio_pci_device *vdev)
+{
+	struct pci_dev *pdev = vdev->pdev;
+	int ret;
+
+	if (!pdev->is_physfn)
+		return 0;
+
+	vdev->vf_token = kzalloc(sizeof(*vdev->vf_token), GFP_KERNEL);
+	if (!vdev->vf_token)
+		return -ENOMEM;
+
+	mutex_init(&vdev->vf_token->lock);
+	uuid_gen(&vdev->vf_token->uuid);
+
+	vdev->nb.notifier_call = vfio_pci_bus_notifier;
+	ret = bus_register_notifier(&pci_bus_type, &vdev->nb);
+	if (ret) {
+		kfree(vdev->vf_token);
+		return ret;
+	}
+	return 0;
+}
+
+static void vfio_pci_vf_uninit(struct vfio_pci_device *vdev)
+{
+	if (!vdev->vf_token)
+		return;
+
+	bus_unregister_notifier(&pci_bus_type, &vdev->nb);
+	WARN_ON(vdev->vf_token->users);
+	mutex_destroy(&vdev->vf_token->lock);
+	kfree(vdev->vf_token);
+}
+
+static int vfio_pci_vga_init(struct vfio_pci_device *vdev)
+{
+	struct pci_dev *pdev = vdev->pdev;
+	int ret;
+
+	if (!vfio_pci_is_vga(pdev))
+		return 0;
+
+	ret = vga_client_register(pdev, vdev, NULL, vfio_pci_set_vga_decode);
+	if (ret)
+		return ret;
+	vga_set_legacy_decoding(pdev, vfio_pci_set_vga_decode(vdev, false));
+	return 0;
+}
+
+static void vfio_pci_vga_uninit(struct vfio_pci_device *vdev)
+{
+	struct pci_dev *pdev = vdev->pdev;
+
+	if (!vfio_pci_is_vga(pdev))
+		return;
+	vga_client_register(pdev, NULL, NULL, NULL);
+	vga_set_legacy_decoding(pdev, VGA_RSRC_NORMAL_IO | VGA_RSRC_NORMAL_MEM |
+					      VGA_RSRC_LEGACY_IO |
+					      VGA_RSRC_LEGACY_MEM);
+}
+
 static int vfio_pci_probe(struct pci_dev *pdev, const struct pci_device_id *id)
 {
 	struct vfio_pci_device *vdev;
@@ -1975,28 +2037,12 @@ static int vfio_pci_probe(struct pci_dev *pdev, const struct pci_device_id *id)
 	ret = vfio_pci_reflck_attach(vdev);
 	if (ret)
 		goto out_del_group_dev;
-
-	if (pdev->is_physfn) {
-		vdev->vf_token = kzalloc(sizeof(*vdev->vf_token), GFP_KERNEL);
-		if (!vdev->vf_token) {
-			ret = -ENOMEM;
-			goto out_reflck;
-		}
-
-		mutex_init(&vdev->vf_token->lock);
-		uuid_gen(&vdev->vf_token->uuid);
-
-		vdev->nb.notifier_call = vfio_pci_bus_notifier;
-		ret = bus_register_notifier(&pci_bus_type, &vdev->nb);
-		if (ret)
-			goto out_vf_token;
-	}
-
-	if (vfio_pci_is_vga(pdev)) {
-		vga_client_register(pdev, vdev, NULL, vfio_pci_set_vga_decode);
-		vga_set_legacy_decoding(pdev,
-					vfio_pci_set_vga_decode(vdev, false));
-	}
+	ret = vfio_pci_vf_init(vdev);
+	if (ret)
+		goto out_reflck;
+	ret = vfio_pci_vga_init(vdev);
+	if (ret)
+		goto out_vf;
 
 	vfio_pci_probe_power_state(vdev);
 
@@ -2016,8 +2062,8 @@ static int vfio_pci_probe(struct pci_dev *pdev, const struct pci_device_id *id)
 
 	return ret;
 
-out_vf_token:
-	kfree(vdev->vf_token);
+out_vf:
+	vfio_pci_vf_uninit(vdev);
 out_reflck:
 	vfio_pci_reflck_put(vdev->reflck);
 out_del_group_dev:
@@ -2039,33 +2085,19 @@ static void vfio_pci_remove(struct pci_dev *pdev)
 	if (!vdev)
 		return;
 
-	if (vdev->vf_token) {
-		WARN_ON(vdev->vf_token->users);
-		mutex_destroy(&vdev->vf_token->lock);
-		kfree(vdev->vf_token);
-	}
-
-	if (vdev->nb.notifier_call)
-		bus_unregister_notifier(&pci_bus_type, &vdev->nb);
-
+	vfio_pci_vf_uninit(vdev);
 	vfio_pci_reflck_put(vdev->reflck);
+	vfio_pci_vga_uninit(vdev);
 
 	vfio_iommu_group_put(pdev->dev.iommu_group, &pdev->dev);
-	kfree(vdev->region);
-	mutex_destroy(&vdev->ioeventfds_lock);
 
 	if (!disable_idle_d3)
 		vfio_pci_set_power_state(vdev, PCI_D0);
 
+	mutex_destroy(&vdev->ioeventfds_lock);
+	kfree(vdev->region);
 	kfree(vdev->pm_save);
 	kfree(vdev);
-
-	if (vfio_pci_is_vga(pdev)) {
-		vga_client_register(pdev, NULL, NULL, NULL);
-		vga_set_legacy_decoding(pdev,
-				VGA_RSRC_NORMAL_IO | VGA_RSRC_NORMAL_MEM |
-				VGA_RSRC_LEGACY_IO | VGA_RSRC_LEGACY_MEM);
-	}
 }
 
 static pci_ers_result_t vfio_pci_aer_err_detected(struct pci_dev *pdev,

From patchwork Sat Mar 13 00:56:00 2021
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
X-Patchwork-Submitter: Jason Gunthorpe <jgg@nvidia.com>
X-Patchwork-Id: 12136227
Return-Path: <kvm-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-16.0 required=3.0 tests=BAYES_00,DKIMWL_WL_HIGH,
	DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,
	INCLUDES_CR_TRAILER,INCLUDES_PATCH,MAILING_LIST_MULTI,MSGID_FROM_MTA_HEADER,
	SPF_HELO_NONE,SPF_PASS autolearn=ham autolearn_force=no version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id C5475C4332B
	for <kvm@archiver.kernel.org>; Sat, 13 Mar 2021 00:57:01 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 9E03C64F5F
	for <kvm@archiver.kernel.org>; Sat, 13 Mar 2021 00:57:01 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S232867AbhCMA4a (ORCPT <rfc822;kvm@archiver.kernel.org>);
        Fri, 12 Mar 2021 19:56:30 -0500
Received: from mail-dm6nam12on2065.outbound.protection.outlook.com
 ([40.107.243.65]:30549
        "EHLO NAM12-DM6-obe.outbound.protection.outlook.com"
        rhost-flags-OK-OK-OK-FAIL) by vger.kernel.org with ESMTP
        id S231597AbhCMA4N (ORCPT <rfc822;kvm@vger.kernel.org>);
        Fri, 12 Mar 2021 19:56:13 -0500
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=jz5vUzdfz4kGiWcjPcmHLWdC0X0bPTbVKNLuLsgpm70EbS+EwtegX8OATBZcRW7WOyyWYgjFUN+D0DZFGZaSuOBYZDE9I5PNkwSHb8rC9Hs4qPIUVdqCJYZXCpuEKPpNJgED9j/D+f7eD1C9/3NiI2fWd0Rbfp/zpxjMAxOparn8vcrZSJ4/Vg0r4jVtMRazVJ//tCKhqXPwRH9cd9u6iyrLGVzT0lh2V0Dl+OqXfom41PHtZG2rlDFicpfOUeoc5xQtHS7/r9Lll42eWuGp51b03t4Ix3NtyxsLuAnS+AmcUPOjR9U0JmHzG6ZBngwOK4IWq82XhNEvrONLC0qspQ==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=uX3iHO2TsjNAMjEE7/PTWoH92GnhcRu1UOzdlyPi36A=;
 b=KyztrSKy8jUOiCJMGynGdC31v6WNLmAYzbPKPjI75Sg6JVb32DsDrcjEPwaMpo31UHrVY79dfjeexnNYWJpAFDElUGmT15nuhkMeEXJqbbNd7QplF9XX+wqVDvb4J9mg5NIvwZuqpE0h4y22T2DrywlQ3YbOG239ZsUxDDs86pcpGI/hiFIwsf1uuTtlaKPqWU79W2IDzlAaOaQL2yOwQcUyK69ZhBLVCZgq0aNF8TnXsEXPS+O5+JU+db65QCGOe1GoGEcLgI1UAoJeBRNp/pEJ3PjRN+JmOHc5Wj9D25hveYnDJaqg9iKTSUY9a2qTN/07zH6gjdlJihD+fns/8Q==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=nvidia.com; dmarc=pass action=none header.from=nvidia.com;
 dkim=pass header.d=nvidia.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=Nvidia.com;
 s=selector2;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=uX3iHO2TsjNAMjEE7/PTWoH92GnhcRu1UOzdlyPi36A=;
 b=CqZunHGHvzXYpwLOUjRjUaLrjfyA6fY//ilzoEEO0yqbY8jka3ZQ18ezGezfRGlyZN0wfRPh7ZtG93VDCznmaT68l1/t/7MnyRyZ6PS/d+UY3HsQ6fV4Nm8HJbj0RO0krry5Mfg++Bnt+I84By+pw0aCC2KN6AVYyZ9r7H14HcWus+FHW1fyF6MhUoLS0RGMx0LPVULM9CBXRvFAbkcSzslzy7VB/ih/UcQtX0Idywhq3Hz0zpucDCjS2De/LTGSejf7JzO/XIVepzyImun78GVOr9XgGOVfDvs0wcpG3Z9wMotnRB2s/bOhLFOMKnh4sa2T/qRW609hWSFTseBKxA==
Authentication-Results: vger.kernel.org; dkim=none (message not signed)
 header.d=none;vger.kernel.org; dmarc=none action=none header.from=nvidia.com;
Received: from DM6PR12MB3834.namprd12.prod.outlook.com (2603:10b6:5:14a::12)
 by DM6PR12MB2940.namprd12.prod.outlook.com (2603:10b6:5:15f::19) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.3933.31; Sat, 13 Mar
 2021 00:56:10 +0000
Received: from DM6PR12MB3834.namprd12.prod.outlook.com
 ([fe80::1c62:7fa3:617b:ab87]) by DM6PR12MB3834.namprd12.prod.outlook.com
 ([fe80::1c62:7fa3:617b:ab87%6]) with mapi id 15.20.3933.032; Sat, 13 Mar 2021
 00:56:10 +0000
From: Jason Gunthorpe <jgg@nvidia.com>
To: kvm@vger.kernel.org
Cc: Alex Williamson <alex.williamson@redhat.com>,
        "Raj, Ashok" <ashok.raj@intel.com>,
        Christian Ehrhardt <christian.ehrhardt@canonical.com>,
        Cornelia Huck <cohuck@redhat.com>,
        Dan Williams <dan.j.williams@intel.com>,
        Daniel Vetter <daniel@ffwll.ch>,
        Eric Auger <eric.auger@redhat.com>,
        Christoph Hellwig <hch@lst.de>,
        Kevin Tian <kevin.tian@intel.com>,
        Leon Romanovsky <leonro@nvidia.com>,
        Max Gurtovoy <mgurtovoy@nvidia.com>,
        Tarun Gupta <targupta@nvidia.com>
Subject: [PATCH v2 08/14] vfio/pci: Re-order vfio_pci_probe()
Date: Fri, 12 Mar 2021 20:56:00 -0400
Message-Id: <8-v2-20d933792272+4ff-vfio1_jgg@nvidia.com>
In-Reply-To: <0-v2-20d933792272+4ff-vfio1_jgg@nvidia.com>
References: 
X-Originating-IP: [142.162.115.133]
X-ClientProxiedBy: MN2PR06CA0021.namprd06.prod.outlook.com
 (2603:10b6:208:23d::26) To DM6PR12MB3834.namprd12.prod.outlook.com
 (2603:10b6:5:14a::12)
MIME-Version: 1.0
X-MS-Exchange-MessageSentRepresentingType: 1
Received: from mlx.ziepe.ca (142.162.115.133) by
 MN2PR06CA0021.namprd06.prod.outlook.com (2603:10b6:208:23d::26) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.3912.17 via Frontend
 Transport; Sat, 13 Mar 2021 00:56:09 +0000
Received: from jgg by mlx with local (Exim 4.94)        (envelope-from
 <jgg@nvidia.com>)        id 1lKsZb-00EMBE-3d; Fri, 12 Mar 2021 20:56:07 -0400
X-MS-PublicTrafficType: Email
X-MS-Office365-Filtering-Correlation-Id: a9ceae5b-3d80-4dd2-cb3f-08d8e5baca5f
X-MS-TrafficTypeDiagnostic: DM6PR12MB2940:
X-MS-Exchange-Transport-Forked: True
X-Microsoft-Antispam-PRVS: 
 <DM6PR12MB294030D9AA452FF38A6DC1F9C26E9@DM6PR12MB2940.namprd12.prod.outlook.com>
X-MS-Oob-TLC-OOBClassifiers: OLM:4941;
X-MS-Exchange-SenderADCheck: 1
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: 
 p1LF9XdQq3IV31DDKe8XB5Nmx5vykgQN+ogVJk9Fp8KOe8YgwEsVvqk9NdJLdYFpnyl6XASHOaRUSk3V7Eyr14ymh3UXjxa6QDebFBQOixaCUw2bQOFRDCfOCFLYCZK9CHvONRpZrs3Kiiuj6FvNJgesTKqtKpFxkJpJj5hyUj7j9hvt0iRfEUV7HD8Vlg58GaEhJoZtXXGOyEQymPdCOdLtNaOyGQ7QA4W8M8YYVdbmpoGl5ibvuKStdCuD4FznbLTWJCDqHNJyHIO3sW73XXU2+nEcl+wVvXb/LjCLMRXYS9/RmYuRVW856ZN6YwslxIGaqvqqd4B8mOIIn4dQvCN/XxDbLA8DNO/rh1o2Ovy5kZlMjd08xIR5msHh3M5nXFkivp6p08eoTp8e8xq4pLU/Znuu+1dU7c/RhxH/nSNDlWdQX4LBiFZNI9G7eed2wEIESo91CwF+NFvSC3/GyiRq1u9GTOMY/PbBEU+tRKJVaYmNxCl9k/sEWInQJSrzTCicsisXkiryUd1bs2lv4Ws6TnfBwYPila7Pf6UhvCHOqQpm6APFxU+PwHXFKYg+8mHX3BH6g/DxpFFO91BAFEz5RT/0Erfo2qbt0riFWD9shJsnxWemOLzhcXLiArcxrNdKSyTBI5bjT3bWgKeieQ==
X-Forefront-Antispam-Report: 
 CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:DM6PR12MB3834.namprd12.prod.outlook.com;PTR:;CAT:NONE;SFS:(4636009)(39860400002)(376002)(396003)(136003)(366004)(346002)(9746002)(9786002)(8676002)(6666004)(4326008)(107886003)(54906003)(8936002)(5660300002)(36756003)(316002)(83380400001)(66946007)(6916009)(66556008)(186003)(26005)(66476007)(478600001)(2906002)(426003)(86362001)(7416002)(2616005)(4216001)(169823001);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData: 
 XZRp9GpNPB7yLBlJsPMbi5nQeGQEfs5ycAacz6fKiLeaGTWQN+GP8ACPZNtzTEaEhg8ogtN6upsmzXxZgjsUD02px0z1b8BhTG5a0uZHAQpwfWB2mBI6As7lBZS9tg9VerFlbtSECKx3L9Mr9EUlfX1Q64KVZ/Pv89+/f16GFBZwBStyIelSooxTPyx3lB0poBJs9JafkDnQRCkuGVMblNh5lxUxhoscfYuQKSKNI+0c6Uq1vzUibzzk2llF0xmdtZzI504njfLW5Yv37tZpe2m8yXkG59CTqQ8pWZgMBjt42/7Cpk6JyP5CI6y1sZ9d6TvV9EYZqiBll4peyegDxKgA3bxGMsdDQlOwfIuWLZVz5+XLDznoU7ArEIZdjVe6djGNxqVsQTYIaXg7TcRTc/GfsVjR4ekGZCfZx6LoYzaFAMydEJsoBy5etz/RkCRYOJ84viMGCM1wSG3w6iVYWWxajDrGEDjiGMPLybbVs0tz8dsXWwngMTLTojtUNeBxiFSxT6zYlScQXbeclJSaRYLrdTl9hTMMMCCcT6UVudqvhLoTHOl7o6gVy+W2rYhi8G5eCQHALzODGYoU7U64EB1sU7GGj0XWU0tz9u79Sw1/PFGjlmYdmCxysROOdzbMMo0hMCqe7MKnvMShjQqWMZHAjJ18Y0fh5d+q0h6BlW3UdXrs+olBpltr3Hsojylav07IyJ3Y7mVjOWYGp7gXXccGJuCcL/Heaueb9gd/n3eEH7nxBm4XkCP+M+XciN9UTxmLUWpPGlsxi+qIBrUdOOztxJnKmwa7vTqsRGGsPjonO4qNT/xAGvkkt6fIimrLjwHXWTqTLoOsz0NBYsZhhbbo78iXqY9MbJ4uytlueoYVe4sKyXbFdKdgRjJ516Oo/CPW3Nm208gGKeM7GaUIa/z1SQJb41+FVwfbkujdG+lydpcSGZPqTWyyMQ2ETifGCRRS+NyqztmT7RCTzRThzp718LVn9LQDzeqwGf3/2aouFAJahaMWSBp6Ob2JoafFX0YqKNbHU/28BBGnhRcpRcmLEzJ2FF/Q7fRooD8BMA2j1peBisPfWDWyDxtlpYCP7R4ILdiLo+o3lFqNTBvHtUhSeEZ5kOEufaelW+QZHrlI0IZVOLtkulDXpzwxTORWtXkklrmXNsC0g4oFk/tixSqDJmf81sQrOeYUmMRrlhOZ56muuSeiUQq1BP4O64hlGzggOgqPx4KJyBiiuCLZZKS9C3FqVligXM852BQcH3HnjwisGfaW2+f4WYUNTEN7TQHAEWJQazybhOzUKhly5ObS6BVsKVB+UdBODMxZTpjQXi9YdVFi1Nl4j824X9AalfL14Y/JtCyUkiHalIHzeQ==
X-OriginatorOrg: Nvidia.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 
 a9ceae5b-3d80-4dd2-cb3f-08d8e5baca5f
X-MS-Exchange-CrossTenant-AuthSource: DM6PR12MB3834.namprd12.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 13 Mar 2021 00:56:09.8306
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 43083d15-7273-40c1-b7db-39efd9ccc17a
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: 
 ZNcUyno0lRL4dekpMEiOpCXOjS3cJHSubn8osLY+B8QJ6jjcLkIFHtjcqv0u+J9Z
X-MS-Exchange-Transport-CrossTenantHeadersStamped: DM6PR12MB2940
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

vfio_add_group_dev() must be called only after all of the private data in
vdev is fully setup and ready, otherwise there could be races with user
space instantiating a device file descriptor and starting to call ops.

For instance vfio_pci_reflck_attach() sets vdev->reflck and
vfio_pci_open(), called by fops open, unconditionally derefs it, which
will crash if things get out of order.

Fixes: cc20d7999000 ("vfio/pci: Introduce VF token")
Fixes: e309df5b0c9e ("vfio/pci: Parallelize device open and release")
Fixes: 6eb7018705de ("vfio-pci: Move idle devices to D3hot power state")
Fixes: ecaa1f6a0154 ("vfio-pci: Add VGA arbiter client")
Signed-off-by: Jason Gunthorpe <jgg@nvidia.com>
---
 drivers/vfio/pci/vfio_pci.c | 17 +++++++++--------
 1 file changed, 9 insertions(+), 8 deletions(-)

diff --git a/drivers/vfio/pci/vfio_pci.c b/drivers/vfio/pci/vfio_pci.c
index f95b58376156a0..0e7682e7a0b478 100644
--- a/drivers/vfio/pci/vfio_pci.c
+++ b/drivers/vfio/pci/vfio_pci.c
@@ -2030,13 +2030,9 @@ static int vfio_pci_probe(struct pci_dev *pdev, const struct pci_device_id *id)
 	INIT_LIST_HEAD(&vdev->vma_list);
 	init_rwsem(&vdev->memory_lock);
 
-	ret = vfio_add_group_dev(&pdev->dev, &vfio_pci_ops, vdev);
-	if (ret)
-		goto out_free;
-
 	ret = vfio_pci_reflck_attach(vdev);
 	if (ret)
-		goto out_del_group_dev;
+		goto out_free;
 	ret = vfio_pci_vf_init(vdev);
 	if (ret)
 		goto out_reflck;
@@ -2060,15 +2056,20 @@ static int vfio_pci_probe(struct pci_dev *pdev, const struct pci_device_id *id)
 		vfio_pci_set_power_state(vdev, PCI_D3hot);
 	}
 
-	return ret;
+	ret = vfio_add_group_dev(&pdev->dev, &vfio_pci_ops, vdev);
+	if (ret)
+		goto out_power;
+	return 0;
 
+out_power:
+	if (!disable_idle_d3)
+		vfio_pci_set_power_state(vdev, PCI_D0);
 out_vf:
 	vfio_pci_vf_uninit(vdev);
 out_reflck:
 	vfio_pci_reflck_put(vdev->reflck);
-out_del_group_dev:
-	vfio_del_group_dev(&pdev->dev);
 out_free:
+	kfree(vdev->pm_save);
 	kfree(vdev);
 out_group_put:
 	vfio_iommu_group_put(group, &pdev->dev);

From patchwork Sat Mar 13 00:56:01 2021
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
X-Patchwork-Submitter: Jason Gunthorpe <jgg@nvidia.com>
X-Patchwork-Id: 12136239
Return-Path: <kvm-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-16.0 required=3.0 tests=BAYES_00,DKIMWL_WL_HIGH,
	DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,
	INCLUDES_CR_TRAILER,INCLUDES_PATCH,MAILING_LIST_MULTI,MSGID_FROM_MTA_HEADER,
	SPF_HELO_NONE,SPF_PASS autolearn=ham autolearn_force=no version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 40A9BC432C3
	for <kvm@archiver.kernel.org>; Sat, 13 Mar 2021 00:57:02 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 19FB164FA6
	for <kvm@archiver.kernel.org>; Sat, 13 Mar 2021 00:57:02 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S232933AbhCMA4d (ORCPT <rfc822;kvm@archiver.kernel.org>);
        Fri, 12 Mar 2021 19:56:33 -0500
Received: from mail-dm6nam12on2065.outbound.protection.outlook.com
 ([40.107.243.65]:30549
        "EHLO NAM12-DM6-obe.outbound.protection.outlook.com"
        rhost-flags-OK-OK-OK-FAIL) by vger.kernel.org with ESMTP
        id S232230AbhCMA4P (ORCPT <rfc822;kvm@vger.kernel.org>);
        Fri, 12 Mar 2021 19:56:15 -0500
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=GeKE+c+tgUHXN7ZG39YRM470qeojjmEBf8itzvYT04FxF2TJpFXD5oUjP7QUVWcu91ulOUrluEGuIWhViS8i50nJ3A8EMMlnnupwgJ9mkXNvXE1445DtToQITBc0mAvXuQc7sV5ipkPKof8knH3HxoeIvyqDZJlLQHwQHmeK3lPcHZ/fxgvCh2EKpjtoAVXy9xld88X040+zdnxV9m55ZxaMf6wGzMPRDKTyFJnty5rdwtNU9bLm3wtqOB9z6hdLgIemL2Ne9d9mIDubIXds+0GEzqydWWJcWYyZShGUYek4TmxaoU+TkFoZXygkBa7YOanCEBMoc6hVBV3anLNw3g==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=kcykNrb4Yt+GfO112hOfgT7lczlqZVZMbt7s7dHujVE=;
 b=Faf4fssPk2AtmOQKvRbo6LdvFuGmmtWlqLFu6tNZyc0vakPH+SNF3LwZBjd/k90ssepZ+88n0wv3QgbXxrUGqR/UC3gOj/hMJmpMhqvzYDa1XfQfLiv/6Hu2uAtLri0+Sd52oFsck0Ixyem4SFZkZwDEfI343NTV5uByA8d0yvhndGxvqTxe4t11Efo/kd/c11w/ThDCLkh64Y+CGZlcjAFKVfgeOTxcGYWUxGZhyBxSnjR47ghG5HxtTTL7sag265xByBV0HZnsLtmVTYTb2MR0eFV+IzLaK1lwy2Y9U3c367JmhRK7d1WzV/n02CKzR+tEn5KLIS6em2AykvBFwg==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=nvidia.com; dmarc=pass action=none header.from=nvidia.com;
 dkim=pass header.d=nvidia.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=Nvidia.com;
 s=selector2;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=kcykNrb4Yt+GfO112hOfgT7lczlqZVZMbt7s7dHujVE=;
 b=mSHrBngrVnIYOYnq7EL3OsJKJQzj2bc2MV2VNSgPTrDAW8tFplvyJYuVg0XbIjL2EEHixjyYXsCFYEQN035hczPe8KSyeXGxFZULTjUSY/IsgsvGIAHvYQcuMbDaEizsTajDLUnCEjZgoEkDvCY1YDuwbHqdfS2p52SGxJ0l77DXrF8uv+J4lF01SiNZRj+hC+tuvpf3StAWJ4mlBmZa3KYzP8JTzL/5XjEZ8Pj6qCIppy/u7KSHoxB+o5pkTVpah1I6DCQMad/SVCIp2F5Lf2ocI4UUnkDi4L5D046uKrBVLsIlX4aV20gASQeY19a/ZMVoUiNNztUmPjHNMZnTmA==
Authentication-Results: redhat.com; dkim=none (message not signed)
 header.d=none;redhat.com; dmarc=none action=none header.from=nvidia.com;
Received: from DM6PR12MB3834.namprd12.prod.outlook.com (2603:10b6:5:14a::12)
 by DM6PR12MB2940.namprd12.prod.outlook.com (2603:10b6:5:15f::19) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.3933.31; Sat, 13 Mar
 2021 00:56:14 +0000
Received: from DM6PR12MB3834.namprd12.prod.outlook.com
 ([fe80::1c62:7fa3:617b:ab87]) by DM6PR12MB3834.namprd12.prod.outlook.com
 ([fe80::1c62:7fa3:617b:ab87%6]) with mapi id 15.20.3933.032; Sat, 13 Mar 2021
 00:56:14 +0000
From: Jason Gunthorpe <jgg@nvidia.com>
To: Alex Williamson <alex.williamson@redhat.com>,
        Cornelia Huck <cohuck@redhat.com>, kvm@vger.kernel.org
Cc: "Raj, Ashok" <ashok.raj@intel.com>,
        Dan Williams <dan.j.williams@intel.com>,
        Daniel Vetter <daniel@ffwll.ch>,
        Christoph Hellwig <hch@lst.de>,
        Leon Romanovsky <leonro@nvidia.com>,
        Max Gurtovoy <mgurtovoy@nvidia.com>,
        Tarun Gupta <targupta@nvidia.com>,
        Liu Yi L <yi.l.liu@intel.com>
Subject: [PATCH v2 09/14] vfio/pci: Use
 vfio_init/register/unregister_group_dev
Date: Fri, 12 Mar 2021 20:56:01 -0400
Message-Id: <9-v2-20d933792272+4ff-vfio1_jgg@nvidia.com>
In-Reply-To: <0-v2-20d933792272+4ff-vfio1_jgg@nvidia.com>
References: 
X-Originating-IP: [142.162.115.133]
X-ClientProxiedBy: BLAPR03CA0134.namprd03.prod.outlook.com
 (2603:10b6:208:32e::19) To DM6PR12MB3834.namprd12.prod.outlook.com
 (2603:10b6:5:14a::12)
MIME-Version: 1.0
X-MS-Exchange-MessageSentRepresentingType: 1
Received: from mlx.ziepe.ca (142.162.115.133) by
 BLAPR03CA0134.namprd03.prod.outlook.com (2603:10b6:208:32e::19) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.3912.17 via Frontend
 Transport; Sat, 13 Mar 2021 00:56:11 +0000
Received: from jgg by mlx with local (Exim 4.94)        (envelope-from
 <jgg@nvidia.com>)        id 1lKsZb-00EMBH-4a; Fri, 12 Mar 2021 20:56:07 -0400
X-MS-PublicTrafficType: Email
X-MS-Office365-Filtering-Correlation-Id: 69b34586-c2d7-4b38-2759-08d8e5bacb4e
X-MS-TrafficTypeDiagnostic: DM6PR12MB2940:
X-MS-Exchange-Transport-Forked: True
X-Microsoft-Antispam-PRVS: 
 <DM6PR12MB2940479DDA55D3067BC0FEFDC26E9@DM6PR12MB2940.namprd12.prod.outlook.com>
X-MS-Oob-TLC-OOBClassifiers: OLM:4941;
X-MS-Exchange-SenderADCheck: 1
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: 
 31PLhg0QhOSF5v5PRIFFWiqN9Tyojk7Zg+5iX1Yz1TbdEW8SpHwft/KG3IgYqelHKGhk2tAw78t12Ztn8wAoBxTVr0/R/hDfcYFvgXM6hJJiRHskw5Ufnre+RemS949u0xEmtbpbQlLhyF34aKKmmWwt1s6HOrRe5WIaj2gGJEauBg8dE8VGmdGfGNg52v/65Qv2B1YxnCeigFwX5XxGRDRea0QAadPpjRK/TIZteBKdcc5/P34nk2HtoMfOUKKNmQHfVb/l5yvA3dUkUem1dpCP0wD9dTQmKsT+GPnTt5RH3UHzf69fIKT+Lzikxavi21mldsSgMhXU99nQPbuccEO1y0UR3+fFGeHVsZ+/wtfejhB0k46sfQxXzfACcNH2NUEtUPxHqV5F8Z1cX7Kedy2G3upBEIgTyaC2wS+fv79jZdPJwF6Vser/iAUBNy2PQne0rGHaslkMcmJ7NTACef2kgxavDfU5FfILlsAw+mG9rgH//YY0sLHFNNEeMoEkrZLbRgv5pDmPzKVdN4/2Gi7w/3jTFibkd3bO/bqgjC9yEO5OVYppI6KGxJn3uT2YgVPEteNFQ/2JvF1eMy4Rp6BkpKKkPUBmIGy8/ZOFWKo=
X-Forefront-Antispam-Report: 
 CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:DM6PR12MB3834.namprd12.prod.outlook.com;PTR:;CAT:NONE;SFS:(4636009)(39860400002)(376002)(396003)(136003)(366004)(346002)(9746002)(9786002)(8676002)(6666004)(4326008)(54906003)(8936002)(5660300002)(36756003)(316002)(110136005)(83380400001)(66946007)(66556008)(186003)(26005)(66476007)(478600001)(2906002)(426003)(86362001)(2616005)(4216001);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData: 
 O7oHwqZE9qqsOF1oF80+/CabznAE0s9JU1NxWWpMyp5QgRaYrD6eZ9Edrt91GWdmVgMrqoHt0iOeloZq0AmnHa1R+XeO9hRROJJ+X/W+U31hc6IZezaYR5d3VEl3F6QhlvaA8BFdrSX4euWQGuLqOpxAg6mVBC35qww5nY5xiA4xJZSzIUe1caD4LKbAUgb3BzRZp1gKX83tpou99v/61nSwYQW8ePG64uGxQT6qlvoA/rSXSHtkFfsIYmkNxUP37Vmq0Fwq1KKYE2XglhbAbD0wc8yTRhHeosypBiInf9sgOiFvhGR7Nd1eupHj8rk4mbpsFN0Y+bG6w90NkhXA442MQ9cQ4M6KA7zvGyKn+ohqAICdATiYDhC+NZJPwu1RbPoYILfbuzqzAe8Zc+q9MrZaHq9dmYi13e+rSnIN9Z3APQqrQHk2FlAjojOkG4fk2RuFB45WcO9gKYTaP1ZkQStomU9ST4kUFCEeuRH+OVEjiUIGQgb2kQUTDkmg2D9tUsyhHe9mjccPDhZ4Vej2Ziy5dou3Z9wYUsMF7oacAKewzK0PQB5NuWQTMi4+pqRGBZH2gmPaSroUkD8MIxWJV2d+eO4fnJBZTs+6llizLVV2CtPgfJywbS/Q9OCMPBUQw2p2NHg5Da+hwu1aR7obU6pSnlopP3Jd7XP96Cy86mKzWKthQpC84zcM87Tt5to3gvlOKL4zfU6hEp+GEjLW2I4KlFsMORWvQTN3wHvDUhszZshVwBLWKmDd6CovQLDugTCKaYGnWeW+V8kP5P5u9Vu/FzZTqBZgOiZbT6pl8Ye3VqwLzNQnhTk+jwTj8a6tdOYb6aZaVwmx+osWreUkL1xrOy1dqeAKuugMbtSna7GJxTBfBg+LTncZUSuF6bmGb8L3vdbzkdcAxQze6S2i9OsC5CwQ9ftXEJTdSqYEhQtmIoeaeKIesX2noQMl3wGO2+LW80AnKdfp93ULWycJ0MwK/OPYKB7e8qGg0dviJNhXayWrHNqbl50+ohTzln6Wkpt37A8cVnYmMmzK7U1hcCPm5TdzLmKZG1eVKmBDHjZnhdO/utxJTevpXVw6+8tj90NAKQA3Emp19kFr4OHRfmYhJLsn2kAoka3JUcIPunTUOhezLrwhJVgrLNFHKoFszUFHrg312/+YcrBaeB/fRI3QKN/+4av1ts3ee0+Hsjz97Wtvz2QOK6je+CBbVuH96L0eOpmW65Vg5byUFcgI2XHHcbpemi6Lz7NkJASvr/samp3tmnMQetAOrpQ1kAXNlFu2AjfjdVLJeQ3yHukqyOLFd+1Qq4fMG/mqgZByaIC3GB1vQ1uDVhclaHP3+ITL
X-OriginatorOrg: Nvidia.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 
 69b34586-c2d7-4b38-2759-08d8e5bacb4e
X-MS-Exchange-CrossTenant-AuthSource: DM6PR12MB3834.namprd12.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 13 Mar 2021 00:56:11.4157
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 43083d15-7273-40c1-b7db-39efd9ccc17a
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: 
 h/4fB07BRfv7XluDwxw/LWAGTxlW3N8U5gXKd3zW29BxAz6/53w3BY/JeqAUAQhb
X-MS-Exchange-Transport-CrossTenantHeadersStamped: DM6PR12MB2940
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

pci already allocates a struct vfio_pci_device with exactly the same
lifetime as vfio_device, switch to the new API and embed vfio_device in
vfio_pci_device.

Reviewed-by: Christoph Hellwig <hch@lst.de>
Reviewed-by: Liu Yi L <yi.l.liu@intel.com>
Signed-off-by: Jason Gunthorpe <jgg@nvidia.com>
---
 drivers/vfio/pci/vfio_pci.c         | 10 +++++-----
 drivers/vfio/pci/vfio_pci_private.h |  1 +
 2 files changed, 6 insertions(+), 5 deletions(-)

diff --git a/drivers/vfio/pci/vfio_pci.c b/drivers/vfio/pci/vfio_pci.c
index 0e7682e7a0b478..a0ac20a499cf6c 100644
--- a/drivers/vfio/pci/vfio_pci.c
+++ b/drivers/vfio/pci/vfio_pci.c
@@ -2019,6 +2019,7 @@ static int vfio_pci_probe(struct pci_dev *pdev, const struct pci_device_id *id)
 		goto out_group_put;
 	}
 
+	vfio_init_group_dev(&vdev->vdev, &pdev->dev, &vfio_pci_ops, vdev);
 	vdev->pdev = pdev;
 	vdev->irq_type = VFIO_PCI_NUM_IRQS;
 	mutex_init(&vdev->igate);
@@ -2056,9 +2057,10 @@ static int vfio_pci_probe(struct pci_dev *pdev, const struct pci_device_id *id)
 		vfio_pci_set_power_state(vdev, PCI_D3hot);
 	}
 
-	ret = vfio_add_group_dev(&pdev->dev, &vfio_pci_ops, vdev);
+	ret = vfio_register_group_dev(&vdev->vdev);
 	if (ret)
 		goto out_power;
+	dev_set_drvdata(&pdev->dev, vdev);
 	return 0;
 
 out_power:
@@ -2078,13 +2080,11 @@ static int vfio_pci_probe(struct pci_dev *pdev, const struct pci_device_id *id)
 
 static void vfio_pci_remove(struct pci_dev *pdev)
 {
-	struct vfio_pci_device *vdev;
+	struct vfio_pci_device *vdev = dev_get_drvdata(&pdev->dev);
 
 	pci_disable_sriov(pdev);
 
-	vdev = vfio_del_group_dev(&pdev->dev);
-	if (!vdev)
-		return;
+	vfio_unregister_group_dev(&vdev->vdev);
 
 	vfio_pci_vf_uninit(vdev);
 	vfio_pci_reflck_put(vdev->reflck);
diff --git a/drivers/vfio/pci/vfio_pci_private.h b/drivers/vfio/pci/vfio_pci_private.h
index 9cd1882a05af69..8755a0febd054a 100644
--- a/drivers/vfio/pci/vfio_pci_private.h
+++ b/drivers/vfio/pci/vfio_pci_private.h
@@ -100,6 +100,7 @@ struct vfio_pci_mmap_vma {
 };
 
 struct vfio_pci_device {
+	struct vfio_device	vdev;
 	struct pci_dev		*pdev;
 	void __iomem		*barmap[PCI_STD_NUM_BARS];
 	bool			bar_mmap_supported[PCI_STD_NUM_BARS];

From patchwork Sat Mar 13 00:56:02 2021
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
X-Patchwork-Submitter: Jason Gunthorpe <jgg@nvidia.com>
X-Patchwork-Id: 12136231
Return-Path: <kvm-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-16.0 required=3.0 tests=BAYES_00,DKIMWL_WL_HIGH,
	DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,
	INCLUDES_CR_TRAILER,INCLUDES_PATCH,MAILING_LIST_MULTI,MSGID_FROM_MTA_HEADER,
	SPF_HELO_NONE,SPF_PASS autolearn=ham autolearn_force=no version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 00CC7C43333
	for <kvm@archiver.kernel.org>; Sat, 13 Mar 2021 00:57:02 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id D01CA64FA6
	for <kvm@archiver.kernel.org>; Sat, 13 Mar 2021 00:57:01 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S232905AbhCMA4d (ORCPT <rfc822;kvm@archiver.kernel.org>);
        Fri, 12 Mar 2021 19:56:33 -0500
Received: from mail-dm6nam12on2065.outbound.protection.outlook.com
 ([40.107.243.65]:30549
        "EHLO NAM12-DM6-obe.outbound.protection.outlook.com"
        rhost-flags-OK-OK-OK-FAIL) by vger.kernel.org with ESMTP
        id S231789AbhCMA4N (ORCPT <rfc822;kvm@vger.kernel.org>);
        Fri, 12 Mar 2021 19:56:13 -0500
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=X/7Ixe7y6nXGq6NPiYBb7NLjbeQuNnSzzVzxp229dzfZfKOUVXVWniohN7ixMnaaJI+suyHqoMM6eyJaFd8+4fvdDoTlXb0CLElxGTjJ0CyKcxGG7ZP60r7PUm9VUybTSXyORxrlT58Lb6pThmcIg6TiFbQwEWgw+eMUmgQlsBwWM63j4BeCBdXpMEnTG3h1qArdYG6Fx46lmYP3/6uClIYzCHnnCO09THIvsUeXWUNXrkCgMJOGGdS+SAeC++H87lqw6ua10VLFhZteZ+ohCw8JDl/ff+wHNLwKAVWEiUPDL9hs+J1pHZx1RmF7WU4Hc7roLoNqQI8MUeGQxsdyBw==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=ng5NFfyxeRi9RQLflfTqs0wpY89UAqOCtXaqT89KMJM=;
 b=gqAgyzglqHe4pM5F1xHu92a7QuQDXZbZgjY4JsIhEkrMOApkYBr8OpP2BUTfK0rdulxR4ADSYLya4jEh4sVEPrKat45YTuvIqruVAFWqThugvP85Ozm0SKlxMEsRpaUTgT3vpn0ftsGKnJ7h278s6iKlLW53zGHhsaxbnCmE844oGj2zCDzgpJzW3gecCtgnubXNBF6ugLwvPXRP7JKx8aQZ6cjshtOxpOcwIAnkMgaFIzLzMGpjzWN2MBpXdAOExkU9kXRgBc80X9SnCUUNkZEtWlnHHCg0jg+6NORo2rNc5PSp2EC4O/xx9w3US0D5c9/sbCj56KD43DthWvMTMQ==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=nvidia.com; dmarc=pass action=none header.from=nvidia.com;
 dkim=pass header.d=nvidia.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=Nvidia.com;
 s=selector2;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=ng5NFfyxeRi9RQLflfTqs0wpY89UAqOCtXaqT89KMJM=;
 b=i0fZdB1hetNUzh3FIcjYED0EIekNL03sploI9p2Qobd6Sf2hx5/DFUwbvuFNg8XecuWek0A99dVOB3E6Um/C7Sp/8odzsNUZxrhFol7edp7YA6hR8Mz+wAMex3GjiJPKZllbkKN8FI6XOeI0CyE/0XUj2NhEOuth8ZiIpkDU/shLnX1zN1SAOFqqJ21zsKIIMncskFCdo+UnOMtSDpXhgATwHyYkjcSrmn0R8LxEAhMR6b0xxeNPjXukReYi9ld+8X0IRwU21++kH2mTQTXDtD7kgfmghkqdrkw9uc37jRpY8jQpRx/UIOethSViERSVhZFIEMY7qXkAG/LVT+3fyg==
Authentication-Results: redhat.com; dkim=none (message not signed)
 header.d=none;redhat.com; dmarc=none action=none header.from=nvidia.com;
Received: from DM6PR12MB3834.namprd12.prod.outlook.com (2603:10b6:5:14a::12)
 by DM6PR12MB2940.namprd12.prod.outlook.com (2603:10b6:5:15f::19) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.3933.31; Sat, 13 Mar
 2021 00:56:11 +0000
Received: from DM6PR12MB3834.namprd12.prod.outlook.com
 ([fe80::1c62:7fa3:617b:ab87]) by DM6PR12MB3834.namprd12.prod.outlook.com
 ([fe80::1c62:7fa3:617b:ab87%6]) with mapi id 15.20.3933.032; Sat, 13 Mar 2021
 00:56:11 +0000
From: Jason Gunthorpe <jgg@nvidia.com>
To: Alex Williamson <alex.williamson@redhat.com>,
        Cornelia Huck <cohuck@redhat.com>, kvm@vger.kernel.org,
        Kirti Wankhede <kwankhede@nvidia.com>
Cc: "Raj, Ashok" <ashok.raj@intel.com>,
        Dan Williams <dan.j.williams@intel.com>,
        Daniel Vetter <daniel@ffwll.ch>,
        Christoph Hellwig <hch@lst.de>,
        Leon Romanovsky <leonro@nvidia.com>,
        Max Gurtovoy <mgurtovoy@nvidia.com>,
        Tarun Gupta <targupta@nvidia.com>,
        Liu Yi L <yi.l.liu@intel.com>
Subject: [PATCH v2 10/14] vfio/mdev: Use
 vfio_init/register/unregister_group_dev
Date: Fri, 12 Mar 2021 20:56:02 -0400
Message-Id: <10-v2-20d933792272+4ff-vfio1_jgg@nvidia.com>
In-Reply-To: <0-v2-20d933792272+4ff-vfio1_jgg@nvidia.com>
References: 
X-Originating-IP: [142.162.115.133]
X-ClientProxiedBy: BL0PR02CA0013.namprd02.prod.outlook.com
 (2603:10b6:207:3c::26) To DM6PR12MB3834.namprd12.prod.outlook.com
 (2603:10b6:5:14a::12)
MIME-Version: 1.0
X-MS-Exchange-MessageSentRepresentingType: 1
Received: from mlx.ziepe.ca (142.162.115.133) by
 BL0PR02CA0013.namprd02.prod.outlook.com (2603:10b6:207:3c::26) with Microsoft
 SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.3912.17 via Frontend
 Transport; Sat, 13 Mar 2021 00:56:09 +0000
Received: from jgg by mlx with local (Exim 4.94)        (envelope-from
 <jgg@nvidia.com>)        id 1lKsZb-00EMBL-5a; Fri, 12 Mar 2021 20:56:07 -0400
X-MS-PublicTrafficType: Email
X-MS-Office365-Filtering-Correlation-Id: 5acad42c-b35a-40c9-b8b9-08d8e5baca70
X-MS-TrafficTypeDiagnostic: DM6PR12MB2940:
X-MS-Exchange-Transport-Forked: True
X-Microsoft-Antispam-PRVS: 
 <DM6PR12MB2940F9056428DCDA78ECC4BFC26E9@DM6PR12MB2940.namprd12.prod.outlook.com>
X-MS-Oob-TLC-OOBClassifiers: OLM:3631;
X-MS-Exchange-SenderADCheck: 1
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: 
 pzpe33WkZSze4HN5Ai+PB4CdPbcDQUyiKeFhgLjMoDHQFT0GuMt+qEbvqvQGeAS6NWlROI+8l5KLzIEsn9l5s1z8JMK08ZVCDQnGob3TQAwwzRgRKUpcgL1IVv+O0qXiSiVisq8NExP9c27aJoPhJKBfJ5/7LRcRR4VqeGsLFY/EOGHqxcuEB051OiM41Y6NQhDoNMg5gLbkBELQ8ULge+/aA6fFW+We2JdwvC68mQgfIUxH4/bjzjRS7zkP7JhBWPoUabG9oERheNjrSi8g9X8Adc+SfynZ6Kmb/ay2GlRm/X8/MJthvaosjnfxUCoQBHJVf5+FRXkWOVYKuPuDhq98iU+w1mKWZ9Oj2vSppLJOV2f0Pxp6WGMiY5Z1WjJOtbUgIvOjcT1JCMfzAwvF4Ic7fqYDydYJgmHW9iapppQ22bxXu4MDkmbDMohlEFng+OMRsvgiQDomSoKcofcn39E3c7vUcmeacb1FjRJbU/5aw0MSfTX3W6iUQMeWCcpoCsEpy7/WR1+bJRxYYVZFGd4jMjE5YaJ/lu2syFg+MprPztmHzaTVmT7K8LrzIqXG
X-Forefront-Antispam-Report: 
 CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:DM6PR12MB3834.namprd12.prod.outlook.com;PTR:;CAT:NONE;SFS:(4636009)(39860400002)(376002)(396003)(136003)(366004)(346002)(9746002)(9786002)(8676002)(6666004)(4326008)(54906003)(8936002)(5660300002)(36756003)(316002)(110136005)(83380400001)(66946007)(6636002)(66556008)(186003)(26005)(66476007)(478600001)(2906002)(426003)(86362001)(2616005);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData: 
 CzqoEbuahJnQjrL+b4kf8ZhNy1NdyhoY75qMB1lrCE2afNyAc/N474DVZeeELL1YdAVgdBWQnfCyajQ4IZFAxQCjn9zMbh0EfsCMrJBlPnN2URl8f9CysyJrkiQIazjm99FzqGVEOBSnxJSzI494LxFIH+1QMiI7VQ6IkwJylAAaAM1XKM2wh9LVZ9ZCELfHnayuGgJc4e2rRc1od2A+kS0yNyKJvYUPKaJCYyyCGkjcN9zDpGYGoCFdnFvFxqHm8ryHn8Z3BB5maJJ9dkfkz8PPOx1Cco30uONPRszPEp+dgZEoKaPAYBZVg+JMOAQRIiDnxNt76MLYH3wXj+dFSxrn54UYyHfQI682JtImhcXic7JUAx8RM0jI2B4aZdsaydSDfT3La9iqk/H0bdt+OKcZPt8kGfzrYL1oHs7iHXoFoYvW46VRBKAKd2xgunXwx1/6bpfWsBYNh64FI8cb+yWtMXztqwixV4tuAQsNJ5mskDtSVltkMyUK1XXWQ1qVgmXLb9tfNsrX2mzsjrI3gor0M3pt7fkXlFa2Z3YmqfXZnl4kM0H+B3z1mUJBxanb5zerKG5Qt2OL7vTZOEvKj8L05tU17AXdHKBX70aMEhNOiEGUIbiFXDl7+PJk2Dux76YtWZK9yH29eyPYm4FDabsNfVThbni9HVrwcRE8OBF7L/B7o0QZ5AjmIuQG6g/eb2GiQELaWKy+l+hJ4Q0YttC3zp3VRzYa6EeyfRoC0Z42joUPqQqYcPS8nMrOhe8GZhBDipexBykQBmYLEcY6JmQ50s95FCunBmPD8OE0qxwK99Xb5GAYN9RmPK0MZ3duUEhPmLFE66I20l7wIUdNpq/OMrNRnYsji1ZJJmH6Cn4O16AhIw+pbLZexpcGQL7kpqpZjkULGxrNr9pOawnwnfi9Zfa6zqDxN+CpQhqa1D+zL3UB7c2d6GZYsrpubcCKHM0h/OF1tS4SIIXyFXczvOoDzCmIWjvmRfLKVy75JZ++xW0oZZxodo8jlkK51hEBTya5ndxIols5TL9x2jV3vBaKuW4PWRbLS5AvINpAjUbOpfuThVATBk0FAqqaFKoiQGbBgrzThq/fTnU/CGeMSbuUIA36rXL+koRQL9tXab/RZ/MksXW6Cu8Y4/7HfV05dO8qPYslsXbWLYxw32A2DT8T2wAhW01b7HLGq3iSQYORcGvX/PHwyIFZ0Pb5/MDFJ89RM/bwvVxb/joCC556u0yLMWb/Is2P5CgHEi73xkgCN6UsWCTQBGXHfh5kUYRBWOD55JFwMcJuBzYC/M3E3GAREATj0Lz7webISbmD5Cu18Wy7x7V2sQKRvRJlYtNJsf1orYONEzuhh1Lc1STgGw==
X-OriginatorOrg: Nvidia.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 
 5acad42c-b35a-40c9-b8b9-08d8e5baca70
X-MS-Exchange-CrossTenant-AuthSource: DM6PR12MB3834.namprd12.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 13 Mar 2021 00:56:09.8646
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 43083d15-7273-40c1-b7db-39efd9ccc17a
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: 
 As4fTmady0z6J/aVaJdt/1xbUxnwpyAPRJEoOW/8fSqdVIWm85RsyTNWfUsQ61Xg
X-MS-Exchange-Transport-CrossTenantHeadersStamped: DM6PR12MB2940
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

mdev gets little benefit because it doesn't actually do anything, however
it is the last user, so move the code here for now.

Reviewed-by: Christoph Hellwig <hch@lst.de>
Reviewed-by: Liu Yi L <yi.l.liu@intel.com>
Signed-off-by: Jason Gunthorpe <jgg@nvidia.com>
---
 drivers/vfio/mdev/vfio_mdev.c | 24 +++++++++++++++++++--
 drivers/vfio/vfio.c           | 39 ++---------------------------------
 include/linux/vfio.h          |  5 -----
 3 files changed, 24 insertions(+), 44 deletions(-)

diff --git a/drivers/vfio/mdev/vfio_mdev.c b/drivers/vfio/mdev/vfio_mdev.c
index b52eea128549ee..4469aaf31b56cb 100644
--- a/drivers/vfio/mdev/vfio_mdev.c
+++ b/drivers/vfio/mdev/vfio_mdev.c
@@ -21,6 +21,10 @@
 #define DRIVER_AUTHOR   "NVIDIA Corporation"
 #define DRIVER_DESC     "VFIO based driver for Mediated device"
 
+struct mdev_vfio_device {
+	struct vfio_device vdev;
+};
+
 static int vfio_mdev_open(void *device_data)
 {
 	struct mdev_device *mdev = device_data;
@@ -124,13 +128,29 @@ static const struct vfio_device_ops vfio_mdev_dev_ops = {
 static int vfio_mdev_probe(struct device *dev)
 {
 	struct mdev_device *mdev = to_mdev_device(dev);
+	struct mdev_vfio_device *mvdev;
+	int ret;
 
-	return vfio_add_group_dev(dev, &vfio_mdev_dev_ops, mdev);
+	mvdev = kzalloc(sizeof(*mvdev), GFP_KERNEL);
+	if (!mvdev)
+		return -ENOMEM;
+
+	vfio_init_group_dev(&mvdev->vdev, &mdev->dev, &vfio_mdev_dev_ops, mdev);
+	ret = vfio_register_group_dev(&mvdev->vdev);
+	if (ret) {
+		kfree(mvdev);
+		return ret;
+	}
+	dev_set_drvdata(&mdev->dev, mvdev);
+	return 0;
 }
 
 static void vfio_mdev_remove(struct device *dev)
 {
-	vfio_del_group_dev(dev);
+	struct mdev_vfio_device *mvdev = dev_get_drvdata(dev);
+
+	vfio_unregister_group_dev(&mvdev->vdev);
+	kfree(mvdev);
 }
 
 static struct mdev_driver vfio_mdev_driver = {
diff --git a/drivers/vfio/vfio.c b/drivers/vfio/vfio.c
index cfa06ae3b9018b..2d6d7cc1d1ebf9 100644
--- a/drivers/vfio/vfio.c
+++ b/drivers/vfio/vfio.c
@@ -99,8 +99,8 @@ MODULE_PARM_DESC(enable_unsafe_noiommu_mode, "Enable UNSAFE, no-IOMMU mode.  Thi
 /*
  * vfio_iommu_group_{get,put} are only intended for VFIO bus driver probe
  * and remove functions, any use cases other than acquiring the first
- * reference for the purpose of calling vfio_add_group_dev() or removing
- * that symmetric reference after vfio_del_group_dev() should use the raw
+ * reference for the purpose of calling vfio_register_group_dev() or removing
+ * that symmetric reference after vfio_unregister_group_dev() should use the raw
  * iommu_group_{get,put} functions.  In particular, vfio_iommu_group_put()
  * removes the device from the dummy group and cannot be nested.
  */
@@ -799,29 +799,6 @@ int vfio_register_group_dev(struct vfio_device *device)
 }
 EXPORT_SYMBOL_GPL(vfio_register_group_dev);
 
-int vfio_add_group_dev(struct device *dev, const struct vfio_device_ops *ops,
-		       void *device_data)
-{
-	struct vfio_device *device;
-	int ret;
-
-	device = kzalloc(sizeof(*device), GFP_KERNEL);
-	if (!device)
-		return -ENOMEM;
-
-	vfio_init_group_dev(device, dev, ops, device_data);
-	ret = vfio_register_group_dev(device);
-	if (ret)
-		goto err_kfree;
-	dev_set_drvdata(dev, device);
-	return 0;
-
-err_kfree:
-	kfree(device);
-	return ret;
-}
-EXPORT_SYMBOL_GPL(vfio_add_group_dev);
-
 /**
  * Get a reference to the vfio_device for a device.  Even if the
  * caller thinks they own the device, they could be racing with a
@@ -962,18 +939,6 @@ void vfio_unregister_group_dev(struct vfio_device *device)
 }
 EXPORT_SYMBOL_GPL(vfio_unregister_group_dev);
 
-void *vfio_del_group_dev(struct device *dev)
-{
-	struct vfio_device *device = dev_get_drvdata(dev);
-	void *device_data = device->device_data;
-
-	vfio_unregister_group_dev(device);
-	dev_set_drvdata(dev, NULL);
-	kfree(device);
-	return device_data;
-}
-EXPORT_SYMBOL_GPL(vfio_del_group_dev);
-
 /**
  * VFIO base fd, /dev/vfio/vfio
  */
diff --git a/include/linux/vfio.h b/include/linux/vfio.h
index ad8b579d67d34a..4995faf51efeae 100644
--- a/include/linux/vfio.h
+++ b/include/linux/vfio.h
@@ -63,11 +63,6 @@ extern void vfio_iommu_group_put(struct iommu_group *group, struct device *dev);
 void vfio_init_group_dev(struct vfio_device *device, struct device *dev,
 			 const struct vfio_device_ops *ops, void *device_data);
 int vfio_register_group_dev(struct vfio_device *device);
-extern int vfio_add_group_dev(struct device *dev,
-			      const struct vfio_device_ops *ops,
-			      void *device_data);
-
-extern void *vfio_del_group_dev(struct device *dev);
 void vfio_unregister_group_dev(struct vfio_device *device);
 extern struct vfio_device *vfio_device_get_from_dev(struct device *dev);
 extern void vfio_device_put(struct vfio_device *device);

From patchwork Sat Mar 13 00:56:03 2021
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
X-Patchwork-Submitter: Jason Gunthorpe <jgg@nvidia.com>
X-Patchwork-Id: 12136219
Return-Path: <kvm-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-16.0 required=3.0 tests=BAYES_00,DKIMWL_WL_HIGH,
	DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,
	INCLUDES_CR_TRAILER,INCLUDES_PATCH,MAILING_LIST_MULTI,MSGID_FROM_MTA_HEADER,
	SPF_HELO_NONE,SPF_PASS autolearn=ham autolearn_force=no version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 773B9C43381
	for <kvm@archiver.kernel.org>; Sat, 13 Mar 2021 00:57:01 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 3F9F164F8F
	for <kvm@archiver.kernel.org>; Sat, 13 Mar 2021 00:57:01 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S232468AbhCMA42 (ORCPT <rfc822;kvm@archiver.kernel.org>);
        Fri, 12 Mar 2021 19:56:28 -0500
Received: from mail-dm6nam12on2065.outbound.protection.outlook.com
 ([40.107.243.65]:30549
        "EHLO NAM12-DM6-obe.outbound.protection.outlook.com"
        rhost-flags-OK-OK-OK-FAIL) by vger.kernel.org with ESMTP
        id S231392AbhCMA4M (ORCPT <rfc822;kvm@vger.kernel.org>);
        Fri, 12 Mar 2021 19:56:12 -0500
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=XPKlTNquvLPyTr6soZsQ49l5h1iFZ0+zqCgS6lR/CcOVvFKc5EU8KrXZ1WMNPNaUljO+AEaSNRNcBN3O7IxuCk+aWdjjE4HLbapN/qLRU75hXRP3BDw8iqhwLhJc25IChMx8AM4aZjGvz+dUffnZEChr0h3ChQHB/zimxfiQWgnsexFmQoUizWqNwlHwcdGPy6JqFB6m+FSeNF84pPaoGA6q5tNjdh/s+fPNiB7LUeyWsb8yVGcI+/NM+vqMnB58CEoxum0WxOtwk82oFWutXRIjQwR2u0QuU6avAo/QTQ4WMFLXiMrLUh/PxlNYZo/RayQdm9uo5k6ZhkbnGAgR9A==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=Kq5MI6b9VsXsCqUmpGxv/WkQTzaKh0okG76QDxbkoco=;
 b=cCIaCAQGsyouWSXdO91DDqIh5w0IjEyXjJGL85VyPGNzrMLGCTW57pSvsnj71tNklDut1wCMgZJO/HFv7yEg1hLe460QDq/nMUxOsIFOqHjzNMfkAQtFkB30iDF1QvSf7U1ksmpqu45NYrKtBwVh/CdFO+0+i7knrGo3q+u171Vg0hWw7KVhN4krd3sagyCQoVWpPnAuosf9JKHWGvXNphyUc4kHAk7DggW6rNCPqYPlW36TC1chzNGPlzA9i3Gppx3WGlfIjD9vOL/p3eI0LU7jluBdRZiE0lzMbPyhxgevUV2XFGnm2ZcPlGZdgc/qYHJjP8p2xC1ixduLcFJI0w==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=nvidia.com; dmarc=pass action=none header.from=nvidia.com;
 dkim=pass header.d=nvidia.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=Nvidia.com;
 s=selector2;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=Kq5MI6b9VsXsCqUmpGxv/WkQTzaKh0okG76QDxbkoco=;
 b=WVSk6mw3bH6JJE9bL2SwaIAtFywrapkk04fff2ev5wckHtHzt+lrH/oY4/2xt9+vhCk0xFIyBwKdQ5LugyduCdYuxUHJslMWiT7fqFavd7uxYUP+XmdUnKFB6xVO64sZ7NB0HRam0DFe7g5xQkGRE48v3jiVVtXC5CPbcMzNIcDTeJ/5xrUC/mz0qng/xqgigDUllXs05OOrPXlwqDEteBPwRQCKZTFhFXIE1VV5hg8wURoV4o2VejPim4+3cf5XcAD64QfdvtzcMU19GbkhQKq318r6JdduJBVhpIBHQfTtocpydL7+OmrQchxAB8h7aVfviilNfZv6XUdsm792mw==
Authentication-Results: redhat.com; dkim=none (message not signed)
 header.d=none;redhat.com; dmarc=none action=none header.from=nvidia.com;
Received: from DM6PR12MB3834.namprd12.prod.outlook.com (2603:10b6:5:14a::12)
 by DM6PR12MB2940.namprd12.prod.outlook.com (2603:10b6:5:15f::19) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.3933.31; Sat, 13 Mar
 2021 00:56:10 +0000
Received: from DM6PR12MB3834.namprd12.prod.outlook.com
 ([fe80::1c62:7fa3:617b:ab87]) by DM6PR12MB3834.namprd12.prod.outlook.com
 ([fe80::1c62:7fa3:617b:ab87%6]) with mapi id 15.20.3933.032; Sat, 13 Mar 2021
 00:56:10 +0000
From: Jason Gunthorpe <jgg@nvidia.com>
To: Alex Williamson <alex.williamson@redhat.com>,
        Cornelia Huck <cohuck@redhat.com>, kvm@vger.kernel.org,
        Kirti Wankhede <kwankhede@nvidia.com>
Cc: "Raj, Ashok" <ashok.raj@intel.com>,
        Dan Williams <dan.j.williams@intel.com>,
        Daniel Vetter <daniel@ffwll.ch>,
        Christoph Hellwig <hch@lst.de>,
        Leon Romanovsky <leonro@nvidia.com>,
        Max Gurtovoy <mgurtovoy@nvidia.com>,
        Tarun Gupta <targupta@nvidia.com>
Subject: [PATCH v2 11/14] vfio/mdev: Make to_mdev_device() into a static
 inline
Date: Fri, 12 Mar 2021 20:56:03 -0400
Message-Id: <11-v2-20d933792272+4ff-vfio1_jgg@nvidia.com>
In-Reply-To: <0-v2-20d933792272+4ff-vfio1_jgg@nvidia.com>
References: 
X-Originating-IP: [142.162.115.133]
X-ClientProxiedBy: BL0PR02CA0031.namprd02.prod.outlook.com
 (2603:10b6:207:3c::44) To DM6PR12MB3834.namprd12.prod.outlook.com
 (2603:10b6:5:14a::12)
MIME-Version: 1.0
X-MS-Exchange-MessageSentRepresentingType: 1
Received: from mlx.ziepe.ca (142.162.115.133) by
 BL0PR02CA0031.namprd02.prod.outlook.com (2603:10b6:207:3c::44) with Microsoft
 SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.3933.31 via Frontend
 Transport; Sat, 13 Mar 2021 00:56:08 +0000
Received: from jgg by mlx with local (Exim 4.94)        (envelope-from
 <jgg@nvidia.com>)        id 1lKsZb-00EMBP-6Y; Fri, 12 Mar 2021 20:56:07 -0400
X-MS-PublicTrafficType: Email
X-MS-Office365-Filtering-Correlation-Id: f755b11e-9683-4a07-4abb-08d8e5bac98a
X-MS-TrafficTypeDiagnostic: DM6PR12MB2940:
X-MS-Exchange-Transport-Forked: True
X-Microsoft-Antispam-PRVS: 
 <DM6PR12MB29406790A83AAB0552710BCDC26E9@DM6PR12MB2940.namprd12.prod.outlook.com>
X-MS-Oob-TLC-OOBClassifiers: OLM:4125;
X-MS-Exchange-SenderADCheck: 1
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: 
 MawNuEoxY1euwK/ZXb0v7T0Z00IkOyjj+EbfbnYyiJs16QIPMjc1ygjitadktnPL7m9NJTG8nJOf2xk+glLD5sUUVtYs06a/K10iWQkweLnSjbi9YY383B5limgMeeg0y0og6XfJrZrDyA1GoVPDpIAk4b1iU25MOJ3S7O/hHLBJfTApOQZIAlIbaGM7wOw8AqoogpcrpU/3DZ2+B88aLKTFvF2mcRpGlfeZU8O9KsvScocNVUyniW8Lliqcpa9HpS/5mx+bb3UKsFBl+gYN3ZxxksWuJTHx+uUW3bBO2MwdEr4Fxo0OO4SngwlZD7yh0kPwByjrMo6XqrBIBj4SSgb51zrUhoY9849D2IpgS//57rWMwr2AzBjeTTUD7GM331kCf94hmyRdMRiijZwkh0UmeOtLGBJs0cz/E77ud4Lb4YfOVE8413Mee/5lEOh4tjTdplmC0H+FTRVWORTlMsCdOrjApormSM71NAx7roxuNfBNo/6tgBpHccrfHpFEi7sbSogroNiZdgjL0aciM1k2tJPtjoO5nApD9L6S2hm054YRUSJgdJFjBJ00F3mu
X-Forefront-Antispam-Report: 
 CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:DM6PR12MB3834.namprd12.prod.outlook.com;PTR:;CAT:NONE;SFS:(4636009)(39860400002)(376002)(396003)(136003)(366004)(346002)(9746002)(9786002)(8676002)(6666004)(4326008)(107886003)(54906003)(8936002)(5660300002)(4744005)(36756003)(316002)(110136005)(83380400001)(66946007)(6636002)(66556008)(186003)(26005)(66476007)(478600001)(2906002)(426003)(86362001)(2616005);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData: 
 rquMVKlnKJ449viIrtI33LAwHyPgGpLnucILZHYeBWnf2SBGXvHEmq9tBZj8dB8LQUo37KSd/WpEAoC7QPwFmYrmmw7NVRtDFUbpxpMfedxlkEBaQKBpX16DDOP8tBRvfcfyOjTfp/gXpV7srGK3HrPAuq6ahsEW8NCXuN21npkuMWuaf3TaqJvGW3tBLQ6ZgGtdQpJrwHxwutMT5UgbOUh8uUCbymQFJgqlYdgC3wj6OAAq2+FgTW9UVC59AENun6z9HLhiPmbf5xotjnc3eH4bZpdSZ3VdULa1Ayaoy+VCB3LYDMrSfzxTPw6nylyiMIWs/aha8CL2e04fun5v7oAZWEN4J7shahs7ZM5++v0rKGJUzHPDsp+Un7s1zIbXe373OiV/pX2omZuafhCUAtWNwP6hURfqStIXZzJFPh6F5WfHq94y9lbeW7WyMnzORjjf5dGjuyVMuiTY4jxG8IG4d876JEuj+2Z3d+9Smqb9lo1bax0ijxT3h+PuEjn4yL52M3ItJdu53azePs1Daf+/4ZRbo6QwzkRNaHKM4U1OePF5CA488LkWIL12aHI9ESqDfWfoiQcIPF176PhhzO5jpyIhW0oAyQgyoe/m5DGOVrFeoVDqHOkEiThjMupfscUEe6/bzyt2ug6SFWgXmU7zaJfaiI8yBYwQchooa1R1uAIs6rnPk2DibxwNDR/Ojpfk9TeCdwHF56l9MKmwDFHPrEVQEdldqT7zaUv3Ldsk9DH5b1SCkqCxxynq4+EbETJk8I5lITartya9/++rcuaXTM2oJ9Qra8lBiYD3lQ655jt0Do+7kb8yxFnT/5/O6NlK+JM5jtsjXUUuxdMpD2CbHw+2Lfccgv0a6OFvcLpAp7KgOdfxu2TNjlqtb6yLoy0HJH7PePT+z+EttKaD7srIYf4bjlDBHDNEeh1sJQ/HuyV5/xEjSfmEfF/PyAxMXK/l9A7cTZlVTcq1IoNrt/CIQduFbnDlwAiTnSCWKxHo8NlQww7MFvB90M0nTWNn37SQgbZLb2rZAhyHy6OIwIlhnaVGwqB/DVOH1fbFzH+ASjnPItgs/lMwKxTec8dYtnG0URS9NUltz9pJE28nrUDc7+KCZOX1P5BS2hGZexEzDKX01c7uJSfHvmHFvntIFBw/XK3XdiSlfXsS0qDkks203E2u1iBsM3dwOF83O9tb4xrYYPlcyrcqfDP3JFZzKxMnXi0ISqIc2EF3Wr77rCwvAP9+gkp5MeDHl7OLgFKjWReuBpo6GVO2RS500nzeoV6xonLwAeI3IbsBhHEAdZwLwb61ioiy7S9W6FGBC01Sb5wMcWMeuApUEQpcOa55qS4qLcYeCwoulKCQe1/F5w==
X-OriginatorOrg: Nvidia.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 
 f755b11e-9683-4a07-4abb-08d8e5bac98a
X-MS-Exchange-CrossTenant-AuthSource: DM6PR12MB3834.namprd12.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 13 Mar 2021 00:56:08.9901
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 43083d15-7273-40c1-b7db-39efd9ccc17a
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: 
 bZ9AGUbIxeHXWMH+rqiNECzj8yzmLzu7c2rVwH/r0gejayO7tY1DnggYAtbbL4dO
X-MS-Exchange-Transport-CrossTenantHeadersStamped: DM6PR12MB2940
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

The macro wrongly uses 'dev' as both the macro argument and the member
name, which means it fails compilation if any caller uses a word other
than 'dev' as the single argument. Fix this defect by making it into
proper static inline, which is more clear and typesafe anyhow.

Reviewed-by: Christoph Hellwig <hch@lst.de>
Signed-off-by: Jason Gunthorpe <jgg@nvidia.com>
---
 drivers/vfio/mdev/mdev_private.h | 5 ++++-
 1 file changed, 4 insertions(+), 1 deletion(-)

diff --git a/drivers/vfio/mdev/mdev_private.h b/drivers/vfio/mdev/mdev_private.h
index 7d922950caaf3c..74c2e541146999 100644
--- a/drivers/vfio/mdev/mdev_private.h
+++ b/drivers/vfio/mdev/mdev_private.h
@@ -35,7 +35,10 @@ struct mdev_device {
 	bool active;
 };
 
-#define to_mdev_device(dev)	container_of(dev, struct mdev_device, dev)
+static inline struct mdev_device *to_mdev_device(struct device *dev)
+{
+	return container_of(dev, struct mdev_device, dev);
+}
 #define dev_is_mdev(d)		((d)->bus == &mdev_bus_type)
 
 struct mdev_type {

From patchwork Sat Mar 13 00:56:04 2021
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
X-Patchwork-Submitter: Jason Gunthorpe <jgg@nvidia.com>
X-Patchwork-Id: 12136243
Return-Path: <kvm-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-16.0 required=3.0 tests=BAYES_00,DKIMWL_WL_HIGH,
	DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,
	INCLUDES_CR_TRAILER,INCLUDES_PATCH,MAILING_LIST_MULTI,MSGID_FROM_MTA_HEADER,
	SPF_HELO_NONE,SPF_PASS autolearn=ham autolearn_force=no version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 1066DC433E0
	for <kvm@archiver.kernel.org>; Sat, 13 Mar 2021 01:01:53 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id C940264F89
	for <kvm@archiver.kernel.org>; Sat, 13 Mar 2021 01:01:52 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S231907AbhCMBBR (ORCPT <rfc822;kvm@archiver.kernel.org>);
        Fri, 12 Mar 2021 20:01:17 -0500
Received: from mail-bn8nam12on2042.outbound.protection.outlook.com
 ([40.107.237.42]:41185
        "EHLO NAM12-BN8-obe.outbound.protection.outlook.com"
        rhost-flags-OK-OK-OK-FAIL) by vger.kernel.org with ESMTP
        id S229523AbhCMBBM (ORCPT <rfc822;kvm@vger.kernel.org>);
        Fri, 12 Mar 2021 20:01:12 -0500
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=bPXyvkF9n1ySi1iKjJkvVh5axzmC2N7kDvCfFIMPZjrCx9ss1Jvtfj//7/A8nHShw4wUY85LKatGLsuoU65QgKsLfK9c4q9YLw657IgzGrYGAabK+ETTR1F7hsXq6vly149RgWHNzznoU4wtXda3zESmhTBcLX5NNgoP4TuWmTe+zj0FNDbg05a1rbhc1NBWdYFYVxhCRAzO/je3rIh2n7WblXlZbbVDrdtpVM3148bp0I2UK14FeG1phvP1xEWA5y48VNmkf1hGzWphTP7Tdh0Ku390Ua4ZI3sHurvt9i2CEYti2ACFhLC+TlwrTyjhgyNoiI/LA1ifX64YqT4yHA==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=IU8zHcIF59YNhZooqAtcNAXQ39MRo5Pfhvw3lFhGAWc=;
 b=FtpRpOhCiovMpAcfhl8WnMhp9xQDFfERMEnJfXLssK577LllkHKa1fjYZmns6bcZjOUCAVR7sabQfW2qdl0JswsZv8UeX5TzsXtgOhklLfzJ1QPrNDfnzwG65kGIOzf0HH8ZkAWl7qjs2r6JokFxucidqEHzF6Jp6xu14WaN+tTXUL8vx0CSZXXDcWoPjSu+lOnC4P7hUEGAmC74W1qns5vWQiJy1/+00S6K3mmnQlrjlIo6JchxpozQYneHypzdg+GrCgA5jpBUaAqucohrr+KzUXGC7xdoFitJAKbh85ywLyrG5xthi9AIs9PxiCYNlEVlNeW4hRPGuA3ds7KnWQ==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=nvidia.com; dmarc=pass action=none header.from=nvidia.com;
 dkim=pass header.d=nvidia.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=Nvidia.com;
 s=selector2;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=IU8zHcIF59YNhZooqAtcNAXQ39MRo5Pfhvw3lFhGAWc=;
 b=bsL4qtJZtGh8mUkjtAammFwU5PQdeb4Gp1vZm+244g2rKl04msPFI2NwQ+f3HZjS/YCW4XG0bkGb1ykV83BREOqBgXTplTSvHaSgAuIn8mOpUzxbvmC4SHGu5iL58TlBYeS459vyKeV0svV8MU0GlaSpFgfQdrjBJQK+79nI5nJMIvGvczN1yloydZgRKDcFerMbrGSRb6vwuUUE79Tknq3lNxWAu0snHnuFZ9IXy9vv3BOKpZYp3rEGmLOXpd5kJb2H1VW8PauZFuIX5klLG/p8kV+NXvdCMPB9F030aJSEN8jMdFGMGXR6fYoeIS7OIplvluSPrrh16nsFxyR+sQ==
Authentication-Results: redhat.com; dkim=none (message not signed)
 header.d=none;redhat.com; dmarc=none action=none header.from=nvidia.com;
Received: from DM6PR12MB3834.namprd12.prod.outlook.com (2603:10b6:5:14a::12)
 by DM6PR12MB3306.namprd12.prod.outlook.com (2603:10b6:5:186::20) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.3912.17; Sat, 13 Mar
 2021 01:01:10 +0000
Received: from DM6PR12MB3834.namprd12.prod.outlook.com
 ([fe80::1c62:7fa3:617b:ab87]) by DM6PR12MB3834.namprd12.prod.outlook.com
 ([fe80::1c62:7fa3:617b:ab87%6]) with mapi id 15.20.3933.032; Sat, 13 Mar 2021
 01:01:10 +0000
From: Jason Gunthorpe <jgg@nvidia.com>
To: Alex Williamson <alex.williamson@redhat.com>,
        Cornelia Huck <cohuck@redhat.com>,
        Jonathan Corbet <corbet@lwn.net>,
        Diana Craciun <diana.craciun@oss.nxp.com>,
        Eric Auger <eric.auger@redhat.com>, kvm@vger.kernel.org,
        Kirti Wankhede <kwankhede@nvidia.com>,
        linux-doc@vger.kernel.org
Cc: "Raj, Ashok" <ashok.raj@intel.com>,
        Dan Williams <dan.j.williams@intel.com>,
        Daniel Vetter <daniel@ffwll.ch>,
        Christoph Hellwig <hch@lst.de>,
        Leon Romanovsky <leonro@nvidia.com>,
        Max Gurtovoy <mgurtovoy@nvidia.com>,
        Tarun Gupta <targupta@nvidia.com>
Subject: [PATCH v2 12/14] vfio: Make vfio_device_ops pass a 'struct
 vfio_device *' instead of 'void *'
Date: Fri, 12 Mar 2021 20:56:04 -0400
Message-Id: <12-v2-20d933792272+4ff-vfio1_jgg@nvidia.com>
In-Reply-To: <0-v2-20d933792272+4ff-vfio1_jgg@nvidia.com>
References: 
X-Originating-IP: [142.162.115.133]
X-ClientProxiedBy: BL0PR02CA0005.namprd02.prod.outlook.com
 (2603:10b6:207:3c::18) To DM6PR12MB3834.namprd12.prod.outlook.com
 (2603:10b6:5:14a::12)
MIME-Version: 1.0
X-MS-Exchange-MessageSentRepresentingType: 1
Received: from mlx.ziepe.ca (142.162.115.133) by
 BL0PR02CA0005.namprd02.prod.outlook.com (2603:10b6:207:3c::18) with Microsoft
 SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.3912.17 via Frontend
 Transport; Sat, 13 Mar 2021 01:01:09 +0000
Received: from jgg by mlx with local (Exim 4.94)        (envelope-from
 <jgg@nvidia.com>)        id 1lKsZb-00EMBU-7Y; Fri, 12 Mar 2021 20:56:07 -0400
X-MS-PublicTrafficType: Email
X-MS-Office365-Filtering-Correlation-Id: 419807a8-eb93-44d5-8ebe-08d8e5bb7d65
X-MS-TrafficTypeDiagnostic: DM6PR12MB3306:
X-MS-Exchange-Transport-Forked: True
X-Microsoft-Antispam-PRVS: 
 <DM6PR12MB3306B90A686EBA4489B951B0C26E9@DM6PR12MB3306.namprd12.prod.outlook.com>
X-MS-Oob-TLC-OOBClassifiers: OLM:8882;
X-MS-Exchange-SenderADCheck: 1
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: 
 6nzc0QWUoRqEvlWzLFDlwyX7ULEWYEKmDkKHc87bBA7TLlJTiGhH7+jSdk9fAFru848UQvYf9PrPADOilPRI9ylukWQiLC8jx05L8lTsAzdB2Xrkoo4WN0X49NroQtR3DjXUo9S7gHg4evOxl9Z9DClcBOkcSofCH87c/JY7NytNMPrbxM9MHfNn12JE/E/i3ppWMV99x9KbMdp/lN9ngM+cYtBq7//rBpEBg6AGvOJAQh/sW7jzzhFaJ6xpOznHLD8rSXyjFCT1p+VCB578LJOTknJYtvuhBLIho2Y48em+bzHoXXDmULQFzLRmZONXlI1Z/G9m8caQAvBKaDyNx5/XnHv7bFr5Vkis2LnR7++kSVpGnWshyGWumG+EkHqwjF6OC96LuhbW2I4LiKaypmj1hyqmT4WwU8nNfAe4cDJ2Xni/YNw9+EgkFaQwoYC8CY+2XAl+NNOcOrVw1g6QE/PkJ+gOK4dxC1sYw6spO4yIKysyyLO2CYwFgnoIynm6UrD6XvouX9ggD9pJkU+E5g==
X-Forefront-Antispam-Report: 
 CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:DM6PR12MB3834.namprd12.prod.outlook.com;PTR:;CAT:NONE;SFS:(4636009)(39860400002)(396003)(376002)(366004)(136003)(346002)(30864003)(6666004)(8936002)(110136005)(316002)(54906003)(26005)(426003)(8676002)(9786002)(66556008)(66476007)(86362001)(186003)(83380400001)(478600001)(2616005)(9746002)(4326008)(107886003)(36756003)(66946007)(7416002)(5660300002)(2906002);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData: 
 EBgVb8U/VvxXfXz1iifj9eS3EfrNmBuJSzPpPVAoxUFqZSR/6EcV+v6K4pD2TWP+yT17ZT/5lpJHuE6HlMEcptzOg0+xVTRjow1QVXLVxJaKyV9/TXwz0VyC/4ARXtQpspxfY49XG9VlAGpcgDe1jT5INeN3IFnCWISZwaF4lgqgr8/0jHW+NnTAIhK9EZxEiB1rEx7a6qJm9+rkpVB1M595A8AVHzH8WihUJwcbLII3jZzU8EBmY2oeK0fZzY17dFxNsAxhd5QCjxHWOkSeaQb6gMrHBiZUWyevXhoIIu60ZimjvJvri81mFHrMzDEC8RSv1LwAxWWJb54qVAMojKDpqK7Vp1Vydq/wApDGzrfzGNtWyaUo09o6eD2BqXtlycWkZKqEDoQwtzgFjQpM7XzOulL89jf4zTL6WpLq8qLEEFT9tgq4lth37qvvXHerVfiiDrP90JS/d/gfyI9AOFmkkxuhg4h+uZXyiuUkN/ZdYWvV5aSaEbH+Uepe+FIz1wEQ//MPIQOw5TnLy4v+C7hfXgIesQ50QBTsH/ezAX4lJzUxrU03WR14n3tjx8V2V8jDPhSOXCYbrOVkydFcHhewklSh7XM8xrbm7PcJXHlxGPhjJba99vFQTFXy+zGpr5WqsHa1/sPM8+Q6W15yirrOmUXHY8q01NJlSb18Lw7vT6aFktjaA/H+AtzB8hc57uXaEl3aVoAsLZEfTme5lCedN+F4gqSuZuvj5shWzOiGhBnTkyUjnLRFdgwZIaf58yz33Y+kF+srt8zVTBf2tFb6Y+g5ZhJPkizRaf836L1TL7ZkQu0X28H8snRerzmFEE0447xoxDa8p07QI9GvQkvUy6/sVUT2TTP687pXyFxKbZ1mnZ2d8PN15vkVTd1lzjeJbKVk5G2/uX5Dv9vfbRUbJEJJZCFEIkVshBNytdIRRZHxMbzcOoHWKKlnEI9AP4J+UHJlRps92dwI6RLA2CYVT2DyYu+HWRMynP3drWa4VfnM8QZtditS04AeY5mcn5i/97F4nTM1jX2bbBgUQqqVuzEuh0uk134Db9F9l8gXSRvlwrBwlUGt51yMenk96/+V6Cgu9mjdzPCIU6ldikYahHVPplwX/g8w8joJ0O7CgTgf2vydcNzy2bINcF+cYNEIy1qm9MYFh0kkg3AHLOE+y8VKtBRhpQXgQ3RZ08GgowMxIAaNovEhvXFZyXBZUlS/ZhPCSR6UglNlnt9DhZSNm4fSDkraiOQ6F1fVvhBHUSgAMzBAKv2C1XA7chXtOt7O9XJci5HmWF24ihh5tvXS9PtP12Z0U8qiocTE3RFjNsCSI7nFokejCaZ60LyvZp8vJncdLuAdoImqSzdswA==
X-OriginatorOrg: Nvidia.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 
 419807a8-eb93-44d5-8ebe-08d8e5bb7d65
X-MS-Exchange-CrossTenant-AuthSource: DM6PR12MB3834.namprd12.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 13 Mar 2021 01:01:10.0936
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 43083d15-7273-40c1-b7db-39efd9ccc17a
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: 
 1rkT4+ra3IrDT8s9jx8hsVE/18C5M7OmizUyBxEb+tWXlmdxLm+M9Pl7VgntqpcB
X-MS-Exchange-Transport-CrossTenantHeadersStamped: DM6PR12MB3306
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

This is the standard kernel pattern, the ops associated with a struct get
the struct pointer in for typesafety. The expected design is to use
container_of to cleanly go from the subsystem level type to the driver
level type without having any type erasure in a void *.

Reviewed-by: Dan Williams <dan.j.williams@intel.com>
Signed-off-by: Jason Gunthorpe <jgg@nvidia.com>
---
 Documentation/driver-api/vfio.rst            | 18 ++++----
 drivers/vfio/fsl-mc/vfio_fsl_mc.c            | 36 +++++++++------
 drivers/vfio/mdev/vfio_mdev.c                | 33 +++++++-------
 drivers/vfio/pci/vfio_pci.c                  | 47 ++++++++++++--------
 drivers/vfio/platform/vfio_platform_common.c | 33 ++++++++------
 drivers/vfio/vfio.c                          | 20 ++++-----
 include/linux/vfio.h                         | 16 +++----
 7 files changed, 117 insertions(+), 86 deletions(-)

diff --git a/Documentation/driver-api/vfio.rst b/Documentation/driver-api/vfio.rst
index d3a02300913a7f..3337f337293a32 100644
--- a/Documentation/driver-api/vfio.rst
+++ b/Documentation/driver-api/vfio.rst
@@ -269,20 +269,22 @@ ready before calling it. The driver provides an ops structure for callbacks
 similar to a file operations structure::
 
 	struct vfio_device_ops {
-		int	(*open)(void *device_data);
-		void	(*release)(void *device_data);
-		ssize_t	(*read)(void *device_data, char __user *buf,
+		int	(*open)(struct vfio_device *vdev);
+		void	(*release)(struct vfio_device *vdev);
+		ssize_t	(*read)(struct vfio_device *vdev, char __user *buf,
 				size_t count, loff_t *ppos);
-		ssize_t	(*write)(void *device_data, const char __user *buf,
+		ssize_t	(*write)(struct vfio_device *vdev,
+				 const char __user *buf,
 				 size_t size, loff_t *ppos);
-		long	(*ioctl)(void *device_data, unsigned int cmd,
+		long	(*ioctl)(struct vfio_device *vdev, unsigned int cmd,
 				 unsigned long arg);
-		int	(*mmap)(void *device_data, struct vm_area_struct *vma);
+		int	(*mmap)(struct vfio_device *vdev,
+				struct vm_area_struct *vma);
 	};
 
-Each function is passed the device_data that was originally registered
+Each function is passed the vdev that was originally registered
 in the vfio_register_group_dev() call above.  This allows the bus driver
-an easy place to store its opaque, private data.  The open/release
+to obtain its private data using container_of().  The open/release
 callbacks are issued when a new file descriptor is created for a
 device (via VFIO_GROUP_GET_DEVICE_FD).  The ioctl interface provides
 a direct pass through for VFIO_DEVICE_* ioctls.  The read/write/mmap
diff --git a/drivers/vfio/fsl-mc/vfio_fsl_mc.c b/drivers/vfio/fsl-mc/vfio_fsl_mc.c
index 87ea8368aa510a..023b2222806424 100644
--- a/drivers/vfio/fsl-mc/vfio_fsl_mc.c
+++ b/drivers/vfio/fsl-mc/vfio_fsl_mc.c
@@ -135,9 +135,10 @@ static void vfio_fsl_mc_regions_cleanup(struct vfio_fsl_mc_device *vdev)
 	kfree(vdev->regions);
 }
 
-static int vfio_fsl_mc_open(void *device_data)
+static int vfio_fsl_mc_open(struct vfio_device *core_vdev)
 {
-	struct vfio_fsl_mc_device *vdev = device_data;
+	struct vfio_fsl_mc_device *vdev =
+		container_of(core_vdev, struct vfio_fsl_mc_device, vdev);
 	int ret;
 
 	if (!try_module_get(THIS_MODULE))
@@ -161,9 +162,10 @@ static int vfio_fsl_mc_open(void *device_data)
 	return ret;
 }
 
-static void vfio_fsl_mc_release(void *device_data)
+static void vfio_fsl_mc_release(struct vfio_device *core_vdev)
 {
-	struct vfio_fsl_mc_device *vdev = device_data;
+	struct vfio_fsl_mc_device *vdev =
+		container_of(core_vdev, struct vfio_fsl_mc_device, vdev);
 	int ret;
 
 	mutex_lock(&vdev->reflck->lock);
@@ -197,11 +199,12 @@ static void vfio_fsl_mc_release(void *device_data)
 	module_put(THIS_MODULE);
 }
 
-static long vfio_fsl_mc_ioctl(void *device_data, unsigned int cmd,
-			      unsigned long arg)
+static long vfio_fsl_mc_ioctl(struct vfio_device *core_vdev,
+			      unsigned int cmd, unsigned long arg)
 {
 	unsigned long minsz;
-	struct vfio_fsl_mc_device *vdev = device_data;
+	struct vfio_fsl_mc_device *vdev =
+		container_of(core_vdev, struct vfio_fsl_mc_device, vdev);
 	struct fsl_mc_device *mc_dev = vdev->mc_dev;
 
 	switch (cmd) {
@@ -327,10 +330,11 @@ static long vfio_fsl_mc_ioctl(void *device_data, unsigned int cmd,
 	}
 }
 
-static ssize_t vfio_fsl_mc_read(void *device_data, char __user *buf,
+static ssize_t vfio_fsl_mc_read(struct vfio_device *core_vdev, char __user *buf,
 				size_t count, loff_t *ppos)
 {
-	struct vfio_fsl_mc_device *vdev = device_data;
+	struct vfio_fsl_mc_device *vdev =
+		container_of(core_vdev, struct vfio_fsl_mc_device, vdev);
 	unsigned int index = VFIO_FSL_MC_OFFSET_TO_INDEX(*ppos);
 	loff_t off = *ppos & VFIO_FSL_MC_OFFSET_MASK;
 	struct fsl_mc_device *mc_dev = vdev->mc_dev;
@@ -404,10 +408,12 @@ static int vfio_fsl_mc_send_command(void __iomem *ioaddr, uint64_t *cmd_data)
 	return 0;
 }
 
-static ssize_t vfio_fsl_mc_write(void *device_data, const char __user *buf,
-				 size_t count, loff_t *ppos)
+static ssize_t vfio_fsl_mc_write(struct vfio_device *core_vdev,
+				 const char __user *buf, size_t count,
+				 loff_t *ppos)
 {
-	struct vfio_fsl_mc_device *vdev = device_data;
+	struct vfio_fsl_mc_device *vdev =
+		container_of(core_vdev, struct vfio_fsl_mc_device, vdev);
 	unsigned int index = VFIO_FSL_MC_OFFSET_TO_INDEX(*ppos);
 	loff_t off = *ppos & VFIO_FSL_MC_OFFSET_MASK;
 	struct fsl_mc_device *mc_dev = vdev->mc_dev;
@@ -468,9 +474,11 @@ static int vfio_fsl_mc_mmap_mmio(struct vfio_fsl_mc_region region,
 			       size, vma->vm_page_prot);
 }
 
-static int vfio_fsl_mc_mmap(void *device_data, struct vm_area_struct *vma)
+static int vfio_fsl_mc_mmap(struct vfio_device *core_vdev,
+			    struct vm_area_struct *vma)
 {
-	struct vfio_fsl_mc_device *vdev = device_data;
+	struct vfio_fsl_mc_device *vdev =
+		container_of(core_vdev, struct vfio_fsl_mc_device, vdev);
 	struct fsl_mc_device *mc_dev = vdev->mc_dev;
 	unsigned int index;
 
diff --git a/drivers/vfio/mdev/vfio_mdev.c b/drivers/vfio/mdev/vfio_mdev.c
index 4469aaf31b56cb..e7309caa99c71b 100644
--- a/drivers/vfio/mdev/vfio_mdev.c
+++ b/drivers/vfio/mdev/vfio_mdev.c
@@ -25,10 +25,11 @@ struct mdev_vfio_device {
 	struct vfio_device vdev;
 };
 
-static int vfio_mdev_open(void *device_data)
+static int vfio_mdev_open(struct vfio_device *core_vdev)
 {
-	struct mdev_device *mdev = device_data;
+	struct mdev_device *mdev = to_mdev_device(core_vdev->dev);
 	struct mdev_parent *parent = mdev->parent;
+
 	int ret;
 
 	if (unlikely(!parent->ops->open))
@@ -44,9 +45,9 @@ static int vfio_mdev_open(void *device_data)
 	return ret;
 }
 
-static void vfio_mdev_release(void *device_data)
+static void vfio_mdev_release(struct vfio_device *core_vdev)
 {
-	struct mdev_device *mdev = device_data;
+	struct mdev_device *mdev = to_mdev_device(core_vdev->dev);
 	struct mdev_parent *parent = mdev->parent;
 
 	if (likely(parent->ops->release))
@@ -55,10 +56,10 @@ static void vfio_mdev_release(void *device_data)
 	module_put(THIS_MODULE);
 }
 
-static long vfio_mdev_unlocked_ioctl(void *device_data,
+static long vfio_mdev_unlocked_ioctl(struct vfio_device *core_vdev,
 				     unsigned int cmd, unsigned long arg)
 {
-	struct mdev_device *mdev = device_data;
+	struct mdev_device *mdev = to_mdev_device(core_vdev->dev);
 	struct mdev_parent *parent = mdev->parent;
 
 	if (unlikely(!parent->ops->ioctl))
@@ -67,10 +68,10 @@ static long vfio_mdev_unlocked_ioctl(void *device_data,
 	return parent->ops->ioctl(mdev, cmd, arg);
 }
 
-static ssize_t vfio_mdev_read(void *device_data, char __user *buf,
+static ssize_t vfio_mdev_read(struct vfio_device *core_vdev, char __user *buf,
 			      size_t count, loff_t *ppos)
 {
-	struct mdev_device *mdev = device_data;
+	struct mdev_device *mdev = to_mdev_device(core_vdev->dev);
 	struct mdev_parent *parent = mdev->parent;
 
 	if (unlikely(!parent->ops->read))
@@ -79,10 +80,11 @@ static ssize_t vfio_mdev_read(void *device_data, char __user *buf,
 	return parent->ops->read(mdev, buf, count, ppos);
 }
 
-static ssize_t vfio_mdev_write(void *device_data, const char __user *buf,
-			       size_t count, loff_t *ppos)
+static ssize_t vfio_mdev_write(struct vfio_device *core_vdev,
+			       const char __user *buf, size_t count,
+			       loff_t *ppos)
 {
-	struct mdev_device *mdev = device_data;
+	struct mdev_device *mdev = to_mdev_device(core_vdev->dev);
 	struct mdev_parent *parent = mdev->parent;
 
 	if (unlikely(!parent->ops->write))
@@ -91,9 +93,10 @@ static ssize_t vfio_mdev_write(void *device_data, const char __user *buf,
 	return parent->ops->write(mdev, buf, count, ppos);
 }
 
-static int vfio_mdev_mmap(void *device_data, struct vm_area_struct *vma)
+static int vfio_mdev_mmap(struct vfio_device *core_vdev,
+			  struct vm_area_struct *vma)
 {
-	struct mdev_device *mdev = device_data;
+	struct mdev_device *mdev = to_mdev_device(core_vdev->dev);
 	struct mdev_parent *parent = mdev->parent;
 
 	if (unlikely(!parent->ops->mmap))
@@ -102,9 +105,9 @@ static int vfio_mdev_mmap(void *device_data, struct vm_area_struct *vma)
 	return parent->ops->mmap(mdev, vma);
 }
 
-static void vfio_mdev_request(void *device_data, unsigned int count)
+static void vfio_mdev_request(struct vfio_device *core_vdev, unsigned int count)
 {
-	struct mdev_device *mdev = device_data;
+	struct mdev_device *mdev = to_mdev_device(core_vdev->dev);
 	struct mdev_parent *parent = mdev->parent;
 
 	if (parent->ops->request)
diff --git a/drivers/vfio/pci/vfio_pci.c b/drivers/vfio/pci/vfio_pci.c
index a0ac20a499cf6c..5f1a782d1c65ae 100644
--- a/drivers/vfio/pci/vfio_pci.c
+++ b/drivers/vfio/pci/vfio_pci.c
@@ -553,9 +553,10 @@ static void vfio_pci_vf_token_user_add(struct vfio_pci_device *vdev, int val)
 	vfio_device_put(pf_dev);
 }
 
-static void vfio_pci_release(void *device_data)
+static void vfio_pci_release(struct vfio_device *core_vdev)
 {
-	struct vfio_pci_device *vdev = device_data;
+	struct vfio_pci_device *vdev =
+		container_of(core_vdev, struct vfio_pci_device, vdev);
 
 	mutex_lock(&vdev->reflck->lock);
 
@@ -581,9 +582,10 @@ static void vfio_pci_release(void *device_data)
 	module_put(THIS_MODULE);
 }
 
-static int vfio_pci_open(void *device_data)
+static int vfio_pci_open(struct vfio_device *core_vdev)
 {
-	struct vfio_pci_device *vdev = device_data;
+	struct vfio_pci_device *vdev =
+		container_of(core_vdev, struct vfio_pci_device, vdev);
 	int ret = 0;
 
 	if (!try_module_get(THIS_MODULE))
@@ -797,10 +799,11 @@ struct vfio_devices {
 	int max_index;
 };
 
-static long vfio_pci_ioctl(void *device_data,
+static long vfio_pci_ioctl(struct vfio_device *core_vdev,
 			   unsigned int cmd, unsigned long arg)
 {
-	struct vfio_pci_device *vdev = device_data;
+	struct vfio_pci_device *vdev =
+		container_of(core_vdev, struct vfio_pci_device, vdev);
 	unsigned long minsz;
 
 	if (cmd == VFIO_DEVICE_GET_INFO) {
@@ -1402,11 +1405,10 @@ static long vfio_pci_ioctl(void *device_data,
 	return -ENOTTY;
 }
 
-static ssize_t vfio_pci_rw(void *device_data, char __user *buf,
+static ssize_t vfio_pci_rw(struct vfio_pci_device *vdev, char __user *buf,
 			   size_t count, loff_t *ppos, bool iswrite)
 {
 	unsigned int index = VFIO_PCI_OFFSET_TO_INDEX(*ppos);
-	struct vfio_pci_device *vdev = device_data;
 
 	if (index >= VFIO_PCI_NUM_REGIONS + vdev->num_regions)
 		return -EINVAL;
@@ -1434,22 +1436,28 @@ static ssize_t vfio_pci_rw(void *device_data, char __user *buf,
 	return -EINVAL;
 }
 
-static ssize_t vfio_pci_read(void *device_data, char __user *buf,
+static ssize_t vfio_pci_read(struct vfio_device *core_vdev, char __user *buf,
 			     size_t count, loff_t *ppos)
 {
+	struct vfio_pci_device *vdev =
+		container_of(core_vdev, struct vfio_pci_device, vdev);
+
 	if (!count)
 		return 0;
 
-	return vfio_pci_rw(device_data, buf, count, ppos, false);
+	return vfio_pci_rw(vdev, buf, count, ppos, false);
 }
 
-static ssize_t vfio_pci_write(void *device_data, const char __user *buf,
+static ssize_t vfio_pci_write(struct vfio_device *core_vdev, const char __user *buf,
 			      size_t count, loff_t *ppos)
 {
+	struct vfio_pci_device *vdev =
+		container_of(core_vdev, struct vfio_pci_device, vdev);
+
 	if (!count)
 		return 0;
 
-	return vfio_pci_rw(device_data, (char __user *)buf, count, ppos, true);
+	return vfio_pci_rw(vdev, (char __user *)buf, count, ppos, true);
 }
 
 /* Return 1 on zap and vma_lock acquired, 0 on contention (only with @try) */
@@ -1646,9 +1654,10 @@ static const struct vm_operations_struct vfio_pci_mmap_ops = {
 	.fault = vfio_pci_mmap_fault,
 };
 
-static int vfio_pci_mmap(void *device_data, struct vm_area_struct *vma)
+static int vfio_pci_mmap(struct vfio_device *core_vdev, struct vm_area_struct *vma)
 {
-	struct vfio_pci_device *vdev = device_data;
+	struct vfio_pci_device *vdev =
+		container_of(core_vdev, struct vfio_pci_device, vdev);
 	struct pci_dev *pdev = vdev->pdev;
 	unsigned int index;
 	u64 phys_len, req_len, pgoff, req_start;
@@ -1714,9 +1723,10 @@ static int vfio_pci_mmap(void *device_data, struct vm_area_struct *vma)
 	return 0;
 }
 
-static void vfio_pci_request(void *device_data, unsigned int count)
+static void vfio_pci_request(struct vfio_device *core_vdev, unsigned int count)
 {
-	struct vfio_pci_device *vdev = device_data;
+	struct vfio_pci_device *vdev =
+		container_of(core_vdev, struct vfio_pci_device, vdev);
 	struct pci_dev *pdev = vdev->pdev;
 
 	mutex_lock(&vdev->igate);
@@ -1830,9 +1840,10 @@ static int vfio_pci_validate_vf_token(struct vfio_pci_device *vdev,
 
 #define VF_TOKEN_ARG "vf_token="
 
-static int vfio_pci_match(void *device_data, char *buf)
+static int vfio_pci_match(struct vfio_device *core_vdev, char *buf)
 {
-	struct vfio_pci_device *vdev = device_data;
+	struct vfio_pci_device *vdev =
+		container_of(core_vdev, struct vfio_pci_device, vdev);
 	bool vf_token = false;
 	uuid_t uuid;
 	int ret;
diff --git a/drivers/vfio/platform/vfio_platform_common.c b/drivers/vfio/platform/vfio_platform_common.c
index 6eb749250ee41c..f5f6b537084a67 100644
--- a/drivers/vfio/platform/vfio_platform_common.c
+++ b/drivers/vfio/platform/vfio_platform_common.c
@@ -218,9 +218,10 @@ static int vfio_platform_call_reset(struct vfio_platform_device *vdev,
 	return -EINVAL;
 }
 
-static void vfio_platform_release(void *device_data)
+static void vfio_platform_release(struct vfio_device *core_vdev)
 {
-	struct vfio_platform_device *vdev = device_data;
+	struct vfio_platform_device *vdev =
+		container_of(core_vdev, struct vfio_platform_device, vdev);
 
 	mutex_lock(&driver_lock);
 
@@ -244,9 +245,10 @@ static void vfio_platform_release(void *device_data)
 	module_put(vdev->parent_module);
 }
 
-static int vfio_platform_open(void *device_data)
+static int vfio_platform_open(struct vfio_device *core_vdev)
 {
-	struct vfio_platform_device *vdev = device_data;
+	struct vfio_platform_device *vdev =
+		container_of(core_vdev, struct vfio_platform_device, vdev);
 	int ret;
 
 	if (!try_module_get(vdev->parent_module))
@@ -293,10 +295,12 @@ static int vfio_platform_open(void *device_data)
 	return ret;
 }
 
-static long vfio_platform_ioctl(void *device_data,
+static long vfio_platform_ioctl(struct vfio_device *core_vdev,
 				unsigned int cmd, unsigned long arg)
 {
-	struct vfio_platform_device *vdev = device_data;
+	struct vfio_platform_device *vdev =
+		container_of(core_vdev, struct vfio_platform_device, vdev);
+
 	unsigned long minsz;
 
 	if (cmd == VFIO_DEVICE_GET_INFO) {
@@ -455,10 +459,11 @@ static ssize_t vfio_platform_read_mmio(struct vfio_platform_region *reg,
 	return -EFAULT;
 }
 
-static ssize_t vfio_platform_read(void *device_data, char __user *buf,
-				  size_t count, loff_t *ppos)
+static ssize_t vfio_platform_read(struct vfio_device *core_vdev,
+				  char __user *buf, size_t count, loff_t *ppos)
 {
-	struct vfio_platform_device *vdev = device_data;
+	struct vfio_platform_device *vdev =
+		container_of(core_vdev, struct vfio_platform_device, vdev);
 	unsigned int index = VFIO_PLATFORM_OFFSET_TO_INDEX(*ppos);
 	loff_t off = *ppos & VFIO_PLATFORM_OFFSET_MASK;
 
@@ -531,10 +536,11 @@ static ssize_t vfio_platform_write_mmio(struct vfio_platform_region *reg,
 	return -EFAULT;
 }
 
-static ssize_t vfio_platform_write(void *device_data, const char __user *buf,
+static ssize_t vfio_platform_write(struct vfio_device *core_vdev, const char __user *buf,
 				   size_t count, loff_t *ppos)
 {
-	struct vfio_platform_device *vdev = device_data;
+	struct vfio_platform_device *vdev =
+		container_of(core_vdev, struct vfio_platform_device, vdev);
 	unsigned int index = VFIO_PLATFORM_OFFSET_TO_INDEX(*ppos);
 	loff_t off = *ppos & VFIO_PLATFORM_OFFSET_MASK;
 
@@ -573,9 +579,10 @@ static int vfio_platform_mmap_mmio(struct vfio_platform_region region,
 			       req_len, vma->vm_page_prot);
 }
 
-static int vfio_platform_mmap(void *device_data, struct vm_area_struct *vma)
+static int vfio_platform_mmap(struct vfio_device *core_vdev, struct vm_area_struct *vma)
 {
-	struct vfio_platform_device *vdev = device_data;
+	struct vfio_platform_device *vdev =
+		container_of(core_vdev, struct vfio_platform_device, vdev);
 	unsigned int index;
 
 	index = vma->vm_pgoff >> (VFIO_PLATFORM_OFFSET_SHIFT - PAGE_SHIFT);
diff --git a/drivers/vfio/vfio.c b/drivers/vfio/vfio.c
index 2d6d7cc1d1ebf9..01de47d1810b6b 100644
--- a/drivers/vfio/vfio.c
+++ b/drivers/vfio/vfio.c
@@ -832,7 +832,7 @@ static struct vfio_device *vfio_device_get_from_name(struct vfio_group *group,
 		int ret;
 
 		if (it->ops->match) {
-			ret = it->ops->match(it->device_data, buf);
+			ret = it->ops->match(it, buf);
 			if (ret < 0) {
 				device = ERR_PTR(ret);
 				break;
@@ -893,7 +893,7 @@ void vfio_unregister_group_dev(struct vfio_device *device)
 	rc = try_wait_for_completion(&device->comp);
 	while (rc <= 0) {
 		if (device->ops->request)
-			device->ops->request(device->device_data, i++);
+			device->ops->request(device, i++);
 
 		if (interrupted) {
 			rc = wait_for_completion_timeout(&device->comp,
@@ -1379,7 +1379,7 @@ static int vfio_group_get_device_fd(struct vfio_group *group, char *buf)
 	if (IS_ERR(device))
 		return PTR_ERR(device);
 
-	ret = device->ops->open(device->device_data);
+	ret = device->ops->open(device);
 	if (ret) {
 		vfio_device_put(device);
 		return ret;
@@ -1391,7 +1391,7 @@ static int vfio_group_get_device_fd(struct vfio_group *group, char *buf)
 	 */
 	ret = get_unused_fd_flags(O_CLOEXEC);
 	if (ret < 0) {
-		device->ops->release(device->device_data);
+		device->ops->release(device);
 		vfio_device_put(device);
 		return ret;
 	}
@@ -1401,7 +1401,7 @@ static int vfio_group_get_device_fd(struct vfio_group *group, char *buf)
 	if (IS_ERR(filep)) {
 		put_unused_fd(ret);
 		ret = PTR_ERR(filep);
-		device->ops->release(device->device_data);
+		device->ops->release(device);
 		vfio_device_put(device);
 		return ret;
 	}
@@ -1558,7 +1558,7 @@ static int vfio_device_fops_release(struct inode *inode, struct file *filep)
 {
 	struct vfio_device *device = filep->private_data;
 
-	device->ops->release(device->device_data);
+	device->ops->release(device);
 
 	vfio_group_try_dissolve_container(device->group);
 
@@ -1575,7 +1575,7 @@ static long vfio_device_fops_unl_ioctl(struct file *filep,
 	if (unlikely(!device->ops->ioctl))
 		return -EINVAL;
 
-	return device->ops->ioctl(device->device_data, cmd, arg);
+	return device->ops->ioctl(device, cmd, arg);
 }
 
 static ssize_t vfio_device_fops_read(struct file *filep, char __user *buf,
@@ -1586,7 +1586,7 @@ static ssize_t vfio_device_fops_read(struct file *filep, char __user *buf,
 	if (unlikely(!device->ops->read))
 		return -EINVAL;
 
-	return device->ops->read(device->device_data, buf, count, ppos);
+	return device->ops->read(device, buf, count, ppos);
 }
 
 static ssize_t vfio_device_fops_write(struct file *filep,
@@ -1598,7 +1598,7 @@ static ssize_t vfio_device_fops_write(struct file *filep,
 	if (unlikely(!device->ops->write))
 		return -EINVAL;
 
-	return device->ops->write(device->device_data, buf, count, ppos);
+	return device->ops->write(device, buf, count, ppos);
 }
 
 static int vfio_device_fops_mmap(struct file *filep, struct vm_area_struct *vma)
@@ -1608,7 +1608,7 @@ static int vfio_device_fops_mmap(struct file *filep, struct vm_area_struct *vma)
 	if (unlikely(!device->ops->mmap))
 		return -EINVAL;
 
-	return device->ops->mmap(device->device_data, vma);
+	return device->ops->mmap(device, vma);
 }
 
 static const struct file_operations vfio_device_fops = {
diff --git a/include/linux/vfio.h b/include/linux/vfio.h
index 4995faf51efeae..784c34c0a28763 100644
--- a/include/linux/vfio.h
+++ b/include/linux/vfio.h
@@ -44,17 +44,17 @@ struct vfio_device {
  */
 struct vfio_device_ops {
 	char	*name;
-	int	(*open)(void *device_data);
-	void	(*release)(void *device_data);
-	ssize_t	(*read)(void *device_data, char __user *buf,
+	int	(*open)(struct vfio_device *vdev);
+	void	(*release)(struct vfio_device *vdev);
+	ssize_t	(*read)(struct vfio_device *vdev, char __user *buf,
 			size_t count, loff_t *ppos);
-	ssize_t	(*write)(void *device_data, const char __user *buf,
+	ssize_t	(*write)(struct vfio_device *vdev, const char __user *buf,
 			 size_t count, loff_t *size);
-	long	(*ioctl)(void *device_data, unsigned int cmd,
+	long	(*ioctl)(struct vfio_device *vdev, unsigned int cmd,
 			 unsigned long arg);
-	int	(*mmap)(void *device_data, struct vm_area_struct *vma);
-	void	(*request)(void *device_data, unsigned int count);
-	int	(*match)(void *device_data, char *buf);
+	int	(*mmap)(struct vfio_device *vdev, struct vm_area_struct *vma);
+	void	(*request)(struct vfio_device *vdev, unsigned int count);
+	int	(*match)(struct vfio_device *vdev, char *buf);
 };
 
 extern struct iommu_group *vfio_iommu_group_get(struct device *dev);

From patchwork Sat Mar 13 00:56:05 2021
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
X-Patchwork-Submitter: Jason Gunthorpe <jgg@nvidia.com>
X-Patchwork-Id: 12136233
Return-Path: <kvm-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-16.0 required=3.0 tests=BAYES_00,DKIMWL_WL_HIGH,
	DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,
	INCLUDES_CR_TRAILER,INCLUDES_PATCH,MAILING_LIST_MULTI,MSGID_FROM_MTA_HEADER,
	SPF_HELO_NONE,SPF_PASS autolearn=ham autolearn_force=no version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 649BBC43603
	for <kvm@archiver.kernel.org>; Sat, 13 Mar 2021 00:57:02 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 484D064F87
	for <kvm@archiver.kernel.org>; Sat, 13 Mar 2021 00:57:02 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S232951AbhCMA4e (ORCPT <rfc822;kvm@archiver.kernel.org>);
        Fri, 12 Mar 2021 19:56:34 -0500
Received: from mail-dm6nam12on2081.outbound.protection.outlook.com
 ([40.107.243.81]:44481
        "EHLO NAM12-DM6-obe.outbound.protection.outlook.com"
        rhost-flags-OK-OK-OK-FAIL) by vger.kernel.org with ESMTP
        id S232311AbhCMA4Q (ORCPT <rfc822;kvm@vger.kernel.org>);
        Fri, 12 Mar 2021 19:56:16 -0500
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=BgpIcrCNLYCceNJRx1G89n1KkhUTaMaUsInL1cua609+WDYN1swNaPArfODzU8Zuo8qH6KfqKr7mzbeG/1+Yle1qcfe9n4/LkQcYG36svemTqHSlbLgQV0hMt4PrWs0eeNtPfCkOcGwfXkbUdrLkNhaJfXzPtKqe49e8akzpmuTywe4mA3KCfH1KmzsIXcxN8NDodT1avfPIPj/pdPsUMGbk/DGVWbrhPJejuJKPobEAvclFw1zNEQRwN8ha/Vm16A/s/PjhzTw4iwWftrpYmYv54pJ1N7LF+G1coG/eag/ZdFWHX2Pn4KPpeAAviKh9BXIyu5Q1/GFRhcZU8fToyQ==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=ehNlWmtZtgb6mG0WAwYxqr1bT1zfvPDosiqeUW1pctA=;
 b=n/MOIpClgTWo8srAkWw+C2+9QY7FFxfmZMTB3yvNljZNFCXbJGsIaz89bJ4KDbdEW7jsqtRWf4tOTL2PVpe5FubtsB9jWwKiVIXxNlXu0aqQ0nPm8U/ihXnehcEXGMc0Lbl3BfsbF9j6byvi7//Irxu2XnyWl/QwKVCDX6bWW9sy7+JOegwZRzOJHg+x0X7G5jA3TllPL3XjecQnyJBhb1Imdq5GDpzRWCdurHcyVmcQAD3DK64snGuTP5/tIBsVLqKPfKyKUylLsnREFXVrhvfI1O2F3jk3R8PQlWJ4jXHLgAkc8Yb54KOfiwCQstRxSxNBkMtBL8xQqSJwpncp+g==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=nvidia.com; dmarc=pass action=none header.from=nvidia.com;
 dkim=pass header.d=nvidia.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=Nvidia.com;
 s=selector2;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=ehNlWmtZtgb6mG0WAwYxqr1bT1zfvPDosiqeUW1pctA=;
 b=rKfeOysExRaV08/3EtJJ6ApS34vxDTuldbpsudYKGCKScwjx2KcRNAC9Va8BS4BNShU4zxNpgoCW4umSnwb2okKW4osi4stfFVQSev3cm7UqJPSpjjtpTBam14kZip3E86uK51Y8oUSWX7agyxBYKxZEx5ZTbEddY5qNEH+V6Ll5JwXopke5rchF7M4erO9zXfPA3EhurBZ143bNktuJwfEFXWfIjFLTjA7B9agL53B5Vd/CyIuPZ/EvCaVkqhy9VxpAi3i7UtyJs+t378H3B+Mg0MfiqgaJZ4eQ4QB3GkHlvFbynbzbx8cg2hcEdTJCoDCM0og9HbRyWDSyxMWiBQ==
Authentication-Results: redhat.com; dkim=none (message not signed)
 header.d=none;redhat.com; dmarc=none action=none header.from=nvidia.com;
Received: from DM6PR12MB3834.namprd12.prod.outlook.com (2603:10b6:5:14a::12)
 by DM6PR12MB2940.namprd12.prod.outlook.com (2603:10b6:5:15f::19) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.3933.31; Sat, 13 Mar
 2021 00:56:15 +0000
Received: from DM6PR12MB3834.namprd12.prod.outlook.com
 ([fe80::1c62:7fa3:617b:ab87]) by DM6PR12MB3834.namprd12.prod.outlook.com
 ([fe80::1c62:7fa3:617b:ab87%6]) with mapi id 15.20.3933.032; Sat, 13 Mar 2021
 00:56:15 +0000
From: Jason Gunthorpe <jgg@nvidia.com>
To: Alex Williamson <alex.williamson@redhat.com>,
        Cornelia Huck <cohuck@redhat.com>, kvm@vger.kernel.org
Cc: "Raj, Ashok" <ashok.raj@intel.com>,
        Dan Williams <dan.j.williams@intel.com>,
        Daniel Vetter <daniel@ffwll.ch>,
        Christoph Hellwig <hch@lst.de>,
        Leon Romanovsky <leonro@nvidia.com>,
        Max Gurtovoy <mgurtovoy@nvidia.com>,
        Tarun Gupta <targupta@nvidia.com>
Subject: [PATCH v2 13/14] vfio/pci: Replace uses of vfio_device_data() with
 container_of
Date: Fri, 12 Mar 2021 20:56:05 -0400
Message-Id: <13-v2-20d933792272+4ff-vfio1_jgg@nvidia.com>
In-Reply-To: <0-v2-20d933792272+4ff-vfio1_jgg@nvidia.com>
References: 
X-Originating-IP: [142.162.115.133]
X-ClientProxiedBy: MN2PR22CA0019.namprd22.prod.outlook.com
 (2603:10b6:208:238::24) To DM6PR12MB3834.namprd12.prod.outlook.com
 (2603:10b6:5:14a::12)
MIME-Version: 1.0
X-MS-Exchange-MessageSentRepresentingType: 1
Received: from mlx.ziepe.ca (142.162.115.133) by
 MN2PR22CA0019.namprd22.prod.outlook.com (2603:10b6:208:238::24) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.3933.31 via Frontend
 Transport; Sat, 13 Mar 2021 00:56:12 +0000
Received: from jgg by mlx with local (Exim 4.94)        (envelope-from
 <jgg@nvidia.com>)        id 1lKsZb-00EMBX-91; Fri, 12 Mar 2021 20:56:07 -0400
X-MS-PublicTrafficType: Email
X-MS-Office365-Filtering-Correlation-Id: d34369f9-6eee-4234-19bf-08d8e5bacc14
X-MS-TrafficTypeDiagnostic: DM6PR12MB2940:
X-MS-Exchange-Transport-Forked: True
X-Microsoft-Antispam-PRVS: 
 <DM6PR12MB2940608DAF72CAA3C1B65A32C26E9@DM6PR12MB2940.namprd12.prod.outlook.com>
X-MS-Oob-TLC-OOBClassifiers: OLM:9508;
X-MS-Exchange-SenderADCheck: 1
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: 
 L/33DNewqPErMzXXDP93FT3rx2dABJ9QG4GkNj0lo2o8LlpiEZsVQtyC3qoX2AiZgwb9vdxe7X4aqib/lkfKBKIyufLzPfQFdYoXJVtHT2X4RkCtRyO7NuVO0W4CFI10l5IiQFw+BYULlsKz8mHiLFW2AniuZCKWXoBMeQCSaWVNiq1S/r9f3cDrUryScDUaYL8vfUan1me4RMIzDuyNRMGwUKuOzSVY+GY3qVhgpMdFZqt0a50yWo4J+5cyk4sEL18WSpUauGN0HyFDG4LayuhTCeHZkYsLFaeVlhQAbhIGkshawrm5IOX3jKnEIrucpa7InwQ9vaf90HMXukWYw/5AmXGD0rbVzUkYcxVDjTp1iAzrFtXoj+J6T9PWr8u8YBdHYVjgXylgLW99hh205L50kVKqpAZkVHliZXL9lYVrEZOlwjxnwYa9FcrjfaW//ed28G3wneTkphA2KQNQY3sluuVr3ctagexYn8l9/4nZ0GpzVMAxXAfM0rs9nmg49L19G4EBYIEntDPNJ6VhwqaVtWUTfjTPZb3lvNWjmDkL/1qSDo1PIyVtHTmP8QnN
X-Forefront-Antispam-Report: 
 CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:DM6PR12MB3834.namprd12.prod.outlook.com;PTR:;CAT:NONE;SFS:(4636009)(39860400002)(376002)(396003)(136003)(366004)(346002)(9746002)(9786002)(8676002)(4326008)(107886003)(54906003)(8936002)(5660300002)(36756003)(316002)(110136005)(83380400001)(66946007)(66556008)(186003)(26005)(66476007)(478600001)(2906002)(426003)(86362001)(2616005);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData: 
 xEZc8o3ogkTLnDGA6Yzxb7BdMWK9/qsPqts9hfj9KJIhziwwT0MI9Nl9V1vUOc8evm0qhT+hrsKkNg2MtRjQp5KjDgCl8fW+7YGLXtYPwT/d+SbzcbHkKpdelmc3YFgzAzbFCpSesJX250ktxJqhkERCwaK4Yw7ynRfUdrshueQ8ovVvCQ04uDBRTU9BEbfOsmRhVTu5f6/ddwvz5r2ROnTnyjcQvGQmeR63yzTb/rVDWjGZFdkn+Y3rS0snv08xDute6qadCgC7js5FOuEwO+7dRMQXPRTNVtVlYcZE4kBhAWArCwwroUlhiX/g3zOWkE5eW8pedmZztfy/nnm+meqOF30f8ejTlmOo/AyjC2HYhmQdxi0h7F71986Aq1pEo3AqWtUy9vYquzIIxapa5Vy8sB0vzqMGrQ86w6ngH930IMLEamokw3rVAmN5HAj5cFVHR4x+8zLDAngKBAL3hDp+QQcMkWEWwBVWPLamqpW6H2y/WZku+enbtcklHEzYZzA7R0zAL3ljm8JjMUS4o/jl6qMGLViLDTZy5yj7RxuXrFja1/xR8bGvC+WPGNVG4GUTYO4XWXzw75QL4lNpc3DF4EceUZpI5KRXiTiT34QLFuUZ6TXg46Za5AM+YDeAZEtB538y+asXO7oqr3HsiFSjBPULpI1zE+qgQDRUbA8IqA12/fWLRUNXHtg/Wck8XeC12coktFEm3a5ik8vaQPyOp1b0kmGzDK9RQfuOBx0GKfzJ//tejyvXcw6cNoupBx8obWjSYPF9laPWhaGOd3j8qRJo5E5QF77AJZAcvk5QxGfI/U4+CYPL/PoEDAFF6WzfPQ4ib6PW5pK3MexSV7nGEvzXvehLLwGVGlqrQ/2uFaae0Gb8JRHKVnwerH7TUYY1zIZqvjnvW/zGVO+PxsLW72hRKzz/2gHkY+jfJ0/ZLeTimUlvmrlr/nvOU1ZXe51nhcpI2JolZQ096idsD7szKwhvF6DJSdpbZoCtjdCWvU4KcUNnXRHPFyXzYsRSlw9eMnlJoFk/Js46gnqazgpWrSB2tr00iF37jbPvY5aEUJoo34Try3dSZ2WImrsIdUGeEpqpmpJQ+zgysAy0thVgzwqkKJS6ks3Gu42BSqhTkEOcJym1Ch1xtJQIQD3UCjGupBzOQb6GK5XImsRa/tT6eE5NgvLCcl1l/V6IIgSKP4Xdzt0eTnH/mLXPNr03RJTtwk0iac5pyOhOV7IKqPNve7TXTx8HMmYkJXe9G0g4dvtdB5CWqeBeZP9c7daHXJsJNMpRxOOJlp/pMC32oIMoVTRPXAVTL+tGk/37+v8NrsvHivmTyl8sIgg8KnTg
X-OriginatorOrg: Nvidia.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 
 d34369f9-6eee-4234-19bf-08d8e5bacc14
X-MS-Exchange-CrossTenant-AuthSource: DM6PR12MB3834.namprd12.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 13 Mar 2021 00:56:12.6760
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 43083d15-7273-40c1-b7db-39efd9ccc17a
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: 
 n6Ru3bxAla8KxxFpO4QCG8LDlOJNW93GBhzo2pLGsU6FcLXgvayiUYVY8bOwydCO
X-MS-Exchange-Transport-CrossTenantHeadersStamped: DM6PR12MB2940
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

This tidies a few confused places that think they can have a refcount on
the vfio_device but the device_data could be NULL, that isn't possible by
design.

Most of the change falls out when struct vfio_devices is updated to just
store the struct vfio_pci_device itself. This wasn't possible before
because there was no easy way to get from the 'struct vfio_pci_device' to
the 'struct vfio_device' to put back the refcount.

Reviewed-by: Christoph Hellwig <hch@lst.de>
Signed-off-by: Jason Gunthorpe <jgg@nvidia.com>
---
 drivers/vfio/pci/vfio_pci.c | 67 +++++++++++++------------------------
 1 file changed, 24 insertions(+), 43 deletions(-)

diff --git a/drivers/vfio/pci/vfio_pci.c b/drivers/vfio/pci/vfio_pci.c
index 5f1a782d1c65ae..1f70387c8afe37 100644
--- a/drivers/vfio/pci/vfio_pci.c
+++ b/drivers/vfio/pci/vfio_pci.c
@@ -517,30 +517,29 @@ static void vfio_pci_disable(struct vfio_pci_device *vdev)
 
 static struct pci_driver vfio_pci_driver;
 
-static struct vfio_pci_device *get_pf_vdev(struct vfio_pci_device *vdev,
-					   struct vfio_device **pf_dev)
+static struct vfio_pci_device *get_pf_vdev(struct vfio_pci_device *vdev)
 {
 	struct pci_dev *physfn = pci_physfn(vdev->pdev);
+	struct vfio_device *pf_dev;
 
 	if (!vdev->pdev->is_virtfn)
 		return NULL;
 
-	*pf_dev = vfio_device_get_from_dev(&physfn->dev);
-	if (!*pf_dev)
+	pf_dev = vfio_device_get_from_dev(&physfn->dev);
+	if (!pf_dev)
 		return NULL;
 
 	if (pci_dev_driver(physfn) != &vfio_pci_driver) {
-		vfio_device_put(*pf_dev);
+		vfio_device_put(pf_dev);
 		return NULL;
 	}
 
-	return vfio_device_data(*pf_dev);
+	return container_of(pf_dev, struct vfio_pci_device, vdev);
 }
 
 static void vfio_pci_vf_token_user_add(struct vfio_pci_device *vdev, int val)
 {
-	struct vfio_device *pf_dev;
-	struct vfio_pci_device *pf_vdev = get_pf_vdev(vdev, &pf_dev);
+	struct vfio_pci_device *pf_vdev = get_pf_vdev(vdev);
 
 	if (!pf_vdev)
 		return;
@@ -550,7 +549,7 @@ static void vfio_pci_vf_token_user_add(struct vfio_pci_device *vdev, int val)
 	WARN_ON(pf_vdev->vf_token->users < 0);
 	mutex_unlock(&pf_vdev->vf_token->lock);
 
-	vfio_device_put(pf_dev);
+	vfio_device_put(&pf_vdev->vdev);
 }
 
 static void vfio_pci_release(struct vfio_device *core_vdev)
@@ -794,7 +793,7 @@ int vfio_pci_register_dev_region(struct vfio_pci_device *vdev,
 }
 
 struct vfio_devices {
-	struct vfio_device **devices;
+	struct vfio_pci_device **devices;
 	int cur_index;
 	int max_index;
 };
@@ -1283,9 +1282,7 @@ static long vfio_pci_ioctl(struct vfio_device *core_vdev,
 			goto hot_reset_release;
 
 		for (; mem_idx < devs.cur_index; mem_idx++) {
-			struct vfio_pci_device *tmp;
-
-			tmp = vfio_device_data(devs.devices[mem_idx]);
+			struct vfio_pci_device *tmp = devs.devices[mem_idx];
 
 			ret = down_write_trylock(&tmp->memory_lock);
 			if (!ret) {
@@ -1300,17 +1297,13 @@ static long vfio_pci_ioctl(struct vfio_device *core_vdev,
 
 hot_reset_release:
 		for (i = 0; i < devs.cur_index; i++) {
-			struct vfio_device *device;
-			struct vfio_pci_device *tmp;
-
-			device = devs.devices[i];
-			tmp = vfio_device_data(device);
+			struct vfio_pci_device *tmp = devs.devices[i];
 
 			if (i < mem_idx)
 				up_write(&tmp->memory_lock);
 			else
 				mutex_unlock(&tmp->vma_lock);
-			vfio_device_put(device);
+			vfio_device_put(&tmp->vdev);
 		}
 		kfree(devs.devices);
 
@@ -1777,8 +1770,7 @@ static int vfio_pci_validate_vf_token(struct vfio_pci_device *vdev,
 		return 0; /* No VF token provided or required */
 
 	if (vdev->pdev->is_virtfn) {
-		struct vfio_device *pf_dev;
-		struct vfio_pci_device *pf_vdev = get_pf_vdev(vdev, &pf_dev);
+		struct vfio_pci_device *pf_vdev = get_pf_vdev(vdev);
 		bool match;
 
 		if (!pf_vdev) {
@@ -1791,7 +1783,7 @@ static int vfio_pci_validate_vf_token(struct vfio_pci_device *vdev,
 		}
 
 		if (!vf_token) {
-			vfio_device_put(pf_dev);
+			vfio_device_put(&pf_vdev->vdev);
 			pci_info_ratelimited(vdev->pdev,
 				"VF token required to access device\n");
 			return -EACCES;
@@ -1801,7 +1793,7 @@ static int vfio_pci_validate_vf_token(struct vfio_pci_device *vdev,
 		match = uuid_equal(uuid, &pf_vdev->vf_token->uuid);
 		mutex_unlock(&pf_vdev->vf_token->lock);
 
-		vfio_device_put(pf_dev);
+		vfio_device_put(&pf_vdev->vdev);
 
 		if (!match) {
 			pci_info_ratelimited(vdev->pdev,
@@ -2122,11 +2114,7 @@ static pci_ers_result_t vfio_pci_aer_err_detected(struct pci_dev *pdev,
 	if (device == NULL)
 		return PCI_ERS_RESULT_DISCONNECT;
 
-	vdev = vfio_device_data(device);
-	if (vdev == NULL) {
-		vfio_device_put(device);
-		return PCI_ERS_RESULT_DISCONNECT;
-	}
+	vdev = container_of(device, struct vfio_pci_device, vdev);
 
 	mutex_lock(&vdev->igate);
 
@@ -2142,7 +2130,6 @@ static pci_ers_result_t vfio_pci_aer_err_detected(struct pci_dev *pdev,
 
 static int vfio_pci_sriov_configure(struct pci_dev *pdev, int nr_virtfn)
 {
-	struct vfio_pci_device *vdev;
 	struct vfio_device *device;
 	int ret = 0;
 
@@ -2155,12 +2142,6 @@ static int vfio_pci_sriov_configure(struct pci_dev *pdev, int nr_virtfn)
 	if (!device)
 		return -ENODEV;
 
-	vdev = vfio_device_data(device);
-	if (!vdev) {
-		vfio_device_put(device);
-		return -ENODEV;
-	}
-
 	if (nr_virtfn == 0)
 		pci_disable_sriov(pdev);
 	else
@@ -2220,7 +2201,7 @@ static int vfio_pci_reflck_find(struct pci_dev *pdev, void *data)
 		return 0;
 	}
 
-	vdev = vfio_device_data(device);
+	vdev = container_of(device, struct vfio_pci_device, vdev);
 
 	if (vdev->reflck) {
 		vfio_pci_reflck_get(vdev->reflck);
@@ -2282,7 +2263,7 @@ static int vfio_pci_get_unused_devs(struct pci_dev *pdev, void *data)
 		return -EBUSY;
 	}
 
-	vdev = vfio_device_data(device);
+	vdev = container_of(device, struct vfio_pci_device, vdev);
 
 	/* Fault if the device is not unused */
 	if (vdev->refcnt) {
@@ -2290,7 +2271,7 @@ static int vfio_pci_get_unused_devs(struct pci_dev *pdev, void *data)
 		return -EBUSY;
 	}
 
-	devs->devices[devs->cur_index++] = device;
+	devs->devices[devs->cur_index++] = vdev;
 	return 0;
 }
 
@@ -2312,7 +2293,7 @@ static int vfio_pci_try_zap_and_vma_lock_cb(struct pci_dev *pdev, void *data)
 		return -EBUSY;
 	}
 
-	vdev = vfio_device_data(device);
+	vdev = container_of(device, struct vfio_pci_device, vdev);
 
 	/*
 	 * Locking multiple devices is prone to deadlock, runaway and
@@ -2323,7 +2304,7 @@ static int vfio_pci_try_zap_and_vma_lock_cb(struct pci_dev *pdev, void *data)
 		return -EBUSY;
 	}
 
-	devs->devices[devs->cur_index++] = device;
+	devs->devices[devs->cur_index++] = vdev;
 	return 0;
 }
 
@@ -2371,7 +2352,7 @@ static void vfio_pci_try_bus_reset(struct vfio_pci_device *vdev)
 
 	/* Does at least one need a reset? */
 	for (i = 0; i < devs.cur_index; i++) {
-		tmp = vfio_device_data(devs.devices[i]);
+		tmp = devs.devices[i];
 		if (tmp->needs_reset) {
 			ret = pci_reset_bus(vdev->pdev);
 			break;
@@ -2380,7 +2361,7 @@ static void vfio_pci_try_bus_reset(struct vfio_pci_device *vdev)
 
 put_devs:
 	for (i = 0; i < devs.cur_index; i++) {
-		tmp = vfio_device_data(devs.devices[i]);
+		tmp = devs.devices[i];
 
 		/*
 		 * If reset was successful, affected devices no longer need
@@ -2396,7 +2377,7 @@ static void vfio_pci_try_bus_reset(struct vfio_pci_device *vdev)
 				vfio_pci_set_power_state(tmp, PCI_D3hot);
 		}
 
-		vfio_device_put(devs.devices[i]);
+		vfio_device_put(&tmp->vdev);
 	}
 
 	kfree(devs.devices);

From patchwork Sat Mar 13 00:56:06 2021
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
X-Patchwork-Submitter: Jason Gunthorpe <jgg@nvidia.com>
X-Patchwork-Id: 12136235
Return-Path: <kvm-owner@kernel.org>
X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on
	aws-us-west-2-korg-lkml-1.web.codeaurora.org
X-Spam-Level: 
X-Spam-Status: No, score=-16.0 required=3.0 tests=BAYES_00,DKIMWL_WL_HIGH,
	DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,HEADER_FROM_DIFFERENT_DOMAINS,
	INCLUDES_CR_TRAILER,INCLUDES_PATCH,MAILING_LIST_MULTI,MSGID_FROM_MTA_HEADER,
	SPF_HELO_NONE,SPF_PASS autolearn=unavailable autolearn_force=no version=3.4.0
Received: from mail.kernel.org (mail.kernel.org [198.145.29.99])
	by smtp.lore.kernel.org (Postfix) with ESMTP id 1A79DC4321A
	for <kvm@archiver.kernel.org>; Sat, 13 Mar 2021 00:57:02 +0000 (UTC)
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.kernel.org (Postfix) with ESMTP id 05E9364F9F
	for <kvm@archiver.kernel.org>; Sat, 13 Mar 2021 00:57:01 +0000 (UTC)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S232943AbhCMA4e (ORCPT <rfc822;kvm@archiver.kernel.org>);
        Fri, 12 Mar 2021 19:56:34 -0500
Received: from mail-dm6nam12on2065.outbound.protection.outlook.com
 ([40.107.243.65]:30549
        "EHLO NAM12-DM6-obe.outbound.protection.outlook.com"
        rhost-flags-OK-OK-OK-FAIL) by vger.kernel.org with ESMTP
        id S232223AbhCMA4O (ORCPT <rfc822;kvm@vger.kernel.org>);
        Fri, 12 Mar 2021 19:56:14 -0500
ARC-Seal: i=1; a=rsa-sha256; s=arcselector9901; d=microsoft.com; cv=none;
 b=ZXgFH2NvCRlxGbKIt6HWs8ZcUpd0SRz7cxNOHvSvarCjM9+XwHINgGXViFnxnae65ptJ9wspwz77IwTIV/+eB6qvrRKO0kNLc1NGEELndNrKgAWV+XTisFFy8YN20a9XPktUOMD27ZL8MrvtnkOrO39u70FYmEF9V1fgyOhbgRyneV4EkFWLKerI6FNSBlB7ppxBOHmnDMB480fWL1Iz/hbH6r9yWedZsHp5EM1uiouwNXSq+CV2KvVP40HR6Z+gT/3KK2XwCIWw3gjvUwTzOqZoV46RwIEoFbpD21/gFmmy+saCyUieCjyMvThILvZzUDjYTnuCyvpmM15nqmOYIQ==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=microsoft.com;
 s=arcselector9901;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=NMA5eI6+0w3JuPIdmz4FGsnE5kNex/3uiNtHiAJ+31Q=;
 b=Mw6wh8A7XV0Gd5KhOEU+I5jkHFguVP0nTqnp/xQ2yBSlblbyarBifi0vrxsXeUso/7zdJRZC+glwsmXXSOtXd0e5iAC2sdptk/p/nq122UnTfdmFgioIpeIvqT8ZljIikk6zqw0Q8nszE+46pIb642hPnUy1prcZasqcCk3Qmgf+HMDKxY6RkP/Fr/3vPHuPtqChSX22YC0KujWoPPaRiR0aP/iHuPRdBbXI+B+1S85JICnPo/6CSz/87/I05dCP3A83q6R8bqzRHZxeLe6zgF1ehUArzMiBZ1ZCTEPEf1CfQxSHJBG+W4JyoR0IYFxcjY0GBD5WcSxlfb+qzS5j0w==
ARC-Authentication-Results: i=1; mx.microsoft.com 1; spf=pass
 smtp.mailfrom=nvidia.com; dmarc=pass action=none header.from=nvidia.com;
 dkim=pass header.d=nvidia.com; arc=none
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=Nvidia.com;
 s=selector2;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=NMA5eI6+0w3JuPIdmz4FGsnE5kNex/3uiNtHiAJ+31Q=;
 b=dH7QBAtQSbmBhUoJxtHCiUOMZiLMDXMPmJkpVuu1pOJxw8bzrpA/xCrkXilPc2MrHwNYOrutnbXu1xqjuMfS7JN7qMpEFFn/PwWIqI2viVWIbPWCcDiAq4aXVcf+iSk4S0l82rmTq2zN4CL5VJQDdGq2I1lTMQiXxsH7CJf4DH1wQfj/BbfPyZvtA+SIroKMmX5OPJGukBGvS7MGTOk1XtoMOj94IqRH3A+0ta09DhTHSbe6e7DNWUcuUVRQBQyMVdZgt1a5zI6RNq2pJT4H1h7m3MnuPTkVHGpcWfvoiTsWRFlcoSy1eR0IQa7terIuOAvloaYo+TT09gtyMuKxrQ==
Authentication-Results: redhat.com; dkim=none (message not signed)
 header.d=none;redhat.com; dmarc=none action=none header.from=nvidia.com;
Received: from DM6PR12MB3834.namprd12.prod.outlook.com (2603:10b6:5:14a::12)
 by DM6PR12MB2940.namprd12.prod.outlook.com (2603:10b6:5:15f::19) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.3933.31; Sat, 13 Mar
 2021 00:56:13 +0000
Received: from DM6PR12MB3834.namprd12.prod.outlook.com
 ([fe80::1c62:7fa3:617b:ab87]) by DM6PR12MB3834.namprd12.prod.outlook.com
 ([fe80::1c62:7fa3:617b:ab87%6]) with mapi id 15.20.3933.032; Sat, 13 Mar 2021
 00:56:13 +0000
From: Jason Gunthorpe <jgg@nvidia.com>
To: Alex Williamson <alex.williamson@redhat.com>,
        Cornelia Huck <cohuck@redhat.com>,
        Jonathan Corbet <corbet@lwn.net>,
        Diana Craciun <diana.craciun@oss.nxp.com>,
        Eric Auger <eric.auger@redhat.com>, kvm@vger.kernel.org,
        Kirti Wankhede <kwankhede@nvidia.com>,
        linux-doc@vger.kernel.org
Cc: "Raj, Ashok" <ashok.raj@intel.com>,
        Dan Williams <dan.j.williams@intel.com>,
        Daniel Vetter <daniel@ffwll.ch>,
        Christoph Hellwig <hch@lst.de>,
        Leon Romanovsky <leonro@nvidia.com>,
        Max Gurtovoy <mgurtovoy@nvidia.com>,
        Tarun Gupta <targupta@nvidia.com>
Subject: [PATCH v2 14/14] vfio: Remove device_data from the vfio bus driver
 API
Date: Fri, 12 Mar 2021 20:56:06 -0400
Message-Id: <14-v2-20d933792272+4ff-vfio1_jgg@nvidia.com>
In-Reply-To: <0-v2-20d933792272+4ff-vfio1_jgg@nvidia.com>
References: 
X-Originating-IP: [142.162.115.133]
X-ClientProxiedBy: MN2PR22CA0027.namprd22.prod.outlook.com
 (2603:10b6:208:238::32) To DM6PR12MB3834.namprd12.prod.outlook.com
 (2603:10b6:5:14a::12)
MIME-Version: 1.0
X-MS-Exchange-MessageSentRepresentingType: 1
Received: from mlx.ziepe.ca (142.162.115.133) by
 MN2PR22CA0027.namprd22.prod.outlook.com (2603:10b6:208:238::32) with
 Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id 15.20.3912.17 via Frontend
 Transport; Sat, 13 Mar 2021 00:56:10 +0000
Received: from jgg by mlx with local (Exim 4.94)        (envelope-from
 <jgg@nvidia.com>)        id 1lKsZb-00EMBc-A7; Fri, 12 Mar 2021 20:56:07 -0400
X-MS-PublicTrafficType: Email
X-MS-Office365-Filtering-Correlation-Id: 6b1a769c-facd-4db5-d9e3-08d8e5bacb44
X-MS-TrafficTypeDiagnostic: DM6PR12MB2940:
X-MS-Exchange-Transport-Forked: True
X-Microsoft-Antispam-PRVS: 
 <DM6PR12MB294090CC4B9FDFBD69810DFCC26E9@DM6PR12MB2940.namprd12.prod.outlook.com>
X-MS-Oob-TLC-OOBClassifiers: OLM:4125;
X-MS-Exchange-SenderADCheck: 1
X-Microsoft-Antispam: BCL:0;
X-Microsoft-Antispam-Message-Info: 
 V+I2DlF+pMSG1oZC/zDHCTLpH9NN6jNZk/WRs7ogZcTZjPh8dx8mNRKKu6I02scy/YQM+2NMzqfE3+nvnc1XoSUvl/XlnB1Sw8wajwbfzZt2hx+G/x8KG3pEazmpOUz2hiWca3MxqTrzlhwhK8tWcbF/oH1zbA/ncI+zEEMTxecSVnY492nIATzrCWuZw3Rp7qWXYSGpR3WtcblKYXFrvftSrgp3t+PDsH6vFVrxGFiBd/Yzy0D+80JwstVm+0bMjTSGFKc9PxqhYkvIwg3nBO8K/fQbF3Hq4TsI+9z7PNgCQ0mOKYPHfwxQjEr534AGD1N94lUaXZgPk61U3aJq9AbMsvGsjKvJQaW38JKzgI0Uz1tpoKM163q1I3mb5bTzvl67P3sIShnQcFrrBtQSlvsMYAaNe3gB5Xk6S76CuAf7D8g6l8rBZtcqt/V2PHApuAL5vYPv6abf+Xuj5QEESvW8JQ+TpElEuRu2elr2qPlq8+wfoSvIxgpVo0Fq0Dgn5K8+QJiBF67ExsFjai4jNgDdGlYuQYiBRUxhRtit27K19rPJx6J+VgG/AH6ncvbF
X-Forefront-Antispam-Report: 
 CIP:255.255.255.255;CTRY:;LANG:en;SCL:1;SRV:;IPV:NLI;SFV:NSPM;H:DM6PR12MB3834.namprd12.prod.outlook.com;PTR:;CAT:NONE;SFS:(4636009)(39860400002)(376002)(396003)(136003)(366004)(346002)(9746002)(9786002)(8676002)(4326008)(107886003)(54906003)(8936002)(5660300002)(36756003)(316002)(110136005)(83380400001)(66946007)(66556008)(186003)(26005)(66476007)(478600001)(2906002)(426003)(86362001)(7416002)(2616005);DIR:OUT;SFP:1101;
X-MS-Exchange-AntiSpam-MessageData: 
 cCdPaAs2X3qcV3kFttmwpI4a6ixvGoQpOdTtyzXx7DQBkuP9LzGNZleWd0brsfKbvkA5/+2flK05aDYEB1E+cfwUEObNel6T6C3HjZYUjZoZ+jQE/8kDFiKEBmJ6FqQYLefi2CwnrvTgiQQMPYXGHkHLr2rTSRK6kxWkSSJm1Lk+yqMjHVxVE9QpRSMA3H3fynrIzIX4/khuQmhXP8dRURT+w7F1b+wlq8VcGSUxcLxEx6IhulC3pKgmdMypaEJuOFvJqZhqKWbXLt+HOeFsTXTjgDN3xWmTatbye7nAsAeZk2jiu5cAAKV0CVEL4vPQytwwfzmK2MnaWRBTvAuchEDxa/epcVUMe04+btdU6BrVUvpXJt7BNnfTk8guoH8yzaXy1CGRwIF9UuuvZxsMhjaBzgT+dwU9Xtnj27+bCEcR7fQJSltlXHPVinkWWNN0nhtAD9/ufj55xf5vIV73wG+agceIbAU6HLBV+VTb4M0uB1zz9dSs4bkrmX0SU74z/rzVdGxlSJ38G8P1dpQAnuRWPQeP1U7gqhLikYt3q97EzkW82eobqYKQS7IQrdxUfb/w1gjleypZSH1ty5Dd8UlJavE2evcwnUUCXujtqcPaB3TNI6ieW2bM7g9+PxpgZ/H37tj73qoTsNIo7tAcwP4mzOWAVVAnMU8pvbsOounwYqqt+tYjuLGk/sy4Ir/nSwzesr3fYyL4N1/vrrNkMIY24vXfeiECHnqg0wDfSoJf0s3b1GMAp1lzYUehLFdKqHKD6+P1eMt/wjqPGw/TnDgwBp+L/icwC8bkf1SOgCcNtcNNWWsNKbL3z35MVheDn+3Ou/5LkyJAOuXddMMhoNPp9ce9CdJLVy2HZGgYnkH7xX6Ve8yKOy41lV/9RCbpmeecyp8c4gDTNsPuA2tkInQukEX9G+qCKOkOl83l13/3xcV0yUJd9qbIMH9gg/4Y0+TPYpMcJmYpbupt2foBKHqrS+c0ts8RpzLjer2JTfmu3u3uio+dCXGkweViCALaiLz1LJo5OGhoVd8nKZz9KREKspVeSaNb9L733kJONPeCEH+sm8NnFnUcvmfmnYMfXTThtjJRCkbrLVcM4jm54XBOA0/AXXjx4PG4bmK3vwLcRbxC7EakitwRlpD+t2j/pgtn/+Ci61xuIDFTHo6j8xagYPDwaJk4Qp9QYIKLELPrUGcX+LDiyHmPk2Rp1aki7TqpmoBQn3fjxcV0mE5qAaO2e80lEHFdNr2FyjttaYaoPqEEhmO89n6fOa5L9ltgymqhMmVYMlspqVrdFsRO36AyBOPaZjuJb9pGKwfdwlQWjCTECHVWSg26BrmI4FVu5oZ8oAD4DWJozKg2EwqfIQ==
X-OriginatorOrg: Nvidia.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 
 6b1a769c-facd-4db5-d9e3-08d8e5bacb44
X-MS-Exchange-CrossTenant-AuthSource: DM6PR12MB3834.namprd12.prod.outlook.com
X-MS-Exchange-CrossTenant-AuthAs: Internal
X-MS-Exchange-CrossTenant-OriginalArrivalTime: 13 Mar 2021 00:56:11.2888
 (UTC)
X-MS-Exchange-CrossTenant-FromEntityHeader: Hosted
X-MS-Exchange-CrossTenant-Id: 43083d15-7273-40c1-b7db-39efd9ccc17a
X-MS-Exchange-CrossTenant-MailboxType: HOSTED
X-MS-Exchange-CrossTenant-UserPrincipalName: 
 wWowNwzXCYWvfQ9oWFZoSbysFkl/oSwLWa0/MZ2r32LZq7CURXlK93JO/cjL7rck
X-MS-Exchange-Transport-CrossTenantHeadersStamped: DM6PR12MB2940
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

There are no longer any users, so it can go away. Everything is using
container_of now.

Reviewed-by: Christoph Hellwig <hch@lst.de>
Signed-off-by: Jason Gunthorpe <jgg@nvidia.com>
---
 Documentation/driver-api/vfio.rst            |  3 +--
 drivers/vfio/fsl-mc/vfio_fsl_mc.c            |  5 +++--
 drivers/vfio/mdev/vfio_mdev.c                |  2 +-
 drivers/vfio/pci/vfio_pci.c                  |  2 +-
 drivers/vfio/platform/vfio_platform_common.c |  2 +-
 drivers/vfio/vfio.c                          | 12 +-----------
 include/linux/vfio.h                         |  4 +---
 7 files changed, 9 insertions(+), 21 deletions(-)

diff --git a/Documentation/driver-api/vfio.rst b/Documentation/driver-api/vfio.rst
index 3337f337293a32..decc68cb8114ac 100644
--- a/Documentation/driver-api/vfio.rst
+++ b/Documentation/driver-api/vfio.rst
@@ -254,8 +254,7 @@ vfio_unregister_group_dev() respectively::
 
 	void vfio_init_group_dev(struct vfio_device *device,
 				struct device *dev,
-				const struct vfio_device_ops *ops,
-				void *device_data);
+				const struct vfio_device_ops *ops);
 	int vfio_register_group_dev(struct vfio_device *device);
 	void vfio_unregister_group_dev(struct vfio_device *device);
 
diff --git a/drivers/vfio/fsl-mc/vfio_fsl_mc.c b/drivers/vfio/fsl-mc/vfio_fsl_mc.c
index 023b2222806424..3af3ca59478f94 100644
--- a/drivers/vfio/fsl-mc/vfio_fsl_mc.c
+++ b/drivers/vfio/fsl-mc/vfio_fsl_mc.c
@@ -75,7 +75,8 @@ static int vfio_fsl_mc_reflck_attach(struct vfio_fsl_mc_device *vdev)
 			goto unlock;
 		}
 
-		cont_vdev = vfio_device_data(device);
+		cont_vdev =
+			container_of(device, struct vfio_fsl_mc_device, vdev);
 		if (!cont_vdev || !cont_vdev->reflck) {
 			vfio_device_put(device);
 			ret = -ENODEV;
@@ -624,7 +625,7 @@ static int vfio_fsl_mc_probe(struct fsl_mc_device *mc_dev)
 		goto out_group_put;
 	}
 
-	vfio_init_group_dev(&vdev->vdev, dev, &vfio_fsl_mc_ops, vdev);
+	vfio_init_group_dev(&vdev->vdev, dev, &vfio_fsl_mc_ops);
 	vdev->mc_dev = mc_dev;
 	mutex_init(&vdev->igate);
 
diff --git a/drivers/vfio/mdev/vfio_mdev.c b/drivers/vfio/mdev/vfio_mdev.c
index e7309caa99c71b..71bd28f976e5af 100644
--- a/drivers/vfio/mdev/vfio_mdev.c
+++ b/drivers/vfio/mdev/vfio_mdev.c
@@ -138,7 +138,7 @@ static int vfio_mdev_probe(struct device *dev)
 	if (!mvdev)
 		return -ENOMEM;
 
-	vfio_init_group_dev(&mvdev->vdev, &mdev->dev, &vfio_mdev_dev_ops, mdev);
+	vfio_init_group_dev(&mvdev->vdev, &mdev->dev, &vfio_mdev_dev_ops);
 	ret = vfio_register_group_dev(&mvdev->vdev);
 	if (ret) {
 		kfree(mvdev);
diff --git a/drivers/vfio/pci/vfio_pci.c b/drivers/vfio/pci/vfio_pci.c
index 1f70387c8afe37..55ef27a15d4d3f 100644
--- a/drivers/vfio/pci/vfio_pci.c
+++ b/drivers/vfio/pci/vfio_pci.c
@@ -2022,7 +2022,7 @@ static int vfio_pci_probe(struct pci_dev *pdev, const struct pci_device_id *id)
 		goto out_group_put;
 	}
 
-	vfio_init_group_dev(&vdev->vdev, &pdev->dev, &vfio_pci_ops, vdev);
+	vfio_init_group_dev(&vdev->vdev, &pdev->dev, &vfio_pci_ops);
 	vdev->pdev = pdev;
 	vdev->irq_type = VFIO_PCI_NUM_IRQS;
 	mutex_init(&vdev->igate);
diff --git a/drivers/vfio/platform/vfio_platform_common.c b/drivers/vfio/platform/vfio_platform_common.c
index f5f6b537084a67..361e5b57e36932 100644
--- a/drivers/vfio/platform/vfio_platform_common.c
+++ b/drivers/vfio/platform/vfio_platform_common.c
@@ -666,7 +666,7 @@ int vfio_platform_probe_common(struct vfio_platform_device *vdev,
 	struct iommu_group *group;
 	int ret;
 
-	vfio_init_group_dev(&vdev->vdev, dev, &vfio_platform_ops, vdev);
+	vfio_init_group_dev(&vdev->vdev, dev, &vfio_platform_ops);
 
 	ret = vfio_platform_acpi_probe(vdev, dev);
 	if (ret)
diff --git a/drivers/vfio/vfio.c b/drivers/vfio/vfio.c
index 01de47d1810b6b..39ea77557ba0c4 100644
--- a/drivers/vfio/vfio.c
+++ b/drivers/vfio/vfio.c
@@ -741,12 +741,11 @@ static int vfio_iommu_group_notifier(struct notifier_block *nb,
  * VFIO driver API
  */
 void vfio_init_group_dev(struct vfio_device *device, struct device *dev,
-			 const struct vfio_device_ops *ops, void *device_data)
+			 const struct vfio_device_ops *ops)
 {
 	init_completion(&device->comp);
 	device->dev = dev;
 	device->ops = ops;
-	device->device_data = device_data;
 }
 EXPORT_SYMBOL_GPL(vfio_init_group_dev);
 
@@ -851,15 +850,6 @@ static struct vfio_device *vfio_device_get_from_name(struct vfio_group *group,
 	return device;
 }
 
-/*
- * Caller must hold a reference to the vfio_device
- */
-void *vfio_device_data(struct vfio_device *device)
-{
-	return device->device_data;
-}
-EXPORT_SYMBOL_GPL(vfio_device_data);
-
 /*
  * Decrement the device reference count and wait for the device to be
  * removed.  Open file descriptors for the device... */
diff --git a/include/linux/vfio.h b/include/linux/vfio.h
index 784c34c0a28763..a2c5b30e1763ba 100644
--- a/include/linux/vfio.h
+++ b/include/linux/vfio.h
@@ -24,7 +24,6 @@ struct vfio_device {
 	refcount_t refcount;
 	struct completion comp;
 	struct list_head group_next;
-	void *device_data;
 };
 
 /**
@@ -61,12 +60,11 @@ extern struct iommu_group *vfio_iommu_group_get(struct device *dev);
 extern void vfio_iommu_group_put(struct iommu_group *group, struct device *dev);
 
 void vfio_init_group_dev(struct vfio_device *device, struct device *dev,
-			 const struct vfio_device_ops *ops, void *device_data);
+			 const struct vfio_device_ops *ops);
 int vfio_register_group_dev(struct vfio_device *device);
 void vfio_unregister_group_dev(struct vfio_device *device);
 extern struct vfio_device *vfio_device_get_from_dev(struct device *dev);
 extern void vfio_device_put(struct vfio_device *device);
-extern void *vfio_device_data(struct vfio_device *device);
 
 /* events for the backend driver notify callback */
 enum vfio_iommu_notify_type {
